Directory structure:
â””â”€â”€ refined-github-refined-github/
    â”œâ”€â”€ readme.md
    â”œâ”€â”€ biome.jsonc
    â”œâ”€â”€ eslint-suppressions.json
    â”œâ”€â”€ eslint.config.js
    â”œâ”€â”€ license
    â”œâ”€â”€ package.json
    â”œâ”€â”€ privacy-policy.md
    â”œâ”€â”€ rollup.config.js
    â”œâ”€â”€ svelte.config.js
    â”œâ”€â”€ tsconfig.json
    â”œâ”€â”€ vite.config.ts
    â”œâ”€â”€ .editorconfig
    â”œâ”€â”€ .git-blame-ignore-revs
    â”œâ”€â”€ .ncurc.json
    â”œâ”€â”€ .npmrc
    â”œâ”€â”€ .nvmrc
    â”œâ”€â”€ .prettierignore
    â”œâ”€â”€ safari/
    â”‚   â”œâ”€â”€ app-store-description.txt
    â”‚   â”œâ”€â”€ app-store-keywords.txt
    â”‚   â”œâ”€â”€ Config.xcconfig
    â”‚   â”œâ”€â”€ Refined GitHub/
    â”‚   â”‚   â”œâ”€â”€ App.swift
    â”‚   â”‚   â”œâ”€â”€ Constants.swift
    â”‚   â”‚   â”œâ”€â”€ Info.plist
    â”‚   â”‚   â”œâ”€â”€ MainScreen.swift
    â”‚   â”‚   â”œâ”€â”€ Refined GitHub.entitlements
    â”‚   â”‚   â”œâ”€â”€ Utilities.swift
    â”‚   â”‚   â”œâ”€â”€ AppIcon.icon/
    â”‚   â”‚   â”‚   â””â”€â”€ icon.json
    â”‚   â”‚   â””â”€â”€ Assets.xcassets/
    â”‚   â”‚       â”œâ”€â”€ Contents.json
    â”‚   â”‚       â”œâ”€â”€ AccentColor.colorset/
    â”‚   â”‚       â”‚   â””â”€â”€ Contents.json
    â”‚   â”‚       â””â”€â”€ LargeIcon.imageset/
    â”‚   â”‚           â””â”€â”€ Contents.json
    â”‚   â””â”€â”€ Web Extension/
    â”‚       â”œâ”€â”€ Info.plist
    â”‚       â”œâ”€â”€ SafariWebExtensionHandler.swift
    â”‚       â””â”€â”€ Web Extension.entitlements
    â”œâ”€â”€ source/
    â”‚   â”œâ”€â”€ background.ts
    â”‚   â”œâ”€â”€ content-script.ts
    â”‚   â”œâ”€â”€ feature-data.ts
    â”‚   â”œâ”€â”€ feature-manager.tsx
    â”‚   â”œâ”€â”€ feature-renames.json
    â”‚   â”œâ”€â”€ feature-renames.test.ts
    â”‚   â”œâ”€â”€ globals.d.ts
    â”‚   â”œâ”€â”€ manifest.json
    â”‚   â”œâ”€â”€ options-storage.ts
    â”‚   â”œâ”€â”€ options.css
    â”‚   â”œâ”€â”€ options.html
    â”‚   â”œâ”€â”€ options.tsx
    â”‚   â”œâ”€â”€ refined-github.css
    â”‚   â”œâ”€â”€ refined-github.ts
    â”‚   â”œâ”€â”€ welcome.html
    â”‚   â”œâ”€â”€ welcome.svelte
    â”‚   â”œâ”€â”€ features/
    â”‚   â”‚   â”œâ”€â”€ action-pr-link.tsx
    â”‚   â”‚   â”œâ”€â”€ action-used-by-link.tsx
    â”‚   â”‚   â”œâ”€â”€ actionable-pr-view-file.tsx
    â”‚   â”‚   â”œâ”€â”€ actions-run-removal.css
    â”‚   â”‚   â”œâ”€â”€ actions-run-removal.tsx
    â”‚   â”‚   â”œâ”€â”€ align-issue-labels.css
    â”‚   â”‚   â”œâ”€â”€ align-issue-labels.tsx
    â”‚   â”‚   â”œâ”€â”€ archive-forks-link.tsx
    â”‚   â”‚   â”œâ”€â”€ avoid-accidental-submissions.tsx
    â”‚   â”‚   â”œâ”€â”€ batch-mark-files-as-viewed.tsx
    â”‚   â”‚   â”œâ”€â”€ bugs-tab.gql
    â”‚   â”‚   â”œâ”€â”€ bugs-tab.tsx
    â”‚   â”‚   â”œâ”€â”€ center-reactions-popup.css
    â”‚   â”‚   â”œâ”€â”€ ci-link.css
    â”‚   â”‚   â”œâ”€â”€ ci-link.gql
    â”‚   â”‚   â”œâ”€â”€ ci-link.tsx
    â”‚   â”‚   â”œâ”€â”€ clean-checks-list.css
    â”‚   â”‚   â”œâ”€â”€ clean-conversation-filters.gql
    â”‚   â”‚   â”œâ”€â”€ clean-conversation-filters.tsx
    â”‚   â”‚   â”œâ”€â”€ clean-conversation-headers.css
    â”‚   â”‚   â”œâ”€â”€ clean-conversation-headers.tsx
    â”‚   â”‚   â”œâ”€â”€ clean-conversation-sidebar.css
    â”‚   â”‚   â”œâ”€â”€ clean-conversation-sidebar.tsx
    â”‚   â”‚   â”œâ”€â”€ clean-conversations.css
    â”‚   â”‚   â”œâ”€â”€ clean-footer.css
    â”‚   â”‚   â”œâ”€â”€ clean-notifications.css
    â”‚   â”‚   â”œâ”€â”€ clean-pinned-issues.css
    â”‚   â”‚   â”œâ”€â”€ clean-pinned-issues.tsx
    â”‚   â”‚   â”œâ”€â”€ clean-readme-url.tsx
    â”‚   â”‚   â”œâ”€â”€ clean-repo-filelist-actions.css
    â”‚   â”‚   â”œâ”€â”€ clean-repo-filelist-actions.tsx
    â”‚   â”‚   â”œâ”€â”€ clean-repo-sidebar.css
    â”‚   â”‚   â”œâ”€â”€ clean-repo-sidebar.tsx
    â”‚   â”‚   â”œâ”€â”€ clean-repo-tabs.tsx
    â”‚   â”‚   â”œâ”€â”€ clean-rich-text-editor.css
    â”‚   â”‚   â”œâ”€â”€ clean-rich-text-editor.tsx
    â”‚   â”‚   â”œâ”€â”€ clear-pr-merge-commit-message.tsx
    â”‚   â”‚   â”œâ”€â”€ click-outside-modal.tsx
    â”‚   â”‚   â”œâ”€â”€ close-as-unplanned.tsx
    â”‚   â”‚   â”œâ”€â”€ close-out-of-view-modals.tsx
    â”‚   â”‚   â”œâ”€â”€ closing-remarks.tsx
    â”‚   â”‚   â”œâ”€â”€ collapsible-content-button.tsx
    â”‚   â”‚   â”œâ”€â”€ command-palette-navigation-shortcuts.tsx
    â”‚   â”‚   â”œâ”€â”€ comment-excess.tsx
    â”‚   â”‚   â”œâ”€â”€ comments-time-machine-links.gql
    â”‚   â”‚   â”œâ”€â”€ comments-time-machine-links.tsx
    â”‚   â”‚   â”œâ”€â”€ conflict-marker.css
    â”‚   â”‚   â”œâ”€â”€ conflict-marker.tsx
    â”‚   â”‚   â”œâ”€â”€ conventional-commits.css
    â”‚   â”‚   â”œâ”€â”€ conventional-commits.tsx
    â”‚   â”‚   â”œâ”€â”€ conversation-activity-filter.css
    â”‚   â”‚   â”œâ”€â”€ conversation-activity-filter.tsx
    â”‚   â”‚   â”œâ”€â”€ conversation-authors.css
    â”‚   â”‚   â”œâ”€â”€ conversation-authors.gql
    â”‚   â”‚   â”œâ”€â”€ conversation-authors.tsx
    â”‚   â”‚   â”œâ”€â”€ conversation-links-on-repo-lists.tsx
    â”‚   â”‚   â”œâ”€â”€ convert-release-to-draft.tsx
    â”‚   â”‚   â”œâ”€â”€ copy-on-y.tsx
    â”‚   â”‚   â”œâ”€â”€ create-release-shortcut.tsx
    â”‚   â”‚   â”œâ”€â”€ cross-deleted-pr-branches.css
    â”‚   â”‚   â”œâ”€â”€ cross-deleted-pr-branches.tsx
    â”‚   â”‚   â”œâ”€â”€ deep-reblame.css
    â”‚   â”‚   â”œâ”€â”€ deep-reblame.gql
    â”‚   â”‚   â”œâ”€â”€ deep-reblame.tsx
    â”‚   â”‚   â”œâ”€â”€ default-branch-button.css
    â”‚   â”‚   â”œâ”€â”€ default-branch-button.tsx
    â”‚   â”‚   â”œâ”€â”€ dim-bots.css
    â”‚   â”‚   â”œâ”€â”€ dim-bots.tsx
    â”‚   â”‚   â”œâ”€â”€ download-folder-button.tsx
    â”‚   â”‚   â”œâ”€â”€ easy-toggle-commit-messages.tsx
    â”‚   â”‚   â”œâ”€â”€ easy-toggle-files.tsx
    â”‚   â”‚   â”œâ”€â”€ embed-gist-inline.tsx
    â”‚   â”‚   â”œâ”€â”€ emphasize-draft-pr-label.css
    â”‚   â”‚   â”œâ”€â”€ emphasize-draft-pr-label.tsx
    â”‚   â”‚   â”œâ”€â”€ esc-to-cancel.tsx
    â”‚   â”‚   â”œâ”€â”€ esc-to-deselect-line.tsx
    â”‚   â”‚   â”œâ”€â”€ expand-all-hidden-comments.tsx
    â”‚   â”‚   â”œâ”€â”€ extend-conversation-status-filters.tsx
    â”‚   â”‚   â”œâ”€â”€ extend-diff-expander.css
    â”‚   â”‚   â”œâ”€â”€ extend-diff-expander.tsx
    â”‚   â”‚   â”œâ”€â”€ file-age-color.tsx
    â”‚   â”‚   â”œâ”€â”€ fit-textareas.css
    â”‚   â”‚   â”œâ”€â”€ fit-textareas.tsx
    â”‚   â”‚   â”œâ”€â”€ fix-no-pr-search.tsx
    â”‚   â”‚   â”œâ”€â”€ github-actions-indicators.gql
    â”‚   â”‚   â”œâ”€â”€ github-actions-indicators.tsx
    â”‚   â”‚   â”œâ”€â”€ github-bugs.css
    â”‚   â”‚   â”œâ”€â”€ global-conversation-list-filters.css
    â”‚   â”‚   â”œâ”€â”€ global-conversation-list-filters.tsx
    â”‚   â”‚   â”œâ”€â”€ hidden-review-comments-indicator.css
    â”‚   â”‚   â”œâ”€â”€ hidden-review-comments-indicator.tsx
    â”‚   â”‚   â”œâ”€â”€ hide-diff-signs.css
    â”‚   â”‚   â”œâ”€â”€ hide-diff-signs.tsx
    â”‚   â”‚   â”œâ”€â”€ hide-inactive-deployments.tsx
    â”‚   â”‚   â”œâ”€â”€ hide-low-quality-comments.css
    â”‚   â”‚   â”œâ”€â”€ hide-low-quality-comments.tsx
    â”‚   â”‚   â”œâ”€â”€ hide-navigation-hover-highlight.css
    â”‚   â”‚   â”œâ”€â”€ hide-navigation-hover-highlight.tsx
    â”‚   â”‚   â”œâ”€â”€ hide-user-forks.tsx
    â”‚   â”‚   â”œâ”€â”€ highest-rated-comment.css
    â”‚   â”‚   â”œâ”€â”€ highest-rated-comment.tsx
    â”‚   â”‚   â”œâ”€â”€ highlight-non-default-base-branch.tsx
    â”‚   â”‚   â”œâ”€â”€ html-preview-link.tsx
    â”‚   â”‚   â”œâ”€â”€ improve-shortcut-help.tsx
    â”‚   â”‚   â”œâ”€â”€ jump-to-change-requested-comment.tsx
    â”‚   â”‚   â”œâ”€â”€ jump-to-conversation-close-event.tsx
    â”‚   â”‚   â”œâ”€â”€ keyboard-navigation.tsx
    â”‚   â”‚   â”œâ”€â”€ last-notification-page-button.tsx
    â”‚   â”‚   â”œâ”€â”€ link-to-changelog-file.gql
    â”‚   â”‚   â”œâ”€â”€ link-to-changelog-file.tsx
    â”‚   â”‚   â”œâ”€â”€ link-to-compare-diff.css
    â”‚   â”‚   â”œâ”€â”€ link-to-compare-diff.tsx
    â”‚   â”‚   â”œâ”€â”€ link-to-github-io.tsx
    â”‚   â”‚   â”œâ”€â”€ linkify-branch-references.tsx
    â”‚   â”‚   â”œâ”€â”€ linkify-code.tsx
    â”‚   â”‚   â”œâ”€â”€ linkify-commit-sha.tsx
    â”‚   â”‚   â”œâ”€â”€ linkify-line-numbers.tsx
    â”‚   â”‚   â”œâ”€â”€ linkify-symbolic-links.tsx
    â”‚   â”‚   â”œâ”€â”€ linkify-text.tsx
    â”‚   â”‚   â”œâ”€â”€ linkify-user-edit-history-popup.tsx
    â”‚   â”‚   â”œâ”€â”€ linkify-user-labels.tsx
    â”‚   â”‚   â”œâ”€â”€ linkify-user-location.tsx
    â”‚   â”‚   â”œâ”€â”€ list-prs-for-branch.tsx
    â”‚   â”‚   â”œâ”€â”€ list-prs-for-file.gql
    â”‚   â”‚   â”œâ”€â”€ list-prs-for-file.tsx
    â”‚   â”‚   â”œâ”€â”€ locked-issue.tsx
    â”‚   â”‚   â”œâ”€â”€ mark-merge-commits-in-list.css
    â”‚   â”‚   â”œâ”€â”€ mark-merge-commits-in-list.tsx
    â”‚   â”‚   â”œâ”€â”€ mark-private-orgs.css
    â”‚   â”‚   â”œâ”€â”€ mark-private-orgs.tsx
    â”‚   â”‚   â”œâ”€â”€ mark-private-repos.css
    â”‚   â”‚   â”œâ”€â”€ mobile-tabs.css
    â”‚   â”‚   â”œâ”€â”€ monospace-textareas.css
    â”‚   â”‚   â”œâ”€â”€ more-conversation-filters.tsx
    â”‚   â”‚   â”œâ”€â”€ more-dropdown-links.css
    â”‚   â”‚   â”œâ”€â”€ more-dropdown-links.tsx
    â”‚   â”‚   â”œâ”€â”€ more-file-links.tsx
    â”‚   â”‚   â”œâ”€â”€ netiquette.tsx
    â”‚   â”‚   â”œâ”€â”€ new-milestone-button.tsx
    â”‚   â”‚   â”œâ”€â”€ new-or-deleted-file.tsx
    â”‚   â”‚   â”œâ”€â”€ new-repo-disable-projects-and-wikis.tsx
    â”‚   â”‚   â”œâ”€â”€ night-not-found.css
    â”‚   â”‚   â”œâ”€â”€ no-duplicate-list-update-time.tsx
    â”‚   â”‚   â”œâ”€â”€ no-modals.tsx
    â”‚   â”‚   â”œâ”€â”€ no-self-reference.tsx
    â”‚   â”‚   â”œâ”€â”€ no-unnecessary-split-diff-view.css
    â”‚   â”‚   â”œâ”€â”€ no-unnecessary-split-diff-view.tsx
    â”‚   â”‚   â”œâ”€â”€ one-click-diff-options.tsx
    â”‚   â”‚   â”œâ”€â”€ one-click-pr-or-gist.css
    â”‚   â”‚   â”œâ”€â”€ one-click-pr-or-gist.tsx
    â”‚   â”‚   â”œâ”€â”€ one-click-review-submission.tsx
    â”‚   â”‚   â”œâ”€â”€ one-key-formatting.tsx
    â”‚   â”‚   â”œâ”€â”€ open-all-conversations.tsx
    â”‚   â”‚   â”œâ”€â”€ open-all-notifications.css
    â”‚   â”‚   â”œâ”€â”€ open-all-notifications.tsx
    â”‚   â”‚   â”œâ”€â”€ open-issue-to-latest-comment.tsx
    â”‚   â”‚   â”œâ”€â”€ parse-backticks.css
    â”‚   â”‚   â”œâ”€â”€ parse-backticks.tsx
    â”‚   â”‚   â”œâ”€â”€ patch-diff-links.tsx
    â”‚   â”‚   â”œâ”€â”€ pinned-issues-update-time.tsx
    â”‚   â”‚   â”œâ”€â”€ pr-approvals-count.css
    â”‚   â”‚   â”œâ”€â”€ pr-base-commit.tsx
    â”‚   â”‚   â”œâ”€â”€ pr-branch-auto-delete.gql
    â”‚   â”‚   â”œâ”€â”€ pr-branch-auto-delete.tsx
    â”‚   â”‚   â”œâ”€â”€ pr-commit-lines-changed.gql
    â”‚   â”‚   â”œâ”€â”€ pr-commit-lines-changed.tsx
    â”‚   â”‚   â”œâ”€â”€ pr-filters.gql
    â”‚   â”‚   â”œâ”€â”€ pr-filters.tsx
    â”‚   â”‚   â”œâ”€â”€ pr-first-commit-title.tsx
    â”‚   â”‚   â”œâ”€â”€ pr-jump-to-first-non-viewed-file.tsx
    â”‚   â”‚   â”œâ”€â”€ pr-notification-link.tsx
    â”‚   â”‚   â”œâ”€â”€ prevent-comment-loss.tsx
    â”‚   â”‚   â”œâ”€â”€ prevent-duplicate-pr-submission.tsx
    â”‚   â”‚   â”œâ”€â”€ prevent-link-loss.tsx
    â”‚   â”‚   â”œâ”€â”€ prevent-pr-merge-panel-opening.tsx
    â”‚   â”‚   â”œâ”€â”€ preview-hidden-comments.css
    â”‚   â”‚   â”œâ”€â”€ preview-hidden-comments.tsx
    â”‚   â”‚   â”œâ”€â”€ previous-next-commit-buttons.tsx
    â”‚   â”‚   â”œâ”€â”€ previous-version.gql
    â”‚   â”‚   â”œâ”€â”€ previous-version.tsx
    â”‚   â”‚   â”œâ”€â”€ profile-gists-link.gql
    â”‚   â”‚   â”œâ”€â”€ profile-gists-link.tsx
    â”‚   â”‚   â”œâ”€â”€ profile-hotkey.tsx
    â”‚   â”‚   â”œâ”€â”€ pull-request-hotkeys.tsx
    â”‚   â”‚   â”œâ”€â”€ quick-comment-edit.tsx
    â”‚   â”‚   â”œâ”€â”€ quick-comment-hiding.tsx
    â”‚   â”‚   â”œâ”€â”€ quick-file-edit.css
    â”‚   â”‚   â”œâ”€â”€ quick-file-edit.tsx
    â”‚   â”‚   â”œâ”€â”€ quick-label-removal.css
    â”‚   â”‚   â”œâ”€â”€ quick-label-removal.tsx
    â”‚   â”‚   â”œâ”€â”€ quick-mention.css
    â”‚   â”‚   â”œâ”€â”€ quick-mention.tsx
    â”‚   â”‚   â”œâ”€â”€ quick-new-issue.tsx
    â”‚   â”‚   â”œâ”€â”€ quick-repo-deletion.tsx
    â”‚   â”‚   â”œâ”€â”€ quick-review-comment-deletion.tsx
    â”‚   â”‚   â”œâ”€â”€ quick-review.tsx
    â”‚   â”‚   â”œâ”€â”€ reactions-avatars.css
    â”‚   â”‚   â”œâ”€â”€ reactions-avatars.tsx
    â”‚   â”‚   â”œâ”€â”€ readable-title-change-events.css
    â”‚   â”‚   â”œâ”€â”€ release-download-count.css
    â”‚   â”‚   â”œâ”€â”€ release-download-count.gql
    â”‚   â”‚   â”œâ”€â”€ release-download-count.tsx
    â”‚   â”‚   â”œâ”€â”€ releases-dropdown.gql
    â”‚   â”‚   â”œâ”€â”€ releases-dropdown.tsx
    â”‚   â”‚   â”œâ”€â”€ releases-tab.gql
    â”‚   â”‚   â”œâ”€â”€ releases-tab.tsx
    â”‚   â”‚   â”œâ”€â”€ reload-failed-proxied-images.tsx
    â”‚   â”‚   â”œâ”€â”€ repo-age-first-commit.gql
    â”‚   â”‚   â”œâ”€â”€ repo-age.gql
    â”‚   â”‚   â”œâ”€â”€ repo-age.tsx
    â”‚   â”‚   â”œâ”€â”€ repo-avatars.tsx
    â”‚   â”‚   â”œâ”€â”€ repo-header-info.gql
    â”‚   â”‚   â”œâ”€â”€ repo-header-info.tsx
    â”‚   â”‚   â”œâ”€â”€ repo-wide-file-finder.tsx
    â”‚   â”‚   â”œâ”€â”€ restore-file.tsx
    â”‚   â”‚   â”œâ”€â”€ rgh-deduplicator.tsx
    â”‚   â”‚   â”œâ”€â”€ rgh-dim-commits.tsx
    â”‚   â”‚   â”œâ”€â”€ rgh-feature-descriptions.css
    â”‚   â”‚   â”œâ”€â”€ rgh-feature-descriptions.tsx
    â”‚   â”‚   â”œâ”€â”€ rgh-improve-new-issue-form.tsx
    â”‚   â”‚   â”œâ”€â”€ rgh-linkify-features.tsx
    â”‚   â”‚   â”œâ”€â”€ rgh-linkify-yolo.tsx
    â”‚   â”‚   â”œâ”€â”€ rgh-netiquette.tsx
    â”‚   â”‚   â”œâ”€â”€ rgh-options-link.tsx
    â”‚   â”‚   â”œâ”€â”€ rgh-pr-template.tsx
    â”‚   â”‚   â”œâ”€â”€ rgh-token-user.tsx
    â”‚   â”‚   â”œâ”€â”€ safer-destructive-actions.css
    â”‚   â”‚   â”œâ”€â”€ same-branch-author-commits.tsx
    â”‚   â”‚   â”œâ”€â”€ same-page-links.tsx
    â”‚   â”‚   â”œâ”€â”€ scrollable-areas.css
    â”‚   â”‚   â”œâ”€â”€ scrollable-areas.tsx
    â”‚   â”‚   â”œâ”€â”€ select-all-notifications-shortcut.tsx
    â”‚   â”‚   â”œâ”€â”€ select-notifications.css
    â”‚   â”‚   â”œâ”€â”€ select-notifications.tsx
    â”‚   â”‚   â”œâ”€â”€ selection-in-new-tab.tsx
    â”‚   â”‚   â”œâ”€â”€ shorten-links.tsx
    â”‚   â”‚   â”œâ”€â”€ show-associated-branch-prs-on-fork.css
    â”‚   â”‚   â”œâ”€â”€ show-associated-branch-prs-on-fork.gql
    â”‚   â”‚   â”œâ”€â”€ show-associated-branch-prs-on-fork.tsx
    â”‚   â”‚   â”œâ”€â”€ show-names.tsx
    â”‚   â”‚   â”œâ”€â”€ show-open-prs-of-forks.gql
    â”‚   â”‚   â”œâ”€â”€ show-open-prs-of-forks.tsx
    â”‚   â”‚   â”œâ”€â”€ show-user-top-repositories.tsx
    â”‚   â”‚   â”œâ”€â”€ show-whitespace.css
    â”‚   â”‚   â”œâ”€â”€ show-whitespace.tsx
    â”‚   â”‚   â”œâ”€â”€ sidebar-focus-file.tsx
    â”‚   â”‚   â”œâ”€â”€ small-user-avatars.css
    â”‚   â”‚   â”œâ”€â”€ small-user-avatars.tsx
    â”‚   â”‚   â”œâ”€â”€ sort-conversations-by-update-time.tsx
    â”‚   â”‚   â”œâ”€â”€ status-subscription.css
    â”‚   â”‚   â”œâ”€â”€ status-subscription.tsx
    â”‚   â”‚   â”œâ”€â”€ sticky-comment-header.css
    â”‚   â”‚   â”œâ”€â”€ sticky-comment-header.tsx
    â”‚   â”‚   â”œâ”€â”€ sticky-conversation-list-toolbar.css
    â”‚   â”‚   â”œâ”€â”€ sticky-csv-header.css
    â”‚   â”‚   â”œâ”€â”€ sticky-file-header.css
    â”‚   â”‚   â”œâ”€â”€ sticky-notifications-actions.css
    â”‚   â”‚   â”œâ”€â”€ sticky-sidebar.css
    â”‚   â”‚   â”œâ”€â”€ sticky-sidebar.tsx
    â”‚   â”‚   â”œâ”€â”€ stop-redirecting-in-notification-bar.tsx
    â”‚   â”‚   â”œâ”€â”€ suggest-commit-title-limit.css
    â”‚   â”‚   â”œâ”€â”€ suggest-commit-title-limit.tsx
    â”‚   â”‚   â”œâ”€â”€ swap-branches-on-compare.tsx
    â”‚   â”‚   â”œâ”€â”€ sync-pr-commit-title.tsx
    â”‚   â”‚   â”œâ”€â”€ tab-size.css
    â”‚   â”‚   â”œâ”€â”€ tab-to-indent.tsx
    â”‚   â”‚   â”œâ”€â”€ table-input.css
    â”‚   â”‚   â”œâ”€â”€ table-input.tsx
    â”‚   â”‚   â”œâ”€â”€ tag-changes-link.css
    â”‚   â”‚   â”œâ”€â”€ tag-changes-link.tsx
    â”‚   â”‚   â”œâ”€â”€ tags-on-commits-list.gql
    â”‚   â”‚   â”œâ”€â”€ tags-on-commits-list.tsx
    â”‚   â”‚   â”œâ”€â”€ toggle-everything-with-alt.tsx
    â”‚   â”‚   â”œâ”€â”€ unclip-checks.css
    â”‚   â”‚   â”œâ”€â”€ unclip-checks.tsx
    â”‚   â”‚   â”œâ”€â”€ unfinished-comments.tsx
    â”‚   â”‚   â”œâ”€â”€ unread-anywhere.tsx
    â”‚   â”‚   â”œâ”€â”€ unreleased-commits.gql
    â”‚   â”‚   â”œâ”€â”€ unreleased-commits.tsx
    â”‚   â”‚   â”œâ”€â”€ unwrap-unnecessary-dropdowns.tsx
    â”‚   â”‚   â”œâ”€â”€ update-pr-from-base-branch.tsx
    â”‚   â”‚   â”œâ”€â”€ useful-not-found-page.gql
    â”‚   â”‚   â”œâ”€â”€ useful-not-found-page.tsx
    â”‚   â”‚   â”œâ”€â”€ user-profile-follower-badge.tsx
    â”‚   â”‚   â”œâ”€â”€ vertical-front-matter.css
    â”‚   â”‚   â”œâ”€â”€ vertical-front-matter.tsx
    â”‚   â”‚   â”œâ”€â”€ view-last-pr-deployment.tsx
    â”‚   â”‚   â”œâ”€â”€ visit-tag.tsx
    â”‚   â”‚   â”œâ”€â”€ warn-pr-from-master.tsx
    â”‚   â”‚   â”œâ”€â”€ warning-for-disallow-edits.css
    â”‚   â”‚   â””â”€â”€ warning-for-disallow-edits.tsx
    â”‚   â”œâ”€â”€ github-events/
    â”‚   â”‚   â”œâ”€â”€ on-commit-title-update.ts
    â”‚   â”‚   â”œâ”€â”€ on-field-keydown.tsx
    â”‚   â”‚   â”œâ”€â”€ on-pr-merge.ts
    â”‚   â”‚   â””â”€â”€ on-react-page-update.tsx
    â”‚   â”œâ”€â”€ github-helpers/
    â”‚   â”‚   â”œâ”€â”€ api.ts
    â”‚   â”‚   â”œâ”€â”€ banner.tsx
    â”‚   â”‚   â”œâ”€â”€ bugs-label.test.ts
    â”‚   â”‚   â”œâ”€â”€ bugs-label.ts
    â”‚   â”‚   â”œâ”€â”€ create-dropdown-item.tsx
    â”‚   â”‚   â”œâ”€â”€ does-file-exist.gql
    â”‚   â”‚   â”œâ”€â”€ dom-formatters.tsx
    â”‚   â”‚   â”œâ”€â”€ get-comment-author.ts
    â”‚   â”‚   â”œâ”€â”€ get-current-git-ref.test.ts
    â”‚   â”‚   â”œâ”€â”€ get-current-git-ref.ts
    â”‚   â”‚   â”œâ”€â”€ get-default-branch.gql
    â”‚   â”‚   â”œâ”€â”€ get-default-branch.ts
    â”‚   â”‚   â”œâ”€â”€ get-next-conversation-number.ts
    â”‚   â”‚   â”œâ”€â”€ get-pr-info.ts
    â”‚   â”‚   â”œâ”€â”€ get-tab-count.ts
    â”‚   â”‚   â”œâ”€â”€ get-user-avatar.ts
    â”‚   â”‚   â”œâ”€â”€ get-user-permission.ts
    â”‚   â”‚   â”œâ”€â”€ github-file-url.test.ts
    â”‚   â”‚   â”œâ”€â”€ github-file-url.ts
    â”‚   â”‚   â”œâ”€â”€ github-token.ts
    â”‚   â”‚   â”œâ”€â”€ group-buttons.tsx
    â”‚   â”‚   â”œâ”€â”€ heat-map.css
    â”‚   â”‚   â”œâ”€â”€ hotkey.tsx
    â”‚   â”‚   â”œâ”€â”€ hotkeys.test.ts
    â”‚   â”‚   â”œâ”€â”€ icon-loading.tsx
    â”‚   â”‚   â”œâ”€â”€ index.test.ts
    â”‚   â”‚   â”œâ”€â”€ index.ts
    â”‚   â”‚   â”œâ”€â”€ is-conversation-locked.gql
    â”‚   â”‚   â”œâ”€â”€ is-conversation-locked.ts
    â”‚   â”‚   â”œâ”€â”€ is-default-branch.ts
    â”‚   â”‚   â”œâ”€â”€ load-details-menu.ts
    â”‚   â”‚   â”œâ”€â”€ parse-backticks.test.ts
    â”‚   â”‚   â”œâ”€â”€ parse-backticks.tsx
    â”‚   â”‚   â”œâ”€â”€ parse-compare-url.test.ts
    â”‚   â”‚   â”œâ”€â”€ parse-compare-url.ts
    â”‚   â”‚   â”œâ”€â”€ pr-branches.test.ts
    â”‚   â”‚   â”œâ”€â”€ pr-branches.ts
    â”‚   â”‚   â”œâ”€â”€ prevent-link-loss.test.ts
    â”‚   â”‚   â”œâ”€â”€ prevent-link-loss.ts
    â”‚   â”‚   â”œâ”€â”€ search-query.test.ts
    â”‚   â”‚   â”œâ”€â”€ search-query.ts
    â”‚   â”‚   â”œâ”€â”€ selectors.test.ts
    â”‚   â”‚   â”œâ”€â”€ selectors.ts
    â”‚   â”‚   â”œâ”€â”€ timeline-item.tsx
    â”‚   â”‚   â””â”€â”€ toast.tsx
    â”‚   â”œâ”€â”€ github-widgets/
    â”‚   â”‚   â”œâ”€â”€ mergeability-row.tsx
    â”‚   â”‚   â””â”€â”€ notice-bar.tsx
    â”‚   â”œâ”€â”€ helpers/
    â”‚   â”‚   â”œâ”€â”€ abbreviate-number.ts
    â”‚   â”‚   â”œâ”€â”€ abbreviate-string.ts
    â”‚   â”‚   â”œâ”€â”€ abortable-classname.ts
    â”‚   â”‚   â”œâ”€â”€ async-for-each.ts
    â”‚   â”‚   â”œâ”€â”€ attach-element.ts
    â”‚   â”‚   â”œâ”€â”€ bisect.tsx
    â”‚   â”‚   â”œâ”€â”€ calculate-css-calc-string.test.ts
    â”‚   â”‚   â”œâ”€â”€ calculate-css-calc-string.ts
    â”‚   â”‚   â”œâ”€â”€ caller-id.test.ts
    â”‚   â”‚   â”œâ”€â”€ caller-id.ts
    â”‚   â”‚   â”œâ”€â”€ clean-commit-message.test.ts
    â”‚   â”‚   â”œâ”€â”€ clean-commit-message.ts
    â”‚   â”‚   â”œâ”€â”€ clear-cache-handler.ts
    â”‚   â”‚   â”œâ”€â”€ click-all.ts
    â”‚   â”‚   â”œâ”€â”€ conventional-commits.test.ts
    â”‚   â”‚   â”œâ”€â”€ conventional-commits.ts
    â”‚   â”‚   â”œâ”€â”€ delay.ts
    â”‚   â”‚   â”œâ”€â”€ dom-utils.ts
    â”‚   â”‚   â”œâ”€â”€ errors.ts
    â”‚   â”‚   â”œâ”€â”€ event-listener-loop.test.ts
    â”‚   â”‚   â”œâ”€â”€ event-listener-loop.ts
    â”‚   â”‚   â”œâ”€â”€ feature-helpers.ts
    â”‚   â”‚   â”œâ”€â”€ feature-utils.test.ts
    â”‚   â”‚   â”œâ”€â”€ feature-utils.ts
    â”‚   â”‚   â”œâ”€â”€ fetch-dom.ts
    â”‚   â”‚   â”œâ”€â”€ get-items-between.test.ts
    â”‚   â”‚   â”œâ”€â”€ get-items-between.ts
    â”‚   â”‚   â”œâ”€â”€ get-text-nodes.ts
    â”‚   â”‚   â”œâ”€â”€ hash-string.ts
    â”‚   â”‚   â”œâ”€â”€ history.ts
    â”‚   â”‚   â”œâ”€â”€ hotfix.tsx
    â”‚   â”‚   â”œâ”€â”€ is-development-version.ts
    â”‚   â”‚   â”œâ”€â”€ is-low-quality-comment.test.ts
    â”‚   â”‚   â”œâ”€â”€ is-low-quality-comment.ts
    â”‚   â”‚   â”œâ”€â”€ isomorphic-fetch.ts
    â”‚   â”‚   â”œâ”€â”€ loose-parse-int.test.ts
    â”‚   â”‚   â”œâ”€â”€ loose-parse-int.ts
    â”‚   â”‚   â”œâ”€â”€ map-of-arrays.ts
    â”‚   â”‚   â”œâ”€â”€ matches-any-patterns.ts
    â”‚   â”‚   â”œâ”€â”€ math.ts
    â”‚   â”‚   â”œâ”€â”€ on-element-removal.ts
    â”‚   â”‚   â”œâ”€â”€ onetime.ts
    â”‚   â”‚   â”œâ”€â”€ open-options.tsx
    â”‚   â”‚   â”œâ”€â”€ open-tabs.ts
    â”‚   â”‚   â”œâ”€â”€ p-utils.ts
    â”‚   â”‚   â”œâ”€â”€ pluralize.test.ts
    â”‚   â”‚   â”œâ”€â”€ pluralize.ts
    â”‚   â”‚   â”œâ”€â”€ pr-commit-cleaner.test.ts
    â”‚   â”‚   â”œâ”€â”€ pr-commit-cleaner.ts
    â”‚   â”‚   â”œâ”€â”€ preserve-scroll.ts
    â”‚   â”‚   â”œâ”€â”€ recreate-element.ts
    â”‚   â”‚   â”œâ”€â”€ rgh-links.tsx
    â”‚   â”‚   â”œâ”€â”€ selector-observer.tsx
    â”‚   â”‚   â”œâ”€â”€ show-whitespace-on-line.test.ts
    â”‚   â”‚   â”œâ”€â”€ show-whitespace-on-line.tsx
    â”‚   â”‚   â”œâ”€â”€ smart-block-wrap.ts
    â”‚   â”‚   â”œâ”€â”€ types.d.ts
    â”‚   â”‚   â”œâ”€â”€ used-storage.ts
    â”‚   â”‚   â””â”€â”€ wait-for.ts
    â”‚   â””â”€â”€ options/
    â”‚       â”œâ”€â”€ feature-list.tsx
    â”‚       â”œâ”€â”€ header.svelte
    â”‚       â”œâ”€â”€ reload-without.ts
    â”‚       â”œâ”€â”€ storage-usage.svelte
    â”‚       â”œâ”€â”€ toggle-all.ts
    â”‚       â””â”€â”€ token-validation.tsx
    â”œâ”€â”€ test/
    â”‚   â”œâ”€â”€ setup-file.js
    â”‚   â”œâ”€â”€ shorten-link.test.ts
    â”‚   â”œâ”€â”€ __snapshots__/
    â”‚   â”‚   â””â”€â”€ shorten-link.test.ts.snap
    â”‚   â””â”€â”€ web-ext-profile/
    â”‚       â””â”€â”€ .gitkeep
    â””â”€â”€ .github/
        â”œâ”€â”€ funding.yml
        â”œâ”€â”€ pull_request_template.md
        â”œâ”€â”€ release.yml
        â”œâ”€â”€ ISSUE_TEMPLATE/
        â”‚   â”œâ”€â”€ 1_bug_report.yml
        â”‚   â”œâ”€â”€ 2_feature_request.yml
        â”‚   â”œâ”€â”€ 3_discussion.md
        â”‚   â””â”€â”€ config.yml
        â””â”€â”€ workflows/
            â”œâ”€â”€ actionlint.yml
            â”œâ”€â”€ conversation.yml
            â”œâ”€â”€ hotfixes.yml
            â”œâ”€â”€ pr.yml
            â”œâ”€â”€ relative-ci.yml
            â”œâ”€â”€ release.yml
            â””â”€â”€ test.yml

================================================
FILE: readme.md
================================================
# <img src="source/icon.png" width="45" align="left"> Refined GitHub

> Browser extension that simplifies the GitHub interface and adds useful features

We use GitHub a lot and notice many annoyances we'd like to fix. So here be dragons.

Our hope is that GitHub will notice and implement some of these much-needed improvements. So if you like any of these improvements, please open a discussion on [GitHub feedback](https://github.com/github-community/community/discussions) or contact [GitHub support](https://support.github.com/request) about doing it.

GitHub Enterprise is also supported: [How to enable it](https://fregante.github.io/webext-permission-toggle/?name=Refined%20GitHub&icon=https%3A%2F%2Fraw.githubusercontent.com%2Frefined-github%2Frefined-github%2Fmain%2Fsource%2Ficon.png). <!-- icon.png renders best -->

*The GITHUB and REFINED GITHUB trademarks are owned by GitHub, Inc. and used under license.*

## Install

[link-chrome]: https://chrome.google.com/webstore/detail/refined-github/hlepfoohegkhhmjieoechaddaejaokhf 'Version published on Chrome Web Store'
[link-firefox]: https://addons.mozilla.org/firefox/addon/refined-github-/ 'Version published on Mozilla Add-ons'
[link-safari]: https://apps.apple.com/app/id1519867270 'Version published on the Mac App Store'

[<img src="https://raw.githubusercontent.com/alrra/browser-logos/90fdf03c/src/chrome/chrome.svg" width="48" alt="Chrome" valign="middle">][link-chrome] [<img valign="middle" src="https://img.shields.io/chrome-web-store/v/hlepfoohegkhhmjieoechaddaejaokhf.svg?label=%20">][link-chrome] and other Chromium browsers

[<img src="https://raw.githubusercontent.com/alrra/browser-logos/90fdf03c/src/firefox/firefox.svg" width="48" alt="Firefox" valign="middle">][link-firefox] [<img valign="middle" src="https://img.shields.io/amo/v/refined-github-.svg?label=%20">][link-firefox] including Firefox Android

[<img src="https://raw.githubusercontent.com/alrra/browser-logos/90fdf03c/src/safari/safari_128x128.png" width="48" alt="Safari" valign="middle">][link-safari] [<img valign="middle" src="https://img.shields.io/itunes/v/1519867270.svg?label=%20">][link-safari] on Mac, iOS and iPadOS

[<img src="https://raw.githubusercontent.com/iamcal/emoji-data/08ec822c38e0b7a6fea0b92a9c42e02b6ba24a84/img-apple-160/1f99a.png" width="48" valign="middle">](https://github.com/sponsors/fregante) _If you love Refined GitHub, consider [sponsoring or hiring](https://github.com/sponsors/fregante) the maintainer [@fregante](https://twitter.com/fregante)_


<div align="center">

<table><tr><td width="550"><div align="center">
	<p><sup><a href="https://github.com/sponsors/fregante">@fregante</a>â€™s open source work is supported by the community.<br>Special thanks to:</sup></p>
	<p><a href="https://www.prisma.io/">
		<picture>
			<source media="(prefers-color-scheme: dark)" srcset="media/sponsor-prisma-dark.svg">
			<img width="250" alt="Prisma.io" src="media/sponsor-prisma-light.svg">
		</picture>
		<br><sup>Next-generation Node.js and TypeScript ORM with an intuitive data model, automated migrations, type-safety & auto-completion.</sup>
	</a></p>
	<p><a href="https://frappe.io/">
		<picture>
			<source media="(prefers-color-scheme: dark)" srcset="media/sponsor-frappe-dark.png">
			<img width="190" alt="Frappe" src="media/sponsor-frappe-light.png">
		</picture>
		<br><sup>Fully-featured low-code web framework and more world-class free and open-source software.</sup>
	</a></p>
</table>

</div>

---

## Highlights ğŸ”¥

<table>
	<tr>
		<th width="50%">
			<p><a title="show-whitespace"></a> Makes whitespace characters visible
			<p><img src="https://user-images.githubusercontent.com/1402241/61187598-f9118380-a6a5-11e9-985a-990a7f798805.png">
		<th width="50%">
			<p><a title="unreleased-commits"></a> Tells you whether you're looking at the latest version of a repository, or if there are any unreleased commits
			<p><img src="https://github-production-user-asset-6210df.s3.amazonaws.com/1402241/267236196-8564c193-a3c7-4248-9735-54749c1990c7.png">
	<tr>
		<th width="50%">
			<p><a title="pr-base-commit"></a> Shows how far behind a PR head branch is + tells you its base commit
			<p><img src="https://user-images.githubusercontent.com/1402241/234492651-b54bf9ba-c218-4a30-bed4-f85a7f037297.png">
		<th width="50%">
			<p><a title="conversation-activity-filter"></a> Lets you hide every event except comments or unresolved comments in issues and PRs
			<p><img src="https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/252116522-053bce84-5c55-477b-8cc2-42a48104fb02.png">
	<tr>
		<th width="50%">
			<p><a title="status-subscription"></a> Lets you subscribe to opening/closing events of issues in one click
			<p><img src="https://github-production-user-asset-6210df.s3.amazonaws.com/1402241/238186901-cbc98b51-d173-40c6-b21e-5f0bae3d800c.png">
		<th width="50%">
			<p><a title="default-branch-button"></a> Adds a link to the default branch on directory listings and files
			<p><img src="https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/252176294-9130783c-51aa-4df9-9c35-9b87c179199a.png">
	<tr>
		<th width="50%">
			<p><a title="restore-file"></a> Adds a button to discard all the changes to a file in a PR
			<p><img src="https://user-images.githubusercontent.com/1402241/236630610-e11a64f6-5e70-4353-89b8-39aae830dd16.gif">
		<th width="50%">
			<p><a title="select-notifications"></a> Select notifications by type and status
			<p><img src="https://user-images.githubusercontent.com/83146190/252175851-e0826d3b-1990-4bff-ba09-71892463818e.gif">
</table>

### Repositories

<!--
Refer to style guide in the wiki. Keep this message between sections.
https://github.com/refined-github/refined-github/wiki/Contributing#metadata-guidelines
-->

- [](# "ci-link") ğŸ”¥ [Adds a build/CI status icon next to the repoâ€™s name.](https://github-production-user-asset-6210df.s3.amazonaws.com/1402241/237923995-5e14a272-0bf2-4fe4-b409-8c05378aa4fd.png)
- [](# "more-dropdown-links") [Adds useful links to the repository navigation dropdown](https://user-images.githubusercontent.com/16872793/124681432-856e6f80-de96-11eb-89c9-6d78e8ae4329.png)
- [](# "swap-branches-on-compare") [Adds a link to swap branches in the branch compare view.](https://user-images.githubusercontent.com/44045911/230370539-ebc94246-864f-48f2-85fa-7318fc1f6d71.png)
- [](# "repo-age") [Displays the age of the repository in the sidebar.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/252176778-f8260312-d0dc-41b5-a4d1-ca680208d347.png)
- [](# "show-open-prs-of-forks") [In your forked repos, shows number of your open PRs to the original repo.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/252177140-94165582-628b-45b6-9a62-faf0c7fc2335.png)
- [](# "clean-repo-filelist-actions") [Makes some buttons on repository lists more compact to make room for other features.](https://user-images.githubusercontent.com/1402241/108955170-52d48080-7633-11eb-8979-67e0d3a53f16.png)
- [](# "new-repo-disable-projects-and-wikis") [Automatically disables projects and wikis when creating a repository.](https://github.com/user-attachments/assets/2537e5a0-f537-4901-8d11-96c1f536663e)
- [](# "sticky-sidebar") [Makes sidebars sticky in repositories, issues, and PRs, if they fit the viewport.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/252179311-ea6d42dc-1525-401a-bc4d-404cf8fa1785.gif)
- [](# "link-to-github-io") [Adds a link to visit the userâ€™s github.io website from its repo.](https://user-images.githubusercontent.com/34235681/152473104-c4723999-9239-48fd-baee-273b01c4eb87.png)
- [](# "github-actions-indicators") [In the workflows sidebar, shows an indicator that a workflow can be triggered manually, and its next scheduled time if relevant.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/252181237-a1d809b1-e5d4-4747-9654-7dde5ab5c61a.png)
- [](# "quick-repo-deletion") [Simplifies the deletion of repositories. Adds "Delete fork" button on 0-star repos. Enables <kbd>shift</kbd> <kbd>alt</kbd> clicks to delete repos in 2 clicks.](https://github.com/user-attachments/assets/9e05ec18-680d-4fbd-acbd-2b5b3505c5b5)
- [](# "archive-forks-link") [Helps you find forks on archived repos.](https://user-images.githubusercontent.com/1402241/230362566-12493c80-bffe-4c7a-b9ba-4a11b1358ab0.png)
- [](# "clean-repo-tabs") [Moves the "Security" and "Insights"  to the repository navigation dropdown. Also moves the "Projects", "Actions" and "Wiki" tabs if they're empty/unused.](https://user-images.githubusercontent.com/16872793/124681343-4a6c3c00-de96-11eb-9055-a8fc551e6eb8.png)
- [](# "repo-avatars") [Adds the profile picture to the header of public repositories.](https://github-production-user-asset-6210df.s3.amazonaws.com/1402241/255323568-aee4d90e-844e-41e8-880a-ce466826516c.png)
- [](# "quick-new-issue") [Adds a link to create issues from anywhere in a repository.](https://github-production-user-asset-6210df.s3.amazonaws.com/1402241/274816033-820ec518-049d-4248-9f8a-27b9423e350b.png)
- [](# "small-user-avatars") [Shows a small avatar next to the username in issue/PR lists and mentions.](https://github-production-user-asset-6210df.s3.amazonaws.com/1402241/271184107-24ec471e-54d1-434a-a5f2-615902d2cad9.png)
- [](# "action-pr-link") ğŸ”¥ [Adds a link back to the PR that ran the workflow.](https://github-production-user-asset-6210df.s3.amazonaws.com/50487467/241645264-076a0137-36a2-4fd0-a66e-735ef3b3a563.png)
- [](# "mobile-tabs") [Makes the tabs more compact on mobile so more of them can be seen.](https://user-images.githubusercontent.com/1402241/245446231-28f44b59-0151-4986-8cb9-05b5645592d8.png)
- [](# "repo-header-info") [Shows whether a repo is a fork and adds the number of stars to its header.](https://github-production-user-asset-6210df.s3.amazonaws.com/1402241/267216946-404d79ab-46d7-4bc8-ba88-ae8f8029150d.png)
- [](# "visit-tag") [When navigating a repo's file on a specific tag, it adds a link to see the release/tag itself.](https://github-production-user-asset-6210df.s3.amazonaws.com/1402241/285123739-e5f4fa0a-3f48-49ef-9b87-2fd6f183c923.png)
- [](# "actions-run-removal") [Lets you cancel or delete workflow runs faster from the workflow list.](https://github.com/user-attachments/assets/a054f9b4-9d56-40c0-9aac-09a8b07bbb3b)

<!--
Refer to style guide in the wiki. Keep this message between sections.
https://github.com/refined-github/refined-github/wiki/Contributing#metadata-guidelines
-->

### File management

- [](# "download-folder-button") [Adds a button to download entire folders](https://user-images.githubusercontent.com/46634000/158347358-49234bb8-b9e6-41be-92ed-c0c0233cbad2.png), via https://download-directory.github.io.
- [](# "quick-file-edit") [Adds a button to edit files from the repo file list.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/252182890-081975f4-f041-4ba5-ae48-d52cb0796543.png)
- [](# "repo-wide-file-finder") Enables the File Finder keyboard shortcut (<kbd>t</kbd>) on entire repository.
- [](# "show-associated-branch-prs-on-fork") [Shows the associated PRs on branches for forked repositories.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/260873542-2a7fc7a2-231f-4f2e-9c7e-272d894de4c6.png)
- [](# "html-preview-link") [Adds a link to preview HTML files.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/260874191-69d386a0-7c1f-42ae-84fd-4f67f90982da.png)
- [](# "file-age-color") [Highlights the most-recently-modified items in file lists.](https://user-images.githubusercontent.com/1402241/218314631-1442cc89-3616-40fc-abe2-9ba3d3697b6a.png)
- [](# "previous-version") [Lets you see the previous version of a file in one click.](https://github.com/refined-github/refined-github/assets/1402241/bc82cc77-bde2-4683-98a6-012c87b4a319)

<!--
Refer to style guide in the wiki. Keep this message between sections.
https://github.com/refined-github/refined-github/wiki/Contributing#metadata-guidelines
-->

### Code

- [](# "linkify-code") [Linkifies issue/PR references and URLs in code.](https://cloud.githubusercontent.com/assets/170270/25370217/61718820-29b3-11e7-89c5-2959eaf8cac8.png)
- [](# "copy-on-y") Enhances [the <kbd>y</kbd> hotkey](https://help.github.com/articles/getting-permanent-links-to-files/) to also copy the permalink.
- [](# "linkify-symbolic-links") [Linkifies symbolic links files.](https://user-images.githubusercontent.com/1402241/62036664-6d0e6880-b21c-11e9-9270-4ae30cc10de2.png)
- [](# "list-prs-for-file") [Alerts you if the current file is altered by an open PR.](https://user-images.githubusercontent.com/1402241/234559302-b9911ac2-a1bb-4f8a-8e88-078d631cde18.png)
- [](# "refined-github.css") [Reduces tabsâ€™ size to 4 spaces instead of 8](https://cloud.githubusercontent.com/assets/170270/14170088/d3be931e-f755-11e5-8edf-c5f864336382.png) where GitHub doesn't follow [the userâ€™s preferences.](https://github.com/settings/appearance)
- [](# "esc-to-deselect-line") [Adds a keyboard shortcut to deselect the current line: <kbd>esc</kbd>.](https://github.com/refined-github/refined-github/issues/1590)
- [](# "vertical-front-matter") [Shows Markdown front matter as vertical table.](https://user-images.githubusercontent.com/44045911/87251695-26069b00-c4a0-11ea-9077-53ce366490ed.png)
- [](# "list-prs-for-branch") [On branch commit lists, shows the PR that touches the current branch.](https://user-images.githubusercontent.com/16872793/119760295-b8751a80-be77-11eb-87da-91d0c403bb49.png)

<!--
Refer to style guide in the wiki. Keep this message between sections.
https://github.com/refined-github/refined-github/wiki/Contributing#metadata-guidelines
-->

### Writing comments

- [](# "tab-to-indent") ğŸ”¥ [Enables <kbd>tab</kbd> and <kbd>shift</kbd>â€‰<kbd>tab</kbd> for indentation in comment fields.](https://user-images.githubusercontent.com/1402241/33802977-beb8497c-ddbf-11e7-899c-698d89298de4.gif)
- [](# "collapsible-content-button") [Adds a button in the text editor to insert collapsible content (via `<details>`).](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/260875648-bd495d27-4cd1-4190-bcc5-b8b476f07d39.png)
- [](# "fit-textareas") ğŸ”¥ [Auto-resizes comment fields to fit their content and no longer show scroll bars.](https://user-images.githubusercontent.com/1402241/54336211-66fd5e00-4666-11e9-9c5e-111fccab004d.gif)
- [](# "quick-comment-edit") [Lets you edit any comment with one click instead of having to open a dropdown.](https://user-images.githubusercontent.com/46634000/162252055-54750c89-0ddc-487a-b4ad-cec6009d9870.png)
- [](# "one-key-formatting") [Wraps selected text when pressing one of Markdown symbols instead of replacing it:](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/261155564-e7aabd0e-b14b-4fe6-b379-62e7419c43f8.gif) `[` `` ` `` `'` `"` `*` `~` `_`
- [](# "clean-rich-text-editor") [Hides unnecessary comment field tooltips and toolbar items](https://user-images.githubusercontent.com/46634000/158201651-7364aba7-f9d0-4a51-89c4-2ced0cc34e48.png) (each one has a keyboard shortcut.)
- [](# "quick-mention") [Adds a button to `@mention` a user in issues and PRs.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/261158402-5a79cc3e-4331-475f-8063-5ed81fefcf10.gif)
- [](# "table-input") [Adds a button in the text editor to quickly insert a simplified HTML table.](https://user-images.githubusercontent.com/46634000/94559114-09892c00-0261-11eb-8fb0-c5a85ea76b6f.gif)
- [](# "unfinished-comments") [Notifies the user of unfinished comments in hidden tabs.](https://user-images.githubusercontent.com/1402241/97792086-423d5d80-1b9f-11eb-9a3a-daf716d10b0e.gif)
- [](# "quick-review-comment-deletion") [Adds a button to delete review comments in one click when editing them.](https://user-images.githubusercontent.com/46634000/115445792-9fdd6900-a216-11eb-9ba3-6dab4d2f9d32.png)
- [](# "avoid-accidental-submissions") [Disables the <kbd>enter</kbd>-to-submit shortcut in some commit/PR/issue title fields to avoid accidental submissions. Use <kbd>ctrl</kbd> <kbd>enter</kbd> instead.](https://user-images.githubusercontent.com/723651/125863341-6cf0bce0-f120-4cec-ac1f-1ce35920e7a7.gif)
- [](# "no-self-reference") [Warns against self-reference links, helping you avoid mistakes.](https://github.com/user-attachments/assets/f5f7a3da-513e-4eff-9571-1cdb72fac2bd)

<!--
Refer to style guide in the wiki. Keep this message between sections.
https://github.com/refined-github/refined-github/wiki/Contributing#metadata-guidelines
-->

### Reading comments

- [](# "reactions-avatars") ğŸ”¥ [Adds reaction avatars showing _who_ reacted to a comment.](https://user-images.githubusercontent.com/1402241/236628453-8b646178-b838-44a3-9541-0a9b5f54a84a.png)
- [](# "embed-gist-inline") [Embeds short gists when linked in comments on their own lines.](https://user-images.githubusercontent.com/1402241/152117903-80d784d5-4f43-4786-bc4c-d4993aec5c79.png)
- [](# "comments-time-machine-links") Adds links to [browse the repository](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/252749373-9313f1d9-3d92-44a2-a1d1-2b49a29e6a5c.png) and [linked files](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/252749616-085103bf-17be-4a7d-b63c-aa5003de6dff.png) at the time of each comment.
- [](# "show-names") [Adds the real name of users by their usernames.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/252756294-94785dc2-423e-498c-939a-359a012036e0.png)
- [](# "shorten-links") [Shortens URLs and repo URLs to readable references like "_user/repo/.file@`d71718d`".](https://user-images.githubusercontent.com/1402241/27252232-8fdf8ed0-538b-11e7-8f19-12d317c9cd32.png)
- [](# "preview-hidden-comments") ğŸ”¥ [Previews hidden comments inline.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/262556553-ca04b870-9adb-4a8c-a6d0-6238863948be.png)
- [](# "highest-rated-comment") ğŸ”¥ [Highlights the most useful comment in issues.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/252763905-a0c3b074-b032-4d97-946e-328e8a6fb2da.png)
- [](# "hide-low-quality-comments") [Hides reaction comments ("+1", "ğŸ‘", â€¦)](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/258220965-4743b9b9-2aef-41b3-a905-ccf8d7beb74e.png) (except the maintainersâ€™) [but they can still be shown.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/258221444-e43f2486-5ba1-40b5-aa1d-d9d5768e8c0a.png)
- [](# "scrollable-areas") [Limits the height of tall code blocks and quotes.](https://github.com/refined-github/refined-github/issues/1123)
- [](# "quick-comment-hiding") [Simplifies the UI to hide comments.](https://user-images.githubusercontent.com/1402241/43039221-1ddc91f6-8d29-11e8-9ed4-93459191a510.gif)
- [](# "open-issue-to-latest-comment") [Makes the "comment" icon in issue lists link to the latest comment of the issue.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/261159396-0610574b-ab1f-42fb-813f-ee7310a1e5b6.png)
- [](# "expand-all-hidden-comments") [On long conversations where GitHub hides comments under a "N hidden items. Load more...", alt-clicking it will load up to 200 comments at once instead of 60.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/261160123-9c4f894b-38c0-446f-af50-9beca7ff1f74.png)
- [](# "keyboard-navigation") [Adds shortcuts to issues, PRs conversations, and PR file lists: <kbd>j</kbd> focuses the comment/file below; <kbd>k</kbd> focuses the comment/file above.](https://user-images.githubusercontent.com/1402241/86573176-48665900-bf74-11ea-8996-a5c46cb7bdfd.gif)
- [](# "comment-excess") [Informs you that there are hidden comments in the header of long issues. Also scrolls down to the hidden comments when pressing Cmd+F or Ctrl+F.](https://github.com/refined-github/refined-github/assets/1402241/4e4660f9-c987-4b0d-82ca-56ef29952c31)

<!--
Refer to style guide in the wiki. Keep this message between sections.
https://github.com/refined-github/refined-github/wiki/Contributing#metadata-guidelines
-->

### Conversations

- [](# "open-all-conversations") [Lets you open all visible issues/PRs at once.](https://github.com/user-attachments/assets/0d890b01-d5ca-4247-8270-055dd6355606)
- [](# "sticky-conversation-list-toolbar") [Makes the issue/PR listâ€™s filters toolbar sticky.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/261164103-875b70f7-5adc-4bb2-b158-8d5231d47da2.gif)
- [](# "sticky-comment-header") [Makes the comment header sticky when scrolling through long comments. Requires `show-names` to be enabled.](https://github.com/user-attachments/assets/0d6deca0-0f49-4aa3-ab23-0cfbde4fa4e8)
- [](# "conversation-authors") [Highlights issues/PRs opened by you or the current repoâ€™s collaborators.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/252804821-a412e05c-fb76-400b-85b5-5acbda538ab2.png)
- [](# "align-issue-labels") [In issue/PR lists, aligns the labels to the left, below each title.](https://github.com/user-attachments/assets/dca5dc12-7283-4704-a93f-5bfe5f2b1938)
- [](# "sort-conversations-by-update-time") ğŸ”¥ Changes the default sort order of issues/PRs to `Recently updated`.
- [](# "more-conversation-filters") [Adds `Everything youâ€™re involved in` and `Everything you subscribed to` filters in the search box dropdown.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/253043952-cfb99cea-1c7b-43ad-9144-9d84bda8206f.png)
- [](# "global-conversation-list-filters") [Adds filters for PRs _in your repos_ and _commented on by you_ in the global PR search.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/253048449-2f7cc331-c379-4ec0-a542-441e8b4f8d79.png)
- [](# "clean-conversation-sidebar") ğŸ”¥ [Hides empty sections (or just their "empty" label) in the issue/PR sidebar.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/253054419-48c38c01-b1dc-42ca-9ff6-fd63392b5921.png)
- [](# "clean-conversation-filters") [Hides `Projects` filter in issue/PR lists if it is empty.](https://github.com/user-attachments/assets/b690405f-b138-413d-9779-9467c160e802)
- [](# "toggle-everything-with-alt") [Adds a shortcut to toggle all similar items (minimized comments, deferred diffs, etc) at once: <kbd>alt</kbd> <kbd>click</kbd> on each button or checkbox.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/253063446-6f556e7d-2ac5-439d-92f0-0c6d719fc86f.gif)
- [](# "extend-conversation-status-filters") [Lets you toggle between is:open/is:closed/is:merged filters in searches.](https://user-images.githubusercontent.com/1402241/73605061-2125ed00-45cc-11ea-8cbd-41a53ae00cd3.gif)
- [](# "bugs-tab") [Adds a "Bugs" tab to repos, if there are any open issues with the "bug" label.](https://user-images.githubusercontent.com/46634000/156766081-f2ea100b-a9f3-472b-bddc-a984a88ddcd3.png)
- [](# "pinned-issues-update-time") [Replaces the "opened" time with the "updated" time on pinned issues.](https://github-production-user-asset-6210df.s3.amazonaws.com/1402241/240707405-e416be14-5ab5-4869-b33c-f43aab7afcb6.png)
- [](# "clean-pinned-issues") [Changes the layout of pinned issues from side-by-side to a standard list.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/258224321-e8ee8c70-6952-4a42-8626-6b5f31d167a3.png)
- [](# "quick-label-removal") [Adds one-click buttons to remove labels in issues/PRs.](https://user-images.githubusercontent.com/36174850/89980178-0bc80480-dc7a-11ea-8ded-9e25f5f13d1a.gif)
- [](# "clean-conversation-headers") [Removes duplicate information in the header of issues and PRs ("User wants to merge X commits from Y into Z")](https://user-images.githubusercontent.com/44045911/112314137-a34b0680-8ce3-11eb-9e0e-8afd6c8235c2.png)
- [](# "dim-bots") [Dims commits and PRs by bots to reduce noise.](https://user-images.githubusercontent.com/1402241/220607557-f8ea0863-f05b-48c8-a447-1fec42af0afd.gif)
- [](# "esc-to-cancel") [Adds a shortcut to cancel editing a issue/PR title: <kbd>esc</kbd>.](https://user-images.githubusercontent.com/35100156/98303086-d81d2200-1fbd-11eb-8529-70d48d889bcf.gif)
- [](# "no-duplicate-list-update-time") [Hides the update time of issues/PRs in lists when it matches the open/closed/merged time.](https://user-images.githubusercontent.com/1402241/111357166-ac3a3900-864e-11eb-884a-d6d6da88f7e2.png)
- [](# "linkify-user-labels") [Links the "Contributor" and "Member" labels on comments to the authorâ€™s commits on the repo.](https://user-images.githubusercontent.com/1402241/177033344-4d4eea63-e075-4096-b2d4-f4b879f1df31.png)
- [](# "jump-to-conversation-close-event") [Adds a link to jump to the latest close event of a issue/PR.](https://user-images.githubusercontent.com/16872793/177792713-64219754-f8df-4629-a9ec-33259307cfe7.gif)
- [](# "close-as-unplanned") [Lets you "close issue as unplanned" in one click instead of three.](https://github-production-user-asset-6210df.s3.amazonaws.com/1402241/279745773-709cde60-c26a-4a0e-89e1-56444d25ebdf.png)
- [](# "locked-issue") [Show a label on locked issues and PRs.](https://user-images.githubusercontent.com/1402241/283015579-0a04becc-9bff-4aef-8770-272d6804970b.png)

<!--
Refer to style guide in the wiki. Keep this message between sections.
https://github.com/refined-github/refined-github/wiki/Contributing#metadata-guidelines
-->

### Viewing pull requests

- [](# "linkify-commit-sha") [Adds a link to the non-PR commit when visiting a PR commit.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/261164635-b3caa3fa-3bb6-41a5-90d3-4aba84517da6.png)
- [](# "pr-filters") [Adds Checks and Draft PR dropdown filters in PR lists.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/253068868-6afb4656-4ef5-4846-89c5-24dc6ee7f839.png)
- [](# "unclip-checks") [Automatically shows all checks without scrolling when expanding the checks panel.](https://github.com/user-attachments/assets/785fffab-43e8-4f79-8170-7c264111df9f)
- [](# "pr-approvals-count") [Shows color-coded review counts in PR lists.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/253125143-d10d95df-4a89-4692-b218-5eba5cd79906.png)
- [](# "highlight-non-default-base-branch") [Shows the base branch in PR lists if itâ€™s not the default branch.](https://user-images.githubusercontent.com/1402241/88480306-39f4d700-cf4d-11ea-9e40-2b36d92d41aa.png)
- [](# "hide-inactive-deployments") [Hides inactive deployments in PRs.](https://github.com/refined-github/refined-github/issues/1144)
- [](# "previous-next-commit-buttons") [Adds duplicate commit navigation buttons at the bottom of the `Commits` tab page.](https://user-images.githubusercontent.com/24777/41755271-741773de-75a4-11e8-9181-fcc1c73df633.png)
- [](# "hidden-review-comments-indicator") [Adds comment indicators when comments are hidden in PR review.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/253128043-a10eaf9e-ff81-48db-b67c-ee823804c859.gif)
- [](# "conflict-marker") [Shows which PRs have conflicts in PR lists.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/253128438-d67c8f49-44f1-4e15-9363-a717109fef39.png)
- [](# "pr-commit-lines-changed") [Adds diff stats on PR commits.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/253130044-494cd822-c460-42dc-8f65-44454a9d18e3.png)
- [](# "cross-deleted-pr-branches") [Adds a line-through to the deleted branches in PRs.](https://github-production-user-asset-6210df.s3.amazonaws.com/140871606/256963526-646ac7d0-3e7f-40c6-ba39-014b49bc0063.png)
- [](# "batch-mark-files-as-viewed") [Mark/unmark multiple files as â€œViewedâ€ in the PR Files tab. Click on the first checkbox you want to mark/unmark and then `shift`-click another one; all the files between the two checkboxes will be marked/unmarked as â€œViewedâ€.](https://github-production-user-asset-6210df.s3.amazonaws.com/140871606/257009611-17249bee-d2e2-42ac-bdf0-ebc90029544e.gif)
- [](# "closing-remarks") ğŸ”¥ [Shows the first Git tag a merged PR was included in or suggests creating a release if not yet released.](https://user-images.githubusercontent.com/1402241/169497171-85d4a97f-413a-41b4-84ba-885dca2b51cf.png)
- [](# "pr-jump-to-first-non-viewed-file") [Jumps to first non-viewed file in a PR when clicking on the progress bar.](https://github-production-user-asset-6210df.s3.amazonaws.com/140871606/257011208-764f509d-fed9-424b-84e9-c01cf2fd428b.gif)
- [](# "jump-to-change-requested-comment") [Adds a link to jump to the latest changed requested comment.](https://user-images.githubusercontent.com/19198931/98718312-418b9f00-23c9-11eb-8da2-dfb616e95eb6.gif)
- [](# "view-last-pr-deployment") [Adds a link to open the latest deployment from the header of a PR.](https://user-images.githubusercontent.com/44045911/232313171-b54ac9cc-ebb1-43ef-bd41-5d81ec9f9588.png)
- [](# "no-unnecessary-split-diff-view") [Always uses unified diffs on files where split diffs arenâ€™t useful.](https://user-images.githubusercontent.com/46634000/121495005-89af8600-c9d9-11eb-822d-77e0b987e3b1.png)
- [](# "emphasize-draft-pr-label") [Makes it easier to distinguish draft PR in lists.](https://user-images.githubusercontent.com/1402241/218252438-062a1ab3-4437-436d-9140-87bee23aaefb.png)

<!--
Refer to style guide in the wiki. Keep this message between sections.
https://github.com/refined-github/refined-github/wiki/Contributing#metadata-guidelines
-->

### Editing pull requests

- [](# "sync-pr-commit-title") ğŸ”¥ [Uses the PRâ€™s title as the default squash commit title](https://github.com/refined-github/refined-github/issues/276) and [updates the PRâ€™s title to match the commit title, if changed.](https://github-production-user-asset-6210df.s3.amazonaws.com/140871606/257011579-25332762-b25f-407b-b6d2-bbfc13de2be7.png)
- [](# "update-pr-from-base-branch") [Adds an "Update branch" button to every PR.](https://user-images.githubusercontent.com/1402241/234483592-4867cb2e-21cb-436d-9ea0-aedadf834f19.png) GitHub has the same feature, but it must be manually configured with protected branches.
- [](# "one-click-review-submission") [Simplifies the PR review form: Approve or reject reviews faster with one-click review-type buttons.](https://user-images.githubusercontent.com/1402241/236627732-df341ff7-cd98-4cd0-a579-722d1fffa5cf.png)
- [](# "pull-request-hotkeys") [Adds keyboard shortcuts to cycle through PR tabs: <kbd>g</kbd> <kbd>â†</kbd> and <kbd>g</kbd> <kbd>â†’</kbd>, or <kbd>g</kbd> <kbd>1</kbd>, <kbd>g</kbd> <kbd>2</kbd>, <kbd>g</kbd> <kbd>3</kbd>, and <kbd>g</kbd> <kbd>4</kbd>](https://user-images.githubusercontent.com/16872793/94634958-7e7b5680-029f-11eb-82ea-1f96cd11e4cd.png).
- [](# "pr-branch-auto-delete") [Automatically deletes the branch right after merging a PR, if possible.](https://user-images.githubusercontent.com/1402241/177067141-eabc7494-38a2-45b5-aef9-ac33cc0da370.png) Common branch names known to be long-lived are excluded (`develop`, `release/*`, etc)
- [](# "one-click-pr-or-gist") [Lets you create draft PRs and public gists in one click.](https://user-images.githubusercontent.com/34235681/152473201-868ad7c1-e06f-4826-b808-d90bca7f08b3.png)
- [](# "clear-pr-merge-commit-message") [Clears the PR merge commit message of clutter, leaving only deduplicated co-authors.](https://user-images.githubusercontent.com/1402241/79257078-62b6fc00-7e89-11ea-8798-c06f33baa94b.png)
- [](# "quick-review") [Adds quick-review buttons to the PR sidebar, automatically focuses the review textarea, and adds a keyboard shortcut to open the review popup: <kbd>v</kbd>.](https://github.com/refined-github/refined-github/assets/1402241/f11039c4-c9d1-4adc-9a65-cfe1f2027ec3)
- [](# "pr-first-commit-title") [Uses the first commit for a new PRâ€™s title and description.](https://user-images.githubusercontent.com/16872793/87246205-ccf42400-c419-11ea-86d5-0e6570d99e6e.gif)

<!--
Refer to style guide in the wiki. Keep this message between sections.
https://github.com/refined-github/refined-github/wiki/Contributing#metadata-guidelines
-->

### Commits

- [](# "patch-diff-links") [Adds links to `.patch` and `.diff` files in commits.](https://github-production-user-asset-6210df.s3.amazonaws.com/140871606/257011950-51712338-ffba-4b71-ad8f-9a0f142afb85.png)
- [](# "more-file-links") [Adds links to view the raw version, the blame, and the history of files in PRs and commits.](https://user-images.githubusercontent.com/46634000/145016304-aec5a8b8-4cdb-48e6-936f-b214a3fb4b49.png)
- [](# "one-click-diff-options") [Adds one-click buttons to change diff style and to ignore the whitespace and a keyboard shortcut to ignore the whitespace: <kbd>d</kbd>â€‰<kbd>w</kbd>.](https://user-images.githubusercontent.com/46634000/156766044-18c9ff50-aead-4c40-ba16-7428b3742b6c.png)
- [](# "extend-diff-expander") [Widens the `Expand diff` button to be clickable across the screen.](https://user-images.githubusercontent.com/1402241/152118201-f25034c7-6fae-4be0-bb3f-c217647e32b7.gif)
- [](# "hide-diff-signs") [Hides diff signs since diffs are color coded already.](https://user-images.githubusercontent.com/1402241/54807718-149cec80-4cb9-11e9-869c-e265863211e3.png)
- [](# "suggest-commit-title-limit") [Suggests limiting commit and PR titles to 72 characters.](https://github.com/user-attachments/assets/e0392989-9c60-4f5c-9052-27a3bb51d4e4)
- [](# "tags-on-commits-list") [Displays the corresponding tags next to commits.](https://user-images.githubusercontent.com/1402241/285106537-3c882cb2-6847-4098-9e51-cf2951dee818.png)
- [](# "mark-merge-commits-in-list") [Marks merge commits in commit lists.](https://github-production-user-asset-6210df.s3.amazonaws.com/1402241/285106996-9bdbc938-69c4-4692-8d47-11e30676de62.png)
- [](# "deep-reblame") [When exploring blames, `Alt`-clicking the â€œReblameâ€ buttons will extract the associated PRâ€™s commits first, instead of treating the commit as a single change.](https://github-production-user-asset-6210df.s3.amazonaws.com/140871606/257035884-732ee7ff-22c5-4049-af7d-f11117d2bbe4.png)
- [](# "new-or-deleted-file") [Indicates with an icon whether files in commits and PRs are being added or removed.](https://user-images.githubusercontent.com/1402241/90332474-23262b00-dfb5-11ea-9a03-8fd676ea0fdd.png)
- [](# "easy-toggle-files") [Enables toggling file diffs by clicking on their header bar.](https://user-images.githubusercontent.com/47531779/99855419-be173e00-2b7e-11eb-9a55-0f6251aeb0ef.gif)
- [](# "same-branch-author-commits") [Preserves current branch and path when viewing all commits by an author.](https://user-images.githubusercontent.com/44045911/148764372-ee443213-e61a-4227-9219-0ee54ed832e8.png)
- [](# "easy-toggle-commit-messages") [Enables toggling commit messages by clicking on the commit box.](https://user-images.githubusercontent.com/1402241/152121837-ca13bf8a-9b7f-4517-8e8d-b58bb135523b.gif)
- [](# "link-to-compare-diff") [Linkifies the "X files changed" text on compare pages to allow jumping to the diff.](https://user-images.githubusercontent.com/46634000/157072587-0335357a-18c7-44c4-ae6e-237080fb36b4.png)
- [](# "conventional-commits") [Shows conventional commit types as labels before the commit message.](https://github.com/user-attachments/assets/980a2d5e-13c2-4b1b-bb80-81dc94723000)

<!--
Refer to style guide in the wiki. Keep this message between sections.
https://github.com/refined-github/refined-github/wiki/Contributing#metadata-guidelines
-->

### Tags and releases

- [](# "release-download-count") [Adds a download count next to release assets.](https://user-images.githubusercontent.com/1402241/197958719-1577bc1b-1f4d-44a8-98c2-2645b7b14d31.png)
- [](# "releases-tab") [Adds a `Releases` tab and a keyboard shortcut: <kbd>g</kbd> <kbd>r</kbd>.](https://cloud.githubusercontent.com/assets/170270/13136797/16d3f0ea-d64f-11e5-8a45-d771c903038f.png)
- [](# "releases-dropdown") [Adds a tags dropdown/search on release pages.](https://user-images.githubusercontent.com/1402241/231678527-f0a96112-9c30-4b49-8205-efa472bd880e.png)
- [](# "create-release-shortcut") Adds a keyboard shortcut to create a new release while on the Releases page: <kbd>c</kbd>.
- [](# "tag-changes-link") ğŸ”¥ [Adds a link to changes since last tag/release for each tag/release.](https://github-production-user-asset-6210df.s3.amazonaws.com/140871606/257036739-bebafb94-cb94-4053-9768-ff97306ab862.png)
- [](# "convert-release-to-draft") [Adds a button to convert a release to draft.](https://user-images.githubusercontent.com/46634000/139236979-44533bfd-5c17-457d-bdc1-f9ec395f6a3a.png)
- [](# "link-to-changelog-file") [Adds a button to view the changelog file from the releases page.](https://user-images.githubusercontent.com/46634000/139236982-a1bce2a2-f3aa-40a9-bca4-8756bc941210.png)

<!--
Refer to style guide in the wiki. Keep this message between sections.
https://github.com/refined-github/refined-github/wiki/Contributing#metadata-guidelines
-->

### Profiles

- [](# "user-profile-follower-badge") [On profiles, it shows whether the user follows you.](https://github-production-user-asset-6210df.s3.amazonaws.com/1402241/263206287-c8e1b94c-ec80-4394-bbb3-1cf6fb08b807.png)
- [](# "profile-gists-link") [Adds a link to the userâ€™s public gists on their profile.](https://user-images.githubusercontent.com/44045911/87950518-f7a94100-cad9-11ea-8393-609fad70635c.png)
- [](# "mark-private-orgs") [Marks private organizations on your own profile.](https://github.com/user-attachments/assets/145a7a97-7b8c-4ac4-8288-f72dcb4613ea)
- [](# "profile-hotkey") Adds a keyboard shortcut to visit your own profile: <kbd>g</kbd> <kbd>m</kbd>.
- [](# "show-user-top-repositories") [Adds a link to the userâ€™s most starred repositories.](https://user-images.githubusercontent.com/1402241/48474026-43e3ae80-e82c-11e8-93de-159ad4c6f283.png)
- [](# "hide-user-forks") [Filters out forks and archived repos from profiles by default, leaving only the sources.](https://github-production-user-asset-6210df.s3.amazonaws.com/1402241/263195425-85cf0951-c6ed-45fe-8cfc-e447e3ed2a25.png) [(but they can still be shown.)](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/262547829-2da96718-fb18-4f2e-b637-8157f552e278.png)
- [](# "linkify-user-location") [Linkifies the user location in their hovercard and profile page.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/262554067-43bea584-cdb4-41c7-b0fa-f487e7ef8807.png)
- [](# "conversation-links-on-repo-lists") [Adds a link to the issues and pulls on the user profile repository tab and global search.](https://user-images.githubusercontent.com/16872793/78712349-82c54900-78e6-11ea-8328-3c2d39a78862.png)

<!--
Refer to style guide in the wiki. Keep this message between sections.
https://github.com/refined-github/refined-github/wiki/Contributing#metadata-guidelines
-->

### Notifications

- [](# "open-all-notifications") [Adds a button to the notification page to open all your unread notifications at once.](https://github-production-user-asset-6210df.s3.amazonaws.com/140871606/257085496-17e5c6fa-6bad-443d-96d2-d97e73cd1a5e.png)
- [](# "unread-anywhere") ğŸ”¥ [Adds a button to the global header to open your unread notifications from any page.](https://github.com/user-attachments/assets/978ac1fe-db98-40f9-9b56-7d289849aa2f)
- [](# "select-all-notifications-shortcut") Adds a shortcut to select all visible notifications: <kbd>a</kbd>.
- [](# "stop-redirecting-in-notification-bar") [Stops redirecting to notification inbox from notification bar actions while holding <kbd>Alt</kbd>.](https://user-images.githubusercontent.com/202916/80318782-c38cef80-880c-11ea-9226-72c585f42a51.png)
- [](# "last-notification-page-button") [Adds a link to the last page of notifications.](https://user-images.githubusercontent.com/16872793/199828181-3ff2cef3-8740-4efa-8122-8f2f222bd657.png)
- [](# "pr-notification-link") [Points PR notifications to the Conversation tabs instead of the commits page, which may be a 404.](https://github.com/refined-github/refined-github/assets/1402241/621f6512-655e-4565-a37b-2b159ea0ffce)
- [](# "sticky-notifications-actions") [Make the notifications action bar sticky.](https://github.com/refined-github/refined-github/assets/1402241/5b370430-2319-4c78-88e7-c2c06cd1c30f)

<!--
Refer to style guide in the wiki. Keep this message between sections.
https://github.com/refined-github/refined-github/wiki/Contributing#metadata-guidelines
-->

### Global

- [](# "useful-not-found-page") ğŸ”¥ [Adds possible related pages and alternatives on 404 pages.](https://user-images.githubusercontent.com/1402241/46402857-7bdada80-c733-11e8-91a1-856573078ff5.png)
- [](# "selection-in-new-tab") [Adds a keyboard shortcut to open selection in new tab when navigating via <kbd>j</kbd> and <kbd>k</kbd>: <kbd>shift</kbd> <kbd>o</kbd>.](https://github.com/refined-github/refined-github/issues/1110)
- [](# "close-out-of-view-modals") [Automatically closes dropdown menus when theyâ€™re no longer visible.](https://user-images.githubusercontent.com/1402241/37022353-531c676e-2155-11e8-96cc-80d934bb22e0.gif)
- [](# "parse-backticks") [GitHub renders `` `text in backticks` `` in some places but not others; this features fills in where forgotten.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/262555091-df31aa17-e7a2-4c16-91ca-fb077ba6134a.png)
- [](# "action-used-by-link") [Lets you see how others are using the current Action in the Marketplace.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/258552390-7d2cd013-c167-4fe5-9731-33622b8607e9.png)
- [](# "improve-shortcut-help") [Shows all of Refined GitHubâ€™s new keyboard shortcuts in the help modal (<kbd>?</kbd> hotkey).](https://user-images.githubusercontent.com/29176678/36999174-9f07d33e-20bf-11e8-83e3-b3a9908a4b5f.png)

<!--
Refer to style guide in the wiki. Keep this message between sections.
https://github.com/refined-github/refined-github/wiki/Contributing#metadata-guidelines
-->

### Netiquette

- [](# "netiquette") [Adds unobtrusive netiquette reminders (old closed issues, highly-active issues, draft PRs, â€¦).](https://github.com/user-attachments/assets/8646d663-7458-4e6d-888a-68d38110fcda)
- [](# "warn-pr-from-master") [Warns you when creating a PR from the default branch, as itâ€™s an anti-pattern.](https://user-images.githubusercontent.com/1402241/52543516-3ca94e00-2de5-11e9-9f80-ff8f9fe8bdc4.png)
- [](# "warning-for-disallow-edits") [Warns you when unchecking `Allow edits from maintainers`, as itâ€™s maintainer-hostile.](https://user-images.githubusercontent.com/1402241/53151888-24101380-35ef-11e9-8d30-d6315ad97325.gif)

<!--
Refer to style guide in the wiki. Keep this message between sections.
https://github.com/refined-github/refined-github/wiki/Contributing#metadata-guidelines
-->

### Fixes for GitHub shortcomings

- [](# "hide-navigation-hover-highlight") Removes the file hover effect in the repo file browser.
- [](# "clean-repo-sidebar") [Removes unnecessary or redundant information from the repository sidebar.](https://user-images.githubusercontent.com/46634000/107955448-18694480-6f9e-11eb-8bc6-80cc90d910bc.png)
- [](# "linkify-branch-references") [Linkifies branch references in "Quick PR" pages.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/258553554-e1711be0-d5ce-4edc-aaf8-72d659c881bc.png)
- [](# "actionable-pr-view-file") [Points the "View file" on PRs to the branch instead of the commit, so the Edit/Delete buttons will be enabled on the "View file" page.](https://user-images.githubusercontent.com/1402241/69044026-c5b17d80-0a26-11ea-86ae-c95f89d3669a.png)
- [](# "reload-failed-proxied-images") [Retries downloading images that failed downloading due to GitHub limited proxying.](https://user-images.githubusercontent.com/14858959/64068746-21991100-cc45-11e9-844e-827f5ac9b51e.png)
- [](# "unwrap-unnecessary-dropdowns") [Makes some dropdowns 1-click instead of unnecessarily 2-click.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/258554504-97d4079a-2aae-4aea-a870-653a267494a8.png)
- [](# "prevent-link-loss") [Suggests fixing links that are wrongly shortened by GitHub.](https://github-production-user-asset-6210df.s3.amazonaws.com/83146190/260087535-a0f19995-5f4a-44e9-87d8-cf742b9bfeed.gif)
- [](# "linkify-user-edit-history-popup") [Linkifies the username in the edit history popup.](https://user-images.githubusercontent.com/1402241/88917988-9ebb7480-d260-11ea-8690-0a3440f1ebbc.png)
- [](# "prevent-duplicate-pr-submission") [Avoids creating duplicate PRs when mistakenly clicking "Create pull request" more than once.](https://user-images.githubusercontent.com/16872793/89589967-e029c200-d814-11ea-962b-3ff1f6236781.gif)
- [](# "prevent-pr-merge-panel-opening") Prevents the merge panel from automatically opening on every page load after itâ€™s been opened once.
- [](# "command-palette-navigation-shortcuts") Adds keyboard shortcuts to select items in command palette using <kbd>ctrl</kbd> <kbd>n</kbd> and <kbd>ctrl</kbd> <kbd>p</kbd> (macOS only).
- [](# "prevent-comment-loss") [While writing/editing comments, open the preview links in new tab instead of navigating away from the page.](https://user-images.githubusercontent.com/17681399/282616531-2befcabe-5c80-4b9a-bfb5-7b9917847bb5.gif)
- [](# "fix-no-pr-search") [Redirect to repo issue list when the search doesnâ€˜t include `is:pr`.](https://user-images.githubusercontent.com/46634000/286579939-50122f02-dcfd-4510-b9e1-03d9985da2cd.gif)
- [](# "clean-readme-url") [Drops redundant "readme-ov-file" parameter from repo URLs.](https://github.com/refined-github/refined-github/assets/1402241/73e96411-3314-4501-a9b6-d006af6fcc47)
- [](# "click-outside-modal") [Closes checks list when clicking outside of modal.](https://github.com/refined-github/refined-github/issues/7157)
- [](# "linkify-line-numbers") [Linkifies the line numbers where GitHub forgot to add links.](https://github.com/refined-github/refined-github/assets/1402241/d5b67f4e-35c3-45d8-b72c-937b855168c3)
- [](# "sidebar-focus-file") [Scrolls the file tree to the current file.](https://github.com/user-attachments/assets/25e1e19e-799b-4dab-ae81-59ba17ad1194)
- [](# "no-modals") [Disable modals that reduce user-experience instead of enhancing it.](https://github.com/user-attachments/assets/7b63c7db-ae31-4ee8-8510-3b9db0c11f3e)
- [](# "same-page-links") Keeps links from opening in new tabs when they shouldn't. "Open in new tab" must be the user's choice, not the default behavior.
- [](# "linkify-text") [Makes certain text clickable, like issue references in the issue title and discussion sidebar.](https://github.com/user-attachments/assets/1d31f695-c198-477e-a3ae-cc0687417a90)
- [](# "new-milestone-button") [Adds a 'New Milestone' button to the milestone page.](https://github.com/user-attachments/assets/1fceb336-6d32-4733-afe0-9971989b1987)

<!--
Refer to style guide in the wiki. Keep this message between sections.
https://github.com/refined-github/refined-github/wiki/Contributing#metadata-guidelines
-->

### Previously part of Refined GitHub

[GitHub took inspiration from Refined GitHub](https://github.blog/2018-08-28-announcing-paper-cuts/) and natively implemented dozens of its features, ğŸ‰ so they've been [removed from this extension.](https://github.com/refined-github/refined-github/pulls?q=is%3Apr+is%3Amerged+label%3A%22implemented+by+github%22) You can also see [all the past features](https://github.com/refined-github/refined-github/pulls?q=is%3Apr+is%3Amerged+-label%3Ameta+in%3Atitle+drop+feature) of Refined GitHub in a single list.

## Customization

Most features can be disabled if they are JavaScript-based and you can override our CSS with your own in the extension options.

We're happy to receive suggestions and contributions, but be aware this is a highly opinionated project. There's [a high bar for adding features.](https://github.com/refined-github/refined-github/wiki/%22Can-you-add-this-feature%3F%22) Users will always disagree with something. That being said, we're open to discussing things.

## Links

- [Contribution guide](https://github.com/refined-github/refined-github/wiki/Contributing)



================================================
FILE: biome.jsonc
================================================
{
	"$schema": "./node_modules/@biomejs/biome/configuration_schema.json",
	"css": {
		"formatter": {
			"quoteStyle": "single"
		}
	},
	"graphql": {
		"formatter": {
			"enabled": true
		}
	},
	"linter": {
		"enabled": true,
		"rules": {
			"recommended": true,
			"complexity": {
				"noImportantStyles": "off"
			},
			"style": {
				// TODO: Enable later
				"noDescendingSpecificity": "off"
			}
		}
	},
	"files": {
		"includes": ["source/**/*.css", "source/**/*.gql"]
	}
}



================================================
FILE: eslint-suppressions.json
================================================
{
  "source/background.ts": {
    "@typescript-eslint/naming-convention": {
      "count": 1
    }
  },
  "source/features/action-pr-link.tsx": {
    "@typescript-eslint/naming-convention": {
      "count": 2
    }
  },
  "source/features/action-used-by-link.tsx": {
    "@typescript-eslint/naming-convention": {
      "count": 3
    }
  },
  "source/features/clean-conversation-headers.tsx": {
    "@typescript-eslint/naming-convention": {
      "count": 1
    }
  },
  "source/features/comments-time-machine-links.tsx": {
    "@typescript-eslint/naming-convention": {
      "count": 1
    }
  },
  "source/features/deep-reblame.tsx": {
    "@typescript-eslint/naming-convention": {
      "count": 1
    }
  },
  "source/features/embed-gist-inline.tsx": {
    "@typescript-eslint/naming-convention": {
      "count": 1
    }
  },
  "source/features/html-preview-link.tsx": {
    "@typescript-eslint/naming-convention": {
      "count": 1
    }
  },
  "source/features/linkify-branch-references.tsx": {
    "@typescript-eslint/naming-convention": {
      "count": 2
    }
  },
  "source/features/list-prs-for-branch.tsx": {
    "@typescript-eslint/naming-convention": {
      "count": 4
    }
  },
  "source/features/list-prs-for-file.tsx": {
    "@typescript-eslint/naming-convention": {
      "count": 2
    }
  },
  "source/features/mark-merge-commits-in-list.tsx": {
    "@typescript-eslint/naming-convention": {
      "count": 1
    }
  },
  "source/features/new-repo-disable-projects-and-wikis.tsx": {
    "@typescript-eslint/naming-convention": {
      "count": 2
    }
  },
  "source/features/one-click-diff-options.tsx": {
    "@typescript-eslint/naming-convention": {
      "count": 2
    }
  },
  "source/features/pagination-hotkey.tsx": {
    "@typescript-eslint/naming-convention": {
      "count": 2
    }
  },
  "source/features/pr-first-commit-title.tsx": {
    "@typescript-eslint/naming-convention": {
      "count": 1
    }
  },
  "source/features/pr-notification-link.tsx": {
    "@typescript-eslint/naming-convention": {
      "count": 1
    }
  },
  "source/features/prevent-link-loss.tsx": {
    "@typescript-eslint/naming-convention": {
      "count": 3
    }
  },
  "source/features/quick-mention.tsx": {
    "@typescript-eslint/naming-convention": {
      "count": 1
    }
  },
  "source/features/quick-repo-deletion.tsx": {
    "@typescript-eslint/naming-convention": {
      "count": 3
    }
  },
  "source/features/show-associated-branch-prs-on-fork.tsx": {
    "@typescript-eslint/naming-convention": {
      "count": 4
    }
  },
  "source/features/show-open-prs-of-forks.tsx": {
    "@typescript-eslint/naming-convention": {
      "count": 2
    }
  },
  "source/features/sort-conversations-by-update-time.tsx": {
    "@typescript-eslint/naming-convention": {
      "count": 1
    }
  },
  "source/features/sync-pr-commit-title.tsx": {
    "@typescript-eslint/naming-convention": {
      "count": 3
    }
  },
  "source/features/update-pr-from-base-branch.tsx": {
    "@typescript-eslint/naming-convention": {
      "count": 1
    }
  },
  "source/features/useful-not-found-page.tsx": {
    "@typescript-eslint/naming-convention": {
      "count": 2
    }
  },
  "source/features/user-profile-follower-badge.tsx": {
    "@typescript-eslint/naming-convention": {
      "count": 1
    }
  },
  "source/github-helpers/api.ts": {
    "@typescript-eslint/naming-convention": {
      "count": 8
    }
  },
  "source/github-helpers/dom-formatters.tsx": {
    "@typescript-eslint/naming-convention": {
      "count": 3
    }
  },
  "source/github-helpers/get-default-branch.ts": {
    "@typescript-eslint/naming-convention": {
      "count": 2
    }
  },
  "source/github-helpers/github-file-url.ts": {
    "@typescript-eslint/naming-convention": {
      "count": 1
    }
  },
  "source/github-helpers/github-token.ts": {
    "@typescript-eslint/naming-convention": {
      "count": 2
    }
  },
  "source/github-helpers/index.ts": {
    "@typescript-eslint/naming-convention": {
      "count": 2
    }
  },
  "source/github-helpers/selectors.test.ts": {
    "@typescript-eslint/naming-convention": {
      "count": 1
    }
  },
  "source/globals.d.ts": {
    "@typescript-eslint/naming-convention": {
      "count": 1
    }
  },
  "source/helpers/caller-id.ts": {
    "@typescript-eslint/naming-convention": {
      "count": 1
    }
  },
  "source/helpers/feature-helpers.ts": {
    "@typescript-eslint/naming-convention": {
      "count": 1
    }
  },
  "source/helpers/fetch-dom.ts": {
    "@typescript-eslint/naming-convention": {
      "count": 2
    }
  },
  "source/helpers/hotfix.tsx": {
    "@typescript-eslint/naming-convention": {
      "count": 1
    }
  },
  "source/helpers/show-whitespace-on-line.test.ts": {
    "@typescript-eslint/naming-convention": {
      "count": 1
    }
  },
  "source/options-storage.ts": {
    "@typescript-eslint/naming-convention": {
      "count": 3
    }
  }
}



================================================
FILE: eslint.config.js
================================================
import xo from 'xo';
import sveltePlugin from 'eslint-plugin-svelte';
import svelteParser from 'svelte-eslint-parser';
import {includeIgnoreFile} from '@eslint/compat';
import {fileURLToPath} from 'node:url';

const gitignorePath = fileURLToPath(new URL('.gitignore', import.meta.url));

export default [
	includeIgnoreFile(gitignorePath, 'Imported .gitignore patterns'),
	...xo.xoToEslintConfig([
		{
			semicolon: true,
			prettier: false,
			languageOptions: {
				globals: {
					browser: 'readonly',
				},
			},
			rules: {
				'no-irregular-whitespace': 'off', // We do want to use non-breaking spaces

				// Disable some unicorn rules
				'unicorn/expiring-todo-comments': 'off', // We just got too many, too much noise
				'unicorn/no-nested-ternary': 'off',
				'unicorn/better-regex': 'off',
				'unicorn/prefer-top-level-await': 'off',
				'unicorn/prefer-dom-node-dataset': 'off',
				'unicorn/prefer-ternary': 'off', // Unreadable https://github.com/sindresorhus/eslint-plugin-unicorn/issues/1633
				'unicorn/prevent-abbreviations': [
					'error',
					{
						replacements: {
							utils: false,
							props: false,
							ref: false,
							nav: false,
						},
					},
				],

				// Restore errors
				'no-await-in-loop': 'error',
				'new-cap': [
					'error',
					{
						newIsCap: true,
						capIsNew: true,
					},
				],

				'no-console': 'off',
				'@stylistic/jsx-quotes': 'off', // Keep existing quote style in JSX
				'@stylistic/function-paren-newline': 'off', // Allow JSX on separate lines from parens
				'promise/prefer-await-to-then': ['error', {strict: false}], // Allows `await x.catch()`

				// Allow unassigned imports for CSS and feature files
				'import-x/no-unassigned-import': ['error', {
					allow: [
						'**/*.css',
						'**/*.scss',
						'**/*.sass',
						'**/*.less',
						'**/features/**',
						'**/github-helpers/**',
						'webext-bugs/*',
						'vite/client',
						'webext-dynamic-content-scripts',
					],
				}],

				'no-restricted-imports': [
					'error',
					{
						paths: [
							{
								name: 'select-dom',
								importNames: ['$', 'expectElement'],
								message: 'Import $ or $optional from `select-dom/strict.js` instead',
							},
						],
					},

				],
				'no-restricted-syntax': [
					'error',
					{
						selector:
								':matches([callee.name=delegate], [callee.name=$], [callee.name=$$], [callee.name=$optional], [callee.name=observe], [callee.property.name=querySelector], [callee.property.name=querySelectorAll], [callee.property.name=closest])[arguments.0.value=/,/][arguments.0.value.length>=20]:not([arguments.0.value=/:has|:is/])',
						message: 'Instead of a single string, pass an array of selectors and add comments to each selector',
					},
					{
						selector:
								':matches([callee.name=delegate], [callee.name=$], [callee.name=$$], [callee.name=$optional], [callee.name=observe], [callee.property.name=querySelector], [callee.property.name=querySelectorAll], [callee.property.name=closest])[arguments.0.type=ArrayExpression][arguments.0.elements.length=1]:not([arguments.0.value=/:has|:is/])',
						message: 'If it\'s a single selector, use a single string instead of an array',
					},
					{
						selector: 'TSNonNullExpression > CallExpression > [name=$optional]',
						message: 'Use `$()` instead of non-null `$optional()`. Use it as `import {expectElement as $}`',
					},
					{
						selector: 'TSNonNullExpression > CallExpression > [name=$]',
						message: 'Unused null expression: !',
					},
					{
						selector: 'MemberExpression[optional=true][object.callee.name=$]',
						message: 'Either use $optional() with `?.` or $() without. $() will throw when the element is not found.',
					},
					{
						message: 'Init functions wrapped with onetime() must have a name ending with "Once"',
						selector: 'ObjectExpression > Property[key.name=init] > CallExpression[callee.name=onetime]:not([arguments.0.name=/Once$/])',
					},
					{
						message: 'Init functions that run once, cannot accept a signal: https://github.com/refined-github/refined-github/pull/8072',
						selector: 'FunctionDeclaration[id.name=/Once$/] > Identifier[name=signal]',
					},
					{
						message: 'Elements with data-hotkey must have a title or aria-label in the format "Hotkey: <key>"',
						selector:
								'JSXOpeningElement:has(JSXAttribute[name.name="data-hotkey"])'
								+ ':not(:has(JSXAttribute[name.name="title"]))'
								+ ':not(:has(JSXAttribute[name.name="aria-label"]))'
								+ ':not(:has(JSXAttribute[name.name="hidden"]))',
					},
				],
				'no-alert': 'off',
				'n/prefer-global/process': 'off',

				// Import-x rules customization
				'import-x/consistent-type-specifier-style': 'off',
				'import-x/prefer-default-export': 'error',
				'import-x/order': [
					'error',
					{
						groups: [
							[
								'builtin',
								'external',
							],
						],
						'newlines-between': 'always-and-inside-groups',
					},
				],
			},
		},
		// TypeScript-specific config
		{
			files: ['**/*.{ts,tsx,cts,mts}'],
			rules: {
				'@typescript-eslint/no-restricted-types': [
					'error',
					{
						types: {
							object: {
								message: 'The `object` type is hard to use. Use `Record<string, unknown>` instead. See: https://github.com/typescript-eslint/typescript-eslint/pull/848',
								fixWith: 'Record<string, unknown>',
							},
							null: {
								message: 'Use `undefined` instead. See: https://github.com/sindresorhus/meta/issues/7',
								fixWith: 'undefined',
							},
							Buffer: {
								message: 'Use Uint8Array instead. See: https://sindresorhus.com/blog/goodbye-nodejs-buffer',
								suggest: [
									'Uint8Array',
								],
							},
							'[]': 'Don\'t use the empty array type `[]`. It only allows empty arrays. Use `SomeType[]` instead.',
							'[[]]': 'Don\'t use `[[]]`. It only allows an array with a single element which is an empty array. Use `SomeType[][]` instead.',
						},
					},
				],
				'@typescript-eslint/switch-exhaustiveness-check': ['error', {
					considerDefaultExhaustiveForUnions: true,
				}],

				'@typescript-eslint/parameter-properties': 'off', // Conflicts with erasable sintax
				'@typescript-eslint/no-deprecated': 'off', // Too noisy for now
				'@typescript-eslint/no-unsafe-assignment': 'off',
				'@typescript-eslint/no-unsafe-argument': 'off',
				'@typescript-eslint/no-unsafe-member-access': 'off',
				'@typescript-eslint/no-unsafe-return': 'off',
				'@typescript-eslint/no-unsafe-call': 'off',
				'@typescript-eslint/method-signature-style': 'off', // Disagree and it breaks types https://github.com/typescript-eslint/typescript-eslint/issues/1991
				'@typescript-eslint/consistent-type-definitions': 'off', // Review later
				'@typescript-eslint/consistent-type-imports': [
					'error',
					{
						// Preferred style
						fixStyle: 'inline-type-imports',
					},
				],
				'@typescript-eslint/explicit-function-return-type': [
					'error',
					{
						allowExpressions: true,
					},
				],
			},
		},
		{
			files: [
				'build/*',
			],
			rules: {
				'@typescript-eslint/triple-slash-reference': 'off',
				'unicorn/prefer-module': 'off',
			},
		},
		{
			files: [
				'source/features/*',
			],
			rules: {
				'import-x/prefer-default-export': 'off',
			},
		},
		{
			files: [
				'**/*.md',
			],
			rules: {
				'unicorn/no-nested-ternary': 'off',
			},
		},
		{
			files: [
				'.github/**',
			],
			rules: {
				'unicorn/filename-case': 'off',
			},
		},
		{
			files: [
				'**/*.svelte',
			],
			rules: {
				'import-x/prefer-default-export': 'off',
			},
		},
		// Config files can export objects directly
		{
			files: ['*.config.{js,ts}', 'rollup.config.js'],
			rules: {
				'import-x/no-anonymous-default-export': 'off',
			},
		},
		// Test files need browser globals
		{
			files: ['test/**/*.js'],
			languageOptions: {
				globals: {
					document: 'readonly',
					location: 'readonly',
				},
			},
		},
		// https://eslint.org/docs/latest/use/configure/ignore#ignoring-files
		{
			ignores: ['safari'],
		},
	]),
	{
		// Disable on markdown files, which are somehow being read as JS files
		ignores: ['**/*.md'],
	},
	// Svelte support
	...sveltePlugin.configs['flat/recommended'],
	{
		files: ['**/*.svelte'],
		languageOptions: {
			parser: svelteParser,
			parserOptions: {
				parser: '@typescript-eslint/parser',
			},
			globals: {
				browser: 'readonly',
				chrome: 'readonly',
				location: 'readonly',
			},
		},
	},
];



================================================
FILE: license
================================================
MIT License

Copyright (c) Sindre Sorhus <sindresorhus@gmail.com> (https://sindresorhus.com)

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.



================================================
FILE: package.json
================================================
{
	"private": true,
	"type": "module",
	"scripts": {
		"vitest": "NODE_NO_WARNINGS=1 vitest --run",
		"build": "run-p build:* --continue-on-error",
		"build:typescript": "tsc --noEmit",
		"build:bundle": "rollup -c",
		"fix": "run-p \"lint:biome -- --write\" \"lint:js -- --fix\" format \"vitest -- --update\" --continue-on-error",
		"format": "prettier . --write && biome format --fix",
		"lint": "run-p lint:* --continue-on-error",
		"lint:js": "eslint .",
		"lint:biome": "biome check",
		"lint:prettier": "prettier . --check",
		"new": "bash build/new-feature.sh",
		"pack:safari": "xcodebuild -project 'safari/Refined GitHub.xcodeproj' -scheme 'Refined GitHub' -destination 'platform=macOS'",
		"prepare:safari": "bash build/prepare-safari-release.sh",
		"start": "npm run watch",
		"test": "run-p vitest lint:* build:* --continue-on-error",
		"watch": "run-p watch:* --continue-on-error",
		"watch:typescript": "tsc --noEmit --watch --preserveWatchOutput",
		"watch:bundle": "rollup -c --watch"
	},
	"prettier": {
		"bracketSpacing": false,
		"plugins": [
			"prettier-plugin-svelte"
		],
		"singleQuote": true,
		"overrides": [
			{
				"files": "*.svelte",
				"options": {
					"parser": "svelte"
				}
			}
		]
	},
	"dependencies": {
		"@fregante/mi-cron": "^2.0.1",
		"@sindresorhus/to-milliseconds": "^2.0.0",
		"abort-utils": "^3.0.0",
		"batched-function": "^3.0.0",
		"code-tag": "^1.2.0",
		"debounce-fn": "^6.0.0",
		"delegate-it": "^6.3.0",
		"dom-chef": "^5.1.1",
		"dom-loaded": "^3.1.0",
		"doma": "^4.0.0",
		"element-ready": "^9.0.2",
		"emoji-regex-xs": "^2.0.1",
		"filter-altered-clicks": "^2.1.1",
		"fit-textarea": "^2.0.0",
		"flat-zip": "^1.0.1",
		"github-reserved-names": "^2.1.1",
		"github-url-detection": "^11.1.0",
		"indent-textarea": "^4.0.0",
		"js-abbreviation-number": "^1.4.0",
		"linkify-issues": "^4.2.0",
		"linkify-urls": "^5.2.0",
		"memoize": "^10.2.0",
		"octicons-plain-react": "^19.21.2",
		"one-event": "^4.4.0",
		"one-mutation": "^3.0.1",
		"pretty-bytes": "^7.1.0",
		"regex-join": "^2.1.0",
		"select-dom": "^9.5.0",
		"shorten-repo-url": "^6.0.0",
		"strip-indent": "^4.0.0",
		"text-field-edit": "^4.1.1",
		"tiny-version-compare": "^4.0.0",
		"ts-extras": "^0.16.1",
		"twas": "^2.1.3",
		"uint8array-extras": "^1.5.0",
		"webext-alert": "^1.1.0",
		"webext-base-css": "^2.1.0",
		"webext-bugs": "^1.1.1",
		"webext-content-scripts": "^2.7.2",
		"webext-detect": "^5.3.1",
		"webext-dynamic-content-scripts": "^10.0.4",
		"webext-msg": "^1.0.0",
		"webext-options-sync": "^4.3.0",
		"webext-options-sync-per-domain": "^4.3.1",
		"webext-permission-toggle": "^6.0.1",
		"webext-storage": "^2.0.1",
		"webext-storage-cache": "^6.0.3",
		"webext-tools": "^3.0.0",
		"zip-text-nodes": "^1.0.0"
	},
	"devDependencies": {
		"@biomejs/biome": "^2.3.12",
		"@eslint-react/eslint-plugin": "^2.7.2",
		"@eslint/compat": "^2.0.1",
		"@rollup/plugin-alias": "^6.0.0",
		"@rollup/plugin-commonjs": "^29.0.0",
		"@rollup/plugin-json": "^6.1.0",
		"@rollup/plugin-node-resolve": "^16.0.3",
		"@rollup/plugin-sucrase": "^5.0.2",
		"@sindresorhus/tsconfig": "^8.1.0",
		"@types/chrome": "^0.1.36",
		"@types/codemirror": "^5.60.17",
		"@types/dom-navigation": "^1.0.6",
		"@types/node": "^24.10.1",
		"@types/react": "^17.0.52",
		"browserslist": "^4.28.1",
		"daily-version": "^2.0.0",
		"dot-json": "^1.3.0",
		"eslint": "^9.39.2",
		"eslint-formatter-unix": "^9.0.1",
		"eslint-import-resolver-typescript": "^4.4.4",
		"eslint-plugin-import-x": "^4.16.1",
		"eslint-plugin-svelte": "^3.14.0",
		"fast-ignore": "^1.1.3",
		"filenamify": "^7.0.1",
		"highlight.js": "^11.11.1",
		"lightningcss": "^1.31.1",
		"linkedom": "^0.18.12",
		"npm-run-all2": "^8.0.4",
		"p-memoize": "^8.0.0",
		"prettier": "^3.8.1",
		"prettier-plugin-svelte": "^3.4.1",
		"rollup": "^4.56.0",
		"rollup-plugin-cleanup": "^3.2.1",
		"rollup-plugin-copy": "^3.5.0",
		"rollup-plugin-delete": "^3.0.2",
		"rollup-plugin-string": "^3.0.0",
		"rollup-plugin-styles": "^4.0.0",
		"rollup-plugin-svelte": "^7.2.3",
		"rollup-plugin-webpack-stats": "^2.1.9",
		"snarkdown": "^2.0.0",
		"svelte": "^5.48.1",
		"svelte-eslint-parser": "^1.4.1",
		"type-fest": "^5.4.1",
		"typed-query-selector": "^2.12.0",
		"typescript": "^5.9.3",
		"unplugin-lightningcss": "^0.4.5",
		"vitest": "^4.0.18",
		"xo": "^1.2.3"
	},
	"engines": {
		"node": ">= 20",
		"npm": ">= 10"
	},
	"graphql": {
		"schema": "https://docs.github.com/public/schema.docs.graphql"
	},
	"overrides": {
		"array-includes": "npm:@nolyfill/array-includes@^1",
		"array.prototype.find": "npm:@nolyfill/array.prototype.find@^1",
		"array.prototype.findlast": "npm:@nolyfill/array.prototype.findlast@^1",
		"array.prototype.findlastindex": "npm:@nolyfill/array.prototype.findlastindex@^1",
		"array.prototype.flat": "npm:@nolyfill/array.prototype.flat@^1",
		"array.prototype.flatmap": "npm:@nolyfill/array.prototype.flatmap@^1",
		"array.prototype.toreversed": "npm:@nolyfill/array.prototype.toreversed@^1",
		"array.prototype.tosorted": "npm:@nolyfill/array.prototype.tosorted@^1",
		"es-iterator-helpers": "npm:@nolyfill/es-iterator-helpers@^1",
		"hasown": "npm:@nolyfill/hasown@^1",
		"is-regex": "npm:@nolyfill/is-regex@^1",
		"object.assign": "npm:@nolyfill/object.assign@^1",
		"object.entries": "npm:@nolyfill/object.entries@^1",
		"object.fromentries": "npm:@nolyfill/object.fromentries@^1",
		"object.groupby": "npm:@nolyfill/object.groupby@^1",
		"object.hasown": "npm:@nolyfill/object.hasown@^1",
		"object.values": "npm:@nolyfill/object.values@^1",
		"string.prototype.matchall": "npm:@nolyfill/string.prototype.matchall@^1",
		"string.prototype.padend": "npm:@nolyfill/string.prototype.padend@^1",
		"is-core-module": "npm:@nolyfill/is-core-module@^1",
		"string.prototype.repeat": "npm:@nolyfill/string.prototype.repeat@^1"
	},
	"webExt": {
		"sourceDir": "distribution",
		"run": {
			"keepProfileChanges": true,
			"firefoxProfile": "./test/web-ext-profile",
			"chromiumProfile": "./test/web-ext-profile",
			"startUrl": [
				"https://github.com/refined-github/refined-github/issues?q=is%3Aissue+is%3Aopen+sort%3Aupdated-desc"
			]
		}
	}
}



================================================
FILE: privacy-policy.md
================================================
# Privacy Policy

No data or personal information is collected by Refined GitHub.

##### Contact

If you have any questions or suggestions regarding this privacy policy, do not hesitate to [contact us](https://sindresorhus.com/contact).



================================================
FILE: rollup.config.js
================================================
import sucrase from '@rollup/plugin-sucrase';
import resolve from '@rollup/plugin-node-resolve';
import commonjs from '@rollup/plugin-commonjs';
import cleanup from 'rollup-plugin-cleanup';
import styles from 'rollup-plugin-styles';
import {string} from 'rollup-plugin-string';
import alias from '@rollup/plugin-alias';
import json from '@rollup/plugin-json';
import copy from 'rollup-plugin-copy';
import del from 'rollup-plugin-delete';
import webpackStatsPlugin from 'rollup-plugin-webpack-stats';
import svelte from 'rollup-plugin-svelte';
import lightning from 'unplugin-lightningcss/rollup';
import {Features, browserslistToTargets} from 'lightningcss';
import browserslist from 'browserslist';

import svelteConfig from './svelte.config.js';

const noise = new Set(['index', 'dist', 'src', 'source', 'distribution', 'node_modules', 'main', 'esm', 'cjs', 'build', 'built']);

/** @type {import('rollup').RollupOptions} */
const rollup = {
	input: {
		options: './source/options.tsx',
		welcome: './source/welcome.svelte',
		header: './source/options/header.svelte',
		'storage-usage': './source/options/storage-usage.svelte',
		background: './source/background.ts',
		'refined-github': './source/refined-github.ts',
		'content-script': './source/content-script.ts',
	},
	output: {
		dir: 'distribution/assets',
		preserveModules: true,
		preserveModulesRoot: 'source',
		assetFileNames: '[name][extname]', // For CSS
		entryFileNames(chunkInfo) {
			if (chunkInfo.name.includes('node_modules')) {
				const cleanName = chunkInfo.name
					.split('/')
					.filter(part => !noise.has(part))
					.join('-');
				return `npm/${cleanName}.js`;
			}

			return chunkInfo.name.replace('build/__snapshots__/', '') + '.js';
		},
	},
	watch: {
		clearScreen: false,
	},

	// TODO: Drop after https://github.com/sindresorhus/memoize/issues/102
	context: 'globalThis',

	plugins: [
		del({
			targets: ['distribution/assets'],
			runOnce: true, // `false` would be nice, but it deletes the files too early, causing two extension reloads
		}),
		lightning({
			options: {
				include: Features.Nesting,
				// Lighting issue: https://github.com/parcel-bundler/lightningcss/issues/826#issuecomment-2453982986
				targets: browserslistToTargets(browserslist('chrome 123, firefox 126, iOS 17.5')),
			},
		}),
		svelte(svelteConfig),
		json(),
		styles({
			mode: 'extract',
			url: false,
		}),
		string({
			include: '**/*.gql',
		}),
		alias({
			entries: [
				{find: 'react', replacement: 'dom-chef'},
			],
		}),
		sucrase({
			transforms: ['typescript', 'jsx'],

			// Output modern JS
			disableESTransforms: true,

			// Drop `__self` in JSX https://github.com/alangpierce/sucrase/issues/232#issuecomment-468898878
			production: true,
		}),
		resolve({browser: true}),
		commonjs(),
		copy({
			targets: [
				{src: './source/manifest.json', dest: 'distribution'},
				{src: './source/*.+(html|png)', dest: 'distribution/assets'},
			],
		}),
		cleanup(),
	],
};

if (process.env.RELATIVE_CI_STATS) {
	rollup.plugins.push(webpackStatsPlugin());
}

export default rollup;



================================================
FILE: svelte.config.js
================================================
/** @type {import('rollup-plugin-svelte').Options} */
export default {
	compilerOptions: {
		// Compile all components to custom elements
		customElement: true,
	},
};



================================================
FILE: tsconfig.json
================================================
{
	"extends": "@sindresorhus/tsconfig",
	"compilerOptions": {
		"outDir": "./distribution/assets",
		"rootDir": "./",
		"module": "preserve",
		"moduleResolution": "bundler",
		"jsx": "react",
		"declaration": false,
		"noUncheckedIndexedAccess": false,
		"noPropertyAccessFromIndexSignature": false,
		"resolveJsonModule": true,
		"verbatimModuleSyntax": true,
		"lib": [
			"DOM",
			"DOM.Iterable",
			"ESNext.Collection",
			"ESNext.Object",
			"ES2024"
		]
	},
	"include": [
		"source",
		"test",
		"build",
		"vite.config.ts"
	]
}



================================================
FILE: vite.config.ts
================================================
import {defineConfig} from 'vitest/config';

export default defineConfig({
	test: {
		setupFiles: [
			'./test/setup-file.js',
		],
	},
});



================================================
FILE: .editorconfig
================================================
root = true

[*]
indent_style = tab
end_of_line = lf
charset = utf-8
trim_trailing_whitespace = true
insert_final_newline = true

[*.yml]
indent_style = space
indent_size = 2



================================================
FILE: .git-blame-ignore-revs
================================================
01dd06acceb957ae824d346a5ff8736ee7320c8a
b6dc0edc94cebdee74d67f5919f46c28cd96b9f8
a62b707f3d893f424458b9453e938071e4271c6e



================================================
FILE: .ncurc.json
================================================
{
	"reject": ["@types/react", "fit-textarea"]
}



================================================
FILE: .npmrc
================================================
legacy-peer-deps=true # Until https://github.com/xojs/stylelint-config-xo/issues/19



================================================
FILE: .nvmrc
================================================
22



================================================
FILE: .prettierignore
================================================
# Ensure Prettier is not automatically run by editors on unwanted files
*.*
# Only svelte files are covered
# TODO: After https://github.com/biomejs/biome/issues/6657
!*.svelte



================================================
FILE: safari/app-store-description.txt
================================================
Refined GitHub is a Safari extension that simplifies the GitHub.com interface and adds useful features.


â–  Highlights

- Linkifies issue/PR references and URLs in code.
- Makes whitespace characters visible.
- Reduces tabsâ€™ size to 4 spaces instead of 8.
- Adds one-click merge conflict fixers.
- Adds reaction avatars showing who reacted to a comment.
- Adds a button to revert all the changes to a file in a PR.
- Adds a build/CI status icon next to the repoâ€™s name.
- Adds a button to view the source of Markdown files.
- Shows PRs that touch the current file.
- Highlights the most useful comment in conversations.
- Shows the first Git tag a merged PR was included in.
- Adds a link to an automatic changelog for each tag/release.
- Adds possible related pages and alternatives on 404 pages.
- Displays the age of the repository in the sidebar.

And so much more! 200+ features. See the Developer Website for a full list of features.


The GITHUB and REFINED GITHUB trademarks are owned by GitHub, Inc. and used under license.



================================================
FILE: safari/app-store-keywords.txt
================================================
github,gh,git,safari,extension,browser,improve,experience,ui,user,interface,issue,pull,request



================================================
FILE: safari/Config.xcconfig
================================================
MARKETING_VERSION = 0.0.0
CURRENT_PROJECT_VERSION = 1

#include? "LocalOverrides.xcconfig"



================================================
FILE: safari/Refined GitHub/App.swift
================================================
import SwiftUI

@main
struct AppMain: App {
	var body: some Scene {
		WindowIfMacOS(Text("Refined GitHub"), id: "main") {
			MainScreen()
		}
		#if os(macOS)
		.windowStyle(.hiddenTitleBar)
		.windowResizability(.contentSize)
		.defaultPosition(.center)
		.commands {
			CommandGroup(replacing: .newItem) {}
			CommandGroup(replacing: .help) {
				Link(
					"Website",
					systemImage: "safari",
					destination: "https://github.com/refined-github/refined-github"
				)
				Divider()
				RateAppLink(appStoreIdentifier: Constants.appStoreIdentifier)
				if #available(macOS 26, *) {
					ShareAppLink(appStoreIdentifier: Constants.appStoreIdentifier)
				}
			}
		}
		#endif
	}
}



================================================
FILE: safari/Refined GitHub/Constants.swift
================================================
import SwiftUI

enum Constants {
	static let appStoreIdentifier = "1519867270"
	static let extensionBundleIdentifier = "com.sindresorhus.Refined-GitHub.Extension"
}



================================================
FILE: safari/Refined GitHub/Info.plist
================================================
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>ITSAppUsesNonExemptEncryption</key>
	<false/>
</dict>
</plist>



================================================
FILE: safari/Refined GitHub/MainScreen.swift
================================================
import SwiftUI
import SafariServices
import StoreKit

struct MainScreen: View {
	@Environment(\.requestReview) private var requestReview
	@Environment(\.scenePhase) private var scenePhase
	@AppStorage("hasRequestedReview") private var hasRequestedReview = false
	@State private var isEnabled = false

	var body: some View {
		VStack(spacing: 40) {
			VStack {
				Image(.largeIcon)
					.resizable()
					.scaledToFit()
					.frame(height: 140)
					.accessibilityHidden(true)
				Text("Refined GitHub")
					.font(.largeTitle.bold())
					#if os(macOS)
					.padding(.top, 8)
					#endif
			}
			#if os(macOS)
			.padding(.top)
			#endif
			#if os(macOS)
			extensionStatusView
			VStack(spacing: 16) {
				Button("Open Safari Settings") {
					Task {
						await openExtensionSettings()
					}
				}
				.buttonStyle(.borderedProminent)
				.controlSize(.large)
				Link("Does the extension not show up?", destination: "https://github.com/refined-github/refined-github/issues/4216#issuecomment-817097886")
					.controlSize(.small)
			}
			#else
			if #available(iOS 26.2, visionOS 26.2, *) {
				extensionStatusView
				Button(isEnabled ? "Extension Settings" : "Enable Extension") {
					Task {
						await openExtensionSettings()
					}
				}
				.buttonStyle(.borderedProminent)
				.controlSize(.large)
				.font(.title3.weight(.medium))
			} else {
				Link("Get Started", destination: URL(string: "x-safari-https://refined-github.github.io/ios/enable.html")!)
					.buttonStyle(.borderedProminent)
					.controlSize(.large)
					.font(.title3.weight(.medium))
			}
			#endif
		}
		.frame(maxWidth: .infinity, maxHeight: .infinity)
		.padding()
		.offset(y: -20) // Looks better than fully center.
		.safeAreaInset(edge: .bottom) {
			VStack(spacing: 16) {
				Text("The app is just a container for the Safari extension and does not do anything.")
				Text("v\(SSApp.version)")
					.foregroundStyle(.tertiary)
			}
			.font(.subheadline)
			.foregroundStyle(.secondary)
			.multilineTextAlignment(.center)
			.padding()
			.padding(.horizontal)
		}
		.task {
			requestReviewIfNeeded()
			await updateExtensionStatus()
		}
		.onChange(of: scenePhase) { newScenePhase in
			guard newScenePhase == .active else {
				return
			}

			Task {
				await updateExtensionStatus()
			}
		}
		#if os(macOS)
		.padding()
		.padding()
		.fixedSize()
		.windowLevel(.floating)
		.windowIsRestorable(false)
		.windowIsMinimizable(false)
		.windowIsStandardButtonHidden(.miniaturizeButton, .zoomButton)
		.windowIsMovableByWindowBackground()
		#endif
	}

	private var extensionStatusView: some View {
		VStack(spacing: 8) {
			Group {
				if isEnabled {
					Text(Image(systemName: "checkmark.seal.fill"))
						.foregroundColor(.green)
						+ Text(" Enabled")
				} else {
					Text(Image(systemName: "xmark.seal.fill"))
						.foregroundColor(.red)
						+ Text(" Disabled")
				}
			}
			.symbolRenderingMode(.multicolor)
			.font(.title3)
			Text("You can turn it \(isEnabled ? "off" : "on") in the Safari extensions settings")
				.font(.subheadline)
				.foregroundStyle(.secondary)
		}
	}

	private func updateExtensionStatus() async {
		#if os(macOS)
		do {
			isEnabled = try await SafariExtension.isEnabled(forIdentifier: Constants.extensionBundleIdentifier)
		} catch {
			error.present()
		}
		#else
		guard #available(iOS 26.2, visionOS 26.2, *) else {
			return
		}

		do {
			isEnabled = try await SafariExtension.isEnabled(forIdentifier: Constants.extensionBundleIdentifier)
		} catch {
			print(error)
		}
		#endif
	}

	#if os(macOS)
	private func openExtensionSettings() async {
		do {
			try await SafariExtension.openSettings(forIdentifier: Constants.extensionBundleIdentifier)
			NSApplication.shared.terminate(nil)
		} catch {
			error.present()
		}
	}
	#else
	@available(iOS 26.2, visionOS 26.2, *)
	private func openExtensionSettings() async {
		do {
			try await SafariExtension.openSettings(forIdentifier: Constants.extensionBundleIdentifier)
		} catch {
			print(error)
		}
	}
	#endif

	private func requestReviewIfNeeded() {
		guard
			!SSApp.isFirstLaunch,
			!hasRequestedReview
		else {
			return
		}

		requestReview()
		hasRequestedReview = true
	}
}

#Preview {
	MainScreen()
}



================================================
FILE: safari/Refined GitHub/Refined GitHub.entitlements
================================================
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>com.apple.security.app-sandbox</key>
	<true/>
</dict>
</plist>



================================================
FILE: safari/Refined GitHub/Utilities.swift
================================================
import SwiftUI
import SafariServices


enum SafariExtension {
	#if os(macOS)
	static func isEnabled(forIdentifier identifier: String) async throws -> Bool {
		try await SFSafariExtensionManager.stateOfSafariExtension(withIdentifier: identifier).isEnabled
	}

	static func openSettings(forIdentifier identifier: String) async throws {
		try await SFSafariApplication.showPreferencesForExtension(withIdentifier: identifier)
	}
	#else
	@available(iOS 26.2, visionOS 26.2, *)
	static func isEnabled(forIdentifier identifier: String) async throws -> Bool {
		try await SFSafariExtensionManager.stateOfExtension(withIdentifier: identifier).isEnabled
	}

	@available(iOS 26.2, visionOS 26.2, *)
	static func openSettings(forIdentifier identifier: String) async throws {
		try await SFSafariSettings.openExtensionsSettings(forIdentifiers: [identifier])
	}
	#endif
}


enum SSApp {
	static let version = Bundle.main.infoDictionary?["CFBundleShortVersionString"] as? String ?? "<Unknown version>"

	static let isFirstLaunch: Bool = {
		let key = "SS_hasLaunched"

		if UserDefaults.standard.bool(forKey: key) {
			return false
		}

		UserDefaults.standard.set(true, forKey: key)
		return true
	}()
}


struct ShareAppLink: View {
	let appStoreIdentifier: String

	var body: some View {
		ShareLink(
			"Share App",
			item: "https://apps.apple.com/app/id\(appStoreIdentifier)"
		)
	}
}


struct RateAppLink: View {
	#if os(macOS)
	private static let urlScheme = "macappstore"
	#else
	private static let urlScheme = "itms-apps"
	#endif

	let appStoreIdentifier: String

	var body: some View {
		Link(
			"Rate App",
			systemImage: "star",
			destination: URL(string: "\(Self.urlScheme)://apps.apple.com/app/id\(appStoreIdentifier)?action=write-review")!
		)
	}
}


#if os(macOS)
typealias WindowIfMacOS = Window
#else
typealias WindowIfMacOS = WindowGroup
#endif


extension URL: @retroactive ExpressibleByStringLiteral {
	/**
	Example:

	```
	let url: URL = "https://sindresorhus.com"
	```
	*/
	public init(stringLiteral value: StaticString) {
		self.init(string: "\(value)")!
	}
}


extension URL {
	/**
	Example:

	```
	URL("https://sindresorhus.com")
	```
	*/
	init(_ staticString: StaticString) {
		self.init(string: "\(staticString)")!
	}
}


extension SetAlgebra {
	/**
	Insert the `value` if it doesn't exist, otherwise remove it.
	*/
	mutating func toggleExistence(_ value: Element) {
		if contains(value) {
			remove(value)
		} else {
			insert(value)
		}
	}

	/**
	Insert the `value` if `shouldExist` is true, otherwise remove it.
	*/
	mutating func toggleExistence(_ value: Element, shouldExist: Bool) {
		if shouldExist {
			insert(value)
		} else {
			remove(value)
		}
	}
}


#if os(macOS)
private struct WindowAccessor: NSViewRepresentable {
	private final class WindowAccessorView: NSView {
		@Binding var windowBinding: NSWindow?

		init(binding: Binding<NSWindow?>) {
			self._windowBinding = binding
			super.init(frame: .zero)
		}

		override func viewDidMoveToWindow() {
			super.viewDidMoveToWindow()
			windowBinding = window
		}

		@available(*, unavailable)
		required init?(coder: NSCoder) {
			fatalError() // swiftlint:disable:this fatal_error_message
		}
	}

	@Binding var window: NSWindow?

	init(_ window: Binding<NSWindow?>) {
		self._window = window
	}

	func makeNSView(context: Context) -> NSView {
		WindowAccessorView(binding: $window)
	}

	func updateNSView(_ nsView: NSView, context: Context) {}
}

extension View {
	/**
	Bind the native backing-window of a SwiftUI window to a property.
	*/
	func bindHostingWindow(_ window: Binding<NSWindow?>) -> some View {
		background(WindowAccessor(window))
	}
}

private struct WindowViewModifier: ViewModifier {
	@State private var window: NSWindow?

	let onWindow: (NSWindow?) -> Void

	func body(content: Content) -> some View {
		onWindow(window)

		return content
			.bindHostingWindow($window)
	}
}

extension View {
	/**
	Access the native backing-window of a SwiftUI window.
	*/
	func accessHostingWindow(_ onWindow: @escaping (NSWindow?) -> Void) -> some View {
		modifier(WindowViewModifier(onWindow: onWindow))
	}

	func windowLevel(_ level: NSWindow.Level) -> some View {
		accessHostingWindow {
			$0?.level = level
		}
	}

	func windowIsMinimizable(_ isMinimizable: Bool = true) -> some View {
		accessHostingWindow {
			$0?.styleMask.toggleExistence(.miniaturizable, shouldExist: isMinimizable)
		}
	}

	func windowIsResizable(_ isResizable: Bool = true) -> some View {
		accessHostingWindow {
			$0?.styleMask.toggleExistence(.resizable, shouldExist: isResizable)
		}
	}

	func windowIsRestorable(_ isRestorable: Bool = true) -> some View {
		accessHostingWindow {
			$0?.isRestorable = isRestorable
		}
	}

	func windowIsMovableByWindowBackground(_ isMovableByWindowBackground: Bool = true) -> some View {
		accessHostingWindow {
			$0?.isMovableByWindowBackground = isMovableByWindowBackground
		}
	}

	func windowIsStandardButtonHidden(
		isHidden: Bool = true,
		_ buttonTypes: NSWindow.ButtonType...
	) -> some View {
		accessHostingWindow {
			for buttonType in buttonTypes {
				$0?.standardWindowButton(buttonType)?.isHidden = isHidden
			}
		}
	}
}
#endif


#if os(macOS)
extension Error {
	@MainActor
	func present() {
		// Required since `presentError` is not yet annotated with `@MainActor`. (macOS 13.5)
		DispatchQueue.main.async {
			NSApp.presentError(self)
		}
	}
}
#endif


extension Link<Label<Text, Image>> {
	init(
		_ title: String,
		systemImage: String,
		destination: URL
	) {
		self.init(destination: destination) {
			Label(title, systemImage: systemImage)
		}
	}
}



================================================
FILE: safari/Refined GitHub/AppIcon.icon/icon.json
================================================
{
  "fill" : {
    "automatic-gradient" : "display-p3:0.99391,1.00000,0.97644,1.00000"
  },
  "groups" : [
    {
      "blur-material" : null,
      "layers" : [
        {
          "glass" : true,
          "image-name" : "Octocat.png",
          "name" : "Octocat",
          "position" : {
            "scale" : 1,
            "translation-in-points" : [
              0,
              0
            ]
          }
        }
      ],
      "name" : "Group",
      "position" : {
        "scale" : 1,
        "translation-in-points" : [
          0,
          30
        ]
      },
      "shadow" : {
        "kind" : "neutral",
        "opacity" : 0.5
      },
      "specular" : false,
      "translucency" : {
        "enabled" : true,
        "value" : 0.1
      }
    }
  ],
  "supported-platforms" : {
    "circles" : [
      "watchOS"
    ],
    "squares" : "shared"
  }
}


================================================
FILE: safari/Refined GitHub/Assets.xcassets/Contents.json
================================================
{
  "info" : {
    "author" : "xcode",
    "version" : 1
  }
}



================================================
FILE: safari/Refined GitHub/Assets.xcassets/AccentColor.colorset/Contents.json
================================================
{
  "colors" : [
    {
      "idiom" : "universal"
    }
  ],
  "info" : {
    "author" : "xcode",
    "version" : 1
  }
}



================================================
FILE: safari/Refined GitHub/Assets.xcassets/LargeIcon.imageset/Contents.json
================================================
{
  "images" : [
    {
      "filename" : "Octocat.png",
      "idiom" : "universal"
    }
  ],
  "info" : {
    "author" : "xcode",
    "version" : 1
  }
}



================================================
FILE: safari/Web Extension/Info.plist
================================================
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>ITSAppUsesNonExemptEncryption</key>
	<false/>
	<key>NSExtension</key>
	<dict>
		<key>NSExtensionPointIdentifier</key>
		<string>com.apple.Safari.web-extension</string>
		<key>NSExtensionPrincipalClass</key>
		<string>$(PRODUCT_MODULE_NAME).SafariWebExtensionHandler</string>
	</dict>
</dict>
</plist>



================================================
FILE: safari/Web Extension/SafariWebExtensionHandler.swift
================================================
import SafariServices

final class SafariWebExtensionHandler: NSObject, NSExtensionRequestHandling {
	func beginRequest(with context: NSExtensionContext) {}
}



================================================
FILE: safari/Web Extension/Web Extension.entitlements
================================================
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>com.apple.security.app-sandbox</key>
	<true/>
</dict>
</plist>



================================================
FILE: source/background.ts
================================================
import 'webext-dynamic-content-scripts';
import 'webext-bugs/options-menu-item';
import {customizeNoAllUrlsErrorMessage} from 'webext-bugs/no-all-urls';
import {globalCache} from 'webext-storage-cache'; // Also needed to regularly clear the cache
import addPermissionToggle from 'webext-permission-toggle';
import {StorageItem} from 'webext-storage';
import {handleMessages} from 'webext-msg';
import {isSafari} from 'webext-detect';

import optionsStorage, {hasToken} from './options-storage.js';
import isDevelopmentVersion from './helpers/is-development-version.js';
import {doesBrowserActionOpenOptions} from './helpers/feature-utils.js';
import {styleHotfixes} from './helpers/hotfix.js';
import {fetchText} from './helpers/isomorphic-fetch.js';
import addReloadWithoutContentScripts from './options/reload-without.js';

const {version, permissions} = chrome.runtime.getManifest();

const welcomeShown = new StorageItem('welcomed', {defaultValue: false});

// GHE support
if (!isSafari()) {
	addPermissionToggle();
}

// Add "Reload without content scripts" functionality
addReloadWithoutContentScripts();

// Extend the error message for the "No All URLs" bugfix
customizeNoAllUrlsErrorMessage('Refined GitHub is not meant to run on every website. If youâ€™re looking to enable it on GitHub Enterprise, follow the instructions in the Options page.');

handleMessages({
	async openUrls(urls: string[], {tab}: chrome.runtime.MessageSender) {
		// Reuse container
		// TODO: https://github.com/refined-github/refined-github/issues/8657
		// Soft-disabled via `cookies` permission check: https://github.com/refined-github/refined-github/pull/8786#pullrequestreview-3491531965
		const firefoxOnlyProps = tab && 'cookieStoreId' in tab && permissions!.includes('cookies')
			? {cookieStoreId: tab.cookieStoreId}
			: {};

		for (const [index, url] of urls.entries()) {
			void chrome.tabs.create({
				url,
				index: tab!.index + index + 1,
				active: false,
				...firefoxOnlyProps,
			});
		}
	},
	async closeTab(_: any, {tab}: chrome.runtime.MessageSender) {
		void chrome.tabs.remove(tab!.id!);
	},
	fetchText,
	async fetchJSON(url: string) {
		const response = await fetch(url);
		return response.json();
	},
	async openOptionsPage() {
		return chrome.runtime.openOptionsPage();
	},
	async getStyleHotfixes() {
		return styleHotfixes.get(version);
	},
});

chrome.action.onClicked.addListener(async tab => {
	if (doesBrowserActionOpenOptions) {
		void chrome.runtime.openOptionsPage();
		return;
	}

	const {actionUrl} = await optionsStorage.getAll();
	if (!actionUrl) {
		// Default to options page if unset
		void chrome.runtime.openOptionsPage();
		return;
	}

	await chrome.tabs.create({
		openerTabId: tab.id,
		url: actionUrl,
	});
});

async function showWelcomePage(): Promise<void> {
	if (await welcomeShown.get()) {
		return;
	}

	const [token, permissions] = await Promise.all([
		hasToken(), // We can't handle an invalid token on a "Welcome" page, so just check whether the user has ever set one
		chrome.permissions.contains({origins: ['https://github.com/*']}),
	]);

	try {
		if (token && permissions) {
			// Mark as welcomed
			return;
		}

		const url = chrome.runtime.getURL('assets/welcome.html');
		await chrome.tabs.create({url});
	} finally {
		// Make sure it's always set to true even in case of errors
		await welcomeShown.set(true);
	}
}

chrome.runtime.onInstalled.addListener(async () => {
	if (isDevelopmentVersion()) {
		await globalCache.clear();
	}

	// Call after the reset above just in case we nuked Safari's base permissions
	await showWelcomePage();
});



================================================
FILE: source/content-script.ts
================================================
// Workaround to add ESM support to content scripts
void import(chrome.runtime.getURL('assets/refined-github.js'));



================================================
FILE: source/feature-data.ts
================================================
// Run `npm run vitest` to update these files
import importedFeaturesRaw from '../build/__snapshots__/imported-features.json' with {type: 'json'};
import featuresMetasRaw from '../build/__snapshots__/features-meta.json' with {type: 'json'};
import renamedFeatures from './feature-renames.json' with {type: 'json'};

export const importedFeatures = importedFeaturesRaw as FeatureID[];
export const featuresMeta = featuresMetasRaw as FeatureMeta[];

// eslint-disable-next-line unicorn/prefer-export-from -- The build silently fails to provide `renamedFeatures` in this scope. I don't know whose fault it is.
export {renamedFeatures};

export function getNewFeatureName(possibleFeatureName: string): FeatureID | undefined {
	// @ts-expect-error Useless "no index type" error as usual
	const newFeatureName = renamedFeatures[possibleFeatureName] as FeatureID ?? possibleFeatureName;
	return importedFeatures.includes(newFeatureName) ? newFeatureName : undefined;
}

export function getOldFeatureNames(featureName: string): string[] {
	const oldNames: string[] = [];
	for (const [oldName, newName] of Object.entries(renamedFeatures)) {
		if (newName === featureName) {
			oldNames.push(oldName);
		}
	}

	return oldNames;
}



================================================
FILE: source/feature-manager.tsx
================================================
/* eslint-disable no-await-in-loop -- Event loops */
import React from 'dom-chef';
import {elementExists} from 'select-dom';
import domLoaded from 'dom-loaded';
import stripIndent from 'strip-indent';
import type {Promisable} from 'type-fest';
import * as pageDetect from 'github-url-detection';
import {isWebPage} from 'webext-detect';
import {messageRuntime} from 'webext-msg';
import oneEvent from 'one-event';

import waitFor from './helpers/wait-for.js';
import ArrayMap from './helpers/map-of-arrays.js';
import bisectFeatures from './helpers/bisect.js';
import {
	shouldFeatureRun,
	isFeaturePrivate,
	type RunConditions,
} from './helpers/feature-utils.js';
import optionsStorage, {isFeatureDisabled, type RGHOptions} from './options-storage.js';
import {
	applyStyleHotfixes,
	getLocalHotfixesAsOptions,
	preloadSyncLocalStrings,
	brokenFeatures,
} from './helpers/hotfix.js';
import asyncForEach from './helpers/async-for-each.js';
import {catchErrors, disableErrorLogging} from './helpers/errors.js';
import {
	getFeatureID, listenToAjaxedLoad, log, shortcutMap,
} from './helpers/feature-helpers.js';
import {contentScriptToggle} from './options/reload-without.js';

type FeatureInitResult = void | false;
type FeatureInit = (signal: AbortSignal) => Promisable<FeatureInitResult>;

type FeatureLoader = RunConditions & {
	/** This only adds the shortcut to the help screen, it doesn't enable it. @default {} */
	shortcuts?: Record<string, string>;

	/** Whether to wait for DOM ready before running `init`. By default, it runs `init` as soon as `body` is found. @default false */
	awaitDomReady?: true;

	/**
	When pressing the back button, DOM changes and listeners are still there. Using a selector here would use the integrated deduplication logic, but it cannot be used with `delegate` and it shouldn't use `has-rgh` and `has-rgh-inner` anymore. #5871
	@deprecated
	@default false
	*/
	deduplicate?: string;

	init: Arrayable<FeatureInit>;
};

const currentFeatureControllers = new ArrayMap<FeatureID, AbortController>();

// eslint-disable-next-line no-async-promise-executor -- Rule assumes we don't want to leave it pending
const globalReady = new Promise<RGHOptions>(async resolve => {
	if (!isWebPage()) {
		throw new Error('This script should only be run on web pages');
	}

	listenToAjaxedLoad();

	const [options, contentScripts, localHotfixes, bisectedFeatures] = await Promise.all([
		optionsStorage.getAll(),
		contentScriptToggle.get(),
		getLocalHotfixesAsOptions(),
		bisectFeatures(),
		preloadSyncLocalStrings(),
	]);

	if (!contentScripts) {
		await contentScriptToggle.remove();
		const message = 'Refined GitHub: scripts were disabled for this load, but CSS canâ€™t be disabled this way.';
		console.warn(message);
		alert(message);
		return;
	}

	log.setup(options);

	await waitFor(() => document.body);

	if (pageDetect.is500() || pageDetect.isPasswordConfirmation()) {
		return;
	}

	if (elementExists('[refined-github]')) {
		console.warn(stripIndent(`
			Refined GitHub has been loaded twice. This may be because:

			â€¢ You loaded the developer version, or
			â€¢ The extension just updated

			If you see this at every load, please open an issue mentioning the browser you're using and the URL where this appears.
		`));
		return;
	}

	document.documentElement.setAttribute('refined-github', '');

	// Request in the background page to avoid showing a 404 request in the console
	// https://github.com/refined-github/refined-github/issues/6433
	// eslint-disable-next-line promise/prefer-await-to-then -- Reads as a callback
	void messageRuntime<string>({getStyleHotfixes: true}).then(applyStyleHotfixes);

	if (options.customCSS.trim().length > 0) {
		// Review #5857 and #5493 before making changes
		document.head.append(<style>{options.customCSS}</style>);
	}

	if (bisectedFeatures) {
		Object.assign(options, bisectedFeatures);
	} else {
		// If features are remotely marked as "seriously breaking" by the maintainers, disable them without having to wait for proper updates to propagate #3529
		void brokenFeatures.get();
		Object.assign(options, localHotfixes);
	}

	if (elementExists('body.logged-out')) {
		console.warn('Refined GitHub is only expected to work when youâ€™re logged in to GitHub. Errors will not be shown.');
		disableErrorLogging();
	} else {
		catchErrors();
	}

	// Detect unload via two events to catch both clicks and history navigation
	// https://github.com/refined-github/refined-github/issues/6437#issuecomment-1489921988
	document.addEventListener('turbo:before-fetch-request', unloadAll); // Clicks
	document.addEventListener('turbo:visit', unloadAll); // Back/forward button

	resolve(options);
});

function castArray<Item>(value: Arrayable<Item>): Item[] {
	return Array.isArray(value) ? value : [value];
}

async function add(url: string, ...loaders: FeatureLoader[]): Promise<void> {
	const id = getFeatureID(url);

	/* Feature filtering and running */
	const options = await globalReady;

	// Skip disabled features, unless the feature is private
	if (isFeatureDisabled(options, id) && !isFeaturePrivate(id)) {
		if (loaders.length === 0) {
			// CSS-only https://github.com/refined-github/refined-github/issues/7944
			// GitHub cleans up the CSS disabling attributes after navigation.
			// https://github.com/refined-github/refined-github/issues/8172
			do {
				document.documentElement.setAttribute('rgh-OFF-' + id, '');
				log.info('â†©ï¸', 'Skipping', id);
			} while (await oneEvent(document, 'turbo:render'));
		} else {
			log.info('â†©ï¸', 'Skipping', id);
		}

		return;
	}

	if (loaders.length === 0) {
		// CSS-only
		return;
	}

	void asyncForEach(loaders, async loader => {
		// Input defaults and validation
		const {
			shortcuts = {},
			asLongAs,
			include,
			exclude,
			init,
			awaitDomReady = false,
			deduplicate = false,
		} = loader;

		if (include?.length === 0) {
			throw new Error(`${id}: \`include\` cannot be an empty array, it means "run nowhere"`);
		}

		// 404 pages should only run 404-only features
		if (pageDetect.is404() && !include?.includes(pageDetect.is404) && !asLongAs?.includes(pageDetect.is404)) {
			return;
		}

		let firstLoop = true;
		do {
			if (awaitDomReady) {
				await domLoaded;
			}

			if (firstLoop) {
				firstLoop = false;
			} else if (deduplicate && elementExists(deduplicate)) {
				continue;
			}

			if (!await shouldFeatureRun({asLongAs, include, exclude})) {
				continue;
			}

			const featureController = new AbortController();
			currentFeatureControllers.append(id, featureController);

			// Do not await, or else an error on a page will break the feature completely until a reload
			void asyncForEach(castArray(init), async init => {
				const result = await init(featureController.signal);
				// Features can return `false` when they decide not to run on the current page
				if (result !== false && !isFeaturePrivate(id)) {
					log.info('âœ…', id);
					// Register feature shortcuts
					for (const [hotkey, description] of Object.entries(shortcuts)) {
						shortcutMap.set(hotkey, description);
					}
				}
			});
		} while (await oneEvent(document, 'turbo:render'));
	});
}

async function addCssFeature(url: string): Promise<void> {
	void add(url);
}

function unload(featureUrl: string): void {
	const id = getFeatureID(featureUrl);
	for (const controller of currentFeatureControllers.get(id) ?? []) {
		controller.abort();
	}
}

function unloadAll(): void {
	for (const feature of currentFeatureControllers.values()) {
		for (const controller of feature) {
			controller.abort();
		}
	}

	currentFeatureControllers.clear();
}

const features = {
	add,
	unload,
	addCssFeature,
};

export default features;



================================================
FILE: source/feature-renames.json
================================================
{
	"scrollable-code-and-blockquote": "scrollable-areas",
	"separate-draft-pr-button": "one-click-pr-or-gist",
	"prevent-pr-commit-link-loss": "prevent-link-loss",
	"remove-projects-tab": "clean-repo-tabs",
	"remove-unused-repo-tabs": "clean-repo-tabs",
	"more-dropdown": "clean-repo-tabs",
	"remove-diff-signs": "hide-diff-signs",
	"remove-label-faster": "quick-label-removal",
	"edit-files-faster": "quick-file-edit",
	"edit-comments-faster": "quick-comment-edit",
	"delete-review-comments-faster": "quick-review-comment-deletion",
	"hide-comments-faster": "quick-comment-hiding",
	"faster-reviews": "quick-review",
	"faster-pr-diff-options": "one-click-diff-options",
	"hide-useless-comments": "hide-low-quality-comments",
	"no-useless-split-diff-view": "no-unnecessary-split-diff-view",
	"unwrap-useless-dropdowns": "unwrap-unnecessary-dropdowns",
	"tag-changelog-link": "tag-changes-link",
	"list-pr-for-branch": "list-prs-for-branch",
	"quick-label-hiding": "quick-label-removal",
	"next-scheduled-github-action": "github-actions-indicators",
	"raw-file-link": "more-file-links",
	"conversation-filters": "more-conversation-filters",
	"quick-pr-diff-options": "one-click-diff-options",
	"quick-review-buttons": "one-click-review-submission",
	"pull-request-hotkey": "pull-request-hotkeys",
	"first-published-tag-for-merged-pr": "closing-remarks",
	"scheduled-and-manual-workflow-indicators": "github-actions-indicators",
	"useful-forks": "archive-forks-link",
	"set-default-repositories-type-to-sources": "hide-user-forks",
	"highlight-deleted-and-added-files-in-diffs": "new-or-deleted-file",
	"enable-file-links-in-compare-view": "actionable-pr-view-file",
	"use-first-commit-message-for-new-prs": "pr-first-commit-title",
	"comment-on-draft-pr-indicator": "netiquette",
	"draft-pr-notice": "netiquette",
	"highlight-collaborators-and-own-conversations": "conversation-authors"
}



================================================
FILE: source/feature-renames.test.ts
================================================
import {execSync} from 'node:child_process';
import fs from 'node:fs/promises';
import path from 'node:path';
import {test, expect} from 'vitest';

import featureRenames from './feature-renames.json';

const oldNames = Object.keys(featureRenames);
const newNames = Object.values(featureRenames);

test('old feature names cannot appear anywhere in the repo', () => {
	for (const oldName of oldNames) {
		const grep = `rg -l "[^-]${oldName}[^-]" -g !feature-renames.json -g !package-lock.json`;
		let results;
		try {
			results = execSync(grep, {encoding: 'utf8'});
		} catch {
			continue;
		}

		throw new Error(`Old feature name "${oldName}" found in ${results}`);
	}
});

test.concurrent.each(newNames)('new feature must exist: source/features/%s.tsx', async newName => {
	const filePath = path.join('source', 'features', `${newName}.tsx`);
	await expect(fs.stat(filePath)).resolves.toBeDefined();
});



================================================
FILE: source/globals.d.ts
================================================
/* eslint-disable no-var,@typescript-eslint/triple-slash-reference -- TypeScript weirdness */

/// <reference types="@types/dom-navigation" />

declare var content: {
	fetch: GlobalFetch;
} | undefined;

// eslint-disable-next-line unicorn/prefer-global-this -- Types not available there
declare var navigation: typeof window.navigation;

type GlobalFetch = typeof fetch;
type Arrayable<X> = X | X[];
type AnyObject = Record<string, any>;
type Deinit = {disconnect: VoidFunction} | {clear: VoidFunction} | {destroy: VoidFunction} | {abort: VoidFunction} | VoidFunction;

type FeatureID = string & {feature: true};
interface FeatureMeta {
	id: FeatureID;
	description: string;
	screenshot: string | null; // eslint-disable-line @typescript-eslint/no-restricted-types -- We use `null` in the JSON file
	css?: true;
}

// These types are unnecessarily loose
// https://dom.spec.whatwg.org/#dom-node-textcontent
interface ChildNode {
	textContent: string;
}
interface Text {
	textContent: string;
}
interface Element {
	textContent: string;
}

declare module 'size-plugin';

declare module '*.gql' {
	export = string;
}

// Custom UI events specific to RGH
interface GlobalEventHandlersEventMap {
	'details:toggled': CustomEvent;
	'pjax:error': CustomEvent;
	'page:loaded': CustomEvent;
	'turbo:visit': CustomEvent;
	'session:resume': CustomEvent;
	// No input:InputEvent match
	// https://github.com/microsoft/TypeScript-DOM-lib-generator/issues/1174#issuecomment-933042088
}

declare namespace JSX {
	interface IntrinsicElements {
		'clipboard-copy': IntrinsicElements.button & {for?: string};
		'details-dialog': IntrinsicElements.div & {tabindex: string};
		'details-menu': IntrinsicElements.div & {src?: string; preload?: boolean};
		'has-rgh': IntrinsicElements.div;
		'has-rgh-inner': IntrinsicElements.div;
		'include-fragment': IntrinsicElements.div & {src?: string};
		label: IntrinsicElements.label & {for?: string};
		'relative-time': IntrinsicElements.div & {datetime: string};
		'tab-container': IntrinsicElements.div;
		'batch-deferred-content': IntrinsicElements.div;
		'time-ago': IntrinsicElements.div & {datetime: string; format?: string};
		'anchored-position': IntrinsicElements.div;
	}

	type BaseElement = IntrinsicElements['div'];
	interface IntrinsicAttributes extends BaseElement {
		width?: number;
		height?: number;
	}
}

// Drop after https://github.com/Microsoft/TypeScript/issues/30928
// eslint-disable-next-line @typescript-eslint/consistent-indexed-object-style -- Declaration merging
interface NamedNodeMap {
	[key: string]: Attr;
}

// Drop after https://github.com/Microsoft/TypeScript/issues/30928
// eslint-disable-next-line @typescript-eslint/consistent-indexed-object-style, @typescript-eslint/naming-convention -- Declaration merging
interface HTMLFormControlsCollection {
	[key: string]: HTMLInputElement | HTMLTextAreaElement | HTMLButtonElement | HTMLSelectElement;
}

// Make `element.cloneNode()` preserve its type instead of returning Node
interface Node extends EventTarget {
	cloneNode(deep?: boolean): this;
}

interface SignalAsOptions {
	signal?: AbortSignal;
}



================================================
FILE: source/manifest.json
================================================
{
	"$schema": "https://json.schemastore.org/chrome-manifest",
	"name": "Refined GitHub",
	"version": "0.0.0",
	"description": "Simplifies the GitHub interface and adds useful features",
	"homepage_url": "https://github.com/refined-github/refined-github",
	"manifest_version": 3,
	"minimum_chrome_version": "123",
	"browser_specific_settings": {
		"gecko": {
			"id": "{a4c4eda4-fb84-4a84-b4a1-f7c1cbf2a1ad}",
			"strict_min_version": "128.0"
		},
		"gecko_android": {
			"strict_min_version": "128.0"
		}
	},
	"permissions": [
		"storage",
		"scripting",
		"contextMenus",
		"activeTab",
		"alarms"
	],
	"host_permissions": [
		"https://github.com/*",
		"https://api.github.com/*"
	],
	"action": {
		"default_icon": "assets/icon.png"
	},
	"optional_host_permissions": [
		"*://*/*"
	],
	"icons": {
		"128": "assets/icon.png"
	},
	"options_page": "assets/options.html",
	"background": {
		"service_worker": "assets/background.js",
		"type": "module",
		"scripts": [
			"assets/background.js"
		]
	},
	"content_scripts": [
		{
			"run_at": "document_start",
			"matches": [
				"https://github.com/*",
				"https://gist.github.com/*"
			],
			"exclude_matches": [
				"https://*/login/*"
			],
			"css": [
				"assets/refined-github.css"
			],
			"js": [
				"assets/content-script.js"
			]
		}
	],
	"web_accessible_resources": [
		{
			"resources": [ "assets/*" ],
			"matches": [ "https://*/*" ]
		}
	]
}



================================================
FILE: source/options-storage.ts
================================================
import OptionsSyncPerDomain from 'webext-options-sync-per-domain';

import {importedFeatures, renamedFeatures} from './feature-data.js';

export type RGHOptions = typeof defaults;

// eslint-disable-next-line prefer-object-spread -- TypeScript hates this one weird trick
const defaults = Object.assign({
	actionUrl: 'https://github.com/',
	customCSS: '',
	personalToken: '',
	logging: false,
	logHTTP: false,
}, Object.fromEntries(importedFeatures.map(id => [`feature:${id}`, true])));

export function isFeatureDisabled(options: RGHOptions, id: string): boolean {
	// Must check if it's specifically `false`: It could be undefined if not yet in the readme or if misread from the entry point #6606
	// eslint-disable-next-line @typescript-eslint/no-unnecessary-boolean-literal-compare
	return options[`feature:${id}`] === false;
}

const migrations = [
	(options: RGHOptions): void => {
		for (const [from, to] of Object.entries(renamedFeatures)) {
			if (typeof options[`feature:${from}`] === 'boolean') {
				options[`feature:${to}`] = options[`feature:${from}`];
			}
		}
	},

	// Removed features will be automatically removed from the options as well
	OptionsSyncPerDomain.migrations.removeUnused,
];

export const perDomainOptions = new OptionsSyncPerDomain({defaults, migrations});
const optionsStorage = perDomainOptions.getOptionsForOrigin();
export default optionsStorage;

const cachedSettings = optionsStorage.getAll();

export async function getToken(): Promise<string | undefined> {
	const {personalToken} = await cachedSettings;
	return personalToken;
}

export async function hasToken(): Promise<boolean> {
	return Boolean(await getToken());
}



================================================
FILE: source/options.css
================================================
#js-failed + form {
	display: none;
}

:root {
	--rgh-red: #cf222e;
	--content-width: 750px; /* Sync with media query below */
	--viewport-margin: 30px;

	max-width: none;
}

body {
	margin: 0;
}

form {
	max-width: var(--content-width);
	margin: auto;
	padding-block: 1em;
}

html::after {
	/* Add some extra scroll to the page to reduce section toggle jumps/scroll */
	content: '';
	display: block;
	height: 50vh;
	background: url('icon.png') center no-repeat;
	filter: opacity(0.1) saturate(0) brightness(1.2);
}

@media (prefers-color-scheme: dark) {
	:root {
		--rgh-red: #f85149;
	}
}

p,
ul {
	margin-top: 0;
}

/* :not() due to https://github.com/refined-github/refined-github/issues/8062 */
p:last-child:not(.info p),
ul:last-child {
	margin-bottom: 0;
}

ul {
	padding-left: 0;
	list-style: none;
}

li[data-validation] {
	margin-bottom: 0.3em;
}

storage-usage {
	font-style: italic;
}

small {
	opacity: 80%;
}

details {
	margin-bottom: 1em;

	--border-radius: 6px;

	border: solid 1px transparent;
	border-radius: var(--border-radius);

	/* Sync with --content-width */
	@media (width <= 750px) {
		border-width: 0;
	}

	&[open] {
		border-color: light-dark(#d2d9e0, #3d444d);
	}
}

details > div {
	padding: 10px;
}

summary {
	--summary-padding: 10px;

	position: sticky;
	top: 0;
	z-index: 1;
	background: light-dark(#f6f8fa, #141415);
	list-style: none;
	padding: var(--summary-padding);

	[open] & {
		border-top-left-radius: var(--border-radius);
		border-top-right-radius: var(--border-radius);
	}
}

summary::-webkit-details-marker {
	display: none; /* Just for Safari. Chrome uses `list-style` */
}

summary:hover {
	background: light-dark(#e3e9ef, #0e1012);
}

[data-validation] {
	padding-left: 1.8em;
}

[data-validation]::before {
	content: url('data:image/svg+xml; utf8, <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" fill="gray" d="M8 5.5a2.5 2.5 0 100 5 2.5 2.5 0 000-5zM4 8a4 4 0 118 0 4 4 0 01-8 0z"></path></svg>');
	width: 16px;
	height: 16px;
	vertical-align: -4px;
	margin-right: 0.8em;
	margin-left: -1.8em; /* Pull out */
	display: inline-block;
}

[data-validation='valid']::before {
	content: url('data:image/svg+xml; utf8, <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" fill="%2328a745" d="M8 16A8 8 0 108 0a8 8 0 000 16zm3.78-9.72a.75.75 0 00-1.06-1.06L6.75 9.19 5.28 7.72a.75.75 0 00-1.06 1.06l2 2a.75.75 0 001.06 0l4.5-4.5z"></path></svg>');
}

[data-validation='invalid']::before {
	content: url('data:image/svg+xml; utf8, <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" fill="%23cb2431" d="M1.5 8a6.5 6.5 0 0110.535-5.096l-9.131 9.131A6.472 6.472 0 011.5 8zm2.465 5.096a6.5 6.5 0 009.131-9.131l-9.131 9.131zM8 0a8 8 0 100 16A8 8 0 008 0z"></path></svg>');
}

[name='customCSS'] {
	font-size: 11px;
}

[name='personalToken']:not(:focus) {
	-webkit-text-security: circle;
}

.feature:not([hidden]) {
	display: flex;
	align-items: baseline;
	flex-wrap: wrap;
	gap: 0 0.4em;
}

.feature input[type='checkbox'] {
	flex-shrink: 0;
}

.feature-checkbox:not(:checked) + .info .feature-name {
	text-decoration: line-through;
}

.feature:has(.feature-checkbox:disabled) > *:not(.hotfix-notice) {
	opacity: 50%;
}

.feature .info {
	flex: 1;
}

.feature .description {
	opacity: 80%;
}

.feature-link {
	margin: 0 0.6em;
}

.screenshot {
	max-width: 100%;
	margin-bottom: 2em;
	border: 1px solid #d1d5da;
	border-radius: 0.5em;
	min-width: 2em;
	min-height: 2em;
}

.screenshot-toggle:checked ~ .screenshot-link {
	font-style: italic;
}

.screenshot-toggle:checked ~ .screenshot {
	display: block;
}

/* Hide "Button link" on GHE domains https://github.com/refined-github/refined-github/issues/7704 */
.OptionsSyncPerDomain-picker:has([value='default']:not(:checked)) ~ #action {
	display: none;
}



================================================
FILE: source/options.html
================================================
<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="color-scheme" content="light dark">
<base target="_blank">
<link rel="shortcut icon" href="icon.png">
<title>Refined GitHub options</title>
<link rel="stylesheet" href="options.css">
<script type="module" src="header.js"></script>
<script type="module" src="storage-usage.js"></script>
<script type="module" src="options.js" defer></script>
<rgh-header title="Refined GitHub">
	<p>
		Visit the <a href="https://github.com/refined-github/refined-github/wiki">wiki</a> to learn about updates, debugging, and GitHub Enterprise.
		You can <a href="https://chrome.google.com/webstore/detail/refined-github/hlepfoohegkhhmjieoechaddaejaokhf/reviews" id="rate-link">rate Refined GitHub</a> to help others find it.
		Follow or sponsor <a href="https://github.com/sponsors/fregante">@fregante</a> if Refined GitHub helps you work more efficiently. ğŸ»
	</p>
</rgh-header>

<div id="js-failed">JavaScript failed to load. Your development build failed or your browser has some issue.</div>

<form id="options-form" class="detail-view-container">
	<!-- Captures and ignores native enter-to-submit action -->
	<button hidden>Capture Submit</button>

	<details id="token">
		<summary><strong>ğŸ”‘ Personal token</strong></summary>
		<div>
			<!-- Keep this URL in sync with welcome.svelte -->
			<p>You should <a id="personal-token-link" href="https://github.com/settings/tokens/new?description=Refined%20GitHub&scopes=repo,read:project,workflow&default_expires_at=none">generate a token</a> to ensure that every feature works correctly. You can read more about the token on <a href="https://github.com/refined-github/refined-github/wiki/Security">the wiki.</a></p>
			<p><strong>Token-less usage is not officially supported.</strong></p>
			<p>
				<input
					type="text"
					name="personalToken"
					spellcheck="false"
					autocomplete="off"
					autocapitalize="off"
					size="20"
					class="monospace-field"
				>
				<span id="validation"></span>
			</p>
			<ul>
				<li data-validation data-scope="valid_token">The token enables <a href="https://github.com/search?q=repo%3Arefined-github%2Frefined-github+%28api.js+OR+does-file-exist.js+OR+get-default-branch.js+OR+get-pr-info.js+OR+pr-ci-status.js%29+path%3A%2F%5Esource%5C%2Ffeatures%5C%2F%2F&type=code">some features</a> to <strong>read</strong> data from public repositories
				<li data-validation data-scope="public_repo">The <code>public_repo</code> scope lets them <strong>edit</strong> your public repositories
				<li data-validation data-scope="repo">The <code>repo</code> scope lets them <strong>edit private</strong> repositories as well
				<li data-validation data-scope="read:project">The <code>read:project</code> scope lets them determine if a repo/org uses projects
				<li data-validation data-scope="workflow">The <code>workflow</code> scope lets them <strong>edit workflow files</strong> <code>.github/workflows/*.yml</code>
			</ul>
		</div>
	</details>

	<details id="toggle-all" hidden>
		<summary><strong>ğŸ³ï¸ Toggle all features</strong></summary>
		<div>
			<p>
				If you're trying to identify a feature, please use "Identify feature" instead. Refined GitHub only implements lightweight features that are helpful to most people, even if they're tiny improvements. They're meant to "blend in" and fill in the gaps of GitHub's interface.
			</p>
			<p>
				If you want to go through and only select a few improvements, you'll miss out on the best parts of Refined GitHub. Also note that new features will still be enabled by default and that some CSS-only refinements cannot be disabled.
			</p>
			<p>
				<button id="disable-all-features">Disable all features</button>
				<button id="enable-all-features">Enable all features</button>
			</p>
		</div>
	</details>

	<details id="features">
		<summary><strong class="features-header">ğŸ”‹ Features</strong></summary>
		<div>
			<p>
					<input id="filter-features" type="text" placeholder="Find features" spellcheck="false" autocomplete="off" autocapitalize="off">
					<small>Use the "Identify feature" section below if you can't find what you're looking for.</small>
			</p>
			<div class="js-features"></div>
		</div>
	</details>

	<details id="bisect">
		<summary><strong>ğŸ” Identify feature</strong></summary>
		<div>
			<p>
				This process will help you identify what Refined GitHub feature is making changes or causing issues on GitHub.
			</p>
			<p id="find-feature-message" hidden>
				Visit the GitHub page where you want to find the feature and refresh it to see the instructions. You can navigate to any page, but donâ€™t use multiple tabs.
			</p>
			<p>
				<button id="find-feature">Start process to identify featureâ€¦</button>
			</p>
		</div>
	</details>

	<details id="css">
		<summary><strong>ğŸ’… Custom CSS</strong></summary>
		<div>
			<p>Like a userstyle, useful to undo unwanted style changes</p>
			<p><textarea name="customCSS" rows="2" spellcheck="false" class="monospace-field"></textarea></p>
			<p>Options storage: <storage-usage area="sync" item="options">unknown</storage-usage></p>
			<p>When the storage is full, the options <a href="https://github.com/fregante/webext-options-sync/issues/27">will stop being saved</a>. If you need to use a lot of CSS, use a dedicated userstyle extension.</p>
		</div>
	</details>

	<details id="action">
		<summary><strong>ğŸ”— Button link</strong></summary>
		<div>
			<p>You can pick what page opens when you click the Refined GitHub icon in the browser toolbar</p>
			<p><input type="url" name="actionUrl" placeholder="https://example.com" spellcheck="false" autocomplete="off" autocapitalize="off"></p>
			<p>If left empty, clicking it will open this options page.</p>
		</div>
	</details>

	<details id="debugging">
		<summary><strong>ğŸ› Debugging</strong></summary>
		<div>
			<p>
				<label>
					<input type="checkbox" name="logging">
					Show the features enabled on each page in the console
				</label>
			</p>
			<p>
				<label>
					<input type="checkbox" name="logHTTP">
						Log API calls in the console
				</label>
			</p>
			<p>
				Options storage: <storage-usage area="sync" item="options">unknown</storage-usage><br>
				Cache storage: <storage-usage area="local">unknown</storage-usage><br>
				Refined Github version: <output id="version">unknown</output>
			</p>
			<p>
				<button id="clear-cache">Clear cache</button>
			</p>
			<p>
				<!-- Native link that looks like a button (to blend in better). Don't @ me -->
				<button type="submit" form="welcome-page-link">Open welcome page</button>
			</p>
			<p>
				<button id="toggle-all-features">Toggle all featuresâ€¦</button>
			</p>
		</div>
	</details>

	<details id="hotfixes">
		<summary><strong>â˜„ï¸ Hotfixes</strong></summary>
		<div>
			<p>In order to address severe issues as quickly as possible, Refined GitHub loads a list of disabled features and temporary CSS fixes. <a href="https://github.com/refined-github/yolo">More info.</a></p>
			<p>This is the latest CSS fetched from the server (if any):</p>
			<p><textarea id="hotfixes-field" rows="2" disabled></textarea></p>
			<p><textarea id="broken-features-field" rows="2" disabled hidden></textarea></p>
			<button type="button" id="fetch-hotfixes">Fetch hotfixes</button>
		</div>
	</details>

	<details id="export">
		<summary><strong>ğŸ—„ï¸ Export options</strong></summary>
		<div>
			<p>
				You can export and import options across browsers and devices via a JSON file. If you're a GitHub Enterprise user, you will need to export each domain separately.
			</p>
			<p>
				<strong>Note</strong> that your options include your access token if provided.
			</p>
			<p>
				<button type="button" class="js-export">Export</button>
				<button type="button" class="js-import">Import</button>
			</p>
		</div>
	</details>

</form>

<!-- Native link that looks like a button (to blend in better). Don't @ me -->
<form action="./welcome.html" method="get" target="_blank" id="welcome-page-link"></form>



================================================
FILE: source/options.tsx
================================================
import 'webext-base-css/webext-base.css';
import './options.css';
import {$, $optional} from 'select-dom/strict.js';
import {$$} from 'select-dom';
import fitTextarea from 'fit-textarea';
import {enableTabToIndent} from 'indent-textarea';
import delegate, {type DelegateEvent} from 'delegate-it';
import {isChrome, isFirefox} from 'webext-detect';
import type {SyncedForm} from 'webext-options-sync-per-domain';
import 'webext-bugs/target-blank';

import clearCacheHandler from './helpers/clear-cache-handler.js';
import {brokenFeatures, styleHotfixes} from './helpers/hotfix.js';
import {importedFeatures} from './feature-data.js';
import {perDomainOptions} from './options-storage.js';
import isDevelopmentVersion from './helpers/is-development-version.js';
import {doesBrowserActionOpenOptions} from './helpers/feature-utils.js';
import {state as bisectState} from './helpers/bisect.js';
import initFeatureList, {updateListDom} from './options/feature-list.js';
import initTokenValidation from './options/token-validation.js';
import initToggleAllButtons from './options/toggle-all.js';

const supportsFieldSizing = CSS.supports('field-sizing', 'content');

let syncedForm: SyncedForm | undefined;

const {version} = chrome.runtime.getManifest();

async function findFeatureHandler(this: HTMLButtonElement): Promise<void> {
	// TODO: Add support for GHE
	const options = await perDomainOptions.getOptionsForOrigin().getAll();
	const enabledFeatures = importedFeatures.filter(featureId => options['feature:' + featureId]);
	await bisectState.set(enabledFeatures);

	this.disabled = true;
	setTimeout(() => {
		this.disabled = false;
	}, 10_000);

	$('#find-feature-message').hidden = false;
}

function focusSection({delegateTarget: section}: DelegateEvent<Event, HTMLDetailsElement>): void {
	const rect = section.getBoundingClientRect();
	if (rect.bottom > window.innerHeight || rect.top < 0) {
		section.scrollIntoView({behavior: 'smooth', block: 'nearest'});
	}

	if (section.open) {
		const field = $optional('input, textarea', section);
		if (field) {
			field.focus({preventScroll: true});
			if (!supportsFieldSizing && field instanceof HTMLTextAreaElement) {
				// #6404
				fitTextarea(field);
			}
		}
	}
}

function updateRateLink(): void {
	if (isChrome()) {
		return;
	}

	$('a#rate-link').href = isFirefox() ? 'https://addons.mozilla.org/en-US/firefox/addon/refined-github-' : 'https://apps.apple.com/app/id1519867270?action=write-review';
}

function isEnterprise(): boolean {
	return syncedForm!.getSelectedDomain() !== 'default';
}

function getExclusions(): string | void {
	if (isEnterprise()) {
		return 'Hotfixes are not applied on GitHub Enterprise.';
	}

	if (isDevelopmentVersion()) {
		return 'Hotfixes are not applied in the development version';
	}
}

async function showStoredCssHotfixes(): Promise<void> {
	$('#hotfixes-field').textContent
		= getExclusions()
			?? await styleHotfixes.getCached(version)
			?? 'No CSS found in cache.';
}

async function fetchHotfixes(event: MouseEvent): Promise<void> {
	const button = event.currentTarget as HTMLButtonElement;
	button.disabled = true;
	try {
		// Style
		$('#hotfixes-field').textContent
			= getExclusions()
				?? await styleHotfixes.getFresh(version)
				?? 'No hotfixes needed for this version! ğŸ‰';

		// Broken features
		const storage = await brokenFeatures.getFresh();
		const field = $('#broken-features-field');
		field.hidden = false;
		field.textContent = JSON.stringify(storage, undefined, 2);
	} finally {
		button.disabled = false;
	}
}

async function generateDom(): Promise<void> {
	// Generate list
	await initFeatureList();

	// Update list from saved options
	syncedForm = await perDomainOptions.syncForm('form');

	// Decorate list
	updateListDom();
	initToggleAllButtons();

	// Only now the form is ready, we can show it
	$('#js-failed').remove();

	// Enable token validation
	void initTokenValidation(syncedForm);

	// Update rate link if necessary
	updateRateLink();

	// Hide non-applicable "Button link" section
	if (doesBrowserActionOpenOptions) {
		$('#action').hidden = true;
	}

	// Show stored CSS hotfixes
	void showStoredCssHotfixes();

	$('#version').textContent = version;
}

function addEventListeners(): void {
	// Update domain-dependent page content when the domain is changed
	syncedForm?.onChange(async domain => {
		// Point the link to the right domain
		$('a#personal-token-link').host = domain === 'default' ? 'github.com' : domain;

		for (const element of $$('storage-usage[item]')) {
			element.setAttribute('item', domain === 'default' ? 'options' : 'options:' + domain);
		}

		updateListDom();
	});

	// Refresh page when permissions are changed (because the dropdown selector needs to be regenerated)
	chrome.permissions.onRemoved.addListener(() => {
		location.reload();
	});
	chrome.permissions.onAdded.addListener(() => {
		location.reload();
	});

	// Improve textareas editing
	enableTabToIndent('textarea');
	if (!supportsFieldSizing) {
		fitTextarea.watch('textarea');
	}

	// Bring section into view when opened
	delegate('details', 'toggle', focusSection, {capture: true});

	// Add cache clearer
	$('#clear-cache').addEventListener('click', clearCacheHandler);

	// Add bisect tool
	$('#find-feature').addEventListener('click', findFeatureHandler);

	// Handle "Fetch hotfixes" button
	$('#fetch-hotfixes').addEventListener('click', fetchHotfixes);
}

async function init(): Promise<void> {
	await generateDom();
	addEventListeners();
}

void init();



================================================
FILE: source/refined-github.css
================================================
:root {
	--rgh-green: var(--fgColor-success, var(--color-success-fg, #1a7f37));
	--rgh-red: var(--fgColor-danger, var(--color-danger-fg, #cf222e));
	--rgh-yellow: var(--fgColor-attention, #c69026);
	--rgh-border-color: var(
		--borderColor-muted,
		var(--color-border-muted, #d8dee4)
	);
	--rgh-background: var(--bgColor-default, var(--color-canvas-default, #fff));
}

/* For `open-all-selected` and `pr-filters`: set a reduced padding for all buttons for #1830 and #1904 */
#js-issues-toolbar .table-list-header-toggle details {
	padding: 0 !important;
}

#js-issues-toolbar .table-list-header-toggle summary {
	padding-left: 8px !important;
	padding-right: 8px !important;
}

#js-issues-toolbar .table-list-header-toggle > :last-child > summary {
	padding-right: 0 !important;
}

/* For `open-all-notifications` and `select-notifications`: allow header wrapping #5705

Selector works on:
https://github.com/notifications (Grouped by date)
https://github.com/notifications (Grouped by repo)
https://github.com/notifications?query=reason%3Acomment (which is an unsaved filter)
*/
.js-check-all-container .js-bulk-action-toasts ~ div .Box-header {
	flex-wrap: wrap;
	height: auto !important; /* Unset the default height to allow wrapping */
	min-height: 52px; /* Re-set the default height as a minimum height */
}

:is(
		.js-notifications-mark-selected-actions,
		.js-notifications-mark-all-actions
	):not([hidden]) {
	display: contents !important;
}

[alt='404 â€œThis is not the web page you are looking forâ€'] {
	animation: fade-in 2s ease-out;
}

/* Lighten deletions in Markdown */
.markdown-body del {
	color: var(--fgColor-muted, var(--color-fg-muted, fuchsia));
}

/* Make <details> visibly clickable */
.markdown-body summary /* Summary elements are always clickable when present */,
.markdown-body details:not([open]) {
	/* Summary-less details have unselectable clickable elements */
	cursor: pointer;
}

/* Remove the "New repository" button in the dashboard sidebar */
.dashboard-sidebar a.Button[href='/new'] {
	display: none;
}

/* Expand empty diffs in PRs */
:root .file .data.empty {
	padding: 54px;
	text-align: center;
}

:root .file .data table {
	text-align: left;
}

/* Improve dropdown expansion animation (e.g. top-right dropdown in comments) */
/* It normally pops in from the center */
.dropdown-menu-sw {
	transform-origin: 90% top;
}

/* Improve spacing in conversation lists meta, made feel crowded by:
conversation-authors
parse-backticks
pr-branches
*/
.js-issue-row .text-small.color-fg-muted {
	line-height: 1.8;
}

/* Reset `vertical-align` for .octicons to work with above increased line-height */
.js-issue-row .text-small.color-fg-muted .octicon {
	vertical-align: middle;
}

/* Hide duplicate "You can also open this in GitHub Desktop" in PRsâ€™ mergeability box */
#partial-pull-merging .js-remove-unless-platform {
	display: none;
}

/* Increase scrollable area in GitHub Actions #3591 */
.WorkflowRunLogsScroll {
	height: auto !important;
}

/* Keep diff stats in "Jump to" dropdown when the header is fixed #3925 */
.select-menu-item-text .diffstat {
	display: inline !important;
}

/* Style the "Find feature" dialog that appears on top of the page */
#rgh-bisect-dialog {
	position: fixed;
	bottom: 50%;
	right: 50%;
	transform: translate(50%, 50%);
	min-width: 380px; /* Avoids a width change on the last step which causes the YES button to be where NO was */
	box-shadow: var(
		--shadow-floating-large,
		var(--color-shadow-large, var(--color-toast-shadow))
	);
	z-index: 2147483647;
}

/* Space out "Edit" and "Open with" buttons on PR page, also for `view-last-pr-deployment` #4281 */
.gh-header-actions [aria-label='Edit Pull Request title'] {
	margin-left: 4px !important;
	margin-right: 4px !important;
}

/* Remove the underline on PR filename copy button hover #4871 */
.file-header .file-info clipboard-copy {
	display: inline-block;
}

/* Ensure all buttons in the repo file navigation header are aligned in the center rather than to the top */
.file-navigation.flex-items-start {
	align-items: center !important;
}

/* Bold username in conversation lists #4899 */
:is(.js-issue-row, .js-pinned-issue-list-item) [data-hovercard-type='user'] {
	font-weight: 600;
}

/* Fit large images in the window when viewing single files */
div[data-target='readme-toc.content'] div.blob-wrapper img {
	max-width: 100%;
}

/* Hide label on Milestones link if there are zero milestones #5120 */
/* TODO: Drop in March 2025 if they don't add it to https://github.com/tc39/ecma402/issues */
[data-selected-links^='repo_milestones ']:has([title='0']) {
	width: 36px; /* Size it so only the icon is visible */
	overflow: hidden; /* Crop the text out */
	padding-left: 10px;
}

[data-selected-links^='repo_milestones ']:has([title='0']) svg {
	margin-right: 20px; /* Push the text farther away from the text so it's cropped out */
}

.rgh-bg-none {
	background: none !important;
}

.rgh-z-index-5 {
	position: relative;
	z-index: 5;
}

/* Increase size of profile picture in user hovercard by 1.5x (default is 48px) #7695 */
/* Test: https://github.com/refined-github/refined-github */
.user-hovercard-avatar > img.d-block.avatar-user {
	width: 72px;
	height: 72px;
}

.octicon-star-fill {
	color: var(--button-star-iconColor);
}

/* Untruncate long job name #8372 */
/* Test: https://github.com/valkey-io/valkey-glide/actions/runs/14163355151/job/39672349767 */
.ActionListItem .ActionListItem-label--truncate {
	white-space: unset !important;
}

/* Add hover effect to attachment row on the release page #8339 */
/* Test: https://github.com/refined-github/refined-github/releases/tag/25.7.16 */
@media (min-width: 800px) {
	.Box-footer
		.Box--condensed
		li:has(.octicon-package, .octicon-file-zip):hover {
		background-color: var(--bgColor-muted, fuchsia);
		&:first-of-type {
			border-top-color: var(--borderColor-muted, fuchsia);
		}
	}
}



================================================
FILE: source/refined-github.ts
================================================
// Core feature that needs to run first; it serves the `deduplicate` key.
import './features/rgh-deduplicator.js';

import './refined-github.css';
import './github-helpers/heat-map.css';

// CSS-only features
import './features/github-bugs.css';
import './features/tab-size.css';
import './features/center-reactions-popup.css';
import './features/monospace-textareas.css';
import './features/safer-destructive-actions.css';
import './features/clean-footer.css';
import './features/pr-approvals-count.css';
import './features/clean-conversations.css';
import './features/sticky-conversation-list-toolbar.css';
import './features/clean-notifications.css';
import './features/night-not-found.css';
import './features/sticky-file-header.css';
import './features/sticky-notifications-actions.css';
import './features/readable-title-change-events.css';
import './features/clean-checks-list.css';
import './features/sticky-csv-header.css';
import './features/mark-private-repos.css';
import './features/mobile-tabs.css';

// DO NOT add CSS files here if they are part of a JavaScript feature.
// Import the `.css` file from the `.tsx` instead.

// CSS-only disableable features
import './features/align-issue-labels.js';
import './features/clean-pinned-issues.js';
import './features/hide-diff-signs.js';
import './features/clean-rich-text-editor.js';
import './features/sticky-comment-header.js';

// Disableable features
import './features/useful-not-found-page.js';
import './features/more-dropdown-links.js';
import './features/releases-tab.js';
import './features/one-key-formatting.js';
import './features/tab-to-indent.js';
import './features/hide-navigation-hover-highlight.js';
import './features/selection-in-new-tab.js';
import './features/quick-comment-hiding.js';
import './features/quick-comment-edit.js';
import './features/open-all-notifications.js';
import './features/copy-on-y.js';
import './features/profile-hotkey.js';
import './features/close-out-of-view-modals.js';
import './features/improve-shortcut-help.js';
import './features/shorten-links.js';
import './features/linkify-code.js';
import './features/download-folder-button.js';
import './features/linkify-branch-references.js';
import './features/open-all-conversations.js';
import './features/conversation-links-on-repo-lists.js';
import './features/global-conversation-list-filters.js';
import './features/more-conversation-filters.js';
import './features/sort-conversations-by-update-time.js'; // Must be after global-conversation-list-filters and more-conversation-filters and conversation-links-on-repo-lists
import './features/pinned-issues-update-time.js';
import './features/default-branch-button.js';
import './features/one-click-diff-options.js';
import './features/ci-link.js';
import './features/sync-pr-commit-title.js';
import './features/hide-inactive-deployments.js';
import './features/pull-request-hotkeys.js';
import './features/one-click-review-submission.js';
import './features/embed-gist-inline.js';
import './features/comments-time-machine-links.js';
import './features/esc-to-deselect-line.js';
import './features/create-release-shortcut.js';
import './features/patch-diff-links.js';
import './features/parse-backticks.js';
import './features/mark-merge-commits-in-list.js';
import './features/swap-branches-on-compare.js';
import './features/reactions-avatars.js';
import './features/show-names.js';
import './features/previous-next-commit-buttons.js';
import './features/extend-diff-expander.js';
import './features/profile-gists-link.js';
import './features/show-user-top-repositories.js';
import './features/hide-user-forks.js';
import './features/user-profile-follower-badge.js';
import './features/highlight-non-default-base-branch.js';
import './features/mark-private-orgs.js';
import './features/linkify-commit-sha.js';
import './features/warning-for-disallow-edits.js';
import './features/warn-pr-from-master.js';
import './features/preview-hidden-comments.js';
import './features/fit-textareas.js';
import './features/collapsible-content-button.js';
import './features/actionable-pr-view-file.js'; // Must be before more-file-links
import './features/more-file-links.js';
import './features/pr-filters.js';
import './features/quick-file-edit.js';
import './features/update-pr-from-base-branch.js';
import './features/tag-changes-link.js';
import './features/clean-conversation-sidebar.js';
import './features/sticky-sidebar.js';
import './features/release-download-count.js';
import './features/open-issue-to-latest-comment.js';
import './features/toggle-everything-with-alt.js';
import './features/suggest-commit-title-limit.js';
import './features/highest-rated-comment.js';
import './features/clean-conversation-filters.js';
import './features/tags-on-commits-list.js';
import './features/conventional-commits.js';
import './features/list-prs-for-file.js';
import './features/pr-branch-auto-delete.js';
import './features/linkify-symbolic-links.js'; // Must be before show-whitespace
import './features/show-whitespace.js';
import './features/restore-file.js';
import './features/hidden-review-comments-indicator.js';
import './features/reload-failed-proxied-images.js';
import './features/conversation-authors.js';
import './features/one-click-pr-or-gist.js';
import './features/dim-bots.js';
import './features/conflict-marker.js';
import './features/html-preview-link.js';
import './features/linkify-user-location.js';
import './features/repo-age.js';
import './features/quick-mention.js';
import './features/extend-conversation-status-filters.js';
import './features/expand-all-hidden-comments.js';
import './features/bugs-tab.js';
import './features/cross-deleted-pr-branches.js';
import './features/repo-wide-file-finder.js';
import './features/pr-commit-lines-changed.js';
import './features/show-open-prs-of-forks.js';
import './features/deep-reblame.js';
import './features/clear-pr-merge-commit-message.js';
import './features/action-used-by-link.js';
import './features/batch-mark-files-as-viewed.js';
import './features/unwrap-unnecessary-dropdowns.js';
import './features/stop-redirecting-in-notification-bar.js';
import './features/prevent-link-loss.js';
import './features/closing-remarks.js';
import './features/show-associated-branch-prs-on-fork.js';
import './features/unclip-checks.js';
import './features/quick-review.js';
import './features/pr-jump-to-first-non-viewed-file.js';
import './features/keyboard-navigation.js';
import './features/vertical-front-matter.js';
import './features/pr-first-commit-title.js';
import './features/linkify-user-edit-history-popup.js';
import './features/clean-repo-filelist-actions.js';
import './features/prevent-duplicate-pr-submission.js';
import './features/quick-label-removal.js';
import './features/clean-conversation-headers.js';
import './features/new-or-deleted-file.js';
import './features/convert-release-to-draft.js';
import './features/new-repo-disable-projects-and-wikis.js';
import './features/table-input.js';
import './features/link-to-github-io.js';
import './features/github-actions-indicators.js';
import './features/unfinished-comments.js';
import './features/jump-to-change-requested-comment.js';
import './features/esc-to-cancel.js';
import './features/easy-toggle-files.js';
import './features/quick-repo-deletion.js';
import './features/clean-repo-sidebar.js';
import './features/rgh-feature-descriptions.js';
import './features/archive-forks-link.js';
import './features/link-to-changelog-file.js';
import './features/rgh-linkify-features.js';
import './features/conversation-activity-filter.js';
import './features/select-all-notifications-shortcut.js';
import './features/no-duplicate-list-update-time.js';
import './features/view-last-pr-deployment.js';
import './features/avoid-accidental-submissions.js';
import './features/quick-review-comment-deletion.js';
import './features/no-unnecessary-split-diff-view.js';
import './features/list-prs-for-branch.js';
import './features/select-notifications.js';
import './features/clean-repo-tabs.js';
import './features/rgh-options-link.js';
import './features/same-branch-author-commits.js';
import './features/prevent-pr-merge-panel-opening.js';
import './features/rgh-improve-new-issue-form.js';
import './features/easy-toggle-commit-messages.js';
import './features/command-palette-navigation-shortcuts.js';
import './features/link-to-compare-diff.js';
import './features/hide-low-quality-comments.js';
import './features/linkify-user-labels.js';
import './features/repo-avatars.js';
import './features/jump-to-conversation-close-event.js';
import './features/last-notification-page-button.js';
import './features/rgh-linkify-yolo.js';
import './features/quick-new-issue.js';
import './features/scrollable-areas.js';
import './features/emphasize-draft-pr-label.js';
import './features/file-age-color.js';
import './features/netiquette.js';
import './features/rgh-netiquette.js';
import './features/small-user-avatars.js';
import './features/releases-dropdown.js';
import './features/pr-base-commit.js';
import './features/unreleased-commits.js';
import './features/previous-version.js';
import './features/status-subscription.js';
import './features/action-pr-link.js';
import './features/rgh-dim-commits.js';
import './features/repo-header-info.js';
import './features/rgh-pr-template.js';
import './features/close-as-unplanned.js';
import './features/locked-issue.js';
import './features/visit-tag.js';
import './features/prevent-comment-loss.js';
import './features/fix-no-pr-search.js';
import './features/clean-readme-url.js';
import './features/pr-notification-link.js';
import './features/click-outside-modal.js';
import './features/comment-excess.js';
import './features/linkify-line-numbers.js';
import './features/sidebar-focus-file.js';
import './features/rgh-token-user.js';
import './features/unread-anywhere.js';
import './features/no-modals.js';
import './features/same-page-links.js';
import './features/linkify-text.js';
import './features/actions-run-removal.js';
import './features/new-milestone-button.js';
import './features/no-self-reference.js';



================================================
FILE: source/welcome.html
================================================
<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="color-scheme" content="light dark">
<base target="_blank">
<link rel="shortcut icon" href="icon.png">
<title>Refined GitHub</title>
<style>
	html {
		font-family: system-ui, sans-serif;
		font-size: 75%;
		background-color: light-dark(#fff, #0d1116);
	}
	body {
		margin: 0;
	}
</style>
<script type="module" src="header.js"></script>
<script type="module" src="welcome.js"></script>

<rgh-welcome></rgh-welcome>



================================================
FILE: source/welcome.svelte
================================================
<svelte:options customElement="rgh-welcome" />

<!-- prettier-ignore -->
<script lang="ts">
	import {onMount} from 'svelte';
	import 'webext-bugs/target-blank';

	import optionsStorage from './options-storage.js';
	import {hasValidGitHubComToken} from './github-helpers/github-token.js';

	let stepVisible = $state(1);
	let stepValid = $state(0);
	let tokenInput = $state('');
	let tokenError = $state('');

	$effect(() => {
		if (stepValid === 1) {
			setTimeout(showThirdStep, 2000);
		} else if (stepValid === 3) {
			setTimeout(() => {
				location.replace('https://github.com/refined-github/refined-github/wiki');
			}, 2000);
		}
	});

	$effect(() => {
		if (tokenInput) {
			verifyToken();

			// @ts-expect-error TS and its index signatures...
			optionsStorage.set({personalToken: tokenInput});
		}
	});

	const origins = ['https://github.com/*', 'https://gist.github.com/*'];

	async function grantPermissions() {
		const granted = await chrome.permissions.request({origins});
		if (granted) {
			stepVisible = 2;
			stepValid = 1;
		}
	}

	function showThirdStep() {
		stepVisible = 3;
	}

	function markSecondStep() {
		setTimeout(() => {
			stepValid = 2;
			stepVisible = 3;
		}, 1000);
	}

	async function verifyToken() {
		if (await hasValidGitHubComToken(tokenInput)) {
			stepValid = 3;
			tokenError = '';
		} else {
			tokenError = 'Invalid token';
		}
	}

	onMount(async () => {
		if (await chrome.permissions.contains({origins})) {
			stepValid = 1;
			setTimeout(() => {
				stepVisible = 2;
			}, 500);
		}
	});
</script>

<main class:dimmed={stepValid === 3}>
	<rgh-header title="Welcome to Refined GitHub"></rgh-header>

	<div class="content">
		<ul>
			<li
				class:valid={stepValid >= 1}
				class:visible={stepVisible >= 1}
				class="will-show"
			>
				{#if stepValid === 0}
					<button onclick={grantPermissions}> Grant </button>
				{:else}
					Grant
				{/if}
				the extension access to github.com
			</li>

			<!-- svelte-ignore a11y_no_noninteractive_element_interactions -->
			<!-- svelte-ignore a11y_click_events_have_key_events -->
			<li
				class:valid={stepValid >= 2}
				class:visible={stepVisible >= 2}
				class="will-show"
				onclick={showThirdStep}
			>
				<!-- Keep this URL in sync with options.html -->
				<a
					href="https://github.com/settings/tokens/new?description=Refined%20GitHub&scopes=repo,read:project,workflow&default_expires_at=none"
					onclick={markSecondStep}
				>
					Generate a token
				</a>
				to ensure that every feature works correctly.
				<a
					href="https://github.com/refined-github/refined-github/wiki/Security"
				>
					More info
				</a>
			</li>

			<li
				class:valid={stepValid >= 3}
				class:visible={stepVisible >= 3}
				class="will-show"
			>
				<label for="token-input">Paste token:</label>
				<input
					id="token-input"
					type="text"
					size="10"
					autocomplete="off"
					name="personalToken"
					bind:value={tokenInput}
				/>
				{#if tokenError}
					<span class="error">{tokenError}</span>
				{/if}
			</li>
		</ul>
	</div>

	<footer>
		<h2 class:visible={stepValid === 3} class="will-show">
			Setup complete, redirecting to
			<a
				class="hidden-link"
				href="https://github.com/refined-github/refined-github/wiki"
				target="_self">GitHub</a
			>â€¦
		</h2>
	</footer>
</main>

<style>
	:host {
		font-size: 2em;
		display: grid;

		--content-width: 60rem;
		--viewport-margin: 30px;
	}

	:host * {
		box-sizing: border-box;
	}

	main {
		transition: opacity 1s;
		margin-bottom: 2em;
	}

	footer {
		margin-top: 50px;
	}

	h2 {
		font-size: clamp(1.2em, 4vw, 1.5em);
		padding-inline: var(--viewport-margin);
		max-width: var(--content-width);
		font-weight: 200;
		margin: auto;
	}

	.content {
		padding-inline: var(--viewport-margin);
	}

	ul {
		list-style: none;
		margin: 30px auto;
		max-width: var(--content-width);
		padding: var(--viewport-margin) 0;
	}

	a,
	button {
		all: initial;
		font: inherit;
		text-decoration: underline;
		color: cornflowerblue;
		cursor: pointer;
	}

	.hidden-link {
		color: inherit;
	}

	li {
		margin-block: 1em;
		padding-left: 1.8em;
	}

	input {
		background: light-dark(#f6f8fa, #151b23);
		border: solid 1px light-dark(#d0d9e0, #3d444d);
		border-radius: 6px;
		padding: 5px 12px;
		font-size: inherit;
		line-height: 20px;
		margin-left: 0.5em;
	}

	input:focus {
		background: light-dark(#fff, #0d1117);
		border-color: #1f6feb;
		box-shadow: inset 0 0 0 1px #1f6feb;
		outline: none;
	}

	li::before {
		content: '';
		display: inline-block;
		width: 1em;
		height: 1em;
		vertical-align: -0.2em;
		margin-right: 0.8em;
		margin-left: -1.8em; /* Pull out */
		background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" fill="gray" d="M8 5.5a2.5 2.5 0 100 5 2.5 2.5 0 000-5zM4 8a4 4 0 118 0 4 4 0 01-8 0z"></path></svg>');
		background-size: contain;
	}

	li.valid::before {
		background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" fill="%2328a745" d="M8 16A8 8 0 108 0a8 8 0 000 16zm3.78-9.72a.75.75 0 00-1.06-1.06L6.75 9.19 5.28 7.72a.75.75 0 00-1.06 1.06l2 2a.75.75 0 001.06 0l4.5-4.5z"></path></svg>');
	}

	.will-show {
		animation: fade-in 0.5s;
		animation-play-state: paused;
	}

	.will-show.visible {
		animation-play-state: running;
	}

	.dimmed {
		opacity: 40%;
	}

	.error {
		color: #cf222e;
		font-size: 0.8em;
	}

	@keyframes fade-in {
		from {
			opacity: 0%;
		}
	}
</style>



================================================
FILE: source/features/action-pr-link.tsx
================================================
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';
import {getConversationNumber} from '../github-helpers/index.js';

function setSearchParameter(anchorElement: HTMLAnchorElement, name: string, value: string): void {
	const parameters = new URLSearchParams(anchorElement.search);
	parameters.set(name, value);
	anchorElement.search = String(parameters);
}

async function addForRepositoryActions(prLink: HTMLAnchorElement): Promise<void> {
	const prNumber = prLink.textContent.slice(1);

	const runLink = prLink.closest('.Box-row')!.querySelector('a:has(.Link--primary)')!;
	setSearchParameter(runLink, 'pr', prNumber);
}

async function addForPR(actionLink: HTMLAnchorElement): Promise<void> {
	setSearchParameter(actionLink, 'pr', String(getConversationNumber()));
}

async function initForRepositoryActionsPage(signal: AbortSignal): Promise<void> {
	observe('div.Box-row[id^=check_suite_] a[data-hovercard-type="pull_request"]', addForRepositoryActions, {signal});
}

async function initForPRPage(signal: AbortSignal): Promise<void> {
	// Exclude rgh-link, include isPRCommits
	observe([
		'main [href="/apps/github-actions"] ~ div a.status-actions', // Legacy
		'[data-testid="check-run-item"] a[href*="/actions/runs/"]', // React component on isPRCommits
	], addForPR, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isRepositoryActions,
	],
	init: initForRepositoryActionsPage,
}, {
	include: [
		pageDetect.isPR,
	],
	init: initForPRPage,
});

/*

## Test URLs

https://github.com/refined-github/refined-github/actions

https://github.com/refined-github/refined-github/pull/6794

https://github.com/refined-github/refined-github/pull/6794/commits

*/



================================================
FILE: source/features/action-used-by-link.tsx
================================================
import React from 'dom-chef';
import {$} from 'select-dom/strict.js';
import SearchIcon from 'octicons-plain-react/Search';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';

function getActionURL(side: HTMLElement): URL {
	const actionRepo = $('a:has(.octicon-repo)', side)
		.pathname
		.slice(1);

	const actionURL = new URL('search', location.origin);
	actionURL.search = new URLSearchParams({
		q: `${actionRepo} path:.github/workflows/ language:YAML`,
		type: 'Code',
		s: 'indexed',
		o: 'desc',
	}).toString();

	return actionURL;
}

function addUsageLink(side: HTMLElement): void {
	const actionURL = getActionURL(side);

	// TODO: Integrate style better https://github.com/refined-github/refined-github/pull/8285/files#r1951911960
	side.after(
		<a href={actionURL.href} className="d-block mb-2">
			<SearchIcon width={14} className="color-fg-default mr-2" />Usage examples
		</a>,
	);
}

function init(signal: AbortSignal): void {
	observe('[data-testid="resources"] > ul', addUsageLink, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isMarketplaceAction,
	],
	init,
});

/*

Test URLs:

https://github.com/marketplace/actions/title-replacer

*/



================================================
FILE: source/features/actionable-pr-view-file.tsx
================================================
import {elementExists} from 'select-dom';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import {getBranches} from '../github-helpers/pr-branches.js';
import observe from '../helpers/selector-observer.js';
import {deletedHeadRepository} from '../github-helpers/selectors.js';

/** Rebuilds the "View file" link because it points to the base repo and to the commit, instead of the head repo and its branch */
function alter(viewFileLink: HTMLAnchorElement): void {
	const {nameWithOwner, branch} = getBranches().head;
	const filePath = viewFileLink.closest('[data-path]')!.getAttribute('data-path')!;

	// Do not replace with `GitHubFileURL` #3152 #3111 #2595
	viewFileLink.pathname = [nameWithOwner, 'blob', branch, filePath].join('/');
}

function init(signal: AbortSignal): void {
	observe('.file-header:not([data-file-deleted="true"]) a.dropdown-item[data-ga-click^="View file"]', alter, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isPRFiles,
	],
	exclude: [
		// Editing files doesn't make sense after a PR is closed/merged
		pageDetect.isClosedConversation,
		() => elementExists(deletedHeadRepository),
		// If you're viewing changes from partial commits, ensure you're on the latest one.
		() => elementExists('.js-commits-filtered') && !elementExists('[aria-label="You are viewing the latest commit"]'),
	],
	awaitDomReady: true, // DOM-based filters, feature is invisible and inactive until dropdown is opened
	init,
});

/*

Test URLs

- PR: https://github.com/refined-github/sandbox/pull/4/files
- deleted head repository: https://github.com/refined-github/refined-github/pull/271

*/



================================================
FILE: source/features/actions-run-removal.css
================================================
/* Use dedicated class because there's no native class to have a "muted" button turn red */
.rgh-actions-run-removal:is(:hover, :focus) {
	color: var(--fgColor-danger, fuchsia) !important;
}



================================================
FILE: source/features/actions-run-removal.tsx
================================================
import './actions-run-removal.css';

import React from 'dom-chef';
import TrashIcon from 'octicons-plain-react/Trash';
import SquareCircleIcon from 'octicons-plain-react/SquareCircle';
import * as pageDetect from 'github-url-detection';
import {$, $optional} from 'select-dom/strict.js';

import observe from '../helpers/selector-observer.js';
import features from '../feature-manager.js';

function addQuickButtons(contextMenuIcon: HTMLElement): void {
	const contextMenuDetails = contextMenuIcon.closest('details')!;

	// eslint-disable-next-line @typescript-eslint/no-unnecessary-type-arguments -- Wrong
	const menuItem = $optional<HTMLElement>([
		'form[action$="/cancel"]',
		'li:has(> button[data-show-dialog-id^="delete-workflow-run"])',
	], contextMenuDetails)?.cloneNode(true);

	if (!menuItem) {
		// No access to this repo
		return;
	}

	const button = $('button', menuItem);
	button.ariaLabel = button.textContent.trim();
	button.replaceChildren(menuItem.tagName === 'FORM' ? <SquareCircleIcon /> : <TrashIcon />);
	button.classList = 'timeline-comment-action color-fg-muted btn-link rgh-actions-run-removal p-1';
	$('summary', contextMenuDetails).classList.add('p-1');
	const rightControlsContainer = contextMenuDetails.parentElement!;
	// Prepending so that the cloned dialog opens instead of the one inside the menu, as it is hidden when the menu is closed
	rightControlsContainer.classList.add('d-flex', 'flex-column-reverse', 'mt-n2', 'mb-n2');
	rightControlsContainer.prepend(menuItem);
}

function init(signal: AbortSignal): void {
	observe('#partial-actions-workflow-runs .Box-row details .octicon-kebab-horizontal', addQuickButtons, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isRepositoryActions,
	],
	init,
});

/*

Test URLs

https://github.com/refined-github/refined-github/actions

*/



================================================
FILE: source/features/align-issue-labels.css
================================================
/* TODO: Remove the old styles in 2026 */
html:not([rgh-OFF-align-issue-labels]) .js-issue-row {
	/* Move labels in the Issue/PR list below the title */
	.min-width-0 {
		display: flex;
		flex-wrap: wrap;
	}

	/* Labels */
	.min-width-0 > .lh-default {
		order: 1;
	}

	.min-width-0 .text-small {
		flex-basis: 100%; /* #4949 */
	}

	/* Build status */
	.commit-build-statuses {
		margin-left: 4px;
	}

	/* Issue detailsÂ line */
	.mt-1.text-small.color-fg-muted {
		flex-basis: 100%;
	}

	/* Title */
	.h4 {
		max-width: 100%; /* #1518 */
	}

	.IssueLabel {
		margin-top: 4px;
		font-size: 11px !important;
	}
}



================================================
FILE: source/features/align-issue-labels.tsx
================================================
import './align-issue-labels.css';

import * as pageDetect from 'github-url-detection';
import {$} from 'select-dom/strict.js';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';

// TODO: Drop line in 2026
void features.addCssFeature(import.meta.url);

function alignBadges(badges: HTMLElement): void {
	// Move badges to the last line
	const conversation = badges.closest('li')!;
	$('[class^="MainContent-module__inner"]', conversation).append(badges);
	badges.classList.add('mt-1');
}

function init(signal: AbortSignal): void {
	observe('[class*="trailingBadgesContainer"]:not(:empty)', alignBadges, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isIssueOrPRList,
	],
	init,
});

/*

# Test URLs

https://github.com/pulls
https://github.com/bmish/eslint-doc-generator/pulls
https://github.com/bmish/eslint-doc-generator/issues
https://github.com/bmish/eslint-doc-generator/milestone/1?closed=1
https://github.com/nrwl/nx/issues

*/



================================================
FILE: source/features/archive-forks-link.tsx
================================================
import React from 'dom-chef';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';
import {buildRepoURL} from '../github-helpers/index.js';

function addLinkToBanner(banner: HTMLElement): void {
	if (banner.lastChild!.textContent.includes('repository has been archived')) {
		banner.lastChild!.after(
			' You can check out ',
			<a href={buildRepoURL('forks')}>its forks</a>,
			'.',
		);
	}
}

function init(signal: AbortSignal): void {
	observe('#js-repo-pjax-container > .flash-warn:first-of-type', addLinkToBanner, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isRepo,
	],
	init,
});

/*
Test URLs:

https://github.com/probot/template/blob/master/CODE_OF_CONDUCT.md?rgh-link-date=2022-10-12T08%3A11%3A41Z
*/



================================================
FILE: source/features/avoid-accidental-submissions.tsx
================================================
import React from 'dom-chef';
import {elementExists} from 'select-dom';
import * as pageDetect from 'github-url-detection';
import delegate, {type DelegateEvent} from 'delegate-it';

import features from '../feature-manager.js';
import {modKey as moduleKey} from '../github-helpers/hotkey.js';

function onKeyDown(event: DelegateEvent<KeyboardEvent, HTMLInputElement>): void {
	const field = event.delegateTarget;
	const form = field.form!;
	if (
		event.key !== 'Enter'
		|| event.ctrlKey
		|| event.metaKey
		|| event.isComposing // #4323
		|| elementExists([
			'.suggester', // GitHubâ€™s autocomplete dropdown
			'.rgh-avoid-accidental-submissions',
		], form)
	) {
		return;
	}

	if (elementExists('.btn-primary[type="submit"]:disabled', form)) {
		return;
	}

	const spacingClasses = pageDetect.isNewFile() || pageDetect.isEditingFile() ? 'my-1' : 'mt-2 mb-n1';

	const message = (
		<p className={'rgh-avoid-accidental-submissions ' + spacingClasses}>
			A submission via <kbd>enter</kbd> has been prevented. You can press <kbd>enter</kbd> again or use <kbd>{moduleKey}</kbd><kbd>enter</kbd>.
		</p>
	);
	if (pageDetect.isNewFile() || pageDetect.isEditingFile() || pageDetect.isPRConversation()) {
		field.after(message);
	} else {
		field.parentElement!.append(message);
	}

	event.preventDefault();
}

const inputElements = [
	'form.new_issue input#issue_title',
	'input#pull_request_title',
	'input#commit-summary-input',
	'#merge_title_field',
];

function init(signal: AbortSignal): void {
	delegate(inputElements, 'keydown', onKeyDown, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isNewIssue,
		pageDetect.isNewFile,
		pageDetect.isCompare,
		pageDetect.isEditingFile,
		pageDetect.isPRConversation,
	],
	init,
});

/*

Test URLs:

isNewIssue: https://github.com/refined-github/sandbox/issues/new
isNewFile: https://github.com/refined-github/sandbox/new/default-a
isCompare: https://github.com/refined-github/sandbox/compare/default-a...quick-pr-branch
isEditingFile: https://github.com/refined-github/sandbox/edit/default-a/README.md
isPRConversation: https://github.com/refined-github/sandbox/pull/4

*/



================================================
FILE: source/features/batch-mark-files-as-viewed.tsx
================================================
import {$$} from 'select-dom';
import {$} from 'select-dom/strict.js';
import {onAbort} from 'abort-utils';
import * as pageDetect from 'github-url-detection';
import debounceFn from 'debounce-fn';
import delegate, {type DelegateEvent} from 'delegate-it';

import features from '../feature-manager.js';
import clickAll from '../helpers/click-all.js';
import showToast from '../github-helpers/toast.js';
import getItemsBetween from '../helpers/get-items-between.js';

let previousFile: HTMLElement | undefined;
let runningBatch = false;

function remember(event: DelegateEvent): void {
	// Only remember if the user clicked it. `isTrusted` doesn't work because `remember` is called on a fake `submit` event
	if (!runningBatch) {
		previousFile = event.delegateTarget.closest('.js-file')!;
	}
}

function isChecked(file: HTMLElement): boolean {
	return $('input.js-reviewed-checkbox', file).checked;
}

// A single click is somehow causing two separate trusted `click` events, so it needs to be debounced
const batchToggle = debounceFn((event: DelegateEvent<MouseEvent, HTMLFormElement>): void => {
	if (!event.shiftKey) {
		return;
	}

	event.stopImmediatePropagation();

	const files = $$('.js-file');
	const thisFile = event.delegateTarget.closest('.js-file')!;
	const isThisBeingFileChecked = !isChecked(thisFile); // Flip it because the value hasn't changed yet

	runningBatch = true;
	const selectedFiles = getItemsBetween(files, previousFile, thisFile);
	for (const file of selectedFiles) {
		if (
			file !== thisFile
			// `checkVisibility` excludes filtered-out files
			// https://github.com/refined-github/refined-github/issues/7819
			&& file.checkVisibility()
			&& isChecked(file) !== isThisBeingFileChecked
		) {
			$('.js-reviewed-checkbox', file).click();
		}
	}

	runningBatch = false;
}, {
	before: true,
	after: false,
});

function markAsViewedSelector(target: HTMLElement): string {
	const checked = isChecked(target) ? ':not([checked])' : '[checked]';
	// The `hidden` attribute excludes filtered-out files
	// https://github.com/refined-github/refined-github/issues/7819
	return '.file:not([hidden]) .js-reviewed-checkbox' + checked;
}

const markAsViewed = clickAll(markAsViewedSelector);

// A single click is somehow causing two separate trusted `click` events, so it needs to be debounced
const onAltClick = debounceFn((event: DelegateEvent<MouseEvent, HTMLInputElement>): void => {
	if (!event.altKey || !event.isTrusted) {
		return;
	}

	const newState = isChecked(event.delegateTarget) ? 'unviewed' : 'viewed';
	void showToast(async () => {
		markAsViewed(event);
	}, {
		message: `Marking visible files as ${newState}`,
		doneMessage: `Files marked as ${newState}`,
	});
}, {
	before: true,
	after: false,
});

function avoidSelectionOnShiftClick(event: MouseEvent): void {
	if (event.shiftKey) {
		event.preventDefault();
	}
}

function init(signal: AbortSignal): void {
	delegate('.js-reviewed-toggle', 'click', onAltClick, {signal});
	delegate('.js-reviewed-toggle', 'click', batchToggle, {signal});
	delegate('.js-reviewed-toggle', 'mousedown', avoidSelectionOnShiftClick, {signal});
	delegate('.js-toggle-user-reviewed-file-form', 'submit', remember, {signal});
	onAbort(signal, () => {
		previousFile = undefined;
	});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isPRFiles,
	],
	init,
});

/*

Test URLs:

https://github.com/refined-github/sandbox/pull/55/files

Use this style to avoid layout shift while testing:

```css
table {display: none !important;}
```

*/



================================================
FILE: source/features/bugs-tab.gql
================================================
query CountBugs($owner: String!, $name: String!) {
	repository(owner: $owner, name: $name) {
		labels(query: "bug", first: 10) {
			nodes {
				name
				issues(states: OPEN) {
					totalCount
				}
			}
		}
		issues(filterBy: { type: "Bug", states: OPEN }) {
			totalCount
		}
	}
}



================================================
FILE: source/features/bugs-tab.tsx
================================================
import React from 'dom-chef';
import {CachedFunction} from 'webext-storage-cache';
import {$} from 'select-dom/strict.js';
import {elementExists} from 'select-dom';
import BugIcon from 'octicons-plain-react/Bug';
import elementReady from 'element-ready';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import api from '../github-helpers/api.js';
import {cacheByRepo, triggerRepoNavOverflow} from '../github-helpers/index.js';
import SearchQuery from '../github-helpers/search-query.js';
import abbreviateNumber from '../helpers/abbreviate-number.js';
import {highlightTab, unhighlightTab} from '../helpers/dom-utils.js';
import isBugLabel from '../github-helpers/bugs-label.js';
import CountBugs from './bugs-tab.gql';
import {expectToken} from '../github-helpers/github-token.js';

type ApiResponse = {
	issues?: {
		totalCount?: number;
	};
	labels?: {
		nodes?: Array<{
			name: string;
			issues: {
				totalCount?: number;
			};
		}>;
	};
};

type Bugs = {
	label: string;
	count: number;
};

async function countBugs(): Promise<Bugs> {
	const {repository} = await api.v4(CountBugs) as {repository: ApiResponse};
	const bugTypeCount = repository?.issues?.totalCount ?? 0;

	let label = repository?.labels?.nodes?.find(label => label.name === 'bug');
	label ??= repository?.labels?.nodes?.find(label => isBugLabel(label.name));

	const bugLabelCount = label?.issues?.totalCount ?? 0;
	const bugCount = Math.max(bugTypeCount, bugLabelCount);

	return {label: label?.name ?? 'bug', count: bugCount};
}

const bugs = new CachedFunction('bugs', {
	updater: countBugs,
	maxAge: {minutes: 30},
	staleWhileRevalidate: {days: 4},
	cacheKey: cacheByRepo,
});

async function getSearchQueryBugLabel(): Promise<string> {
	const {label} = await bugs.getCached() ?? {};
	return `(label:${SearchQuery.escapeValue(label ?? 'bug')} OR type:Bug)`;
}

async function isBugsListing(): Promise<boolean> {
	return SearchQuery.from(location).includes(await getSearchQueryBugLabel());
}

async function addBugsTab(): Promise<void | false> {
	// Query API as early as possible, even if it's not necessary on archived repos
	const bugsPromise = bugs.get();

	// On a label:bug listing:
	// - always show the tab, as soon as possible
	// - update the count later
	// On other pages:
	// - only show the tab if needed
	if (!(await isBugsListing())) {
		const {count} = await bugsPromise;
		if (count === 0) {
			return false;
		}
	}

	const issuesTab = await elementReady('a.UnderlineNav-item[data-hotkey="g i"]', {waitForChildren: false});
	if (!issuesTab) {
		// Issues are disabled
		return false;
	}

	// Copy Issues tab
	const bugsTab = issuesTab.cloneNode(true);
	bugsTab.classList.add('rgh-bugs-tab');
	unhighlightTab(bugsTab);

	// Disable unwanted behavior #3001
	delete bugsTab.dataset.hotkey;
	delete bugsTab.dataset.selectedLinks;
	bugsTab.removeAttribute('id');

	// Update its appearance
	const bugsTabTitle = $('[data-content]', bugsTab);
	bugsTabTitle.dataset.content = 'Bugs';
	bugsTabTitle.textContent = 'Bugs';
	$('.octicon', bugsTab).replaceWith(<BugIcon className="UnderlineNav-octicon d-none d-sm-inline" />);

	// Set temporary counter
	const bugsCounter = $('.Counter', bugsTab);
	bugsCounter.textContent = '0';
	bugsCounter.title = '';

	// Update Bugsâ€™ link
	bugsTab.href = SearchQuery.from(bugsTab).append(await getSearchQueryBugLabel()).href;

	// In case GitHub changes its layout again #4166
	if (issuesTab.parentElement instanceof HTMLLIElement) {
		issuesTab.parentElement.after(<li className="d-inline-flex">{bugsTab}</li>);
	} else {
		issuesTab.after(bugsTab);
	}

	triggerRepoNavOverflow();

	// Update bugs count
	try {
		const {count: bugCount} = await bugsPromise;
		bugsCounter.textContent = abbreviateNumber(bugCount);
		bugsCounter.title = bugCount > 999 ? String(bugCount) : '';
	} catch (error) {
		bugsCounter.remove();
		throw error; // Likely an API call error that will be handled by the init
	}
}

// TODO: Use native highlighting https://github.com/refined-github/refined-github/pull/6909#discussion_r1322607091
function highlightBugsTab(): void {
	// Remove highlighting from "Issues" tab
	unhighlightTab($('.UnderlineNav-item[data-hotkey="g i"]'));
	highlightTab($('.rgh-bugs-tab'));
}

async function removePinnedIssues(): Promise<void> {
	const pinnedIssues = await elementReady('.js-pinned-issues-reorder-container', {waitForChildren: false});
	pinnedIssues?.remove();
}

async function updateBugsTagHighlighting(): Promise<void | false> {
	const {count, label} = await bugs.get();
	if (count === 0) {
		return false;
	}

	if (
		(pageDetect.isRepoTaxonomyIssueOrPRList() && location.href.endsWith('/labels/' + encodeURIComponent(label)))
		|| (pageDetect.isRepoIssueList() && (await isBugsListing()))
	) {
		void removePinnedIssues();
		highlightBugsTab();
		return;
	}

	if (pageDetect.isIssue() && (await elementReady(`#partial-discussion-sidebar .IssueLabel[data-name="${label}"]`))) {
		highlightBugsTab();
		return;
	}

	return false;
}

async function init(): Promise<void | false> {
	await expectToken();

	if (!elementExists('.rgh-bugs-tab')) {
		await addBugsTab();
	}

	await updateBugsTagHighlighting();
}

void features.add(import.meta.url, {
	include: [
		pageDetect.hasRepoHeader,
	],
	init,
});

/*

Test URLs:

"bug" label: https://github.com/refined-github/refined-github/issues
"bug-fix" label: https://github.com/axios/axios/issues
Issues disabled: https://github.com/refined-github/yolo

*/



================================================
FILE: source/features/center-reactions-popup.css
================================================
/* Restore two-line layout */
:root .dropdown-menu-reactions {
	display: grid !important;
	grid-template-rows: 1fr 1fr; /* Keep two lines whether there are 6 or 8 reactions */
	grid-auto-flow: column;

	/* Move the popups */
	/* Align the popups to the border + add 10px to make them overflow a bit */
	/* Button on the top right of comments */
	&.dropdown-menu-w {
		/* Depends on the presence of `quick-comment-edit` */
		translate: 107px -22px;
	}

	&.dropdown-menu-se {
		/* Keep in view on mobile too */
		/* https://github.com/refined-github/refined-github/issues/8605 */
		translate: -28px -62px;
	}

	/* Button on the bottom left of comments */
	&.dropdown-menu-ne {
		translate: -27px 61px;
	}
}

/* React Issue View */
:root div[data-visibility-visible]:has([class*='ReactionsMenuItem-module']) {
	& > ul {
		display: grid !important;
		grid-template-rows: 1fr 1fr; /* Keep two lines whether there are 6 or 8 reactions */
		grid-auto-flow: column;
	}

	/* Reset the width */
	min-width: 0px !important;

	/* Center, but keep in view on mobile too */
	/* https://github.com/refined-github/refined-github/issues/8605 */
	translate: -28px -56px;
}

/*

Test URLs:

- https://github.com/refined-github/sandbox/issues/3
- https://github.com/refined-github/sandbox/pull/4
- https://github.com/refined-github/sandbox/releases
- https://github.com/vitest-dev/vitest/discussions/4631

*/



================================================
FILE: source/features/ci-link.css
================================================
/* The icon appears inside a clickable container, so it must be disabled */
.AppHeader-context-compact-mainItem .rgh-ci-link {
	pointer-events: none;
	margin-left: 0.3em;
}

/* The popup is cut off by the global bar #8495 */
.AppHeader-globalBar-start {
	overflow: visible !important;
}



================================================
FILE: source/features/ci-link.gql
================================================
query GetChecks($owner: String!, $name: String!) {
	repository(owner: $owner, name: $name) {
		defaultBranchRef {
			target {
				... on Commit {
					history(first: 3) {
						nodes {
							oid
							statusCheckRollup {
								state
							}
						}
					}
				}
			}
		}
	}
}



================================================
FILE: source/features/ci-link.tsx
================================================
import './ci-link.css';

import React from 'dom-chef';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import api from '../github-helpers/api.js';
import {buildRepoURL} from '../github-helpers/index.js';
import observe from '../helpers/selector-observer.js';
import getChecks from './ci-link.gql';
import {expectToken} from '../github-helpers/github-token.js';
import {isSmallDevice} from '../helpers/dom-utils.js';

async function getCommitWithChecks(): Promise<string | undefined> {
	const {repository} = await api.v4(getChecks);
	// Check earlier commits just in case the last one is CI-generated and doesn't have checks
	for (const commit of repository.defaultBranchRef.target.history.nodes) {
		if (commit.statusCheckRollup) {
			return commit.oid;
		}
	}

	return undefined;
}

async function add(anchor: HTMLElement): Promise<void> {
	const commit = await getCommitWithChecks();
	if (!commit) {
		return;
	}

	const endpoint = buildRepoURL('commits/checks-statuses-rollups');
	anchor.parentElement!.append(
		// Hide in small viewports, matches `repo-header-info`
		<span className="rgh-ci-link ml-1 d-none d-sm-inline" title="CI status of latest commit">
			<batch-deferred-content hidden data-url={endpoint}>
				<input
					name="oid"
					value={commit}
					data-targets="batch-deferred-content.inputs"
				/>
			</batch-deferred-content>
		</span>,
	);

	// A parent is clipping the popup
	anchor.closest('.AppHeader-context-full')?.style.setProperty('overflow', 'visible');
}

async function init(signal: AbortSignal): Promise<void> {
	await expectToken();

	observe([
		// Desktop
		'.AppHeader-context-item:not([data-hovercard-type])',

		// Mobile. `> *:first-child` avoids finding our own element
		'.AppHeader-context-compact-mainItem > span:first-child',
	], add, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.hasRepoHeader,
	],
	exclude: [
		// Disable the feature entirely on small screens
		isSmallDevice,
	],
	init,
});

/*
Test URLs

CI:
https://github.com/refined-github/refined-github

No CI:
https://github.com/fregante/.github
*/



================================================
FILE: source/features/clean-checks-list.css
================================================
/* Bringing running checks and failed checks to the top of the list */
/* .octicon-check targets "successful" checks */
/* .octicon-x targets "failed" checks */
/* .octicon-skip targets "skipped" checks */
/* .octicon-square-fill targets "neutral" checks */
/* .text-italic targets "running" or "waiting" checks */

/* Required to allow sorting */
/* "updatable" class needed to target checks list only #6468 */
.merge-status-list.js-updatable-content-preserve-scroll-position {
	display: flex;
	flex-direction: column;
}

/* Push running checks below failed checks */
.merge-status-item:has(.text-italic) {
	order: 1;
}

/* Push successful/skipped/neutral checks below running checks */
.merge-status-item:has(.octicon-check, .octicon-skip, .octicon-square-fill) {
	order: 2;
}

/* Dim successful/skipped/neutral checks */
.merge-status-list:has(.octicon-x, .text-italic):not(:hover)
/* Only if any checks are failing or in progress */
.merge-status-item:has(.octicon-check, .octicon-skip, .octicon-square-fill) {
	opacity: 50%;
}

/* Untruncate long check descriptions: https://github.com/hashicorp/consul/commit/38d94282ca0a1ed66d21ebb5c966a97e450d0ae3 */
.merge-status-item .css-truncate {
	white-space: unset !important;
}

/* Top align check symbol */
.merge-status-item .merge-status-icon {
	align-self: flex-start !important;

	& svg {
		height: 20px;
	}
}

/*
Test URLs
https://github.com/refined-github/refined-github/pull/7166
https://github.com/refined-github/refined-github/pull/7166/commits/0219fdddb5325383fed8c7300619b6445f0ae303
https://github.com/refined-github/refined-github/commit/0219fdddb5325383fed8c7300619b6445f0ae303
*/



================================================
FILE: source/features/clean-conversation-filters.gql
================================================
query HasAnyProjects($owner: String!, $name: String!) {
	repository(owner: $owner, name: $name) {
		projects {
			totalCount
		}
		projectsV2 {
			totalCount
		}
	}
	organization(login: $owner) {
		projects {
			totalCount
		}
		projectsV2 {
			totalCount
		}
	}
}



================================================
FILE: source/features/clean-conversation-filters.tsx
================================================
import {CachedFunction} from 'webext-storage-cache';
import {$optional} from 'select-dom/strict.js';
import {elementExists} from 'select-dom';
import elementReady from 'element-ready';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import {cacheByRepo} from '../github-helpers/index.js';
import HasAnyProjects from './clean-conversation-filters.gql';
import api from '../github-helpers/api.js';
import {expectToken, expectTokenScope} from '../github-helpers/github-token.js';
import observe from '../helpers/selector-observer.js';

const hasAnyProjects = new CachedFunction('has-projects', {
	async updater(): Promise<boolean> {
		const activeProjectsCounter = await elementReady('[data-hotkey="g b"] .Counter');
		if (activeProjectsCounter && getCount(activeProjectsCounter) > 0) {
			return true;
		}

		const isOrganization = elementExists('[rel=author][data-hovercard-type="organization"]');
		if (!activeProjectsCounter && !isOrganization) {
			// No tab = Projects disabled in repo
			// No organization = no Projects in organization
			return false;
		}

		await expectTokenScope('read:project');
		const {repository, organization} = await api.v4(HasAnyProjects, {
			allowErrors: true,
		});

		return Boolean(repository.projects.totalCount)
			|| Boolean(repository.projectsV2.totalCount)
			|| Boolean(organization?.projects?.totalCount)
			|| Boolean(organization?.projectsV2?.totalCount);
	},
	maxAge: {days: 1},
	staleWhileRevalidate: {days: 20},
	cacheKey: cacheByRepo,
});

function getCount(element: HTMLElement): number {
	return Number(element.textContent.trim());
}

async function hideProjects(container: HTMLElement): Promise<void> {
	const filter = $optional('[data-testid="projects-anchor-button"]', container);

	// If the filter is missing, then it has been disabled organization-wide already
	if (filter && !(await hasAnyProjects.get())) {
		filter.remove();
	}
}

async function hide(container: HTMLElement): Promise<void> {
	// Keep separate so that one doesn't crash the other
	void hideProjects(container);
}

async function init(signal: AbortSignal): Promise<void> {
	await expectToken();
	observe(String.raw`#\:rs\:-list-view-metadata`, hide, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isRepoIssueOrPRList,
	],
	init,
});

/*

Test URLs:

- No projects: https://github.com/left-pad/left-pad/issues
- Projects and milestones (no-op): https://github.com/tc39/ecma402/issues

*/



================================================
FILE: source/features/clean-conversation-headers.css
================================================
/* TODO: Revert https://github.com/refined-github/refined-github/pull/8111 in April 2025 */
:root .rgh-non-default-branch {
	background-color: var(
		--control-checked-bgColor-hover,
		var(--color-state-hover-primary-bg, var(--color-accent-emphasis, fuchsia))
	);

	&,
	a {
		color: var(
			--control-checked-fgColor-rest,
			var(
				--color-state-hover-primary-text,
				var(--color-fg-on-emphasis, fuchsia)
			)
		);
	}
}

.rgh-clean-conversation-headers {
	/* Removes: every text (but not icons) */
	font-size: 0 !important;

	/* Shows on issues: [octocat] opened this issue on [1 Jan] Â· 1 comments */
	/* Shows on PRs: [octocat] merged 1 commit into [master] from [feature] on [1 Jan] */
	/* Doesn't show on PRs: octocat merged [1] commit into master from feature */
	& > :not(.js-updating-pull-request-commits-count) {
		font-size: 14px;
	}

	/* Shows on PRs: [by ]octocat main â† feature */
	&:not(.rgh-hide-author)::before {
		content: 'by ';
		font-size: 14px;
	}

	.author {
		margin-right: 4px;
	}

	/* Removes on issues: [octocat] opened this issue on 1 Jan Â· 1 comments */
	/* Removes on PRs: [octocat] merged 1 commit into master from feature */
	&.rgh-hide-author {
		.author + .Label /* #5832 */,
		.author,
		a[data-hovercard-type='user'] {
			display: none;
		}
	}

	.commit-ref,
	[class^='BranchName'] {
		font-size: 12px;
	}

	relative-time {
		margin-left: 4px;
	}

	/* Removes on issues: octocat opened this issue on [1 Jan] Â· 1 comments */
	.gh-header.issue & relative-time {
		display: none;
	}

	/* Fixes vertical alignment of base branch dropdown #5598 */
	.commit-ref-dropdown {
		margin-top: -2px !important;
	}
}



================================================
FILE: source/features/clean-conversation-headers.tsx
================================================
import './clean-conversation-headers.css';

import React from 'dom-chef';
import {$, $optional} from 'select-dom/strict.js';
import elementReady from 'element-ready';
import ArrowLeftIcon from 'octicons-plain-react/ArrowLeft';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import getDefaultBranch from '../github-helpers/get-default-branch.js';
import observe from '../helpers/selector-observer.js';
import {expectToken} from '../github-helpers/github-token.js';
import {parseReferenceRaw} from '../github-helpers/pr-branches.js';
import {assertNodeContent} from '../helpers/dom-utils.js';

async function cleanIssueHeader(byline: HTMLElement): Promise<void> {
	byline.classList.add('rgh-clean-conversation-headers', 'rgh-hide-author');

	// Shows on issues: octocat opened this issue on 1 Jan Â· [1 comments]
	// Removes on issues: octocat opened this issue on 1 Jan [Â·] 1 comments
	const commentCount = $('relative-time', byline).nextSibling!;
	commentCount.replaceWith(<span>{commentCount.textContent.replace('Â·', '')}</span>);
}

async function highlightNonDefaultBranchPRs(base: HTMLElement, baseBranch: string): Promise<void> {
	const wasDefaultBranch = pageDetect.isClosedConversation() && baseBranch === 'master';
	const isDefaultBranch = baseBranch === await getDefaultBranch();
	if (!isDefaultBranch && !wasDefaultBranch) {
		base.classList.add('rgh-non-default-branch');
	}
}

async function cleanPrHeader(byline: HTMLElement): Promise<void> {
	byline.classList.add('rgh-clean-conversation-headers');
	byline.parentElement!.closest('.d-flex')!.classList.add('flex-items-center');

	const prCreatorSelector = [
		'.TimelineItem .author',
		'.Timeline-Item [data-testid="author-avatar"] a:not([data-testid="github-avatar"])',
	];

	// Extra author name is only shown on `isPRConversation`
	// Hide if it's the same as the opener (always) or merger
	const shouldHideAuthor
		= pageDetect.isPRConversation()
			&& !byline.closest('.gh-header-sticky') // #7802
			&& $([
				'.author',
				'a[data-hovercard-url]',
			], byline).textContent === (await elementReady(prCreatorSelector))!.textContent;

	if (shouldHideAuthor) {
		byline.classList.add('rgh-hide-author');
	}

	const base = $([
		'.commit-ref',
		'[class^="BranchName"]',
	], byline);

	let baseBranch;
	if (base.title) {
		baseBranch = parseReferenceRaw(base.title, base.textContent).branch;
	} else {
		baseBranch = parseReferenceRaw(base.nextElementSibling!.textContent, base.textContent).branch;
	}

	// Don't await https://github.com/refined-github/refined-github/issues/8331
	void highlightNonDefaultBranchPRs(base, baseBranch);

	// Shows on PRs: main [â†] feature
	const anchor
		= $optional('.commit-ref-dropdown', byline)?.nextSibling // TODO: Drop old PR layout support
			?? base.nextSibling?.nextSibling;
	assertNodeContent(anchor!, 'from');
	anchor!.after(<span><ArrowLeftIcon className="v-align-middle mx-1" /></span>);
}

async function init(signal: AbortSignal): Promise<void> {
	await expectToken();

	const cleanConversationHeader = pageDetect.isIssue() ? cleanIssueHeader : cleanPrHeader;
	observe([
		'.gh-header-meta > .flex-auto', // Real
		'.rgh-conversation-activity-filter', // Helper in case it runs first and breaks the `>` selector, because it wraps the .flex-auto element
		'[class^="StateLabel"] + div > span:first-child',
	], cleanConversationHeader, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isIssue,
		pageDetect.isPR,
	],
	init,
});

/* Test URLs

- Open PR (default branch): https://github.com/refined-github/sandbox/pull/4
- Open PR (non-default branch): https://github.com/Kenshin/simpread/pull/698

- Merged PR (same author): https://github.com/sindresorhus/refined-github/pull/3402
- Merged PR (different author): https://github.com/parcel-bundler/parcel/pull/78
- Merged PR (different author + first published tag): https://github.com/sindresorhus/refined-github/pull/3227

- Closed PR: https://github.com/sindresorhus/refined-github/pull/4141

*/



================================================
FILE: source/features/clean-conversation-sidebar.css
================================================
/* Adjust spacing of empty sections */
.discussion-sidebar-item.rgh-clean-sidebar {
	margin-bottom: -5px;
}

/* Align sidebar to the top */
.rgh-clean-sidebar .discussion-sidebar-item:first-child {
	padding-top: 0 !important;
}

/* Move message under the `Unsubscribe` button above the button */
.rgh-clean-sidebar .thread-subscription-status {
	display: flex;
	flex-direction: column;
}

/* `form` excludes the header */
.rgh-clean-sidebar form.thread-subscribe-form {
	order: 1;
}

.rgh-clean-sidebar .thread-subscription-status .reason {
	margin: 0 0 10px !important;
}



================================================
FILE: source/features/clean-conversation-sidebar.tsx
================================================
import './clean-conversation-sidebar.css';

import React from 'dom-chef';
import {elementExists} from 'select-dom';
import {$, $optional} from 'select-dom/strict.js';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import onElementRemoval from '../helpers/on-element-removal.js';
import observe from '../helpers/selector-observer.js';
import {removeTextNodeContaining} from '../helpers/dom-utils.js';

// Don't cache: https://github.com/refined-github/refined-github/issues/7283
const canEditSidebar = (): boolean => elementExists('.discussion-sidebar-item [data-hotkey="l"]');

function getNodesAfter(node: Node): Range {
	const range = new Range();
	range.selectNodeContents(node.parentElement!);
	range.setStartAfter(node);
	return range;
}

async function cleanReviewers(): Promise<void> {
	const possibleReviewers = $optional('[src$="/suggested-reviewers"]');
	if (possibleReviewers) {
		await onElementRemoval(possibleReviewers);
	}

	const content = $('[aria-label="Select reviewers"] > .css-truncate');
	if (!content.firstElementChild) {
		removeTextNodeContaining(content, 'No reviews');
	}
}

/**
Smartly removes "No content" or the whole section, depending on `canEditSidebar`.

Expected DOM:

```pug
.discussion-sidebar-item
	form (may be missing)
		details or div.discussion-sidebar-heading
		.css-truncate (may be missing)
			"No issues"
```

@param selector Element that contains `details` or `.discussion-sidebar-heading` or distinctive element inside it
*/
function cleanSection(selector: string): boolean {
	const container = $optional(`:is(form, .discussion-sidebar-item):has(${selector})`);
	if (!container) {
		return false;
	}

	const identifiers = [
		'.IssueLabel',
		'[aria-label="Select milestones"] .Progress-item',
		'[aria-label="Link issues"] [data-hovercard-type]',
		'a[href^="https://copilot-workspace.githubnext.com"]',
		'[aria-label="Select projects"] .Link--primary',
	];

	const heading = $([
		'details:has(> .discussion-sidebar-heading)', // Can edit sidebar, has a dropdown
		'.discussion-sidebar-heading', // Cannot editor sidebar, has a plain heading
	], container);
	if (heading.closest(['form', '.discussion-sidebar-item'])!.querySelector(identifiers)) {
		return false;
	}

	const section = container.closest('.discussion-sidebar-item')!;
	if (canEditSidebar()) {
		getNodesAfter(heading).deleteContents();
		section.classList.add('rgh-clean-sidebar');
	} else {
		section.remove();
	}

	return true;
}

async function cleanSidebar(): Promise<void> {
	$('#partial-discussion-sidebar').classList.add('rgh-clean-sidebar');

	// Assignees
	const assignees = $('.js-issue-assignees');
	if (assignees.children.length === 0) {
		assignees.closest('.discussion-sidebar-item')!.remove();
	} else {
		const assignYourself = $optional('.js-issue-assign-self');
		if (assignYourself) {
			removeTextNodeContaining(assignYourself.previousSibling!, 'No oneâ€”');
			$('[aria-label="Select assignees"] summary').append(
				<span style={{fontWeight: 'normal'}}> â€“ {assignYourself}</span>,
			);
			assignees.closest('.discussion-sidebar-item')!.classList.add('rgh-clean-sidebar');
		}
	}

	// Reviewers
	if (pageDetect.isPR()) {
		void cleanReviewers();
	}

	// Labels
	if (!cleanSection('.js-issue-labels') && !canEditSidebar()) {
		// Hide heading in any case except `canEditSidebar`
		$('.discussion-sidebar-item:has(.js-issue-labels) .discussion-sidebar-heading')
			.remove();
	}

	// Development (linked issues/PRs)
	const developmentHint = $optional('[aria-label="Link issues"] > p');
	if (developmentHint) { // This may not exist if issues are disabled
		removeTextNodeContaining(developmentHint, /No branches or pull requests|Successfully merging/);
	}

	const createBranchLink = $optional('button[data-action="click:create-branch#openDialog"]');
	const openWorkspaceButton = $optional('a[href^="https://copilot-workspace.githubnext.com"]');
	if (createBranchLink && !openWorkspaceButton) {
		createBranchLink.classList.add('Link--muted', 'Link--inTextBlock');
		$('[aria-label="Link issues"] summary').append(
			<span style={{fontWeight: 'normal'}}> â€“ {createBranchLink}</span>,
		);
	}

	cleanSection('[aria-label="Link issues"]');

	// Projects
	cleanSection('[aria-label="Select projects"]');

	// Milestones
	cleanSection('[aria-label="Select milestones"]');
}

function init(signal: AbortSignal): void {
	observe('#partial-discussion-sidebar', cleanSidebar, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isConversation,
	],
	awaitDomReady: true, // The sidebar is at the end of the page + it needs to be fully loaded
	init,
});

/*

Test URLs:

* open issue: https://github.com/refined-github/sandbox/issues/15
* open issue with linked PR: https://github.com/refined-github/sandbox/issues/3
* closed issue: https://github.com/refined-github/sandbox/issues/56
* draft PR: https://github.com/refined-github/sandbox/pull/7
* merged PR: https://github.com/refined-github/sandbox/pull/58
* open issue with a milestone and assignee: https://github.com/microsoft/TypeScript/issues/18836
* User has triage access
  * issue: https://github.com/download-directory/download-directory.github.io/issues/39
  * PR: https://github.com/download-directory/download-directory.github.io/pull/37

*/



================================================
FILE: source/features/clean-conversations.css
================================================
/* Remove user avatar from new comment form */
.timeline-new-comment .timeline-comment-avatar,
.review-thread-reply .avatar {
	display: none;
}

.review-thread-reply .review-thread-reply-button {
	margin-left: 0;
}

/* Hide arrow on new comment form */
.timeline-new-comment .timeline-comment--caret::before,
.timeline-new-comment .timeline-comment--caret::after {
	content: none !important;
}

/*

Test URLs:

- Issues: https://github.com/refined-github/sandbox/issues/3
- PRs: https://github.com/refined-github/sandbox/pull/4
- Discussions: https://github.com/vercel/vercel/discussions/3874
- Commits: https://github.com/refined-github/refined-github/commit/82fb3d62f11838ad4120f510bd90520c57bb12da

*/



================================================
FILE: source/features/clean-footer.css
================================================
.footer > .d-flex {
	transition: opacity 0.2s ease;
	margin: auto;
}

.footer > .d-flex:not(:hover) {
	opacity: 30%;
}

/*

Test URL:

https://github.com/refined-github/refined-github

*/



================================================
FILE: source/features/clean-notifications.css
================================================
/* Place conversation number before the title */
.js-notifications-group [id^='notification'] {
	flex-direction: row !important;
}

/* Hide duplicate repository URL */
.js-notifications-group [id^='notification'] > .d-flex > .f6 {
	font-size: 0 !important;
}

/* Size and position the conversation number */
.js-notifications-group [id^='notification'] > .d-flex > .f6 > span {
	display: block;
	font-size: 12px;
	font-variant-numeric: tabular-nums;
	margin-top: 2px; /* Align baseline with conversation title */
	margin-right: 8px;
	word-break: keep-all;
}

/*

Test URLs:

https://github.com/notifications

*/



================================================
FILE: source/features/clean-pinned-issues.css
================================================
html:not([rgh-OFF-clean-pinned-issues]) {
	@media (width >= 700px) {
		ul[aria-label='Drag and drop pinned issues list.'] {
			display: table !important;
			width: 100%;
			margin: 0;

			/* Rounded table border https://stackoverflow.com/a/2586780/288906 */
			box-shadow: 0 0 0 2px var(--rgh-border-color, fuchsia);
			border-collapse: collapse;
			border-radius: 6px;
			border-style: hidden;

			li {
				display: table-row !important;
				border-color: var(--rgh-border-color, fuchsia) !important;
				& > div {
					padding-right: var(--base-size-12, 12px);
				}
			}

			[class^='PinnedIssue-module__titleOptionsContainer'] {
				flex: 1;
			}

			[class^='PinnedIssue-module__contentContainer'] {
				flex-direction: row;
				justify-content: space-between;
				align-items: center;
			}
		}
	}
}



================================================
FILE: source/features/clean-pinned-issues.tsx
================================================
import './clean-pinned-issues.css';

import features from '../feature-manager.js';

void features.addCssFeature(import.meta.url);

/*

Test URLs:

https://github.com/refined-github/sandbox/issues
https://github.com/eslint/eslint/issues

*/



================================================
FILE: source/features/clean-readme-url.tsx
================================================
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';

function maybeCleanUrl(event?: NavigateEvent): void {
	const parsed = new URL(event?.destination.url ?? location.href);
	if (parsed.searchParams.get('tab') === 'readme-ov-file') {
		parsed.searchParams.delete('tab');
		history.replaceState(history.state, '', parsed.href);
	}
}

function init(signal: AbortSignal): void {
	maybeCleanUrl();
	let interval: NodeJS.Timeout;
	if (globalThis.navigation) {
		navigation.addEventListener('navigate', maybeCleanUrl, {signal});
	} else {
		interval = setInterval(() => {
			maybeCleanUrl();
		}, 1000);
		signal.addEventListener('abort', () => {
			clearInterval(interval);
		});
	}
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isRepoHome,
	],
	init,
});

/*

Test URLs:

https://github.com/refined-github/refined-github?tab=readme-ov-file

*/



================================================
FILE: source/features/clean-repo-filelist-actions.css
================================================
.rgh-clean-repo-filelist-actions .TextInput-wrapper {
	/* Override the value that GitHub sets */
	min-width: unset !important;

	input:not(:focus) {
		width: 0;
	}
}



================================================
FILE: source/features/clean-repo-filelist-actions.tsx
================================================
import React from 'dom-chef';
import {$, $optional} from 'select-dom/strict.js';
import * as pageDetect from 'github-url-detection';
import PlusIcon from 'octicons-plain-react/Plus';

import observe from '../helpers/selector-observer.js';
import {assertNodeContent, wrap} from '../helpers/dom-utils.js';
import features from '../feature-manager.js';
import './clean-repo-filelist-actions.css';

/** Add tooltip on a wrapper to avoid breaking dropdown functionality */
function addTooltipToSummary(childElement: Element, tooltip: string): void {
	wrap(
		childElement,
		<div className="tooltipped tooltipped-n" aria-label={tooltip} />,
	);
}

function cleanFilelistActions(addFileButton: Element): void {
	const container = addFileButton.parentElement!.parentElement!;
	const codeButton = $optional('& > button', container);
	container.classList.add('rgh-clean-repo-filelist-actions');

	cleanAddFileButton(addFileButton);

	if (!pageDetect.isRepoRoot() || !codeButton) {
		return;
	}

	cleanCodeButton(codeButton);
}

function cleanAddFileButton(addFileButton: Element): void {
	const fileButtonContent = $('[data-component="buttonContent"] > span', addFileButton);

	assertNodeContent(fileButtonContent, 'Add file')
		.replaceWith(<PlusIcon />);
	addTooltipToSummary(addFileButton, 'Add file');
}

function cleanCodeButton(codeButton: Element): void {
	const codeButtonContent = $('[data-component="text"]', codeButton);
	codeButtonContent.remove();
	addTooltipToSummary(codeButton, 'Clone, open or download');
}

function init(signal: AbortSignal): void {
	observe('.react-directory-remove-file-icon', cleanFilelistActions, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isRepoTree,
		pageDetect.isSingleFile,
	],
	exclude: [
		pageDetect.isRepoFile404,
	],
	init,
});

/*

Test URLs
https://github.com/refined-github/sandbox
https://github.com/refined-github/sandbox/tree/branch/with/slashes

*/



================================================
FILE: source/features/clean-repo-sidebar.css
================================================
[rgh-clean-repo-sidebar] {
	/* Hide "About" header */
	.Layout-sidebar .BorderGrid-row:first-child h2 {
		display: none;
	}

	/* Hide "Packages" if empty */
	.BorderGrid-row:has(a[href*='/packages?repo_name'] .Counter[title='0']) {
		display: none;
	}

	/* Align the top of the repo root sidebar with the main page content */
	.Layout-sidebar .BorderGrid-row:first-child h2 + p.f4 {
		margin-top: 0 !important;
	}

	@media (width >= 768px) {
		/* Hide "Releases" header */
		.Layout-sidebar h2 [href$='/releases'] {
			display: none;
		}

		/* Align data section with latest tag/release link #5428 */
		.Layout-sidebar .Link--muted .octicon {
			margin-right: 4px !important;
		}
	}

	/*
	* Hide "+ 65 releases" link
	* Hide "Learn more about GitHub Sponsors" link
	* Hide "+ 123 contributors" link
	* Don't hide "Create new release" link #8442
	*/
	.Layout-sidebar .BorderGrid-cell
		> .mt-3:not(:has(> a[href$='releases/new'])) {
		display: none;
	}

	/* Hide Code of conduct links */
	.Layout-sidebar .Link--muted {
		[href$='/code-of-conduct.md' i],
		[href$='/code_of_conduct.md' i] {
			display: none;
		}
	}
}



================================================
FILE: source/features/clean-repo-sidebar.tsx
================================================
import './clean-repo-sidebar.css';
import {elementExists} from 'select-dom';
import {$, $optional} from 'select-dom/strict.js';
import domLoaded from 'dom-loaded';
import elementReady from 'element-ready';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import {buildRepoURL} from '../github-helpers/index.js';

// The h2 is to avoid hiding website links that include '/releases' #4424
// TODO: It's broken
const releasesSidebarSelector = '.Layout-sidebar .BorderGrid-cell h2 a[href$="/releases"]';
async function cleanReleases(): Promise<void> {
	const sidebarReleases = await elementReady(releasesSidebarSelector, {waitForChildren: false});
	if (!sidebarReleases) {
		return;
	}

	const releasesSection = sidebarReleases.closest('.BorderGrid-cell')!;
	if (!elementExists('.octicon-tag', releasesSection)) {
		// Hide the whole section if there's no releases
		releasesSection.hidden = true;
		return;
	}

	// Collapse "Releases" section into previous section
	releasesSection.classList.add('border-0', 'pt-md-0');
	sidebarReleases.closest('.BorderGrid-row')!
		.previousElementSibling! // Aboutâ€™s .BorderGrid-row
		.firstElementChild! // Aboutâ€™s .BorderGrid-cell
		.classList
		.add('border-0', 'pb-0');

	// Point to releases page; the user sees the same content, but there's more below
	$optional('a.Link--primary[href*="/releases/tag/"]', releasesSection)
		// The link is missing on tagged-but-no-releases repos
		?.setAttribute('href', buildRepoURL('releases'));
}

async function hideLanguageHeader(): Promise<void> {
	await domLoaded;

	const lastSidebarHeader = $optional('.Layout-sidebar .BorderGrid-row:last-of-type h2');
	if (lastSidebarHeader?.textContent === 'Languages') {
		lastSidebarHeader.hidden = true;
	}
}

// Hide empty meta if itâ€™s not editable by the current user
async function hideEmptyMeta(): Promise<void> {
	await domLoaded;

	if (!pageDetect.canUserAdminRepo()) {
		$optional('.Layout-sidebar .BorderGrid-cell > .text-italic')?.remove();
	}
}

async function moveReportLink(): Promise<void> {
	await domLoaded;

	const reportLink = $optional('.Layout-sidebar a[href^="/contact/report-content"]')?.parentElement;
	if (reportLink) {
		// Your own repos don't include this link
		$('.Layout-sidebar .BorderGrid-row:last-of-type .BorderGrid-cell').append(reportLink);
	}
}

async function init(): Promise<void> {
	document.documentElement.setAttribute('rgh-clean-repo-sidebar', '');
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isRepoRoot,
	],
	deduplicate: 'has-rgh-inner',
	init: [
		init,
		cleanReleases,
		hideLanguageHeader,
		hideEmptyMeta,
		moveReportLink,
	],
});

/*

Test URLs:

- https://github.com/refined-github/refined-github
- Repo with empty packages section: https://github.com/isaacs/node-glob
- Repo with 1 package: https://github.com/recyclarr/recyclarr
- Repo with tags but not releases: https://github.com/fregante/bin-dir
- Repo with no tags: https://github.com/refined-github/yolo

*/



================================================
FILE: source/features/clean-repo-tabs.tsx
================================================
import {CachedFunction} from 'webext-storage-cache';
import {countElements} from 'select-dom';
import {$, $optional} from 'select-dom/strict.js';
import elementReady from 'element-ready';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import fetchDom from '../helpers/fetch-dom.js';
import api from '../github-helpers/api.js';
import getTabCount from '../github-helpers/get-tab-count.js';
import looseParseInt from '../helpers/loose-parse-int.js';
import abbreviateNumber from '../helpers/abbreviate-number.js';
import {buildRepoURL, cacheByRepo, getRepo} from '../github-helpers/index.js';
import {unhideOverflowDropdown} from './more-dropdown-links.js';

async function canUserEditOrganization(): Promise<boolean> {
	return Boolean(await elementReady('.btn-primary[href$="repositories/new"]'));
}

function mustKeepTab(tab: HTMLElement): boolean {
	return (
		// User is on tab ğŸ‘€
		tab.matches('.selected')
		// Repo owners should see the tab. If they don't need it, they should disable the feature altogether
		|| pageDetect.canUserAdminRepo()
	);
}

function setTabCounter(tab: HTMLElement, count: number): void {
	const tabCounter = $('.Counter', tab);
	tabCounter.textContent = abbreviateNumber(count);
	tabCounter.title = count > 999 ? String(count) : '';
}

function onlyShowInDropdown(id: string): void {
	// TODO: Use selector observer
	const tabItem = $optional(`li:not([hidden]) > [data-tab-item$="${id}"]`);
	if (!tabItem) { // #3962 #7140
		return;
	}

	tabItem.closest('li')!.hidden = true;

	const menuItem = $(`[data-menu-item$="${id}"]`);
	menuItem.removeAttribute('data-menu-item');
	menuItem.hidden = false;
	// The item has to be moved somewhere else because the overflow nav is order-dependent
	$('.UnderlineNav-actions ul').append(menuItem);
}

const wikiPageCount = new CachedFunction('wiki-page-count', {
	async updater(): Promise<number> {
		const dom = await fetchDom(buildRepoURL('wiki'));
		const counter = dom.querySelector('#wiki-pages-box .Counter');

		if (counter) {
			return looseParseInt(counter);
		}

		return countElements('#wiki-content > .Box .Box-row', dom);
	},
	maxAge: {hours: 1},
	staleWhileRevalidate: {days: 5},
	cacheKey: cacheByRepo,
});

const hasActionRuns = new CachedFunction('workflows-count', {
	async updater(repoWithOwner: string): Promise<boolean> {
		return api.v3hasAnyItems(`/repos/${repoWithOwner}/actions/runs`);
	},
	maxAge: {days: 1},
	staleWhileRevalidate: {days: 10},
});

async function updateWikiTab(): Promise<void | false> {
	const wikiTab = await elementReady('[data-hotkey="g w"]');
	if (!wikiTab || mustKeepTab(wikiTab)) {
		return false;
	}

	const count = await wikiPageCount.get();
	if (count > 0) {
		setTabCounter(wikiTab, count);
	} else {
		onlyShowInDropdown('wiki-tab');
	}
}

async function updateActionsTab(): Promise<void | false> {
	const actionsTab = await elementReady('[data-hotkey="g a"]');
	if (!actionsTab || mustKeepTab(actionsTab) || await hasActionRuns.get(getRepo()!.nameWithOwner)) {
		return false;
	}

	onlyShowInDropdown('actions-tab');
}

async function updateProjectsTab(): Promise<void | false> {
	const projectsTab = await elementReady('[data-hotkey="g b"]');
	if (!projectsTab || mustKeepTab(projectsTab) || await getTabCount(projectsTab) > 0) {
		return false;
	}

	if (pageDetect.isRepo()) {
		onlyShowInDropdown('projects-tab');
		return;
	}

	if (await canUserEditOrganization()) {
		// Leave Project tab visible to those who can create a new project
		return;
	}

	projectsTab.remove();
}

async function moveRareTabs(): Promise<void | false> {
	// The user may have disabled `more-dropdown-links` so un-hide it
	if (!await unhideOverflowDropdown()) {
		return false;
	}

	// Wait for the nav dropdown to be loaded #5244
	await elementReady('.UnderlineNav-actions ul');

	// Only hide security tab if there are no vulnerability alerts #8457
	const securityTab = $optional('[data-tab-item$="security-tab"]');
	if (securityTab && !mustKeepTab(securityTab) && await getTabCount(securityTab) === 0) {
		onlyShowInDropdown('security-tab');
	}

	onlyShowInDropdown('insights-tab');
}

void features.add(import.meta.url, {
	include: [
		pageDetect.hasRepoHeader,
	],
	deduplicate: 'has-rgh',
	init: [
		updateActionsTab,
		updateWikiTab,
		updateProjectsTab,
	],
}, {
	include: [
		pageDetect.hasRepoHeader,
	],
	init: moveRareTabs,
}, {
	include: [
		pageDetect.isOrganizationProfile,
	],
	deduplicate: 'has-rgh',
	init: updateProjectsTab,
});

/*

Test URLs:

- Org with 0 projects: https://github.com/babel
- Repo with 0 projects: https://github.com/babel/flavortown
- Repo with 0 wiki: https://github.com/babel/babel-sublime-snippets
- Repo with 0 actions: https://github.com/babel/jade-babel
- Repo with some actions not on main branch: https://github.com/quatquatt/no-actions-menu
- Repo with security alerts: (requires a repo you own with Dependabot alerts enabled)

*/



================================================
FILE: source/features/clean-rich-text-editor.css
================================================
/* Hide unnecessary comment toolbar items, but only on desktop #5743 */
/* Kinda excludes "soft keyboards" devices https://github.com/w3c/csswg-drafts/issues/3871 */
@media (hover: hover) and (pointer: fine) {
	html:not([rgh-OFF-clean-rich-text-editor])
		/* biome-ignore format: bug */
		:is(
			/* Classic fields */
			[data-md-button='mention'],
			[data-md-button='ref'],
			[data-md-button='header-3'],
			[data-md-button='bold'],
			[data-md-button='italic'],
			/* React fields */
				[data-component='IconButton']:has(.octicon-heading),
			[data-component='IconButton']:has(.octicon-bold),
			[data-component='IconButton']:has(.octicon-italic),
			[data-component='IconButton']:has(.octicon-cross-reference),
			[data-component='IconButton']:has(.octicon-mention)
		):not(:focus) {
		/* Like GitHubâ€™s `show-on-focus` class. Needed because we target `md-ref` with the observer in `table-input` and `collapsible-content-button` */
		position: absolute;
		width: 1px;
		height: 1px;
		margin: 0;
		overflow: hidden;
		clip: rect(1px, 1px, 1px, 1px);
	}
}



================================================
FILE: source/features/clean-rich-text-editor.tsx
================================================
import './clean-rich-text-editor.css';

import features from '../feature-manager.js';

void features.addCssFeature(import.meta.url);

/*

## Test URLs

On create issue page
One PR https://github.com/refined-github/refined-github/issues/new?template=1_bug_report.yml

On an issue page
https://github.com/refined-github/refined-github/issues/6408

On discussion page
https://github.com/StrataSource/Portal-2-Community-Edition/discussions/706

*/



================================================
FILE: source/features/clear-pr-merge-commit-message.tsx
================================================
import React from 'dom-chef';
import {countElements} from 'select-dom';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import {getBranches} from '../github-helpers/pr-branches.js';
import getDefaultBranch from '../github-helpers/get-default-branch.js';
import cleanCommitMessage from '../helpers/clean-commit-message.js';
import {userHasPushAccess} from '../github-helpers/get-user-permission.js';
import {expectToken} from '../github-helpers/github-token.js';
import attachElement from '../helpers/attach-element.js';
import observe from '../helpers/selector-observer.js';

const isPrAgainstDefaultBranch = async (): Promise<boolean> => getBranches().base.branch === await getDefaultBranch();

async function clear(messageField: HTMLTextAreaElement): Promise<void> {
	const originalMessage = messageField.value;
	const cleanedMessage = cleanCommitMessage(originalMessage, !await isPrAgainstDefaultBranch());

	if (cleanedMessage === originalMessage.trim()) {
		return;
	}

	// Do not use `text-field-edit` #6348
	messageField.value = cleanedMessage ? cleanedMessage + '\n' : '';

	// Trigger `fit-textareas` if enabled
	messageField.dispatchEvent(new Event('input', {bubbles: true}));

	const anchor = messageField.closest('div[data-has-label]')!;

	attachElement(anchor, {
		after: () => (
			<div className="flex-self-stretch">
				<p className="note">
					The description field was cleared by <a target="_blank" href="https://github.com/refined-github/refined-github/wiki/Extended-feature-descriptions#clear-pr-merge-commit-message" rel="noreferrer">Refined GitHub</a>.
				</p>
			</div>
		),
	});
}

async function init(signal: AbortSignal): Promise<void> {
	await expectToken();
	observe('textarea[placeholder="Add an optional extended descriptionâ€¦"]', clear, {signal});
}

void features.add(import.meta.url, {
	asLongAs: [
		pageDetect.isPRConversation,
		userHasPushAccess,
	],
	exclude: [
		// Don't clear 1-commit PRs #3140
		() => countElements('.TimelineItem.js-commit') === 1,
	],
	awaitDomReady: true, // Appears near the end of the page anyway
	init,
});

/*

Test URLs

PR against non-default branch:
https://github.com/refined-github/sandbox/pull/53

*/



================================================
FILE: source/features/click-outside-modal.tsx
================================================
import * as pageDetect from 'github-url-detection';
import delegate, {type DelegateEvent} from 'delegate-it';

import features from '../feature-manager.js';

function onButtonClick({delegateTarget: delegate, target}: DelegateEvent): void {
	// Only close if clicking outside of modal
	if (delegate === target) {
		delegate.dispatchEvent(new KeyboardEvent('keydown', {bubbles: true, key: 'Escape', code: 'Escape'}));
	}
}

function init(signal: AbortSignal): void {
	delegate('[class*="Dialog__Backdrop-"]', 'click', onButtonClick, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isBranches,
		pageDetect.isRepoCommitList,
		pageDetect.isRepoTree,
		pageDetect.isSingleFile,
	],
	init,
});

/*

## Test URLs

- https://github.com/refined-github/refined-github
- https://github.com/refined-github/refined-github/branches
- https://github.com/refined-github/refined-github/commits/main/
- https://github.com/refined-github/refined-github/blob/main/package.json

*/



================================================
FILE: source/features/close-as-unplanned.tsx
================================================
import delegate, {type DelegateEvent} from 'delegate-it';
import * as pageDetect from 'github-url-detection';
import {$} from 'select-dom/strict.js';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';
import {getFeatureID} from '../helpers/feature-helpers.js';

const id = getFeatureID(import.meta.url);

const unplannedCheckbox = 'input[name="state_reason"][value="not_planned"]';

function update(dropdown: HTMLElement): void {
	const form = dropdown.closest('form')!;
	const radio = $(unplannedCheckbox, dropdown);
	const mainButton = $('[name="comment_and_close"]', form);
	const icon = $('.octicon-skip', dropdown);

	const checkbox = radio.cloneNode();
	checkbox.hidden = true;
	checkbox.type = 'checkbox';

	mainButton.classList.add('tooltipped', 'tooltipped-nw');
	mainButton.setAttribute('aria-label', 'Done, closed, fixed, resolved');

	const unplannedButton = mainButton.cloneNode();
	unplannedButton.append(icon);
	unplannedButton.id = id;
	unplannedButton.classList.add('btn', 'tooltipped', 'tooltipped-nw', 'mr-0');
	// Prevent content from being changed #7024
	unplannedButton.classList.remove('js-comment-and-button');
	unplannedButton.setAttribute('aria-label', 'Close as not planned.\nWonâ€™t fix, canâ€™t repro, duplicate, stale');

	dropdown.replaceWith(unplannedButton);
	form.append(checkbox);
}

function updateCheckbox({delegateTarget: button}: DelegateEvent<MouseEvent, HTMLInputElement>): void {
	$(unplannedCheckbox, button.form!).checked = button.id === id;
}

function init(signal: AbortSignal): void {
	observe('close-reason-selector .select-menu', update, {signal});
	delegate('[name="comment_and_close"]', 'click', updateCheckbox, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isIssue,
	],
	init,
});

/*

Test URLs: (any issue you can close)

https://github.com/refined-github/sandbox/issues/73

*/



================================================
FILE: source/features/close-out-of-view-modals.tsx
================================================
import {$$} from 'select-dom';
import delegate, {type DelegateEvent} from 'delegate-it';

import onetime from '../helpers/onetime.js';
import features from '../feature-manager.js';
import {getFeatureID} from '../helpers/feature-helpers.js';

const visible = new Set();
const observer = new IntersectionObserver(entries => {
	let lastModal: Element;
	for (const {intersectionRatio, target: modal} of entries) {
		if (intersectionRatio > 0) {
			visible.add(modal);
		} else {
			visible.delete(modal);
		}

		lastModal = modal;
	}

	if (visible.size === 0) {
		observer.disconnect();
		lastModal!.closest('details')!.open = false;
	}
});

let lastOpen: number;
const safetySwitch = new AbortController();

function menuActivatedHandler(event: DelegateEvent): void {
	const details = event.target as HTMLDetailsElement;

	// Safety check #3742
	if (!details.open && lastOpen > Date.now() - 500) {
		safetySwitch.abort();
		console.warn(`The modal was closed too quickly. Disabling ${getFeatureID(import.meta.url)} for this session.`);
		return;
	}

	lastOpen = Date.now();

	const modals = $$([
		':scope > details-menu', // "Watch repo" dropdown
		':scope > details-dialog', // "Watch repo" dropdown
		':scope > modal-dialog', // "Development" dropdown #7093
		':scope > div > .dropdown-menu', // "Clone or download" and "Repo nav overflow"
	], details);

	for (const modal of modals) {
		observer.observe(modal);
	}
}

function initOnce(): void {
	delegate('.details-overlay', 'toggle', menuActivatedHandler, {capture: true, signal: safetySwitch.signal});
}

void features.add(import.meta.url, {
	init: onetime(initOnce),
});

/*

Test URLs

- Dropdowns in conversation sidebar: https://github.com/refined-github/sandbox/issues/3
- Star/Watch dropdowns: https://github.com/refined-github/sandbox

*/



================================================
FILE: source/features/closing-remarks.tsx
================================================
import React from 'dom-chef';
import {CachedFunction} from 'webext-storage-cache';
import {$$} from 'select-dom';
import {$} from 'select-dom/strict.js';

import TagIcon from 'octicons-plain-react/Tag';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import fetchDom from '../helpers/fetch-dom.js';
import waitForPrMerge from '../github-events/on-pr-merge.js';
import createBanner, {type BannerProps} from '../github-helpers/banner.js';
import TimelineItem from '../github-helpers/timeline-item.js';
import attachElement from '../helpers/attach-element.js';
import {buildRepoURL, getRepo, isRefinedGitHubRepo} from '../github-helpers/index.js';
import {getReleases} from './releases-tab.js';
import observe from '../helpers/selector-observer.js';
import {userHasPushAccess} from '../github-helpers/get-user-permission.js';

function excludeNightliesAndJunk({textContent}: HTMLAnchorElement): boolean {
	// https://github.com/refined-github/refined-github/issues/7206
	return !textContent.includes('nightly') && /\d[.]\d/.test(textContent);
}

function ExplanationLink(): JSX.Element {
	return (
		<a href="https://github.com/refined-github/refined-github/wiki/Extended-feature-descriptions#closing-remarks" />
	);
}

const firstTag = new CachedFunction('first-tag', {
	async updater(commit: string): Promise<string | false> {
		const tagsAndBranches = await fetchDom(buildRepoURL('branch_commits', commit));
		const tags = $$('ul.branches-tag-list a', tagsAndBranches);
		// eslint-disable-next-line unicorn/no-array-callback-reference -- Just this once, I swear
		return tags.findLast(excludeNightliesAndJunk)?.textContent ?? false;
	},
	cacheKey: ([commit]) => [getRepo()!.nameWithOwner, commit].join(':'),
});

function createReleaseUrl(): string {
	if (isRefinedGitHubRepo()) {
		return 'https://github.com/refined-github/refined-github/actions/workflows/release.yml';
	}

	return buildRepoURL('releases/new');
}

async function init(signal: AbortSignal): Promise<void> {
	const mergeCommit = $(`.TimelineItem.js-details-container.Details a[href^="/${getRepo()!.nameWithOwner}/commit/" i] > code`).textContent;
	const tagName = await firstTag.get(mergeCommit);

	if (tagName) {
		const tagUrl = buildRepoURL('releases/tag', tagName);

		// Add static box at the bottom
		addExistingTagLinkFooter(tagName, tagUrl);

		// PRs have a regular and a sticky header
		observe('#partial-discussion-header relative-time', addExistingTagLinkToHeader.bind(undefined, tagName, tagUrl), {signal});
	} else {
		void addReleaseBanner(<>This PR seems to be <ExplanationLink>not yet released</ExplanationLink>.</>);
	}
}

function addExistingTagLinkToHeader(tagName: string, tagUrl: string, discussionHeader: HTMLElement): void {
	discussionHeader.parentElement!.append(
		<span>
			<TagIcon className="ml-2 mr-1 color-fg-muted" />
			<a
				href={tagUrl}
				className="commit-ref"
				title={`${tagName} was the first Git tag to include this pull request`}
			>
				{tagName}
			</a>
		</span>,
	);
}

function addExistingTagLinkFooter(tagName: string, tagUrl: string): void {
	const linkedTag = <a href={tagUrl} className="Link--primary text-bold">{tagName}</a>;
	attachElement($('#issue-comment-box'), {
		before: () => (
			<TimelineItem>
				{createBanner({
					icon: <TagIcon className="m-0" />,
					text: <>This pull request first <ExplanationLink>appeared</ExplanationLink> in {linkedTag}</>,
					classes: ['flash-success', 'rgh-bg-none'],
				})}
			</TimelineItem>
		),
	});
}

async function addReleaseBanner(text: string | JSX.Element): Promise<void> {
	const [releases] = await getReleases();
	if (releases === 0) {
		return;
	}

	const url = createReleaseUrl();
	const bannerContent = {
		text,
		icon: <TagIcon className="m-0" />,
		classes: ['rgh-bg-none'],
	} satisfies BannerProps;

	if (await userHasPushAccess()) {
		Object.assign(bannerContent, {
			action: url,
			buttonLabel: 'Draft a new release',
		});
	}

	attachElement($('#issue-comment-box'), {
		before: () => (
			<TimelineItem>
				{createBanner(bannerContent)}
			</TimelineItem>
		),
	});
}

void features.add(import.meta.url, {
	// When arriving on an already-merged PR
	asLongAs: [
		pageDetect.isPRConversation,
		pageDetect.isMergedPR,
	],
	awaitDomReady: true, // It must look for the merge commit
	init,
}, {
	// This catches a PR while it's being merged
	asLongAs: [
		pageDetect.isPRConversation,
		pageDetect.isOpenConversation,
		userHasPushAccess,
	],
	awaitDomReady: true, // Post-load user event, no need to listen earlier
	async init(signal: AbortSignal): Promise<void> {
		await waitForPrMerge(signal);
		await addReleaseBanner('Now you can release this change');
	},
});

/*
Test URLs

- PR: https://github.com/refined-github/refined-github/pull/5600
- Locked PR: https://github.com/eslint/eslint/pull/17
- Archived repo: https://github.com/fregante/iphone-inline-video/pull/130
- Junk tag: https://github.com/refined-github/sandbox/pull/1
	- See: https://github.com/refined-github/sandbox/branch_commits/f743c334f6475021ef133591b587bc282c0cf4c4
- Normal tag: https://togithub.com/refined-github/refined-github/pull/7127
	- See https://github.com/refined-github/refined-github/branch_commits/5321825
- Nightly tag: https://togithub.com/neovim/neovim/pull/22060
	- see: https://github.com/neovim/neovim/branch_commits/27b81af

*/



================================================
FILE: source/features/collapsible-content-button.tsx
================================================
import React from 'dom-chef';
import FoldDownIcon from 'octicons-plain-react/FoldDown';
import * as pageDetect from 'github-url-detection';
import {insertTextIntoField} from 'text-field-edit';
import delegate, {type DelegateEvent} from 'delegate-it';
import {$} from 'select-dom/strict.js';

import features from '../feature-manager.js';
import smartBlockWrap from '../helpers/smart-block-wrap.js';
import observe from '../helpers/selector-observer.js';
import {triggerActionBarOverflow} from '../github-helpers/index.js';
import {actionBarSelectors} from '../github-helpers/selectors.js';

function addContentToDetails({delegateTarget}: DelegateEvent<MouseEvent, HTMLButtonElement>): void {
	const container = delegateTarget.closest([
		'form',
		'[data-testid="comment-composer"]', // Add comment form
		'[class^="MarkdownEditor-module__container"]', // Edit comment form
	])!;

	/* There's only one rich-text editor even when multiple fields are visible; the class targets it #5303 */
	const field = $([
		'textarea.js-comment-field', // TODO: remove after March 2025
		'textarea[aria-labelledby="comment-composer-heading"]', // Add comment textarea
		'[class^="MarkdownInput-module__textArea"] textarea', // Edit comment textarea
	], container);
	const selection = field.value.slice(field.selectionStart, field.selectionEnd);

	// Don't indent <summary> because indentation will not be automatic on multi-line content
	const newContent = `
		<details>
		<summary>Details</summary>

		${selection}

		</details>
	`.replaceAll(/(\n|\b)\t+/g, '$1').trim();

	field.focus();
	insertTextIntoField(field, smartBlockWrap(newContent, field));

	// Restore selection.
	// `selectionStart` will be right after the newly-inserted text
	field.setSelectionRange(
		field.value.lastIndexOf('</summary>', field.selectionStart) + '</summary>'.length + 2,
		field.value.lastIndexOf('</details>', field.selectionStart) - 2,
	);
}

function append(container: HTMLElement): void {
	const classes = [
		'Button',
		'Button--iconOnly',
		'Button--invisible',
		'Button--medium',
		'tooltipped',
		'tooltipped-sw',
		'rgh-collapsible-content-btn',
	];

	const divider = $([
		'hr[data-targets="action-bar.items"]', // TODO: remove after March 2025
		'[class^="Toolbar-module__divider"]',
	], container).cloneNode(true);

	container.append(
		divider,
		<button
			type="button"
			className={classes.join(' ')}
			aria-label="Add collapsible content"
			data-targets="action-bar.items" // Enables automatic hiding when it doesn't fit
		>
			<FoldDownIcon />
		</button>,
	);

	if (container.getAttribute('aria-label') === 'Formatting tools') {
		return;
	}

	// Only needed on the old version
	// TODO: remove after March 2025
	triggerActionBarOverflow(container);
}

function init(signal: AbortSignal): void {
	observe(actionBarSelectors, append, {signal});
	delegate('.rgh-collapsible-content-btn', 'click', addContentToDetails, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.hasRichTextEditor,
	],
	init,
});

/*

Test URLs:

- Any issue or PR

*/



================================================
FILE: source/features/command-palette-navigation-shortcuts.tsx
================================================
import delegate, {type DelegateEvent} from 'delegate-it';

import {isMac} from '../github-helpers/index.js';
import features from '../feature-manager.js';
import onetime from '../helpers/onetime.js';

function commandPaletteKeydown(event: DelegateEvent<KeyboardEvent>): void {
	const {key, ctrlKey, delegateTarget} = event;

	if (!ctrlKey || (key !== 'n' && key !== 'p')) {
		return;
	}

	event.preventDefault();

	const targetKey = key === 'n' ? 'ArrowDown' : 'ArrowUp';
	delegateTarget.dispatchEvent(new KeyboardEvent('keydown', {bubbles: true, key: targetKey, code: targetKey}));
}

function initOnce(): void {
	delegate('command-palette', 'keydown', commandPaletteKeydown);
}

void features.add(import.meta.url, {
	asLongAs: [
		() => isMac,
	],
	shortcuts: {
		'ctrl n': 'Select next item in command palette',
		'ctrl p': 'Select previous item in command palette',
	},
	init: onetime(initOnce),
});

/*

Test URLs:

Mac only, any page, like https://github.com/refined-github/refined-github/pull/5432

*/



================================================
FILE: source/features/comment-excess.tsx
================================================
import React from 'react';
import * as pageDetect from 'github-url-detection';
import elementReady from 'element-ready';
import {$, $optional} from 'select-dom/strict.js';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';
import {assertNodeContent} from '../helpers/dom-utils.js';
import {paginationButtonSelector} from '../github-helpers/selectors.js';
import {isMac, scrollIntoViewIfNeeded} from '../github-helpers/index.js';

const hiddenCommentsForm = '#js-progressive-timeline-item-container';

// Don't use `data-hotkey` because it always prevents default
function scrollOnSearch(event: KeyboardEvent): void {
	if (
		(isMac ? event.metaKey : event.ctrlKey)
		&& !event.shiftKey
		&& !event.altKey
		&& event.key === 'f'
	) {
		const collapsedEvents = $optional(paginationButtonSelector);
		if (collapsedEvents) {
			scrollIntoViewIfNeeded(collapsedEvents);
		}
	}
}

function addIndicator(headerCommentCount: HTMLSpanElement): void {
	const loadMoreButton = $(paginationButtonSelector);
	assertNodeContent(headerCommentCount, /^\d+ comment(s)?$/);
	assertNodeContent(loadMoreButton, /^\d+ hidden items$/);
	const spacer = new Text(' Â· ');
	const link = (
		<a
			className="Link--muted"
			href={hiddenCommentsForm}
			onClick={() => {
				// The count will be outdated after the first expansion. We can remove it until the next header update by GitHub.
				spacer.remove();
				link.remove();
			}}
		>
			{loadMoreButton.textContent}
		</a>
	);
	headerCommentCount.append(spacer);
	headerCommentCount.after(link,
	);
}

async function init(signal: AbortSignal): Promise<void> {
	if (await elementReady(`${hiddenCommentsForm} ${paginationButtonSelector}`)) {
		observe('.gh-header-meta relative-time + span', addIndicator, {signal});
		globalThis.addEventListener('keydown', scrollOnSearch, {signal});
	}
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isIssue,
	],
	init,
});

/*

Test URLs

https://togithub.com/prettier/prettier/issues/7475

*/



================================================
FILE: source/features/comments-time-machine-links.gql
================================================
query GetCommitAtDate(
	$owner: String!
	$name: String!
	$branch: String!
	$date: GitTimestamp!
) {
	repository(owner: $owner, name: $name) {
		ref(qualifiedName: $branch) {
			target {
				... on Commit {
					history(first: 1, until: $date) {
						nodes {
							oid
						}
					}
				}
			}
		}
	}
}



================================================
FILE: source/features/comments-time-machine-links.tsx
================================================
import React from 'dom-chef';
import {$} from 'select-dom/strict.js';
import elementReady from 'element-ready';
import * as pageDetect from 'github-url-detection';
import delegate, {type DelegateEvent} from 'delegate-it';
import HistoryIcon from 'octicons-plain-react/History';

import features from '../feature-manager.js';
import api from '../github-helpers/api.js';
import GitHubFileURL from '../github-helpers/github-file-url.js';
import addNotice from '../github-widgets/notice-bar.js';
import {linkifiedURLClass} from '../github-helpers/dom-formatters.js';
import {buildRepoURL, isPermalink} from '../github-helpers/index.js';
import {saveOriginalHref} from './sort-conversations-by-update-time.js';
import observe from '../helpers/selector-observer.js';
import GetCommitAtDate from './comments-time-machine-links.gql';
import {expectToken} from '../github-helpers/github-token.js';
import getDefaultBranch from '../github-helpers/get-default-branch.js';

const commentSelector = [
	'.loaded .react-issue-body', // Issue description
	'.react-issue-comment', // Issue comment
	'[data-testid="review-thread"] > div', // Review thread comment
	'.js-comment', // PR description or comment
].join(',');

async function updateURLtoDatedSha(url: GitHubFileURL, date: string): Promise<void> {
	const {repository} = await api.v4(GetCommitAtDate, {variables: {date, branch: url.branch}});

	const [{oid}] = repository.ref.target.history.nodes;
	$('a.rgh-link-date').pathname = url.assign({branch: oid}).pathname;
}

async function showTimeMachineBar(): Promise<void | false> {
	const url = new URL(location.href); // This can't be replaced with `GitHubFileURL` because `getCurrentGitRef` throws on 404s
	const date = url.searchParams.get('rgh-link-date')!;

	// Drop parameter from current page after using it
	url.searchParams.delete('rgh-link-date');
	history.replaceState(history.state, document.title, url.href);

	if (pageDetect.is404()) {
		const pathnameParts = url.pathname.split('/');
		pathnameParts[4] = `HEAD@{${date}}`;
		url.pathname = pathnameParts.join('/');
	} else {
		// This feature only makes sense if the URL points to a non-permalink
		if (await isPermalink()) {
			return false;
		}

		// Selector note: isRepoFile and isRepoTree have different DOM for this element
		const lastCommitDate = await elementReady('.Box-header relative-time', {waitForChildren: false});
		if (lastCommitDate && date > lastCommitDate.getAttribute('datetime')!) {
			return false;
		}

		const parsedUrl = new GitHubFileURL(location.href);

		// Handle `isRepoHome` #4979
		parsedUrl.branch ||= await getDefaultBranch();
		parsedUrl.route ||= 'tree';

		// Due to GitHubâ€™s bug of supporting branches with slashes: #2901
		void updateURLtoDatedSha(parsedUrl, date); // Don't await it, since the link will usually work without the update

		// Set temporary URL AFTER calling `updateURLtoDatedSha`
		parsedUrl.branch = `${parsedUrl.branch}@{${date}}`;

		// Use new path in link
		url.pathname = parsedUrl.pathname;
	}

	const link = (
		<a className="rgh-link-date" href={url.href}>
			view this object as it appeared at the time of the comment
		</a>
	);
	await addNotice(
		<>You can also {link} (<relative-time datetime={date} />)</>,
	);
}

function addDateParameterToLink(link: HTMLAnchorElement): void {
	if (!pageDetect.isRepoGitObject(link)) {
		return;
	}

	// Skip permalinks
	const linkParts = link.pathname.split('/');
	if (/^[\da-f]{40}$/.test(linkParts[4])) {
		return;
	}

	const comment = link.closest(commentSelector)!;
	const relativeTime = $('relative-time', comment);
	const timestamp = relativeTime.attributes.datetime.value;

	saveOriginalHref(link);

	const searchParameters = new URLSearchParams(link.search);
	searchParameters.set('rgh-link-date', timestamp);
	link.search = String(searchParameters);
}

function addDropdownLink(menu: HTMLElement, timestamp: string): void {
	$('.show-more-popover', menu.parentElement!).append(
		<div className="dropdown-divider" />,
		<a
			href={buildRepoURL(`tree/HEAD@{${timestamp}}`)}
			className={'dropdown-item btn-link ' + linkifiedURLClass}
			role="menuitem"
			title="Browse repository like it appeared on this day"
		>
			View repo at this time
		</a>,
	);
}

function addDropdownLinkReact({delegateTarget: delegate}: DelegateEvent): void {
	const timestamp = delegate.closest('[class^="Box"]')!.querySelector('relative-time[datetime]')!.attributes.datetime.value;
	const menuItemList = $('[class^="prc-ActionList-ActionList"]');
	const menuItem = $('[class^="prc-ActionList-ActionListItem"]', menuItemList).cloneNode(true);

	menuItem.removeAttribute('aria-keyshortcuts');
	menuItem.role = 'none';
	const menuItemContentWrapper = $('[class^="prc-ActionList-ActionListContent"]', menuItem);
	const link = (
		<a
			href={buildRepoURL(`tree/HEAD@{${timestamp}}`)}
			className={menuItemContentWrapper.className + ' ' + linkifiedURLClass}
			role="menuitem"
			title="Browse repository like it appeared on this day"
			aria-keyshortcuts="v"
		>
		</a>
	);
	link.append(...menuItemContentWrapper.childNodes);
	menuItemContentWrapper.replaceWith(link);
	$('[class^="prc-ActionList-ItemLabel"]', menuItem).textContent = 'View repo at this time';
	$('[class^="prc-ActionList-LeadingVisual"]', menuItem).replaceChildren(<HistoryIcon />);

	menuItemList.append(
		<li className="dropdown-divider" aria-hidden="true" data-component="ActionList.Divider" />,
		menuItem,
	);
}

async function init(signal: AbortSignal): Promise<void> {
	await expectToken();

	observe('.timeline-comment-actions > details:last-child', menu => {
		if (menu.closest('.js-pending-review-comment')) {
			return;
		}

		// The timestamp of main review comments isn't in their header but in the timeline event above #5423
		const timestamp = menu
			.closest(['.js-comment:not([id^="pullrequestreview-"])', '.js-timeline-item'])!
			.querySelector('relative-time')!
			.attributes
			.datetime
			.value;

		addDropdownLink(menu, timestamp);
	}, {signal});

	// [data-component="IconButton"] includes only React buttons
	// :not([id^="task-list-menu"]) excludes task list (Convert to issue/sub-issue, etc) menu buttons
	delegate(`:is(${commentSelector}) button[data-component="IconButton"]:has(> .octicon-kebab-horizontal):not([id^="task-list-menu"])`, 'click', addDropdownLinkReact, {signal});

	observe(
		`:is(${commentSelector}) a[href^="${location.origin}"]:not(.${linkifiedURLClass})`,
		addDateParameterToLink,
		{signal},
	);
}

void features.add(import.meta.url, {
	include: [
		pageDetect.hasComments,
	],
	exclude: [
		pageDetect.isGist,
	],
	init,
}, {
	asLongAs: [
		() => new URLSearchParams(location.search).has('rgh-link-date'),
	],
	include: [
		pageDetect.is404,
		pageDetect.isSingleFile,
		pageDetect.isRepoTree,
	],
	init: showTimeMachineBar,
});

/*
Test URLs

https://github.com/refined-github/refined-github/pull/1863
https://github.com/refined-github/sandbox/issues/108

See the bar on:

- https://github.com/sindresorhus/refined-github/blob/main/source/features/mark-merge-commits-in-list.tsx?rgh-link-date=2019-03-04T13%3A04%3A18Z
*/



================================================
FILE: source/features/conflict-marker.css
================================================
[data-color-mode='light'] .rgh-conflict-marker svg {
	color: #ccc;
}

[data-color-mode='dark'] .rgh-conflict-marker svg {
	color: var(--fgColor-muted, var(--color-fg-muted, fuchsia));
}



================================================
FILE: source/features/conflict-marker.tsx
================================================
import './conflict-marker.css';

import React from 'dom-chef';
import * as pageDetect from 'github-url-detection';
import AlertIcon from 'octicons-plain-react/Alert';
import batchedFunction from 'batched-function';

import features from '../feature-manager.js';
import api from '../github-helpers/api.js';
import observe from '../helpers/selector-observer.js';
import {openPrsListLink} from '../github-helpers/selectors.js';
import {expectToken} from '../github-helpers/github-token.js';

async function addIcon(links: HTMLAnchorElement[]): Promise<void> {
	const prConfigs = links.map(link => {
		const [, owner, name, , prNumber] = link.pathname.split('/');
		const key = api.escapeKey(owner, name, prNumber);
		return {
			key,
			link,
			owner,
			name,
			number: Number(prNumber),
		};
	});

	// Batch queries cannot be exported to .gql files
	const batchQuery = prConfigs.map(({key, owner, name, number}) => `
		${key}: repository(owner: "${owner}", name: "${name}") {
			pullRequest(number: ${number}) {
				mergeable
				state
				isDraft
			}
		}
	`).join('\n');

	const data = await api.v4(batchQuery);

	for (const pr of prConfigs) {
		const {mergeable, state, isDraft} = data[pr.key].pullRequest;
		if (mergeable === 'CONFLICTING' && (state === 'OPEN' || isDraft)) {
			pr.link.after(
				<a
					className="rgh-conflict-marker tooltipped tooltipped-e color-fg-muted ml-2"
					aria-label="This PR has conflicts that must be resolved"
					href={`${pr.link.pathname}#partial-pull-merging`}
				>
					<AlertIcon className="v-align-middle" />
				</a>,
			);
		}
	}
}

async function init(signal: AbortSignal): Promise<void> {
	await expectToken();
	observe(openPrsListLink, batchedFunction(addIcon, {delay: 100}), {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isIssueOrPRList,
	],
	init,
});

/*
Test URLs
https://github.com/pulls
https://github.com/refined-github/sandbox/issues?q=conflict
https://github.com/kubernetes/kubernetes/milestone/62
*/



================================================
FILE: source/features/conventional-commits.css
================================================
:root [rgh-conventional-commits] {
	font-size: var(--body-font-size, 1px);
	line-height: 1.5;
}

/* Default color from `wontfix` label. Also applies to `chore`  because it's the most common and meaningless type of commit */
[rgh-conventional-commits] {
	--label-r: 255;
	--label-g: 255;
	--label-b: 255;
	--label-h: 0;
	--label-s: 0;
	--label-l: 100;
}

/* Color from `enhancement` label */
[rgh-conventional-commits='feat'] {
	--label-r: 162;
	--label-g: 238;
	--label-b: 239;
	--label-h: 180;
	--label-s: 70;
	--label-l: 78;
}

/* Color from `bug` label */
[rgh-conventional-commits='fix'] {
	--label-r: 215;
	--label-g: 58;
	--label-b: 74;
	--label-h: 353;
	--label-s: 66;
	--label-l: 53;
}

/* Color from `documentation` label */
[rgh-conventional-commits='docs'] {
	--label-r: 0;
	--label-g: 117;
	--label-b: 202;
	--label-h: 205;
	--label-s: 100;
	--label-l: 39;
}

[rgh-conventional-commits='build'] {
	--label-r: 217;
	--label-g: 63;
	--label-b: 11;
	--label-h: 15;
	--label-s: 90;
	--label-l: 44;
}

[rgh-conventional-commits='refactor'] {
	--label-r: 0;
	--label-g: 107;
	--label-b: 117;
	--label-h: 185;
	--label-s: 100;
	--label-l: 22;
}

[rgh-conventional-commits='test'] {
	--label-r: 251;
	--label-g: 202;
	--label-b: 4;
	--label-h: 48;
	--label-s: 96;
	--label-l: 50;
}

[rgh-conventional-commits='ci'] {
	--label-r: 197;
	--label-g: 222;
	--label-b: 245;
	--label-h: 208;
	--label-s: 70;
	--label-l: 86;
}

[rgh-conventional-commits='perf'] {
	--label-r: 83;
	--label-g: 25;
	--label-b: 231;
	--label-h: 256;
	--label-s: 81;
	--label-l: 50;
}



================================================
FILE: source/features/conventional-commits.tsx
================================================
/*

This feature is documented at https://github.com/refined-github/refined-github/wiki/Customization#conventional-commits

*/

import './conventional-commits.css';

import React from 'react';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';
import {commitTitleInLists} from '../github-helpers/selectors.js';
import {conventionalCommitRegex, parseConventionalCommit} from '../helpers/conventional-commits.js';
import {removeTextInTextNode} from '../helpers/dom-utils.js';

function renderLabelInCommitTitle(commitTitleElement: HTMLElement): void {
	const textNode = commitTitleElement.firstChild!;
	const commit = parseConventionalCommit(textNode.textContent);

	if (!commit) {
		return;
	}

	if (
		// Skip commits that are _only_ "ci:" without anything else. Rare but it would be confusing to show just the label
		commit.raw === textNode.textContent
		&& !commitTitleElement.nextElementSibling

		// Ensure that the element contains only plain text, not stuff like <code>
		&& commitTitleElement.childElementCount < 1
	) {
		return;
	}

	commitTitleElement.prepend(
		<span className="IssueLabel hx_IssueLabel mr-2" rgh-conventional-commits={commit.rawType}>
			{commit.type}
		</span>,

		// Keep scope outside because that's how they're rendered in release notes as well
		commit.scope ? <span className="color-fg-muted">{commit.scope}</span> : '',
	);

	removeTextInTextNode(textNode, conventionalCommitRegex);
}

function init(signal: AbortSignal): void {
	observe(`${commitTitleInLists} > span > a:first-child`, renderLabelInCommitTitle, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isCommitList,
	],
	init,
});

/*

Test URLs:

- Repo commits: https://github.com/refined-github/sandbox/commits/conventional-commits/
- PR commits: https://github.com/refined-github/sandbox/pull/91/commits
- Real data: https://github.com/conventional-changelog/standard-version/commits
- Repo without conventional commits: https://github.com/refined-github/refined-github/commits

*/



================================================
FILE: source/features/conversation-activity-filter.css
================================================
.rgh-conversation-events-label,
.rgh-conversation-activity-is-filtered .rgh-conversation-activity-filtered,
[data-rgh-conversation-activity-filter='hideEventsAndCollapsedComments']
	:is(
		.rgh-conversation-activity-collapsed,
		.js-resolvable-timeline-thread-container[data-resolved='true'],
		.js-resolvable-timeline-thread-container[data-resolved='false']
			.minimized-comment
	),
.rgh-conversation-activity-is-filtered
	.rgh-conversation-activity-filter-dropdown
	.octicon-eye,
:is(.js-issues-results, [data-testid='issue-viewer-container']):not(
		.rgh-conversation-activity-is-filtered
	)
	.rgh-conversation-activity-filter-dropdown
	.octicon-eye-closed {
	display: none !important;

	/* For debugging purposes only */
	/* display: block !important; */
	/* outline: solid 5px #f00; */
}

[data-rgh-conversation-activity-filter='hideEvents']
	.rgh-conversation-events-label {
	display: inline !important;
}

/* Fix dropdown getting cut off on issue headers */
[class^='HeaderMetadata-module__titleAndMetadata'] {
	overflow: visible !important;
}

.rgh-conversation-activity-filter-wrapper {
	display: flex;
	align-items: center;
}

.rgh-conversation-activity-filter-dropdown summary {
	display: flex;
	align-items: center;
}

.rgh-conversation-activity-filter-dropdown .SelectMenu-modal {
	width: max-content;
}

.gh-header-meta {
	.rgh-conversation-activity-filter-wrapper {
		display: block;
		margin-bottom: 8px; /* Preserve centered vertical alignment with status badge */
	}

	.rgh-conversation-activity-filter {
		display: inline;
	}

	.rgh-conversation-activity-filter-dropdown summary {
		display: list-item;
	}
}



================================================
FILE: source/features/conversation-activity-filter.tsx
================================================
import './conversation-activity-filter.css';

import React from 'dom-chef';
import {$, $optional} from 'select-dom/strict.js';
import {$$, elementExists} from 'select-dom';
import * as pageDetect from 'github-url-detection';
import CheckIcon from 'octicons-plain-react/Check';
import EyeClosedIcon from 'octicons-plain-react/EyeClosed';
import EyeIcon from 'octicons-plain-react/Eye';
import XIcon from 'octicons-plain-react/X';
import domLoaded from 'dom-loaded';

import delay from '../helpers/delay.js';
import {wrap} from '../helpers/dom-utils.js';
import features from '../feature-manager.js';
import {registerHotkey} from '../github-helpers/hotkey.js';
import observe from '../helpers/selector-observer.js';

const expectedDropdownWidth = 270;

const states = {
	default: '',
	hideEvents: 'Hide events',
	hideEventsAndCollapsedComments: 'Hide events and collapsed comments',
};

type State = keyof typeof states;

const dropdownClass = 'rgh-conversation-activity-filter-dropdown';
const hiddenClassName = 'rgh-conversation-activity-filtered';
const collapsedClassName = 'rgh-conversation-activity-collapsed';
const timelineItem = [
	'.js-timeline-item',
	// React issue pages
	'[data-wrapper-timeline-id]:not([data-wrapper-timeline-id="load-top"])', // Exclude "Load more" button
];

function processTimelineEvent(item: HTMLElement): void {
	// Don't hide commits in PR conversation timelines #5581
	if (pageDetect.isPR() && elementExists('.TimelineItem-badge .octicon-git-commit', item)) {
		return;
	}

	item.classList.add(hiddenClassName);
}

function processSimpleComment(item: HTMLElement): void {
	// Hide comments marked as resolved/hidden
	if (elementExists('.octicon-unfold', item)) {
		item.classList.add(collapsedClassName);
	}
}

function processDissmissedReviewEvent(item: HTMLElement): void {
	item.classList.add(hiddenClassName);

	// Find and hide stale reviews referenced by dismissed review events
	for (const {hash: staleReviewId} of $$('.TimelineItem-body > a[href^="#pullrequestreview-"]', item)) {
		$(staleReviewId)
			.closest(timelineItem)!
			.classList
			.add(collapsedClassName);
	}
}

function processReview(review: HTMLElement): void {
	const hasMainComment = elementExists('.js-comment[id^=pullrequestreview] .timeline-comment', review);

	// Don't combine the selectors or use early returns without understanding what a thread or thread comment is
	const unresolvedThreads = $$('.js-resolvable-timeline-thread-container[data-resolved="false"]', review);
	const unresolvedThreadComments = $$('.timeline-comment-group:not(.minimized-comment)', review);

	if (!hasMainComment && (unresolvedThreads.length === 0 || unresolvedThreadComments.length === 0)) {
		review.classList.add(collapsedClassName); // The whole review is essentially resolved
		return;
	}

	for (const thread of unresolvedThreads) {
		// Hide threads containing only resolved comments
		if (!unresolvedThreadComments.some(comment => thread.contains(comment))) {
			thread.classList.add(collapsedClassName);
		}
	}
}

function processItem(item: HTMLElement): void {
	// Exclude deep-linked comment
	if (location.hash.startsWith('#issuecomment-') && elementExists(location.hash, item)) {
		return;
	}

	if (elementExists('.js-comment[id^=pullrequestreview]', item)) {
		processReview(item);
	} else if (elementExists('.TimelineItem-badge .octicon-x', item)) {
		processDissmissedReviewEvent(item);
	} else if (elementExists(['.comment-body', '.react-issue-comment'], item)) {
		processSimpleComment(item);
	} else {
		processTimelineEvent(item);
	}
}

async function handleSelection({target}: Event): Promise<void> {
	// The event is fired before the DOM is updated. Extensions can't access the eventâ€™s `detail` where the widget would normally specify which element was selected
	await delay(1);

	const state = $('[aria-checked="true"]', target as Element).dataset.value as State;
	applyState(state);
}

function applyState(state: State): void {
	const container = $(':is(.js-issues-results, [data-testid="issue-viewer-container"])');
	container.setAttribute('data-rgh-conversation-activity-filter', state);
	container.classList.toggle(
		'rgh-conversation-activity-is-filtered',
		state !== 'default',
	);

	// Update the state of the dropdowns
	for (const dropdownItem of $$(`.${dropdownClass} [aria-checked="false"][data-value="${state}"]`)) {
		dropdownItem.setAttribute('aria-checked', 'true');
	}

	for (const dropdownItem of $$(`.${dropdownClass} [aria-checked="true"]:not([data-value="${state}"])`)) {
		dropdownItem.setAttribute('aria-checked', 'false');
	}
}

function createRadios(current: State): JSX.Element[] {
	return Object.entries(states).map(([state, label]) => (
		<div
			className="SelectMenu-item"
			role="menuitemradio"
			aria-checked={state === current ? 'true' : 'false'}
			data-value={state}
		>
			<CheckIcon className="SelectMenu-icon SelectMenu-icon--check" />
			{label || 'Show all'}
		</div>
	));
}

async function addWidget(state: State, anchor: HTMLElement): Promise<void> {
	const position = anchor.closest('div')!;
	if (position.classList.contains('rgh-conversation-activity-filter')) {
		return;
	}

	await delay(100); // Let `clean-conversation-headers` run first
	wrap(position, <div className="rgh-conversation-activity-filter-wrapper" />);
	position.classList.add('rgh-conversation-activity-filter');

	// Place the icon first to calculate available space for the dropdown after
	const details = <details
		className={`details-reset details-overlay ${position.offsetWidth > 0 ? 'ml-2' : ''} d-inline-block position-relative ${dropdownClass}`}
		id="rgh-conversation-activity-filter-select-menu"
	>
		<summary className="height-full color-fg-muted">
			<EyeIcon />
			<EyeClosedIcon className="color-fg-danger" />
			<span className="text-small color-fg-danger v-align-text-bottom rgh-conversation-events-label ml-1">events</span>
			<div className="dropdown-caret ml-1" />
		</summary>
	</details>;
	position.after(details);

	// Try to place the dropdown to the left https://github.com/refined-github/refined-github/issues/5450#issuecomment-1068284635
	// TODO: Use `<anchored-position>` instead
	const availableSpaceToTheLeftOfTheDropdown = details.getBoundingClientRect().left;
	const alignment
	= availableSpaceToTheLeftOfTheDropdown === 0
		|| (availableSpaceToTheLeftOfTheDropdown > expectedDropdownWidth)
		? 'right-0'
		: 'left-0';

	details.append(
		<details-menu
			className={`SelectMenu ${alignment}`}
			on-details-menu-select={handleSelection}
		>
			<div className="SelectMenu-modal">
				<div className="SelectMenu-header">
					<h3 className="SelectMenu-title color-fg-default">
						Filter conversation activities
					</h3>
					<button
						className="SelectMenu-closeButton"
						type="button"
						data-toggle-for="rgh-conversation-activity-filter-select-menu"
					>
						<XIcon />
					</button>
				</div>
				<div className="SelectMenu-list">
					{createRadios(state)}
				</div>
			</div>
		</details-menu>,
	);
}

const minorFixesIssuePages = [
	'https://github.com/refined-github/refined-github/issues/3686',
	'https://github.com/refined-github/refined-github/issues/6000',
	'https://github.com/refined-github/refined-github/issues/7000',
	'https://github.com/refined-github/refined-github/issues/7777',
];

function uncollapseTargetedComment(): void {
	if (location.hash.startsWith('#issuecomment-')) {
		$optional(`.${collapsedClassName} ${location.hash}`)
			?.closest(timelineItem)
			?.classList
			.remove(collapsedClassName);
	}
}

function switchToNextFilter(): void {
	const state = $(`.${dropdownClass} [aria-checked="true"]`).dataset.value as State;

	switch (state) {
		case 'default': {
			applyState('hideEvents');
			break;
		}

		case 'hideEvents': {
			applyState('hideEventsAndCollapsedComments');
			break;
		}

		case 'hideEventsAndCollapsedComments': {
			applyState('default');
			break;
		}
	}
}

async function init(signal: AbortSignal): Promise<void> {
	const initialState = minorFixesIssuePages.some(url => location.href.startsWith(url))
		? 'hideEventsAndCollapsedComments' // Automatically hide resolved comments on "Minor codebase updates and fixes" issue pages
		: 'default';

	observe([
		'#partial-discussion-header .gh-header-meta > .flex-auto:last-child',
		'#partial-discussion-header .sticky-header-container .meta:last-child',
		// React issue pages
		'[class^="HeaderMetadata-module__metadataContent"]',
		'[class*="HeaderMetadata-module__smallMetadataRow"]',
	], addWidget.bind(undefined, initialState), {signal});

	if (initialState !== 'default') {
		// Wait for the DOM to be ready before applying the initial state
		// https://github.com/refined-github/refined-github/issues/7086
		await domLoaded;
		applyState(initialState);
	}

	globalThis.addEventListener('hashchange', uncollapseTargetedComment, {signal});

	observe(timelineItem, processItem, {signal});

	registerHotkey('h', switchToNextFilter, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isConversation,
		// Workaround for #6554
		// TODO: remove once the issue is resolved
		pageDetect.isRepoIssueOrPRList,
	],
	shortcuts: {
		h: 'Cycle through conversation activity filters',
	},
	init,
});

/*

Test URLs:

https://github.com/refined-github/refined-github/pull/4030
https://github.com/refined-github/refined-github/issues/4008

*/



================================================
FILE: source/features/conversation-authors.css
================================================
.rgh-collaborator {
	border: 1px solid
		var(--borderColor-default, var(--color-border-default, fuchsia));
	border-radius: 2em;
	padding: 2px 5px;

	.rgh-small-user-avatars {
		margin-right: 2px !important;
	}
}

/* Fix border partially visible in new view #8025 */
[data-testid='list-row-repo-name-and-number'] {
	margin-top: 1.5px;
}

a.rgh-own-conversation,
a.rgh-own-conversation:hover {
	/* Colors taken from native .user-mention class */
	color: var(
		--color-user-mention-fg,
		fuchsia
	) !important; /* Their :hover	uses !important... */
	background-color: var(--bgColor-attention-muted, fuchsia);
}

a.rgh-own-conversation:hover {
	text-decoration: underline !important;
}



================================================
FILE: source/features/conversation-authors.gql
================================================
query GetMaintainers($owner: String!, $name: String!) {
	repository(owner: $owner, name: $name) {
		collaborators(first: 100, affiliation: ALL) {
			nodes {
				login
			}
		}
	}
}



================================================
FILE: source/features/conversation-authors.tsx
================================================
import './conversation-authors.css';

import {CachedFunction} from 'webext-storage-cache';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import api from '../github-helpers/api.js';
import {cacheByRepo, getLoggedInUser} from '../github-helpers/index.js';
import observe from '../helpers/selector-observer.js';
import {expectToken} from '../github-helpers/github-token.js';
import GetCollaborators from './conversation-authors.gql';

const collaborators = new CachedFunction('repo-collaborators', {
	async updater(): Promise<string[]> {
		const {repository} = await api.v4(GetCollaborators);
		return repository.collaborators.nodes.map((user: Record<string, string>) => user.login);
	},
	maxAge: {days: 1},
	staleWhileRevalidate: {days: 20},
	cacheKey: cacheByRepo,
});

async function highlightCollaborators(signal: AbortSignal): Promise<void> {
	await expectToken();
	const list = await collaborators.get();
	observe([
		// Old issue lists - TODO: Drop in 2026
		'.js-issue-row [data-hovercard-type="user"]',
		'a[class^="IssueItem-module__authorCreatedLink"]',
	], author => {
		const name = author.textContent.trim();
		if (list.includes(name) && name !== getLoggedInUser()) {
			author.classList.add('rgh-collaborator');
		}
	}, {signal});
}

function highlightSelf(signal: AbortSignal): void {
	// "Opened by {user}" and "Created by {user}"
	observe([
		// Old issue lists - TODO: Drop in 2026
		`.opened-by a[title$="ed by ${CSS.escape(getLoggedInUser()!)}"]`,
		`a[class^="IssueItem-module__authorCreatedLink"][data-hovercard-url="/users/${CSS.escape(getLoggedInUser()!)}/hovercard"]`,
	], author => {
		author.classList.add('rgh-own-conversation');
	}, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isRepoIssueOrPRList,
	],
	init: highlightCollaborators,
}, {
	include: [
		pageDetect.isIssueOrPRList,
	],
	init: highlightSelf,
});

/*

Test URLs:

https://github.com/issues
https://github.com/refined-github/refined-github/pulls

*/



================================================
FILE: source/features/conversation-links-on-repo-lists.tsx
================================================
import React from 'dom-chef';
import {$, $optional} from 'select-dom/strict.js';
import * as pageDetect from 'github-url-detection';
import GitPullRequestIcon from 'octicons-plain-react/GitPullRequest';
import IssueOpenedIcon from 'octicons-plain-react/IssueOpened';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';
import {assertNodeContent} from '../helpers/dom-utils.js';

function addConversationLinks(repositoryLink: HTMLAnchorElement): void {
	const repository = repositoryLink.closest('li')!;

	// Remove the "X issues need help" link
	$optional('[href*="issues?q=label%3A%22help+wanted"]', repository)?.remove();

	// Place before the update date
	assertNodeContent(
		$('relative-time', repository).previousSibling,
		'Updated',
	).before(
		<>
			<a
				className="Link--muted mr-3"
				href={repositoryLink.href + '/issues'}
			>
				<IssueOpenedIcon />
			</a>
			<a
				className="Link--muted mr-3"
				href={repositoryLink.href + '/pulls'}
			>
				<GitPullRequestIcon />
			</a>
		</>,
	);
}

function addSearchConversationLinks(repositoryLink: HTMLAnchorElement): void {
	// Do not move to `includes` until React AJAX issues are resolved:
	// https://github.com/refined-github/refined-github/pull/7524#issuecomment-2211692096
	// https://github.com/refined-github/refined-github/issues/6554
	if (new URLSearchParams(location.search).get('type') !== 'repositories') {
		return;
	}

	// Place before the update date Â·
	repositoryLink
		.closest('[data-testid="results-list"] > div')!
		.querySelector('ul > span:last-of-type')!
		.before(
			<>
				<span
					aria-hidden="true"
					className="color-fg-muted mx-2"
				>
					Â·
				</span>
				<li className="d-flex text-small">
					<a
						className="Link--muted"
						href={repositoryLink.href + '/issues'}
					>
						<IssueOpenedIcon />
					</a>
				</li>
				<li className="d-flex text-small ml-2">
					<a
						className="Link--muted"
						href={repositoryLink.href + '/pulls'}
					>
						<GitPullRequestIcon />
					</a>
				</li>
			</>,
		);
}

function init(signal: AbortSignal): void {
	observe('a[itemprop="name codeRepository"]', addConversationLinks, {signal});
}

function initSearch(signal: AbortSignal): void {
	observe('.search-title a', addSearchConversationLinks, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isUserProfileRepoTab, // Organizations already have these links
	],
	init,
}, {
	include: [
		pageDetect.isGlobalSearchResults,
	],
	init: initSearch,
});

/*
Test URLs

isProfileRepoList:
https://github.com/fregante?tab=repositories

isGlobalSearchResults:
https://github.com/search?q=fregante
*/



================================================
FILE: source/features/convert-release-to-draft.tsx
================================================
import React from 'dom-chef';
import {$} from 'select-dom/strict.js';
import {elementExists} from 'select-dom';
import * as pageDetect from 'github-url-detection';
import delegate from 'delegate-it';

import features from '../feature-manager.js';
import api from '../github-helpers/api.js';
import {getRepo} from '../github-helpers/index.js';
import observe from '../helpers/selector-observer.js';
import showToast from '../github-helpers/toast.js';
import {expectToken} from '../github-helpers/github-token.js';

const getReleaseEditLinkSelector = (): 'a' => `a[href^="/${getRepo()!.nameWithOwner}/releases/edit"]` as 'a';

async function convertToDraft(): Promise<void> {
	const tagName = location.pathname.split('/').pop()!;
	const release = await api.v3(`releases/tags/${tagName}`);
	await api.v3(release.url, {
		method: 'PATCH',
		body: {
			draft: true,
		},
	});

	$(getReleaseEditLinkSelector()).click(); // Visit "Edit release" page
}

const confirmMessage = 'The release will be effectively deleted and a new draft will be created.';
const confirmMessageWithReactions = 'Existing user reactions will be lost.';
const confirmMessageQuestion = 'Continue?';

async function onConvertClick(): Promise<void> {
	const message = elementExists('.js-reaction-group-button')
		? [confirmMessage, confirmMessageWithReactions, confirmMessageQuestion]
		: [confirmMessage, confirmMessageQuestion];
	if (!confirm(message.join(' '))) {
		return;
	}

	await showToast(convertToDraft(), {
		message: 'Convertingâ€¦',
		doneMessage: 'Redirectingâ€¦',
	});
}

function attachButton(editButton: HTMLAnchorElement): void {
	if (elementExists('[title="Draft"]')) {
		return;
	}

	editButton.before(
		<button
			type="button"
			className="Button Button--secondary Button--small ml-3 mr-1 rgh-convert-draft"
		>
			Convert to draft
		</button>,
	);
}

async function init(signal: AbortSignal): Promise<void | false> {
	await expectToken();

	observe(getReleaseEditLinkSelector(), attachButton, {signal});
	delegate('.rgh-convert-draft', 'click', onConvertClick, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isSingleReleaseOrTag,
	],
	init,
});

/*

Test URLs:

https://github.com/refined-github/refined-github/releases/tag/23.7.25

*/



================================================
FILE: source/features/copy-on-y.tsx
================================================
import features from '../feature-manager.js';
import {isEditable} from '../helpers/dom-utils.js';

async function handler({key, target}: KeyboardEvent): Promise<void> {
	if (key === 'y' && !isEditable(target)) {
		const url = location.href;
		await navigator.clipboard.writeText(url);
		// Log to ensure we're coping the new URL
		console.log('Copied URL to the clipboard', url);
	}
}

function init(signal: AbortSignal): void {
	globalThis.addEventListener('keyup', handler, {signal});
}

void features.add(import.meta.url, {
	init,
});
// TODO: Add visual popup, maybe use GitHub's own clipboard element

/*

Test URLs

> Any page, particularly it should work copy the permalink when `y` is pressed on:

https://github.com/refined-github/refined-github/blob/main/.gitignore

*/



================================================
FILE: source/features/create-release-shortcut.tsx
================================================
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import {registerHotkey} from '../github-helpers/hotkey.js';
import {buildRepoURL} from '../github-helpers/index.js';

function init(signal: AbortSignal): void {
	// Reasoning for this feature: #1254
	registerHotkey('c', buildRepoURL('releases/new'), {signal});
}

void features.add(import.meta.url, {
	shortcuts: {
		c: 'Create a new release',
	},
	include: [
		pageDetect.isReleasesOrTags,
	],
	exclude: [
		pageDetect.isNewRelease,
		pageDetect.isEditingRelease,
	],
	init,
});

/*

Test URLs

https://github.com/refined-github/refined-github/releases
https://github.com/refined-github/sandbox/releases/new
https://github.com/refined-github/sandbox/releases/tag/cool

*/



================================================
FILE: source/features/cross-deleted-pr-branches.css
================================================
.commit-ref[title$='has been deleted'],
.commit-ref[title$='has been deleted'] * {
	text-decoration: line-through !important;
	color: var(--fgColor-muted, var(--color-fg-muted, fuchsia));
}



================================================
FILE: source/features/cross-deleted-pr-branches.tsx
================================================
import './cross-deleted-pr-branches.css';

import React from 'dom-chef';
import {$$, lastElement} from 'select-dom';
import {$, $optional} from 'select-dom/strict.js';
import * as pageDetect from 'github-url-detection';

import {wrap} from '../helpers/dom-utils.js';
import features from '../feature-manager.js';

function init(): void | false {
	const lastBranchAction = lastElement('.TimelineItem-body .user-select-contain.commit-ref');

	const headReferenceLink = $optional('.head-ref a');
	if (!headReferenceLink && !lastBranchAction) {
		return; // Don't return false, This featureâ€™s CSS already takes care of this
	}

	if (!lastBranchAction?.closest('.TimelineItem-body')!.textContent.includes(' deleted ')) {
		return false;
	}

	const deletedBranchName = lastBranchAction.textContent.trim();
	const repoRootUrl = headReferenceLink?.href.split('/', 5).join('/');
	for (const element of $$('.commit-ref')) {
		const branchName = element.textContent.trim().split(':').pop()!;
		if (branchName === deletedBranchName) {
			element.title = 'This branch has been deleted';

			if (!headReferenceLink) {
				continue;
			}

			if (element.classList.contains('head-ref')) {
				$('a', element).href = repoRootUrl!;
			} else {
				wrap(element, <a href={repoRootUrl} />);
			}
		}
	}
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isPRConversation,
	],
	deduplicate: 'has-rgh-inner',
	awaitDomReady: true, // Must wait for the last one
	init,
});

/*

Test URLs:

- deleted branch: https://github.com/sindresorhus/refined-github/pull/576
- deleted branch (from fork): https://github.com/sindresorhus/refined-github/pull/872
- restored branch (on fork): https://github.com/sindresorhus/refined-github/pull/909

*/



================================================
FILE: source/features/deep-reblame.css
================================================
/* Uses cyan instead of fuchsia because the link is natively purple */
button.rgh-deep-reblame .octicon-versions {
	color: var(--color-prettylights-syntax-entity, cyan);
	opacity: 70%;
}

.rgh-deep-reblame:hover .octicon-versions {
	color: var(--color-scale-pink-7, cyan);
	opacity: 70%;
}



================================================
FILE: source/features/deep-reblame.gql
================================================
query GetPullRequestBlameCommit(
	$owner: String!
	$name: String!
	$file: String!
	$commit: String!
) {
	repository(owner: $owner, name: $name) {
		file: object(expression: $file) {
			id
		}
		object(expression: $commit) {
			... on Commit {
				associatedPullRequests(last: 1) {
					nodes {
						number
						mergeCommit {
							oid
						}
						commits(last: 1) {
							nodes {
								commit {
									oid
								}
							}
						}
					}
				}
			}
		}
	}
}



================================================
FILE: source/features/deep-reblame.tsx
================================================
import './deep-reblame.css';

import mem from 'memoize';
import React from 'dom-chef';
import {$$} from 'select-dom';
import {$, $optional} from 'select-dom/strict.js';
import VersionsIcon from 'octicons-plain-react/Versions';
import * as pageDetect from 'github-url-detection';
import delegate, {type DelegateEvent} from 'delegate-it';

import features from '../feature-manager.js';
import api from '../github-helpers/api.js';
import GitHubFileURL from '../github-helpers/github-file-url.js';
import showToast from '../github-helpers/toast.js';
import looseParseInt from '../helpers/loose-parse-int.js';
import observe from '../helpers/selector-observer.js';
import GetPullRequestBlameCommit from './deep-reblame.gql';
import {multilineAriaLabel} from '../github-helpers/index.js';
import {expectToken} from '../github-helpers/github-token.js';

const getPullRequestBlameCommit = mem(async (commit: string, prNumbers: number[], currentFilename: string): Promise<string> => {
	const {repository} = await api.v4(GetPullRequestBlameCommit, {
		variables: {
			commit,
			file: commit + ':' + currentFilename,
		},
	});

	const associatedPR = repository.object.associatedPullRequests.nodes[0];

	if (!associatedPR || !prNumbers.includes(associatedPR.number) || associatedPR.mergeCommit.oid !== commit) {
		throw new Error('The PR linked in the title didnâ€™t create this commit');
	}

	if (!repository.file) {
		throw new Error('The file was renamed and Refined GitHub canâ€™t find it');
	}

	return associatedPR.commits.nodes[0].commit.oid;
});

function extractCommitFromHoverCardUrl(url: string): string {
	return /[/]commit[/]([0-9a-f]{40})[/]/i.exec(url)![1];
}

async function redirectToBlameCommit(event: DelegateEvent<MouseEvent, HTMLAnchorElement | HTMLButtonElement>): Promise<void> {
	const blameElement = event.delegateTarget;
	if (blameElement instanceof HTMLAnchorElement && !event.altKey) {
		return; // Unmodified click on regular link: let it proceed
	}

	event.preventDefault();
	blameElement.blur(); // Hide tooltip after click, itâ€™s shown on :focus

	const blameHunk = blameElement.closest('.react-blame-segment-wrapper')!;
	const prNumbers = $$('.issue-link', blameHunk).map(pr => looseParseInt(pr));
	const commitInfo = $('span[data-hovercard-url*="/commit/"]', blameHunk).dataset.hovercardUrl!;
	const prCommit = extractCommitFromHoverCardUrl(commitInfo);
	const blameUrl = new GitHubFileURL(location.href);

	await showToast(async () => {
		blameUrl.branch = await getPullRequestBlameCommit(prCommit, prNumbers, blameUrl.filePath);
		blameUrl.hash = 'L' + $('.react-line-number', blameHunk).textContent;
		location.href = blameUrl.href;
	}, {
		message: 'Fetching pull request',
		doneMessage: 'Redirecting',
	});
}

function addButton(hunk: HTMLElement): void {
	const reblameLink = $optional('a[aria-labelledby^="reblame-"]', hunk);
	if (reblameLink) {
		reblameLink.setAttribute('aria-label', 'View blame prior to this change. Hold `Alt` to extract commits from this PR first');
		reblameLink.classList.add('rgh-deep-reblame');
	} else {
		$('.timestamp-wrapper-mobile', hunk).after(
			<button
				type="button"
				aria-label={multilineAriaLabel(
					'View blame prior to this change',
					'(extracts commits from this PR first)',
				)}
				className="rgh-deep-reblame Button Button--iconOnly Button--invisible Button--small d-flex"
			>
				<VersionsIcon />
			</button>,
		);
	}
}

async function init(signal: AbortSignal): Promise<void> {
	await expectToken();

	delegate('.rgh-deep-reblame', 'click', redirectToBlameCommit, {signal});
	observe('.react-blame-for-range:has([data-hovercard-type="pull_request"])', addButton, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isBlame,
	],
	init,
});

/*

Test URLs:

https://github.com/refined-github/refined-github/blame/af0dd20dde497ac9dcec9cda47bee80902121298/source/features/deep-reblame.tsx

*/



================================================
FILE: source/features/default-branch-button.css
================================================
/* TODO: Revert https://github.com/refined-github/refined-github/pull/7859 in March 2025 */
/* The `details` version is for GHE. The `button` in the selector avoids a GHE conflict. `fuchsia` is to highlight broken styles. */
button.rgh-highlight-non-default-branch,
details.rgh-highlight-non-default-branch > summary {
	background-color: var(
		--bgColor-accent-muted,
		var(--color-accent-subtle, fuchsia)
	) !important;
	color: var(--fgColor-accent, var(--color-accent-fg, fuchsia)) !important;
	border-color: var(
		--fgColor-accent,
		var(--color-accent-fg, fuchsia)
	) !important;
}

button.rgh-highlight-non-default-branch svg,
details.rgh-highlight-non-default-branch > summary svg {
	color: var(--fgColor-accent, var(--color-accent-fg, fuchsia)) !important;
}



================================================
FILE: source/features/default-branch-button.tsx
================================================
import './default-branch-button.css';

import React from 'dom-chef';
import * as pageDetect from 'github-url-detection';
import ChevronLeftIcon from 'octicons-plain-react/ChevronLeft';
import {$optional} from 'select-dom/strict.js';
import memoize from 'memoize';

import features from '../feature-manager.js';
import GitHubFileURL from '../github-helpers/github-file-url.js';
import {groupButtons} from '../github-helpers/group-buttons.js';
import getDefaultBranch from '../github-helpers/get-default-branch.js';
import observe from '../helpers/selector-observer.js';
import {branchSelector} from '../github-helpers/selectors.js';
import isDefaultBranch from '../github-helpers/is-default-branch.js';
import {fixFileHeaderOverlap, isRepoCommitListRoot} from '../github-helpers/index.js';
import {expectToken} from '../github-helpers/github-token.js';

const getUrl = memoize(async (currentUrl: string): Promise<string> => {
	const defaultUrl = new GitHubFileURL(currentUrl);
	if (pageDetect.isRepoRoot()) {
		// The default branch of the root directory is just /user/repo/
		defaultUrl.route = '';
		defaultUrl.branch = '';
	} else {
		defaultUrl.branch = await getDefaultBranch();
	}

	return defaultUrl.href;
});

async function updateUrl(event: React.MouseEvent<HTMLAnchorElement>): Promise<void> {
	event.currentTarget.href = await getUrl(location.href);
}

function wrapButtons(buttons: HTMLElement[]): void {
	groupButtons(buttons, 'd-flex', 'rgh-default-branch-button-group');

	// `rounded-left-0` is for Firefox
	// https://github.com/refined-github/refined-github/pull/8030
	buttons.at(-1)!.classList.add('rounded-left-0');
}

async function add(branchSelector: HTMLElement): Promise<void> {
	// The DOM varies between details-based DOM and React-based one
	const selectorWrapper = branchSelector.tagName === 'SUMMARY'
		? branchSelector.parentElement!
		: branchSelector;
	selectorWrapper.classList.add('rgh-highlight-non-default-branch');

	const existingLink = $optional('.rgh-default-branch-button', branchSelector.parentElement!);

	// React issues. Duplicates appear after a color scheme update
	// https://github.com/refined-github/refined-github/issues/7098
	if (existingLink) {
		// Border radius style is removed by the color scheme update
		wrapButtons([existingLink, selectorWrapper]);
		return;
	}

	if (pageDetect.isSingleFile()) {
		fixFileHeaderOverlap(branchSelector);
	}

	const defaultLink = (
		<a
			className="btn tooltipped tooltipped-se px-2 rgh-default-branch-button flex-self-start"
			href={await getUrl(location.href)}
			aria-label="See this view on the default branch"
			// Update on hover because the URL may change without a DOM refresh
			// https://github.com/refined-github/refined-github/issues/6554
			// Inlined listener because `mouseenter` is too heavy for `delegate`
			onMouseEnter={updateUrl}

			// Don't enable AJAX on this behavior because we need a full page reload to drop the button, same reason as above #6554
			// data-turbo-frame="repo-content-turbo-frame"
		>
			<ChevronLeftIcon />
		</a>
	);

	selectorWrapper.before(defaultLink);
	wrapButtons([defaultLink, selectorWrapper]);
}

async function init(signal: AbortSignal): Promise<void> {
	await expectToken();
	observe(branchSelector, add, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isRepoTree,
		pageDetect.isSingleFile,
		isRepoCommitListRoot,
	],
	exclude: [
		isDefaultBranch,
	],
	init,
});

/*

Test URLs:

- isRepoTree https://github.com/refined-github/refined-github/tree/07ecc75
- isSingleFile, 410 Gone from default branch https://github.com/refined-github/refined-github/blob/07ecc75/extension/content.js
- isRepoCommitList: https://github.com/refined-github/refined-github/commits/07ecc75/
- isRepoCommitList (already on default branch): https://github.com/typed-ember/ember-cli-typescript/commits/master
- isRepoCommitListRoot (no branch selector): https://github.com/refined-github/refined-github/commits/07ecc75/extension
- `isRepoHome`, long branch name: https://github.com/refined-github/sandbox/tree/very-very-long-long-long-long-branch-name

*/



================================================
FILE: source/features/dim-bots.css
================================================
.rgh-dim-bots {
	& > *,
	& .Box-row--drag-hide {
		transition: 100ms opacity; /* Match `mark-merge-commits-in-list` */
	}

	/* Commit titles, dim */
	&:not(.rgh-tagged, :hover) > *,
	/* PR row, dim */
		&:not(.rgh-tagged, :hover)
		.Box-row--drag-hide {
		opacity: 50%; /* Match `mark-merge-commits-in-list` */
	}

	&:not(.rgh-tagged, .rgh-interacted) {
		/* Reset commit title spacing */
		.min-width-0 .mb-1 {
			margin-bottom: 0 !important;
		}

		.mb-1 ~ * /* Commit metadata */,
		.dropdown-signed-commit /* Commit verified label */,
		.flex-shrink-0 .BtnGroup /* Commit buttons on side */,
		.min-width-0 > :is(.d-block, .d-flex) /* PR */ {
			display: none !important;
		}
	}
}



================================================
FILE: source/features/dim-bots.tsx
================================================
import './dim-bots.css';

import {$$} from 'select-dom';
import * as pageDetect from 'github-url-detection';
import delegate, {type DelegateEvent} from 'delegate-it';

import features from '../feature-manager.js';
import preserveScroll from '../helpers/preserve-scroll.js';
import observe from '../helpers/selector-observer.js';
import {botLinksCommitSelectors, botLinksPrSelectors} from '../github-helpers/selectors.js';
import {getIdentifiers} from '../helpers/feature-helpers.js';

const botLinksCommitSelectorsExceptCopilot = botLinksCommitSelectors.map(
	selector => `${selector}:not([href*="copilot"])`,
);

const dimBots = getIdentifiers(import.meta.url);

const interactiveElementsSelector = 'a, button, input, [tabindex]';

function undimBots(event: DelegateEvent): void {
	const target = event.target as HTMLElement;
	// Only undim when clicking on empty areas
	if (target.closest(interactiveElementsSelector)) {
		return;
	}

	const resetScroll = preserveScroll(target);
	for (const bot of $$(dimBots.selector)) {
		bot.classList.add('rgh-interacted');
	}

	resetScroll();
}

function dim(commit: HTMLElement): void {
	commit.closest([
		'[data-testid="commit-row-item"]',

		'.Box-row', // PRs
	])!.classList.add(dimBots.class);
}

async function init(signal: AbortSignal): Promise<void> {
	observe([...botLinksCommitSelectorsExceptCopilot, ...botLinksPrSelectors], dim, {signal});

	// Undim on mouse focus
	delegate(dimBots.selector, 'click', undimBots, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isCommitList,
		pageDetect.isIssueOrPRList,
	],
	init,
});

/*

Test URLs

- Commits: https://github.com/typed-ember/ember-cli-typescript/commits/master?after=5ff0c078a4274aeccaf83382c0d6b46323f57397+174
- Commits by unmarked bot: https://github.com/rust-lang/rust/commits/master?after=c387f012b14a3d64e0d580b7ebe65e5325bcf822+34&branch=master&qualified_name=refs%2Fheads%2Fmaster
- PRs: https://github.com/OctoLinker/OctoLinker/pulls?q=is%3Apr+is%3Aclosed
- PRs by unmarked bot: https://github.com/spotify/scio/pulls?q=is%3Apr+sort%3Aupdated-desc+is%3Aclosed+steward
- PR Commits: https://github.com/pixiebrix/webext-messenger/pull/173/commits

*/



================================================
FILE: source/features/download-folder-button.tsx
================================================
import React from 'dom-chef';
import {$, $optional} from 'select-dom/strict.js';
import * as pageDetect from 'github-url-detection';
import DownloadIcon from 'octicons-plain-react/Download';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';
import replaceElementTypeInPlace from '../helpers/recreate-element.js';

function add(menu: HTMLUListElement): void {
	const downloadUrl = new URL('https://download-directory.github.io/');
	downloadUrl.searchParams.set('url', location.href);

	const item = menu.firstElementChild!.cloneNode(true);
	item.role = 'none';
	item.removeAttribute('tabindex');
	item.removeAttribute('id');
	item.removeAttribute('aria-keyshortcuts');
	item.removeAttribute('aria-labelledby');

	const link = item.firstElementChild instanceof HTMLAnchorElement
		? item.firstElementChild
		// Not a link on permalinks and archived repos
		: replaceElementTypeInPlace(item.firstElementChild!, 'a');
	link.href = downloadUrl.href;
	link.classList.add('no-underline', 'fgColor-inherit');
	link.setAttribute('aria-keyshortcuts', 'c');

	// Missing on permalinks and archived repos
	$optional('svg', link)?.replaceWith(<DownloadIcon />);

	// Only on permalinks and archived repos
	$optional('[id$="--trailing-visual"]', link)?.remove();

	$('[id$="--label"]', link).textContent = 'Download directory';

	menu.prepend(item);
}

function init(signal: AbortSignal): void {
	observe('ul[role="menu"]:has([aria-keyshortcuts="c"])', add, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isRepoTree,
	],
	exclude: [
		pageDetect.isRepoRoot, // Already has an native download ZIP button
		pageDetect.isEnterprise,
	],
	init,
});

/*

Test URLs

- Own repo: https://github.com/refined-github/refined-github/tree/main/.github
- Archived repo: https://github.com/fregante/object-fit-images/tree/master/demo

*/



================================================
FILE: source/features/easy-toggle-commit-messages.tsx
================================================
import {$optional} from 'select-dom/strict.js';
import * as pageDetect from 'github-url-detection';
import delegate, {type DelegateEvent} from 'delegate-it';

import features from '../feature-manager.js';

const activeElementsSelector = 'a, button, clipboard-copy, details';

function toggleCommitMessage(event: DelegateEvent<MouseEvent>): void {
	// The clicked element is a button, a link or a popup ("Verified" badge, CI details, etc.)
	const elementClicked = event.target as HTMLElement;
	if (elementClicked.closest(activeElementsSelector)) {
		return;
	}

	// There is text selection
	if (globalThis.getSelection()?.toString().length !== 0) {
		return;
	}

	$optional([
		'[data-testid="commit-row-show-description-button"]', // Commit list
		'[data-testid="latest-commit-details-toggle"]', // File/folder
	], event.delegateTarget)?.dispatchEvent(
		new MouseEvent('click', {bubbles: true, altKey: event.altKey}),
	);
}

const commitMessagesSelector = [
	'[data-testid="commit-row-item"]',
	'[data-testid="latest-commit"]', // Commit message in file tree header
];

function init(signal: AbortSignal): void {
	delegate(commitMessagesSelector, 'click', toggleCommitMessage, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isCommitList,
		pageDetect.isCompare,
		pageDetect.isRepoTree,
		pageDetect.isSingleFile,
	],
	exclude: [
		pageDetect.isRepoFile404,
	],
	init,
});

/*

Test URLs:

- Repo root: https://github.com/refined-github/sandbox/tree/254a81ef488dcb3866cf8a4cacde501d9faaa588
- Commit list: https://github.com/refined-github/refined-github/commits/main/?after=384131b0be3d4097f7cc633f76aecd43f1292471+69
- File/folder: https://github.com/refined-github/sandbox/tree/254a81ef488dcb3866cf8a4cacde501d9faaa588/.github/workflows

How to test:

1. Ensure that clicking the ellipsis can still expand/elide the commit message correctly.
2. Ensure that clicking next to the ellipsis can also expand/elide the commit message.
3. Ensure that clicking on the expanded commit message can elide it.
4. Ensure that selecting texts in the expanded commit message would not elide it.

*/



================================================
FILE: source/features/easy-toggle-files.tsx
================================================
import {$} from 'select-dom/strict.js';
import delegate, {type DelegateEvent} from 'delegate-it';
import * as pageDetect from 'github-url-detection';

import {codeSearchHeader} from '../github-helpers/selectors.js';
import features from '../feature-manager.js';

function toggleFile(event: DelegateEvent<MouseEvent>): void {
	const elementClicked = event.target as HTMLElement;
	const headerBar = event.delegateTarget;

	// Exclude interactive elements
	if (!elementClicked.closest(['a', 'button', 'clipboard-copy', 'details'])) {
		$('button:has(> .octicon-chevron-down, > .octicon-chevron-right)', headerBar)
			.dispatchEvent(new MouseEvent('click', {bubbles: true, altKey: event.altKey}));
	}
}

function toggleCodeSearchFile(event: DelegateEvent<MouseEvent>): void {
	const elementClicked = event.target as HTMLElement;
	const headerBar = event.delegateTarget;
	const toggle = $(':scope > button', headerBar);

	// The clicked element is either the bar itself or one of its children excluding the button
	if (elementClicked === headerBar || (elementClicked.parentElement === headerBar && elementClicked !== toggle)) {
		toggle.dispatchEvent(new MouseEvent('click', {bubbles: true, altKey: event.altKey}));
	}
}

function init(signal: AbortSignal): void {
	delegate([
		'.file-header',
		// React
		'[class^="Diff-module__diffHeaderWrapper"]',
	], 'click', toggleFile, {signal});
}

function initSearchPage(signal: AbortSignal): void {
	delegate(codeSearchHeader, 'click', toggleCodeSearchFile, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.hasFiles,
		pageDetect.isGistRevision,
	],
	init,
}, {
	include: [
		pageDetect.isGlobalSearchResults,
	],
	init: initSearchPage,
});

/*

## Test URLs

- Pull Request: https://github.com/refined-github/refined-github/pull/7036/files
- Code Search: https://github.com/search?q=repo%3Arefined-github%2Frefined-github%20easy&type=code

*/



================================================
FILE: source/features/embed-gist-inline.tsx
================================================
import React from 'dom-chef';
import domify from 'doma';
import * as pageDetect from 'github-url-detection';
import mem from 'memoize';
import {messageRuntime} from 'webext-msg';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';
import {standaloneGistLinkInMarkdown} from '../github-helpers/selectors.js';

type GistData = {
	div: string;
	files: unknown[];
	stylesheet: string;
};

// Fetch via background.js due to CORB policies. Also memoize to avoid multiple requests.
const fetchGist = mem(
	async (url: string): Promise<GistData> =>
		messageRuntime({fetchJSON: `${url}.json`}),
);

const isOnlyChild = (link: HTMLAnchorElement): boolean => link.textContent.trim() === link.parentElement!.textContent.trim();

async function embedGist(link: HTMLAnchorElement): Promise<void> {
	const info = <em> (loading)</em>;
	link.after(info);

	try {
		const gistData = await fetchGist(link.href);
		if (gistData.div.length > 10_000) {
			info.textContent = ' (too large to embed)';
			return;
		}

		const fileCount: number = gistData.files.length;
		if (fileCount > 1) {
			info.textContent = ` (${fileCount} files)`;
		} else {
			const container = <div />;
			container.attachShadow({mode: 'open'}).append(
				<style>{`
					.gist .gist-data {
						max-height: 16em;
						overflow-y: auto;
					}
				`}
				</style>,
				<link rel="stylesheet" href={gistData.stylesheet} />,
				domify.one(gistData.div)!,
			);
			link.parentElement!.after(container);
			info.remove();
		}
	} catch (error) {
		info.remove();
		throw error;
	}
}

function init(signal: AbortSignal): void {
	observe(standaloneGistLinkInMarkdown, link => {
		if (pageDetect.isGistFile(link) && isOnlyChild(link)) {
			void embedGist(link);
		}
	}, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.hasComments,
	],
	init,
});

/*

Test URLs

https://github.com/refined-github/sandbox/issues/77

*/



================================================
FILE: source/features/emphasize-draft-pr-label.css
================================================
/* Explanation for the feature in https://github.com/refined-github/refined-github/pull/4728#issuecomment-910630727 */

@media (min-resolution: 2x) {
	html:not([rgh-OFF-emphasize-draft-pr-label]) {
		/* Dashboard PR lists */
		div[class*='DashboardListView-module__ItemLeadingVisual'] svg[aria-label='Status: Draft (not ready).'],
		.js-issue-row
			/* biome-ignore format: bug */
			:is(
				/* Repo PR lists */
					[aria-label='Open draft pull request'],
				/* Global PR lists */
					[aria-label='Draft Pull Request']
			)
			svg,
		/* React issue list */
			[aria-label*='Status: Draft (not ready)']
			[data-testid='list-row-state-icon']
			svg,
		/* Notification select by */
			.rgh-select-notifications .octicon-git-pull-request-draft,
		/* Notification list */
			.notification-list-item-link .octicon-git-pull-request-draft {
			stroke: var(--fgColor-muted, var(--color-fg-muted, fuchsia));
			stroke-width: 1.2px;
			color: var(--rgh-background, fuchsia) !important;
			paint-order: stroke;
			overflow: visible !important;
		}
	}
}



================================================
FILE: source/features/emphasize-draft-pr-label.tsx
================================================
import './emphasize-draft-pr-label.css';

import features from '../feature-manager.js';

void features.addCssFeature(import.meta.url);

/*

Test URLs:

- https://github.com/refined-github/refined-github/pulls
- https://github.com/pulls

*/



================================================
FILE: source/features/esc-to-cancel.tsx
================================================
import {$} from 'select-dom/strict.js';
import type {DelegateEvent} from 'delegate-it';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import {onConversationTitleFieldKeydown} from '../github-events/on-field-keydown.js';

function handleEscPress(event: DelegateEvent<KeyboardEvent>): void {
	if (event.key === 'Escape') {
		$('.js-cancel-issue-edit').click();

		event.stopImmediatePropagation();
		event.preventDefault();
	}
}

function init(signal: AbortSignal): void {
	onConversationTitleFieldKeydown(handleEscPress, signal);
}

// TODO: Drop in March 2025, implemented by GitHub
// https://github.com/refined-github/refined-github/pull/7892
void features.add(import.meta.url, {
	shortcuts: {
		esc: 'Cancel editing a conversation title',
	},
	include: [
		pageDetect.isIssue,
		pageDetect.isPR,
	],
	init,
});

/*

Test URLs:

1. Visit https://github.com/issues?q=+archived%3Afalse+author%3A%40me
2. Open any issue/PR
3. Try to edit the title
4. Press Esc

*/



================================================
FILE: source/features/esc-to-deselect-line.tsx
================================================
import {$optional} from 'select-dom/strict.js';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import {isEditable} from '../helpers/dom-utils.js';
import removeHashFromUrlBar from '../helpers/history.js';

function isLineSelected(): boolean {
	// Example hashes:
	// #L1
	// #L1-L7
	// #diff-1030ad175a393516333e18ea51c415caR1
	return /^#L|^#diff-[\da-f]+R\d+/.test(location.hash);
}

function listener({key, target}: KeyboardEvent): void {
	if (key === 'Escape' && isLineSelected() && !isEditable(target)) {
		const selectedLineNumber = $optional('.react-line-number.highlighted-line');

		if (selectedLineNumber) {
			// Save and remove line number
			const {lineNumber} = selectedLineNumber.dataset;
			selectedLineNumber.dataset.lineNumber = '';
			// Trigger click to deselect
			selectedLineNumber.dispatchEvent(new MouseEvent('mousedown', {bubbles: true}));
			// Restore line number
			selectedLineNumber.dataset.lineNumber = lineNumber;
			// Un-focus code block
			(document.activeElement as HTMLElement).blur();
		} else {
			// TODO: Review in December 2025 if old UI is gone. Currently only applies to PRs
			location.hash = '#no-line'; // Update UI, without `scroll-to-top` behavior
		}

		removeHashFromUrlBar();
	}
}

function init(signal: AbortSignal): void {
	document.body.addEventListener('keyup', listener, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.hasCode,
	],
	init,
});

/*

Test URLs:

1. Visit https://github.com/refined-github/refined-github/blob/132272786fdc058193e089d8c06f2a158844e101/source/features/esc-to-deselect-line.tsx#L11
2. Press Esc
3. See selected line become deselected

*/



================================================
FILE: source/features/expand-all-hidden-comments.tsx
================================================
import {$optional} from 'select-dom/strict.js';
import oneEvent from 'one-event';
import delegate, {type DelegateEvent} from 'delegate-it';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import showToast from '../github-helpers/toast.js';
import {paginationButtonSelector} from '../github-helpers/selectors.js';

// eslint-disable-next-line @typescript-eslint/explicit-function-return-type
async function expandHidden(paginationButton: HTMLButtonElement | undefined) {
	let wrapper: Element = paginationButton!.form!.parentElement!;
	const isExpandingMainThread = wrapper.id === 'js-progressive-timeline-item-container';

	while (paginationButton) {
		// eslint-disable-next-line no-await-in-loop
		await oneEvent(paginationButton.form!, 'page:loaded');
		if (isExpandingMainThread) {
			// Pagination forms in the main thread load their content in a nested wrapper
			wrapper = wrapper.lastElementChild!;
		}

		paginationButton = $optional(`:scope > ${paginationButtonSelector}`, wrapper);
		paginationButton?.click();
	}
}

async function handleAltClick({altKey, delegateTarget}: DelegateEvent<MouseEvent, HTMLButtonElement>): Promise<void> {
	if (!altKey) {
		return;
	}

	await showToast(expandHidden(delegateTarget), {
		message: 'Expandingâ€¦',
		doneMessage: 'Expanded',
	});
}

function init(signal: AbortSignal): void {
	delegate(paginationButtonSelector, 'click', handleAltClick, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isConversation,
	],
	init,
});

/*
Test URLs
https://github.com/rust-lang/rfcs/pull/2544
*/



================================================
FILE: source/features/extend-conversation-status-filters.tsx
================================================
import React from 'dom-chef';
import {$optional} from 'select-dom/strict.js';
import CheckIcon from 'octicons-plain-react/Check';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import SearchQuery from '../github-helpers/search-query.js';
import observe from '../helpers/selector-observer.js';

function addMergeLink(lastLink: HTMLAnchorElement): void {
	// It's shouldn't be added in issues list
	if (!pageDetect.isPRList()) {
		return;
	}

	const locationQuery = SearchQuery.from(location);
	const isMerged = locationQuery.includes('is:merged');
	const isUnmerged = locationQuery.includes('is:unmerged');

	// The links in `.table-list-header-toggle` are either:
	//   1 Open | 1 Closed
	//   1 Total            // Apparently appears with is:merged/is:unmerged
	if (isMerged) {
		// It's a "Total" link for "is:merged"
		lastLink.lastChild!.textContent = lastLink.lastChild!.textContent.replace('Total', 'Merged');
		return;
	}

	if (isUnmerged) {
		// It's a "Total" link for "is:unmerged"
		lastLink.lastChild!.textContent = lastLink.lastChild!.textContent.replace('Total', 'Unmerged');
		return;
	}

	// In this case, `lastLink` is expected to be a "Closed" link
	const mergeLink = lastLink.cloneNode(true);
	mergeLink.textContent = 'Merged';
	mergeLink.classList.toggle('selected', isMerged);
	mergeLink.href = SearchQuery.from(mergeLink).replace('is:closed', 'is:merged').href;
	lastLink.after(' ', mergeLink);
}

function removeAllFilters(link: HTMLAnchorElement): void {
	if (link === link.parentElement!.lastElementChild) {
		addMergeLink(link);
	}

	$optional('.octicon', link)?.remove();
	if (link.classList.contains('selected')) {
		link.prepend(<CheckIcon />);
		link.href = SearchQuery
			.from(link)
			.remove(
				'is:open',
				'is:closed',
				'is:merged',
				'is:unmerged',
			)
			.href;
	}
}

function init(signal: AbortSignal): void {
	observe('.table-list-header-toggle.states a', removeAllFilters, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isRepoIssueOrPRList,
		pageDetect.isGlobalIssueOrPRList,
	],
	init,
});

/*

Test URLs:

- Regular: https://github.com/sindresorhus/refined-github/pulls
- "Merged" view: https://github.com/sindresorhus/refined-github/pulls?q=is%3Apr+sort%3Aupdated-desc+is%3Amerged

*/



================================================
FILE: source/features/extend-diff-expander.css
================================================
/* TODO: Revert https://github.com/refined-github/refined-github/pull/8111 in April 2025 */
/* Hovering the line will highlight the first direction button, unless you hover the buttons directly */
.rgh-extend-diff-expander .js-expandable-line:hover
	:is(
		.blob-num:not(:hover) .directional-expander:first-child,
		.blob-num:not(:hover) + .blob-code
	) {
	color: var(
		--control-checked-fgColor-rest,
		var(--color-state-hover-primary-text, var(--color-fg-on-emphasis, fuchsia))
	);
	background: var(
		--control-checked-bgColor-hover,
		var(--color-state-hover-primary-bg, var(--color-accent-emphasis, fuchsia))
	);
	border-color: var(
		--control-checked-borderColor-hover,
		var(
			--color-state-hover-primary-border,
			var(--color-accent-emphasis, fuchsia)
		)
	);
	cursor: pointer;
}

/* Support react commit view */
.rgh-extend-diff-expander .diff-line-row:has(button[data-direction]):hover {
	/* Color variables and fallbacks are copy-pasted from GitHub */
	color: var(
		--diffBlob-hunkNum-fgColor-hover,
		var(--fgColor-onEmphasis, fuchsia)
	);
	background: var(
		--diffBlob-hunkNum-bgColor-hover,
		var(--bgColor-accent-emphasis, fuchsia)
	);
	cursor: pointer;
	transition: var(--duration-fast) var(--easing-easeInOut);
	transition-property: color, fill, background-color, border-color;

	& button[data-direction] {
		color: var(
			--diffBlob-hunkNum-fgColor-hover,
			var(--fgColor-onEmphasis, fuchsia)
		);
		background: var(
			--diffBlob-hunkNum-bgColor-hover,
			var(--bgColor-accent-emphasis, fuchsia)
		);
	}
}



================================================
FILE: source/features/extend-diff-expander.tsx
================================================
import './extend-diff-expander.css';

import {$} from 'select-dom/strict.js';
import delegate, {type DelegateEvent} from 'delegate-it';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';

const lineSelectors = [
	'.diff-view .js-expandable-line', // Expandable lines in old view
	'.diff-line-row:has(button[data-direction])', // React view
];

const nativeButtonSelector = [
	'.js-expand', // Expand button in old view
	'button[data-direction]', // React view
];

function expandDiff(event: DelegateEvent): void {
	// Skip if the user clicked directly on the icon
	if (!(event.target as Element).closest(nativeButtonSelector)) {
		$(nativeButtonSelector, event.delegateTarget).click();
	}
}

function init(signal: AbortSignal): void {
	document.body.classList.add('rgh-extend-diff-expander');
	delegate(lineSelectors, 'click', expandDiff, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.hasFiles,
	],
	init,
});

/*

Test URLs:

- PR: https://github.com/refined-github/refined-github/pull/940/files
- Compare: https://github.com/microsoft/TypeScript/compare/v4.1.2...v4.1.3
- Commit: https://github.com/microsoft/TypeScript/commit/9d25e593ab722d9cf203690de94e36f8588e968e
*/



================================================
FILE: source/features/file-age-color.tsx
================================================
/*

This feature is documented at https://github.com/refined-github/refined-github/wiki/Customization

*/

import * as pageDetect from 'github-url-detection';

import observe from '../helpers/selector-observer.js';
import features from '../feature-manager.js';
import {createHeatIndexFunction} from '../helpers/math.js';

const calculateHeatIndex = createHeatIndexFunction([0, -2_000_000_000]);

function addHeatIndex(lastUpdateElement: HTMLElement): void {
	// `datetime` attribute used by pre-React version
	const lastUpdate = new Date(lastUpdateElement.getAttribute('datetime') ?? lastUpdateElement.title);
	const diff = Date.now() - lastUpdate.getTime();

	lastUpdateElement.setAttribute('data-rgh-heat', String(calculateHeatIndex(-diff)));
}

function init(signal: AbortSignal): void {
	observe('.react-directory-commit-age > [title]', addHeatIndex, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isRepoTree,
	],
	exclude: [
		pageDetect.isRepoFile404,
	],
	init,
});

/*

Test URLs:

https://github.com/refined-github/refined-github
https://github.com/refined-github/refined-github/tree/main/source

*/



================================================
FILE: source/features/fit-textareas.css
================================================
.rgh-fit-textareas {
	min-height: 4.5lh;
	max-height: none !important;
	field-sizing: content;
}

:root textarea.rgh-fit-textareas.form-control {
	height: auto;
}



================================================
FILE: source/features/fit-textareas.tsx
================================================
import './fit-textareas.css';

import {isSafari} from 'webext-detect';
import fitTextarea from 'fit-textarea';
import {$} from 'select-dom/strict.js';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';

const nativeFit = CSS.supports('field-sizing', 'content');

function resetListener({target}: Event): void {
	const field = $('textarea', target as HTMLFormElement);
	// Delay because the field is still filled while the `reset` event is firing
	setTimeout(fitTextarea, 0, field);
}

function inputListener({target}: Event): void {
	fitTextarea(target as HTMLTextAreaElement);
}

function watchTextarea(textarea: HTMLTextAreaElement, {signal}: SignalAsOptions): void {
	// Disable constrained GitHub feature
	textarea.classList.remove('size-to-fit', 'js-size-to-fit', 'issue-form-textarea'); // Remove !important height and min-height
	textarea.classList.add('rgh-fit-textareas');

	if (nativeFit) {
		return;
	}

	textarea.addEventListener('input', inputListener, {signal}); // The user triggers `input` event
	textarea.addEventListener('focus', inputListener, {signal}); // The user triggers `focus` event
	textarea.addEventListener('change', inputListener, {signal}); // File uploads trigger `change` events
	textarea.form?.addEventListener('reset', resetListener, {signal});
	fitTextarea(textarea);
}

function init(signal: AbortSignal): void {
	// `anchored-position`: Exclude PR review box because it's in a `position:fixed` container; The scroll HAS to appear within the fixed element.
	// `#pull_request_body_ghost`: Special textarea that GitHub just matches to the visible textarea
	observe(`
		textarea:not(
			anchored-position #pull_request_review_body,
			#pull_request_body_ghost,
			#pull_request_body_ghost_ruler
		)
	`, watchTextarea, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.hasRichTextEditor,
	],
	exclude: [
		// Allow Safari only if it supports the native version
		() => isSafari() && !nativeFit,
	],
	init,
});

/*

Test URLs:

https://github.com/refined-github/sandbox/issues/3

*/



================================================
FILE: source/features/fix-no-pr-search.tsx
================================================
import * as pageDetect from 'github-url-detection';
import delegate, {type DelegateEvent} from 'delegate-it';

import features from '../feature-manager.js';
import SearchQuery from '../github-helpers/search-query.js';

function redirectToIssues(event: DelegateEvent<Event, HTMLFormElement>): void {
	const form = event.delegateTarget;
	const query = SearchQuery.from(location);
	query.set(form.elements['js-issues-search'].value);

	if (!query.includes('is:pr')) {
		form.action = form.action.replace(/\/pulls$/, '/issues');
		// Prevent submission via AJAX and use .submit() to allow the change from /pulls to /issues
		// https://github.com/refined-github/refined-github/pull/7614/files#r1694731354
		event.preventDefault();
		form.submit();
	}
}

function init(signal: AbortSignal): void {
	delegate('form.subnav-search[action$="/pulls"]', 'submit', redirectToIssues, {
		signal,
		capture: true,
	});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isPRList,
	],
	init,
});

/*

Test URLs:

https://github.com/pulls
https://github.com/refined-github/refined-github/pulls

1. Open the url above
2. Remove the "is:pr" from the search input and submit
3. You should be redirected to the "Issues" tab

*/



================================================
FILE: source/features/github-actions-indicators.gql
================================================
query GetWorkflows($owner: String!, $name: String!) {
	repository(owner: $owner, name: $name) {
		workflowFiles: object(expression: "HEAD:.github/workflows") {
			... on Tree {
				entries {
					name
					object {
						... on Blob {
							text
						}
					}
				}
			}
		}
	}
}



================================================
FILE: source/features/github-actions-indicators.tsx
================================================
import {CachedFunction} from 'webext-storage-cache';
import React from 'dom-chef';
import {$} from 'select-dom/strict.js';
import PlayIcon from 'octicons-plain-react/Play';
import {parseCron} from '@fregante/mi-cron';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import api from '../github-helpers/api.js';
import {cacheByRepo} from '../github-helpers/index.js';
import observe from '../helpers/selector-observer.js';
import GetWorkflows from './github-actions-indicators.gql';
import {expectToken} from '../github-helpers/github-token.js';
import removeHashFromUrlBar from '../helpers/history.js';

type Workflow = {
	name: string;
	isEnabled: boolean;
};

type WorkflowDetails = {
	schedules: string[];
	manuallyDispatchable: boolean;
};

// There is no way to get a workflow list in the v4 API #6543
async function getWorkflows(): Promise<Workflow[]> {
	const response = await api.v3('actions/workflows');

	const workflows = response.workflows as any[];

	// The response is not reliable: Some workflow's path is '' and deleted workflow's state is 'active'
	return workflows
		.map<Workflow>(workflow => ({
			name: workflow.path.split('/').pop()!,
			isEnabled: workflow.state === 'active',
		}));
}

async function getFilesInWorkflowPath(): Promise<Record<string, string>> {
	const {repository: {workflowFiles}} = await api.v4(GetWorkflows);

	const workflows: any[] = workflowFiles?.entries ?? [];

	const result: Record<string, string> = {};
	for (const workflow of workflows) {
		result[workflow.name] = workflow.object.text;
	}

	return result;
}

const workflowDetails = new CachedFunction('workflows-details', {
	async updater(): Promise<Record<string, Workflow & WorkflowDetails>> {
		const [workflows, workflowFiles] = await Promise.all([getWorkflows(), getFilesInWorkflowPath()]);

		const details: Record<string, Workflow & WorkflowDetails> = {};

		for (const workflow of workflows) {
			const workflowYaml = workflowFiles[workflow.name];

			if (workflowYaml === undefined) {
				// Cannot find workflow yaml; workflow removed.
				continue;
			}

			const crons = [...workflowYaml.matchAll(/^(?: {4}|\t\t)-\s*cron[:\s'"]+([^'"\n]+)/gm)].map(match => match[1]);
			details[workflow.name] = {
				...workflow,
				schedules: crons,
				manuallyDispatchable: workflowYaml.includes('workflow_dispatch:'),
			};
		}

		return details;
	},
	maxAge: {days: 1},
	staleWhileRevalidate: {days: 10},
	cacheKey: cacheByRepo,
});

async function addIndicators(workflowLink: HTMLAnchorElement): Promise<void> {
	// Called in `init`, memoized
	const workflows = await workflowDetails.get();
	const workflowName = workflowLink.href.split('/').pop()!;
	const workflow = workflows[workflowName];
	if (!workflow) {
		return;
	}

	if (workflow.manuallyDispatchable && workflowLink.pathname !== location.pathname) {
		if (workflowLink.nextElementSibling) {
			const url = new URL(workflowLink.href);
			url.hash = 'rgh-run-workflow';
			workflowLink.after(
				<a
					href={url.href}
					data-turbo-frame={workflowLink.dataset.turboFrame}
					// `actions-unpin-button` provides the hover style
					className="tooltipped tooltipped-sw Button Button--iconOnly Button--invisible Button--medium color-bg-transparent actions-unpin-button"
					aria-label="Trigger manually"
				>
					<PlayIcon />
				</a>,
			);
		} else {
			// This class keeps the action on a single line. It natively exists if the item can be pinned (if current user has write access)
			workflowLink.parentElement!.classList.add('ActionListItem--withActions');
			workflowLink.after(
				<div
					className="tooltipped tooltipped-sw Button Button--iconOnly Button--invisible Button--medium color-bg-transparent"
					aria-label="This workflow can be triggered manually"
				>
					<PlayIcon />
				</div>,
			);
		}
	}

	let nextTime: Date | undefined;
	for (const schedule of workflow.schedules) {
		const time = parseCron.nextDate(schedule);
		if (time && (!nextTime || time < nextTime)) {
			nextTime = time;
		}
	}

	if (!nextTime) {
		return;
	}

	$('.ActionListItem-label', workflowLink).append(
		<em>
			(<relative-time datetime={String(nextTime)} />)
		</em>,
	);
}

async function init(signal: AbortSignal): Promise<false | void> {
	await expectToken();
	observe('a.ActionListContent', addIndicators, {signal});
}

function openRunWorkflow(): void {
	removeHashFromUrlBar();
	// Note that the attribute is removed after the first opening, so the selector only matches it once
	const dropdown = $('details[data-deferred-details-content-url*="/actions/manual?workflow="]');
	dropdown.open = true;
}

void features.add(import.meta.url, {
	asLongAs: [
		pageDetect.isRepositoryActions,
		async () => Boolean(await workflowDetails.get()),
	],
	init,
}, {
	include: [
		() => location.hash === '#rgh-run-workflow',
	],
	awaitDomReady: true,
	init: openRunWorkflow,
});

/*

## Test URLs

Manual + scheduled:
https://github.com/sindresorhus/type-fest/actions/workflows/ts-canary.yml

Manual + disabled + pinned:
https://github.com/refined-github/sandbox/actions

*/



================================================
FILE: source/features/github-bugs.css
================================================
/* Style backticked code in links #4817, matches GitHubâ€™s `.markdown-title code` rule */
/* `isCommitList` commit message */
[data-testid='commit-row-item'] code,
.Box-header .commit-author + span code /* `isRepoTree` commit message */ {
	padding: 2px 4px;
	background-color: var(
		--bgColor-neutral-muted,
		var(--color-neutral-muted, fuchsia)
	);
	font-size: 0.9em;
	line-height: 1;
	border-radius: 6px;
}

/* Limit width of comment form on commit pages #5032 */
#all_commit_comments .timeline-comment-wrapper {
	max-width: 780px; /* This is the limit applied on the comment thread by `.comment-holder` */
}

/* Fix spacing of repo header button icons #5620 */
.pagehead-actions :is(.btn, summary) .octicon:not(.octicon-triangle-down) {
	margin-right: 4px !important;
}

/* Align icons in the release search field #6506 */
/* Test: https://github.com/refined-github/refined-github/releases */
[action$='/releases'] .subnav-search-icon {
	margin-top: -1px;
}

#release-filter::-webkit-calendar-picker-indicator {
	margin-top: -4px;
}

/* Add margin to release download icon #6510 */
.Box-row :is(.octicon-package, .octicon-file-zip):has(+ a[rel='nofollow']) {
	margin-right: 4px;
}

/* Mute unclickable reaction buttons, disable hover */
/* Test: https://github.com/refined-github/sandbox/pull/48 */
:root .social-reaction-summary-item:disabled {
	filter: grayscale(0.5);
	background-color: transparent;
}

:root .social-reaction-summary-item.user-has-reacted:disabled {
	color: var(
		--reactionButton-selected-fgColor-rest,
		var(--color-accent-fg, fuchsia)
	);
	background-color: var(
		--reactionButton-selected-bgColor-rest,
		var(--color-accent-subtle, fuchsia)
	) !important;
}

/* Hide inactive comment box tabs #7108 */
/* Test: https://github.com/refined-github/sandbox/issues/74 */
.comment-form-head.tabnav:has(~ div .octicon-lock) {
	display: none;
}

/* Fit rendered markdown div to its content #7187 */
div.markdown-body {
	min-height: 2em !important;
}

/* Sponsor button in mobile view #7853 */
/* Test: https://github.com/refined-github/refined-github */
#dialog-show-responsive-sponsor-modal {
	width: var(--base-size-32);
	height: var(--base-size-32);
	padding: 0;
}

/* Notifications "Unread" dropdown  overlap (Safari, Mobile) */
/* Info: https://github.com/refined-github/refined-github/issues/7959 */
/* Test: https://github.com/notifications */
#dialog-show-notifications-tabs-nav ~ action-menu {
	flex-shrink: 0;
}

/* Long release asset download links break the layout */
/* Info: https://github.com/refined-github/refined-github/issues/8065 */
/* Test: https://github.com/hkint/xiaomi-ax3000t-immortalwrt-hanwckf-firmware-build/releases/tag/ImmortalWrt_2024.11.13-0026 */
svg.octicon-package + a.Truncate[href*='/releases/download/'] > .Truncate-text {
	white-space: wrap;
}

/* Notifications "Group by" button unnecessary space */
/* Info: https://github.com/refined-github/refined-github/pull/8208 */
/* Test: https://github.com/notifications */
/* Matches .d-md-block */
@media (width >= 768px) {
	/* Pulls the alert container to the right when empty */
	.gap-4.pl-3:not(:has(a.h6)):has(
			> .d-md-block
				> .js-socket-channel[data-url^='/notifications/beta/recent_notifications_alert']
		) {
		/* Subtract 16px spacing from both .gap-3 and .ml-3 */
		margin-right: -32px;
	}
}

/* Issue picker does not clip unbreakable issue titles in PRs */
/* Info: https://github.com/refined-github/refined-github/pull/8454 */
/* Test: type "#113" in https://github.com/refined-github/sandbox/pull/4 */
.suggester-container li {
	max-width: 500px;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
}

/* Fix button color contrast when deleting an unused tag */
/* Info: https://github.com/refined-github/refined-github/issues/8803 */
/* Test: https://github.com/refined-github/sandbox/tags */
.dropdown-item.btn-link.color-fg-danger:hover {
	color: var(--fgColor-onEmphasis, fuchsia) !important;
	background-color: var(--bgColor-danger-emphasis, fuchsia);
}

/*

Test URLs:

MAKE SURE TO ADD A ISSUE REFERENCE + TEST URL FOR EACH NEW RULE

*/



================================================
FILE: source/features/global-conversation-list-filters.css
================================================
/* Decrease the padding of filter buttons to accommodate the new buttons */
#issues_dashboard .subnav-links .subnav-item {
	padding-inline: 9px;
}



================================================
FILE: source/features/global-conversation-list-filters.tsx
================================================
import './global-conversation-list-filters.css';

import React from 'dom-chef';
import {$$, elementExists} from 'select-dom';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import SearchQuery from '../github-helpers/search-query.js';
import observe from '../helpers/selector-observer.js';

function createLink(label: string, title: string, query: string): HTMLElement {
	const url = new URL('/pulls', location.origin);
	url.searchParams.set('q', `is:open archived:false ${query}`);
	const link = <a href={url.href} title={title} className="subnav-item">{label}</a>;

	const isCurrentPage = SearchQuery.from(location).includes(query);

	// Highlight it, if that's the current page
	if (isCurrentPage && !elementExists('.subnav-links .selected')) {
		link.classList.add('selected');

		// Other links will keep the current query, that's not what we want
		for (const otherLink of $$('.subnav-links a')) {
			otherLink.href = SearchQuery.from(otherLink).remove(query).href;
		}
	}

	return link;
}

function addLinks(container: HTMLElement): void {
	container.append(
		createLink('Involved', 'Pull Requests youâ€™re involved in', 'involves:@me'),
		createLink('Yours', 'Pull Requests on your repos', 'user:@me'),
	);
}

function init(signal: AbortSignal): void {
	observe('.subnav-links', addLinks, {signal});
}

void features.add(import.meta.url, {
	asLongAs: [
		pageDetect.isGlobalIssueOrPRList,
		pageDetect.isPRList, // We don't have a single `isGlobalPRList`
	],
	init,
});

/*

Test URLs:

https://github.com/pulls

*/



================================================
FILE: source/features/hidden-review-comments-indicator.css
================================================
:root .rgh-comments-indicator {
	position: absolute;
}

.show-inline-notes .rgh-comments-indicator {
	display: none;
}

.rgh-comments-indicator:is(::before, ::after) {
	content: '' !important; /* Needs to override .blob-numâ€™s */
	position: absolute;
	top: -1px;
	left: 0;
	width: 200%;
	border-top: solid 1px;
	opacity: 40%;
	transform: translateY(-50%);
}

/* This is only used to improve the clickability */
.rgh-comments-indicator::after {
	border-top-width: 5px;
	color: transparent;
}

/* Split diffs only have 1 line number on the left */
.file-diff-split .rgh-comments-indicator:is(::before, ::after) {
	width: 100%;
}

.rgh-comments-indicator button {
	position: absolute;
	right: 100%;
	transform: translateY(-50%);
	padding: 5px 8px;
	color: inherit;
	text-decoration: none !important; /* Needs to override .btn-linkâ€™s */
	font-family: sans-serif;
}

.rgh-comments-indicator span {
	margin-left: 3px;
}

/* Split diffs fill the screen so there's only 18px available. We only show the icon */
.file-diff-split .rgh-comments-indicator span {
	display: none;
}

.file-diff-split .rgh-comments-indicator button {
	padding-right: 1px;
}



================================================
FILE: source/features/hidden-review-comments-indicator.tsx
================================================
import './hidden-review-comments-indicator.css';

import mem from 'memoize';
import React from 'dom-chef';
import {$$, countElements} from 'select-dom';
import CommentIcon from 'octicons-plain-react/Comment';
import * as pageDetect from 'github-url-detection';
import delegate, {type DelegateEvent} from 'delegate-it';
import {onAbort} from 'abort-utils';

import features from '../feature-manager.js';
import preserveScroll from '../helpers/preserve-scroll.js';
import observe from '../helpers/selector-observer.js';

// When an indicator is clicked, this will show comments on the current file
function handleIndicatorClick({delegateTarget}: DelegateEvent): void {
	const commentedLine = delegateTarget.closest('tr')!.previousElementSibling!;
	const resetScroll = preserveScroll(commentedLine);
	delegateTarget
		.closest('.file.js-file')!
		.querySelector('input.js-toggle-file-notes')!
		.click();

	resetScroll();
}

// `mem` avoids adding the indicator twice to the same thread
const addIndicator = mem((commentThread: HTMLElement): void => {
	const commentCount = countElements('.review-comment.js-comment', commentThread);
	commentThread.before(
		<tr>
			<td className="rgh-comments-indicator blob-num" colSpan={2}>
				<button type="button" className="btn-link">
					<CommentIcon />
					<span>{commentCount}</span>
				</button>
			</td>
		</tr>,
	);
});

// Add indicator when the `show-inline-notes` class is removed (i.e. the comments are hidden)
const indicatorToggleObserver = new MutationObserver(mutations => {
	for (const mutation of mutations) {
		const file = mutation.target as HTMLElement;
		const wasVisible = mutation.oldValue!.includes('show-inline-notes');
		const isHidden = !file.classList.contains('show-inline-notes');
		if (wasVisible && isHidden) {
			for (const thread of $$('tr.inline-comments', file)) {
				addIndicator(thread);
			}
		}
	}
});

function init(signal: AbortSignal): void {
	observe('.file.js-file', element => {
		// #observe won't observe the same element twice
		// TODO: toggle visibility via :has selector instead
		indicatorToggleObserver.observe(element, {
			attributes: true,
			attributeOldValue: true,
			attributeFilter: ['class'],
		});
	}, {signal});

	delegate('.rgh-comments-indicator', 'click', handleIndicatorClick, {signal});

	onAbort(signal, indicatorToggleObserver);
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isPRFiles,
	],
	init,
});

/*
Test URLs:

https://github.com/refined-github/sandbox/pull/18/files

*/



================================================
FILE: source/features/hide-diff-signs.css
================================================
html:not([rgh-OFF-hide-diff-signs])
	:is(
		.diff-text-cell
			.diff-text /* Edit page, probably upcoming DOM everywhere */,
		.blob-code-inner /* Inline review blocks in PRs */,
		.blob-code-marker-cell /* Commit page */
	)::before,
/* React commit page */
	.diff-text-marker {
	visibility: hidden;
}



================================================
FILE: source/features/hide-diff-signs.tsx
================================================
import './hide-diff-signs.css';

import features from '../feature-manager.js';

void features.addCssFeature(import.meta.url);

/*

Test URLs:

- PR files: https://github.com/refined-github/refined-github/pull/1783/files
- Commits: https://github.com/refined-github/refined-github/commit/24a802e93203fecb5644cc0a0f40ef0d1dba2359
- Code in PR reviews: https://github.com/refined-github/sandbox/pull/38
- Preview tab on Edit file page: https://github.com/refined-github/refined-github/edit/main/.editorconfig

*/



================================================
FILE: source/features/hide-inactive-deployments.tsx
================================================
import {$$, elementExists} from 'select-dom';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';

// This feature doesn't need an active observer
function init(): void {
	// Selects all the deployments first so that we can leave the last one on the page
	const deployments = $$('.js-socket-channel[data-gid^="PR"]:has(.octicon-rocket)');
	deployments.pop(); // Don't hide the last deployment, even if it is inactive

	for (const deployment of deployments) {
		if (elementExists('[title="Deployment Status Label: Inactive"]', deployment)) {
			deployment.remove();
		}
	}
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isPRConversation,
	],
	awaitDomReady: true,
	init,
});

/*

Test URLs:

https://github.com/btkostner/btkostner.io/pull/10

*/



================================================
FILE: source/features/hide-low-quality-comments.css
================================================
.rgh-low-quality-comments-note {
	margin: 15px 0 10px 60px;
	font-size: 12px;
	color: var(--fgColor-muted, var(--color-fg-muted, fuchsia));
}

.rgh-hidden-comment {
	.timeline-comment {
		border-color: var(--rgh-red, fuchsia);
	}

	.timeline-comment--caret {
		&::before {
			background-color: var(--rgh-red, fuchsia);
		}

		&::after {
			left: -7px; /* make caret border 1px */
		}
	}
}



================================================
FILE: source/features/hide-low-quality-comments.tsx
================================================
import './hide-low-quality-comments.css';

import React from 'dom-chef';
import {$, $optional} from 'select-dom/strict.js';
import {$$, countElements, elementExists} from 'select-dom';
import * as pageDetect from 'github-url-detection';
import delegate, {type DelegateEvent} from 'delegate-it';

import delay from '../helpers/delay.js';
import features from '../feature-manager.js';
import isLowQualityComment from '../helpers/is-low-quality-comment.js';

export const singleParagraphCommentSelector = '.comment-body > p:only-child';

async function unhide(event: DelegateEvent): Promise<void> {
	for (const comment of $$('.rgh-hidden-comment')) {
		comment.hidden = false;
	}

	await delay(10); // "Similar comments" aren't expanded without this in Safari #3830

	// Expand all "similar comments" boxes
	for (const similarCommentsExpandButton of $$('.rgh-hidden-comment > summary')) {
		similarCommentsExpandButton.click();
	}

	$('.rgh-hidden-comment').scrollIntoView();
	event.delegateTarget.parentElement!.remove();
}

function hideComment(comment: HTMLElement): void {
	comment.hidden = true;
	comment.classList.add('rgh-hidden-comment');
}

function init(): void {
	for (const similarCommentsBox of $$('.js-discussion .Details-element:not([data-body-version])')) {
		hideComment(similarCommentsBox);
	}

	const linkedComment = location.hash.startsWith('#issuecomment-')
		? $optional(`${location.hash} ${singleParagraphCommentSelector}`)
		: undefined;

	for (const commentText of $$(singleParagraphCommentSelector)) {
		// Exclude explicitly linked comments #5363
		if (commentText === linkedComment) {
			continue;
		}

		if (!isLowQualityComment(commentText.textContent)) {
			continue;
		}

		// Comments that contain useful images or links shouldn't be removed
		// Images are wrapped in <a> tags on GitHub hence included in the selector
		if (elementExists('a', commentText)) {
			continue;
		}

		// Ensure that they're not by VIPs (owner, collaborators, etc)
		const comment = commentText.closest('.js-timeline-item')!;
		if (elementExists('.Label', comment)) {
			continue;
		}

		// If the person is having a conversation, then don't hide it
		const author = $('.author', comment).getAttribute('href')!;
		// If the first comment left by the author isn't a low quality comment
		// (previously hidden or about to be hidden), then leave this one as well
		const previousComment = $(`.js-timeline-item:not([hidden]) .unminimized-comment .author[href="${author}"]`);
		if (previousComment?.closest('.js-timeline-item') !== comment) {
			continue;
		}

		hideComment(comment);
	}

	const lowQualityCount = countElements('.rgh-hidden-comment');
	if (lowQualityCount > 0) {
		$('.discussion-timeline-actions').prepend(
			<p className="rgh-low-quality-comments-note">
				{`${lowQualityCount} unhelpful comment${lowQualityCount > 1 ? 's were' : ' was'} automatically hidden. `}
				<button className="btn-link text-emphasized rgh-unhide-low-quality-comments" type="button">Show</button>
			</p>,
		);

		// No need to add the signal here
		delegate('.rgh-unhide-low-quality-comments', 'click', unhide);
	}
}

// This should NOT be made dynamic via observer, it's not worth updating the lowQuality count for fresh comments
void features.add(import.meta.url, {
	include: [
		pageDetect.isIssue,
	],
	deduplicate: '.rgh-low-quality-comments-note',
	awaitDomReady: true,
	init,
});

/*

## Test URLs

- 26 hidden comments: https://togithub.com/stephencookdev/speed-measure-webpack-plugin/issues/167#issue-849740710
- Linked comment should not be collapsed: https://togithub.com/stephencookdev/speed-measure-webpack-plugin/issues/167#issuecomment-821212185

*/



================================================
FILE: source/features/hide-navigation-hover-highlight.css
================================================
[rgh-no-navigation-highlight] {
	.Box-row.navigation-focus /* Issue list */,
	.react-directory-row:hover /* React file list */,
	.navigation-focus td /* File list */ {
		background: none !important;
	}

	/* Notifications list */
	.notifications-list-item:hover {
		background: none !important;
		box-shadow: none !important;
	}
}



================================================
FILE: source/features/hide-navigation-hover-highlight.tsx
================================================
import './hide-navigation-hover-highlight.css';

import features from '../feature-manager.js';

const attribute = 'rgh-no-navigation-highlight';
const html = document.documentElement;

function init(): void {
	html.setAttribute(attribute, '');
	html.addEventListener('navigation:keydown', () => {
		html.removeAttribute(attribute);
	}, {once: true});
}

void features.add(import.meta.url, {
	init,
});

/*

Test URLs

- Notifications list: https://github.com/notifications
- Issue list: https://github.com/refined-github/refined-github/issues
- React file list: https://github.com/refined-github/refined-github/tree/main/.github
- File list: https://github.com/refined-github/refined-github

*/



================================================
FILE: source/features/hide-user-forks.tsx
================================================
import features from '../feature-manager.js';
import onetime from '../helpers/onetime.js';
import observe from '../helpers/selector-observer.js';

function addSourceTypeToLink(link: HTMLAnchorElement): void {
	const search = new URLSearchParams(link.search);
	search.set('type', 'source');
	link.search = String(search);
}

const skipUrlsWithType = ':not([href*="&type="], .issues-reset-query)';

const selectors = [
	// User repos
	`a[href*="?tab=repositories"]:is([href^="/"], [href^="${location.origin}/"])${skipUrlsWithType}`,

	// Organization repos
	`a[href*="/repositories"]:is([href^="/orgs/"], [href^="${location.origin}/orgs/"])${skipUrlsWithType}`,
] as const;

function initOnce(): void {
	observe(selectors, addSourceTypeToLink);
}

void features.add(import.meta.url, {
	// No `include` necessary
	init: onetime(initOnce),
});

/*

## Test URLs

- https://github.com/fregante?tab=repositories
- https://github.com/orgs/refined-github/repositories
- The "Your repositories" link in the user dropdown in the header
- The "Repositories" tab in
	- https://github.com/fregante
	- https://github.com/refined-github

*/



================================================
FILE: source/features/highest-rated-comment.css
================================================
.rgh-highest-rated-comment.timeline-comment {
	/* Same as GitHub's `.timeline-chosen-answer` */
	border: 2px solid
		var(--borderColor-success-emphasis, var(--color-success-emphasis, fuchsia));
}

.rgh-highest-rated-comment.timeline-comment--caret::before {
	background-color: var(
		--borderColor-success-emphasis,
		var(--color-success-emphasis, fuchsia)
	);
}

a.rgh-highest-rated-comment {
	border: 2px solid
		var(--borderColor-success-emphasis, var(--color-success-emphasis, fuchsia)) !important;
}

a.rgh-highest-rated-comment .avatar {
	position: absolute;
	left: -58px;
}



================================================
FILE: source/features/highest-rated-comment.tsx
================================================
import './highest-rated-comment.css';

import mem from 'memoize';
import React from 'dom-chef';
import {$, $optional} from 'select-dom/strict.js';
import {$$} from 'select-dom';
import * as pageDetect from 'github-url-detection';
import ArrowDownIcon from 'octicons-plain-react/ArrowDown';
import CheckCircleFillIcon from 'octicons-plain-react/CheckCircleFill';

import features from '../feature-manager.js';
import looseParseInt from '../helpers/loose-parse-int.js';
import isLowQualityComment from '../helpers/is-low-quality-comment.js';
import {singleParagraphCommentSelector} from './hide-low-quality-comments.js';

// `.js-timeline-item` gets the nearest comment excluding the very first comment (OP post)
const commentSelector = '.js-timeline-item';

const positiveReactionsSelector = `
	${commentSelector} [aria-label="react with thumbs up"],
	${commentSelector} [aria-label="react with hooray"],
	${commentSelector} [aria-label="react with heart"]
`;

const negativeReactionsSelector = `
	${commentSelector} [aria-label="react with thumbs down"]
`;

const getPositiveReactions = mem((comment: HTMLElement): number | void => {
	const count = selectSum(positiveReactionsSelector, comment);
	if (
		// It needs to be upvoted enough times
		count >= 10

		// It can't be a controversial comment
		&& selectSum(negativeReactionsSelector, comment) < count / 2
	) {
		return count;
	}
});

function getBestComment(): HTMLElement | undefined {
	let highest;
	for (const reaction of $$(positiveReactionsSelector)) {
		const comment = reaction.closest(commentSelector)!;
		const positiveReactions = getPositiveReactions(comment);
		if (positiveReactions && (!highest || positiveReactions > highest.count)) {
			highest = {comment, count: positiveReactions};
		}
	}

	return highest?.comment;
}

function highlightBestComment(bestComment: Element): void {
	$('.unminimized-comment', bestComment).classList.add('rgh-highest-rated-comment');
	$('.unminimized-comment .timeline-comment-header > h3', bestComment).before(
		<span
			className="color-fg-success tooltipped tooltipped-s"
			aria-label="This comment has the most positive reactions on this issue."
		>
			<CheckCircleFillIcon />
		</span>,
	);
}

function linkBestComment(bestComment: HTMLElement): void {
	// Find position of comment in thread
	const position = $$(commentSelector).indexOf(bestComment);

	// Only link to it if it doesn't already appear at the top of the conversation
	if (position < 3) {
		return;
	}

	const text = $('.comment-body', bestComment).textContent.slice(0, 100);
	const {hash} = $('a.js-timestamp', bestComment);
	const avatar = $('img.avatar', bestComment).cloneNode();

	bestComment.parentElement!.firstElementChild!.after(
		<a href={hash} className="no-underline rounded-1 rgh-highest-rated-comment timeline-comment color-bg-subtle px-2 d-flex flex-items-center">
			{avatar}

			<h3 className="timeline-comment-header-text f5 color-fg-muted text-normal text-italic css-truncate css-truncate-overflow mr-2">
				<span className="Label mr-2">Highest-rated</span>{text}
			</h3>

			<div className="color-fg-muted f6 no-wrap">
				<ArrowDownIcon className="mr-1" />Jump to comment
			</div>
		</a>,
	);
}

function selectSum(selector: string, container: HTMLElement): number {
	return $$(selector, container).reduce((sum, element) => sum + looseParseInt(element), 0);
}

function init(): false | void {
	const bestComment = getBestComment();
	if (!bestComment) {
		return false;
	}

	const commentText = $optional(singleParagraphCommentSelector, bestComment)?.textContent;
	if (commentText && isLowQualityComment(commentText)) { // #5567
		return false;
	}

	linkBestComment(bestComment);
	highlightBestComment(bestComment);
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isIssue,
	],
	deduplicate: 'has-rgh-inner',
	awaitDomReady: true, // Must wait for all to pick the best one
	init,
});

/*
Test URLs:

- 8th comment, has link: https://github.com/refined-github/refined-github/issues/4166
- 2nd comment, no link: https://github.com/refined-github/refined-github/issues/825
*/



================================================
FILE: source/features/highlight-non-default-base-branch.tsx
================================================
import React from 'dom-chef';
import * as pageDetect from 'github-url-detection';
import GitPullRequestIcon from 'octicons-plain-react/GitPullRequest';
import batchedFunction from 'batched-function';

import features from '../feature-manager.js';
import api from '../github-helpers/api.js';
import {buildRepoURL} from '../github-helpers/index.js';
import getDefaultBranch from '../github-helpers/get-default-branch.js';
import observe from '../helpers/selector-observer.js';
import {expectToken} from '../github-helpers/github-token.js';
import abbreviateString from '../helpers/abbreviate-string.js';

type BranchInfo = {
	baseRef: string;
	baseRefName: string;
};

function isClosed(prLink: HTMLElement): boolean {
	return Boolean(prLink.closest('.js-issue-row')!.querySelector(['.octicon.merged', '.octicon.closed']));
}

function buildQuery(issueIds: string[]): string {
	return `
		repository() {
			${issueIds.map(id => `
				${id}: pullRequest(number: ${id.replaceAll(/\D/g, '')}) {
					baseRef {id}
					baseRefName
				}
			`).join('\n')}
		}
	`;
}

async function add(prLinks: HTMLElement[]): Promise<void> {
	const query = buildQuery(prLinks.map(pr => pr.id));
	const [data, defaultBranch] = await Promise.all([
		api.v4(query),
		getDefaultBranch(),
	]);

	for (const prLink of prLinks) {
		const pr: BranchInfo = data.repository[prLink.id];
		if (pr.baseRefName === defaultBranch) {
			continue;
		}

		// Avoid noise on old PRs pointing to `master` #3910
		// If the PR is open, it means that `master` still exists
		if (pr.baseRefName === 'master' && isClosed(prLink)) {
			continue;
		}

		const branch = pr.baseRef && buildRepoURL('tree', pr.baseRefName);
		const displayName = abbreviateString(pr.baseRefName, 25);

		prLink.parentElement!.querySelector('.text-small.color-fg-muted .d-none.d-md-inline-flex')!.append(
			<span className="issue-meta-section ml-2">
				<GitPullRequestIcon />
				{' To '}
				<span
					className="commit-ref user-select-contain mb-n1"
					style={branch ? {} : {textDecoration: 'line-through'}}
				>
					<a title={branch ? pr.baseRefName : 'Deleted'} href={branch}>
						{displayName}
					</a>
				</span>
			</span>,
		);
	}
}

async function init(signal: AbortSignal): Promise<false | void> {
	await expectToken();
	observe('.js-issue-row .js-navigation-open[data-hovercard-type="pull_request"]', batchedFunction(add, {delay: 100}), {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isRepoIssueOrPRList,
	],
	init,
});

/*

Test URLs:

https://github.com/refined-github/sandbox/pulls?q=is%3Apr+is%3Aopen+pr+branch

*/



================================================
FILE: source/features/html-preview-link.tsx
================================================
import React from 'dom-chef';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';

const isSingleHTMLFile = (): boolean => pageDetect.isSingleFile() && /\.html?$/.test(location.pathname);

function add(rawButton: HTMLAnchorElement): void {
	if (!pageDetect.isPublicRepo()) {
		return;
	}

	rawButton
		.parentElement! // `div`
		.parentElement! // `BtnGroup`
		.prepend(
			<div>
				<a
					className={rawButton.className}
					data-variant="default"
					data-size="small"
					// #3305
					href={`https://refined-github-html-preview.kidonng.workers.dev${rawButton.pathname}`}
				>
					Preview
				</a>
			</div>,
		);
}

function init(signal: AbortSignal): void {
	observe(['a#raw-url', 'a[data-testid="raw-button"]'], add, {signal});
}

void features.add(import.meta.url, {
	include: [
		isSingleHTMLFile,
	],
	exclude: [
		pageDetect.isEnterprise,
	],
	init,
});

/*

Test URLs:

https://github.com/refined-github/sandbox/blob/html/preview-link/public/test.html
https://github.com/CodingTrain/website/blob/4f90eedb9618257d9166241e92e51a7f3f00a08e/code_challenges/PerlinNoiseTerrain_p5.js/index.html

*/



================================================
FILE: source/features/improve-shortcut-help.tsx
================================================
import React from 'dom-chef';
import {elementExists} from 'select-dom';
import {$, $optional} from 'select-dom/strict.js';
import memoize from 'memoize';

import onetime from '../helpers/onetime.js';
import features from '../feature-manager.js';
import {isEditable} from '../helpers/dom-utils.js';
import {shortcutMap} from '../helpers/feature-helpers.js';
import observe from '../helpers/selector-observer.js';

function splitKeys(keys: string): DocumentFragment[] {
	return keys.split(' ').map(key => <> <kbd>{key}</kbd></>);
}

function improveShortcutHelpLegacy(dialog: Element): void {
	$('.Box-body .col-5 .Box:first-child', dialog).after(
		<div className="Box Box--condensed m-4">
			<div className="Box-header">
				<h2 className="Box-title">Refined GitHub</h2>
			</div>

			<ul>
				{[...shortcutMap]
					.toSorted(([, a], [, b]) => a.localeCompare(b))
					.map(([hotkey, description]) => (
						<li className="Box-row d-flex flex-row">
							<div className="flex-auto">{description}</div>
							<div className="ml-2 no-wrap">
								{splitKeys(hotkey)}
							</div>
						</li>
					))}
			</ul>
		</div>,
	);
}

const observer = new MutationObserver(([{target}]) => {
	if (target instanceof Element && !elementExists('.js-details-dialog-spinner', target)) {
		improveShortcutHelpLegacy(target);
		observer.disconnect();
	}
});

function observeShortcutModal({key, target}: KeyboardEvent): void {
	if (key !== '?' || isEditable(target)) {
		return;
	}

	const modal = $optional('body > details:not(.js-command-palette-dialog) > details-dialog');
	if (modal) {
		observer.observe(modal, {childList: true});
	}
}

function initOnce(): void {
	document.body.addEventListener('keypress', observeShortcutModal);
}

// TODO: Remove everything above in 2026
const getRghShortcutsContainer = memoize(
	(baseShortcutsContainer: Element): Element => {
		const rghShortcutsContainer = baseShortcutsContainer.cloneNode(true);
		const shortcutsList = $('ul', rghShortcutsContainer);
		const shortcutItem = $('[class^="ShortcutsGroupList-module__ShortcutItem"]', shortcutsList);
		const keybindingHint = $('kbd', shortcutItem);
		const chord = $('span', shortcutItem);

		$('h2', rghShortcutsContainer).textContent = 'Refined GitHub';
		shortcutsList.replaceChildren(
			...[...shortcutMap]
				.toSorted(([, a], [, b]) => a.localeCompare(b))
				.map(([hotkey, description]) => {
					const currentItem = shortcutItem.cloneNode(true);
					currentItem.firstElementChild!.textContent = description;
					currentItem.lastElementChild!.replaceChildren(
						<kbd className={keybindingHint.className}>
							{hotkey.split(' ').map((key, index) => (
								<>
									{index > 0 && ' '}
									<span className={chord.className}>
										{key.charAt(0).toUpperCase() + key.slice(1)}
									</span>
								</>
							))}
						</kbd>,
					);
					return currentItem;
				}),
		);

		return rghShortcutsContainer;
	},
	{
		cacheKey: () => location.origin + location.pathname,
	},
);

function improveShortcutHelp(columnsContainer: HTMLElement): void {
	if (shortcutMap.size === 0) {
		features.unload(import.meta.url);
		return;
	}

	const lastColumn = columnsContainer.lastElementChild!;
	lastColumn.append(getRghShortcutsContainer(lastColumn.firstElementChild!));
}

function init(signal: AbortSignal): void {
	observe('[class^="ShortcutsDialog-module__ColumnsContainer"]', improveShortcutHelp, {signal});
}

void features.add(import.meta.url, {
	init: [init, onetime(initOnce)],
});

/*

Test URLs: Any page

*/



================================================
FILE: source/features/jump-to-change-requested-comment.tsx
================================================
import React from 'dom-chef';
import {$} from 'select-dom/strict.js';
import * as pageDetect from 'github-url-detection';

import {wrap} from '../helpers/dom-utils.js';
import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';

function linkify(textLine: HTMLElement): void {
	const url = $('a.dropdown-item[href^="#pullrequestreview-"]', textLine.parentElement!);
	// `lastChild` is a textNode
	wrap(textLine.lastChild!, <a href={url.hash} />);
}

function init(signal: AbortSignal): void {
	observe('.merge-status-item.review-item [title*="requested changes"]', linkify, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isPRConversation,
	],
	init,
});

/*
Test URLs

https://github.com/ipaddress-gem/ipaddress/pull/22#partial-pull-merging
*/



================================================
FILE: source/features/jump-to-conversation-close-event.tsx
================================================
import React from 'dom-chef';
import {lastElement} from 'select-dom';
import * as pageDetect from 'github-url-detection';

import {wrap} from '../helpers/dom-utils.js';
import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';

export const statusBadge = [
	'#partial-discussion-header .State',
	'[class^="StateLabel"]',
] as const;

export function getLastCloseEvent(): HTMLElement | undefined {
	return lastElement([
		// TODO: Move to selectors.ts
		// Old view: Drop in April 2025
		`.TimelineItem-badge :is(
			.octicon-issue-closed,
			.octicon-git-merge,
			.octicon-git-pull-request-closed,
			.octicon-skip
		)`,
		// React view (values for PR states not yet known)
		`[data-testid="state-reason-link"]:is(
			[href*="reason%3Acompleted"],
			[href*="reason%3Anot-planned"]
		)`,
	])?.closest([
		'.TimelineItem', // Old view
		'[data-timeline-event-id]',
	])?.querySelector('relative-time') ?? undefined;
}

function addToConversation(discussionHeader: HTMLElement): void {
	// Avoid native `title` by disabling pointer events, we have our own `aria-label`. We can't drop the `title` attribute because some features depend on it.
	discussionHeader.style.pointerEvents = 'none';

	wrap(
		discussionHeader,
		<a
			aria-label="Scroll to most recent close event"
			className="tooltipped tooltipped-e"
			href={getLastCloseEvent()!.closest('a')!.href}
		/>,
	);
}

function init(signal: AbortSignal): void {
	observe(
		statusBadge,
		addToConversation,
		{signal},
	);
}

void features.add(import.meta.url, {
	asLongAs: [
		pageDetect.isConversation,
		pageDetect.isClosedConversation,
	],
	awaitDomReady: true, // We're specifically looking for the last event
	init,
});

/*
## Test URLs
Closed Issue: https://github.com/refined-github/sandbox/issues/2
Closed Issue (Not Planned): https://github.com/refined-github/sandbox/issues/24
Merged PR: https://github.com/refined-github/sandbox/pull/23
Closed PR: https://github.com/refined-github/sandbox/pull/22
*/



================================================
FILE: source/features/keyboard-navigation.tsx
================================================
import {$optional} from 'select-dom/strict.js';
import {$$, elementExists} from 'select-dom';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import {isEditable} from '../helpers/dom-utils.js';

const isCommentGroupMinimized = (comment: HTMLElement): boolean =>
	elementExists('.minimized-comment:not(.d-none)', comment)
	|| Boolean(comment.closest([
		'.js-resolvable-thread-contents.d-none', // Regular comments
		'details.js-resolvable-timeline-thread-container:not([open])', // Review comments
	]));

function runShortcuts(event: KeyboardEvent): void {
	if ((event.key !== 'j' && event.key !== 'k') || isEditable(event.target)) {
		return;
	}

	event.preventDefault();

	const focusedComment = $optional(':target');
	const items
		= $$([
			'.js-targetable-element[id^="diff-"]', // Files in diffs
			'.js-minimizable-comment-group', // Comments (to be `.filter()`ed)
		])
			.filter(element =>
				element.classList.contains('js-minimizable-comment-group')
					? !isCommentGroupMinimized(element)
					: true,
			);

	// `j` goes to the next comment, `k` goes back a comment
	const direction = event.key === 'j' ? 1 : -1;
	// Without `focusedElement`, it will start from -1
	const currentIndex = items.indexOf(focusedComment!);

	// Start at 0 if nothing is; clamp index
	const chosenCommentIndex = Math.min(
		Math.max(0, currentIndex + direction),
		items.length - 1,
	);

	if (currentIndex !== chosenCommentIndex) {
		// Focus comment without pushing to history
		location.replace('#' + items[chosenCommentIndex].id);
	}
}

function init(signal: AbortSignal): void {
	document.body.addEventListener('keypress', runShortcuts, {signal});
}

void features.add(import.meta.url, {
	shortcuts: {
		j: 'Focus the comment/file below',
		k: 'Focus the comment/file above',
	},
	include: [
		pageDetect.hasComments,
	],
	init,
});

/*

Test URLs:

https://github.com/refined-github/refined-github/pull/4030#discussion_r584184640

*/



================================================
FILE: source/features/last-notification-page-button.tsx
================================================
import React from 'dom-chef';
import {$} from 'select-dom/strict.js';
import * as pageDetect from 'github-url-detection';
import {stringToBase64} from 'uint8array-extras';

import features from '../feature-manager.js';
import looseParseInt from '../helpers/loose-parse-int.js';
import {assertNodeContent} from '../helpers/dom-utils.js';
import observe from '../helpers/selector-observer.js';

const itemsPerNotificationsPage = 25;

function linkify(nextButton: HTMLAnchorElement): void {
	const totalNotificationsNode = $('.js-notifications-list-paginator-counts').lastChild!;
	assertNodeContent(totalNotificationsNode, /^of \d+$/);
	const totalNotificationsNumber = looseParseInt(totalNotificationsNode);
	const lastCursor = Math.floor((totalNotificationsNumber - 1) / itemsPerNotificationsPage) * itemsPerNotificationsPage;
	const nextButtonSearch = new URLSearchParams(nextButton.search);
	nextButtonSearch.set('after', stringToBase64(`cursor:${lastCursor}`));
	totalNotificationsNode.replaceWith(
		' of ',
		<a href={'?' + String(nextButtonSearch)}>
			{totalNotificationsNumber}
		</a>,
	);
}

function init(signal: AbortSignal): void {
	// When there's no "next page", this element becomes `<button disabled>`
	observe('a[aria-label="Next"]', linkify, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isNotifications,
	],
	init,
});

/*

Test URLs:

https://github.com/notifications

*/



================================================
FILE: source/features/link-to-changelog-file.gql
================================================
query GetFilesOnRoot($owner: String!, $name: String!) {
	repository(owner: $owner, name: $name) {
		object(expression: "HEAD:") {
			... on Tree {
				entries {
					name
					type
				}
			}
		}
	}
}



================================================
FILE: source/features/link-to-changelog-file.tsx
================================================
import React from 'dom-chef';
import {CachedFunction} from 'webext-storage-cache';
import elementReady from 'element-ready';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import api from '../github-helpers/api.js';
import {buildRepoURL, getRepo} from '../github-helpers/index.js';
import GetFilesOnRoot from './link-to-changelog-file.gql';

type FileType = {
	name: string;
	type: string;
};

const changelogFiles = /^(?:changelog|news|changes|history|release|whatsnew)(?:\.(?:mdx?|mkdn?|mdwn|mdown|markdown|litcoffee|txt|rst))?$/i;
function findChangelogName(files: string[]): string | false {
	return files.find(name => changelogFiles.test(name)) ?? false;
}

const changelogName = new CachedFunction('changelog', {
	async updater(nameWithOwner: string): Promise<string | false> {
		const [owner, name] = nameWithOwner.split('/');
		const {repository} = await api.v4(GetFilesOnRoot, {
			variables: {name, owner},
		});

		const files: string[] = [];
		for (const entry of repository.object.entries as FileType[]) {
			if (entry.type === 'blob') {
				files.push(entry.name);
			}
		}

		return findChangelogName(files);
	},
});

async function init(): Promise<void | false> {
	const changelog = await changelogName.get(getRepo()!.nameWithOwner);
	if (!changelog) {
		return false;
	}

	const releasesOrTagsNavbarSelector = [
		'nav[aria-label^="Releases and Tags"]', // Release list
		'.subnav-links', // Tag list
	];

	const navbar = await elementReady(releasesOrTagsNavbarSelector);
	navbar!.append(
		<a
			className="subnav-item tooltipped tooltipped-n"
			aria-label={`View the ${changelog} file`}
			href={buildRepoURL('blob', 'HEAD', changelog)}
		>
			<span>Changelog</span>
		</a>,
	);
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isReleasesOrTags,
	],
	exclude: [
		pageDetect.isSingleReleaseOrTag,
	],
	deduplicate: 'has-rgh-inner',
	init,
});

/*

Test URLs:

- CHANGELOG.md: https://github.com/nodeca/js-yaml/releases/tag/4.0.0)
- CHANGELOG.rst: https://github.com/pyca/cryptography/releases)
- CHANGES: https://github.com/sphinx-doc/sphinx/releases)
- news: https://github.com/pypa/pip/releases)
- HISTORY.md: https://github.com/psf/requests/releases)

*/



================================================
FILE: source/features/link-to-compare-diff.css
================================================
.rgh-link-to-compare-diff:hover > .octicon-file-diff {
	&,
	& ~ span {
		color: var(--fgColor-accent, var(--color-accent-fg, fuchsia)) !important;
	}
}



================================================
FILE: source/features/link-to-compare-diff.tsx
================================================
import './link-to-compare-diff.css';

import React from 'dom-chef';
import {elementExists} from 'select-dom';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';
import {wrapAll} from '../helpers/dom-utils.js';

function linkify(changedFilesSummary: HTMLElement): void {
	wrapAll(
		<a className="no-underline rgh-link-to-compare-diff" href="#files_bucket" />,
		...changedFilesSummary.children,
	);
}

function init(signal: AbortSignal): void {
	observe('.Box li:has(> .octicon-file-diff)', linkify, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isCompare,
	],
	exclude: [
		() => elementExists('.tabnav:not(.CommentBox-header)'), // The commit list and compare diff are in two separate tabs
	],
	awaitDomReady: true, // DOM-based exclusion filter
	init,
});

/*

Test URLs:

Separate tabs: https://github.com/refined-github/sandbox/compare/buncha-files...default-a
One view: https://github.com/refined-github/sandbox/compare/default-a...buncha-files

*/



================================================
FILE: source/features/link-to-github-io.tsx
================================================
import React from 'dom-chef';
import * as pageDetect from 'github-url-detection';
import LinkIcon from 'octicons-plain-react/Link';

import features from '../feature-manager.js';
import {getRepo} from '../github-helpers/index.js';
import observe from '../helpers/selector-observer.js';

function getLinkToGitHubIo(repoTitle: HTMLElement, className?: string): JSX.Element {
	return (
		<a
			href={`https://${repoTitle.textContent.trim().replace(/com$/, 'io')}`}
			className={className}
		>
			<LinkIcon className="v-align-middle" />
		</a>
	);
}

function addRepoListLink(repoTitle: HTMLAnchorElement): void {
	repoTitle.after(' ', getLinkToGitHubIo(repoTitle));
}

function addOrgRepoListLink(repoTitle: HTMLAnchorElement): void {
	repoTitle.after(getLinkToGitHubIo(repoTitle, 'ml-1'));
}

function addRepoHeaderLink(repoTitle: HTMLElement): void {
	repoTitle.after(getLinkToGitHubIo(repoTitle, 'mr-2'));
}

function initRepo(signal: AbortSignal): void {
	observe('[itemprop="name"]', addRepoHeaderLink, {signal});
}

function initRepoList(signal: AbortSignal): void {
	observe([
		// Earlier GitHub Pages were hosted on github.com #6228
		'a[itemprop="name codeRepository"][href$=".github.com"]',
		'a[itemprop="name codeRepository"][href$=".github.io"]',
	], addRepoListLink, {signal});
	observe([
		'a[data-testid="listitem-title-link"][href$=".github.com"]',
		'a[data-testid="listitem-title-link"][href$=".github.io"]',
	], addOrgRepoListLink, {signal});
}

void features.add(import.meta.url, {
	asLongAs: [
		() => /\.github\.(?:io|com)$/.test(getRepo()?.name ?? 'shush eslint'),
	],
	include: [
		pageDetect.isRepoHome,
	],
	exclude: [
		pageDetect.isEnterprise,
	],
	init: initRepo,
}, {
	include: [
		pageDetect.isProfileRepoList,
		pageDetect.isOrganizationProfile,
	],
	exclude: [
		pageDetect.isEnterprise,
	],
	init: initRepoList,
});

/*

Test URLs:

- Repo: https://github.com/yashshah1/yashshah1.github.io
- List, user: https://github.com/yashshah1?tab=repositories&q=GitHub.io&type=source
- List, org: https://github.com/Qv2ray?q=GitHub.io
- List, org repos: https://github.com/orgs/Qv2ray/repositories?q=GitHub.io

*/



================================================
FILE: source/features/linkify-branch-references.tsx
================================================
import React from 'dom-chef';
import * as pageDetect from 'github-url-detection';
import {$, $optional} from 'select-dom/strict.js';
import {$$} from 'select-dom';

import features from '../feature-manager.js';
import GitHubFileURL from '../github-helpers/github-file-url.js';
import {buildRepoURL} from '../github-helpers/index.js';
import observe from '../helpers/selector-observer.js';

function linkifyQuickPR(element: HTMLElement): void {
	const branchUrl = buildRepoURL('tree', element.textContent);
	element.replaceWith(
		<span className="commit-ref">
			<a className="no-underline" href={branchUrl} data-turbo-frame="repo-content-turbo-frame">
				{element.textContent}
			</a>
		</span>,
	);
}

function linkifyHovercard(hovercard: HTMLElement): void {
	const {href} = $('a.Link--primary', hovercard);

	for (const reference of $$('.commit-ref', hovercard)) {
		const url = new GitHubFileURL(href).assign({
			route: 'tree',
			branch: reference.title,
		});

		const user = $optional('.user', reference);
		if (user) {
			url.user = user.textContent;
		}

		reference.replaceChildren(
			<a className="no-underline" href={url.href} data-turbo-frame="repo-content-turbo-frame">
				{[...reference.childNodes]}
			</a>,
		);
	}
}

async function quickPRInit(signal: AbortSignal): Promise<void> {
	observe('.branch-name', linkifyQuickPR, {signal});
}

function hovercardInit(signal: AbortSignal): void {
	observe('[data-hydro-view*="pull-request-hovercard-hover"] ~ .d-flex.mt-2', linkifyHovercard, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isQuickPR,
	],
	init: quickPRInit,
}, {
	init: hovercardInit,
});

/*

Test URLs:

https://github.com/refined-github/sandbox/compare/default-a...quick-pr-branch?quick_pull=1
https://github.com ("Recent activity" box in left sidebar, hover a PR)

*/



================================================
FILE: source/features/linkify-code.tsx
================================================
import {$$} from 'select-dom';
import * as pageDetect from 'github-url-detection';

import observe from '../helpers/selector-observer.js';
import features from '../feature-manager.js';
import {getRepo} from '../github-helpers/index.js';
import {
	codeElementsSelector,
	linkifiedURLClass,
	linkifyURLs,
	linkifyIssues,
} from '../github-helpers/dom-formatters.js';

function linkifyContent(wrapper: Element): void {
	// Mark code block as touched to avoid `shorten-links` from acting on these new links in code
	wrapper.classList.add(linkifiedURLClass);

	linkifyURLs(wrapper);

	const currentRepo = pageDetect.isGlobalSearchResults()
		// Look for the link on the line number
		? getRepo(wrapper.parentElement!.querySelector('.blob-num a')!.href)
		: getRepo();
	// Some non-repo pages like gists have issue references #3844
	// They make no sense, but we still want `linkifyURLs` to run there
	if (!currentRepo) {
		return;
	}

	for (const element of $$('.pl-c', wrapper)) {
		linkifyIssues(currentRepo, element);
	}
}

function init(signal: AbortSignal): void {
	observe(codeElementsSelector, linkifyContent, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.hasCode,
	],
	init,
});

/*

## Test URLs

- URLs/issues in comments: https://github.com/refined-github/sandbox/pull/98
- URLs in PR files: https://github.com/refined-github/refined-github/pull/546/files#diff-7296d5f600098588b0af5ec9c84486593be79164f97406a0fc3c4ef5211ab2f9
- URLs in regular files: https://github.com/refined-github/refined-github/blob/3f5fc489e417d4f4a14da5ea423775e9ca9246fd/source/features/copy-markdown.js#L45 (broken: #6336)
- Issue reference in file: https://github.com/refined-github/refined-github/blob/2ade9a84b1894c7879fab9d3e2d045e876f941a6/source/features/sort-issues-by-update-time.tsx#L18 (broken: #6336)
- Code Search: https://github.com/search?q=repo%3AKatsuteDev%2FBackground+marketplace&type=code
- Code Search: https://github.com/search?q=%2F%23%5Cd%7B4%2C%7D%2F+language%3Atypescript&type=code
- Code Search that might break: https://github.com/search?q=path%3A.npmrc&type=code
- Clipped URL that shouldn't be linkified: https://github.com/sindresorhus/linkify-urls/pull/40#pullrequestreview-1593302757

*/



================================================
FILE: source/features/linkify-commit-sha.tsx
================================================
import React from 'dom-chef';
import {$optional} from 'select-dom/strict.js';
import * as pageDetect from 'github-url-detection';

import {wrap} from '../helpers/dom-utils.js';
import features from '../feature-manager.js';

function init(): void {
	const element = $optional('.sha.user-select-contain:not(a *)');
	if (element) {
		wrap(element, <a href={location.pathname.replace(/pull\/\d+\/commits/, 'commit')} />);
	}
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isPRCommit,
	],
	awaitDomReady: true,
	init,
});

/*

Test URLs:

https://github.com/refined-github/refined-github/pull/1429/commits/b533ffa5820d825e1730c62d11acb2edbfb2d7dd

*/



================================================
FILE: source/features/linkify-line-numbers.tsx
================================================
import * as pageDetect from 'github-url-detection';
import delegate, {type DelegateEvent} from 'delegate-it';
import {isAlteredClick} from 'filter-altered-clicks';

import features from '../feature-manager.js';

function openLinkToLine(event: DelegateEvent<MouseEvent, HTMLTableCellElement>): void {
	const cell = event.delegateTarget;
	const fileLink = cell
		.closest(['.Box', '.review-thread-component'])!
		.querySelector(['a[href*="#L"]', 'a[href*="#diff-"]'])!;
	const url = fileLink.hash.startsWith('#diff-')
		? fileLink.pathname + fileLink.hash + `R${cell.dataset.lineNumber}`
		: fileLink.pathname + `#L${cell.dataset.lineNumber}`;

	if (isAlteredClick(event)) {
		window.open(url);
	} else {
		location.href = url;
	}
}

function init(signal: AbortSignal): void {
	delegate('td[data-line-number]:empty', 'click', openLinkToLine, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isConversation,
	],
	init,
});

/*

Test URLs:

https://github.com/refined-github/sandbox/pull/81

*/



================================================
FILE: source/features/linkify-symbolic-links.tsx
================================================
import React from 'dom-chef';
import {$, $optional} from 'select-dom/strict.js';
import * as pageDetect from 'github-url-detection';

import {wrap} from '../helpers/dom-utils.js';
import features from '../feature-manager.js';

function init(): void {
	if ($optional('.file-mode')?.textContent === 'symbolic link') {
		const line = $('.js-file-line');
		wrap(line.firstChild!, <a href={line.textContent} data-turbo-frame="repo-content-turbo-frame" />);
	}
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isSingleFile,
	],
	exclude: [
		pageDetect.isRepoFile404,
	],
	deduplicate: 'has-rgh',
	awaitDomReady: true, // Small page
	init,
});

/*

Test URLs:

https://github.com/wmluke/angular-flash/blob/0.1.14/app/components

*/



================================================
FILE: source/features/linkify-text.tsx
================================================
import * as pageDetect from 'github-url-detection';

import {elementExists} from 'select-dom';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';
import {getRepo} from '../github-helpers/index.js';
import {linkifyIssues} from '../github-helpers/dom-formatters.js';
import {logError} from '../helpers/errors.js';

function linkifyIssue(paragraph: HTMLParagraphElement): void {
	// Already linkified
	if (elementExists('a', paragraph)) {
		logError(new Error(`${paragraph.textContent} is already linkified`));
	}

	linkifyIssues(getRepo()!, paragraph);
}

function init(signal: AbortSignal): void {
	observe([
		'.js-issue-title', // TODO: Drop in 2026
		'[data-component="TitleArea"] .markdown-title', // Issue and PR React View Title
		'.discussion-sidebar-item:has(.octicon-issue-opened) p', // Discussions sidebar item
	], linkifyIssue, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isPR,
		pageDetect.isIssue,
		pageDetect.isDiscussion,
	],
	init,
});

/*

Test URLs

- https://github.com/refined-github/sandbox/pull/70/files
- Discussions (title): https://github.com/File-New-Project/EarTrumpet/discussions/877
- Discussions (sidebar item): https://github.com/renovatebot/renovate/discussions/24775

*/



================================================
FILE: source/features/linkify-user-edit-history-popup.tsx
================================================
import React from 'dom-chef';
import * as pageDetect from 'github-url-detection';

import {wrap} from '../helpers/dom-utils.js';
import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';

function linkify(avatar: HTMLImageElement): void {
	const userName = avatar.alt.slice(1);
	// Linkify name first
	wrap(avatar.nextElementSibling!, <a className="Link--primary" href={`/${userName}`} />);

	// Then linkify avatar
	wrap(avatar, <a href={`/${userName}`} />);
}

function init(signal: AbortSignal): void {
	observe('details-dialog .Box-header .mr-3 > img:not([alt*="[bot]"])', linkify, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isConversation,
	],
	init,
});

/*

Test URLs:

- User edits: https://github.com/refined-github/sandbox/issues/24#issue-1299932109
- App edits: https://github.com/renovatebot/renovate/pull/30606#issue-2449330214
- Ghost edits: https://github.com/Mottie/GitHub-userscripts/issues/88#issuecomment-502933879

*/



================================================
FILE: source/features/linkify-user-labels.tsx
================================================
import React from 'dom-chef';
import * as pageDetect from 'github-url-detection';

import {wrap} from '../helpers/dom-utils.js';
import features from '../feature-manager.js';
import {buildRepoURL} from '../github-helpers/index.js';
import getCommentAuthor from '../github-helpers/get-comment-author.js';
import observe from '../helpers/selector-observer.js';

function linkify(label: Element): void {
	if (label.closest('a')) {
		throw new Error('Already linkified, feature needs to be updated');
	}

	// React might create a new label without removing the old one
	// https://github.com/refined-github/refined-github/issues/8478
	label.parentElement!.querySelector('.rgh-linkify-user-labels')?.remove();

	const url = new URL(buildRepoURL('commits'));
	url.searchParams.set('author', getCommentAuthor(label));
	wrap(label, <a className="Link--secondary rgh-linkify-user-labels" href={url.href} />);
}

function init(signal: AbortSignal): void {
	observe([
		'span[data-testid="comment-author-association"][aria-label*="a member of the"]',
		'span[data-testid="comment-author-association"][aria-label^="This user has previously committed"]',
		// PRs and pre-issue redesign 2024
		'.tooltipped[aria-label*="a member of the"]',
		'.tooltipped[aria-label^="This user has previously committed"]',
	], linkify, {signal});
}

void features.add(import.meta.url, {
	asLongAs: [
		pageDetect.isRepo,
	],
	include: [
		pageDetect.hasComments,
	],
	init,
});

/*
Test URLs:

Bot PR
https://github.com/webpack/webpack/pull/15926#issue-1264092372

Bot comment
https://github.com/webpack/webpack/pull/15926#issuecomment-1149371743

Bot commented on behalf of
https://github.com/webpack/webpack/pull/15926#issuecomment-1170670173

Member review
https://github.com/refined-github/refined-github/pull/5721#pullrequestreview-1018226910

Contributor review comment
https://github.com/refined-github/refined-github/pull/5691#discussion_r895191327

Contributor review second comment
https://github.com/refined-github/refined-github/pull/5691#discussion_r895192800

Contributor review second comment in Files tab
https://github.com/refined-github/refined-github/pull/2667/files#r366433031
*/



================================================
FILE: source/features/linkify-user-location.tsx
================================================
import React from 'dom-chef';

import onetime from '../helpers/onetime.js';
import features from '../feature-manager.js';
import {wrap} from '../helpers/dom-utils.js';
import observe from '../helpers/selector-observer.js';

function addLocation({nextElementSibling, nextSibling}: SVGElement): Element {
	// `nextSibling` alone might point to an empty TextNode before an element, if thereâ€™s an element
	const userLocation = nextElementSibling ?? nextSibling as Element;

	const locationName = userLocation.textContent.trim();
	const mapLink = `https://www.openstreetmap.org/search?query=${encodeURIComponent(locationName)}`;

	userLocation.before(' '); // Keeps the linkâ€™s underline from extending out to the icon
	const link = <a className="Link--primary" href={mapLink} />;

	if (userLocation.parentElement!.closest('.Popover')) {
	// Match the style of other links in the hovercard
		link.classList.add('text-underline');
	}

	wrap(userLocation, link);

	return link;
}

function initOnce(): void {
	observe([
		'[itemprop="homeLocation"] svg.octicon-location', // `isUserProfile`
		'.pagehead .has-location svg.octicon-location', // `isOrganizationProfile`
		'[aria-label="User location"] svg.octicon-location', // User hover cards
		'[aria-label="Organization Hovercard"] svg.octicon-location', // Organization hover cards
	], addLocation);
}

void features.add(import.meta.url, {
	// No `include` necessary
	init: onetime(initOnce),
});

/*

Test URLs

- isUserProfile: https://github.com/mysticatea
- isOrganizationProfile: https://github.com/github
- Hover cards: https://github.com/

*/



================================================
FILE: source/features/list-prs-for-branch.tsx
================================================
import React from 'dom-chef';

import features from '../feature-manager.js';
import getCurrentGitRef from '../github-helpers/get-current-git-ref.js';
import isDefaultBranch from '../github-helpers/is-default-branch.js';
import {pullRequestsAssociatedWithBranch, stateIcon} from './show-associated-branch-prs-on-fork.js';
import {addAfterBranchSelector, isPermalink, isRepoCommitListRoot} from '../github-helpers/index.js';
import observe from '../helpers/selector-observer.js';
import {branchSelectorParent} from '../github-helpers/selectors.js';
import {expectToken} from '../github-helpers/github-token.js';

// Taken from https://github.com/fregante/github-issue-link-status/blob/98792f2837352bacbf80664f3edbcec8e579ed17/source/github-issue-link-status.js#L10
const stateColorMap = {
	OPEN: 'color-fg-success',
	CLOSED: 'color-fg-danger',
	MERGED: 'color-fg-done',
	DRAFT: '',
};

async function add(branchSelectorParent: HTMLDetailsElement): Promise<void | false> {
	const getPr = await pullRequestsAssociatedWithBranch.get();
	const currentBranch = getCurrentGitRef()!;
	const prInfo = getPr[currentBranch];
	if (!prInfo) {
		return;
	}

	const StateIcon = stateIcon[prInfo.state];

	addAfterBranchSelector(
		branchSelectorParent,
		<a
			data-issue-and-pr-hovercards-enabled
			href={prInfo.url}
			className="btn flex-self-center rgh-list-prs-for-branch"
			data-hovercard-type="pull_request"
			data-hovercard-url={prInfo.url + '/hovercard'}
		>
			<StateIcon className={stateColorMap[prInfo.state]} />
			<span> #{prInfo.number}</span>
		</a>,
	);
}

async function init(signal: AbortSignal): Promise<false | void> {
	await expectToken();

	observe(branchSelectorParent, add, {signal});
}

void features.add(import.meta.url, {
	include: [
		isRepoCommitListRoot,
	],
	exclude: [
		isDefaultBranch,
		isPermalink,
	],
	init,
});

/*

Test URLs

https://github.com/refined-github/sandbox/commits/4679-1
https://github.com/refined-github/sandbox/commits/branch/with/slashes

*/



================================================
FILE: source/features/list-prs-for-file.gql
================================================
query getPrsByFile($owner: String!, $name: String!, $defaultBranch: String!) {
	repository(owner: $owner, name: $name) {
		pullRequests(
			first: 25
			states: OPEN
			baseRefName: $defaultBranch
			orderBy: { field: UPDATED_AT, direction: DESC }
		) {
			nodes {
				number
				files(first: 100) {
					nodes {
						path
					}
				}
			}
		}
	}
}



================================================
FILE: source/features/list-prs-for-file.tsx
================================================
import React from 'dom-chef';
import {CachedFunction} from 'webext-storage-cache';
import {isFirefox} from 'webext-detect';
import * as pageDetect from 'github-url-detection';
import AlertIcon from 'octicons-plain-react/Alert';
import GitPullRequestIcon from 'octicons-plain-react/GitPullRequest';

import features from '../feature-manager.js';
import api from '../github-helpers/api.js';
import getDefaultBranch from '../github-helpers/get-default-branch.js';
import {buildRepoURL, cacheByRepo} from '../github-helpers/index.js';
import GitHubFileURL from '../github-helpers/github-file-url.js';
import observe from '../helpers/selector-observer.js';
import listPrsForFileQuery from './list-prs-for-file.gql';
import {expectToken} from '../github-helpers/github-token.js';

function getPRUrl(prNumber: number): string {
	// https://caniuse.com/url-scroll-to-text-fragment
	const hash = isFirefox() ? '' : `#:~:text=${new GitHubFileURL(location.href).filePath}`;
	return buildRepoURL('pull', prNumber, 'files') + hash;
}

function getHovercardUrl(prNumber: number): string {
	return buildRepoURL('pull', prNumber, 'hovercard');
}

const buttonId = 'rgh-list-prs-for-file-';
let count = 0;

function getDropdown(prs: number[]): HTMLElement {
	const isEditing = pageDetect.isEditingFile();
	const icon = isEditing
		? <AlertIcon className="color-fg-attention" />
		: <GitPullRequestIcon />;

	count++;
	return (
		<div>
			<button
				type="button"
				className="Button Button--secondary color-fg-muted"
				id={buttonId + count}
				// @ts-expect-error HTML standard
				popovertarget={buttonId + 'popover-' + count}
			>
				{icon}
				<span className="color-fg-default"> {prs.length} </span>
				<div className="dropdown-caret" />
			</button>

			<anchored-position
				id={buttonId + 'popover-' + count}
				anchor={buttonId + count}
				popover="auto"
			>
				<div className="Overlay Overlay--size-auto">
					<div className="px-3 pt-3 h6 color-fg-muted">
						File also being edited in
					</div>
					<ul className="ActionListWrap ActionListWrap--inset">
						{prs.map(prNumber => (
							<li className="ActionListItem">
								<a
									className="ActionListContent js-hovercard-left"
									href={getPRUrl(prNumber)}
									data-hovercard-url={getHovercardUrl(prNumber)}
								>
									#{prNumber}
								</a>
							</li>
						))}
					</ul>
				</div>
			</anchored-position>
		</div>
	);
}

/**
@returns prsByFile {"filename1": [10, 3], "filename2": [2]}
*/
const getPrsByFile = new CachedFunction('files-with-prs', {
	async updater(): Promise<Record<string, number[]>> {
		const {repository} = await api.v4(listPrsForFileQuery, {
			variables: {
				defaultBranch: await getDefaultBranch(),
			},
		});

		const files: Record<string, number[]> = {};

		for (const pr of repository.pullRequests.nodes) {
			for (const {path} of pr.files.nodes) {
				files[path] ??= [];
				if (files[path].length < 10) {
					files[path].push(pr.number);
				}
			}
		}

		return files;
	},
	maxAge: {hours: 2},
	staleWhileRevalidate: {days: 9},
	cacheKey: cacheByRepo,
});

async function add(anchor: HTMLElement): Promise<false | void> {
	const path = new GitHubFileURL(location.href).filePath;
	const prsByFile = await getPrsByFile.get();
	let prs = prsByFile[path];

	if (!prs) {
		return;
	}

	const editingPRNumber = new URLSearchParams(location.search).get('pr')?.split('/').slice(-1);
	if (editingPRNumber) {
		prs = prs.filter(pr => pr !== Number(editingPRNumber));
		if (prs.length === 0) {
			return;
		}
	}

	const dropdown = getDropdown(prs);
	if (anchor.parentElement!.matches('.gap-2')) {
		// `isSingleFile`
		anchor.before(dropdown);
	} else {
		// `isEditingFile`
		dropdown.classList.add('mr-2');
		anchor.parentElement!.prepend(dropdown);
	}
}

async function init(signal: AbortSignal): Promise<void> {
	await expectToken();

	observe([
		'[data-testid="more-file-actions-button-nav-menu-wide"]', // `isSingleFile`
		'[data-testid="more-file-actions-button-nav-menu-narrow"]', // `isSingleFile`
		'[data-hotkey="Mod+s"]', // `isEditingFile`
	], add, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isSingleFile,
		pageDetect.isEditingFile,
	],
	init,
});

/*

## Test URLs

- isSingleFile: https://github.com/refined-github/sandbox/blob/6619/6619
- isEditingFile: https://github.com/refined-github/sandbox/edit/6619/6619

*/



================================================
FILE: source/features/locked-issue.tsx
================================================
import React from 'react';
import LockIcon from 'octicons-plain-react/Lock';
import * as pageDetect from 'github-url-detection';
import {elementExists} from 'select-dom';
import {$} from 'select-dom/strict.js';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';
import isConversationLocked from '../github-helpers/is-conversation-locked.js';

function LockedIndicator(): JSX.Element {
	return (
		<span title="Locked" className="State d-flex flex-items-center flex-shrink-0">
			<LockIcon className="flex-items-center mr-1" />
			Locked
		</span>
	);
}

function addLock(element: HTMLElement): void {
	const isReactView = element.getAttribute('data-testid')?.startsWith('issue-metadata');

	// Avoid adding it duplicately in issue
	if (isReactView && elementExists('.rgh-locked-issue', element)) {
		return;
	}

	const closestSticky = element.closest('.gh-header-sticky');
	const classes = `${closestSticky ? 'mr-2 ' : ''}${isReactView ? '' : 'mb-2 '}`;

	let container: HTMLElement | undefined;

	if (isReactView) {
		const wrapper = $('[data-testid="header-state"]', element).parentElement!;

		// Check if the element is wrapped by jump to close event feature
		const isWrappedByCloseEvent = wrapper.tagName === 'A';
		container = isWrappedByCloseEvent
			? wrapper.parentElement!
			: wrapper;
	} else {
		container = element;
	}

	container.after(
		<LockedIndicator className={classes + 'rgh-locked-issue'} />,
	);
}

async function init(signal: AbortSignal): Promise<void | false> {
	observe([
		'[data-testid="issue-metadata-fixed"]', // Issue title
		'[data-testid="issue-metadata-sticky"]', // Sticky issue title
		'.gh-header-meta > :first-child', // PR title
		'.gh-header-sticky .flex-row > :first-child', // Sticky PR title
	], addLock, {signal});
}

void features.add(import.meta.url, {
	asLongAs: [
		pageDetect.isConversation,
		async () => await isConversationLocked() ?? false,
	],
	init,
});

/*

## Test URLs

- Locked issue: https://github.com/refined-github/sandbox/issues/74
- Locked PR: https://github.com/refined-github/sandbox/pull/48

*/



================================================
FILE: source/features/mark-merge-commits-in-list.css
================================================
.rgh-merge-commit > div > * {
	transition: 100ms opacity; /* Match `dim-bots` */
}

.rgh-merge-commit:not(.navigation-focus, :hover) > div > * {
	opacity: 50%; /* Match `dim-bots` */
}



================================================
FILE: source/features/mark-merge-commits-in-list.tsx
================================================
import './mark-merge-commits-in-list.css';

import React from 'dom-chef';
import {$} from 'select-dom/strict.js';
import * as pageDetect from 'github-url-detection';
import {objectEntries} from 'ts-extras';
import GitMergeIcon from 'octicons-plain-react/GitMerge';
import batchedFunction from 'batched-function';

import observe from '../helpers/selector-observer.js';
import features from '../feature-manager.js';
import api from '../github-helpers/api.js';
import {commitHashLinkInLists, commitTitleInLists} from '../github-helpers/selectors.js';
import {assertCommitHash} from '../github-helpers/index.js';
import {expectToken} from '../github-helpers/github-token.js';

const filterMergeCommits = async (commits: string[]): Promise<string[]> => {
	const {repository} = await api.v4(`
		repository() {
			${commits.map((commit: string) => `
				${api.escapeKey(commit)}: object(expression: "${commit}") {
				... on Commit {
						parents {
							totalCount
						}
					}
				}
			`).join('\n')}
		}
	`);

	const mergeCommits = [];
	for (const [key, commit] of objectEntries(repository)) {
		if (commit.parents.totalCount >= 2) {
			mergeCommits.push(key.slice(1));
		}
	}

	return mergeCommits;
};

export function getCommitHash(commit: HTMLElement): string {
	const hash = $(commitHashLinkInLists, commit).pathname.split('/').pop()!;
	assertCommitHash(hash);
	return hash;
}

function updateCommitIcon(commit: HTMLElement, replace: boolean): void {
	if (replace) {
		// Align icon to the line; rem used to match the native units
		$('.octicon-git-commit', commit).replaceWith(<GitMergeIcon style={{marginLeft: '0.5rem'}} />);
	} else {
		$(commitTitleInLists, commit).prepend(<GitMergeIcon className="mr-1" />);
	}
}

async function markCommits(commits: HTMLElement[]): Promise<void> {
	const isPRConversation = pageDetect.isPRConversation();
	const mergeCommits = await filterMergeCommits(commits.map(commit => getCommitHash(commit)));
	for (const commit of commits) {
		if (mergeCommits.includes(getCommitHash(commit))) {
			commit.classList.add('rgh-merge-commit');
			updateCommitIcon(commit, isPRConversation);
		}
	}
}

async function init(signal: AbortSignal): Promise<void> {
	await expectToken();
	observe([
		'[data-testid="commit-row-item"]',

		'.js-commits-list-item', // `isPRCommitList`
		'.js-timeline-item .TimelineItem:has(.octicon-git-commit)', // `isPRConversation`; "js-timeline-item" excludes "isPRCommitList"
	], batchedFunction(markCommits, {delay: 100}), {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isCommitList,
		pageDetect.isPRConversation,
		pageDetect.isCompare,
	],
	init,
});

/*

Test URLs

- isPRConversation: https://github.com/refined-github/refined-github/pull/6194#event-8016526003
- isPRCommitList: https://github.com/refined-github/refined-github/pull/6194/commits
- isCommitList: https://github.com/typed-ember/ember-cli-typescript/commits/master?after=5ff0c078a4274aeccaf83382c0d6b46323f57397+174
- isCompare: https://github.com/refined-github/sandbox/compare/e8b25d3e...b3d0d992

*/



================================================
FILE: source/features/mark-private-orgs.css
================================================
.rgh-private-org {
	position: relative;
}

.rgh-private-org svg {
	pointer-events: none;
	position: absolute;
	bottom: 2px;
	right: 2px;
	fill: #333;
	stroke: #fff;
	stroke-width: 4px;
	paint-order: stroke;
	overflow: visible !important;
}



================================================
FILE: source/features/mark-private-orgs.tsx
================================================
import './mark-private-orgs.css';

import React from 'dom-chef';
import {CachedFunction} from 'webext-storage-cache';
import EyeClosedIcon from 'octicons-plain-react/EyeClosed';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import api from '../github-helpers/api.js';
import {getLoggedInUser} from '../github-helpers/index.js';
import observe from '../helpers/selector-observer.js';

const publicOrganizationsNames = new CachedFunction('public-organizations', {
	async updater(username: string): Promise<string[]> {
	// API v4 seems to *require* `org:read` permission AND it includes private organizations as well, which defeats the purpose. There's no way to filter them.
	// GitHub's API explorer inexplicably only includes public organizations.
		const response = await api.v3(`/users/${username}/orgs`);
		return response.map((organization: AnyObject) => organization.login);
	},
	maxAge: {hours: 6},
	staleWhileRevalidate: {days: 10},
});

function markPrivate(org: HTMLAnchorElement, organizations: string[]): void {
	if (!organizations.includes(org.pathname.replace(/^\/(organizations\/)?/, ''))) {
		org.classList.add('rgh-private-org');
		org.append(<EyeClosedIcon />);
	}
}

async function init(signal: AbortSignal): Promise<void> {
	const organizations = await publicOrganizationsNames.get(getLoggedInUser()!);
	observe(
		'a.avatar-group-item[data-hovercard-type="organization"][itemprop="follows"]',
		org => {
			markPrivate(org, organizations);
		},
		{signal, stopOnDomReady: true},
	);
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isOwnUserProfile,
	],
	init,
});

/*

Test URLs:

https://github.com/YOUR_USERNAME

*/



================================================
FILE: source/features/mark-private-repos.css
================================================
li.private .Label--secondary {
	border-color: var(
		--borderColor-attention-muted,
		var(--color-attention-muted)
	);
	color: var(--fgColor-attention, var(--color-attention-emphasis, fuchsia));
}

/*

Test URLs:

https://github.com/YOUR_USERNAME?tab=repositories&type=private

Note: it doesn't apply to search results https://github.com/refined-github/refined-github/issues/7585

*/



================================================
FILE: source/features/mobile-tabs.css
================================================
@media (width <= 767px) {
	:root:root .AppHeader-localBar {
		padding: 0;
	}

	:root .UnderlineNav {
		padding-inline: var(--base-size-16, 16px);
		padding-block: 5px var(--control-medium-gap, 8px);
	}

	:root .UnderlineNav-body {
		align-items: stretch; /* Ensure they have the same height */
	}

	:root .UnderlineNav-item {
		display: grid;
		min-width: 50px;
		grid:
			'icon counter'
			'title title';
		gap: 0 5px;
		padding: 6px 10px;
		background: var(
			--control-transparent-bgColor-hover,
			var(--color-action-list-item-default-hover-bg, fuchsia)
		);
	}

	:root .UnderlineNav-item:hover {
		background: var(
			--control-transparent-bgColor-hover,
			var(--color-action-list-item-default-active-bg, fuchsia)
		); /* From: Counter background color */
	}

	:root .UnderlineNav-item.selected::after {
		/* Reposition the orange line */
		bottom: -9px !important;
	}

	:root .UnderlineNav-item [data-content] {
		grid-area: title;
		line-height: 1;
		margin-top: 5px;

		/* font-size: 0; */
		/* Safari 16.4 color bug #6473 */
		font-size: 0.6px;
		color: transparent !important;
	}

	:root .UnderlineNav-item [data-content]::before {
		visibility: inherit;
		height: auto;
		font-size: 10px;
		color: var(--fgColor-default, var(--color-fg-default, fuchsia));
		font-weight: inherit;
	}

	:root [data-content='Pull requests']::before {
		content: 'Pulls' !important;
	}

	/* Tab label on on profiles */
	:root .UnderlineNav-item span[data-view-component]:not([class]) {
		grid-area: title;
		line-height: 1;
		margin-top: 5px;
		font-size: 10px;
	}

	:root .UnderlineNav-item svg {
		margin: 0 !important;
		grid-area: icon;
		justify-self: end;
	}

	:root .UnderlineNav-item .Counter {
		grid-area: counter;
		background: none; /* Counters appears as pills */
		padding: 0;
		margin: 0;
		border: none;
		min-width: min-content;
		justify-self: start;
	}

	/* When counter is missing */
	:root .UnderlineNav-item:not(:has(.Counter)),
	:root .UnderlineNav-item:has(.Counter:empty),
	:root .UnderlineNav-item:has([hidden]) {
		grid-template-areas:
			'icon icon'
			'title title';

		svg {
			justify-self: center;
		}
	}

	/* PR tab navigation */
	/* https://github.com/refined-github/refined-github/issues/7725 */
	#partial-discussion-header + .tabnav .tabnav-tab {
		display: inline-flex;
		flex-wrap: wrap;
		width: min-content;
		white-space: nowrap;
		place-content: center center;
		align-items: center;
		min-width: 7em;
		padding: 0.7em;
		font-size: 13px;

		.octicon {
			order: -2;
			display: block !important;
		}

		.Counter {
			order: -1;
		}

		@media (width <= 500px) {
			font-size: 10px;

			.Counter {
				background: none;
				padding: 0;
				margin: 0;
				min-width: 0;
			}
		}
	}

	@media (width <= 500px) {
		#partial-discussion-header + .tabnav {
			font-size: 10px;

			/* Avoid awkward clipped overflow */
			padding-right: 0 !important;

			.Counter {
				background: none;
				padding: 0;
				margin: 0;
			}
		}
	}
}

/*

Test URLs:

- Repo: https://github.com/refined-github/refined-github
- Org: https://github.com/refined-github
- User: https://github.com/fregante

*/



================================================
FILE: source/features/monospace-textareas.css
================================================
/* Use monospace font in various fields */
/* Use same font-family as GitHub style for `code` */

/* https://github.com/refined-github/sandbox/pull/10#issue-comment-box */
[placeholder='Add an optional extended descriptionâ€¦'],
/* Test URL: https://github.com/refined-github/refined-github/edit/main/.editorconfig */
	#commit-message-input,
/* Test URL: https://github.com/refined-github/refined-github/edit/main/.editorconfig */
	#commit-description-input,
/* Test URL: https://github.com/refined-github/refined-github/releases/new */
	#release_body,
/* Test URL: https://github.com/settings/gpg/new */
	#gpg_key_public_key,
/* Test URL: https://github.com/settings/ssh/new */
	#ssh_key_key {
	font-family:
		ui-monospace, SFMono-Regular, 'SF Mono', Menlo, Consolas, 'Liberation Mono',
		monospace !important;
}



================================================
FILE: source/features/more-conversation-filters.tsx
================================================
import {$, $optional} from 'select-dom/strict.js';
import * as pageDetect from 'github-url-detection';
import {stringToBase64} from 'uint8array-extras';

import features from '../feature-manager.js';
import SearchQuery from '../github-helpers/search-query.js';

function init(): void {
	const sourceItem = $optional('#filters-select-menu a:nth-last-child(2)');
	if (!sourceItem) {
		return;
	}

	// "Involved" filter
	const commentsLink = sourceItem.cloneNode(true);
	commentsLink.lastChild!.textContent = 'Everything youâ€™re involved in';
	commentsLink.removeAttribute('target');
	commentsLink.href = SearchQuery.from(commentsLink).set('is:open involves:@me').href;
	commentsLink.setAttribute('aria-checked', String(commentsLink.href === location.href)); // #4589

	sourceItem.after(commentsLink);

	// "Subscribed" external link
	const searchSyntaxLink = $('#filters-select-menu a:last-child');
	const subscriptionsLink = searchSyntaxLink.cloneNode(true);
	subscriptionsLink.lastElementChild!.textContent = 'Everything you subscribed to';

	const subscriptionsUrl = new URL('https://github.com/notifications/subscriptions');
	const repositoryId
		= $optional('meta[name="octolytics-dimension-repository_id"]')?.content
			?? $('input[name="repository_id"]').value;
	subscriptionsUrl.searchParams.set('repository', stringToBase64(`010:Repository${repositoryId}`));
	subscriptionsLink.href = subscriptionsUrl.href;

	commentsLink.after(subscriptionsLink);
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isRepoIssueOrPRList,
	],
	awaitDomReady: true,
	deduplicate: 'has-rgh-inner',
	init,
});

/*

Test URLs:

https://github.com/refined-github/refined-github/issues
https://github.com/refined-github/refined-github/pulls

*/



================================================
FILE: source/features/more-dropdown-links.css
================================================
/* Always show the overflow menu button */
.rgh-has-more-dropdown .UnderlineNav-actions {
	visibility: visible !important;
}



================================================
FILE: source/features/more-dropdown-links.tsx
================================================
import './more-dropdown-links.css';

import React from 'dom-chef';
import {elementExists} from 'select-dom';
import elementReady from 'element-ready';
import * as pageDetect from 'github-url-detection';
import GitBranchIcon from 'octicons-plain-react/GitBranch';
import GitCompareIcon from 'octicons-plain-react/GitCompare';
import GitCommitIcon from 'octicons-plain-react/GitCommit';
import PackageDependenciesIcon from 'octicons-plain-react/PackageDependencies';

import features from '../feature-manager.js';
import getDefaultBranch from '../github-helpers/get-default-branch.js';
import createDropdownItem from '../github-helpers/create-dropdown-item.js';
import {buildRepoURL} from '../github-helpers/index.js';
import getCurrentGitRef from '../github-helpers/get-current-git-ref.js';
import observe from '../helpers/selector-observer.js';
import {expectToken} from '../github-helpers/github-token.js';

export async function unhideOverflowDropdown(): Promise<boolean> {
	// Wait for the tab bar to be loaded
	const repoNavigationBar = await elementReady('.UnderlineNav-body');

	// No dropdown on mobile #5781
	if (!elementExists('.js-responsive-underlinenav')) {
		return false;
	}

	repoNavigationBar!.parentElement!.classList.add('rgh-has-more-dropdown');
	return true;
}

async function addDropdownItems(repoNavigationDropdown: HTMLElement): Promise<void> {
	const reference = getCurrentGitRef() ?? await getDefaultBranch();
	const compareUrl = buildRepoURL('compare', reference);
	const commitsUrl = buildRepoURL('commits', reference);
	const branchesUrl = buildRepoURL('branches');
	const dependenciesUrl = buildRepoURL('network/dependencies');

	repoNavigationDropdown.append(
		<li className="dropdown-divider" role="separator" />,
		createDropdownItem({
			label: 'Compare',
			href: compareUrl,
			icon: GitCompareIcon,
		}),
		pageDetect.isEnterprise()
			? ''
			: createDropdownItem({
				label: 'Dependencies',
				href: dependenciesUrl,
				icon: PackageDependenciesIcon,
			}),
		createDropdownItem({
			label: 'Commits',
			href: commitsUrl,
			icon: GitCommitIcon,
		}),
		createDropdownItem({
			label: 'Branches',
			href: branchesUrl,
			icon: GitBranchIcon,
		}),
	);
}

async function init(signal: AbortSignal): Promise<void> {
	await expectToken();
	await unhideOverflowDropdown();

	observe('.UnderlineNav-actions ul', addDropdownItems, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.hasRepoHeader,
	],
	init,
});

/*

Test URLs:

https://github.com/refined-github/refined-github

*/



================================================
FILE: source/features/more-file-links.tsx
================================================
import React from 'dom-chef';
import {$} from 'select-dom/strict.js';
import * as pageDetect from 'github-url-detection';
import delegate, {type DelegateEvent} from 'delegate-it';
import FileCodeIcon from 'octicons-plain-react/FileCode';
import VersionsIcon from 'octicons-plain-react/Versions';
import HistoryIcon from 'octicons-plain-react/History';

import features from '../feature-manager.js';
import GitHubFileURL from '../github-helpers/github-file-url.js';

function getLegacyMenuItem(viewFile: HTMLAnchorElement, name: string, route: string): JSX.Element {
	const {href} = new GitHubFileURL(viewFile.href).assign({route});
	return (
		<a href={href} data-turbo={String(route !== 'raw')} className="pl-5 dropdown-item btn-link" role="menuitem">
			View {name}
		</a>
	);
}

function handleLegacyMenuOpening({delegateTarget: dropdown}: DelegateEvent): void {
	dropdown.classList.add('rgh-more-file-links'); // Mark this as processed

	const viewFile = $('a[data-ga-click^="View file"]', dropdown);
	viewFile.after(
		getLegacyMenuItem(viewFile, 'raw', 'raw'),
		getLegacyMenuItem(viewFile, 'blame', 'blame'),
		getLegacyMenuItem(viewFile, 'history', 'commits'),
		<div className="dropdown-divider" role="none" />,
	);
}

function getMenuItem(viewFile: HTMLElement, name: string, route: string, icon: React.JSX.Element): HTMLElement {
	const menuItem = viewFile.cloneNode(true);
	const fileLink = $('a', viewFile).href;
	const link = $('a', menuItem);
	link.href = new GitHubFileURL(fileLink).assign({route}).href;
	link.dataset.turbo = String(route !== 'raw');
	$('[class^="prc-ActionList-ItemLabel"]', menuItem).textContent = `View ${name}`;
	$('[class^="prc-ActionList-LeadingVisual"]', menuItem).replaceChildren(icon);
	return menuItem;
}

function handleMenuOpening(): void {
	const viewFile = $('[class^="prc-ActionList-ActionListItem"]:has(.octicon-eye)');
	viewFile.after(
		getMenuItem(viewFile, 'raw', 'raw', <FileCodeIcon />),
		getMenuItem(viewFile, 'blame', 'blame', <VersionsIcon />),
		getMenuItem(viewFile, 'history', 'commits', <HistoryIcon />),
		viewFile.nextElementSibling?.getAttribute('data-component') === 'ActionList.Divider'
			? ''
			: <li className="dropdown-divider" aria-hidden="true" data-component="ActionList.Divider" />,
	);
}

function init(signal: AbortSignal): void {
	// `capture: true` required to be fired before GitHub's handlers
	delegate('.file-header .js-file-header-dropdown:not(.rgh-more-file-links)', 'toggle', handleLegacyMenuOpening, {capture: true, signal});
	delegate('[class^="DiffFileHeader-module__diff-file-header"] button:has(>.octicon-kebab-horizontal)', 'click', handleMenuOpening);
}

void features.add(import.meta.url, {
	include: [
		pageDetect.hasFiles,
	],
	init,
});

/*

Test URLs:
https://github.com/refined-github/sandbox/pull/55/files
https://github.com/refined-github/sandbox/compare/41c25160f0f574b302d72652ac83f4b2dab47e19...770d2ad5f086371da8a5f078f4267e6847e649f5
https://github.com/refined-github/sandbox/commit/0504e7dccb40374c24c1217f37d3579993d6071e

*/



================================================
FILE: source/features/netiquette.tsx
================================================
import React from 'dom-chef';
import FlameIcon from 'octicons-plain-react/Flame';
import * as pageDetect from 'github-url-detection';
import toMilliseconds from '@sindresorhus/to-milliseconds';
import {$optional} from 'select-dom/strict.js';
import {countElements, elementExists} from 'select-dom';
import twas from 'twas';
import InfoIcon from 'octicons-plain-react/Info';
import GitPullRequestDraftIcon from 'octicons-plain-react/GitPullRequestDraft';

import createBanner from '../github-helpers/banner.js';
import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';
import {
	buildRepoURL,
	getConversationNumber,
	isAnyRefinedGitHubRepo,
	isOwnConversation,
} from '../github-helpers/index.js';
import {newCommentField} from '../github-helpers/selectors.js';
import {userIsModerator} from '../github-helpers/get-user-permission.js';
import looseParseInt from '../helpers/loose-parse-int.js';
import api from '../github-helpers/api.js';

export async function getCloseDate(): Promise<Date | undefined> {
	if (pageDetect.isOpenConversation()) {
		return;
	}

	const {closed_at: closedAt} = await api.v3(`issues/${getConversationNumber()!}`);
	if (!closedAt) {
		throw new TypeError('closed_at field is null');
	}

	return new Date(closedAt);
}

const threeMonths = toMilliseconds({days: 90});

export function wasLongAgo(date: Date): boolean {
	return (Date.now() - date.getTime()) > threeMonths;
}

function isPopular(): boolean {
	return (
		countElements('[data-testid="comment-header"]') > 30
		|| looseParseInt($optional('[aria-label*="other participants"]')?.ariaLabel) > 30
		|| elementExists('[data-testid="issue-timeline-load-more-count-front"]')
		// TODO: Drop in April 2025; old conversation style
		|| countElements('.timeline-comment') > 30
		|| countElements('.participant-avatar') > 10
	);
}

export function getResolvedText(closingDate: Date): JSX.Element {
	const ago = <strong>{twas(closingDate.getTime())}</strong>;
	const newIssue = <a href={buildRepoURL('issues/new/choose')}>new issue</a>;
	return (
		<>
			This {pageDetect.isPR() ? 'PR' : 'issue'} was closed {ago}. Please consider opening a {newIssue} instead of leaving a comment here.
		</>
	);
}

function addResolvedBanner(newCommentField: HTMLElement, closingDate: Date): void {
	if (elementExists('.rgh-resolved-banner')) {
		return;
	}

	const reactWrapper = newCommentField.closest('[class^="InlineAutocomplete"]');
	const banner = createBanner({
		icon: <InfoIcon className="m-0" />,
		classes: 'm-0 p-2 text-small color-fg-muted border-0 rounded-0 rgh-resolved-banner'.split(' '),
		text: getResolvedText(closingDate),
	});

	if (reactWrapper) {
		reactWrapper.prepend(banner);
	} else {
		banner.classList.replace('rounded-0', 'm-2');
		newCommentField.prepend(banner);
	}
}

function addPopularBanner(newCommentField: HTMLElement): void {
	if (elementExists('.rgh-popular-banner')) {
		return;
	}

	const reactWrapper = newCommentField.closest('[class^="InlineAutocomplete"]');
	const banner = createBanner({
		icon: <FlameIcon className="m-0" />,
		classes: 'p-2 text-small color-fg-muted border-0 rounded-0 rgh-popular-banner'.split(' '),
		text: 'This issue is highly active. Reconsider commenting unless you have read all the comments and have something to add.',
	});

	if (reactWrapper) {
		reactWrapper.prepend(banner);
	} else {
		banner.classList.replace('rounded-0', 'm-2');
		newCommentField.prepend(banner);
	}
}

function addDraftBanner(newCommentField: HTMLElement): void {
	newCommentField.prepend(
		createBanner({
			icon: <GitPullRequestDraftIcon className="m-0" />,
			classes: 'p-2 my-2 mx-md-2 text-small color-fg-muted border-0'.split(' '),
			text: <>This is a <strong>draft PR</strong>, it might not be ready for review.</>,
		}),
	);
}

function initDraft(signal: AbortSignal): void {
	observe(newCommentField, addDraftBanner, {signal});
}

function initBanner(signal: AbortSignal): void {
	observe(newCommentField, async (field: HTMLElement) => {
		// Check inside the observer because React views load after dom-ready
		const closingDate = await getCloseDate();
		if (closingDate && wasLongAgo(closingDate)) {
			addResolvedBanner(field, closingDate);
		} else if (isPopular() && !(await userIsModerator())) {
			addPopularBanner(field);
		}
	}, {signal});
}

function makeFieldKinder(field: HTMLParagraphElement): void {
	if (field.textContent.trim() === 'Add your comment here...') {
		// Regular issue/PR comment field, or single review comments
		// https://github.com/refined-github/refined-github/pull/6991
		field.textContent = 'Add your comment here, be kind';
	} else if (field.textContent.trim() === 'Leave a comment') {
		// Main review comment field
		// https://github.com/refined-github/refined-github/pull/6991/files
		field.textContent = 'Leave a comment, be kind';
	} else {
		throw new Error(`Unexpected placeholder text: ${field.textContent}`);
	}
}

function makeReactFieldKinder(field: HTMLTextAreaElement): void {
	field.placeholder = 'Add your comment here, be kind';
}

function initKindness(signal: AbortSignal): void {
	observe('p.CommentBox-placeholder', makeFieldKinder, {signal});
	observe([
		'textarea[placeholder="Use Markdown to format your comment"]', // On issues
		'textarea[placeholder="Leave a comment"]', // On single commits
	], makeReactFieldKinder, {signal});
}

void features.add(import.meta.url, {
	exclude: [
		isAnyRefinedGitHubRepo,
	],
	include: [
		pageDetect.isConversation,
	],
	awaitDomReady: true, // We're specifically looking for the last event
	init: initBanner,
}, {
	include: [
		pageDetect.isDraftPR,
	],
	exclude: [
		isOwnConversation,
	],
	awaitDomReady: true,
	init: initDraft,
}, {
	include: [
		pageDetect.hasComments,
	],
	init: initKindness,
});

/*

Test URLs

- Old issue: https://togithub.com/facebook/react/issues/227
- Old PR: https://togithub.com/facebook/react/pull/209
- Popular issue: https://togithub.com/facebook/react/issues/13991
- Draft PR: https://github.com/refined-github/sandbox/pull/7

*/



================================================
FILE: source/features/new-milestone-button.tsx
================================================
import React from 'dom-chef';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';
import {buildRepoURL} from '../github-helpers/index.js';

function addButton(editButton: Element): void {
	editButton.before(
		<a
			href={buildRepoURL('milestones/new')}
			className="btn"
		>
			New Milestone
		</a>,
	);
}

function init(signal: AbortSignal): void {
	const repoBase = buildRepoURL('milestones');

	observe(`a[href*="${repoBase}/"][href$="/edit"]`, addButton, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isMilestone,
	],
	init,
});

/*
Test URLs:

https://github.com/go-gitea/gitea/milestone/186
*/



================================================
FILE: source/features/new-or-deleted-file.tsx
================================================
import React from 'dom-chef';
import {$, $optional} from 'select-dom/strict.js';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';

function add(fileHeader: HTMLDivElement): void {
	const list = $optional('ul[aria-label="File Tree"]');
	if (!list && pageDetect.isCommit()) {
		// Silence error, single-file commits don't have the file list
		return;
	}

	// Link--primary excludes CODEOWNERS icon #5565
	const fileLink = $('a.Link--primary', fileHeader);

	const fileInList = $optional([
		`[href="${fileLink.hash}"]`, // TODO: Old PR Files view, drop in 2026
		`[class^="PRIVATE_TreeView-item-content"]:has([href="${fileLink.hash}"])`,
	], list);
	if (!fileInList) {
		features.unload(import.meta.url);
		throw new Error('Could not find file in sidebar, is the sidebar loaded?');
	}

	const icon = $optional([
		'.octicon-diff-removed', // TODO: Old PR Files view, drop in 2026
		'.octicon-diff-added', // TODO: Old PR Files view, drop in 2026
		'.octicon-file-removed',
		'.octicon-file-added',
		'.octicon-file-moved',
	], fileInList)
		?.cloneNode(true);
	if (icon) {
		// `span` needed for native vertical alignment
		fileHeader.append(<span className="ml-1">{icon}</span>);
	}
}

async function init(signal: AbortSignal): Promise<void> {
	observe([
		'div.file-info', // TODO: Old PR Files view, drop in 2026
		'div[class*="DiffFileHeader-module__file-path-section"]',
	], add, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isPRFiles,
		pageDetect.isCommit,
	],
	init,
});

/*

## Test URLs

Commit: https://github.com/refined-github/sandbox/commit/a00694ff7370d46b5f6d723a0b39141903dae45a
PR: https://github.com/refined-github/sandbox/pull/71/files
PR with CODEOWNERS: https://github.com/dotnet/winforms/pull/6028/files
1-file commits: https://github.com/refined-github/sandbox/commit/1ed862e3abd13004009927b26355a51a109d6855

*/



================================================
FILE: source/features/new-repo-disable-projects-and-wikis.tsx
================================================
import React from 'dom-chef';
import {$, $optional} from 'select-dom/strict.js';
import delegate from 'delegate-it';
import domLoaded from 'dom-loaded';
import * as pageDetect from 'github-url-detection';
import {elementExists} from 'select-dom';

import onetime from '../helpers/onetime.js';
import features from '../feature-manager.js';
import api from '../github-helpers/api.js';
import observe from '../helpers/selector-observer.js';
import {expectToken} from '../github-helpers/github-token.js';

const documentation = 'https://github.com/refined-github/refined-github/wiki/Extended-feature-descriptions#new-repo-disable-projects-and-wikis';

async function disableWikiAndProjectsOnce(): Promise<void> {
	delete sessionStorage.rghNewRepo;

	await api.v3('', {
		method: 'PATCH',
		body: {
			has_projects: false,
			has_wiki: false,
		},
	});
	await domLoaded;
	$optional('[data-menu-item$="wiki-tab"]')?.remove();
	$optional('[data-menu-item$="projects-tab"]')?.remove();
	$optional('li:has([data-content="Wiki"]')?.remove();
	$optional('li:has([data-content="Projects"])')?.remove();
}

function setStorage(): void {
	if ($('input#rgh-disable-project').checked) {
		sessionStorage.rghNewRepo = true;
	}
}

function add(blueprintRow: HTMLElement): void {
	const disableProjectsAndWikis = blueprintRow.cloneNode(true);

	disableProjectsAndWikis.classList.add('flash-warn');

	const title = $('.titleBox h3', disableProjectsAndWikis);
	title.textContent = 'Disable Projects and Wikis';

	const description = $('.descriptionBox p', disableProjectsAndWikis);
	description.replaceChildren(
		'After creating the repository disable the projects and wiki. ',
		<a href={documentation} target="_blank" rel="noreferrer">Suggestion by Refined GitHub.</a>,
	);

	const control = $('.blockControl', disableProjectsAndWikis);
	control.replaceChildren(
		// Padding/margin classes added to increate hit area
		<label className="d-flex gap-1 flex-items-center p-2 mr-n2">
			Disable
			<input
				checked
				// @ts-expect-error Safari only
				switch
				type="checkbox"
				id="rgh-disable-project"
			/>
		</label>,
	);
	control.classList.add('d-flex', 'flex-items-center');

	blueprintRow.parentElement!.append(disableProjectsAndWikis);
}

function addOld(submitButton: HTMLElement): void {
	// .github repos have a banner that matches this #8716
	if (elementExists('[data-testid="special-repo-name-banner"]')) {
		return;
	}

	submitButton.classList.add('mt-0'); // Normalize it. /new has margin, /:user/:repo/fork does not
	submitButton.parentElement!.before(
		<div className="flash flash-warn py-0 ml-n3 my-4">
			<div className="form-checkbox checked">
				<label>
					<input
						checked
						type="checkbox"
						id="rgh-disable-project"
					/> Disable Projects and Wikis
				</label>
				<span className="note mb-2">
					After creating the repository disable the projects and wiki. <a href={documentation} target="_blank" rel="noreferrer">Suggestion by Refined GitHub.</a>
				</span>
			</div>
		</div>,
	);
}

async function init(signal: AbortSignal): Promise<void> {
	await expectToken();
	observe('[class^="ControlGroupContainer"]:has(#visibility-anchor-button)', add, {signal});
	observe('form:has(.octicon-info) [type=submit]', addOld, {signal});
	delegate('form', 'submit', setStorage, {signal, capture: true});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isNewRepo,
		pageDetect.isNewRepoTemplate,
		pageDetect.isForkingRepo,
	],
	init,
}, {
	include: [
		() => Boolean(sessionStorage.rghNewRepo),
	],
	init: onetime(disableWikiAndProjectsOnce),
});

/*

Test URLs:

https://github.com/new
https://github.com/new?template_name=browser-extension-template&template_owner=fregante

*/



================================================
FILE: source/features/night-not-found.css
================================================
/* Animate :hover Octocat brightening */
.font-mktg > .position-relative [height='230'] {
	transition: filter 1s ease-out;
}

/* These are 2 exact copies: one for always-dark mode and the other one for auto mode */
[data-color-mode='dark'] {
	.font-mktg > .position-relative {
		[height='249'] {
			filter: invert();
		}

		[height='230']:not(:hover) {
			filter: brightness(0.7) saturate(0.5) contrast(1.3);
		}

		[height='156'] {
			filter: brightness(0.3) saturate(0.5);
		}

		[height='49'] {
			filter: brightness(0.8) saturate(0.5);
		}

		[height='123'] {
			filter: brightness(0.15) saturate(0.5);
		}

		[height='415'],
		[height='75'],
		[height='50'] {
			filter: brightness(0.1) saturate(0.5);
		}
	}

	/* Dark dimmed */
	&[data-dark-theme='dark_dimmed'] .font-mktg > .position-relative {
		[height='249'] {
			filter: brightness(0.5);
		}

		[height='230']:not(:hover) {
			filter: brightness(0.8) saturate(0.5) contrast(1.3);
		}

		[height='156'] {
			filter: brightness(0.5) saturate(0.5);
		}

		[height='49'] {
			filter: brightness(0.9) saturate(0.5);
		}

		[height='415'],
		[height='75'],
		[height='50'],
		[height='123'] {
			filter: brightness(0.3) saturate(0.5);
		}
	}
}

/* Auto mode, dark */
@media (prefers-color-scheme: dark) {
	/* Dark */
	[data-color-mode='auto'] {
		.font-mktg > .position-relative {
			[height='249'] {
				filter: invert();
			}

			[height='230']:not(:hover) {
				filter: brightness(0.7) saturate(0.5) contrast(1.3);
			}

			[height='156'] {
				filter: brightness(0.3) saturate(0.5);
			}

			[height='49'] {
				filter: brightness(0.8) saturate(0.5);
			}

			[height='123'] {
				filter: brightness(0.15) saturate(0.5);
			}

			[height='415'],
			[height='75'],
			[height='50'] {
				filter: brightness(0.1) saturate(0.5);
			}
		}

		/* Dark dimmed */
		&[data-dark-theme='dark_dimmed'] .font-mktg > .position-relative {
			[height='249'] {
				filter: brightness(0.5);
			}

			[height='230']:not(:hover) {
				filter: brightness(0.8) saturate(0.5) contrast(1.3);
			}

			[height='156'] {
				filter: brightness(0.5) saturate(0.5);
			}

			[height='49'] {
				filter: brightness(0.9) saturate(0.5);
			}

			[height='415'],
			[height='75'],
			[height='50'],
			[height='123'] {
				filter: brightness(0.3) saturate(0.5);
			}
		}
	}
}

/*

Test URLs:

https://github.com/fregante-404
https://github.com/fregante/404

*/



================================================
FILE: source/features/no-duplicate-list-update-time.tsx
================================================
import {$$} from 'select-dom';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';

function parseTime(element: HTMLElement): number {
	return new Date(element.getAttribute('datetime')!).getTime();
}

function remove(issue: HTMLElement): void {
	const [stateChangeTime, updateTime] = $$('relative-time', issue);
	if (parseTime(updateTime) - parseTime(stateChangeTime) < 10_000) { // Hide if within 10 seconds
		updateTime.parentElement!.remove();
	}
}

function init(signal: AbortSignal): void {
	observe('.js-navigation-item[id^="issue_"]', remove, {signal});
}

void features.add(import.meta.url, {
	asLongAs: [
		() => location.search.includes('sort%3Aupdated-'),
	],
	include: [
		pageDetect.isIssueOrPRList,
	],
	init,
});

/*

Test URLs:

This feature applies to conversation lists sorted by updated time

- https://github.com/sindresorhus/refined-github/pulls?q=sort%3Aupdated-asc+is%3Aclosed
- https://github.com/sindresorhus/refined-github/issues?q=is%3Aissue+sort%3Aupdated-desc+is%3Aclosed+comments%3A0
- https://github.com/issues?q=is%3Aissue+is%3Aopen+author%3Afregante+archived%3Afalse+sort%3Aupdated-desc

*/



================================================
FILE: source/features/no-modals.tsx
================================================
import * as pageDetect from 'github-url-detection';
import delegate, {type DelegateEvent} from 'delegate-it';

import features from '../feature-manager.js';

function fix(event: DelegateEvent<MouseEvent, HTMLAnchorElement>): void {
	event.stopImmediatePropagation();
	event.delegateTarget.removeAttribute('target');
}

function init(signal: AbortSignal): void {
	delegate([
		'a[href$="/issues/new/choose"]', // New issue button
		'a[class*="SubIssueTitle"]', // Sub-issue links
		'a[data-testid="issue-pr-title-link"]', // Global issue list links
	], 'click', fix, {signal, capture: true});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isIssue,
		pageDetect.isRepoIssueList,
		pageDetect.isGlobalIssueOrPRList,
	],
	init,
});

/*

Test URLs:

https://github.com/refined-github/sandbox/issues
https://github.com/refined-github/sandbox/issues/110

*/



================================================
FILE: source/features/no-self-reference.tsx
================================================
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';

function underlineSelfReference(link: HTMLElement): void {
	link.title = 'Link is a self-reference';

	// Disable link and hovercard
	link.removeAttribute('href');
	link.removeAttribute('data-hovercard-url');

	// TODO: Use shorthand `text-decoration` property in 2027 (due to Safari 18)
	link.style.textDecorationLine = 'underline';
	link.style.textDecorationStyle = 'wavy';
	link.style.textDecorationColor = 'red';
}

function init(signal: AbortSignal): void {
	const [currentPage] = location.href.split('#');
	observe(`.issue-link[href="${currentPage}"]`, underlineSelfReference, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isPR,
		pageDetect.isIssue,
	],
	init,
});

/*

## Test URLs

https://github.com/refined-github/sandbox/pull/120
https://github.com/refined-github/sandbox/issues/122

*/



================================================
FILE: source/features/no-unnecessary-split-diff-view.css
================================================
html:not([rgh-OFF-no-unnecessary-split-diff-view]) {
	/* The selector looks for diff tables WITHOUT changes on the left XOR on the right */
	/* Instead of duplicating this selector for each rule, we set a variable and pick it up where needed */

	.js-diff-table:has([data-split-side]) {
		&:not(
				:has(
						[data-split-side='left']:is(
								.blob-code-addition,
								.blob-code-deletion
							)
					)
			) {
			--rgh-only-additions: none;

			table-layout: auto !important;
		}

		&:not(
				:has(
						[data-split-side='right']:is(
								.blob-code-addition,
								.blob-code-deletion
							)
					)
			) {
			--rgh-only-deletions: none;

			table-layout: auto !important;
		}
	}

	[data-hunk],
	.blob-expanded {
		/* Only additions: Hide the left side */
		td:nth-child(2) {
			display: var(--rgh-only-additions, table-cell) !important;
		}

		/* Only deletions: Hide the right side */
		td:nth-child(4) {
			display: var(--rgh-only-deletions, table-cell) !important;
		}
	}

	/* Any applicable situation: Re-align annotations */
	:is(.inline-comments, .js-inline-annotations) .empty-cell:not(.blob-num) {
		display: var(
			--rgh-only-additions,
			var(--rgh-only-deletions, table-cell)
		) !important;
	}
}

/* TODO: remove everything above in late 2026 */
.rgh-no-split-diff {
	table-layout: auto !important;

	/* No changes on the left side */
	&.rgh-only-additions {
		--rgh-left-side-d: none;
		--rgh-right-side-w: 100%;
	}

	/* No changes on the right side */
	&.rgh-only-deletions {
		--rgh-right-side-d: none;
		--rgh-left-side-w: 100%;
	}

	/* Align line number cells with the header first cell */
	.diff-line-number {
		min-width: 40px;
	}

	.diff-line-row {
		/* The left side (deletions) */
		/* > to avoid selecting suggested changes */
		& > td:nth-child(2) {
			/* Only additions: hide the left side */
			display: var(--rgh-left-side-d, table-cell) !important;
			/* Only deletions: expand the left side */
			width: var(--rgh-left-side-w, auto) !important;
		}

		/* The right side (additions) */
		/* > to avoid selecting suggested changes */
		& > td:nth-child(4) {
			/* Only deletions: hide the right side */
			display: var(--rgh-right-side-d, table-cell) !important;
			/* Only additions: expand the right side */
			width: var(--rgh-right-side-w, auto) !important;
		}
	}
}



================================================
FILE: source/features/no-unnecessary-split-diff-view.tsx
================================================
import './no-unnecessary-split-diff-view.css';
import * as pageDetect from 'github-url-detection';
import {$, $optional} from 'select-dom/strict.js';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';

/* TODO: remove in late 2026 */
void features.addCssFeature(import.meta.url);

function manageSplitDiffState(tableBody: HTMLTableSectionElement): void {
	const table = tableBody.closest('table')!;
	const columnsGroup = $('colgroup', table);
	// Diff view is unified
	if (columnsGroup.childElementCount !== 4) {
		table.classList.remove('rgh-no-split-diff');
		return;
	}

	// Avoid selecting suggested deletions/additions
	if (!$optional(':scope > tr > td:nth-child(2) > .deletion', tableBody)) {
		table.classList.add('rgh-no-split-diff', 'rgh-only-additions');
	} else if (!$optional(':scope > tr > td:nth-child(4) > .addition', tableBody)) {
		table.classList.add('rgh-no-split-diff', 'rgh-only-deletions');
	}
}

function init(signal: AbortSignal): void {
	observe('[class*="DiffLines-module__tableLayoutFixed"] > tbody', manageSplitDiffState, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isPR,
		pageDetect.isCompare,
		pageDetect.isCommit,
	],
	init,
});

/*

## Test URLs

### PR files

https://github.com/refined-github/sandbox/pull/50/files?diff=split

### PR files with annotations

https://github.com/fregante/sandbox/pull/30/files

### Compare page

https://github.com/refined-github/sandbox/compare/no-unnecessary-split-diff-view?expand=1&diff=split

### Single commit

https://github.com/refined-github/sandbox/commit/c28cc8e5271452b5b4c347d46a63f717c29417d6?diff=split

*/



================================================
FILE: source/features/one-click-diff-options.tsx
================================================
import React from 'dom-chef';
import {elementExists} from 'select-dom';
import {$, $optional} from 'select-dom/strict.js';
import * as pageDetect from 'github-url-detection';
import BookIcon from 'octicons-plain-react/Book';
import CheckIcon from 'octicons-plain-react/Check';
import DiffIcon from 'octicons-plain-react/Diff';
import DiffModifiedIcon from 'octicons-plain-react/DiffModified';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';
import {removeTextNodeContaining} from '../helpers/dom-utils.js';

function isHidingWhitespace(): boolean {
	// The selector is the native button
	return new URL(location.href).searchParams.get('w') === '1' || elementExists('button[name="w"][value="0"]:not([hidden])');
}

function createWhitespaceButton(): HTMLElement {
	const url = new URL(location.href);

	if (isHidingWhitespace()) {
		url.searchParams.delete('w');
	} else {
		url.searchParams.set('w', '1');
	}

	return (
		<a
			href={url.href}
			data-hotkey="d w"
			className={'tooltipped tooltipped-s btn btn-sm tooltipped ' + (isHidingWhitespace() ? 'color-fg-subtle' : '')}
			aria-label={`${isHidingWhitespace() ? 'Show' : 'Hide'} whitespace changes`}
		>
			{isHidingWhitespace() && <CheckIcon />} No Whitespace
		</a>
	);
}

function attachPRButtons(dropdown: HTMLDetailsElement): void {
	const diffSettingsForm = $('form[action$="/diffview"]', dropdown);

	// Preserve data before emption the form
	const isUnified = new FormData(diffSettingsForm).get('diff') === 'unified';
	const token = $('[name="authenticity_token"]', diffSettingsForm);

	// Empty form except the token field
	diffSettingsForm.replaceChildren(token);

	const type = isUnified ? 'split' : 'unified';
	const Icon = isUnified ? BookIcon : DiffIcon;
	diffSettingsForm.append(
		<button
			className="tooltipped tooltipped-s ml-2 btn-link Link--muted px-2"
			aria-label={`Switch to the ${type} diff view`}
			name="diff"
			value={type}
			type="submit"
		>
			<Icon className="v-align-middle" />
		</button>,
	);

	if (!isHidingWhitespace()) {
		diffSettingsForm.append(
			<button
				data-hotkey="d w"
				className="tooltipped tooltipped-s btn-link Link--muted px-2"
				aria-label="Hide whitespace changes"
				name="w"
				value="1"
				type="submit"
			>
				<DiffModifiedIcon className="v-align-middle" />
			</button>,
		);
	}

	dropdown.replaceWith(diffSettingsForm);

	// Trim title
	const prTitle = $optional('.pr-toolbar .js-issue-title');
	if (prTitle && elementExists('.pr-toolbar progress-bar')) { // Only review view has progress-bar
		prTitle.style.maxWidth = '24em';
		prTitle.title = prTitle.textContent;
	}

	// Make space for the new button #655
	removeTextNodeContaining(
		$('[data-hotkey="c"] strong').previousSibling!,
		'Changes from',
	);

	// Remove extraneous padding around "Clear filters" button
	$optional('.subset-files-tab')?.classList.replace('px-sm-3', 'ml-sm-2');
}

function initPR(signal: AbortSignal): void {
	// There are two "diff settings" element, one for mobile and one for the desktop. We only replace the one for the desktop
	observe('.hide-sm.hide-md details.diffbar-item:has(svg.octicon-gear)', attachPRButtons, {signal});
}

function attachButtons(nativeDiffButtons: HTMLElement): void {
	const anchor = nativeDiffButtons.parentElement!;

	// `usesFloats` is necessary to ensure the order and spacing as seen in #5958
	const usesFloats = anchor?.classList.contains('float-right');
	if (usesFloats) {
		anchor.after(
			<div className="float-right mr-3">
				{createWhitespaceButton()}
			</div>,
		);
	} else {
		anchor.before(createWhitespaceButton());
	}
}

function init(signal: AbortSignal): void {
	observe('[action="/users/diffview"]', attachButtons, {signal});
}

const shortcuts = {
	'd w': 'Show/hide whitespaces in diffs',
};

void features.add(import.meta.url, {
	shortcuts,
	include: [
		pageDetect.isPRFiles,
	],
	exclude: [
		pageDetect.isPRFile404,
		pageDetect.isEnterprise, // #5820
	],
	init: initPR,
}, {
	shortcuts,
	include: [
		pageDetect.isCompare,
	],
	init,
});

/*
# Test URLs

- PR files: https://github.com/refined-github/refined-github/pull/6261/files
- Compare, in "Files changed" tab: https://github.com/rancher/rancher/compare/v2.6.3...v2.6.6
- Compare, without tab: https://github.com/rancher/rancher/compare/v2.6.5...v2.6.6
- Single commit: https://github.com/rancher/rancher/commit/e82921075436c21120145927d5a66037661fcf4e

*/



================================================
FILE: source/features/one-click-pr-or-gist.css
================================================
/* For the 1st button "Create public Gist" */
#gists + div button[value='1'] {
	margin-left: auto !important;
	margin-right: 0;
}



================================================
FILE: source/features/one-click-pr-or-gist.tsx
================================================
import './one-click-pr-or-gist.css';

import React from 'dom-chef';
import {$$, elementExists} from 'select-dom';
import {$, $optional} from 'select-dom/strict.js';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';

function init(): void | false {
	const initialGroupedButtons = $optional('.BtnGroup:has([name="draft"], [name="gist[public]"])');
	if (!initialGroupedButtons) {
		// 1. Free accounts can't open Draft PRs in private repos, so this element is missing
		// 2. PRs can't be created from some comparison pages: Either base is a tag, not a branch; or there already exists a PR.
		return false;
	}

	const parent = initialGroupedButtons.parentElement!;

	for (const dropdownItem of $$('.select-menu-item', initialGroupedButtons)) {
		let title = $('.select-menu-item-heading', dropdownItem).textContent.trim();
		const description = $('.description', dropdownItem).textContent.trim();
		const radioButton = $('input[type=radio]', dropdownItem);
		const classList = ['btn', 'ml-2', 'tooltipped', 'tooltipped-s'];

		if (/\bdraft\b/i.test(title)) {
			title = 'Create draft PR';
		} else {
			classList.push('btn-primary');
		}

		initialGroupedButtons.after(
			<button
				data-disable-invalid
				className={classList.join(' ')}
				aria-label={description}
				type="submit"
				name={radioButton.name}
				value={radioButton.value}
			>
				{title}
			</button>,
		);
	}

	initialGroupedButtons.remove();

	// Add minimal structure validation before adding a dangerous class
	if (parent.classList.contains('d-flex') && parent.parentElement!.classList.contains('flex-justify-end')) {
		parent.parentElement!.classList.add('flex-wrap');
	}
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isCompare,
		pageDetect.isGist,
	],
	exclude: [
		() => elementExists('[data-show-dialog-id="drafts-upgrade-dialog"]'),
	],
	deduplicate: 'has-rgh',
	awaitDomReady: true,
	init,
});

/*

Test URLs

- Normal: https://github.com/refined-github/sandbox/compare/default-a...fregante-patch-1
- "Allow edits from maintainers": https://github.com/refined-github/refined-github/compare/main...fregante:refined-github:main?expand=1

*/



================================================
FILE: source/features/one-click-review-submission.tsx
================================================
import React from 'dom-chef';
import delegate, {type DelegateEvent} from 'delegate-it';
import * as pageDetect from 'github-url-detection';
import CheckIcon from 'octicons-plain-react/Check';
import FileDiffIcon from 'octicons-plain-react/FileDiff';
import {$} from 'select-dom/strict.js';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';
import {assertNodeContent} from '../helpers/dom-utils.js';

function replaceCheckboxes(originalSubmitButton: HTMLButtonElement): void {
	const form = originalSubmitButton.form!;
	const actionsRow = originalSubmitButton.closest('.Overlay-footer');
	const formAttribute = originalSubmitButton.getAttribute('form')!;

	// Do not use `$$` because elements can be outside `form`
	// `RadioNodeList` is dynamic, so we need to make a copy
	const radios = [...form.elements.namedItem('pull_request_review[event]') as RadioNodeList] as HTMLInputElement[];
	if (radios.length === 0) {
		throw new Error('Could not find radio buttons');
	}

	// Set the default action for cmd+enter to Comment
	if (radios.length > 1) {
		form.prepend(
			<input
				type="hidden"
				name="pull_request_review[event]"
				value="comment"
			/>,
		);
	}

	if (actionsRow) {
		actionsRow.prepend(<span className="spacer.gif ml-auto" />);
		radios.reverse();
	}

	// Generate the new buttons
	for (const radio of radios) {
		const parent = radio.parentElement!;
		const labelElement = (
			parent.querySelector('label')
			?? radio.nextSibling! // TODO: Remove after April 2025
		);
		const tooltip = $([
			'p', // TODO: Remove after April 2025
			'.FormControl-caption',
		], parent).textContent.trim().replace(/\.$/, '');
		assertNodeContent(labelElement, /^(Approve|Request changes|Comment)$/);

		const classes = ['btn btn-sm'];

		if (tooltip) {
			classes.push('tooltipped tooltipped-nw tooltipped-no-delay');
		}

		const button = (
			<button
				type="submit"
				name="pull_request_review[event]"
				// Old version of GH don't nest the submit button inside the form, so must be linked manually. Issue #6963.
				form={formAttribute}
				value={radio.value}
				className={classes.join(' ')}
				aria-label={tooltip}
				disabled={radio.disabled}
			>
				{labelElement.textContent}
			</button>
		);

		if (!radio.disabled && radio.value === 'approve') {
			button.prepend(<CheckIcon className="color-fg-success" />);
		} else if (!radio.disabled && radio.value === 'reject') {
			button.prepend(<FileDiffIcon className="color-fg-danger" />);
		}

		if (actionsRow) {
			actionsRow.prepend(button);
		} else {
			// TODO: For GHE. Remove after June 2025
			const legacyActionsRow = originalSubmitButton.closest('.form-actions')!;
			legacyActionsRow.append(button);
		}
	}

	// Remove original fields at last to avoid leaving a broken form
	const fieldset = radios[0].closest('fieldset');

	if (fieldset) {
		fieldset.remove();
	} else {
		// To retain backwards compatibility with older GHE versions, remove any radios not within a fieldset. Issue #6963.
		for (const radio of radios) {
			radio.closest('.form-checkbox')!.remove();
		}
	}

	originalSubmitButton.remove();
}

let lastSubmission: number | undefined;
function blockDuplicateSubmissions(event: DelegateEvent): void {
	if (lastSubmission && Date.now() - lastSubmission < 1000) {
		event.preventDefault();
		console.log('Duplicate submission prevented');
		return;
	}

	lastSubmission = Date.now();
}

function init(signal: AbortSignal): void {
	// The selector excludes the "Cancel" button
	observe('#review-changes-modal [type="submit"]:not([name])', replaceCheckboxes, {signal});
	delegate('#review-changes-modal form', 'submit', blockDuplicateSubmissions, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isPRFiles,
	],
	awaitDomReady: true,
	init,
});

/*

Test URLs

https://github.com/refined-github/sandbox/pull/4/files
https://github.com/refined-github/sandbox/pull/12/files

*/



================================================
FILE: source/features/one-key-formatting.tsx
================================================
import * as pageDetect from 'github-url-detection';
import {wrapFieldSelection} from 'text-field-edit';
import delegate, {type DelegateEvent} from 'delegate-it';

import features from '../feature-manager.js';
import {onCommentFieldKeydown, onConversationTitleFieldKeydown, onCommitTitleFieldKeydown} from '../github-events/on-field-keydown.js';

const formattingCharacters = ['`', '\'', '"', '[', '(', '{', '*', '_', '~', 'â€œ', 'â€˜'];
const matchingCharacters = ['`', '\'', '"', ']', ')', '}', '*', '_', '~', 'â€', 'â€™'];
const quoteCharacters = new Set(['`', '\'', '"']);

function eventHandler(event: DelegateEvent<KeyboardEvent, HTMLTextAreaElement | HTMLInputElement>): void {
	const field = event.delegateTarget;
	const formattingChar = event.key;

	if (!formattingCharacters.includes(formattingChar)) {
		return;
	}

	const [start, end] = [field.selectionStart!, field.selectionEnd!];

	// If `start` and `end` of selection are the same, then no text is selected
	if (start === end) {
		return;
	}

	// Allow replacing quotes #5960
	if (quoteCharacters.has(formattingChar) && end - start === 1 && quoteCharacters.has(field.value.at(start)!)) {
		return;
	}

	event.preventDefault();

	const matchingEndChar = matchingCharacters[formattingCharacters.indexOf(formattingChar)];
	wrapFieldSelection(field, formattingChar, matchingEndChar);
}

function init(signal: AbortSignal): void {
	onCommentFieldKeydown(eventHandler, signal);
	onConversationTitleFieldKeydown(eventHandler, signal);
	onCommitTitleFieldKeydown(eventHandler, signal);
	delegate([
		'input[name="commit_title"]',
		'input[name="gist[description]"]',
		'#saved-reply-title-field',
		'#commit-message-input',
	], 'keydown', eventHandler, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.hasRichTextEditor,
		pageDetect.isGist,
		pageDetect.isNewFile,
		pageDetect.isEditingFile,
		pageDetect.isDeletingFile,
	],
	init,
});

/*

Test URLs:

- Any comment box and issue/PR title: https://github.com/refined-github/sandbox/issues/3
- Gist title: https://gist.github.com
- Commit title when editing files: https://github.com/refined-github/sandbox/edit/default-a/editable
- Commit title when deleting files: https://github.com/refined-github/sandbox/delete/default-a/editable

*/



================================================
FILE: source/features/open-all-conversations.tsx
================================================
import React from 'dom-chef';
import {$$} from 'select-dom/strict.js';
import delegate from 'delegate-it';
import elementReady from 'element-ready';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import openTabs from '../helpers/open-tabs.js';
import observe from '../helpers/selector-observer.js';

function onButtonClick(): void {
	const links = $$([
		'a[data-testid="issue-pr-title-link"]',
		'a.h4.js-navigation-open', // TODO: Pre-React selector; Drop in 2026
	]);

	if (links.length > 25) {
		console.warn('Selected too many links. Is the selector still correct?');
	}

	const selectedLinks = links.filter(link =>
		link.closest([
			'.js-issue-row.selected', // TODO: Pre-React selector; Drop in 2026
			'[aria-label^="Selected"]',
		]),
	);

	const linksToOpen = selectedLinks.length > 0
		? selectedLinks
		: links;

	const urls = linksToOpen.map(link => link.href);
	void openTabs(urls);
}

const multipleConversationsSelector = [
	'.js-issue-row + .js-issue-row', // TODO: Pre-React selector; Drop in 2026
	'[role="list"] > div:nth-child(2) > [class^="IssueRow"]',
] as const;

async function hasMoreThanOneConversation(): Promise<boolean> {
	return Boolean(await elementReady(multipleConversationsSelector.join(', '), {waitForChildren: false}));
}

function add(anchor: HTMLElement): void {
	const isLegacy = anchor.closest('.table-list-header-toggle');
	const isSelected = anchor.closest([
		'.table-list-triage', // TODO: Pre-React selector; Drop in 2026
		'[aria-label="Bulk actions"]',
	]);
	const classes = isLegacy
		? 'btn-link px-2'
		: isSelected
			? 'btn'
			: 'btn btn-sm';
	anchor.prepend(
		<button
			type="button"
			className={`rgh-open-all-conversations ${classes}`}
		>
			{isSelected
				? 'Open selected'
				: 'Open all'}
		</button>,
	);
}

async function init(signal: AbortSignal): Promise<void | false> {
	observe([
		'.table-list-header-toggle:not(.states)', // TODO: Pre-React selector; Drop in 2026
		'[aria-label="Bulk actions"] > :first-child',
		'[aria-label="Actions"] > :first-child',
	], add, {signal});
	delegate('button.rgh-open-all-conversations', 'click', onButtonClick, {signal});
}

void features.add(import.meta.url, {
	asLongAs: [
		hasMoreThanOneConversation,
	],
	include: [
		pageDetect.isIssueOrPRList,
	],
	exclude: [
		pageDetect.isGlobalIssueOrPRList,
	],
	init,
}, {
	include: [
		pageDetect.isGlobalIssueOrPRList,
	],
	init,
});

/*

Test URLs:

- Global: https://github.com/issues
- Issues: https://github.com/refined-github/refined-github/issues
- PRs: https://github.com/refined-github/refined-github/pulls
- Nothing to open: https://github.com/fregante/empty/pulls

*/



================================================
FILE: source/features/open-all-notifications.css
================================================
/* Only show "Open all unread" if no notifications are selected */
.js-notifications-mark-selected-actions[hidden]
~ .rgh-open-notifications-button {
	display: inline-block !important;
}

.js-notifications-mark-selected-actions
	:not(.mr-2)
	+ .rgh-open-selected-button {
	margin-left: var(--base-size-8, 80px) !important;
}



================================================
FILE: source/features/open-all-notifications.tsx
================================================
import './open-all-notifications.css';

import React from 'dom-chef';
import {$$, elementExists} from 'select-dom';
import * as pageDetect from 'github-url-detection';
import LinkExternalIcon from 'octicons-plain-react/LinkExternal';
import delegate, {type DelegateEvent} from 'delegate-it';
import {$} from 'select-dom/strict.js';

import features from '../feature-manager.js';
import openTabs from '../helpers/open-tabs.js';
import {appendBefore} from '../helpers/dom-utils.js';
import observe from '../helpers/selector-observer.js';
import {multilineAriaLabel} from '../github-helpers/index.js';
import {getIdentifiers} from '../helpers/feature-helpers.js';

// Selector works on:
// https://github.com/notifications (Grouped by date)
// https://github.com/notifications (Grouped by repo)
// https://github.com/notifications?query=reason%3Acomment (which is an unsaved filter)
const notificationHeaderSelector = '.js-check-all-container .js-bulk-action-toasts ~ div .Box-header';

const openUnread = getIdentifiers('open-notifications-button');
const openSelected = getIdentifiers('open-selected-button');

function getUnreadNotifications(container: ParentNode = document): HTMLElement[] {
	return $$('.notification-unread', container);
}

async function openNotifications(notifications: Element[], markAsDone = false): Promise<void> {
	const urls = notifications
		.toReversed() // Open oldest first #6755
		.map(notification => $('a', notification).href);

	const openingTabs = openTabs(urls);
	if (!await openingTabs) {
		return;
	}

	for (const notification of notifications) {
		if (markAsDone) {
			$('[title="Done"]', notification).click();
		} else {
			// Mark all as read instead
			notification.classList.replace('notification-unread', 'notification-read');
		}
	}
}

async function openUnreadNotifications({delegateTarget, altKey}: DelegateEvent<MouseEvent>): Promise<void> {
	const container = delegateTarget.closest('.js-notifications-group') ?? document;
	await openNotifications(getUnreadNotifications(container), altKey);

	// Remove all now-unnecessary buttons
	removeOpenUnreadButtons(container);
}

async function openSelectedNotifications(): Promise<void> {
	const selectedNotifications = $$('.notifications-list-item :checked')
		.map(checkbox => checkbox.closest('.notifications-list-item')!);
	await openNotifications(selectedNotifications);

	if (!elementExists('.notification-unread')) {
		removeOpenUnreadButtons();
	}
}

function removeOpenUnreadButtons(container: ParentNode = document): void {
	for (const button of $$(openUnread.selector, container)) {
		button.remove();
	}
}

function addSelectedButton(selectedActionsGroup: HTMLElement): void {
	const button = (
		<button
			type="button"
			className={'btn btn-sm mr-2 tooltipped tooltipped-s ' + openSelected.class}
			data-hotkey="p"
			aria-label={multilineAriaLabel(
				'Open selected notifications',
				'Hotkey: P',
			)}
		>
			<LinkExternalIcon className="mr-1" />Open
		</button>
	);
	appendBefore(
		selectedActionsGroup,
		'details',
		button,
	);
}

function addToRepoGroup(markReadButton: HTMLElement): void {
	const repository = markReadButton.closest('.js-notifications-group')!;
	if (getUnreadNotifications(repository).length === 0) {
		return;
	}

	markReadButton.before(
		<button
			type="button"
			className={'btn btn-sm mr-2 tooltipped tooltipped-w ' + openUnread.class}
			aria-label="Open all unread notifications from this repo"
		>
			<LinkExternalIcon width={16} /> Open unread
		</button>,
	);
}

function addToMainHeader(notificationHeader: HTMLElement): void {
	if (getUnreadNotifications().length === 0) {
		return;
	}

	notificationHeader.append(
		<button className={'btn btn-sm ml-auto d-none ' + openUnread.class} type="button">
			<LinkExternalIcon className="mr-1" />Open all unread
		</button>,
	);
}

function init(signal: AbortSignal): void {
	delegate(openSelected.selector, 'click', openSelectedNotifications, {signal});
	delegate(openUnread.selector, 'click', openUnreadNotifications, {signal});

	observe(notificationHeaderSelector + ' .js-notifications-mark-selected-actions', addSelectedButton, {signal});
	observe(notificationHeaderSelector, addToMainHeader, {signal});
	observe('.js-grouped-notifications-mark-all-read-button', addToRepoGroup, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isNotifications,
	],
	shortcuts: {
		p: 'Open selected notifications',
	},
	init,
});

/*

Test URLs:

https://github.com/notifications (Grouped by date)
https://github.com/notifications (Grouped by repo)
https://github.com/notifications?query=reason%3Acomment (which is an unsaved filter)

*/



================================================
FILE: source/features/open-issue-to-latest-comment.tsx
================================================
import {$$} from 'select-dom';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import {openIssueToLastComment} from '../github-helpers/selectors.js';

function init(): void {
	for (const link of $$(openIssueToLastComment)) {
		link.hash = '#issue-comment-box';
	}
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isIssueOrPRList,
	],
	awaitDomReady: true,
	init,
});

/*

Test URLs:

https://github.com/refined-github/sandbox/labels/bug

*/



================================================
FILE: source/features/parse-backticks.css
================================================
/* Style copied from GitHub's <code> */
.rgh-parse-backticks {
	background-color: var(
		--bgColor-neutral-muted,
		var(--color-neutral-muted, fuchsia)
	);
	border-radius: 6px;
	font-size: 85%;
	margin: 0;
	padding: 0.2em 0.4em;
}



================================================
FILE: source/features/parse-backticks.tsx
================================================
import './parse-backticks.css';

import onetime from '../helpers/onetime.js';
import observe from '../helpers/selector-observer.js';
import features from '../feature-manager.js';
import {parseBackticks} from '../github-helpers/dom-formatters.js';

const selectors = [
	// `isRepoHome` repository description
	// https://github.com/refined-github/sandbox
	'.BorderGrid--spacious .f4.my-3',

	// `isCommitList` commit description
	// https://github.com/refined-github/sandbox/commits/buncha-files/
	'.js-commits-list-item pre',

	// `isPRConversation` commit description
	// https://github.com/refined-github/sandbox/pull/55#commits-pushed-d4852bb
	'.js-commit-group pre',

	// `isReleasesOrTags` Headers
	// TODO: Fix. Not working
	// https://github.com/refined-github/sandbox/releases/tag/cool
	'.release-header',

	// `isCompare` with existing PR
	// https://github.com/refined-github/sandbox/compare/shorten-links
	'.Box-row .mb-1 a',

	// https://github.com/refined-github/refined-github/pulse
	'#pull-requests a.Link--primary',

	// https://github.com/refined-github/refined-github/actions
	'[id^="check_suite"] a.Link--primary',

	// https://github.com/refined-github/refined-github/actions/runs/6063125869
	'.js-socket-channel[data-url*="/header_partial"] h3',

	'.js-wiki-sidebar-toggle-display a', // `isWiki` sidebar pages title
	'#wiki-wrapper .gh-header-title', // `isWiki` page title

	// https://github.com/orgs/refined-github/repositories
	'#user-repositories-list [itemprop="description"]',

	// Hovercard
	// https://github.com/refined-github/sandbox/issues/72
	'.js-hovercard-content > .Popover-message .Link--primary',

	// `isGlobalSearchResults` search titles
	// https://github.com/search?q=org%3Arefined-github+testing&type=pullrequests
	'.search-title a',

	// https://github.com/notifications/subscriptions
	'.notification-thread-subscription [id^="subscription_link_"]',

	// Dashboard
	// https://github.com
	'[class^="DashboardListView-module__ItemTitle"]',
] as const;

function initOnce(): void {
	observe(selectors, parseBackticks);
}

void features.add(import.meta.url, {
	// No `include` necessary
	init: onetime(initOnce),
});

/*
Test URLs:

inline

*/



================================================
FILE: source/features/patch-diff-links.tsx
================================================
import React from 'dom-chef';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import {getCleanPathname} from '../github-helpers/index.js';
import observe from '../helpers/selector-observer.js';

function getCommitUrl(extension: 'patch' | 'diff'): string {
	// The replacement avoids a redirection isPRCommit
	const pathname = getCleanPathname().replace(/\/pull\/\d+\/commits/, '/commit');
	return `/${pathname}.${extension}`;
}

function updateCommitUrl(
	event: React.FocusEvent<HTMLAnchorElement> | React.MouseEvent<HTMLAnchorElement>,
): void {
	const link = event.currentTarget;
	link.href = getCommitUrl(link.textContent as 'patch' | 'diff');
}

function createLink(type: 'patch' | 'diff'): JSX.Element {
	return (
		<a
			href={getCommitUrl(type)}
			className="sha color-fg-default"
			// Update URL because it might be out of date due to SPA navigation
			// https://github.com/refined-github/refined-github/issues/8737
			onMouseEnter={updateCommitUrl}
			onFocus={updateCommitUrl}
		>
			{type}
		</a>
	);
}

async function addPatchDiffLinks(commitMeta: HTMLElement): Promise<void> {
	commitMeta.classList.remove('no-wrap'); // #5987
	commitMeta.prepend(
		<span className="sha-block" data-turbo="false">
			{createLink('patch')}
			{' '}
			{createLink('diff')}
			{commitMeta.tagName !== 'DIV' && <span className="px-2">Â·</span>}
		</span>,
	);
}

async function init(signal: AbortSignal): Promise<void> {
	observe([
		'.commit-meta > :is(span, div):last-child', // `isPRCommit` + old `isSingleCommit`
		'[class*="commit-header-actions"] + div pre',
	], addPatchDiffLinks, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isCommit,
	],
	exclude: [
		pageDetect.isPRCommit404,
	],
	init,
});

/*

Test URLs:

- Commit:https://github.com/refined-github/refined-github/commit/132272786fdc058193e089d8c06f2a158844e101
- PR Commit: https://github.com/refined-github/refined-github/pull/7751/commits/07ddf838c211075701e9a681ab061a158b05ee79

*/



================================================
FILE: source/features/pinned-issues-update-time.tsx
================================================
import React from 'dom-chef';
import {CachedFunction} from 'webext-storage-cache';
import {$} from 'select-dom/strict.js';
import batchedFunction from 'batched-function';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import api from '../github-helpers/api.js';
import {getRepo} from '../github-helpers/index.js';
import looseParseInt from '../helpers/loose-parse-int.js';
import observe from '../helpers/selector-observer.js';
import {expectToken} from '../github-helpers/github-token.js';

type IssueInfo = {
	updatedAt: string;
};

const getLastUpdated = new CachedFunction('last-updated', {
	async updater(issueNumbers: number[]): Promise<Record<string, IssueInfo>> {
		const {repository} = await api.v4(`
		repository() {
			${issueNumbers.map(number => `
				${api.escapeKey(number)}: issue(number: ${number}) {
					updatedAt
				}
			`).join('\n')}
		}
	`);

		return repository;
	},
	maxAge: {minutes: 30},
	cacheKey: ([issues]) => `${getRepo()!.nameWithOwner}:${String(issues)}`,
});

function getPinnedIssueNumber(pinnedIssue: HTMLElement): number {
	return looseParseInt($('.opened-by', pinnedIssue).firstChild);
}

async function update(pinnedIssues: HTMLElement[]): Promise<void> {
	const lastUpdated: Record<string, IssueInfo> = await getLastUpdated.get(pinnedIssues.map(issue => getPinnedIssueNumber(issue)));
	for (const pinnedIssue of pinnedIssues) {
		const issueNumber = getPinnedIssueNumber(pinnedIssue);
		const {updatedAt} = lastUpdated[api.escapeKey(issueNumber)];
		const originalLine = $('.opened-by', pinnedIssue);
		originalLine.after(
			// .rgh class enables tweakers to hide the number
			<span className="text-small color-fg-muted">
				<span className="rgh-pinned-issue-number">#{issueNumber}</span> updated <relative-time datetime={updatedAt} />
			</span>,
		);

		originalLine.hidden = true;
	}
}

async function init(signal: AbortSignal): Promise<void> {
	await expectToken();
	observe('.pinned-issue-item', batchedFunction(update, {delay: 100}), {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isRepoIssueList,
	],
	init,
});

/*

Test URLs:

https://github.com/refined-github/refined-github/issues

*/



================================================
FILE: source/features/pr-approvals-count.css
================================================
/* TODO: Drop coloring in July 2025. New PR view renders this defunct and redundant. */

/* Show approvals count in PR list */
.js-issue-row .color-fg-muted
	[href$='#partial-pull-merging'][aria-label*='approval'] {
	font-size: 0;
	color: transparent !important;
}

.js-issue-row
	.color-fg-muted
	[href$='#partial-pull-merging'][aria-label*='approval']::before {
	all: unset;
	content: attr(aria-label);
	display: inline-block !important;
	color: var(--rgh-green);
	font-size: 12px;
}

.js-issue-row
	.color-fg-muted
	[href$='#partial-pull-merging'][aria-label*='changes'] {
	color: var(--rgh-red) !important;
}

.js-issue-row
	.color-fg-muted
	[href$='#partial-pull-merging'][aria-label*='required'] {
	color: var(--rgh-yellow) !important;
}

/* Disable now-duplicate tooltip */
.js-issue-row .color-fg-muted
	[href$='#partial-pull-merging'][aria-label*='approval']::after {
	content: none;
}

/*

Test URLs:

https://github.com/refined-github/sandbox/pulls?q=is%3Apr+is%3Aopen+sort%3Aupdated-desc+review

*/



================================================
FILE: source/features/pr-base-commit.tsx
================================================
import React from 'dom-chef';
import * as pageDetect from 'github-url-detection';

import {elementExists} from 'select-dom';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';
import {getBranches} from '../github-helpers/pr-branches.js';
import getPrInfo, {type PullRequestInfo} from '../github-helpers/get-pr-info.js';
import pluralize from '../helpers/pluralize.js';
import {buildRepoURL} from '../github-helpers/index.js';
import {linkifyCommit} from '../github-helpers/dom-formatters.js';
import {isTextNodeContaining} from '../helpers/dom-utils.js';
import {expectToken} from '../github-helpers/github-token.js';
import {deletedHeadRepository, prMergeabilityBoxCaption} from '../github-helpers/selectors.js';

function getBaseCommitNotice(prInfo: PullRequestInfo): JSX.Element {
	const {base} = getBranches();
	const commit = linkifyCommit(prInfo.baseRefOid);
	const count = pluralize(prInfo.behindBy, '$$ commit');
	const countLink = (
		<a href={buildRepoURL('compare', `${prInfo.baseRefOid.slice(0, 8)}...${base.branch}`)}>
			{count}
		</a>
	);
	return (
		<div>Itâ€™s {countLink} behind (base commit: {commit})</div>
	);
}

async function addInfo(statusMeta: Element): Promise<void> {
	const {base} = getBranches();
	const prInfo = await getPrInfo(base.relative);
	if (!prInfo.needsUpdate) {
		return;
	}

	const previousMessage = statusMeta.firstChild!; // Extract now because it won't be the first child anymore
	statusMeta.prepend(getBaseCommitNotice(prInfo));
	if (isTextNodeContaining(previousMessage, 'Merging can be performed automatically.')) {
		previousMessage.remove();
	}
}

async function init(signal: AbortSignal): Promise<false | void> {
	await expectToken();

	observe(
		prMergeabilityBoxCaption,
		addInfo,
		{signal},
	);
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isPRConversation,
	],
	exclude: [
		pageDetect.isClosedConversation,
		() => elementExists(deletedHeadRepository),
	],
	awaitDomReady: true, // DOM-based exclusions
	init,
});

/*
Test URLs

PR without conflicts
https://github.com/refined-github/sandbox/pull/60

Draft PR without conflicts
https://github.com/refined-github/sandbox/pull/61

Native "Update branch" button
(pick a conflict-free PR from https://github.com/refined-github/refined-github/pulls?q=is%3Apr+is%3Aopen+sort%3Acreated-asc)

Native "Resolve conflicts" button
https://github.com/refined-github/sandbox/pull/9

Cross-repo PR with long branch names
https://github.com/refined-github/sandbox/pull/13

*/



================================================
FILE: source/features/pr-branch-auto-delete.gql
================================================
query GetPrsToBaseBranch(
	$owner: String!
	$name: String!
	$baseRefName: String!
) {
	repository(owner: $owner, name: $name) {
		pullRequests(baseRefName: $baseRefName, states: OPEN) {
			totalCount
		}
	}
}



================================================
FILE: source/features/pr-branch-auto-delete.tsx
================================================
import React from 'dom-chef';
import {$$optional} from 'select-dom/strict.js';
import InfoIcon from 'octicons-plain-react/Info';
import elementReady from 'element-ready';
import * as pageDetect from 'github-url-detection';

import api from '../github-helpers/api.js';
import features from '../feature-manager.js';
import waitForPrMerge from '../github-events/on-pr-merge.js';
import {getBranches} from '../github-helpers/pr-branches.js';
import matchesAnyPattern from '../helpers/matches-any-patterns.js';
import GetPrsToBaseBranch from './pr-branch-auto-delete.gql';

// DO NOT ask for additions or customizations. This is just a list of "obvious" permanent branches.
// Protect your permanent branches instead: https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/managing-protected-branches/about-protected-branches
const exceptions = [
	'dev',
	'develop',
	'development',
	'main',
	'master',
	'next',
	'pre',
	'prod',
	'stage',
	'staging',
	/production/,
	/^release/,
	/^v\d/,
];

async function init(): Promise<void> {
	const deleteButton = $$optional([
		'[action$="/cleanup"] [type="submit"]', // TODO: Drop in May 2025
		'[class^="MergeBoxSectionHeader"] button',
	]).find(button => button.textContent === 'Delete branch');

	if (!deleteButton) {
		return;
	}

	// Skip branches that are likely to be long-lived https://github.com/refined-github/refined-github/issues/7755
	const {head} = getBranches();
	if (matchesAnyPattern(head.branch, exceptions)) {
		return;
	}

	// Skip branches that have PRs open https://github.com/refined-github/refined-github/issues/7782
	const {repository} = await api.v4(GetPrsToBaseBranch, {
		variables: {
			baseRefName: head.branch,
		},
	});

	if (repository.pullRequests.totalCount) {
		return;
	}

	// TODO: Drop label in May 2025
	deleteButton.dataset.disableWith = 'Auto-deletingâ€¦';
	deleteButton.click();

	const deletionEvent = await elementReady('.TimelineItem-body:has(.pull-request-ref-restore-text)', {
		stopOnDomReady: false,
		signal: AbortSignal.timeout(2000),
	});

	const url = 'https://github.com/refined-github/refined-github/wiki/Extended-feature-descriptions#pr-branch-auto-delete';
	deletionEvent!.append(
		<a className="d-inline-block" href={url}>via Refined GitHub <InfoIcon /></a>,
	);
}

void features.add(import.meta.url, {
	asLongAs: [
		pageDetect.isPRConversation,
		pageDetect.isOpenConversation,
	],
	awaitDomReady: true, // Post-load user event, no need to listen earlier
	async init(signal: AbortSignal): Promise<void> {
		await waitForPrMerge(signal);
		await init();
	},
});

/*

Test URLs:

1. Open https://github.com/pulls
2. Click on any PRs you can merge (in repositories without native auto-delete)
3. Merge the PR

*/



================================================
FILE: source/features/pr-commit-lines-changed.gql
================================================
query GetCommitChanges($owner: String!, $name: String!, $commit: String!) {
	repository(owner: $owner, name: $name) {
		object(expression: $commit) {
			... on Commit {
				additions
				deletions
			}
		}
	}
}



================================================
FILE: source/features/pr-commit-lines-changed.tsx
================================================
import React from 'dom-chef';
import {CachedFunction} from 'webext-storage-cache';
import elementReady from 'element-ready';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import api from '../github-helpers/api.js';
import pluralize from '../helpers/pluralize.js';
import GetCommitChanges from './pr-commit-lines-changed.gql';

const commitChanges = new CachedFunction('commit-changes', {
	async updater(commit: string): Promise<[additions: number, deletions: number]> {
		const {repository} = await api.v4(GetCommitChanges, {
			variables: {
				commit,
			},
		});

		return [repository.object.additions, repository.object.deletions];
	},
});

async function init(): Promise<void> {
	const commitSha = location.pathname.split('/').pop()!;
	const [additions, deletions] = await commitChanges.get(commitSha);
	const tooltip = pluralize(additions + deletions, '1 line changed', '$$ lines changed');
	const diffstat = await elementReady('.diffstat', {waitForChildren: false});
	diffstat!.replaceWith(
		<span className="ml-2 diffstat tooltipped tooltipped-s" aria-label={tooltip}>
			<span className="color-fg-success">+{additions}</span>{' '}
			<span className="color-fg-danger">âˆ’{deletions}</span>{' '}
			<span className="diffstat-block-neutral" />
			<span className="diffstat-block-neutral" />
			<span className="diffstat-block-neutral" />
			<span className="diffstat-block-neutral" />
			<span className="diffstat-block-neutral" />
		</span>,
	);
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isPRCommit,
	],
	deduplicate: 'has-rgh-inner',
	init,
});

/*

Test URLs:

https://github.com/refined-github/refined-github/pull/6674/commits/3d93b7823e3c31d3bd1900ab1ec98f5ce41203bf

*/



================================================
FILE: source/features/pr-filters.gql
================================================
query HasChecks($owner: String!, $name: String!) {
	repository(owner: $owner, name: $name) {
		head: object(expression: "HEAD") {
			... on Commit {
				history(first: 10) {
					nodes {
						statusCheckRollup {
							state
						}
					}
				}
			}
		}
	}
}



================================================
FILE: source/features/pr-filters.tsx
================================================
import React from 'dom-chef';
import {CachedFunction} from 'webext-storage-cache';
import {$} from 'select-dom/strict.js';
import CheckIcon from 'octicons-plain-react/Check';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import api from '../github-helpers/api.js';
import observe from '../helpers/selector-observer.js';
import {cacheByRepo} from '../github-helpers/index.js';
import HasChecks from './pr-filters.gql';
import {expectToken} from '../github-helpers/github-token.js';
import SearchQuery from '../github-helpers/search-query.js';

const reviewsFilterSelector = '#reviews-select-menu';

function addDropdownItem(dropdown: HTMLElement, title: string, filterCategory: string, filterValue: string): void {
	const filterQuery = `${filterCategory}:${filterValue}`;

	const searchQuery = SearchQuery.from(location);
	const isSelected = searchQuery.includes(filterQuery);

	const filtersToRemove = searchQuery.getQueryParts().filter(part => part.startsWith(`${filterCategory}:`));
	searchQuery.remove(...filtersToRemove);

	if (!isSelected) {
		searchQuery.append(filterQuery);
	}

	dropdown.append(
		<a
			href={searchQuery.href}
			className="SelectMenu-item"
			aria-checked={isSelected ? 'true' : 'false'}
			role="menuitemradio"
		>
			<CheckIcon className="SelectMenu-icon SelectMenu-icon--check" />
			<span>{title}</span>
		</a>,
	);
}

function addDraftFilter(dropdown: HTMLElement): void {
	dropdown.append(
		<div className="SelectMenu-divider">
			Filter by draft pull requests
		</div>,
	);

	addDropdownItem(dropdown, 'Ready for review', 'draft', 'false');
	addDropdownItem(dropdown, 'Not ready for review (Draft PR)', 'draft', 'true');
}

const hasChecks = new CachedFunction('has-checks', {
	async updater(): Promise<boolean> {
		const {repository} = await api.v4(HasChecks);

		return repository.head.history.nodes.some((commit: AnyObject) => commit.statusCheckRollup);
	},
	maxAge: {days: 3},
	cacheKey: cacheByRepo,
});

async function addChecksFilter(reviewsFilter: HTMLElement): Promise<void> {
	if (!await hasChecks.get()) {
		return;
	}

	// Copy existing element and adapt its content
	const checksFilter = reviewsFilter.cloneNode(true);
	checksFilter.id = '';

	$('summary', checksFilter).firstChild!.textContent = 'Checks\u00A0'; // Only replace text node, keep caret
	$('.SelectMenu-title', checksFilter).textContent = 'Filter by checks status';

	const dropdown = $('.SelectMenu-list', checksFilter);
	dropdown.textContent = ''; // Drop previous filters

	for (const status of ['Success', 'Failure', 'Pending']) {
		addDropdownItem(dropdown, status, 'status', status.toLowerCase());
	}

	reviewsFilter.after(checksFilter);
}

async function init(signal: AbortSignal): Promise<void> {
	await expectToken();
	observe(reviewsFilterSelector, addChecksFilter, {signal});
	observe(`${reviewsFilterSelector} .SelectMenu-list`, addDraftFilter, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isPRList,
	],
	init,
});

/*

Test URLs:

https://github.com/pulls
https://github.com/refined-github/refined-github/pulls

*/



================================================
FILE: source/features/pr-first-commit-title.tsx
================================================
import {elementExists} from 'select-dom';
import {$, $optional} from 'select-dom/strict.js';
import * as pageDetect from 'github-url-detection';
import {insertTextIntoField, setFieldText} from 'text-field-edit';

import features from '../feature-manager.js';
import looseParseInt from '../helpers/loose-parse-int.js';
import observe from '../helpers/selector-observer.js';

function interpretNode(node: ChildNode): string | void {
	switch (node instanceof Element && node.tagName) {
		case false:
		case 'A': {
			return node.textContent;
		}

		case 'CODE': {
			// Restore backticks that GitHub loses when rendering them
			return '`' + node.textContent + '`';
		}

		default:
			// Ignore other nodes, like `<span>...</span>` that appears when commits have a body
	}
}

function getFirstCommit(firstCommit: HTMLElement): {title: string; body: string | undefined} {
	const body = $optional('.Details-content--hidden pre', firstCommit)
		?.textContent
		.trim() ?? undefined;

	const title = [...firstCommit.childNodes]
		.map(node => interpretNode(node))
		.join('')
		.trim();

	return {title, body};
}

function useCommitTitle(firstCommitElement: HTMLElement): void {
	const requestedContent = new URL(location.href).searchParams;
	const commitCountIcon = $([
		// Few commits
		'div.Box.mb-3 .octicon-git-commit',
		// Many commits (rendered in tabs)
		'a[href="#commits_bucket"] .octicon-git-commit',
	]);
	const commitCount = commitCountIcon?.nextElementSibling;
	if (!commitCount || looseParseInt(commitCount) < 2 || !elementExists('#new_pull_request')) {
		return;
	}

	const firstCommit = getFirstCommit(firstCommitElement);

	if (!requestedContent.has('pull_request[title]')) {
		setFieldText(
			$('#pull_request_title'),
			firstCommit.title,
		);
	}

	if (firstCommit.body && !requestedContent.has('pull_request[body]')) {
		insertTextIntoField(
			$('#pull_request_body'),
			firstCommit.body,
		);
	}
}

function init(signal: AbortSignal): void {
	observe('#commits_bucket > :first-child .js-commits-list-item:first-child p', useCommitTitle, {signal});
}

// The user already altered the PR title/body in a previous load, don't overwrite it
// https://github.com/refined-github/refined-github/issues/7191
function hasUserAlteredThePR(): boolean {
	const sessionResumeId = $optional('meta[name="session-resume-id"]')?.content;
	return Boolean(sessionResumeId && sessionStorage.getItem(`session-resume:${sessionResumeId}`));
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isCompare,
	],
	exclude: [
		() =>	new URLSearchParams(location.search).has('title'),
		hasUserAlteredThePR,
	],
	init,
});

/*
Test URLs

Few commit: https://github.com/refined-github/sandbox/compare/rendered-commit-title?expand=1
Many commits: https://github.com/refined-github/refined-github/compare/refined-github:refined-github:esbuild-2...pgimalac:refined-github:pgimalac/fit-rendered-markdown?expand=1
*/



================================================
FILE: source/features/pr-jump-to-first-non-viewed-file.tsx
================================================
import {$optional} from 'select-dom/strict.js';
import elementReady from 'element-ready';
import delegate from 'delegate-it';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';

function jumpToFirstNonViewed(): void {
	const firstNonViewedFile = $optional([
		'[id][data-details-container-group="file"]:not([data-file-user-viewed])', // TODO: Old PR Files view, drop in 2026
		'[id][class^="Diff-module"]:has(button[aria-pressed="false"])',
	]);
	if (firstNonViewedFile) {
		// Scroll to file without pushing to history
		location.replace('#' + firstNonViewedFile.id);
	} else {
		// The file hasn't loaded yet, so make GitHub load it by scrolling to the bottom
		window.scrollTo(window.scrollX, document.body.scrollHeight);
	}
}

const selectors = [
	'.diffbar-item progress-bar', // TODO: Old PR Files view, drop in 2026
	'.d-flex:has([class*="ViewedFileProgress"])',
];
async function init(signal: AbortSignal): Promise<void> {
	const bar = await elementReady(selectors);
	bar!.style.cursor = 'pointer';
	delegate(selectors, 'click', jumpToFirstNonViewed, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isPRFiles,
	],
	exclude: [
		pageDetect.isPRFile404,
		pageDetect.isPRCommit,
	],
	init,
});

/*

Test URLs:

PR: https://github.com/refined-github/sandbox/pull/55/files
Large PR https://github.com/pixiebrix/pixiebrix-extension/pull/6808/files

*/



================================================
FILE: source/features/pr-notification-link.tsx
================================================
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';

const regex = /\/files\/[\da-f]{40}..[\da-f]{40}$/;

export function removeLinkToPRFilesTab(link: HTMLAnchorElement): void {
	if (regex.test(link.pathname)) {
		link.pathname = link.pathname.replace(regex, '');
		link.hash = '#issue-comment-box';
	}
}

function init(signal: AbortSignal): void {
	// It's ok if it's not 100% safe because trimLink's regex is super specific
	observe('[href*="/pull/"][href*="/files/"][href*=".."]', removeLinkToPRFilesTab, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isNotifications,
	],
	init,
});

/*

Test URL:

https://github.com/notifications

*/



================================================
FILE: source/features/prevent-comment-loss.tsx
================================================
import * as pageDetect from 'github-url-detection';
import delegate, {type DelegateEvent} from 'delegate-it';
import filterAlteredClicks from 'filter-altered-clicks';

import features from '../feature-manager.js';

function openInNewTab(event: DelegateEvent<MouseEvent, HTMLAnchorElement>): void {
	event.preventDefault();
	window.open(event.delegateTarget.href, '_blank');
}

function init(signal: AbortSignal): void {
	delegate(
		[
			'.js-preview-body a', // `hasRichTextEditor`
			'.html-blob a', // `isEditingFile`
		],
		'click',
		filterAlteredClicks(openInNewTab),
		{signal},
	);
}

void features.add(import.meta.url, {
	include: [
		pageDetect.hasRichTextEditor,
		pageDetect.isEditingFile,
	],
	init,
});

/*

## Test URLs

https://github.com/refined-github/sandbox/issues/new
https://github.com/refined-github/refined-github/edit/main/readme.md

*/



================================================
FILE: source/features/prevent-duplicate-pr-submission.tsx
================================================
import * as pageDetect from 'github-url-detection';
import delegate, {type DelegateEvent} from 'delegate-it';

import features from '../feature-manager.js';

let previousSubmission = 0;

function preventSubmit(event: DelegateEvent): void {
	if (Date.now() - previousSubmission < 1000) {
		event.preventDefault();
	}

	previousSubmission = Date.now();
}

function init(signal: AbortSignal): void {
	delegate('#new_pull_request', 'submit', preventSubmit, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isCompare,
	],
	init,
});

/*

Test URLs:

1. Visit https://github.com/refined-github/sandbox/compare/default-a...7416?expand=1
2. Double-click "Create pull request"

*/



================================================
FILE: source/features/prevent-link-loss.tsx
================================================
import React from 'dom-chef';
import {$optional, $} from 'select-dom/strict.js';
import AlertIcon from 'octicons-plain-react/Alert';
import debounceFn from 'debounce-fn';
import * as pageDetect from 'github-url-detection';
import {replaceFieldText} from 'text-field-edit';
import delegate, {type DelegateEvent} from 'delegate-it';

import features from '../feature-manager.js';
import {
	prCommitUrlRegex,
	preventPrCommitLinkLoss,
	prCompareUrlRegex,
	preventPrCompareLinkLoss,
	discussionUrlRegex,
	preventDiscussionLinkLoss,
} from '../github-helpers/prevent-link-loss.js';
import createBanner from '../github-helpers/banner.js';

const fieldSelector = [
	'textarea.js-comment-field',
	'textarea[aria-labelledby="comment-composer-heading"]', // React view
] as const;

const documentation = 'https://github.com/refined-github/refined-github/wiki/Extended-feature-descriptions#prevent-link-loss';

function handleButtonClick({currentTarget: fixButton}: React.MouseEvent<HTMLButtonElement>): void {
	const field = $(
		fieldSelector,
		fixButton.closest(['form', '[data-testid="markdown-editor-comment-composer"]'])!,
	);

	replaceFieldText(field, prCommitUrlRegex, preventPrCommitLinkLoss);
	replaceFieldText(field, prCompareUrlRegex, preventPrCompareLinkLoss);
	replaceFieldText(field, discussionUrlRegex, preventDiscussionLinkLoss);
	fixButton.closest('.flash')!.remove();
}

function getUI(container: HTMLElement): HTMLElement {
	return $optional('.rgh-prevent-link-loss-container', container) ?? (createBanner({
		icon: <AlertIcon className="m-0" />,
		text: (
			<>
				{' Your link may be '}
				<a href={documentation} target="_blank" rel="noopener noreferrer" data-hovercard-type="issue">
					misinterpreted
				</a>
				{' by GitHub.'}
			</>
		),
		classes: [
			'rgh-prevent-link-loss-container',
			'flash-warn',
			'my-2',
			container.tagName === 'FORM' ? 'mx-2' : '',
		],
		action: handleButtonClick,
		buttonLabel: 'Fix link',
	}));
}

function isVulnerableToLinkLoss(value: string): boolean {
	// The replacement logic is not just in the regex, so it alone can't be used to detect the need for the replacement
	return value !== value.replace(prCommitUrlRegex, preventPrCommitLinkLoss)
		|| value !== value.replace(prCompareUrlRegex, preventPrCompareLinkLoss)
		|| value !== value.replace(discussionUrlRegex, preventDiscussionLinkLoss);
}

function updateUI({delegateTarget: field}: DelegateEvent<Event, HTMLTextAreaElement>): void {
	if (isVulnerableToLinkLoss(field.value)) {
		if (field.form) {
			$('file-attachment .js-write-bucket', field.form).append(getUI(field.form));
		} else {
			// React view
			const container = field.closest('[data-testid="markdown-editor-comment-composer"]')!;
			container.append(getUI(container));
		}
	} else {
		getUI(field).remove();
	}
}

const updateUIDebounced = debounceFn(updateUI, {
	wait: 300,
});

function init(signal: AbortSignal): void {
	delegate(fieldSelector, 'input', updateUIDebounced, {signal});
	delegate(fieldSelector, 'focusin', updateUI, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.hasRichTextEditor,
	],
	init,
});

/*

Test URLs:

Test link: `https://github.com/refined-github/refined-github/pull/6954/commits/32d1c8b2e1b6971709fe273cfdd1f959b51e8d85`

New issue form: https://github.com/refined-github/refined-github/issues/new?assignees=&labels=bug&projects=&template=1_bug_report.yml
New comment form: https://github.com/refined-github/sandbox/issues/3
New review form: https://github.com/refined-github/sandbox/pull/4/files#review-changes-modal
New review comment form: https://github.com/refined-github/sandbox/pull/4/files

*/



================================================
FILE: source/features/prevent-pr-merge-panel-opening.tsx
================================================
import {$optional} from 'select-dom/strict.js';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';

async function sessionResumeHandler(): Promise<void> {
	await Promise.resolve(); // The `session:resume` event fires a bit too early
	const cancelMergeButton = $optional('.merge-branch-form .js-details-target');
	if (cancelMergeButton) {
		cancelMergeButton.click();
		document.removeEventListener('session:resume', sessionResumeHandler);
	}
}

function init(signal: AbortSignal): void {
	document.addEventListener('session:resume', sessionResumeHandler, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isPRConversation,
	],
	init,
});

/*

Test URLs:

1. Visit https://github.com/pulls
2. Open any PR you can merge
2. Click "Merge pull request"
3. Click "Cancel merge"
4. Reload the page
5. The panel should not still be open

*/



================================================
FILE: source/features/preview-hidden-comments.css
================================================
/* Avoid overflow on mobile due to change of flex-direction #5750 */
.rgh-preview-hidden-comments h3 {
	max-width: 100%;
}



================================================
FILE: source/features/preview-hidden-comments.tsx
================================================
import './preview-hidden-comments.css';

import React from 'dom-chef';
import {$} from 'select-dom/strict.js';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import {upperCaseFirst} from '../github-helpers/index.js';
import observe from '../helpers/selector-observer.js';

function preview(hiddenCommentHeader: HTMLElement): void {
	const details = hiddenCommentHeader.closest('details')!;
	details.classList.add('rgh-preview-hidden-comments'); // Used in CSS

	const comment = $('.comment-body', details);
	const commentText = comment.textContent.trim();
	if (commentText.length === 0) {
		return;
	}

	const commentHeader = hiddenCommentHeader.textContent;
	if (/disruptive|spam/.test(commentHeader)) {
		return;
	}

	// The reason is missing/lost in some cases
	const reason = /duplicate|outdated|off-topic|hidden/.exec(commentHeader)?.[0];
	hiddenCommentHeader.classList.add('css-truncate', 'css-truncate-overflow', 'mr-2');
	hiddenCommentHeader.append(
		<span className="Details-content--open">{hiddenCommentHeader.firstChild}</span>,
		<span className="Details-content--closed">
			{reason && <span className="Label mr-2">{upperCaseFirst(reason)}</span>}{commentText.slice(0, 100)}
		</span>,
	);
}

function init(signal: AbortSignal): void {
	// `.timeline-comment-group` excludes review comments, which are always loaded on click, so it's not possible to preview them
	observe('.timeline-comment-group .minimized-comment .timeline-comment-header-text', preview, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.hasComments,
	],
	init,
});

/*
Test URLs
https://github.com/refined-github/sandbox/pull/47
*/



================================================
FILE: source/features/previous-next-commit-buttons.tsx
================================================
import React from 'dom-chef';
import {$, $optional} from 'select-dom/strict.js';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';

function init(): false | void {
	const originalPreviousNext = $optional('.commit .float-right.ButtonGroup') // Legacy
		?? $optional('[class^="prc-ButtonGroup-ButtonGroup"]:has(a[aria-label$="previous commit" i])');
	if (!originalPreviousNext) {
		return false;
	}

	// Wrap the button in a <div> to avoid #4503
	$([
		'#files', // Legacy
		'[class^="DiffPlaceholder-module__DiffPlaceholderSVG"]',
	]).after(
		<div className="d-flex flex-justify-end mb-3">
			{originalPreviousNext.cloneNode(true)}
		</div>,
	);
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isPRCommit,
	],
	deduplicate: 'has-rgh-inner',
	awaitDomReady: true,
	init,
});

/*
Test URLs:

Condensed commit: https://github.com/refined-github/refined-github/pull/4448/commits/0b8966c918eae11da9fc992368741757088edf08
Regular commit: https://github.com/refined-github/refined-github/pull/5113/commits/5b7282afc40b013f5928271fb6740cf70b4e4295

*/



================================================
FILE: source/features/previous-version.gql
================================================
query getPreviousCommitForFile($resource: URI!, $filePath: String!) {
	resource(url: $resource) {
		... on Commit {
			history(path: $filePath, first: 2) {
				nodes {
					oid
				}
			}
		}
	}
}



================================================
FILE: source/features/previous-version.tsx
================================================
import React from 'dom-chef';
import * as pageDetect from 'github-url-detection';
import VersionsIcon from 'octicons-plain-react/Versions';
import {$} from 'select-dom/strict.js';
import {elementExists} from 'select-dom';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';
import api from '../github-helpers/api.js';
import GitHubFileURL from '../github-helpers/github-file-url.js';
import previousVersionQuery from './previous-version.gql';
import onReactPageUpdate from '../github-events/on-react-page-update.js';
import {expectToken} from '../github-helpers/github-token.js';

async function getPreviousCommitForFile(pathname: string): Promise<string | undefined> {
	const {user, repository, branch, filePath} = new GitHubFileURL(pathname);
	const {resource} = await api.v4(previousVersionQuery, {
		variables: {
			filePath,
			resource: `/${user}/${repository}/commit/${branch}`,
		},
	});

	// The first commit refers to the current one, so we skip it
	return resource.history.nodes[1]?.oid;
}

async function getPreviousFileUrl(): Promise<string | void> {
	const previousCommit = await getPreviousCommitForFile(location.href);
	if (!previousCommit) {
		return;
	}

	return new GitHubFileURL(location.href)
		.assign({branch: previousCommit})
		.href;
}

function addMobileDom(wrappedHistoryButton: HTMLElement): HTMLAnchorElement {
	const wrappedPreviousButton = wrappedHistoryButton.cloneNode(true);
	wrappedPreviousButton.setAttribute('aria-label', 'Previous version');
	const previousButton = $('a', wrappedPreviousButton);
	previousButton.classList.add('rgh-previous-version-mobile');
	wrappedHistoryButton.before(wrappedPreviousButton);
	return previousButton;
}

function addDesktopDom(historyButton: HTMLAnchorElement): HTMLAnchorElement {
	const previousButton = historyButton.cloneNode(true);
	previousButton.classList.add('mr-n2', 'rgh-previous-version-desktop');
	$('span[data-component="text"]', previousButton).textContent = 'Previous';
	historyButton.before(previousButton);
	return previousButton;
}

async function add(historyButton: HTMLAnchorElement, {signal}: SignalAsOptions): Promise<void> {
	const url = await getPreviousFileUrl();
	if (!url) {
		return;
	}

	// The button might be labeled or inside a role="tooltip" element.
	// If it has a tooltip, we need to clone the tooltip element itself, not the button.
	const wrappedHistoryButton = historyButton.closest('[role="tooltip"]');

	if (elementExists(wrappedHistoryButton ? '.rgh-previous-version-mobile' : '.rgh-previous-version-desktop')) {
		return;
	}

	const previousButton = wrappedHistoryButton
		? addMobileDom(wrappedHistoryButton)
		: addDesktopDom(historyButton);

	previousButton.href = url;
	$('span[data-component="leadingVisual"] svg', previousButton).replaceWith(
		<VersionsIcon />,
	);

	onReactPageUpdate(async pageUnload => {
		const url = await getPreviousFileUrl();
		if (pageUnload.aborted) {
			return;
		}

		if (url) {
			previousButton.href = url;
		}

		previousButton.hidden = !url;
	}, signal!);
}

async function init(signal: AbortSignal): Promise<void> {
	await expectToken();
	observe('a:has([data-component="leadingVisual"] svg.octicon-history)', add, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isSingleFile,
		pageDetect.isRepoTree,
		pageDetect.isBlame,
	],
	exclude: [
		pageDetect.isRepoHome,
	],
	init,
});

/*

Test URL

https://github.com/refined-github/refined-github/tree/main/source
https://github.com/refined-github/refined-github/blob/main/readme.md

*/



================================================
FILE: source/features/profile-gists-link.gql
================================================
query getGistCount($username: String!) {
	user(login: $username) {
		gists(first: 0) {
			totalCount
		}
	}
}



================================================
FILE: source/features/profile-gists-link.tsx
================================================
import React from 'dom-chef';
import {CachedFunction} from 'webext-storage-cache';
import {$} from 'select-dom/strict.js';
import {elementExists} from 'select-dom';
import * as pageDetect from 'github-url-detection';
import CodeSquareIcon from 'octicons-plain-react/CodeSquare';

import features from '../feature-manager.js';
import api from '../github-helpers/api.js';
import {getCleanPathname, triggerRepoNavOverflow} from '../github-helpers/index.js';
import createDropdownItem from '../github-helpers/create-dropdown-item.js';
import observe from '../helpers/selector-observer.js';
import GetGistCount from './profile-gists-link.gql';
import {repoUnderlineNavDropdownUl} from '../github-helpers/selectors.js';
import {expectToken} from '../github-helpers/github-token.js';

const gistCount = new CachedFunction('gist-count', {
	async updater(username: string): Promise<number> {
		const {user} = await api.v4(GetGistCount, {
			variables: {username},
		});
		return user.gists.totalCount;
	},
	maxAge: {days: 1},
	staleWhileRevalidate: {days: 3},
});

function getUser(): {url: string; name: string} {
	const name = getCleanPathname();
	const url = pageDetect.isEnterprise()
		? `/gist/${name}`
		: `https://gist.github.com/${name}`;
	return {url, name};
}

async function appendTab(navigationBar: Element): Promise<void> {
	const user = getUser();
	const link = (
		<a
			href={user.url}
			className="UnderlineNav-item js-responsive-underlinenav-item"
			role="tab"
			aria-selected="false"
			data-tab-item="rgh-gists-item"
		>
			<CodeSquareIcon className="UnderlineNav-octicon hide-sm" />
			{' Gists '}
		</a>
	);

	navigationBar.append(link);

	// There are two UnderlineNav items (responsiveâ€¦) that point to the same dropdown
	const overflowNav = $(repoUnderlineNavDropdownUl);
	if (!elementExists('[data-rgh-label="Gists"]', overflowNav)) {
		overflowNav.append(
			createDropdownItem({
				label: 'Gists',
				href: user.url,
				icon: CodeSquareIcon,
				'data-rgh-label': 'Gists',
			}),
		);
	}

	const count = await gistCount.get(user.name);
	if (count > 0) {
		link.append(<span className="Counter">{count}</span>);
	}

	triggerRepoNavOverflow();
}

async function init(signal: AbortSignal): Promise<void> {
	await expectToken();
	observe('nav[aria-label="User"] > ul', appendTab, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isUserProfile,
	],
	init,
});

/*

Test URL:

Has gists: https://github.com/fregante
No gists: https://github.com/someone

*/



================================================
FILE: source/features/profile-hotkey.tsx
================================================
import {isEnterprise} from 'github-url-detection';

import onetime from '../helpers/onetime.js';
import features from '../feature-manager.js';
import {getLoggedInUser} from '../github-helpers/index.js';
import {registerHotkey} from '../github-helpers/hotkey.js';

function initOnce(): void {
	// This patterns also works on gist.github.com
	const origin = isEnterprise() ? location.origin : 'https://github.com';
	const profileLink = new URL(getLoggedInUser()!, origin);
	registerHotkey('g m', profileLink.href);
}

void features.add(import.meta.url, {
	shortcuts: {
		'g m': 'Go to Profile',
	},
	init: onetime(initOnce),
});

/*

Test URLs:

1. Visit any page

*/



================================================
FILE: source/features/pull-request-hotkeys.tsx
================================================
import {$$} from 'select-dom/strict.js';
import elementReady from 'element-ready';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import {addHotkey} from '../github-helpers/hotkey.js';

async function init(): Promise<void> {
	const tabnav = await elementReady([
		'[aria-label="Pull request tabs"]',
		'[aria-label="Pull request navigation tabs"]', // Commits list tab
	].join(', '));
	const tabs = $$([
		'a.tabnav-tab',
		'a[role="tab"]', // Commits list tab
	], tabnav);
	const lastTab = tabs.length - 1;
	const selectedIndex = tabs.findIndex(tab => tab.classList.contains('selected'));

	for (const [index, tab] of tabs.entries()) {
		addHotkey(tab, `g ${index + 1}`);

		if (index === selectedIndex - 1 || (selectedIndex === 0 && index === lastTab)) {
			addHotkey(tab, 'g ArrowLeft');
		} else if (index === selectedIndex + 1 || (selectedIndex === lastTab && index === 0)) {
			addHotkey(tab, 'g ArrowRight');
		}
	}
}

void features.add(import.meta.url, {
	shortcuts: {
		'g <number>': 'Go to PR tab <number>',
		'g â†’': 'Go to next PR tab',
		'g â†': 'Go to previous PR tab',
	},
	include: [
		pageDetect.isPR,
	],
	init,
});

/*

Test URLs:

https://github.com/refined-github/sandbox/pull/4

*/



================================================
FILE: source/features/quick-comment-edit.tsx
================================================
import React from 'dom-chef';
import {elementExists} from 'select-dom';
import PencilIcon from 'octicons-plain-react/Pencil';
import * as pageDetect from 'github-url-detection';
import memoize from 'memoize';

import observe from '../helpers/selector-observer.js';
import features from '../feature-manager.js';
import {isArchivedRepoAsync} from '../github-helpers/index.js';
import {userIsModerator} from '../github-helpers/get-user-permission.js';

// The signal is only used to memoize calls on the current page. A new page load will use a new signal.
const isIssueIneditable = memoize(
	// If .js-pick-reaction is the first child, `reaction-menu` doesn't exist, which means that the conversation is locked.
	// However, if you can edit every comment, you can still edit the comment
	async (_signal: AbortSignal | undefined): Promise<boolean> => elementExists('.js-pick-reaction:first-child') && !await userIsModerator(),
	{
		cache: new WeakMap(),
	},
);

async function addQuickEditButton(commentDropdown: HTMLDetailsElement, {signal}: SignalAsOptions): Promise<void> {
	if (await isIssueIneditable(signal)) {
		features.unload(import.meta.url);
		return;
	}

	const commentBody = commentDropdown.closest('.js-comment')!;

	// TODO: Potentially move to :has selector
	// The comment is definitely not editable
	if (!elementExists('.js-comment-update', commentBody)) {
		return;
	}

	// We can't rely on `observe` for deduplication because the anchor might be replaced by GitHub while leaving the edit button behind #5572
	if (elementExists('.rgh-quick-comment-edit-button', commentBody)) {
		return;
	}

	commentDropdown.before(
		<button
			type="button"
			role="menuitem"
			className="timeline-comment-action btn-link js-comment-edit-button rgh-quick-comment-edit-button"
			aria-label="Edit comment"
		>
			<PencilIcon />
		</button>,
	);
}

async function init(signal: AbortSignal): Promise<void> {
	if (await isArchivedRepoAsync()) {
		return;
	}

	// If true then the resulting selector will match all comments, otherwise it will only match those made by you
	const preSelector = await userIsModerator() ? '' : '.current-user';

	observe(preSelector + '.js-comment.unminimized-comment .timeline-comment-actions details.position-relative', addQuickEditButton, {signal});
}

void features.add(import.meta.url, {
	asLongAs: [
		pageDetect.isLoggedIn,
	],
	include: [
		pageDetect.hasComments,
	],
	init,
});

/*
Test URLs:

- Regular issue: https://github.com/es-tooling/module-replacements-codemods/issues/6
- Locked issue (own repo): https://github.com/refined-github/sandbox/issues/74
- Locked issue (other repo): https://github.com/eslint/eslint/issues/8213
- Archived repo: https://github.com/fregante/iphone-inline-video/issues/101

*/



================================================
FILE: source/features/quick-comment-hiding.tsx
================================================
import React from 'dom-chef';
import {$$} from 'select-dom';
import {$} from 'select-dom/strict.js';

import delegate, {type DelegateEvent} from 'delegate-it';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';

const formSelector = [
	'form[action$="/minimize-comment"]',
	'form[action$="/minimize"]', // Review thread comments
] as const;

function generateSubmenu(hideButton: Element): void {
	if (hideButton.closest('.rgh-quick-comment-hiding-details')) {
		// Already generated
		return;
	}

	const detailsElement = hideButton.closest('details')!;
	detailsElement.classList.add('rgh-quick-comment-hiding-details');

	const comment = hideButton.closest('.unminimized-comment')!;
	const hideCommentForm = $(formSelector, comment);

	// Generate dropdown
	const newForm = hideCommentForm.cloneNode();
	const fields = [...hideCommentForm.elements].map(field => field.cloneNode());
	newForm.append(<i hidden>{fields}</i>); // Add existing fields (comment ID, token)
	newForm.setAttribute('novalidate', 'true');	// Ignore the form's required attributes

	// Imitate existing menu, reset classes
	newForm.className = ['js-comment-minimize', 'dropdown-menu', 'dropdown-menu-sw', 'color-fg-default', 'show-more-popover', 'anim-scale-in'].join(' ');

	for (const reason of $$('option:not([value=""])', hideCommentForm.elements.classifier)) {
		newForm.append(
			<button
				type="submit"
				name="classifier"
				value={reason.value}
				className="dropdown-item btn-link"
				role="menuitem"
			>
				{reason.textContent}
			</button>,
		);
	}

	// Close immediately after the clicking option
	newForm.addEventListener('click', () => {
		detailsElement.open = false;
	});

	detailsElement.append(newForm);
}

// Shows menu on top of mainDropdownContent when "Hide" is clicked;
// Hide it when dropdown closes.
// Uses `v-hidden` to avoid conflicts with `close-out-of-view-modals`
function toggleSubMenu(hideButton: Element, show: boolean): void {
	const dropdown = hideButton.closest('details')!;

	// Native dropdown
	$('details-menu', dropdown).classList.toggle('v-hidden', show);

	// "Hide comment" dropdown
	$(formSelector, dropdown).classList.toggle('v-hidden', !show);
}

function resetDropdowns(event: DelegateEvent): void {
	toggleSubMenu(event.delegateTarget, false);
}

function showSubmenu(event: DelegateEvent): void {
	generateSubmenu(event.delegateTarget);
	toggleSubMenu(event.delegateTarget, true);

	event.stopImmediatePropagation();
	event.preventDefault();
}

function init(signal: AbortSignal): void {
	// `capture: true` required to be fired before GitHub's handlers
	delegate('.js-comment-hide-button', 'click', showSubmenu, {capture: true, signal});
	delegate('.rgh-quick-comment-hiding-details', 'toggle', resetDropdowns, {capture: true, signal});
}

// TODO: Drop feature in April 2025
// https://github.com/refined-github/refined-github/issues/7856#issuecomment-2411492400
void features.add(import.meta.url, {
	include: [
		pageDetect.hasComments,
	],
	init,
});

/*

Test URLs

https://github.com/refined-github/sandbox/pull/47

*/



================================================
FILE: source/features/quick-file-edit.css
================================================
/* Only shows one icon at a time, depending on hover status */
.rgh-quick-file-edit:not(:hover) .octicon-pencil,
.rgh-quick-file-edit:hover > :first-child {
	display: none !important;
}

/* Widen column to avoid bumps in directory-less listings */
.rgh-quick-file-edit {
	width: 16px;
	font-size: 0;
	line-height: 0;
	display: inline-block;
}



================================================
FILE: source/features/quick-file-edit.tsx
================================================
import './quick-file-edit.css';

import React from 'dom-chef';
import PencilIcon from 'octicons-plain-react/Pencil';
import * as pageDetect from 'github-url-detection';

import {wrap} from '../helpers/dom-utils.js';
import features from '../feature-manager.js';
import GitHubFileURL from '../github-helpers/github-file-url.js';
import {isArchivedRepoAsync, isPermalink} from '../github-helpers/index.js';
import observe from '../helpers/selector-observer.js';
import {directoryListingFileIcon} from '../github-helpers/selectors.js';

async function linkifyIcon(fileIcon: Element): Promise<void> {
	const fileLink = fileIcon
		.closest('.react-directory-filename-column')!
		.querySelector('a.Link--primary')!;

	const url = new GitHubFileURL(fileLink.href).assign({
		route: 'edit',
	});

	wrap(fileIcon, <a href={url.href} className="rgh-quick-file-edit" />);
	fileIcon.after(<PencilIcon />);
}

async function init(signal: AbortSignal): Promise<void | false> {
	observe(directoryListingFileIcon, linkifyIcon, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isRepoTree,
	],
	exclude: [
		pageDetect.isRepoFile404,
		isArchivedRepoAsync,
		isPermalink,
	],
	init,
});

/*

Test URLs

Legacy views: https://github.com/refined-github/refined-github
React views: https://github.com/refined-github/refined-github/tree/main/.github

*/



================================================
FILE: source/features/quick-label-removal.css
================================================
.rgh-quick-label-removal {
	display: flex !important;
	margin-left: 2px;
	margin-right: -7px;
	color: inherit !important;

	& svg {
		margin: 2px;
		margin-left: 0;
		border-radius: 50%;
		padding: 2px 0;
		width: 14px;
		height: 14px;
	}

	&:is(:focus, :hover) svg {
		background-color: currentcolor;
		fill: rgb(var(--label-r) var(--label-g) var(--label-b));

		[data-color-mode='dark'][data-dark-theme*='dark'] & {
			fill: var(--rgh-background);
		}
	}
}



================================================
FILE: source/features/quick-label-removal.tsx
================================================
import './quick-label-removal.css';

import React from 'dom-chef';
import {elementExists} from 'select-dom';
import {$} from 'select-dom/strict.js';
import XIcon from 'octicons-plain-react/X';
import {assertError} from 'ts-extras';
import * as pageDetect from 'github-url-detection';
import delegate, {type DelegateEvent} from 'delegate-it';

import features from '../feature-manager.js';
import api from '../github-helpers/api.js';
import showToast from '../github-helpers/toast.js';
import {getConversationNumber} from '../github-helpers/index.js';
import observe from '../helpers/selector-observer.js';
import {expectToken} from '../github-helpers/github-token.js';

// Don't cache: https://github.com/refined-github/refined-github/issues/7283
function canEditLabels(): boolean {
	return elementExists('.label-select-menu .octicon-gear');
}

function getLabelList(): HTMLElement {
	return $('.label-select-menu [src] .hx_rsm-content');
}

function removeLabelList(): void {
	const list = getLabelList();
	list.closest('details')!.addEventListener('toggle', restoreLabelList, {once: true});
	list.replaceChildren();
}

function restoreLabelList(): void {
	const list = getLabelList();
	list.replaceChildren(
		<include-fragment src={list.closest('[src]')!.getAttribute('src')!} />,
	);
}

async function removeLabelButtonClickHandler(event: DelegateEvent<MouseEvent, HTMLButtonElement>): Promise<void> {
	event.preventDefault();

	const removeLabelButton = event.delegateTarget;
	const label = removeLabelButton.closest('a')!;

	try {
		label.hidden = true;
		// Disable dropdown list to avoid race conditions in the UI.
		// Each deletion would be followed by a reload of the list _at the wrong time_
		removeLabelList();

		await api.v3(`issues/${getConversationNumber()!}/labels/${removeLabelButton.dataset.name!}`, {
			method: 'DELETE',
		});
	} catch (error) {
		assertError(error);
		void showToast(error);
		removeLabelButton.blur();
		label.hidden = false;
		return;
	}

	label.remove();
}

function addRemoveLabelButton(label: HTMLElement): void {
	label.classList.add('d-inline-flex');
	label.append(
		<button
			type="button"
			className="btn-link rgh-quick-label-removal"
			data-name={label.dataset.name}
		>
			<XIcon />
		</button>,
	);
}

async function init(signal: AbortSignal): Promise<void> {
	await expectToken();

	delegate('.rgh-quick-label-removal:enabled', 'click', removeLabelButtonClickHandler, {signal});
	observe('.js-issue-labels .IssueLabel', addRemoveLabelButton, {signal});
}

void features.add(import.meta.url, {
	asLongAs: [
		pageDetect.isConversation,
		canEditLabels,
	],
	exclude: [
		pageDetect.isArchivedRepo,
	],
	awaitDomReady: true, // The sidebar is near the end of the page
	init,
});

/*

Test URLs:

https://github.com/refined-github/refined-github/pull/3454
https://github.com/refined-github/refined-github/issues/3440

*/



================================================
FILE: source/features/quick-mention.css
================================================
/* Show button when the avatar or the button itself are hovered/focused */
:not(:hover, :focus) + .rgh-quick-mention:not(:hover, :focus) {
	opacity: 20%;
}

.rgh-quick-mention {
	/* !important required to override .tooltipped */
	position: absolute !important;
	top: 100%;
	left: 50%;
	translate: -50%;

	/* Centers and improves clickable area; !important required to override .btn-link */
	padding: 4px 12px !important;
}

.rgh-quick-mention.react-view {
	position: static !important;
	translate: none;

	&::after {
		bottom: unset;
		transform: none;
	}
}

/* Show icon in black if it's not hovered/focused, instead of the blue color caused by .btn-link */
.rgh-quick-mention:not(:hover, :focus) {
	color: inherit;
}

/* Show tooltip on top of `sticky-comment-header` */
.TimelineItem-avatar:has(.rgh-quick-mention) {
	z-index: 4;
}



================================================
FILE: source/features/quick-mention.tsx
================================================
import './quick-mention.css';

import React from 'dom-chef';
import {$} from 'select-dom/strict.js';
import {elementExists} from 'select-dom';
import ReplyIcon from 'octicons-plain-react/Reply';
import * as pageDetect from 'github-url-detection';
import {insertTextIntoField} from 'text-field-edit';
import delegate, {type DelegateEvent} from 'delegate-it';

import {wrap} from '../helpers/dom-utils.js';
import features from '../feature-manager.js';
import {getLoggedInUser, isArchivedRepoAsync} from '../github-helpers/index.js';
import observe from '../helpers/selector-observer.js';

const fieldSelector = [
	'textarea#new_comment_field',
	'#react-issue-comment-composer textarea',
] as const;

// Old Issue View and PR View
// `:first-child` avoids app badges #2630
// Avatars next to review events aren't wrapped in a <div> #4844
const prCommentSelector = `
	.js-quote-selection-container
	:is(
		div.TimelineItem-avatar > [data-hovercard-type="user"]:first-child,
		a.TimelineItem-avatar
	):not([href="/${getLoggedInUser()!}"])
`;

const issueCommentSelector = [
	// React Issue View
	`[data-testid="issue-viewer-comments-container"] [class^="LayoutHelpers-module__timelineElement"] a:not([href="/${getLoggedInUser()!}"])`,
	// React Issue View (first comment)
	`[data-testid="issue-viewer-issue-container"] a[class^="Avatar-module__avatarLink"]:not([href="/${getLoggedInUser()!}"])`,
];

function prefixUserMention(userMention: string): string {
	// The alt may or may not have it #4859
	return '@' + userMention.replace('@', '').replace(/\[bot\]$/, '');
}

function mentionUser({delegateTarget: button}: DelegateEvent): void {
	const userMention = button.parentElement!.querySelector('img')!.alt;
	const newComment = $(fieldSelector);
	newComment.focus();

	// If the new comment field has selected text, donâ€™t replace it
	newComment.selectionStart = newComment.selectionEnd;

	// If the cursor is preceded by a space (or is at place 0), don't add a space before the mention
	const precedingCharacter = newComment.value.slice(newComment.selectionStart - 1, newComment.selectionStart);
	const spacer = /\s|^$/.test(precedingCharacter) ? '' : ' ';

	// The space after closes the autocomplete box and places the cursor where the user would start typing
	insertTextIntoField(newComment, `${spacer}${prefixUserMention(userMention)} `);
}

const debug = false;

function add(avatar: HTMLElement): void {
	if (debug) {
		avatar.style.border = 'solid 5px black';
	}

	const timelineItem = avatar.closest([
		// Regular comments
		'.js-comment-container',

		// Reviews
		'.js-comment',
	])!;

	const isOldView = Boolean(timelineItem);

	if (isOldView) {
		if (debug) {
			timelineItem.style.border = 'solid 5px red';
		}

		if (
			// Exclude events that aren't tall enough, like hidden comments or reviews without comments
			!elementExists('.unminimized-comment, .js-comment-container', timelineItem)
		) {
			return;
		}
	} else {
		// Make sure the comment isn't hidden
		const contentItem = avatar.parentElement!.querySelector([
			'[data-testid="comment-header"] + div',
			'.react-issue-body', // First comment in React issues view
		])!;

		if (!contentItem) {
			return;
		}
	}

	if (debug) {
		timelineItem.style.border = 'solid 5px green';
	}

	// Wrap avatars next to review events so the inserted button doesn't break the layout #4844
	if (avatar.classList.contains('TimelineItem-avatar')) {
		avatar.classList.remove('TimelineItem-avatar');
		wrap(avatar, <div className="avatar-parent-child TimelineItem-avatar d-none d-md-block" />);
	}

	if (!isOldView) {
		avatar.style.height = 'auto';
		wrap(avatar, <div className="avatar-parent-child d-none d-md-block" />);
	}

	const userMention = $('img', avatar).alt;

	avatar.after(
		<button
			type="button"
			className={['rgh-quick-mention tooltipped tooltipped-e btn-link', isOldView ? '' : 'react-view'].join(' ')}
			aria-label={`Mention ${prefixUserMention(userMention)} in a new comment`}
		>
			<ReplyIcon />
		</button>,
	);
}

async function init(signal: AbortSignal): Promise<void> {
	if (await isArchivedRepoAsync()) {
		return;
	}

	delegate('button.rgh-quick-mention', 'click', mentionUser, {signal});

	const controller = new AbortController();
	const field: HTMLTextAreaElement | undefined = await new Promise(resolve => {
		observe(fieldSelector, field => {
			resolve(field);
			controller.abort();
		}, {signal: AbortSignal.any([signal, controller.signal])});
	});

	if (!field) {
		return;
	}

	const isPROrOldView = field.id === 'new_comment_field';
	if (isPROrOldView) {
		observe(prCommentSelector, add, {signal});
	} else {
		observe(issueCommentSelector, add, {signal});
	}
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isConversation,
	],
	init,
});

/*

Test URLs

https://github.com/refined-github/sandbox/pull/10

No-comment reviews shouldn't have it:
https://github.com/NixOS/nixpkgs/pull/147010#pullrequestreview-817111882

- Locked issue (own repo): https://github.com/refined-github/sandbox/issues/74
- Locked issue (other repo): https://github.com/eslint/eslint/issues/8213
- Comment with app badge:
	- https://github.com/dotnet/docs/issues/10085
	- https://github.com/biomejs/biome/issues/1927#issuecomment-2227203261

*/



================================================
FILE: source/features/quick-new-issue.tsx
================================================
import React from 'dom-chef';
import * as pageDetect from 'github-url-detection';
import IssueOpenedIcon from 'octicons-plain-react/IssueOpened';
import {$} from 'select-dom/strict.js';

import features from '../feature-manager.js';
import {buildRepoURL, getRepo, isArchivedRepoAsync} from '../github-helpers/index.js';
import observe from '../helpers/selector-observer.js';

const labelId = 'rgh-quick-new-issue';

function add(listItem: HTMLElement): void {
	const newIssueItem = listItem.cloneNode(true);

	const link = $('a', newIssueItem);
	const label = $('[id="' + link.getAttribute('aria-labelledby')!.trim() + '"]', newIssueItem);
	link.setAttribute('aria-labelledby', labelId);
	label.id = labelId;

	link.href = buildRepoURL('issues/new/choose');
	label.textContent = `New issue in ${getRepo()?.name}`;

	$('svg', newIssueItem).replaceWith(<IssueOpenedIcon />);

	listItem.parentElement!.append(newIssueItem);

	const separator = $('[data-component="ActionList.Divider"]', listItem.parentElement!).cloneNode(true);
	newIssueItem.before(separator);
}

async function init(signal: AbortSignal): Promise<void | false> {
	observe('li:has(>a[href="/new/import"])', add, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isRepo,
	],
	exclude: [
		isArchivedRepoAsync,
	],
	init,
});

/*

Test URLs:

Repo home:
https://github.com/fregante/webext-storage-cache

Wiki, template picker:
https://github.com/refined-github/refined-github/wiki

Archived repo (feature disabled):
https://github.com/fregante/iphone-inline-video

*/



================================================
FILE: source/features/quick-repo-deletion.tsx
================================================
import React from 'dom-chef';
import elementReady from 'element-ready';
import {$, $optional} from 'select-dom/strict.js';
import * as pageDetect from 'github-url-detection';
import {setFieldText} from 'text-field-edit';
import TrashIcon from 'octicons-plain-react/Trash';
import delegate, {type DelegateEvent} from 'delegate-it';

import features from '../feature-manager.js';
import {buildRepoURL, getForkedRepo, getRepo} from '../github-helpers/index.js';
import observe from '../helpers/selector-observer.js';
import {userIsAdmin} from '../github-helpers/get-user-permission.js';
import {expectTokenScope} from '../github-helpers/github-token.js';
import addNotice from '../github-widgets/notice-bar.js';
import api from '../github-helpers/api.js';
import showToast from '../github-helpers/toast.js';

const tooltip = 'Instant deletion: shift-alt-click';
const buttonHashSelector = '#dialog-show-repo-delete-menu-dialog';

// Only if the repository hasn't been starred
async function isRepoUnpopular(): Promise<boolean> {
	const counter = await elementReady('.starring-container .Counter');
	return counter!.textContent === '0';
}

async function deleteRepository(): Promise<void> {
	const {nameWithOwner} = getRepo()!;
	await expectTokenScope('delete_repo');
	await api.v3('/repos/' + nameWithOwner, {
		method: 'DELETE',
		json: false,
	});
}

async function modifyUIAfterSuccessfulDeletion(): Promise<void> {
	const {nameWithOwner, owner} = getRepo()!;
	const forkSource = '/' + getForkedRepo()!;
	const restoreURL = pageDetect.isOrganizationRepo()
		? `/organizations/${owner}/settings/deleted_repositories`
		: '/settings/deleted_repositories';
	const otherForksURL = `/${owner}?tab=repositories&type=fork`;

	await addNotice(
		<>
			<TrashIcon />
			<span>
				Repository <strong>{nameWithOwner}</strong> deleted. <a href={restoreURL}>Restore it</a>, <a href={forkSource}>visit the source repo</a>, or see <a href={otherForksURL}>your other forks.</a>
			</span>
		</>,
		{action: false},
	);
	$('.application-main').remove();
}

async function handleShiftAltClick(event: DelegateEvent<MouseEvent, HTMLElement>): Promise<void> {
	if (!event.shiftKey || !event.altKey) {
		return;
	}

	event.preventDefault();

	// Can't really prevent default, so we must close the dialog if we're on the repo settings page
	// https://github.com/refined-github/refined-github/pull/7866#issuecomment-2396270060
	$optional<HTMLDialogElement>('#' + event.delegateTarget.getAttribute('data-show-dialog-id')!)?.close();

	if (confirm('Are you sure you want to delete this repository?')) {
		await showToast(deleteRepository, {
			message: 'Deleting repoâ€¦',
			doneMessage: 'Repo deleted',
		});

		await modifyUIAfterSuccessfulDeletion();
	}
}

function addShortcutTooltip(button: HTMLElement): void {
	button.setAttribute('title', tooltip);
}

function addButton(header: HTMLElement): void {
	header.prepend(
		<li>
			<a
				href={buildRepoURL('settings', buttonHashSelector)}
				className="btn btn-sm btn-danger rgh-quick-repo-deletion"
				title={tooltip}
			>
				<TrashIcon className="mr-2" />
				Delete fork
			</a>
		</li>,
	);
}

function autoFill(field: HTMLInputElement): void {
	setFieldText(field, getRepo()!.nameWithOwner);
}

function autoOpenModal(signal: AbortSignal): void {
	$(buttonHashSelector).click();
	observe('.js-repo-delete-proceed-confirmation', autoFill, {signal});
}

async function initRepoRoot(signal: AbortSignal): Promise<void | false> {
	observe('.pagehead-actions', addButton, {signal});
	delegate('.rgh-quick-repo-deletion', 'click', handleShiftAltClick, {signal});
}

async function initRepoSettings(signal: AbortSignal): Promise<void | false> {
	delegate(buttonHashSelector, 'click', handleShiftAltClick, {signal});
	observe(buttonHashSelector, addShortcutTooltip, {signal});
}

void features.add(import.meta.url, {
	asLongAs: [
		pageDetect.isRepoRoot,
		pageDetect.isForkedRepo,
		userIsAdmin,
		isRepoUnpopular,
	],
	init: initRepoRoot,
}, {
	include: [
		pageDetect.isRepoSettings,
	],
	init: initRepoSettings,
}, {
	include: [
		() => location.hash === buttonHashSelector,
	],
	awaitDomReady: true, // The expected element is towards the bottom of the page
	init: autoOpenModal,
});

/*

Test URLs:

1. Fork a repo, like https://github.com/left-pad/left-pad
2. Star it to see if the "Delete fork" button disappears
3. Click "Delete fork"
4. The confirmation dialog should appear
5. On the last step, the repo name field should be auto-filled

*/



================================================
FILE: source/features/quick-review-comment-deletion.tsx
================================================
import React from 'dom-chef';
import {$} from 'select-dom/strict.js';
import TrashIcon from 'octicons-plain-react/Trash';
import * as pageDetect from 'github-url-detection';
import delegate, {type DelegateEvent} from 'delegate-it';
import {isChrome} from 'webext-detect';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';
import loadDetailsMenu from '../github-helpers/load-details-menu.js';
import showToast from '../github-helpers/toast.js';

function onButtonClick({delegateTarget: button}: DelegateEvent): void {
	try {
		button
			.closest('.js-comment')!
			.querySelector('.show-more-popover .js-comment-delete > button')!
			.click();
	} catch (error) {
		void showToast(new Error('Feature broken. Please open an issue with the link found in the console'));
		throw error;
	}
}

async function preloadDropdown({delegateTarget: button}: DelegateEvent): Promise<void> {
	const comment = button.closest('.js-comment')!;
	await loadDetailsMenu($('details-menu.show-more-popover', comment));
}

function addDeleteButton(cancelButton: Element): void {
	cancelButton.after(
		<button className="btn btn-danger float-left mr-auto rgh-review-comment-delete-button" type="button">
			<TrashIcon />
		</button>,
	);
}

function init(signal: AbortSignal): void {
	delegate('.rgh-review-comment-delete-button', 'click', onButtonClick, {signal});
	delegate('.rgh-quick-comment-edit-button', 'click', preloadDropdown, {signal});
	observe('.review-comment .js-comment-cancel-button', addDeleteButton, {signal});
}

void features.add(import.meta.url, {
	asLongAs: [
		isChrome,
	],
	include: [
		pageDetect.isPRConversation,
		pageDetect.isPRFiles,
	],
	init,
});

/*

Test URLs

- https://github.com/refined-github/sandbox/pull/31
- https://github.com/refined-github/sandbox/pull/31/files

*/



================================================
FILE: source/features/quick-review.tsx
================================================
import React from 'dom-chef';
import {$} from 'select-dom/strict.js';
import elementReady from 'element-ready';
import * as pageDetect from 'github-url-detection';
import delegate, {type DelegateEvent} from 'delegate-it';

import delay from '../helpers/delay.js';
import api from '../github-helpers/api.js';
import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';
import showToast from '../github-helpers/toast.js';
import {
	getConversationNumber,
	getLoggedInUser,
	scrollIntoViewIfNeeded,
	triggerConversationUpdate,
} from '../github-helpers/index.js';
import {randomArrayItem} from '../helpers/math.js';
import {getToken} from '../options-storage.js';

const emojis = [...'ğŸš€ğŸ¿ï¸âš¡ï¸ğŸ¤ŒğŸ¥³ğŸ¥°ğŸ¤©ğŸ¥¸ğŸ˜ğŸ¤¯ğŸš¢ğŸ›«ğŸ³ï¸ğŸ'];

async function quickApprove(event: DelegateEvent<MouseEvent>): Promise<void> {
	const approval = event.altKey ? '' : prompt('Approve instantly? You can add a custom message or leave empty');
	if (approval === null) {
		return;
	}

	const call = api.v3(`pulls/${getConversationNumber()!}/reviews`, {
		method: 'POST',
		body: {event: 'APPROVE', body: approval},
	});

	await showToast(call, {
		message: 'Approvingâ€¦',
		doneMessage: `${randomArrayItem(emojis)} Approved`,
	});

	// Update timeline and scroll to bottom so the new review appears in view
	scrollIntoViewIfNeeded($('#partial-timeline'));
	triggerConversationUpdate();
}

async function addSidebarReviewButton(reviewersSection: Element): Promise<void> {
	const reviewFormUrl = new URL(location.href);
	reviewFormUrl.pathname += '/files';
	reviewFormUrl.hash = 'review-changes-modal';

	// Occasionally this button appears before "Reviewers", so let's wait a bit longer
	await delay(300);
	const quickReview = (
		<span className="text-normal color-fg-muted">
			â€“ <a href={reviewFormUrl.href} className="btn-link Link--muted Link--inTextBlock" data-hotkey="v" data-turbo-frame="repo-content-turbo-frame" title="Hotkey: V">review now</a>
		</span>
	);

	reviewersSection.append(quickReview);

	// Can't approve own PRs and closed PRs
	// API required for this action
	if (
		getLoggedInUser() === $('.author').textContent
		|| pageDetect.isClosedConversation()
		|| !(await getToken())
	) {
		return;
	}

	quickReview.append(
		' â€“ ',
		<button
			type="button"
			className="btn-link Link--muted Link--inTextBlock rgh-quick-approve tooltipped tooltipped-nw"
			aria-label="Hold alt to approve without confirmation"
		>
			approve now
		</button>,
	);
}

async function initSidebarReviewButton(signal: AbortSignal): Promise<void> {
	observe('#reviewers-select-menu .discussion-sidebar-heading', addSidebarReviewButton, {signal});
	delegate('.rgh-quick-approve', 'click', quickApprove, {signal});
}

function focusReviewTextarea(event: DelegateEvent<Event, HTMLElement>): void {
	if ('newState' in event && event.newState === 'open') {
		$('textarea', event.delegateTarget).focus();
	}
}

async function initReviewButtonEnhancements(signal: AbortSignal): Promise<void> {
	delegate('#review-changes-modal', 'toggle', focusReviewTextarea, {capture: true, signal});

	const reviewDropdownButton = await elementReady('.js-reviews-toggle');
	if (reviewDropdownButton) {
		reviewDropdownButton.dataset.hotkey = 'v';
	}
}

async function openReviewPopup(button: HTMLButtonElement): Promise<void> {
	await delay(100); // The popover appears immediately afterwards in the HTML, observe() might trigger too soon
	(button.popoverTargetElement as HTMLElement).showPopover();
}

function initNativeDeepLinking(signal: AbortSignal): void {
	// Cannot target the [popover] itself because observe() can't see hidden elements
	observe('[popovertarget="review-changes-modal"]', openReviewPopup, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isPRConversation,
	],
	init: initSidebarReviewButton,
}, {
	shortcuts: {
		v: 'Open PR review popup',
	},
	include: [
		pageDetect.isPRFiles,
	],
	init: initReviewButtonEnhancements,
}, {
	asLongAs: [
		() => location.hash === '#review-changes-modal',
		pageDetect.isPRFiles,
	],
	init: initNativeDeepLinking,
});

/*

Test URLs:

- Open PR (review, approve) https://github.com/refined-github/sandbox/pull/10
- Closed PR (only review) https://github.com/refined-github/sandbox/pull/26

*/



================================================
FILE: source/features/reactions-avatars.css
================================================
:root .rgh-reactions-avatar {
	--size: 16px;
	--inherited-gap: 0px; /* Some buttons are flex+gap, others are not */

	margin-left: calc(var(--size) * 0.3); /* Move away from count */
	margin-right: calc(var(--size) * -0.5 - var(--inherited-gap));
	height: var(--size);

	&:last-of-type {
		margin-right: 0 !important;
	}

	[role='switch'] & {
		--inherited-gap: 4px;

		&:last-of-type {
			margin-right: -3px !important;
		}
	}
}



================================================
FILE: source/features/reactions-avatars.tsx
================================================
import './reactions-avatars.css';

import React from 'dom-chef';
import {$$} from 'select-dom';
import {flatZip} from 'flat-zip';
import * as pageDetect from 'github-url-detection';

import {onAbort} from 'abort-utils';

import observe from '../helpers/selector-observer.js';
import features from '../feature-manager.js';
import {getLoggedInUser} from '../github-helpers/index.js';
import getUserAvatar from '../github-helpers/get-user-avatar.js';

const arbitraryAvatarLimit = 36;
const approximateHeaderLength = 3; // Each button header takes about as much as 3 avatars
const avatarSize = 16;

type Participant = {
	button: HTMLButtonElement;
	username: string;
	imageUrl: string;
};

function getParticipants(button: HTMLButtonElement): Participant[] {
	let users;

	if (button.getAttribute('role') === 'switch') { // [aria-label] alone is not a differentiator
		users = button.nextElementSibling!
			.textContent
			.replace(/.*including /, '')
			.replace(/\)/, '')
			.replace(/,? and /, ', ')
			.replace(/, \d+ more/, '')
			.split(', ');
	} else if (button.nextElementSibling?.tagName === 'TOOL-TIP') {
		// The list of people who commented is in an adjacent `<tool-tip>` element #5698
		users = button.nextElementSibling
			.textContent
			.replace(/ reacted with.*/, '')
			.replace(/,? and /, ', ')
			.replace(/, \d+ more/, '')
			.split(', ');
	} else {
		throw new Error('Unknown reaction button layout');
	}

	const currentUser = getLoggedInUser();
	const participants = [];
	for (const username of users) {
		if (username === currentUser) {
			continue;
		}

		const imageUrl = getUserAvatar(username, avatarSize);
		if (imageUrl) {
			participants.push({button, username, imageUrl});
		}
	}

	return participants;
}

const viewportObserver = new IntersectionObserver(changes => {
	for (const change of changes) {
		if (change.isIntersecting) {
			showAvatarsOn(change.target);
			viewportObserver.unobserve(change.target);
		}
	}
}, {
	// Start loading a little before they become visible
	rootMargin: '500px',
});

function showAvatarsOn(commentReactions: Element): void {
	const reactions = $$([
		'button[aria-pressed]', // Discussions, releases, PRs, old issues
		'button[aria-checked]', // React issues
	], commentReactions)
		.map(button => getParticipants(button)); // Get all participants for each reaction
	const avatarLimit = arbitraryAvatarLimit - (reactions.length * approximateHeaderLength);
	const flatParticipants = flatZip(reactions, avatarLimit);

	for (const {button, username, imageUrl} of flatParticipants) {
		button.append(
			<span className="avatar-user avatar rgh-reactions-avatar p-0 flex-self-center">
				<img src={imageUrl} className="d-block" width={avatarSize} height={avatarSize} alt={`@${username}`} loading="lazy" />
			</span>,
		);
	}
}

function observeCommentReactions(commentReactions: Element): void {
	viewportObserver.observe(commentReactions);
}

function init(signal: AbortSignal): void {
	observe([
		// `batch-deferred-content` means the participant list hasn't loaded yet
		'.has-reactions .js-comment-reactions-options:not(batch-deferred-content .js-comment-reactions-options)',
		'[aria-label="Reactions"]',
	], observeCommentReactions, {signal});
	onAbort(signal, viewportObserver);
}

void features.add(import.meta.url, {
	include: [
		pageDetect.hasComments,
		pageDetect.isReleasesOrTags,
		pageDetect.isSingleReleaseOrTag,
		pageDetect.isDiscussion,
	],
	init,
});

/*
Test URLs

- PR: https://github.com/refined-github/refined-github/pull/4119
- Locked PR: https://github.com/refined-github/refined-github/pull/975
- Copilot reaction: https://github.com/refined-github/refined-github/issues/7761
- Dependabot reaction: https://github.com/aio-libs/aiohttp/pull/3809#issuecomment-498809698
- Discussion: https://github.com/parcel-bundler/parcel/discussions/6490
- Locked discussion: https://github.com/orgs/community/discussions/28776
- Deferred participants loading: https://github.com/orgs/community/discussions/30093
- Releases: https://github.com/refined-github/refined-github/releases

*/



================================================
FILE: source/features/readable-title-change-events.css
================================================
/* Stack titles in title edition events to improve readability */

div:has(> span[class^='RenamedTitleEvent']),
.TimelineItem-body:has(del.markdown-title) {
	display: flex;
	flex-wrap: wrap !important;
	gap: 0 0.3em;
}

span[class^='RenamedTitleEvent'],
.TimelineItem-body :is(del, ins).markdown-title {
	flex-basis: 100%;
	order: 99;

	/* TODO: Drop when adding support for the new issue view */
	word-break: break-word !important;
}

/* GitHub bug */
.TimelineItem-body del.markdown-title {
	text-decoration: line-through !important;
}

/*
Test URLs

- Issue: https://github.com/refined-github/sandbox/issues/112#event-18404386593
- PR: https://github.com/refined-github/sandbox/pull/114#event-18404427896
*/



================================================
FILE: source/features/release-download-count.css
================================================
/* Simulates fixed columns */
.rgh-release-download-count {
	& > span:not(:last-child) {
		flex-basis: 0 !important;
		min-width: 5em;
	}

	/* Date */
	& > span:last-child {
		width: 7em;
		overflow: hidden;
		text-overflow: ellipsis;
	}

	/* Right-align on mobile */
	[data-rgh-heat] {
		min-width: 5em;
	}
}



================================================
FILE: source/features/release-download-count.gql
================================================
query getReleaseDownloadCount($owner: String!, $name: String!, $tag: String!) {
	repository(owner: $owner, name: $name) {
		release(tagName: $tag) {
			releaseAssets(first: 100) {
				nodes {
					name
					downloadCount
				}
			}
		}
	}
}



================================================
FILE: source/features/release-download-count.tsx
================================================
/*

This feature is documented at https://github.com/refined-github/refined-github/wiki/Customization

*/

import './release-download-count.css';

import React from 'dom-chef';
import {$$} from 'select-dom';
import {$, $optional} from 'select-dom/strict.js';
import DownloadIcon from 'octicons-plain-react/Download';
import * as pageDetect from 'github-url-detection';
import {abbreviateNumber} from 'js-abbreviation-number';

import getReleaseDownloadCount from './release-download-count.gql';
import features from '../feature-manager.js';
import api from '../github-helpers/api.js';
import observe from '../helpers/selector-observer.js';
import {createHeatIndexFunction} from '../helpers/math.js';
import {expectToken} from '../github-helpers/github-token.js';
import {assertNodeContent, getClasses} from '../helpers/dom-utils.js';

type Asset = {
	name: string;
	downloadCount: number;
};

async function getAssetsForTag(tag: string): Promise<Record<string, number>> {
	const {repository} = await api.v4(getReleaseDownloadCount, {variables: {tag}});
	const assets: Asset[] = repository.release.releaseAssets.nodes;
	return Object.fromEntries(assets.map(({name, downloadCount}) => ([name, downloadCount])));
}

async function addCounts(assetsList: HTMLElement): Promise<void> {
	// Both pages have .Box but in the list .Box doesn't include the tag
	const container = assetsList.closest('section') // Single-release page
		?? assetsList.closest('.Box:not(.Box--condensed)')!; // Releases list, excludes the assets listâ€™s own .Box

	// .octicon-code required by visit-tag feature
	const releaseName = $(['.octicon-tag ~ span', '.octicon-code ~ span'], container)
		.textContent
		.trim();

	const assets = await getAssetsForTag(releaseName);

	const calculateHeatIndex = createHeatIndexFunction(Object.values(assets));
	for (const assetLink of $$('.octicon-package ~ a', assetsList)) {
		// Match the asset in the DOM to the asset in the API response
		const downloadCount = assets[assetLink.pathname.split('/').pop()!] ?? 0;

		// Place next to asset sha
		const assetSize = assetLink
			.closest('.Box-row')!
			.querySelector(':scope > .flex-justify-end > span')!;
		assertNodeContent(assetSize.firstChild, /^\d+(\.\d+)? \w{2,5}$/);

		assetSize.classList.replace('text-sm-left', 'text-md-right');

		const classes = getClasses(assetSize);
		if (downloadCount === 0) {
			// Don't show, but preserve space/column
			classes.add('v-hidden');
		}

		// Add class to parent in order to define "columns"
		assetSize.parentElement!.classList.add('rgh-release-download-count');

		// Hide sha on mobile. They have the classes but they're not correct (they hide in mid sizes, but show on smallest and largest...)
		$optional(':scope > div:has(clipboard-copy)', assetSize.parentElement!)?.classList.add('d-none');

		// Add at the beginning of the line to avoid (clickable) content shift
		assetSize.parentElement!.prepend(
			<span className={[...getClasses(assetSize)].join(' ')}>
				<span
					className="d-inline-block text-right"
					title={`${downloadCount} downloads`}
					data-rgh-heat={calculateHeatIndex(downloadCount)}
				>
					{abbreviateNumber(downloadCount)} <DownloadIcon />
				</span>
			</span>,
		);

		// Remove via JS because we can't override utility classes...
		for (const column of assetSize.parentElement!.children) {
			column.classList.remove('ml-sm-3', 'ml-md-4');
			column.classList.add('ml-lg-4');
		}
	}
}

async function init(signal: AbortSignal): Promise<void> {
	await expectToken();

	observe('.Box-footer .Box--condensed:has(.octicon-package)', addCounts, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isReleasesOrTags,
		pageDetect.isSingleReleaseOrTag,
	],
	init,
});

/*

Test URLs

- One release: https://github.com/refined-github/sandbox/releases/tag/v1.0.0
- List of releases: https://github.com/cli/cli/releases
- Lots of assets: https://github.com/notepad-plus-plus/notepad-plus-plus/releases
- Assets without hashes: https://github.com/NateShoffner/Disable-Nvidia-Telemetry/releases/tag/1.1

*/



================================================
FILE: source/features/releases-dropdown.gql
================================================
query GetReleases($owner: String!, $name: String!) {
	repository(owner: $owner, name: $name) {
		releases(first: 100) {
			nodes {
				tagName
			}
		}
	}
}



================================================
FILE: source/features/releases-dropdown.tsx
================================================
import React from 'dom-chef';
import * as pageDetect from 'github-url-detection';
import delegate, {type DelegateEvent} from 'delegate-it';
import {CachedFunction} from 'webext-storage-cache';

import api from '../github-helpers/api.js';
import features from '../feature-manager.js';
import {buildRepoURL, cacheByRepo} from '../github-helpers/index.js';
import observe from '../helpers/selector-observer.js';
import GetReleases from './releases-dropdown.gql';
import {expectToken} from '../github-helpers/github-token.js';

const getReleases = new CachedFunction('releases', {
	async updater(): Promise<string[]> {
		const {repository} = await api.v4(GetReleases);
		return repository.releases.nodes.map(({tagName}: {tagName: string}) => tagName);
	},
	maxAge: {hours: 1},
	staleWhileRevalidate: {days: 4},
	cacheKey: cacheByRepo,
});

// `datalist` selections don't have an `inputType`
async function selectionHandler(event: DelegateEvent<Event, HTMLInputElement>): Promise<void> {
	const field = event.delegateTarget;
	const selectedTag = field.value;
	const releases = await getReleases.get(); // Expected to be in cache
	if (!('inputType' in event) && releases.includes(selectedTag)) {
		location.href = buildRepoURL('releases/tag', encodeURIComponent(selectedTag));
		field.value = ''; // Can't call `preventDefault`, the `input` event is not cancelable
	}
}

async function addList(searchField: HTMLInputElement): Promise<void> {
	const releases = await getReleases.get();
	if (releases.length === 0) {
		return;
	}

	searchField.setAttribute('list', 'rgh-releases-dropdown');
	searchField.after(
		<datalist id="rgh-releases-dropdown">
			{releases.map(tag => <option value={tag} />)}
		</datalist>,
	);
}

const searchFieldSelector = 'input#release-filter';
async function init(signal: AbortSignal): Promise<void> {
	await expectToken();
	observe(searchFieldSelector, addList, {signal});
	delegate(searchFieldSelector, 'input', selectionHandler, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isReleases,
	],
	init,
});

/*

## Test URLs

https://github.com/refined-github/sandbox/releases

*/



================================================
FILE: source/features/releases-tab.gql
================================================
query GetReleasesCount($owner: String!, $name: String!) {
	repository(owner: $owner, name: $name) {
		releases {
			totalCount
		}
		tags: refs(refPrefix: "refs/tags/") {
			totalCount
		}
	}
}



================================================
FILE: source/features/releases-tab.tsx
================================================
import React from 'dom-chef';
import {CachedFunction} from 'webext-storage-cache';
import TagIcon from 'octicons-plain-react/Tag';
import elementReady from 'element-ready';
import * as pageDetect from 'github-url-detection';
import {$optional} from 'select-dom/strict.js';

import observe from '../helpers/selector-observer.js';
import features from '../feature-manager.js';
import api from '../github-helpers/api.js';
import abbreviateNumber from '../helpers/abbreviate-number.js';
import createDropdownItem from '../github-helpers/create-dropdown-item.js';
import {
	buildRepoURL,
	cacheByRepo,
	getRepo,
	triggerRepoNavOverflow,
} from '../github-helpers/index.js';
import {appendBefore} from '../helpers/dom-utils.js';
import {repoUnderlineNavUl, repoUnderlineNavDropdownUl} from '../github-helpers/selectors.js';
import GetReleasesCount from './releases-tab.gql';
import {expectToken} from '../github-helpers/github-token.js';

function detachHighlightFromCodeTab(codeTab: HTMLAnchorElement): void {
	codeTab.dataset.selectedLinks = codeTab.dataset.selectedLinks!.replace('repo_releases ', '');
}

const releasesCount = new CachedFunction('releases-count', {
	updater: fetchCounts,
	shouldRevalidate: cachedValue => typeof cachedValue === 'number',
	maxAge: {hours: 1},
	staleWhileRevalidate: {days: 3},
	cacheKey: cacheByRepo,
});

export async function getReleases(): Promise<[0] | [number, 'Tags' | 'Releases']> {
	const repo = getRepo()!.nameWithOwner;
	return releasesCount.get(repo);
}

async function fetchCounts(nameWithOwner: string): Promise<[0] | [number, 'Tags' | 'Releases']> {
	const [owner, name] = nameWithOwner.split('/');
	const {repository: {releases, tags}} = await api.v4(GetReleasesCount, {
		variables: {name, owner},
	});

	if (releases.totalCount) {
		return [releases.totalCount, 'Releases'];
	}

	if (tags.totalCount) {
		return [tags.totalCount, 'Tags'];
	}

	return [0];
}

async function addReleasesTab(repoNavigationBar: HTMLElement): Promise<false | void> {
	const [count, type] = await getReleases();
	if (!type) {
		return false;
	}

	// Wait for the dropdown because `observe` fires as soon as it encounter the container. `releases-tab` must be appended.
	await elementReady(repoUnderlineNavUl);

	repoNavigationBar.append(
		<li className="d-flex">
			<a
				href={buildRepoURL(type.toLowerCase())}
				className="js-selected-navigation-item UnderlineNav-item hx_underlinenav-item no-wrap js-responsive-underlinenav-item rgh-releases-tab"
				data-hotkey="g r"
				data-selected-links="repo_releases"
				data-tab-item="rgh-releases-item"
				data-turbo-frame="repo-content-turbo-frame" /* Required for `data-selected-links` to work */
				title="Hotkey: G R"
			>
				<TagIcon className="UnderlineNav-octicon d-none d-sm-inline" />
				<span data-content={type}>{type}</span>
				<span className="Counter" title={count > 999 ? String(count) : ''}>{abbreviateNumber(count)}</span>
			</a>
		</li>,
	);

	triggerRepoNavOverflow();
}

async function addReleasesDropdownItem(dropdownMenu: HTMLElement): Promise<false | void> {
	const [, type] = await getReleases();

	if (!type) {
		$optional('.dropdown-divider', dropdownMenu)?.remove();
		return false;
	}

	appendBefore(
		dropdownMenu,
		'.dropdown-divider', // Won't exist if `clean-repo-tabs` is disabled
		createDropdownItem({
			label: type,
			href: buildRepoURL(type.toLowerCase()),
			icon: TagIcon,
			'data-menu-item': 'rgh-releases-item',
		}),
	);

	triggerRepoNavOverflow();
}

async function init(signal: AbortSignal): Promise<void> {
	await expectToken();
	observe(repoUnderlineNavUl, addReleasesTab, {signal});
	observe(repoUnderlineNavDropdownUl, addReleasesDropdownItem, {signal});
	observe(['[data-menu-item="i0code-tab"] a', 'a#code-tab'], detachHighlightFromCodeTab, {signal});
}

void features.add(import.meta.url, {
	shortcuts: {
		'g r': 'Go to Releases',
	},
	include: [
		pageDetect.hasRepoHeader,
	],
	init,
});

/*

Test URLs:

Releases: https://github.com/refined-github/refined-github
Tags: https://github.com/python/cpython

*/



================================================
FILE: source/features/reload-failed-proxied-images.tsx
================================================
import delegate, {type DelegateEvent} from 'delegate-it';

import delay from '../helpers/delay.js';
import onetime from '../helpers/onetime.js';
import features from '../feature-manager.js';

async function handleErroredImage({delegateTarget}: DelegateEvent<ErrorEvent, HTMLImageElement>): Promise<void> {
	console.log('Refined GitHub: image failed loading, will retry', delegateTarget.src);

	await delay(5000);
	try {
		// A clone image retries downloading
		const cloned = delegateTarget.cloneNode();
		await cloned.decode();
		// If successfully loaded, the failed image will be replaced.
		delegateTarget.replaceWith(cloned);
	} catch {}
}

function initOnce(): void {
	delegate('img[src^="https://camo.githubusercontent.com/"]', 'error', handleErroredImage, {capture: true});
}

void features.add(import.meta.url, {
	init: onetime(initOnce),
});

/*

Test URLs:

1. https://github.com/refined-github/sandbox/blob/7416/7416.md
2. See log in console

*/



================================================
FILE: source/features/repo-age-first-commit.gql
================================================
query GetFirstCommit($owner: String!, $name: String!) {
	repository(owner: $owner, name: $name) {
		defaultBranchRef {
			target {
				... on Commit {
					oid
					committedDate
					resourcePath
					history {
						totalCount
					}
				}
			}
		}
	}
}



================================================
FILE: source/features/repo-age.gql
================================================
query GetRepoAge($owner: String!, $name: String!, $cursor: String!) {
	repository(owner: $owner, name: $name) {
		defaultBranchRef {
			target {
				... on Commit {
					history(first: 5, after: $cursor) {
						nodes {
							committedDate
							resourcePath
						}
					}
				}
			}
		}
	}
}



================================================
FILE: source/features/repo-age.tsx
================================================
import twas from 'twas';
import {CachedFunction} from 'webext-storage-cache';
import React from 'dom-chef';
import RepoIcon from 'octicons-plain-react/Repo';
import elementReady from 'element-ready';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import api from '../github-helpers/api.js';
import {cacheByRepo} from '../github-helpers/index.js';
import GetRepoAge from './repo-age.gql';
import GetFirstCommit from './repo-age-first-commit.gql';
import {randomArrayItem} from '../helpers/math.js';

type CommitTarget = {
	oid: string;
	committedDate: string;
	resourcePath: string;
	history: {
		totalCount: number;
	};
};

const fresh = [
	'Freshly baked',
	'Freshly brewed',
	'Newly minted',
	'Hot off the presses',
	'Straight out of the oven',
	'Still hot',
	'Smells fresh',
	'Just a baby',
	'Itâ€™s my birthday',
	'Brand spanking new',
	'Itâ€™s a new world âœ¨',
	'Certified Fresh Repoâ„¢',
	'So it begins, the great battle of our time',
];

const dateFormatter = new Intl.DateTimeFormat('en-US', {
	year: 'numeric',
	month: 'long',
	day: 'numeric',
});

async function getRepoAge(commitSha: string, commitsCount: number): Promise<[committedDate: string, resourcePath: string]> {
	const {repository} = await api.v4(GetRepoAge, {
		variables: {
			cursor: `${commitSha} ${commitsCount - Math.min(6, commitsCount)}`,
		},
	});

	const {committedDate, resourcePath} = repository.defaultBranchRef.target.history.nodes
		.toReversed()
		// Filter out any invalid commit dates #3185
		.find((commit: CommitTarget) => new Date(commit.committedDate).getFullYear() > 1970);

	return [committedDate, resourcePath];
}

const firstCommit = new CachedFunction('first-commit', {
	async updater(): Promise<[committedDate: string, resourcePath: string]> {
		const {repository} = await api.v4(GetFirstCommit);

		const {oid: commitSha, history, committedDate, resourcePath} = repository.defaultBranchRef.target as CommitTarget;
		const commitsCount = history.totalCount;
		if (commitsCount === 1) {
			return [committedDate, resourcePath];
		}

		return getRepoAge(commitSha, commitsCount);
	},
	cacheKey: cacheByRepo,
});

async function init(): Promise<void> {
	const [firstCommitDate, firstCommitHref] = await firstCommit.get();
	const birthday = new Date(firstCommitDate);

	// `twas` could also return `an hour ago` or `just now`
	const [value, unit] = twas(birthday.getTime())
		.replace('just now', '1 second')
		.replace(/^an?/, '1')
		.split(' ');

	// About a day old or less ?
	const age = Date.now() - birthday.getTime() < 10e7
		? randomArrayItem(fresh)
		: <><strong>{value}</strong> {unit} old</>;

	const sidebarForksLinkIcon = await elementReady('.BorderGrid .octicon-repo-forked');
	sidebarForksLinkIcon!.closest('.mt-2')!.after(
		<h3 className="sr-only">Repository age</h3>,
		<div className="mt-2">
			<a href={firstCommitHref} className="Link--muted" title={`First commit dated ${dateFormatter.format(birthday)}`}>
				<RepoIcon className="mr-2" /> {age}
			</a>
		</div>,
	);
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isRepoRoot,
	],
	exclude: [
		pageDetect.isEmptyRepoRoot,
	],
	deduplicate: 'has-rgh-inner',
	init,
});

/*

Test URLs:

https://github.com/refined-github/sandbox
https://github.com/refined-github/sandbox/tree/6619

*/



================================================
FILE: source/features/repo-avatars.tsx
================================================
import React from 'dom-chef';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import {getRepo} from '../github-helpers/index.js';
import getUserAvatar from '../github-helpers/get-user-avatar.js';
import observe from '../helpers/selector-observer.js';

async function add(ownerLabel: HTMLElement): Promise<void> {
	const username = getRepo()!.owner;
	const size = 16;
	const source = getUserAvatar(username, size)!;

	const avatar = (
		<img
			className="avatar ml-1 mr-2"
			src={source}
			width={size}
			height={size}
			alt={`@${username}`}
		/>
	);

	ownerLabel.classList.add('d-flex', 'flex-items-center');
	ownerLabel.prepend(avatar);

	if (!ownerLabel.closest('[data-hovercard-type="organization"]')) {
		avatar.classList.add('avatar-user');
	}
}

function init(signal: AbortSignal): void {
	observe([
		'.AppHeader-context-full [role="listitem"]:first-child .AppHeader-context-item-label', // TODO: Drop after May 2026
		'header.GlobalNav [data-testid="top-nav-center"] ol > li:first-child span',
	], add, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.hasRepoHeader,
	],
	init,
});

/*

## Test URLs

- org repo: https://github.com/refined-github/refined-github/issues
- user repo: https://github.com/fregante/GhostText/issues

*/



================================================
FILE: source/features/repo-header-info.gql
================================================
query GetRepositoryInfo($owner: String!, $name: String!) {
	repository(owner: $owner, name: $name) {
		stargazerCount
		isFork
		isPrivate
		viewerHasStarred
	}
}



================================================
FILE: source/features/repo-header-info.tsx
================================================
import * as pageDetect from 'github-url-detection';
import LockIcon from 'octicons-plain-react/Lock';
import RepoForkedIcon from 'octicons-plain-react/RepoForked';
import StarIcon from 'octicons-plain-react/Star';
import StarFillIcon from 'octicons-plain-react/StarFill';
import React from 'dom-chef';
import {elementExists} from 'select-dom';
import {CachedFunction} from 'webext-storage-cache';

import observe from '../helpers/selector-observer.js';
import features from '../feature-manager.js';
import api from '../github-helpers/api.js';
import GetRepositoryInfo from './repo-header-info.gql';
import {buildRepoURL, cacheByRepo} from '../github-helpers/index.js';
import abbreviateNumber from '../helpers/abbreviate-number.js';
import {expectToken} from '../github-helpers/github-token.js';
import {isSmallDevice} from '../helpers/dom-utils.js';

type RepositoryInfo = {
	isFork: boolean;
	isPrivate: boolean;
	stargazerCount: number;
	viewerHasStarred: boolean;
};

const repositoryInfo = new CachedFunction('stargazer-count', {
	async updater(): Promise<RepositoryInfo> {
		const {repository} = await api.v4(GetRepositoryInfo);
		return repository;
	},
	maxAge: {days: 1},
	staleWhileRevalidate: {days: 3},
	cacheKey: cacheByRepo,
});

async function add(repoLink: HTMLAnchorElement): Promise<void> {
	const {isFork, isPrivate, stargazerCount, viewerHasStarred} = await repositoryInfo.get();

	// GitHub may already show this icon natively, so we match its position
	if (isPrivate && !elementExists('.octicon-lock', repoLink)) {
		repoLink.append(
			<LockIcon className="ml-1" width={12} height={12} />,
		);
	}

	// GitHub may already show this icon natively, so we match its position
	if (isFork && !elementExists('.octicon-repo-forked', repoLink)) {
		repoLink.append(
			<RepoForkedIcon className="ml-1" width={12} height={12} />,
		);
	}

	if (stargazerCount > 1) {
		let tooltip = `Repository starred by ${stargazerCount.toLocaleString('us')} people`;
		if (viewerHasStarred) {
			tooltip += ', including you';
		}

		if (!repoLink.classList.contains('AppHeader-context-item')) {
			repoLink.closest('li')!.classList.add('d-flex');
		}

		repoLink.after(
			<a
				href={buildRepoURL('stargazers')}
				title={tooltip}
				// Hide in small viewports, matches `ci-link`
				className="d-none d-sm-flex flex-items-center flex-justify-center mr-1 gap-1 color-fg-muted"
			>
				{
					viewerHasStarred
						// Use `color` because `fill` is overridden with `currentColor`
						? <StarFillIcon className="ml-1" width={12} height={12} color="var(--button-star-iconColor)" />
						: <StarIcon className="ml-1" width={12} height={12} />
				}
				<span className="f5">{abbreviateNumber(stargazerCount)}</span>
			</a>,
		);
	}
}

async function init(signal: AbortSignal): Promise<void> {
	await expectToken();
	observe([
		'.AppHeader-context-full [role="listitem"]:last-child a.AppHeader-context-item', // TODO: Drop after May 2026
		'header.GlobalNav [data-testid="top-nav-center"] ol > li:last-child a:first-child',
	], add, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.hasRepoHeader,
	],
	exclude: [
		// Disable the feature entirely on small screens
		isSmallDevice,
	],
	init,
});

/*
Test URLs

- Regular: https://github.com/refined-github/refined-github
- Fork: https://github.com/134130/refined-github
- Fork with native icon: https://github.com/refined-github/fork
- Private: https://github.com/refined-github/private
- Private fork: https://github.com/refined-github/fork

*/



================================================
FILE: source/features/repo-wide-file-finder.tsx
================================================
import {elementExists} from 'select-dom';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import getDefaultBranch from '../github-helpers/get-default-branch.js';
import {buildRepoURL} from '../github-helpers/index.js';
import getCurrentGitRef from '../github-helpers/get-current-git-ref.js';
import {registerHotkey} from '../github-helpers/hotkey.js';
import {expectToken} from '../github-helpers/github-token.js';

async function init(signal: AbortSignal): Promise<void> {
	await expectToken();
	const ref = getCurrentGitRef() ?? await getDefaultBranch();
	const url = buildRepoURL('tree', ref) + '?search=1';
	registerHotkey('t', url, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isRepo,
	],
	exclude: [
		() => elementExists(['[data-hotkey="t"]', '[data-hotkey="t,Shift+T"]']),
		pageDetect.isEmptyRepo,
		pageDetect.isPRFiles,
		pageDetect.isFileFinder,
	],
	init,
});

/*

Test URLs:

https://github.com/refined-github/refined-github/actions

*/



================================================
FILE: source/features/restore-file.tsx
================================================
import React from 'dom-chef';
import {$, $optional} from 'select-dom/strict.js';
import delegate, {type DelegateEvent} from 'delegate-it';
import * as pageDetect from 'github-url-detection';
import {stringToBase64} from 'uint8array-extras';
import UndoIcon from 'octicons-plain-react/Undo';

import features from '../feature-manager.js';
import api from '../github-helpers/api.js';
import showToast from '../github-helpers/toast.js';
import {getBranches} from '../github-helpers/pr-branches.js';
import getPrInfo from '../github-helpers/get-pr-info.js';
import observe from '../helpers/selector-observer.js';
import {expectToken} from '../github-helpers/github-token.js';

// Track the currently focused file container for removal after discard
let focusedFileContainer: HTMLElement | undefined;

async function getMergeBaseReference(): Promise<string> {
	const {base, head} = getBranches();
	// This v3 response is relatively large, but it doesn't seem to be available on v4
	// Cache buster due to: https://github.com/refined-github/refined-github/issues/7312
	const response = await api.v3(`compare/${base.relative}...${head.relative}?cachebust=${Date.now()}`);
	return response.merge_base_commit.sha; // #4679
}

async function getHeadReference(): Promise<string> {
	const {base} = getBranches();
	const {headRefOid} = await getPrInfo(base.relative);
	return headRefOid;
}

async function getFile(filePath: string): Promise<string | undefined> {
	const ref = await getMergeBaseReference();
	const {textContent} = await api.v3(
		`contents/${filePath}?ref=${ref}`,
		{
			json: false,
			headers: {
				Accept: 'application/vnd.github.raw',
			},
		},
	);
	return textContent;
}

async function discardChanges(progress: (message: string) => void, originalFileName: string, newFileName: string, headline: string): Promise<void> {
	const [headReference, file] = await Promise.all([
		getHeadReference(),
		getFile(originalFileName),
	]);

	const isNewFile = !file;
	const isRenamed = originalFileName !== newFileName;

	const contents = file ? stringToBase64(file) : '';
	const deleteNewFile = {deletions: [{path: newFileName}]};
	const restoreOldFile = {additions: [{path: originalFileName, contents}]};
	const fileChanges = isRenamed
		? {...restoreOldFile, ...deleteNewFile} // Renamed, maybe also changed
		: isNewFile
			? deleteNewFile // New
			: restoreOldFile; // Changes

	const {nameWithOwner, branch: prBranch} = getBranches().head;
	progress('Committingâ€¦');

	await api.v4(`
		mutation discardChanges ($input: CreateCommitOnBranchInput!) {
			createCommitOnBranch(input: $input) {
				commit {
					oid
				}
			}
		}
	`, {
		variables: {
			input: {
				branch: {
					repositoryNameWithOwner: nameWithOwner,
					branchName: prBranch,
				},
				expectedHeadOid: headReference,
				fileChanges,
				message: {
					headline,
				},
			},
		},
	});
}

function getFilenames(menuItem: HTMLElement): {original: string; new: string} {
	// Legacy view: get filenames from the data-path and Link--primary elements
	if (menuItem.tagName === 'BUTTON') {
		const [originalFileName, newFileName = originalFileName] = menuItem
			.closest('[data-path]')!
			.querySelector('.Link--primary')!
			.textContent
			.split(' â†’ ');

		return {original: originalFileName, new: newFileName};
	}

	// New React view: get filenames from the file header
	const fileNameElement = $('[class^="DiffFileHeader-module__file-name"]', focusedFileContainer);
	const span = $optional('span:not(.sr-only)', fileNameElement);
	const [originalFileName, newFileName = originalFileName] = (span ?? fileNameElement)
		// eslint-disable-next-line unicorn/prefer-string-replace-all -- Invisible char
		.textContent.split('  ').map(text => text.replaceAll(/\u200E/g, ''));

	return {original: originalFileName, new: newFileName};
}

async function handleClick(event: DelegateEvent<MouseEvent, HTMLButtonElement>): Promise<void> {
	const menuItem = event.delegateTarget;
	const filenames = getFilenames(menuItem);

	const commitTitle = prompt(
		'Are you sure you want to discard these changes? Enter the commit title',
		`Discard changes to ${filenames.original}`,
	);

	if (!commitTitle) {
		return;
	}

	await showToast(async progress => discardChanges(progress, filenames.original, filenames.new, commitTitle), {
		message: 'Loading infoâ€¦',
		doneMessage: 'Changes discarded',
	});

	// Hide file from view
	if (menuItem.tagName === 'BUTTON') {
		menuItem.closest('.file')!.remove();
		return;
	}

	// New React view: remove the tracked file container and close the menu
	focusedFileContainer!.remove();
	menuItem.closest('div[data-focus-trap="active"]')!.remove();
}

// Legacy view handler
function addLegacyMenuItem(editFile: HTMLAnchorElement): void {
	editFile.after(
		<button
			className="pl-5 dropdown-item btn-link rgh-restore-file"
			role="menuitem"
			type="button"
		>
			Discard changes
		</button>,
	);
}

// New React view handler: track the file container and add menu item
function handleMenuOpening({delegateTarget}: DelegateEvent<MouseEvent, HTMLElement>): void {
	// Track the file container for later removal
	focusedFileContainer = delegateTarget.closest('div[id^="diff-"]')!;

	// Wait for the menu to be rendered
	requestAnimationFrame(() => {
		const editFile = $('[class^="prc-ActionList-ActionListItem"]:has(.octicon-pencil)');
		const discardItem = editFile.cloneNode(true);
		discardItem.classList.add('rgh-restore-file');
		$('a', discardItem).removeAttribute('href');
		$('[class^="prc-ActionList-ItemLabel"]', discardItem).textContent = 'Discard changes';
		$('[class^="prc-ActionList-LeadingVisual"]', discardItem).replaceChildren(<UndoIcon />);

		editFile.after(discardItem);
	});
}

async function init(signal: AbortSignal): Promise<void> {
	await expectToken();

	// Legacy view
	observe('.js-file-header-dropdown a[aria-label^="Change this"]', addLegacyMenuItem, {signal});

	// New React view
	delegate(
		'[class^="DiffFileHeader-module__diff-file-header"] button:has(>.octicon-kebab-horizontal)',
		'click',
		handleMenuOpening,
		{signal},
	);

	// `capture: true` required to be fired before GitHub's handlers
	delegate('.rgh-restore-file', 'click', handleClick, {capture: true, signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isPRFiles,
	],
	init,
});

/*

Test URLs:

https://github.com/refined-github/sandbox/pull/16/files
https://github.com/refined-github/sandbox/pull/29/files

*/



================================================
FILE: source/features/rgh-deduplicator.tsx
================================================
import React from 'dom-chef';
import {$optional} from 'select-dom/strict.js';

import {_} from '../helpers/hotfix.js';
import features from '../feature-manager.js';

/*
When navigating back and forth in history, GitHub will preserve the DOM changes;
This means that the old features will still be on the page and don't need to re-run.

This marks each as "processed"
*/
void features.add('rgh-deduplicator' as FeatureID, {
	awaitDomReady: true,
	async init() {
		// `await` kicks it to the next tick, after the other features have checked for 'has-rgh', so they can run once.
		await Promise.resolve();
		$optional('has-rgh')?.remove(); // https://github.com/refined-github/refined-github/issues/6568
		$optional(_`#js-repo-pjax-container, #js-pjax-container`)?.append(<has-rgh />);
		$optional(_`turbo-frame`)?.append(<has-rgh-inner />); // #4567
	},
});

/* Test URLs: all */



================================================
FILE: source/features/rgh-dim-commits.tsx
================================================
import * as pageDetect from 'github-url-detection';

import {isRefinedGitHubRepo} from '../github-helpers/index.js';
import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';
import {commitTitleInLists} from '../github-helpers/selectors.js';

// Source: https://github.com/fregante/release-with-changelog/blob/779fd5e658f82e5b11b1c0a352a6838d3bd8f67f/generate-release-notes.js#L6
const excludePreset = /^bump |^meta|^document|^lint|^refactor|readme|dependencies|^v?\d+\.\d+\.\d+/i;

function dim(commitTitle: HTMLElement): void {
	if (excludePreset.test(commitTitle.textContent.trim())) {
		commitTitle.closest('[data-testid="commit-row-item"]')!.style.opacity = '50%';
	}
}

function init(signal: AbortSignal): void {
	observe(commitTitleInLists, dim, {signal});
}

void features.add(import.meta.url, {
	asLongAs: [
		isRefinedGitHubRepo,
	],
	include: [
		pageDetect.isCommitList,
	],
	init,
});

/*

Test URLs:

https://github.com/refined-github/refined-github/commits/98fb24e53704b436d68f254429885fb7bef09541/source/features/bypass-checks.tsx

*/



================================================
FILE: source/features/rgh-feature-descriptions.css
================================================
.rgh-feature-description {
	flex-basis: 300px !important;
	flex-grow: 1;

	code,
	kbd {
		font-size: 0.8em;
		line-height: 0.8;
	}
}



================================================
FILE: source/features/rgh-feature-descriptions.tsx
================================================
import './rgh-feature-descriptions.css';

import React from 'dom-chef';
import AlertIcon from 'octicons-plain-react/Alert';
import CopyIcon from 'octicons-plain-react/Copy';
import InfoIcon from 'octicons-plain-react/Info';

import features from '../feature-manager.js';
import optionsStorage, {isFeatureDisabled} from '../options-storage.js';
import {featuresMeta, getNewFeatureName, getOldFeatureNames} from '../feature-data.js';
import observe from '../helpers/selector-observer.js';
import {brokenFeatures} from '../helpers/hotfix.js';
import {createRghIssueLink} from '../helpers/rgh-links.js';
import openOptions from '../helpers/open-options.js';
import createBanner from '../github-helpers/banner.js';
import {isFeaturePrivate} from '../helpers/feature-utils.js';

function addDescription(infoBanner: HTMLElement, id: string, meta: FeatureMeta | undefined): void {
	const isCss = location.pathname.endsWith('.css');

	const description = meta?.description // Regular feature?
		?? (
			isFeaturePrivate(id)
				? 'This feature applies only to "Refined GitHub" repositories and cannot be disabled.'
				: isCss
					? 'This feature is CSS-only and cannot be disabled.'
					: undefined // The heck!?
		);

	const conversationsUrl = new URL('https://github.com/refined-github/refined-github/issues');
	const oldNames = getOldFeatureNames(id);
	const searchTerms = [id, ...oldNames].map(name => `"${name}"`).join(' OR ');
	conversationsUrl.searchParams.set('q', `sort:updated-desc is:open (${searchTerms})`);

	const newIssueUrl = new URL('https://github.com/refined-github/refined-github/issues/new');
	newIssueUrl.searchParams.set('template', '1_bug_report.yml');
	newIssueUrl.searchParams.set('title', `\`${id}\`: `);
	newIssueUrl.searchParams.set('labels', 'bug, help wanted');

	infoBanner.before(
		// Block and width classes required to avoid margin collapse
		<div className="Box mb-3 d-inline-block width-full">
			<div className="Box-row d-flex gap-3 flex-wrap">
				<div className="rgh-feature-description d-flex flex-column gap-2">
					<h3>
						<code>{id}</code>
						<clipboard-copy
							aria-label="Copy"
							data-copy-feedback="Copied!"
							value={id}
							class="Link--onHover color-fg-muted d-inline-block ml-2"
							tabindex="0"
							role="button"
						>
							<CopyIcon className="v-align-baseline" />
						</clipboard-copy>
					</h3>
					{oldNames.length > 0 && (
						<div className="color-fg-muted mt-n3">
							<span className="text-small">previously named </span>
							{oldNames.map((name, index) => (
								<React.Fragment key={name}>
									{index > 0 && ', '}
									<code>{name}</code>
								</React.Fragment>
							))}
						</div>
					)}
					{description && <div dangerouslySetInnerHTML={{__html: description}} className="h3" />}
					<div className="no-wrap">
						<a href={conversationsUrl.href} data-turbo-frame="repo-content-turbo-frame">Related issues</a>
						{' â€¢ '}
						<a href={newIssueUrl.href} data-turbo-frame="repo-content-turbo-frame">Report bug</a>
						{
							meta && isCss
								? <> â€¢ <a data-turbo-frame="repo-content-turbo-frame" href={location.pathname.replace('.css', '.tsx')}>See .tsx file</a></>
								: meta?.css
									? <> â€¢ <a data-turbo-frame="repo-content-turbo-frame" href={location.pathname.replace('.tsx', '.css')}>See .css file</a></>
									: undefined
						}
					</div>
				</div>
				{meta?.screenshot && (
					<a href={meta.screenshot} className="flex-self-center">
						<img
							src={meta.screenshot}
							className="d-block border"
							style={{
								maxHeight: 100,
								maxWidth: 150,
							}}
						/>
					</a>
				)}
			</div>
		</div>,
	);
}

async function getDisabledReason(id: string): Promise<JSX.Element | undefined> {
	// Block and width classes required to avoid margin collapse
	const classes = ['mb-3', 'd-inline-block', 'width-full'];
	// Skip dev check present in `getLocalHotfixes`, we want to see this even when developing
	const hotfixes = await brokenFeatures.get() ?? [];
	const hotfixed = hotfixes.find(([feature]) => feature === id);
	if (hotfixed) {
		const [_name, issue, unaffectedVersion] = hotfixed;

		if (unaffectedVersion) {
			return createBanner({
				text: <>This feature was disabled until version {unaffectedVersion} due to {createRghIssueLink(issue)}.</>,
				classes,
				icon: <InfoIcon className="mr-0" />,
			});
		}

		return createBanner({
			text: <>This feature is disabled due to {createRghIssueLink(issue)}.</>,
			classes: [...classes, 'flash-warn'],
			icon: <AlertIcon className="mr-0" />,
		});
	}

	if (isFeatureDisabled(await optionsStorage.getAll(), id)) {
		return createBanner({
			text: 'You disabled this feature on GitHub.com.',
			classes: [...classes, 'flash-warn'],
			icon: <AlertIcon className="mr-0" />,
			action: openOptions,
			buttonLabel: 'Refined GitHub Options',
		});
	}

	return undefined;
}

async function addDisabledBanner(infoBanner: HTMLElement, id: string): Promise<void> {
	const reason = await getDisabledReason(id);
	if (reason) {
		infoBanner.before(reason);
	}
}

async function add(infoBanner: HTMLElement): Promise<void> {
	const [, filename] = /source\/features\/([^.]+)/.exec(location.pathname) ?? [];
	// Enable link even on past commits
	const currentFeatureName = getNewFeatureName(filename);
	const meta = featuresMeta.find(feature => feature.id === currentFeatureName);

	// This ID exists whether the feature is documented or not
	const id = meta?.id ?? filename;

	addDescription(infoBanner, id, meta);
	await addDisabledBanner(infoBanner, id);
}

function init(signal: AbortSignal): void {
	observe('#repos-sticky-header', add, {signal});
}

const featureUrlRegex = /^(?:[/]refined-github){2}[/]blob[/][^/]+[/]source[/]features[/][^.]+[.](?:tsx|css)$/;

void features.add(import.meta.url, {
	include: [
		() => featureUrlRegex.test(location.pathname),
	],
	init,
});

/*

Test URLs:

- Regular feature: https://github.com/refined-github/refined-github/blob/main/source/features/sync-pr-commit-title.tsx
- CSS counterpart: https://github.com/refined-github/refined-github/blob/main/source/features/sync-pr-commit-title.css
- RGH feature: https://github.com/refined-github/refined-github/blob/main/source/features/rgh-feature-descriptions.css
- CSS-only feature: https://github.com/refined-github/refined-github/blob/main/source/features/center-reactions-popup.css
*/



================================================
FILE: source/features/rgh-improve-new-issue-form.tsx
================================================
import React from 'dom-chef';
import {$} from 'select-dom/strict.js';
import delegate, {type DelegateEvent} from 'delegate-it';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import {OptionsLink} from '../helpers/open-options.js';
import clearCacheHandler from '../helpers/clear-cache-handler.js';
import {baseApiFetch} from '../github-helpers/github-token.js';
import {getToken} from '../options-storage.js';
import {isRefinedGitHubRepo} from '../github-helpers/index.js';
import {getElementByAriaLabelledBy} from '../helpers/dom-utils.js';
import observe from '../helpers/selector-observer.js';

const isSetTheTokenSelector = 'input[type="checkbox"][required]';
const liesGif = 'https://github.com/user-attachments/assets/f417264f-f230-4156-b020-16e4390562bd';

function addNotice(adjective: JSX.Element | string): void {
	$('[class^="IssueFormElements-module__formElementsContainer"]').prepend(
		<div className="flash flash-error h3 my-9" style={{animation: 'pulse-in 0.3s 2'}}>
			<p>
				Your token is {adjective}. Many Refined GitHub features don't work without it.
				You can update it <OptionsLink className="btn-link">in the options</OptionsLink>.
			</p>
			<p>Before creating this issue, add a valid token and confirm the problem still occurs.</p>
		</div>,
	);
}

async function checkToken(): Promise<void> {
	const token = await getToken();
	if (!token) {
		addNotice('missing');
		return;
	}

	try {
		await baseApiFetch({apiBase: 'https://api.github.com/', path: 'user', token});
	} catch (error) {
		if (!navigator.onLine || (error as any)?.message === 'Failed to fetch') {
			return;
		}

		addNotice('invalid or expired');
		return;
	}

	// Thank you for following the instructions. I'll save you a click.
	$(isSetTheTokenSelector).checked = true;
}

// https://stackoverflow.com/a/46012210
const nativeInputValueSetter = Object.getOwnPropertyDescriptor(globalThis.HTMLInputElement.prototype, 'value')!.set!;
function setReactInputValue(target: HTMLInputElement, value: string): void {
	nativeInputValueSetter.call(target, value);
	target.dispatchEvent(new Event('input', {bubbles: true}));
}

async function setVersion(): Promise<void> {
	const {version} = chrome.runtime.getManifest();
	const field = getElementByAriaLabelledBy<HTMLInputElement>(
		'[class^="IssueCreatePage"] [class^="Box-sc"] input',
		'Extension version*',
	);

	setReactInputValue(field, version);
	if (!await getToken()) {
		// Mark the submission as not having a token set up because people have a tendency to go through forms and read absolutely nothing. This makes it easier to spot liars.
		setReactInputValue(field, '(' + version + ')');
		field.disabled = true;
	}
}

async function linkifyCacheRefresh(): Promise<void> {
	$('[href="#clear-cache"]').replaceWith(
		<button
			className="btn"
			type="button"
			onClick={clearCacheHandler}
		>
			Clear cache
		</button>,
	);
}

function Lies(): JSX.Element {
	return (
		<a href="https://www.youtube.com/watch?v=YWdD206eSv0">
			<img src={liesGif} alt="Just go on the internet and tell lies?" className="d-inline-block" />
		</a>
	);
}

async function lieDetector({delegateTarget}: DelegateEvent<MouseEvent, HTMLInputElement>): Promise<void> {
	if (delegateTarget.checked) {
		delegateTarget.closest('fieldset')!.append(<Lies />);
	}
}

async function validateTokenCheckbox(): Promise<void> {
	if (await getToken()) {
		return;
	}

	// eslint-disable-next-line new-cap -- Preload image
	Lies();

	delegate(isSetTheTokenSelector, 'click', lieDetector, {
		once: true,
	});
}

function init(signal: AbortSignal): void {
	observe('[class^="CreateIssueForm-module__mainContentSection"]', () => {
		void linkifyCacheRefresh();
		void checkToken();
		void validateTokenCheckbox();
		void setVersion();
	}, {signal});
}

void features.add(import.meta.url, {
	asLongAs: [
		isRefinedGitHubRepo,
		pageDetect.isNewIssue,
		() => new URL(location.href).searchParams.get('template') === '1_bug_report.yml',
	],
	init,
});

/*

Test URLs:

https://github.com/refined-github/refined-github/issues/new?assignees=&labels=bug&projects=&template=1_bug_report.yml

*/



================================================
FILE: source/features/rgh-linkify-features.tsx
================================================
import React from 'dom-chef';
import * as pageDetect from 'github-url-detection';

import {wrap} from '../helpers/dom-utils.js';
import features from '../feature-manager.js';
import {getFeatureUrl} from '../helpers/rgh-links.js';
import {getNewFeatureName} from '../feature-data.js';
import {isAnyRefinedGitHubRepo} from '../github-helpers/index.js';
import observe from '../helpers/selector-observer.js';
import {commitTitleInLists} from '../github-helpers/selectors.js';

function linkifyFeature(possibleFeature: HTMLElement): void {
	const originalText = possibleFeature.textContent;
	const id = getNewFeatureName(originalText);
	if (!id) {
		return;
	}

	const href = getFeatureUrl(id);
	// If the original text is different from the resolved ID, it's an old name
	const isOldName = originalText !== id;
	const title = isOldName ? `Now called ${id}` : undefined;

	const possibleLink = possibleFeature.firstElementChild ?? possibleFeature;
	if (possibleLink instanceof HTMLAnchorElement) {
		// Possible DOM structure:
		// - <a>
		// - <code> > <a>
		possibleLink.href = href;
		possibleLink.classList.add('color-fg-accent');
		if (title) {
			possibleLink.title = title;
		}
	} else if (!possibleFeature.closest('a')) {
		// Possible DOM structure:
		// - <code>
		wrap(
			possibleFeature,
			<a
				className="color-fg-accent"
				data-turbo-frame="repo-content-turbo-frame"
				href={href}
				title={title}
			/>,
		);
	}
}

function init(signal: AbortSignal): void {
	observe([
		'.js-issue-title code', // `isPR`, Old view `isIssue`
		'[data-testid="issue-title"] code', // `isIssue`
		'.js-comment-body code', // Old view `hasComments`
		'.markdown-body code', // `hasComments`, `isReleasesOrTags`
		'[class^="CommitHeader-module__commitMessageContainer"] code', // `isSingleCommit`,
		`${commitTitleInLists} code`, // `isCommitList`,
		'.react-directory-commit-message code', // `isRepoTree`
	], linkifyFeature, {signal});
}

void features.add(import.meta.url, {
	asLongAs: [
		isAnyRefinedGitHubRepo,
	],
	include: [
		pageDetect.hasComments,
		pageDetect.isReleasesOrTags,
		pageDetect.isSingleReleaseOrTag,
		pageDetect.isCommitList,
		pageDetect.isSingleCommit,
		pageDetect.isRepoWiki,
		pageDetect.isPR,
		pageDetect.isIssue,
		pageDetect.isRepoTree,
	],
	init,
});

/*

Test URLs

- hasComments: https://github.com/refined-github/refined-github/issues/8867
- isReleasesOrTags: https://github.com/refined-github/refined-github/releases
- isSingleReleaseOrTag: https://github.com/refined-github/refined-github/releases/tag/23.7.25
- isCommitList: https://github.com/refined-github/refined-github/commits/main
- isSingleCommit: https://github.com/refined-github/refined-github/commit/d63e2d97fc4d85f986a120fb49cd8e09f6785b93
- isRepoWiki: https://github.com/refined-github/refined-github/wiki/Extended-feature-descriptions
- isPR: https://github.com/refined-github/refined-github/pull/8904
- isIssue: https://github.com/refined-github/refined-github/issues/8902

*/



================================================
FILE: source/features/rgh-linkify-yolo.tsx
================================================
import React from 'dom-chef';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import {isRefinedGitHubYoloRepo} from '../github-helpers/index.js';
import observe from '../helpers/selector-observer.js';
import {createRghIssueLink, getFeatureUrl} from '../helpers/rgh-links.js';

function linkifyIssue(issueCell: HTMLElement): void {
	// Linkify with hovercards
	issueCell.replaceChildren(createRghIssueLink(issueCell.textContent));
}

function linkifyFeature(issueCell: HTMLElement): void {
	const url = getFeatureUrl(issueCell.textContent as FeatureID);
	issueCell.replaceChildren(
		<code>
			<a className="d-inline-block" href={url}>
				{issueCell.firstChild}
			</a>
		</code>,
	);
}

function init(signal: AbortSignal): void {
	// .js-csv-data is the old selector
	observe(':is(.js-csv-data, .react-csv-row) td:nth-child(2)', linkifyFeature, {signal});
	observe(':is(.js-csv-data, .react-csv-row) td:nth-child(3)', linkifyIssue, {signal});
}

void features.add(import.meta.url, {
	asLongAs: [
		isRefinedGitHubYoloRepo,
		pageDetect.isSingleFile,
		() => location.pathname.endsWith('broken-features.csv'),
	],
	init,
});

/*

Test URLs:

https://github.com/refined-github/yolo/blob/main/broken-features.csv

*/



================================================
FILE: source/features/rgh-netiquette.tsx
================================================
import React from 'dom-chef';
import InfoIcon from 'octicons-plain-react/Info';
import * as pageDetect from 'github-url-detection';

import createBanner from '../github-helpers/banner.js';
import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';
import {isAnyRefinedGitHubRepo} from '../github-helpers/index.js';
import {getCloseDate, getResolvedText, wasLongAgo} from './netiquette.js';
import TimelineItem from '../github-helpers/timeline-item.js';

async function addConversationBanner(newCommentBox: HTMLElement): Promise<void> {
	// Check inside the observer because React views load after dom-ready
	const closingDate = await getCloseDate();
	if (!closingDate || !wasLongAgo(closingDate)) {
		features.unload(import.meta.url);
		return;
	}

	const button = (
		<button
			type="button"
			className="btn-link"
			onClick={() => {
				newCommentBox.hidden = false;

				// Unlink this button
				button.replaceWith(button.firstChild!);

				// Keep the banner, make it visible

				banner.firstElementChild!.classList.replace('rgh-bg-none', 'flash-error');

				window.scrollBy({
					top: 100,
					behavior: 'smooth',
				});
			}}
		>comment
		</button>
	);

	const banner = (
		<TimelineItem>
			{createBanner({
				classes: ['rgh-bg-none'],
				icon: <InfoIcon className="mr-1" />,
				text: <>{getResolvedText(closingDate)} If you want to say something helpful, you can leave a {button}. <strong>Do not</strong> report issues here.</>,
			})}
		</TimelineItem>
	);
	newCommentBox.before(banner);
	newCommentBox.hidden = true;
}

function init(signal: AbortSignal): void | false {
	observe([
		'#issuecomment-new:has(file-attachment)',
		'[data-testid="comment-composer"]',
	], addConversationBanner, {signal});
}

void features.add(import.meta.url, {
	asLongAs: [
		isAnyRefinedGitHubRepo,
	],
	include: [
		pageDetect.isConversation,
	],
	awaitDomReady: true, // We're specifically looking for the last event
	init,
});

/*

Test URLs

- Old issue: https://github.com/refined-github/refined-github/issues/3076
- Old PR: https://github.com/refined-github/refined-github/pull/159

*/



================================================
FILE: source/features/rgh-options-link.tsx
================================================
/* You can have invisible/inactive links to the options page on the wiki. This feature enables them. */
/* Use this HTML in a markdown document: <a name="options-page-link">options page</a> */
import delegate from 'delegate-it';

import features from '../feature-manager.js';
import openOptions from '../helpers/open-options.js';
import observe from '../helpers/selector-observer.js';
import {isRefinedGitHubRepo} from '../github-helpers/index.js';

const placeholdersSelector = 'a[name="user-content-options-page-link"]';

function linkify(anchor: HTMLAnchorElement): void {
	// This makes the anchor visible and clickable
	anchor.href = '#refined-github-options';
}

function init(signal: AbortSignal): void {
	observe(placeholdersSelector, linkify, {signal});
	delegate(placeholdersSelector, 'click', openOptions, {signal});
}

void features.add(import.meta.url, {
	include: [
		isRefinedGitHubRepo,
	],
	init,
});

/*

Test URLs:

https://github.com/refined-github/refined-github/wiki

*/



================================================
FILE: source/features/rgh-pr-template.tsx
================================================
import React from 'dom-chef';
import {replaceFieldText} from 'text-field-edit';
import * as pageDetect from 'github-url-detection';
import {linkifyUrlsToDom} from 'linkify-urls';
import shortenRepoUrl from 'shorten-repo-url';

import features from '../feature-manager.js';
import {isRefinedGitHubRepo} from '../github-helpers/index.js';
import observe from '../helpers/selector-observer.js';

function extract(textarea: HTMLTextAreaElement): void {
	replaceFieldText(textarea, /<!--(.+)-->\n/s, (_, match) => {
		textarea.closest('tab-container')!.before(
			<div style={{whiteSpace: 'pre-wrap'}} className="flash mb-3 p-3">
				{linkifyUrlsToDom(match.trim(), {value: url => shortenRepoUrl(url, location.href)})}
			</div>,
		);

		return '';
	});
}

function init(signal: AbortSignal): void {
	observe('#pull_request_body', extract, {signal});
}

void features.add(import.meta.url, {
	asLongAs: [
		isRefinedGitHubRepo,
		pageDetect.isCompare,
	],
	init,
});

/*

Test URLs:

https://github.com/refined-github/refined-github/compare/main...sandbox/keep-branch?quick_pull=1

*/



================================================
FILE: source/features/rgh-token-user.tsx
================================================
import React from 'react';
import AlertIcon from 'octicons-plain-react/Alert';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';
import {getLoggedInUser} from '../github-helpers/index.js';
import {getToken} from '../options-storage.js';
import {tokenUser} from '../github-helpers/github-token.js';
import {api3} from '../github-helpers/api.js';
import onetime from '../helpers/onetime.js';
import {OptionsLink} from '../helpers/open-options.js';

async function verify(header: HTMLButtonElement): Promise<void> {
	const token = await getToken();
	if (!token) {
		return;
	}

	const currentWebUser = getLoggedInUser();
	const currentTokenUser = await tokenUser.get(api3, token);
	if (currentWebUser !== currentTokenUser) {
		header.after(
			// Use raw "flash" classes to blend in better with the dropdown menu
			<div className="flash px-3 mt-3 mb-0 py-2 d-flex flex-items-center border-0 rounded-0">
				<AlertIcon className="mr-2" />
				<span>Your <OptionsLink className="btn-link">Refined GitHub token</OptionsLink> is for a different user, the extension will act on behalf of <code>{currentTokenUser}</code></span>
			</div>,
		);
	}
}

function initOnce(): void {
	observe('[aria-label="User navigation"][role="heading"]', verify);
}

void features.add(import.meta.url, {
	init: onetime(initOnce),
});

/*

Test URL: anywhere

*/



================================================
FILE: source/features/safer-destructive-actions.css
================================================
/* Move "close issue" and "cancel" buttons on authoring comments to the left */

/* ...in issue comment form */
#issuecomment-new #partial-new-comment-form-actions > .d-flex,
/* ...in comment edit form */
div.previewable-edit .d-flex:has(> .js-comment-cancel-button) {
	justify-content: space-between !important;
	width: 100%; /* https://github.com/refined-github/refined-github/issues/7711 */
}

/* ...in PR review form */
button.js-hide-inline-comment-form,
/* ... in PR review add comment form */
	.float-right:has(> button.js-hide-inline-comment-form) {
	float: none !important;
}

/* ...in the merge confirmation form */
.commit-form-actions .select-menu {
	display: block !important;
}

.commit-form-actions button:not(.js-merge-commit-button) {
	float: right;
}

/*

Test URLs:

https://github.com/refined-github/sandbox/pull/4

- Regular comments
- Review comments

*/



================================================
FILE: source/features/same-branch-author-commits.tsx
================================================
import {$$} from 'select-dom';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';

const authorLinkSelector = 'a[aria-label^="commits by"]';

function init(): void {
	for (const author of $$(authorLinkSelector)) {
		author.pathname = location.pathname;
	}
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isRepoCommitList,
	],
	awaitDomReady: true, // Small page
	init,
});

/*

Test URLs:

https://github.com/refined-github/sandbox/commits/branch/with/slashes/
https://github.com/refined-github/sandbox/commits/new/.github

*/



================================================
FILE: source/features/same-page-links.tsx
================================================
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';

function fix(button: HTMLAnchorElement): void {
	button.removeAttribute('target');
}

function init(signal: AbortSignal): void {
	observe([
		'[data-testid="state-reason-link"] + [target="_blank"]', // "Closing issue" link
		'[data-testid="issue-metadata-fixed"] [target="_blank"]', // Reference PR link in issue header
		'[data-testid^="timeline-row-border"] [target="_blank"]', // Commit linkbacks in PRs
	], fix, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isIssue,
	],
	init,
});

/*

Test URLs

- "Closing issue" link https://github.com/refined-github/refined-github/issues/8346#event-16947543136
- "Reference PR link" https://github.com/refined-github/refined-github/pull/8367
- "Commit Linkbacks" https://github.com/sindresorhus/np/issues/82#event-22200037448, https://github.com/cli/cli/issues/10238
*/



================================================
FILE: source/features/scrollable-areas.css
================================================
html:not([rgh-OFF-scrollable-areas]) {
	/* Note: Don't add support for commit view dropdown comments #8100 */
	.comment-body,
	[data-testid='markdown-body'] {
		blockquote,
		pre {
			position: relative; /* OctoLinker compat: attach the purple balls to the scroll */
			max-height: 30.5em;
			overflow-y: auto;
		}

		/* A tiny scroll bar appears when the last paragraph contains a `code` or `g-emoji` tag #3012 #4597 */
		blockquote {
			padding-bottom: 0.2em; /* Do not add to `pre` #5540 */
		}

		:is(details, blockquote) :is(blockquote, pre) {
			max-height: none;
		}
	}
}



================================================
FILE: source/features/scrollable-areas.tsx
================================================
import './scrollable-areas.css';

import features from '../feature-manager.js';

void features.addCssFeature(import.meta.url);

/*

Test URLs:

https://github.com/refined-github/refined-github/pull/1146#issuecomment-377296024

*/



================================================
FILE: source/features/select-all-notifications-shortcut.tsx
================================================
import {$} from 'select-dom/strict.js';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import {registerHotkey} from '../github-helpers/hotkey.js';

function selectAllNotifications(): void {
	$('.js-notifications-mark-all-prompt').click();
}

function init(signal: AbortSignal): void {
	registerHotkey('a', selectAllNotifications, {signal});
}

void features.add(import.meta.url, {
	shortcuts: {
		a: 'Select all notifications',
	},
	include: [
		pageDetect.isNotifications,
	],
	init,
});

/*

Test URLs:

https://github.com/notifications (Grouped by date)
https://github.com/notifications (Grouped by repo)

*/



================================================
FILE: source/features/select-notifications.css
================================================
/* Only when the menu is shown as a dropdown, not as a modal (mobile) #5796 */
/* The media query matches the native one exactly, inverted via `not` */
@media screen and not (width <= 543px) {
	.js-notifications-mark-selected-actions > *,
	.rgh-open-selected-button {
		/* Allow clicking on "Done" and other toolbar buttons even when the dropdown (z-index of 99) is open #4753 */
		z-index: 100;
	}
}



================================================
FILE: source/features/select-notifications.tsx
================================================
import './select-notifications.css';

import React from 'dom-chef';
import {elementExists} from 'select-dom';
import {$, $$} from 'select-dom/strict.js';
import delegate from 'delegate-it';
import * as pageDetect from 'github-url-detection';
import CheckCircleIcon from 'octicons-plain-react/CheckCircle';
import CheckIcon from 'octicons-plain-react/Check';
import DotFillIcon from 'octicons-plain-react/DotFill';
import DotIcon from 'octicons-plain-react/Dot';
import GitMergeIcon from 'octicons-plain-react/GitMerge';
import GitPullRequestDraftIcon from 'octicons-plain-react/GitPullRequestDraft';
import GitPullRequestIcon from 'octicons-plain-react/GitPullRequest';
import HubotIcon from 'octicons-plain-react/Hubot';
import IssueOpenedIcon from 'octicons-plain-react/IssueOpened';
import SquirrelIcon from 'octicons-plain-react/Squirrel';
import XCircleIcon from 'octicons-plain-react/XCircle';

import onetime from '../helpers/onetime.js';
import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';
import {botLinksNotificationSelectors} from '../github-helpers/selectors.js';

const prIcons = ':is(.octicon-git-pull-request, .octicon-git-pull-request-closed, .octicon-git-pull-request-draft, .octicon-git-merge)';
const issueIcons = ':is(.octicon-issue-opened, .octicon-issue-closed, .octicon-skip)';
const filters = {
	'Pull requests': prIcons,
	Issues: issueIcons,
	// This selector is a bit too loose, so it needs to be scoped to the smallest possible element and exclude the bookmark icon
	Others: `.notification-list-item-link .octicon:not(${prIcons}, ${issueIcons}, .octicon-bookmark)`,
	Bots: botLinksNotificationSelectors.join(', '),
	Open: ':is(.octicon-issue-opened, .octicon-git-pull-request)',
	Closed: ':is(.octicon-issue-closed, .octicon-git-pull-request-closed, .octicon-skip)',
	Draft: '.octicon-git-pull-request-draft',
	Merged: '.octicon-git-merge',
	Read: '.notification-read *',
	Unread: '.notification-unread *',
} as const;

type Filter = keyof typeof filters;
type Category = 'Type' | 'Status' | 'Read';

function resetFilters({target}: React.SyntheticEvent): void {
	$('form#rgh-select-notifications-form').reset();
	for (const label of $$('label', target as Element)) {
		label.setAttribute('aria-checked', 'false');
	}
}

function getFiltersSelector(formData: FormData, category: Category): string[] {
	return formData.getAll(category).map(value => filters[value as Filter]);
}

function handleSelection(): void {
	// @ts-expect-error TS bug
	const formData = new FormData($('form#rgh-select-notifications-form'));
	const types = getFiltersSelector(formData, 'Type');
	const statuses = getFiltersSelector(formData, 'Status');
	const readStatus = getFiltersSelector(formData, 'Read');
	const selectorGroups = [types, statuses, readStatus].filter(selectors => selectors.length > 0);
	const deselectAll = selectorGroups.length === 0;

	const notifications = $$('.notifications-list-item');
	let input: HTMLInputElement;
	for (const notification of notifications) {
		input = $('input.js-notification-bulk-action-check-item', notification);
		// Updating the "checked" property does not raise any events
		input.checked = !deselectAll && selectorGroups.every(selectors => elementExists(selectors, notification));
	}

	// Trigger the selection action bar update
	// @ts-expect-error input will be assigned in the loop above
	input.dispatchEvent(new Event('change', {bubbles: true}));
}

function createDropdownList(category: Category, filters: Filter[]): JSX.Element {
	const icons: Record<Filter, JSX.Element> = {
		'Pull requests': <GitPullRequestIcon className="color-fg-muted" />,
		Issues: <IssueOpenedIcon className="color-fg-muted" />,
		Open: <CheckCircleIcon className="color-fg-success" />,
		Others: <SquirrelIcon className="color-fg-muted" />,
		Bots: <HubotIcon className="color-fg-muted" />,
		Closed: <XCircleIcon className="color-fg-danger" />,
		Draft: <GitPullRequestDraftIcon className="color-fg-subtle" />,
		Merged: <GitMergeIcon className="color-fg-done" />,
		Read: <DotIcon className="color-fg-accent" />,
		Unread: <DotFillIcon className="color-fg-accent" />,
	};

	return (
		<div className="SelectMenu-list">
			<header className="SelectMenu-header">
				<span className="SelectMenu-title">{category}</span>
			</header>
			{filters.map(filter => (
				<label
					className="SelectMenu-item text-normal"
					role="menuitemcheckbox"
					aria-checked="false"
					tabIndex={0}
				>
					<CheckIcon className="octicon octicon-check SelectMenu-icon SelectMenu-icon--check mr-2" aria-hidden="true" />
					<div className="SelectMenu-item-text">
						<input
							hidden
							type="checkbox"
							name={category}
							value={filter}
						/>
						{icons[filter]}
						<span className="ml-2">{filter}</span>
					</div>
				</label>
			))}
		</div>
	);
}

const createDropdown = onetime(() => (
	<details
		className="details-reset details-overlay position-relative rgh-select-notifications mr-2"
		onToggle={resetFilters}
	>
		<summary
			className="h6" // `h6` matches "Select all" style
			data-hotkey="Shift+S"
			aria-haspopup="menu"
			// Don't use tooltipped, it remains visible when the dropdown is open
			title="Hotkey: Shift+S"
			role="button"
		>
			Select by <span className="dropdown-caret ml-1" />
		</summary>
		<details-menu
			className="SelectMenu left-0"
			aria-label="Select by"
			role="menu"
			on-details-menu-selected={handleSelection}
		>
			<div className="SelectMenu-modal">
				<form id="rgh-select-notifications-form">
					{createDropdownList('Type', ['Pull requests', 'Issues', 'Others', 'Bots'])}
					{createDropdownList('Status', ['Open', 'Closed', 'Merged', 'Draft'])}
					{createDropdownList('Read', ['Read', 'Unread'])}
				</form>
			</div>
		</details-menu>
	</details>
));

function closeDropdown(): void {
	$('.rgh-select-notifications').removeAttribute('open');
}

function addDropdown(selectAllCheckbox: HTMLInputElement): void {
	selectAllCheckbox.style.verticalAlign = '-0.2em'; // #7852
	selectAllCheckbox.closest('label')!.after(
		// `h6` matches "Select all" style
		<span className="mx-2 h6">Â·</span>,
		createDropdown(),
	);
}

function init(signal: AbortSignal): void {
	observe('input.js-notifications-mark-all-prompt', addDropdown, {signal});

	// Close the dropdown when one of the toolbar buttons is clicked
	delegate(['.js-notifications-mark-selected-actions > *', '.rgh-open-selected-button'], 'click', closeDropdown, {signal});
}

void features.add(import.meta.url, {
	shortcuts: {
		'shift s': 'Open the "Select by" dropdown',
	},
	include: [
		pageDetect.isNotifications,
	],
	init,
});

/*

Test URLs:

https://github.com/notifications (Grouped by date)
https://github.com/notifications (Grouped by repo)
https://github.com/notifications?query=reason%3Acomment (which is an unsaved filter)

*/



================================================
FILE: source/features/selection-in-new-tab.tsx
================================================
import {$optional} from 'select-dom/strict.js';
import {messageRuntime} from 'webext-msg';

import onetime from '../helpers/onetime.js';
import features from '../feature-manager.js';
import {registerHotkey} from '../github-helpers/hotkey.js';

function openInNewTab(): void {
	const selected = $optional([
		'.navigation-focus a.js-navigation-open[href]', // Old view - TODO: Drop after June 2025
		'[data-focus-visible-added] .markdown-title a',
	]);

	if (!selected) {
		return;
	}

	void messageRuntime({
		openUrls: [selected.href],
	});

	// Get the list element that contains the unread class and mark it as read.
	selected.closest('.unread')?.classList.replace('unread', 'read');
}

function initOnce(): void {
	registerHotkey('Shift+O', openInNewTab);
}

void features.add(import.meta.url, {
	shortcuts: {
		'shift o': 'Open selection in new tab',
	},
	init: onetime(initOnce),
});

/*

Test URLs:

https://github.com/notifications
https://github.com/refined-github/refined-github
https://github.com/refined-github/refined-github/issues

*/



================================================
FILE: source/features/shorten-links.tsx
================================================
import onetime from '../helpers/onetime.js';
import features from '../feature-manager.js';
import {linkifiedURLClass, shortenLink} from '../github-helpers/dom-formatters.js';
import observe from '../helpers/selector-observer.js';

/* This feature is currently so broad that it's not de-inited via signal, it's just run once for all pageloads #5889 */
function initOnce(): void {
	observe([
		`.comment-body a[href]:not(.${linkifiedURLClass})`,
		`.react-issue-comment .markdown-body a[href]:not(.${linkifiedURLClass})`, // Issue comments
		`.react-issue-body .markdown-body a[href]:not(.${linkifiedURLClass})`, // First issue comment
		`[data-testid="review-thread"] .markdown-body a[href]:not(.${linkifiedURLClass})`, // React commit view
	], shortenLink);
}

void features.add(import.meta.url, {
	init: onetime(initOnce),
});

/*
## Test URLs

https://github.com/refined-github/sandbox/pull/14
https://github.com/refined-github/refined-github/pull/473
*/



================================================
FILE: source/features/show-associated-branch-prs-on-fork.css
================================================
/* Styles mostly copied from React component */
:root .rgh-pr-box {
	display: flex;
	align-items: center;
	flex-wrap: wrap;
	gap: 4px;
}

.rgh-pr-cell {
	flex-wrap: wrap;
	gap: 4px;

	& > [class*='Box'] {
		/* Drop forced height on pre-existing cell */
		height: auto;
	}
}

.rgh-pr-link {
	color: var(--fgColor-muted, var(--color-fg-muted, fuchsia));
	align-items: center;
	border: solid 1px
		var(--borderColor-default, var(--color-border-default, fuchsia));
	text-decoration: none !important;
	border-radius: 999px;
	display: inline-flex;
	font: 600 12px / 1 inherit;
	white-space: nowrap;
	height: 20px;
	padding: 0 7px;
}

.rgh-pr-link:hover {
	background-color: var(--bgColor-muted, var(--color-canvas-subtle, fuchsia));
}



================================================
FILE: source/features/show-associated-branch-prs-on-fork.gql
================================================
query AssociatedPullRequests($owner: String!, $name: String!) {
	repository(owner: $owner, name: $name) {
		refs(refPrefix: "refs/heads/", last: 100) {
			nodes {
				name
				associatedPullRequests(
					last: 1
					orderBy: { field: CREATED_AT, direction: DESC }
				) {
					nodes {
						number
						state
						isDraft
						url
						timelineItems(
							last: 1
							itemTypes: [HEAD_REF_DELETED_EVENT, HEAD_REF_RESTORED_EVENT]
						) {
							nodes {
								__typename
							}
						}
					}
				}
			}
		}
	}
}



================================================
FILE: source/features/show-associated-branch-prs-on-fork.tsx
================================================
import './show-associated-branch-prs-on-fork.css';

import React from 'dom-chef';
import {CachedFunction} from 'webext-storage-cache';
import * as pageDetect from 'github-url-detection';
import GitMergeIcon from 'octicons-plain-react/GitMerge';
import GitPullRequestIcon from 'octicons-plain-react/GitPullRequest';
import GitPullRequestClosedIcon from 'octicons-plain-react/GitPullRequestClosed';
import GitPullRequestDraftIcon from 'octicons-plain-react/GitPullRequestDraft';
import RepoForkedIcon from 'octicons-plain-react/RepoForked';
import memoize from 'memoize';

import observe from '../helpers/selector-observer.js';
import features from '../feature-manager.js';
import api from '../github-helpers/api.js';
import {cacheByRepo} from '../github-helpers/index.js';
import AssociatedPullRequests from './show-associated-branch-prs-on-fork.gql';
import {expectToken} from '../github-helpers/github-token.js';

type PullRequest = {
	timelineItems: {
		nodes: AnyObject;
	};
	number: number;
	state: keyof typeof stateIcon;
	isDraft: boolean;
	url: string;
};

export const pullRequestsAssociatedWithBranch = new CachedFunction('associatedBranchPullRequests', {
	async updater(): Promise<Record<string, PullRequest>> {
		const {repository} = await api.v4(AssociatedPullRequests);

		const pullRequests: Record<string, PullRequest> = {};
		for (const {name, associatedPullRequests} of repository.refs.nodes) {
			const [prInfo] = associatedPullRequests.nodes as PullRequest[];
			// Check if the ref was deleted, since the result includes pr's that are not in fact related to this branch but rather to the branch name.
			const headRefWasDeleted = prInfo?.timelineItems.nodes[0]?.__typename === 'HeadRefDeletedEvent';
			if (prInfo && !headRefWasDeleted) {
				prInfo.state = prInfo.isDraft && prInfo.state === 'OPEN' ? 'DRAFT' : prInfo.state;
				pullRequests[name] = prInfo;
			}
		}

		return pullRequests;
	},
	maxAge: {hours: 1},
	staleWhileRevalidate: {days: 4},
	cacheKey: cacheByRepo,
});

export const stateIcon = {
	OPEN: GitPullRequestIcon,
	CLOSED: GitPullRequestClosedIcon,
	MERGED: GitMergeIcon,
	DRAFT: GitPullRequestDraftIcon,
};

async function addLink(branch: HTMLElement): Promise<void> {
	const prs = await pullRequestsAssociatedWithBranch.get();
	const branchName = branch.getAttribute('title')!;
	const prInfo = prs[branchName];
	if (!prInfo) {
		return;
	}

	const StateIcon = stateIcon[prInfo.state] ?? (() => {/* empty */});
	const stateClassName = prInfo.state.toLowerCase();

	const cell = branch
		.closest('tr.TableRow')!
		.children
		.item(4)!;

	cell.classList.add('rgh-pr-cell');
	cell.append(
		<div className="rgh-pr-box">
			<a
				href={prInfo.url}
				target="_blank" // Matches native behavior
				data-hovercard-url={prInfo.url + '/hovercard'}
				aria-label={`Link to the ${prInfo.isDraft ? 'draft ' : ''}pull request #${prInfo.number}`}
				className="rgh-pr-link"
				rel="noreferrer"
			>
				<StateIcon width={14} height={14} className={stateClassName} />
				<RepoForkedIcon width={14} height={14} className={`mr-1 ${stateClassName}`} />
				#{prInfo.number}
			</a>
		</div>,
	);
}

async function init(signal: AbortSignal): Promise<void> {
	await expectToken();
	// Memoize because it's being called twice for each. Ideally this should be part of the selector observer
	// https://github.com/refined-github/refined-github/pull/7194#issuecomment-1894972091
	observe('react-app[app-name=repos-branches] a[class*=BranchName] div[title]', memoize(addLink), {signal});
}

void features.add(import.meta.url, {
	asLongAs: [
		pageDetect.isForkedRepo,
	],
	include: [
		pageDetect.isBranches,
	],
	init,
});

/*

Test URLs:

https://github.com/bfred-it-org/github-sandbox/branches

*/



================================================
FILE: source/features/show-names.tsx
================================================
import React from 'dom-chef';
import * as pageDetect from 'github-url-detection';
import batchedFunction from 'batched-function';
import getEmojiRegex from 'emoji-regex-xs';

import features from '../feature-manager.js';
import api from '../github-helpers/api.js';
import {getLoggedInUser, isUsernameAlreadyFullName} from '../github-helpers/index.js';
import observe from '../helpers/selector-observer.js';
import {removeTextNodeContaining} from '../helpers/dom-utils.js';
import {usernameLinksSelector} from '../github-helpers/selectors.js';
import {expectToken} from '../github-helpers/github-token.js';
import attachElement from '../helpers/attach-element.js';

const emojiRegex = getEmojiRegex();

async function dropExtraCopy(link: HTMLAnchorElement): Promise<void> {
	// Drop 'commented' label to shorten the copy
	const commentedNode = link.parentNode!.nextSibling;
	if (link.closest('.timeline-comment-header') && commentedNode) {
		// "left a comment" appears in the main comment of reviews
		removeTextNodeContaining(commentedNode, /commented|left a comment/);
	}
}

function createElement(element: HTMLAnchorElement, fullName: string): JSX.Element {
	const nameElement = (
		<span className="color-fg-muted css-truncate d-inline-block rgh-show-names">
			{/* .css-truncate-target sets display: inline-block and confines bidi overrides #8191 */}
			(<span className="css-truncate-target" style={{maxWidth: '200px'}}>{fullName}</span>)
		</span>
	);

	const testId = element.getAttribute('data-testid');
	if (testId && ['issue-body-header-author', 'avatar-link'].includes(testId)) {
		nameElement.classList.add('ml-1');
	}

	return nameElement;
}

function appendName(element: HTMLAnchorElement, fullName: string): void {
	// If it's a regular comment author, add it outside <strong> otherwise it's something like "User added some commits"
	const {parentElement} = element;
	const insertionPoint = parentElement!.tagName === 'STRONG' ? parentElement! : element;

	// React might create a new label without removing the old one
	// https://github.com/refined-github/refined-github/issues/8478
	attachElement(insertionPoint, {after: () => createElement(element, fullName)});
}

async function updateLinks(found: HTMLAnchorElement[]): Promise<void> {
	const users = Map.groupBy(
		// Exclude nested items https://github.com/refined-github/refined-github/pull/8661
		found.filter(element => element.textContent.trim() === element.href.split('/').pop()),
		element => element.textContent.trim(),
	);
	const currentUser = getLoggedInUser()!;
	const currentUserElements = users.get(currentUser);
	if (currentUserElements) {
		for (const currentUserElement of currentUserElements) {
			// For `sticky-comment-header`. Use attribute because classes are altered by GitHub
			currentUserElement.closest('[data-testid="comment-header"]')?.setAttribute('data-rgh-viewer-did-author', '');
		}

		users.delete(currentUser);
	}

	users.delete('ghost'); // Consider using `github-reserved-names` if more exclusions are needed

	if (users.size === 0) {
		return;
	}

	const names = await api.v4(
		[...users.keys()].map(username =>
			api.escapeKey(username) + `: user(login: "${username}") {name}`,
		).join(','),
	);

	for (const [username, elements] of users) {
		const userKey = api.escapeKey(username);
		const {name: fullName} = names[userKey];

		// Could be `null` if not set
		if (!fullName) {
			continue;
		}

		const fullNameWithoutEmoji = fullName.replace(emojiRegex, '').trim();

		for (const element of elements) {
			if (isUsernameAlreadyFullName(username, fullNameWithoutEmoji)) {
				element.textContent = fullNameWithoutEmoji;
			} else {
				appendName(element, fullNameWithoutEmoji);
			}
		}
	}
}

const updateLink = batchedFunction(updateLinks, {delay: 200});

function updateDom(link: HTMLAnchorElement): void {
	// `dropExtraCopy` is async so that errors in this part don't break the entire feature
	void dropExtraCopy(link);

	updateLink(link);
}

async function init(signal: AbortSignal): Promise<void> {
	await expectToken();
	observe(usernameLinksSelector, updateDom, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isDashboard,
		pageDetect.hasComments,
	],
	init,
});

/*

Test URLs:

- issue: https://github.com/isaacs/github/issues/297
- PR with reviews: https://github.com/rust-lang/rfcs/pull/2544
- mannequins: https://togithub.com/python/cpython/issues/67591
- newsfeed: https://github.com

Special cases:

- RTL: https://github.com/refined-github/refined-github/issues/8191
- Bidi override case 1: https://togithub.com/FortAwesome/Font-Awesome/issues/2465
- Bidi override case 2: https://togithub.com/w3c/webdriver/issues/385#issuecomment-598407238
- With emoji: https://github.com/typescript-eslint/tsgolint/pull/2

*/



================================================
FILE: source/features/show-open-prs-of-forks.gql
================================================
query GetPRs($query: String!) {
	search(first: 100, type: ISSUE, query: $query) {
		nodes {
			... on PullRequest {
				number
				headRepository {
					nameWithOwner
				}
			}
		}
	}
}



================================================
FILE: source/features/show-open-prs-of-forks.tsx
================================================
import React from 'dom-chef';
import {CachedFunction} from 'webext-storage-cache';
import {$} from 'select-dom/strict.js';
import elementReady from 'element-ready';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import api from '../github-helpers/api.js';
import pluralize from '../helpers/pluralize.js';
import {getForkedRepo, getLoggedInUser, getRepo} from '../github-helpers/index.js';
import GetPRs from './show-open-prs-of-forks.gql';

function getLinkCopy(count: number): string {
	return pluralize(count, 'one open pull request', 'at least $$ open pull requests');
}

const countPRs = new CachedFunction('prs-on-forked-repo', {
	async updater(forkedRepo: string): Promise<{count: number; firstPr?: number}> {
		const {search} = await api.v4(GetPRs, {
			variables: {
				query: `is:pr is:open archived:false repo:${forkedRepo} author:${getLoggedInUser()!}`,
			},
		});

		// Only show PRs originated from the current repo
		const prs = search.nodes.filter((pr: AnyObject) => pr.headRepository.nameWithOwner === getRepo()!.nameWithOwner);

		// If only one is found, pass the PR number so we can link to the PR directly
		if (prs.length === 1) {
			return {count: 1, firstPr: prs[0].number};
		}

		return {count: prs.length};
	},
	maxAge: {hours: 1},
	staleWhileRevalidate: {days: 2},
	cacheKey: ([forkedRepo]): string => `${forkedRepo}:${getRepo()!.nameWithOwner}`,
});

// eslint-disable-next-line @typescript-eslint/no-restricted-types
async function getPRs(): Promise<[prCount: number, url: string] | []> {
	// Wait for the tab bar to be loaded
	// Maybe replace with https://github.com/refined-github/github-url-detection/issues/85
	await elementReady('.UnderlineNav-body');
	if (!pageDetect.canUserAdminRepo()) {
		return [];
	}

	const forkedRepo = getForkedRepo()!;
	const {count, firstPr} = await countPRs.get(forkedRepo);
	if (count === 1) {
		return [count, `/${forkedRepo}/pull/${firstPr!}`];
	}

	const url = new URL(`/${forkedRepo}/pulls`, location.origin);
	url.searchParams.set('q', 'is:pr is:open sort:updated-desc author:@me');
	return [count, url.href];
}

async function initHeadHint(): Promise<void | false> {
	const [count, url] = await getPRs();
	if (!count) {
		return false;
	}

	$(`[data-hovercard-type="repository"][href="/${getForkedRepo()!}"]`).after(
		// The class is used by `quick-fork-deletion`
		<> with <a href={url} className="rgh-open-prs-of-forks">{getLinkCopy(count)}</a></>,
	);
}

async function initDeleteHint(): Promise<void | false> {
	const [count, url] = await getPRs();
	if (!count) {
		return false;
	}

	$('details-dialog[aria-label*="Delete"] .Box-body p:first-child').after(
		<p className="flash flash-warn">
			It will also abandon <a href={url}>your {getLinkCopy(count)}</a> in <strong>{getForkedRepo()!}</strong> and youâ€™ll no longer be able to edit {count === 1 ? 'it' : 'them'}.
		</p>,
	);
}

void features.add(import.meta.url, {
	asLongAs: [
		pageDetect.isForkedRepo,
	],
	deduplicate: 'has-rgh',
	init: initHeadHint,
}, {
	asLongAs: [
		pageDetect.isForkedRepo,
	],
	include: [
		pageDetect.isRepoMainSettings,
	],
	deduplicate: 'has-rgh',
	init: initDeleteHint,
});

/*

Test URLs:

1. Visit https://github.com/pulls?q=is%3Apr+is%3Aopen+author%3A%40me+archived%3Afalse+-user%3A%40me
2. Find a PR made from a fork
3. In it, open your own fork

*/



================================================
FILE: source/features/show-user-top-repositories.tsx
================================================
import React from 'dom-chef';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';

function addLink(showCaseTitle: Element): void {
	const url = new URL(location.pathname, location.href);
	// DO NOT add type: 'source' since forks could also have many stars
	url.search = new URLSearchParams({
		tab: 'repositories',
		sort: 'stargazers',
	}).toString();

	showCaseTitle.firstChild!.after(' / ', <a href={url.href}>Top repositories</a>);
}

function init(signal: AbortSignal): void {
	observe('.js-pinned-items-reorder-container h2', addLink, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isUserProfileMainTab,
	],
	init,
});

/*

Test URLs:

https://github.com/fregante

*/



================================================
FILE: source/features/show-whitespace.css
================================================
[data-rgh-whitespace] {
	line-height: 1em;
	background-clip: border-box;
	background-repeat: repeat-x;
	background-position: left center;
}

[data-rgh-whitespace='tab'] {
	background-image: url('data:image/svg+xml,%3Csvg preserveAspectRatio="xMinYMid meet" viewBox="0 0 12 24" xmlns="http://www.w3.org/2000/svg"%3E%3Cpath d="M9.5 10.44L6.62 8.12L7.32 7.26L12.04 11V11.44L7.28 14.9L6.62 13.9L9.48 11.78H0V10.44H9.5Z" fill="rgba(128, 128, 128, 50%25)"/%3E%3C/svg%3E');
	background-size: calc(var(--tab-size) * 1ch) 1.25em;

	/* 2px because of #4991 */
	background-position: 2px center;
}

[data-rgh-whitespace='space'] {
	background-image: url('data:image/svg+xml,%3Csvg preserveAspectRatio="xMinYMid meet" viewBox="0 0 12 24" xmlns="http://www.w3.org/2000/svg"%3E%3Cpath d="M4.5 11C4.5 10.1716 5.17157 9.5 6 9.5C6.82843 9.5 7.5 10.1716 7.5 11C7.5 11.8284 6.82843 12.5 6 12.5C5.17157 12.5 4.5 11.8284 4.5 11Z" fill="rgba(128, 128, 128, 50%25)"/%3E%3C/svg%3E');
	background-size: 1ch 1.25em;
}

[data-tab-size='1'] {
	--tab-size: 1;
}

[data-tab-size='2'] {
	--tab-size: 2;
}

[data-tab-size='3'] {
	--tab-size: 3;
}

[data-tab-size='4'] {
	--tab-size: 4;
}

[data-tab-size='5'] {
	--tab-size: 5;
}

[data-tab-size='6'] {
	--tab-size: 6;
}

[data-tab-size='8'] {
	--tab-size: 8;
}

[data-tab-size='10'] {
	--tab-size: 10;
}

[data-tab-size='12'] {
	--tab-size: 12;
}

/*
Can't use this because attr() returns strings and casting isn't supported anywhere yet
https://developer.mozilla.org/en-US/docs/Web/CSS/attr

[data-tab-size] {
	--tab-size: attr(data-tab-size);
}
*/



================================================
FILE: source/features/show-whitespace.tsx
================================================
import './show-whitespace.css';

import * as pageDetect from 'github-url-detection';
import {onAbort} from 'abort-utils';

import features from '../feature-manager.js';
import {codeElementsSelector} from '../github-helpers/dom-formatters.js';
import showWhiteSpacesOnLine from '../helpers/show-whitespace-on-line.js';
import observe from '../helpers/selector-observer.js';

const viewportObserver = new IntersectionObserver(changes => {
	for (const {target: line, isIntersecting} of changes) {
		if (isIntersecting) {
			const shouldAvoidSurroundingSpaces = Boolean(line.closest('.blob-wrapper-embedded')); // #2285
			showWhiteSpacesOnLine(line, shouldAvoidSurroundingSpaces);
			viewportObserver.unobserve(line);
		}
	}
});

function showWhitespaceWhenInViewport(line: HTMLElement): void {
	viewportObserver.observe(line);
}

function init(signal: AbortSignal): void {
	observe(`:is(${codeElementsSelector.join(',')}):not(.blob-code-hunk)`, showWhitespaceWhenInViewport, {signal});
	onAbort(signal, viewportObserver);
}

void features.add(import.meta.url, {
	include: [
		pageDetect.hasCode,
	],
	init,
});

/*
TEST URL
https://github.com/refined-github/sandbox/pull/18
*/



================================================
FILE: source/features/sidebar-focus-file.tsx
================================================
import * as pageDetect from 'github-url-detection';

import delay from '../helpers/delay.js';
import features from '../feature-manager.js';
import GitHubFileURL from '../github-helpers/github-file-url.js';
import {scrollIntoViewIfNeeded} from '../github-helpers/index.js';

async function init(): Promise<void | false> {
	const {filePath} = new GitHubFileURL(location.href);

	// eslint-disable-next-line unicorn/prefer-query-selector -- `querySelector` requires escaping
	const item = document.getElementById(`${filePath}-item`);
	if (item) {
		// This feature is only needed for the very first load of the view.
		// GitHub does it natively after that.
		scrollIntoViewIfNeeded(item);

		// Try again after a delay because GitHub might have reset the scroll
		// https://github.com/refined-github/refined-github/pull/7848#discussion_r1784041198
		await delay(500);
		scrollIntoViewIfNeeded(item);
	} else {
		// The sidebar might be closed
		return false;
	}
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isRepoTree,
		pageDetect.isSingleFile,
	],
	exclude: [
		pageDetect.isRepoRoot,
	],
	awaitDomReady: true,
	init,
});

/*

Test URLs:

- https://github.com/refined-github/refined-github/blob/main/source/features/mark-private-repos.css
- https://github.com/refined-github/refined-github/tree/main/test/web-ext-profile

*/



================================================
FILE: source/features/small-user-avatars.css
================================================
.rgh-mention-avatar::before {
	content: '';
	display: inline-block;
	width: 1em !important;
	height: 1em;
	min-width: 16px;
	min-height: 16px;
	margin-right: 0.2em;
	border-radius: 50%;
	background-image: var(--avatar-url);
	background-size: cover;
	background-position: center;
	vertical-align: middle;
}

.user-mention {
	margin-left: 0 !important;
	margin-right: 0 !important;
}

[data-testid='list-row-repo-name-and-number'] relative-time {
	/* Due to `inline-block` on `.small-user-avatars`, which is used as a "nowrap" container */
	/* https://github.com/refined-github/refined-github/issues/8396 */
	vertical-align: baseline;
}



================================================
FILE: source/features/small-user-avatars.tsx
================================================
import React from 'dom-chef';

import onetime from '../helpers/onetime.js';
import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';
import getUserAvatarURL from '../github-helpers/get-user-avatar.js';
import './small-user-avatars.css';

function addAvatar(link: HTMLElement): void {
	const username = link.textContent;
	const size = 14;

	link.classList.add('d-inline-block', 'lh-condensed-ultra');
	link.prepend(
		<img
			className="avatar avatar-user v-align-text-bottom mr-1 rgh-small-user-avatars"
			src={getUserAvatarURL(username, size)!}
			width={size}
			height={size}
			loading="lazy"
		/>,
	);
}

function addMentionAvatar(link: HTMLAnchorElement): void {
	// Don't use textContent #8389
	const username = link.href.split('/').pop()!;
	const avatarUrl = getUserAvatarURL(username, 16)!;

	link.classList.add('rgh-small-user-avatars', 'rgh-mention-avatar');
	link.style.setProperty('--avatar-url', `url(${avatarUrl})`);
}

function initOnce(): void {
	// Excludes bots
	observe([
		'.js-issue-row [data-hovercard-type="user"]', // `isPRList` + old `isIssueList`
		'.notification-thread-subscription [data-hovercard-type="user"]', // https://github.com/notifications/subscriptions
		`:is(
			[data-testid="created-at"],
			[data-testid="closed-at"]
		) a[data-hovercard-url*="/users"]`, // `isIssueList`
	], addAvatar);
	observe('.user-mention:not(.commit-author)', addMentionAvatar);
}

void features.add(import.meta.url, {
	init: onetime(initOnce),
});

/*

Test URLs:

https://github.com/notifications/subscriptions
https://github.com/refined-github/refined-github/issues
https://github.com/refined-github/refined-github/pull/7004
https://github.com/refined-github/refined-github/issues/8802#issuecomment-3711163697
https://github.com/refined-github/refined-github/releases
https://github.com/refined-github/refined-github/releases/tag/23.9.21
https://github.com/orgs/community/discussions/5841#discussioncomment-1450320

*/



================================================
FILE: source/features/sort-conversations-by-update-time.tsx
================================================
import {$optional} from 'select-dom/strict.js';
import * as pageDetect from 'github-url-detection';
import elementReady from 'element-ready';
import oneEvent from 'one-event';

import features from '../feature-manager.js';
import SearchQuery from '../github-helpers/search-query.js';
import observe from '../helpers/selector-observer.js';
import {linksToConversationLists} from '../github-helpers/selectors.js';

/** Keep the original URL on the element so that `shorten-links` can use it reliably #5890 */
export function saveOriginalHref(link: HTMLAnchorElement): void {
	link.dataset.originalHref ??= link.href;
}

async function selectCurrentConversationFilter(): Promise<void> {
	const currentSearchURL = location.href.replace('/pulls?', '/issues?'); // Replacement needed to make up for the redirection of "Your pull requests" link
	const menu = await elementReady('#filters-select-menu');
	const currentFilter = $optional(`a.SelectMenu-item[href="${currentSearchURL}"]`, menu);
	if (currentFilter) {
		$optional('[aria-checked="true"]', menu)?.setAttribute('aria-checked', 'false');
		currentFilter.setAttribute('aria-checked', 'true');
	}
}

async function updateLink(link: HTMLAnchorElement): Promise<void> {
	if (link.host !== location.host) {
		return;
	}

	// Pick only links to lists, not single issues
	// + skip pagination links
	// + skip pr/issue filter dropdowns (some are lazyloaded)
	if (pageDetect.isIssueOrPRList(link)) {
		// Avoid rewriting /labels/ URLs until the last moment
		// https://github.com/refined-github/refined-github/issues/7205
		if (pageDetect.isRepoTaxonomyIssueOrPRList(link)) {
			await oneEvent(link, 'click', {filter: event => (event as MouseEvent).which < 2});
		}

		saveOriginalHref(link);

		const newUrl = SearchQuery.from(link).prepend('sort:updated-desc').href;

		// Preserve relative attributes as such #5435
		const isRelativeAttribute = link.getAttribute('href')!.startsWith('/');
		link.href = isRelativeAttribute ? newUrl.replace(location.origin, '') : newUrl;
	}

	// Also sort projects #4957
	if (pageDetect.isProjects()) {
		saveOriginalHref(link);

		// Projects use a different parameter name so don't use SearchQuery
		const search = new URLSearchParams(link.search);
		const query = search.get('query') ?? 'is:open'; // Default value query is missing
		search.set('query', `sort:updated-desc ${query}`);
		link.search = search.toString();
	}
}

function init(signal: AbortSignal): void {
	// Get links that don't already have a specific sorting or pagination applied
	observe(
		linksToConversationLists,
		updateLink,
		{signal},
	);
}

void features.add(import.meta.url, {
	init,
}, {
	include: [
		pageDetect.isRepoIssueOrPRList,
	],
	init: selectCurrentConversationFilter,
});

/*

Test URLs

Live links, these should be altered to include the `sort:updated-desc` query parameter:

- https://github.com/refined-github/refined-github/pulls
- https://github.com/refined-github/refined-github/labels/bug

*/



================================================
FILE: source/features/status-subscription.css
================================================
/* TODO: Revert https://github.com/refined-github/refined-github/pull/8111 in April 2025 */
.rgh-status-subscription .btn {
	&:not(.selected) {
		color: var(--fgColor-muted, var(--color-fg-muted, fuchsia));
	}

	&.selected {
		border-color: var(
			--control-borderColor-emphasis,
			var(--color-accent-emphasis, fuchsia)
		);

		.octicon {
			color: var(--fgColor-default, var(--color-fg-default, fuchsia));
		}
	}
}



================================================
FILE: source/features/status-subscription.tsx
================================================
import './status-subscription.css';

import React from 'dom-chef';
import * as pageDetect from 'github-url-detection';
import {$, $optional} from 'select-dom/strict.js';
import BellIcon from 'octicons-plain-react/Bell';
import BellSlashIcon from 'octicons-plain-react/BellSlash';
import IssueReopenedIcon from 'octicons-plain-react/IssueReopened';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';
import {getConversationNumber, getRepo, multilineAriaLabel} from '../github-helpers/index.js';

type SubscriptionStatus = 'none' | 'all' | 'status';

// Make the element look selected, not disabled, but effectively disable clicks/focus
const disableAttributes = {
	'aria-selected': true,
	className: 'selected',
	tabIndex: -1,
	style: {pointerEvents: 'none'},
} as const satisfies React.HTMLAttributes<HTMLButtonElement>;

function SubButton(): JSX.Element {
	return (
		<button
			data-disable-with
			name="id"
			type="submit"
			className="btn btn-sm flex-1 BtnGroup-item tooltipped tooltipped-sw"
		/>
	);
}

function getReasonElement(subscriptionButton: HTMLButtonElement): HTMLParagraphElement {
	return subscriptionButton
		.closest('.thread-subscription-status')!
		.querySelector('p.reason')!;
}

function getCurrentStatus(subscriptionButton: HTMLButtonElement): SubscriptionStatus {
	const reason = getReasonElement(subscriptionButton).textContent;

	// Youâ€™re receiving notifications because you chose custom settings for this thread.
	if (reason.includes('custom settings')) {
		return 'status';
	}

	// Youâ€™re not receiving notifications from this thread.
	if (reason.includes('not receiving')) {
		return 'none';
	}

	return 'all';
}

function addButton(subscriptionButton: HTMLButtonElement): void {
	const status = getCurrentStatus(subscriptionButton);
	// Save first
	const originalId = subscriptionButton.form!.elements.id;

	subscriptionButton.after(
		<div className="rgh-status-subscription BtnGroup d-flex width-full">
			<SubButton
				// @ts-expect-error I don't remember how to fix this
				value="unsubscribe"
				aria-label="Unsubscribe"
				{...(status === 'none' && disableAttributes)}
			>
				<BellSlashIcon /> None
			</SubButton>

			<SubButton
				// @ts-expect-error I don't remember how to fix this
				value="subscribe"
				aria-label="Subscribe to all events"
				{...(status === 'all' && disableAttributes)}
			>
				<BellIcon /> All
			</SubButton>

			<SubButton
				// @ts-expect-error I don't remember how to fix this
				value="subscribe_to_custom_notifications"
				aria-label={multilineAriaLabel(
					'Subscribe just to status changes',
					'(closing, reopening, merging)',
				)}
				{...(status === 'status' && disableAttributes)}
			>
				<IssueReopenedIcon /> Status
			</SubButton>
		</div>,

		// Always submitted, but ignored unless the value is `subscribe_to_custom_notifications`
		// Keep outside BtnGroup
		<input type="hidden" name="events[]" value="merged" />,
		<input type="hidden" name="events[]" value="closed" />,
		<input type="hidden" name="events[]" value="reopened" />,
	);

	// Remove it only if the form was successfully added
	originalId.remove();
	subscriptionButton.hidden = true;

	// 'all' can have many reasons, but the other two don't add further information #6684
	if (status !== 'all') {
		getReasonElement(subscriptionButton).hidden = true;
	}
}

const githubApiBaseHeaders = new Headers({
	accept: 'application/json',
	'github-verified-fetch': 'true',
	'x-github-client-version': $('meta[name="release"]').content,
	credentials: 'include',
});

type IssueApiResponse = Record<string, any>;

async function fetchIssue(): Promise<IssueApiResponse> {
	const repo = getRepo()!;

	const body = {
		query: 'fa182058c0b83a77481f98108cdbf1eb',
		variables: {
			number: getConversationNumber()!,
			owner: repo.owner,
			repo: repo.name,
		},
	};
	const url = new URL('/_graphql', location.origin);
	url.searchParams.set('body', JSON.stringify(body));

	const response = await fetch(url, {headers: githubApiBaseHeaders});
	if (!response.ok) {
		throw new Error('Failed to fetch the issue');
	}

	const {data} = await response.json();
	return data;
}

async function updateIssueSubscriptionStatus(targetStatus: SubscriptionStatus, issue: IssueApiResponse): Promise<void> {
	const {id} = issue.repository.issue;

	const body = {
		query: 'd0752b2e49295017f67c84f21bfe41a3',
		variables: {
			input: {
				events: targetStatus === 'status' ? ['CLOSED', 'REOPENED'] : [],
				state: targetStatus === 'status' ? 'CUSTOM' : targetStatus === 'all' ? 'SUBSCRIBED' : 'UNSUBSCRIBED',
				subscribableId: id,
			},
		},
	};

	const response = await fetch('/_graphql',
		{
			headers: githubApiBaseHeaders,
			method: 'POST',
			body: JSON.stringify(body),
		},
	);
	if (!response.ok) {
		throw new Error('Failed to update the issue subscription status');
	}
}

async function getCurrentStatusIssue(issue: IssueApiResponse): Promise<SubscriptionStatus> {
	const {viewerThreadSubscriptionFormAction, viewerCustomSubscriptionEvents} = issue.repository.issue;
	const isSubscribed = viewerThreadSubscriptionFormAction === 'UNSUBSCRIBE';

	if (isSubscribed) {
		if (viewerCustomSubscriptionEvents.length > 0) {
			return 'status';
		}

		return 'all';
	}

	return 'none';
}

async function addButtonIssue(subscriptionButton: HTMLButtonElement): Promise<void> {
	const issue = await fetchIssue();
	const status = await getCurrentStatusIssue(issue);
	const previousRghButton = $optional('.rgh-status-subscription', subscriptionButton.parentElement!);

	subscriptionButton.after(
		<div className="rgh-status-subscription BtnGroup d-flex width-full">
			<SubButton
				aria-label="Unsubscribe"
				onClick={async () => {
					await updateIssueSubscriptionStatus('none', issue);
					void addButtonIssue(subscriptionButton);
				}}
				{...(status === 'none' && disableAttributes)}
			>
				<BellSlashIcon /> None
			</SubButton>

			<SubButton
				aria-label="Subscribe to all events"
				onClick={async () => {
					await updateIssueSubscriptionStatus('all', issue);
					void addButtonIssue(subscriptionButton);
				}}
				{...(status === 'all' && disableAttributes)}
			>
				<BellIcon /> All
			</SubButton>

			<SubButton
				aria-label={multilineAriaLabel(
					'Subscribe just to status changes',
					'(closing, reopening, merging)',
				)}
				onClick={async () => {
					await updateIssueSubscriptionStatus('status', issue);
					void addButtonIssue(subscriptionButton);
				}}
				{...(status === 'status' && disableAttributes)}
			>
				<IssueReopenedIcon /> Status
			</SubButton>
		</div>,
	);

	previousRghButton?.remove();
	subscriptionButton.hidden = true;
}

function init(signal: AbortSignal): void {
	// Repos you're ignoring can't be subscribed to, so the button is disabled
	observe('button[data-thread-subscribe-button]:enabled', addButton, {signal});
	if (!pageDetect.isEnterprise()) {
		observe('button[aria-describedby*="issue-viewer-subscription-description"]', addButtonIssue, {signal});
	}
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isConversation,
		// Workaround for #6554
		// TODO: remove once the issue is resolved
		pageDetect.isRepoIssueOrPRList,
	],
	awaitDomReady: true, // The sidebar is at the end of the page
	init,
});

/*

Test URLs

- Issue: https://github.com/refined-github/sandbox/issues/3
- PR: https://github.com/refined-github/sandbox/pull/4
- Also test a repo you're completely ignoring

*/



================================================
FILE: source/features/sticky-comment-header.css
================================================
html:not([rgh-OFF-sticky-comment-header]) {
	--rgh-bg-accent: var(
		--bgColor-accent-muted,
		var(--color-accent-subtle, fuchsia)
	);

	/* biome-ignore format: bug */
	/* Issue body header */
	[class^='IssueBodyHeader-module__IssueBodyHeaderContainer'],
	/* Issue/review/commit comment header */
	[data-testid='comment-header']:not(
		/* Exclude review thread comments (on the "Files changed" tab) */
		[class^='ReviewThreadComment-module'] > *
	),
	/* PR body/comment or gist comment header */
	.timeline-comment-header {
		position: sticky;
		/* Prevent header from being covered by media */
		z-index: 3;
		--rgh-issue-or-pr-sticky-header-height: 56px;
		top: calc(
			var(--base-sticky-header-height, 0px) +
			var(--rgh-issue-or-pr-sticky-header-height, 0px)
		);
	}

	:is([id^='gistcomment'], [id^='commitcomment']) > * {
		--rgh-issue-or-pr-sticky-header-height: 0px !important;
	}

	/* Added by `show-names` */
	[data-rgh-viewer-did-author]:not([class^='ReviewThreadComment-module'] > *),
	.timeline-comment.current-user .timeline-comment-header,
	[class*='IssueBodyHeader-module__viewerDidAuthor'] {
		/* Draw a possibly semi-transparent accent color over the opaque background */
		background:
			linear-gradient(var(--rgh-bg-accent), var(--rgh-bg-accent)),
			var(--rgh-background);
	}

	/* Prevent header of the next comment from overlapping context menu of the sticky header */
	.timeline-comment-header:has(details[open]) {
		z-index: 4;
	}
}



================================================
FILE: source/features/sticky-comment-header.tsx
================================================
import './sticky-comment-header.css';

import features from '../feature-manager.js';

void features.addCssFeature(import.meta.url);

/*

Test URLs:

https://github.com/refined-github/sandbox/issues/117
https://github.com/refined-github/sandbox/pull/118
https://github.com/refined-github/sandbox/pull/118/files (Shouldn't affect review comments)
https://gist.github.com/anthonyeden/0088b07de8951403a643a8485af2709b
https://github.com/refined-github/sandbox/commit/0dfef9db87825b1124d885fb2c4e89c5b4a339b4

*/



================================================
FILE: source/features/sticky-conversation-list-toolbar.css
================================================
/* Sticky table header on issues list */
/* https://github.com/refined-github/refined-github/issues */
.Box-header#js-issues-toolbar,
/* https://github.com/issues */
.Box#js-issues-toolbar > .Box-header {
	position: sticky;
	top: 0;
	z-index: 25; /* Must be above .modal-backdrop (z-index 20) #1317 */
}

/* Test URLs above */



================================================
FILE: source/features/sticky-csv-header.css
================================================
.markdown-body .csv-data :is(td, th) {
	/* Make first column sticky */
	&:first-child {
		position: sticky;
		left: 0;
		z-index: 1;
		background-clip: padding-box;
	}

	/* Prevent double borders */
	&:last-child {
		border-right: none;
	}
}

.blob-wrapper.type-csv,
.Box:has(.csv-data) {
	border-bottom-right-radius: 0;
	border-bottom-left-radius: 0;
	border-bottom: none;
}

.markdown-body .csv-data tbody tr:last-child td:first-child {
	border-bottom: 1px solid
		var(--borderColor-default, var(--color-border-default, fuchsia));
}

/*
Test URLs:
horizontal + vertical scrolling: https://github.com/fxedel/vaterstetten-in-zahlen/blob/2c3ab1c/data/energie/mastrPhotovoltaik.csv
vertical scrolling only: https://github.com/fxedel/vaterstetten-in-zahlen/blob/2c3ab1c/data/einwohner/lfstatFortschreibungJahre.csv
horizontal scrolling only: https://github.com/microCOVID/microCOVID/blob/181201b/public/prevalence_data/US_50.csv
no scrolling: https://github.com/fxedel/vaterstetten-in-zahlen/blob/2c3ab1c/data/einwohner/lfstatVolkszaehlungen.csv
`.tsv` file: https://github.com/4dcu-be/GitHub-Actions-KeyForge/blob/8d53ec2/data/keyforge_decks.tsv

Exclude:
too large to even show the file contents: https://github.com/mattkinsey/covid19-vaccine-timeseries/blob/cf7362e/vacc-timeseries.csv
too large to make it beautiful and searchable: https://github.com/fxedel/vaterstetten-in-zahlen/blob/2c3ab1c/data/corona-fallzahlen/arcgisInzidenzGemeinden.csv
no commas found: https://github.com/fxedel/vaterstetten-in-zahlen/blob/2c3ab1c/data/kommunalwahl2020/raw/Open-Data-Buergermeisterwahl-Bayern1173.csv
*/



================================================
FILE: source/features/sticky-file-header.css
================================================
/* `.sticky-file-header` excludes native sticky header */
:root .file-header:not(.sticky-file-header) {
	position: sticky;
	z-index: 6; /* isBlame, isEditingFile */
	top: 0;
}

.notification-shelf ~ .application-main .file-header:not(.sticky-file-header) {
	top: 129px;
}

/* Same as `.sticky-file-header.has-open-dropdown` */
.file-header.has-open-dropdown:not(.sticky-file-header) {
	z-index: 10;
}

/* Consider the File List fixed header/sidebar in commits */
:root diff-layout .file-header:not(.sticky-file-header) {
	top: 60px;
}

/*
Test URLs
https://github.com/refined-github/refined-github/commit/1d9dd9f0208c327351512beb6d6a22279bc47807
https://github.com//refined-github/refined-github/compare/22.2.13...22.2.22#files_bucket
https://gist.github.com/sindresorhus/a39789f98801d908bbc7ff3ecc99d99c

Exclude:
https://github.com/refined-github/refined-github/pull/5460/files
https://github.com/refined-github/refined-github/blob/main/source/features/default-branch-button.tsx
https://github.com/refined-github/refined-github/blame/243e51d786e4771d313091b94cec826ff86becc9/source/features/index.tsx#L326-L327

*/



================================================
FILE: source/features/sticky-notifications-actions.css
================================================
@media (height >= 500px) {
	.js-notifications-container {
		--sticky-padding: 10px;
		--shadow-blur-radius: 10px;
		--shadow-spread-radius: 10px;

		.Box:has(.js-notifications-mark-all-prompt) {
			& .Box-header {
				position: sticky;
				top: var(--sticky-padding);
				z-index: 10;

				/* Cover up the content seen through the rounded corners above */
				box-shadow: 0
					calc((var(--sticky-padding) + var(--borderRadius-medium)) * -1) 0 0
					var(--rgh-background);
			}

			/* Grouped by repo; .Box only contains the header */
			&:not(.notifications-list) {
				display: contents; /* Craptastic position:sticky is only sticky within its parent, so we have to break it. Fingers crossed this doesn't break the layout in the future. */
				& .Box-header {
					/* Since its section already has its own .Box-header, we try to further "elevate" it */
					box-shadow: 0 0 var(--shadow-blur-radius) var(--shadow-spread-radius)
						var(--rgh-background);
				}
			}
		}

		.js-notifications-banners-target {
			margin-bottom: calc(
				max(var(--shadow-blur-radius) * 0.6, 0px) +
				var(--shadow-spread-radius)
			);
		}
	}
}

/*

Test URLs:
https://github.com/notifications (Grouped by date)
https://github.com/notifications (Grouped by repo)

*/



================================================
FILE: source/features/sticky-sidebar.css
================================================
[rgh-sticky-sidebar-enabled] #js-repo-pjax-container ul.pagehead-actions,
/* https://github.com/refined-github/refined-github/issues/6761 */
	[rgh-sticky-sidebar-enabled]
	[id^='my-forks-menu'] {
	z-index: initial !important; /* This affects the social buttons. It seems to have no effect but it constantly causes trouble with other features. */
}

/*
Have the calculations available even when the sidebar isn't sticky so that `--rgh-sticky-sidebar-offset` can be used via JS.

Exclusively use simple sums and use `0px` instead of `0`
*/
.application-main {
	--rgh-sticky-header-height: 70px; /* 60px plus some padding */
	--rgh-sticky-sidebar-offset: calc(
		var(--rgh-sticky-header-height, 0px) +
		var(--rgh-sticky-notification-header-height, 0px)
	);
}

/* `isRepoRoot` */
.Layout-sidebar .BorderGrid {
	--rgh-sticky-sidebar-offset: 0;
}

.notification-shelf ~ .application-main {
	/* It needs to be on the same element as above for calc() to work */
	--rgh-sticky-notification-header-height: 69px;
}

/* required to make `sticky` work for the issue Sidebar */
.rgh-sticky-sidebar-container {
	display: unset !important;
}

.rgh-sticky-sidebar {
	position: sticky;
	top: var(--rgh-sticky-sidebar-offset, 0) !important;
}

#discussion_bucket #partial-discussion-sidebar.rgh-sticky-sidebar-container {
	height: min-content;
}

/* Hides the last divider (on pull requests) to avoid https://user-images.githubusercontent.com/10238474/62282128-af6fb980-b457-11e9-8b18-c29687b88da1.gif */
.rgh-sticky-sidebar + .border-top {
	display: none;
}

/* Higher than sticky readme header https://github.com/refined-github/refined-github/issues/8462 */
.rgh-sticky-sidebar:has(.details-overlay[open]) {
	z-index: 90;
}



================================================
FILE: source/features/sticky-sidebar.tsx
================================================
import './sticky-sidebar.css';

import debounce from 'debounce-fn';
import * as pageDetect from 'github-url-detection';
import {onAbort} from 'abort-utils';
import {elementExists} from 'select-dom';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';
import calculateCssCalcString from '../helpers/calculate-css-calc-string.js';

const minimumViewportWidthForSidebar = 768; // Less than this, the layout is single-column

const sidebarSelector = [
	'.Layout-sidebar .BorderGrid', // `isRepoRoot`
	'.Layout-sidebar #partial-discussion-sidebar', // Old `isConversation`
	'div[data-testid="issue-viewer-metadata-pane"]', // `isConversation`
	'#discussion_bucket #partial-discussion-sidebar', // `isDiscussion`
];

let sidebar: HTMLElement | undefined;
const onResize = debounce(updateStickiness, {wait: 100});
const sidebarObserver = new ResizeObserver(onResize);

// Avoid disabling the stickiness while the user is interacting with it
function toggleHoverState(event: MouseEvent): void {
	const isHovered = event.type === 'mouseenter';
	if (isHovered) {
		sidebarObserver.disconnect();
	} else {
		// Also immediately calls `onResize`, so it has the welcome side effect of unsticking the sidebar if its height changes
		sidebarObserver.observe(sidebar!);
	}
}

// Can't use delegate because it's not efficient to track mouse events across the document
function trackSidebar(signal: AbortSignal, foundSidebar: HTMLElement): void {
	if (elementExists('[data-testid="sticky-sidebar"]', foundSidebar)) {
		return;
	}

	sidebar = foundSidebar;
	sidebarObserver.observe(sidebar);
	onAbort(signal, sidebarObserver, () => {
		sidebar = undefined;
	});

	const container = sidebar.parentElement!.id === 'discussion_bucket' ? sidebar : sidebar.parentElement!;
	container.classList.add('rgh-sticky-sidebar-container');

	sidebar.addEventListener('mouseenter', toggleHoverState, {signal});
	sidebar.addEventListener('mouseleave', toggleHoverState, {signal});
}

function updateStickiness(): void {
	if (!sidebar) {
		return;
	}

	const offset = calculateCssCalcString(getComputedStyle(sidebar).getPropertyValue('--rgh-sticky-sidebar-offset'));
	sidebar.classList.toggle(
		'rgh-sticky-sidebar',
		window.innerWidth >= minimumViewportWidthForSidebar
		&& sidebar.offsetHeight + offset < window.innerHeight,
	);
}

function init(signal: AbortSignal): void {
	document.documentElement.setAttribute('rgh-sticky-sidebar-enabled', '');

	// The element is recreated when the page is updated
	// `trackSidebar` also triggers the first update via `sidebarObserver.observe()`
	observe(sidebarSelector, trackSidebar.bind(undefined, signal), {signal});

	// Update it when the window is resized
	window.addEventListener('resize', onResize, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isRepoRoot,
		pageDetect.isConversation,
		pageDetect.isDiscussion,
	],
	exclude: [
		() => screen.availWidth < minimumViewportWidthForSidebar,
	],
	init,
});

/*

Test URLs:

Repo: https://github.com/refined-github/refined-github
Conversation: https://github.com/refined-github/refined-github/issues/6752

*/



================================================
FILE: source/features/stop-redirecting-in-notification-bar.tsx
================================================
import delegate, {type DelegateEvent} from 'delegate-it';

import features from '../feature-manager.js';

const hasNotificationBar = (): boolean =>
	location.search.startsWith('?notification_referrer_id=')
	|| JSON.parse(sessionStorage.getItem('notification_shelf') ?? '{}').pathname === location.pathname;

function handleClick(event: DelegateEvent<MouseEvent, HTMLButtonElement>): void {
	// Disable the redirect to the Notifications inbox if either:
	// 1. The alt key was held down during click (user choice)
	// 2. The notification has been opened in a new tab (the inbox is still open in the previous tab)
	const redirectDisabled = event.altKey || sessionStorage.rghIsNewTab === 'true';
	event.delegateTarget.form!.toggleAttribute('data-redirect-to-inbox-on-submit', !redirectDisabled);
}

function init(signal: AbortSignal): void {
	sessionStorage.rghIsNewTab = history.length === 1;
	delegate('.notification-shelf .js-notification-action button', 'click', handleClick, {signal});
}

void features.add(import.meta.url, {
	include: [
		hasNotificationBar,
	],
	init,
});

/*

Test URLs:

1. Visit https://github.com/notifications
2. Open any notification
3. Alt-ckick the buttons in the notification bar

*/



================================================
FILE: source/features/suggest-commit-title-limit.css
================================================
:root {
	--rgh-limit-color: var(--rgh-red, fuchsia);
}

/* Limit width of commit title to 72 characters */
.rgh-suggest-commit-title-limit :is(#merge_title_field, #commit-summary-input) {
	box-sizing: content-box; /* Exclude padding/border from `width`; No need to mess with `calc` */
	width: 72ch;

	/* Like 100%, except it works with content-box and it feels like -webkit-1999 */
	max-width: -webkit-fill-available;
	max-width: -moz-available;
	max-width: intrinsic;
}

#commit-summary-input,
#merge_title_field,
#pull_request_title,
#issue_title {
	&.rgh-title-over-limit {
		border-color: var(--rgh-limit-color);
		background-color: color-mix(
			in srgb,
			var(--rgh-limit-color) 3%,
			transparent
		);

		&:focus {
			box-shadow:
				inset 0 1px 2px rgb(35 27 27 / 7.5%),
				0 0 0 0.2em color-mix(in srgb, var(--rgh-limit-color) 30%, transparent);
		}
	}
}



================================================
FILE: source/features/suggest-commit-title-limit.tsx
================================================
import './suggest-commit-title-limit.css';

import delegate, {type DelegateEvent} from 'delegate-it';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import onCommitTitleUpdate from '../github-events/on-commit-title-update.js';
import getNextConversationNumber from '../github-helpers/get-next-conversation-number.js';
import {getConversationNumber} from '../github-helpers/index.js';
import {formatPrCommitTitle} from './sync-pr-commit-title.js';
import waitForPrMerge from '../github-events/on-pr-merge.js';
import abortableClassName from '../helpers/abortable-classname.js';

// https://github.com/refined-github/refined-github/issues/2178#issuecomment-505940703
const limit = 72;

function validateCommitTitle({delegateTarget: field}: DelegateEvent<Event, HTMLInputElement>): void {
	field.classList.toggle('rgh-title-over-limit', field.value.length > limit);
}

async function validatePrTitle({delegateTarget: field}: DelegateEvent<Event, HTMLInputElement>): Promise<void> {
	// Include the PR number in the title length calculation because it will be added to the commit title
	const prTitle = formatPrCommitTitle(
		field.value,
		getConversationNumber() ?? await getNextConversationNumber(),
	);
	field.classList.toggle('rgh-title-over-limit', prTitle.length > limit);
}

function unload(): void {
	features.unload(import.meta.url);
}

async function init(signal: AbortSignal): Promise<void> {
	abortableClassName(document.body, signal, 'rgh-suggest-commit-title-limit');
	onCommitTitleUpdate(validateCommitTitle, signal);
	delegate([
		'#issue_title',
		'#pull_request_title',
	], 'input', validatePrTitle, {signal, passive: true});
	await waitForPrMerge(signal);
	unload();
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isEditingFile,
		pageDetect.isCompare,
		pageDetect.isPR,
	],
	exclude: [
		// No need here https://github.com/refined-github/refined-github/issues/7922
		pageDetect.isMergedPR,
	],
	// DOM-based checks; event-based feature
	awaitDomReady: true,
	init,
});

/*

# Test data

## Commit title

123456789 123456789 123456789 123456789 123456789 123456789 123456789 123

## Test URLs

- Any mergeable PR
	- https://github.com/refined-github/sandbox/pull/8
- Any editable file
	- Markown: https://github.com/refined-github/refined-github/edit/main/readme.md
	- Workflow: https://github.com/refined-github/refined-github/edit/fix-commit-title-limit/.github/workflows/features.yml

*/



================================================
FILE: source/features/swap-branches-on-compare.tsx
================================================
import React from 'dom-chef';
import {$} from 'select-dom/strict.js';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import {buildRepoURL, getRepo} from '../github-helpers/index.js';

const isTwoDotDiff = (): boolean =>
	!location.pathname.includes('...')
	&& location.pathname.includes('..');

function init(): void {
	const {path} = getRepo()!;

	// `main...main` comparison
	if (path === 'compare') {
		return;
	}

	const references = path
		.replace('compare/', '')
		.split('...')
		.toReversed();

	// Compares against the "base" branch if the URL only has one reference
	if (references.length === 1) {
		references.unshift($('.branch span').textContent);
	}

	if (references[0] === references[1]) {
		return;
	}

	const referencePicker = $('.range-editor .d-inline-block + .range-cross-repo-pair');
	referencePicker.after(
		<a className="btn btn-sm mx-2" href={buildRepoURL('compare/' + references.join('...'))}>
			Swap
		</a>,
	);
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isCompare,
	],
	exclude: [
		// Disable on Two-dot Git diff comparison #4453
		isTwoDotDiff,
	],
	awaitDomReady: true,
	deduplicate: 'has-rgh',
	init,
});

/*
Test URLs:

- Compare: https://github.com/refined-github/refined-github/compare/23.2.1...main
- Blank but valid: https://github.com/refined-github/refined-github/compare/23.11.15.1433...23.11.15
- Blank but unswappable: https://github.com/refined-github/refined-github/compare
*/



================================================
FILE: source/features/sync-pr-commit-title.tsx
================================================
import React from 'dom-chef';
import {$, $optional} from 'select-dom/strict.js';
import delegate from 'delegate-it';
import * as pageDetect from 'github-url-detection';

import api from '../github-helpers/api.js';
import features from '../feature-manager.js';
import {getConversationNumber, userCanLikelyMergePR} from '../github-helpers/index.js';
import onCommitTitleUpdate from '../github-events/on-commit-title-update.js';
import observe from '../helpers/selector-observer.js';
import cleanPrCommitTitle from '../helpers/pr-commit-cleaner.js';

const prTitleFieldSelector = 'input#issue_title';
const commitTitleFieldSelector = '.is-squashing form:not([hidden]) input#merge_title_field';

function getCurrentCommitTitleField(): HTMLInputElement | undefined {
	return $optional(commitTitleFieldSelector);
}

function getCurrentCommitTitle(): string | undefined {
	return getCurrentCommitTitleField()?.value.trim();
}

export function formatPrCommitTitle(title: string, prNumber = getConversationNumber()!): string {
	return `${title} (#${prNumber})`;
}

function createCommitTitle(): string {
	const prTitle = $(prTitleFieldSelector).value.trim();
	return formatPrCommitTitle(prTitle);
}

function needsSubmission(): boolean {
	const currentCommitTitle = getCurrentCommitTitle();
	return Boolean(currentCommitTitle) && (createCommitTitle() !== currentCommitTitle);
}

function getUI(): HTMLElement {
	const cancelButton = <button type="button" className="btn-link Link--muted text-underline rgh-sync-pr-commit-title">Cancel</button>;
	return $optional('.rgh-sync-pr-commit-title-note') ?? (
		<p className="note rgh-sync-pr-commit-title-note">
			The title of this PR will be updated to match this title. {cancelButton}
		</p>
	);
}

function updateUI(): void {
	if (needsSubmission()) {
		getCurrentCommitTitleField()!.after(getUI());
	} else {
		getUI().remove();
	}
}

async function updatePRTitle(): Promise<void> {
	if (!needsSubmission()) {
		return;
	}

	// Remove PR number from commit title
	const title = cleanPrCommitTitle(getCurrentCommitTitle()!, getConversationNumber()!);

	await api.v3(`pulls/${getConversationNumber()!}`, {
		method: 'PATCH',
		body: {title},
	});
}

async function updateCommitTitle(): Promise<void> {
	const field = getCurrentCommitTitleField()!;
	if (field) {
		// Do not use `text-field-edit` #6348
		field.value = createCommitTitle();

		// There might be listeners that need to be notified
		field.dispatchEvent(new Event('input', {bubbles: true}));
	}
}

function disableSubmission(): void {
	features.unload(import.meta.url);
	getUI().remove();
}

function init(signal: AbortSignal): void {
	// PR title -> Commit title field
	observe(commitTitleFieldSelector, updateCommitTitle, {signal}); // On panel open
	observe('.gh-header-title', updateCommitTitle, {signal}); // On PR title change

	// Commit title field -> toggle checkbox visibility
	onCommitTitleUpdate(updateUI, signal);

	// On submission, update PR
	delegate('form.js-merge-pull-request', 'submit', updatePRTitle, {signal});

	// On "Cancel", disable the feature
	delegate('.rgh-sync-pr-commit-title', 'click', disableSubmission, {signal});
}

void features.add(import.meta.url, {
	asLongAs: [
		userCanLikelyMergePR,
	],
	include: [
		pageDetect.isPRConversation,
	],
	awaitDomReady: true, // DOM-based filters, feature appears at the end of the page
	init,
});

/*

Test URLs:

1. Open any PR in https://github.com/pulls

*/



================================================
FILE: source/features/tab-size.css
================================================
/*

This feature is documented at https://github.com/refined-github/refined-github/wiki/Customization#tab-size

*/

/*
GitHub doesnâ€™t apply the userâ€™s "tab size" setting in a few places, leaving the 8-character default.
This feature reduces it to 4 characters, while allowing GitHubâ€™s own tab size setting to override it in its children.

Thereâ€™s also one place where GitHub incorrectly uses the "user configuration" attribute to set it to 8, so weâ€™re explicitly overriding that. #4833

--tab-size is used to allow the user to override it and to be picked up by `show-whitespace`
*/

:root,
.comment-body .tab-size[data-tab-size='8'] {
	--tab-size: 4;

	tab-size: var(--tab-size);
}

/*

## Test URLs

- Rendered documents: https://github.com/refined-github/refined-github/blob/154c0f8c86b23e52d1e1ee947b90bc36bc6188ba/contributing.md#featuresadd
- Code blocks and embeds in conversations: https://github.com/refined-github/sandbox/pull/19
- The comment field everywhere

### Unaffected URLs

- isFile: https://github.com/refined-github/refined-github/blob/6979e88e6a7b3273338a2651ac4b533609ef97df/source/options.html
- isEditingFile: https://github.com/refined-github/refined-github/edit/main/source/options.html
- isGist: https://gist.github.com/kidonng/3ab6b5779e1a5a46984c14eecc0fc3a0

*/



================================================
FILE: source/features/tab-to-indent.tsx
================================================
import {eventHandler} from 'indent-textarea';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import {onCommentFieldKeydown} from '../github-events/on-field-keydown.js';

function init(signal: AbortSignal): void {
	onCommentFieldKeydown(eventHandler, signal);
}

void features.add(import.meta.url, {
	include: [
		pageDetect.hasRichTextEditor,
	],
	init,
});

/*

Test URLs:

https://github.com/refined-github/refined-github/issues/new?template=1_bug_report.yml

*/



================================================
FILE: source/features/table-input.css
================================================
:root {
	--rgh-table-input-size: 40px;
}

:root:root:root:root .rgh-table-input {
	font-size: var(--rgh-table-input-size);
	padding: 3px;
	z-index: 99;
	display: grid !important;
	grid-template: repeat(5, 1em) / repeat(5, 1em);
	width: fit-content;
	height: fit-content;
	margin: auto;
}

.ActionBar-item-container:has(.rgh-table-input) {
	overflow: visible;
}

:root .rgh-tic {
	padding: 1px;
	display: grid;
}

.rgh-tic::before {
	content: '';
	align-self: stretch;
	border: 2px solid var(--rgh-border-color, fuchsia);
	border-radius: 2px;
}

@media screen and (width >= 768px) {
	:root {
		/* #6511 */
		--rgh-table-input-size: 20px;
	}
}

.rgh-tic:hover::before,
/* Hovering the 1st column */
	.rgh-tic:is(:nth-of-type(5n + 1)):has(
		~ .rgh-tic:hover:nth-of-type(5n + 1)
	)::before,
/* Hovering the 2nd column */
	.rgh-tic:is(:nth-of-type(5n + 1), :nth-of-type(5n + 2)):has(
		~ .rgh-tic:hover:nth-of-type(5n + 2)
	)::before,
/* Hovering the 3rd column */
	.rgh-tic:not(:nth-of-type(5n + 4), :nth-of-type(5n + 5)):has(
		~ .rgh-tic:hover:nth-of-type(5n + 3)
	)::before,
/* Hovering the 4th column */
	.rgh-tic:not(:nth-of-type(5n + 5)):has(
		~ .rgh-tic:hover:nth-of-type(5n + 4)
	)::before,
/* Hovering the 5th column */
	.rgh-tic:has(~ .rgh-tic:hover:nth-of-type(5n + 5))::before {
	border-color: var(--borderColor-accent-muted, fuchsia);
	background-color: var(--bgColor-accent-muted, fuchsia);
}

/* https://github.com/refined-github/refined-github/issues/6515 */
.rgh-table-input .sentinel {
	display: none;
}



================================================
FILE: source/features/table-input.tsx
================================================
import './table-input.css';

import React from 'dom-chef';
import TableIcon from 'octicons-plain-react/Table';
import * as pageDetect from 'github-url-detection';
import {insertTextIntoField} from 'text-field-edit';
import delegate, {type DelegateEvent} from 'delegate-it';
import {$} from 'select-dom/strict.js';

import features from '../feature-manager.js';
import smartBlockWrap from '../helpers/smart-block-wrap.js';
import observe from '../helpers/selector-observer.js';
import {actionBarSelectors} from '../github-helpers/selectors.js';

function addTable({delegateTarget: square}: DelegateEvent<MouseEvent, HTMLButtonElement>): void {
	const container = square.closest('fieldset') // Issue
		?? square.form!.querySelector('.CommentBox-container')!; // PR
	const field = $('textarea', container);
	const cursorPosition = field.selectionStart;

	const columns = Number(square.dataset.x);
	const rows = Number(square.dataset.y);
	const row = columns === 1
		// One HTML line per row
		? '<tr><td>\n'

		// <tr> on its own line
		// "1 space" indents without causing unwanted Markdown code blocks that 4 spaces would cause
		: '<tr>\n' + ' <td>\n'.repeat(columns);
	field.focus();
	const table = '<table>\n' + row.repeat(rows) + '</table>';
	insertTextIntoField(field, smartBlockWrap(table, field));

	// Move caret to first cell
	field.selectionEnd = field.value.indexOf('<td>', cursorPosition) + '<td>'.length;
}

function append(container: HTMLElement): void {
	container.classList.add('d-flex');

	container.append(
		<details className="details-reset details-overlay select-menu select-menu-modal-right hx_rsm">
			<summary
				className="Button Button--iconOnly Button--invisible Button--medium"
				role="button"
				aria-label="Add a table"
				aria-haspopup="menu"
			>
				<div
					className="tooltipped tooltipped-sw"
					aria-label="Add a table"
				>
					<TableIcon />
				</div>
			</summary>
			<details-menu
				className="select-menu-modal position-absolute right-0 hx_rsm-modal rgh-table-input"
				role="menu"
			>
				{Array.from({length: 25}).map((_, index) => (
					<button
						type="button"
						role="menuitem"
						className="rgh-tic btn-link"
						data-x={(index % 5) + 1}
						data-y={Math.floor(index / 5) + 1}
					/>
				))}
			</details-menu>
		</details>,
	);
}

function init(signal: AbortSignal): void {
	observe(actionBarSelectors, append, {signal});
	delegate('.rgh-tic', 'click', addTable, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.hasRichTextEditor,
	],
	init,
});

/*

Test URLs:

- Any issue or PR

*/



================================================
FILE: source/features/tag-changes-link.css
================================================
/* Don't break layout on mobile (https://primer.style/css/support/breakpoints) */
@media (width >= 768px) {
	/* Reserve some space above the "Compare" dropdown (the selector will be disabled as soon as the "Changelog" link is inserted) */
	.rgh-tag-changes-link .repository-content
		.my-5
		> :first-child
		> :nth-child(5):not(.rgh-changelog-link) {
		/* 21px is the height of the link that is being inserted https://user-images.githubusercontent.com/1402241/103394704-bf2d7a80-4aef-11eb-8377-5c59b46cc2b3.png */
		padding-top: 21px !important;
	}
}



================================================
FILE: source/features/tag-changes-link.tsx
================================================
import './tag-changes-link.css';

import React from 'dom-chef';
import {$$, elementExists} from 'select-dom';
import {$, $optional} from 'select-dom/strict.js';
import domLoaded from 'dom-loaded';
import DiffIcon from 'octicons-plain-react/Diff';
import * as pageDetect from 'github-url-detection';
import tinyVersionCompare from 'tiny-version-compare';

import features from '../feature-manager.js';
import fetchDom from '../helpers/fetch-dom.js';
import {buildRepoURL, getRepo, parseTag} from '../github-helpers/index.js';

type TagDetails = {
	element: HTMLElement;
	commit: string;
	tag: string;
	version: string;
	namespace: string;
};

async function getNextPage(): Promise<DocumentFragment> {
	const nextPageLink = $optional('.pagination a:last-child');
	if (nextPageLink) {
		return fetchDom(nextPageLink.href);
	}

	if (pageDetect.isSingleReleaseOrTag()) {
		const [, tag = ''] = getRepo()!.path.split('releases/tag/', 2); // Already URL-encoded
		return fetchDom(buildRepoURL(`tags?after=${tag}`));
	}

	return new DocumentFragment();
}

function parseTags(element: HTMLElement): TagDetails {
	// DO NOT change this to `pathname` because it's empty when element is from `getNextPage` function
	// https://github.com/refined-github/refined-github/pull/7726#discussion_r1727135015
	const tagUrl = $(['a[href*="/tree/"]', 'a[href*="/tag/"]'], element).href;
	const tag = /\/(?:releases\/tag|tree)\/(.*)/.exec(tagUrl)![1];

	return {
		element,
		tag,
		commit: $('[href*="/commit/"]', element).textContent.trim(),
		...parseTag(decodeURIComponent(tag)), // `version`, `namespace`
	};
}

function getPreviousTag(current: number, allTags: TagDetails[]): string | undefined {
	let unmatchedNamespaceTag: string | undefined;

	for (let next = current + 1; next < allTags.length; next++) {
		// Find a version on a different commit, if there are multiple tags on the same one
		if (allTags[next].commit === allTags[current].commit) {
			continue;
		}

		// Find an earlier version
		if (tinyVersionCompare(allTags[current].version, allTags[next].version) < 1) {
			continue;
		}

		if (allTags[current].namespace === allTags[next].namespace) {
			return allTags[next].tag;
		}

		// If no matching namespace is found, just use the next one
		unmatchedNamespaceTag ??= allTags[next].tag;
	}

	return unmatchedNamespaceTag;
}

async function init(): Promise<void> {
	document.documentElement.classList.add('rgh-tag-changes-link');

	const tagsSelector = [
		// https://github.com/facebook/react/releases (release in releases list)
		'.repository-content .col-md-2',

		// https://github.com/facebook/react/tags (tags list)
		'.Box-row .commit',

		// https://github.com/facebook/react/releases/tag/v17.0.2 (single release page)
		'.Box-body .border-md-bottom',
	];

	await domLoaded;
	// Look for tags in the current page and the next page
	const pages = [document, await getNextPage()];
	const allTags = $$(tagsSelector, pages).map(tag => parseTags(tag));

	for (const [index, container] of allTags.entries()) {
		const previousTag = getPreviousTag(index, allTags);
		if (!previousTag) {
			continue;
		}

		const lastLinks = $$([
			'.Link--muted[data-hovercard-type="commit"]', // Link to commit in release sidebar
			'.list-style-none > .d-inline-block:last-child', // Link to source tarball under release tag
		], container.element);
		for (const lastLink of lastLinks) {
			const currentTag = allTags[index].tag;
			const compareLink = (
				<a
					className="Link--muted tooltipped tooltipped-n"
					aria-label={`See commits between ${decodeURIComponent(previousTag)} and ${decodeURIComponent(currentTag)}`}
					href={buildRepoURL(`compare/${previousTag}...${currentTag}`)}
				>
					<DiffIcon /> {pageDetect.isEnterprise() ? 'Commits' : <span className="ml-1 wb-break-all">Commits</span>}
				</a>
			);

			// The page of a tag without a release still uses the old layout #5037
			if (pageDetect.isEnterprise() || pageDetect.isTags() || (pageDetect.isSingleReleaseOrTag() && elementExists('.release'))) {
				lastLink.after(
					<li className={lastLink.className + ' rgh-changelog-link'}>
						{compareLink}
					</li>,
				);
				// Fix spacing issue when the window is < 700px wide https://github.com/refined-github/refined-github/pull/3841#issuecomment-754325056
				lastLink.classList.remove('flex-auto');
				continue;
			}

			lastLink.parentElement!.after(
				<div className={'rgh-changelog-link ' + (pageDetect.isReleases() ? 'mb-md-2 mr-3 mr-md-0' : 'mr-4 mb-2')}>
					{compareLink}
				</div>,
			);
			if (pageDetect.isReleases()) {
				lastLink.classList.remove('mb-2');
				lastLink.parentElement!.classList.remove('mb-md-2');
			}
		}
	}
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isReleasesOrTags,
		pageDetect.isSingleReleaseOrTag,
	],
	exclude: [
		pageDetect.isEmptyRepoRoot,
	],
	deduplicate: 'has-rgh-inner',
	init,
});

/*

Test URLs:

- https://github.com/refined-github/refined-github/releases
- https://github.com/refined-github/refined-github/tags
- https://github.com/refined-github/refined-github/releases/tag/23.2.5

*/



================================================
FILE: source/features/tags-on-commits-list.gql
================================================
query GetTagsOnCommit(
	$owner: String!
	$name: String!
	$commit: String!
	$after: String
) {
	repository(owner: $owner, name: $name) {
		refs(
			first: 100
			refPrefix: "refs/tags/"
			orderBy: { field: TAG_COMMIT_DATE, direction: DESC }
			after: $after
		) {
			pageInfo {
				hasNextPage
				endCursor
			}
			nodes {
				name
				target {
					commitResourcePath
					... on Tag {
						tagger {
							date
						}
					}
					... on Commit {
						committedDate
					}
				}
			}
		}
		object(expression: $commit) {
			... on Commit {
				committedDate
			}
		}
	}
}



================================================
FILE: source/features/tags-on-commits-list.tsx
================================================
import React from 'dom-chef';
import cache from 'webext-storage-cache/legacy.js';
import {$, $$, $$optional} from 'select-dom/strict.js';

import TagIcon from 'octicons-plain-react/Tag';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import api from '../github-helpers/api.js';
import {getCommitHash} from './mark-merge-commits-in-list.js';
import {buildRepoURL, getRepo} from '../github-helpers/index.js';
import GetTagsOnCommit from './tags-on-commits-list.gql';
import {expectToken} from '../github-helpers/github-token.js';
import delay from '../helpers/delay.js';

type CommitTags = Record<string, string[]>;

const arrayUnion = (x: string[], y: string[]): string[] => [...new Set([...x, ...y])];

type BaseTarget = {
	commitResourcePath: string;
};

type TagTarget = {
	tagger: {
		date: Date;
	};
} & BaseTarget;

type CommitTarget = {
	committedDate: Date;
} & BaseTarget;

type CommonTarget = TagTarget | CommitTarget;
type TagNode = {
	name: string;
	target: CommonTarget;
};

function mergeTags(oldTags: CommitTags, newTags: CommitTags): CommitTags {
	const result: CommitTags = {...oldTags};
	for (const commit of Object.keys(newTags)) {
		result[commit] = result[commit]
			? arrayUnion(result[commit], newTags[commit])
			: newTags[commit];
	}

	return result;
}

function isTagTarget(target: CommonTarget): target is TagTarget {
	return 'tagger' in target;
}

async function getTags(lastCommit: string, after?: string): Promise<CommitTags> {
	const {repository} = await api.v4(GetTagsOnCommit, {
		variables: {
			commit: lastCommit,
			...after && {after},
		},
	});
	const nodes = repository.refs.nodes as TagNode[];

	// If there are no tags in the repository
	if (nodes.length === 0) {
		return {};
	}

	let tags: CommitTags = {};
	for (const node of nodes) {
		if (node.name === 'nightly') {
			continue;
		}

		const commit = node.target.commitResourcePath.split('/')[4];
		tags[commit] ||= [];

		tags[commit].push(node.name);
	}

	const lastTag = nodes.at(-1)!.target;
	const lastTagIsYounger = new Date(repository.object.committedDate) < new Date(isTagTarget(lastTag) ? lastTag.tagger.date : lastTag.committedDate);

	// If the last tag is newer than last commit on the page, then not all commits are accounted for, keep looking
	if (lastTagIsYounger && repository.refs.pageInfo.hasNextPage) {
		tags = mergeTags(tags, await getTags(lastCommit, repository.refs.pageInfo.endCursor));
	}

	// There are no tags for this commit
	return tags;
}

async function init(): Promise<void | false> {
	await expectToken();
	const cacheKey = `tags:${getRepo()!.nameWithOwner}`;

	let commitsOnPage = $$optional('[data-testid="commit-row-item"]');
	if (commitsOnPage.length === 0) {
		// Try waiting a bit longer
		// https://github.com/refined-github/refined-github/issues/7954
		await delay(1000);
		commitsOnPage = $$('[data-testid="commit-row-item"]');
	}

	const lastCommitOnPage = getCommitHash(commitsOnPage.at(-1)!);
	let cached = await cache.get<Record<string, string[]>>(cacheKey) ?? {};
	const commitsWithNoTags = [];
	for (const commit of commitsOnPage) {
		const targetCommit = getCommitHash(commit);
		let targetTags = cached[targetCommit];

		if (!targetTags) {
			// No tags for this commit found in the cache, check in github
			cached = mergeTags(cached, await getTags(lastCommitOnPage)); // eslint-disable-line no-await-in-loop
			targetTags = cached[targetCommit];
		}

		if (!targetTags) {
			// There was no tag for this commit, save that info to the cache
			commitsWithNoTags.push(targetCommit);
		} else if (targetTags.length > 0) {
			const commitMeta = $([
				'div[data-testid="list-view-item-description"]',
				'[class^="Description-module__container"]',
			], commit);

			commitMeta.append(
				<div className="ml-1 d-flex flex-items-center gap-1">
					<TagIcon />
					<span className="d-flex flex-wrap gap-1">
						{...targetTags.map(tag => (
							<>
								{' '}
								{/* .markdown-title enables the background color */}
								<a
									className="Link--muted markdown-title"
									href={buildRepoURL('releases/tag', tag)}
								>
									<code>{tag}</code>
								</a>
							</>
						))}
					</span>
				</div>,
			);
			commit.classList.add('rgh-tagged');
		}
	}

	if (commitsWithNoTags.length > 0) {
		for (const commit of commitsWithNoTags) {
			cached[commit] = [];
		}
	}

	await cache.set(cacheKey, cached, {days: 1});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isRepoCommitList,
	],
	awaitDomReady: true,
	deduplicate: 'has-rgh-inner',
	init,
});

/*

Test URLs:

https://github.com/refined-github/refined-github/commits/19.5.21.1921

*/



================================================
FILE: source/features/toggle-everything-with-alt.tsx
================================================
import delegate from 'delegate-it';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import clickAll from '../helpers/click-all.js';

function minimizedCommentsSelector(clickedItem: HTMLElement): string {
	const open = (clickedItem.parentElement as HTMLDetailsElement).open ? '[open]' : ':not([open])';
	return `.minimized-comment > details${open} > summary`;
}

const diffsSelector = '.js-file .js-diff-load';

function resolvedCommentsSelector(clickedItem: HTMLElement): string {
	return `.js-resolvable-thread-toggler[aria-expanded="${clickedItem.getAttribute('aria-expanded')!}"]:not(.d-none)`;
}

const expandSelector = '.js-file .js-expand-full';

const collapseSelector = '.js-file .js-collapse-diff';

const commitMessageSelector = 'button[data-testid="commit-row-show-description-button"]';

const addSuggestionToBatchSelector = ':is(.js-apply-changes button[data-variant="primary"], .js-batched-suggested-changes-add)';

function markdownCommentSelector(clickedItem: HTMLElement): string {
	const {id} = clickedItem.closest('.TimelineItem-body[id]')!;
	return `#${id} .markdown-body details > summary`;
}

function init(signal: AbortSignal): void {
	// Collapsed comments in PR conversations and files
	delegate('.minimized-comment details summary', 'click', clickAll(minimizedCommentsSelector), {signal});

	// "Load diff" buttons in PR files
	delegate(diffsSelector, 'click', clickAll(diffsSelector), {signal});

	// Review comments in PR
	delegate('.js-file .js-resolvable-thread-toggler', 'click', clickAll(resolvedCommentsSelector), {signal});

	// "Expand all" and "Collapse expanded lines" buttons in commit files
	delegate(expandSelector, 'click', clickAll(expandSelector), {signal});
	delegate(collapseSelector, 'click', clickAll(collapseSelector), {signal});

	// Commit message buttons in commit lists and PR conversations
	delegate(commitMessageSelector, 'click', clickAll(commitMessageSelector), {signal});

	// <details> elements in issue/PR comment Markdown content
	delegate('.TimelineItem-body[id] .markdown-body details > summary', 'click', clickAll(markdownCommentSelector), {signal});

	// "Add suggestion to batch" buttons in PR files
	delegate(addSuggestionToBatchSelector, 'click', clickAll(addSuggestionToBatchSelector), {signal, capture: true});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isConversation,
		pageDetect.hasFiles,
		pageDetect.isCommitList,
		pageDetect.isPRFiles,
	],
	init,
});

/*

Test URLs:

Collapsed comments:
- PR conversations: https://github.com/refined-github/refined-github/pull/1694
- PR files: https://github.com/refined-github/refined-github/pull/1896/files
- Issue conversations: https://github.com/refined-github/refined-github/issues/4008

Load diff in PR files: https://github.com/parcel-bundler/parcel/pull/2967/files
Expand all in PR files: https://github.com/refined-github/refined-github/pull/4585/files

Commit messages:
- isPRConversation: https://github.com/refined-github/refined-github/pull//5324
- isCommitList: https://github.com/torvalds/linux/commits/master

<details> elements:
- Issue: https://github.com/yakov116/TestR/issues/34
- PR description: https://github.com/OpenLightingProject/open-fixture-library/pull/2455
- PR comment: https://github.com/OpenLightingProject/open-fixture-library/pull/2453#issuecomment-1055672394

Add suggestion to batch: https://github.com/refined-github/sandbox/pull/121/changes
*/



================================================
FILE: source/features/unclip-checks.css
================================================
.rgh-unclip-checks [class*='MergeBoxExpandable-module'] {
	max-height: none !important;
}



================================================
FILE: source/features/unclip-checks.tsx
================================================
import './unclip-checks.css';
import * as pageDetect from 'github-url-detection';
import delegate, {type DelegateEvent} from 'delegate-it';

import features from '../feature-manager.js';

function init(signal: AbortSignal): void {
	delegate(
		'button[aria-label="Expand checks"]',
		'click',
		({delegateTarget}: DelegateEvent<MouseEvent, HTMLButtonElement>) => {
			delegateTarget.closest('section[aria-label="Checks"]')!.classList.add('rgh-unclip-checks');
		},
		{signal, capture: true},
	);
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isPRConversation,
	],
	init,
});

/*

Test URLs:

https://togithub.com/facebook/react/pull/34051

*/



================================================
FILE: source/features/unfinished-comments.tsx
================================================
import {$$} from 'select-dom';
import delegate from 'delegate-it';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';

let submitting: ReturnType<typeof setTimeout> | undefined;

const prefix = 'âœï¸ Comment - ';

function isFieldDirty(field: HTMLTextAreaElement): boolean {
	return field.matches('[class*="Textarea__StyledTextarea"]')
		? field.value.length > 0 // React fields update both value and textContent, so default to "filled === dirty"
		: field.value !== field.textContent;
}

function hasDraftComments(): boolean {
	// `[id^="convert-to-issue-body"]` excludes the hidden pre-filled textareas created when opening the dropdown menu of review comments
	return $$('textarea:not([id^="convert-to-issue-body"])').some(f => isFieldDirty(f));
}

function disableOnSubmit(): void {
	clearTimeout(submitting);
	submitting = setTimeout(() => {
		submitting = undefined;
	}, 2000);
}

function updateDocumentTitle(): void {
	if (submitting) {
		return;
	}

	// Ensure it does not pile up
	document.title = document.title.replace(prefix, '');

	if (document.visibilityState === 'hidden' && hasDraftComments()) {
		document.title = prefix + document.title;
	} else {
		document.title = document.title.replace(prefix, '');
	}
}

function init(signal: AbortSignal): void {
	delegate('form', 'submit', disableOnSubmit, {capture: true, signal});
	document.addEventListener('visibilitychange', updateDocumentTitle, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.hasRichTextEditor,
	],
	init,
});

/*

Test URLs:

https://github.com/refined-github/sandbox/pull/4

*/



================================================
FILE: source/features/unread-anywhere.tsx
================================================
import {$$optional, $optional} from 'select-dom/strict.js';
import {messageRuntime} from 'webext-msg';
import React from 'dom-chef';
import * as pageDetect from 'github-url-detection';
import ArrowUpRightIcon from 'octicons-plain-react/ArrowUpRight';

import features from '../feature-manager.js';
import {registerHotkey} from '../github-helpers/hotkey.js';
import onetime from '../helpers/onetime.js';
import showToast from '../github-helpers/toast.js';
import {fetchDomUncached} from '../helpers/fetch-dom.js';
import pluralize from '../helpers/pluralize.js';
import {removeLinkToPRFilesTab} from './pr-notification-link.js';
import observe from '../helpers/selector-observer.js';
import {getClasses, isSmallDevice} from '../helpers/dom-utils.js';

const limit = 5;

async function openUnreadNotifications(event?: React.MouseEvent): Promise<void> {
	if (event?.target instanceof HTMLButtonElement) {
		// Hide the tooltip
		event.target.blur();
		event.target.disabled = true; // Prevent multiple clicks
	}

	await showToast(async updateToast => {
		const page = await fetchDomUncached('/notifications?query=is%3Aunread');

		const notifications = $$optional('a.js-navigation-open', page);
		if (notifications.length === 0) {
			updateToast('No unread notifications');
			return;
		}

		updateToast('Openingâ€¦');
		const urls = notifications.slice(0, limit).map(notification => {
			removeLinkToPRFilesTab(notification); // Internally limited to PR Files links
			return notification.href;
		});

		await messageRuntime({
			openUrls: urls,
		});

		if (notifications.length > limit) {
			updateToast(`Opened the last ${limit} unread notifications`);
		} else {
			updateToast(pluralize(urls.length, '$$ notification') + ' opened');
			// Update the UI too. Optional because the UI is often out of date
			$optional('.AppHeader-button--hasIndicator')?.classList.remove('AppHeader-button--hasIndicator');
		}
	}, {
		message: 'Loading notificationsâ€¦',
		doneMessage: false,
	}).finally(() => {
		if (event?.target instanceof HTMLButtonElement) {
			event.target.disabled = false;
		}
	});
}

function addButton(nativeLink: HTMLAnchorElement): void {
	const classes = getClasses(nativeLink);
	classes.delete('AppHeader-button--hasIndicator');
	// Reverse order so that the new button is painted below the "unread indicator"
	nativeLink.parentElement!.classList.add('d-flex', 'flex-row-reverse');
	nativeLink.classList.add('AppHeader-buttonLeft');
	const button = (
		<button
			type="button"
			onClick={openUnreadNotifications}
			// Show pointer cursor even when disabled
			style={{width: 10, cursor: 'pointer'}}

			// JSX swallows \n if you skip {''}
			aria-label={'Open unread notifications\nHotkey: g u'}
		>
			<ArrowUpRightIcon className="mb-2" />
		</button>
	);
	nativeLink.before(button);
	button.classList.add(
		...classes,
		'AppHeader-buttonRight',
		'tooltipped',
		'tooltipped-sw',
	);
}

// No signal, created once per load
function initOnce(): void {
	registerHotkey('g u', openUnreadNotifications);
	document.documentElement.classList.add('rgh-unread-anywhere');
	observe('a#AppHeader-notifications-button.AppHeader-button--hasIndicator', addButton);
}

void features.add(import.meta.url, {
	shortcuts: {
		'g u': 'Open all unread notifications from anywhere',
	},
	exclude: [
		// Disable the feature entirely on small screens
		isSmallDevice,

		// Can't work on gists due to CORS: https://github.com/refined-github/refined-github/issues/8641
		pageDetect.isGist,
	],
	init: onetime(initOnce),
});

/*

Test URLs: anywhere :)

*/



================================================
FILE: source/features/unreleased-commits.gql
================================================
query GetPublishRepoState($owner: String!, $name: String!) {
	repository(owner: $owner, name: $name) {
		refs(
			first: 20
			refPrefix: "refs/tags/"
			orderBy: { field: TAG_COMMIT_DATE, direction: DESC }
		) {
			nodes {
				name
				tag: target {
					oid
					... on Tag {
						commit: target {
							oid
						}
					}
				}
			}
		}
		defaultBranchRef {
			target {
				... on Commit {
					history(first: 20) {
						nodes {
							oid
						}
					}
				}
			}
		}
	}
}



================================================
FILE: source/features/unreleased-commits.tsx
================================================
import React from 'dom-chef';
import {CachedFunction} from 'webext-storage-cache';
import * as pageDetect from 'github-url-detection';
import PlusIcon from 'octicons-plain-react/Plus';
import TagIcon from 'octicons-plain-react/Tag';
import {elementExists} from 'select-dom';
import {$optional} from 'select-dom/strict.js';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';
import api from '../github-helpers/api.js';
import {
	buildRepoURL,
	cacheByRepo,
	getLatestVersionTag,
	getRepo,
} from '../github-helpers/index.js';
import isDefaultBranch from '../github-helpers/is-default-branch.js';
import pluralize from '../helpers/pluralize.js';
import {branchSelector} from '../github-helpers/selectors.js';
import getPublishRepoState from './unreleased-commits.gql';
import getDefaultBranch from '../github-helpers/get-default-branch.js';
import abbreviateString from '../helpers/abbreviate-string.js';
import {wrapAll} from '../helpers/dom-utils.js';
import {groupButtons} from '../github-helpers/group-buttons.js';
import {expectToken} from '../github-helpers/github-token.js';
import {userHasPushAccess} from '../github-helpers/get-user-permission.js';

type RepoPublishState = {
	latestTag: string | false;
	aheadBy: number;
};

type Tags = {
	name: string;
	tag: {
		oid: string;
		commit?: {
			oid: string;
		};
	};
};

const undeterminableAheadBy = Number.MAX_SAFE_INTEGER; // For when the branch is ahead by more than 20 commits #5505

const repoPublishState = new CachedFunction('tag-ahead-by', {
	async updater(): Promise<RepoPublishState> {
		const {repository} = await api.v4(getPublishRepoState);

		if (repository.refs.nodes.length === 0) {
			return {
				latestTag: false,
				aheadBy: 0,
			};
		}

		const tags = new Map<string, string>();
		for (const node of repository.refs.nodes as Tags[]) {
			tags.set(node.name, node.tag.commit?.oid ?? node.tag.oid);
		}

		// If this logic ever gets dropped or becomes simpler, consider using the native "compare" API
		// https://github.com/refined-github/refined-github/issues/6094
		const latestTag = getLatestVersionTag([...tags.keys()]);
		const latestTagOid = tags.get(latestTag)!;
		const aheadBy = repository.defaultBranchRef.target.history.nodes.findIndex((node: AnyObject) => node.oid === latestTagOid);

		return {
			latestTag,
			aheadBy: aheadBy === -1 ? undeterminableAheadBy : aheadBy,
		};
	},
	maxAge: {hours: 1},
	staleWhileRevalidate: {days: 2},
	cacheKey: cacheByRepo,
});

async function createLink(
	latestTag: string,
	aheadBy: number,
): Promise<HTMLElement> {
	const commitCount
		= aheadBy === undeterminableAheadBy
			? 'More than 20 unreleased commits'
			: pluralize(aheadBy, '$$ unreleased commit');
	const label = `${commitCount}\nsince ${abbreviateString(latestTag, 30)}`;

	return (
		<a
			className="btn px-2 tooltipped tooltipped-se"
			href={buildRepoURL('compare', `${latestTag}...${await getDefaultBranch()}`)}
			aria-label={label}
		>
			<TagIcon className="v-align-middle" />
			{aheadBy === undeterminableAheadBy || <sup className="ml-n2"> +{aheadBy}</sup>}
		</a>
	);
}

async function createLinkGroup(latestTag: string, aheadBy: number): Promise<HTMLElement> {
	const link = await createLink(latestTag, aheadBy);
	if (!(await userHasPushAccess())) {
		return link;
	}

	return groupButtons([
		link,
		// `aria-label` wording taken from $user/$repo/releases page
		<a
			href={buildRepoURL('releases/new')}
			className="btn px-2 tooltipped tooltipped-se"
			aria-label="Draft a new release"
			data-turbo-frame="repo-content-turbo-frame"
		>
			<PlusIcon className="v-align-middle" />
		</a>,
	]);
}

async function addToHome(branchSelector: HTMLButtonElement): Promise<void> {
	// React issues. Duplicates appear after a color scheme update
	// https://github.com/refined-github/refined-github/issues/7536
	if (elementExists('.rgh-unreleased-commits-wrapper')) {
		return;
	}

	const {latestTag, aheadBy} = await repoPublishState.get();
	const isAhead = aheadBy > 0;

	if (!latestTag || !isAhead) {
		return;
	}

	const linkGroup = await createLinkGroup(latestTag, aheadBy);
	linkGroup.style.flexShrink = '0';

	wrapAll(
		<div className="d-flex gap-2 rgh-unreleased-commits-wrapper" />,
		branchSelector,
		linkGroup,
	);
}

async function addToReleases(releasesFilter: HTMLInputElement): Promise<void> {
	const {latestTag, aheadBy} = await repoPublishState.get();
	const isAhead = aheadBy > 0;

	if (!latestTag || !isAhead) {
		return;
	}

	const widget = await createLink(latestTag, aheadBy);

	// Prepend it to the existing "Draft a new release" button to match the button on the repo home
	const newReleaseButton = $optional('nav + div a[href$="/releases/new"]');
	if (newReleaseButton) {
		newReleaseButton.before(widget);
		groupButtons([
			widget,
			newReleaseButton,
		]);
		return;
	}

	// Otherwise, add it before filter input
	releasesFilter.form!.before(widget);
	releasesFilter.form!.parentElement!.classList.add('d-flex', 'flex-items-start');
	// The form has .ml-md-2, this restores it on `sm`
	widget.classList.add('mr-md-0', 'mr-2');
}

async function initHome(signal: AbortSignal): Promise<void> {
	await expectToken();
	observe(branchSelector, addToHome, {signal});
}

async function initReleases(signal: AbortSignal): Promise<void> {
	await expectToken();
	observe('input#release-filter', addToReleases, {signal});
}

void features.add(import.meta.url, {
	asLongAs: [
		isDefaultBranch,
	],
	include: [
		pageDetect.isRepoHome,
	],
	init: initHome,
}, {
	include: [
		// Only first page of Releases
		() => getRepo()?.path === 'releases',
	],
	init: initReleases,
});

/*

Test URLs

Repo with no tags (no button)
https://github.com/refined-github/yolo

Repo with too many unreleased commits
https://github.com/refined-github/sandbox

Repo with some unreleased commits
https://github.com/refined-github/refined-github

Releases page with unreleased commits
https://github.com/facebook/react/releases

Releases page with unreleased commits (user can release)
https://github.com/refined-github/refined-github/releases

Releases page with changelog file
https://github.com/fczbkk/css-selector-generator/releases

*/



================================================
FILE: source/features/unwrap-unnecessary-dropdowns.tsx
================================================
import {$, $$, $$optional} from 'select-dom/strict.js';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';

// Replace dropdown while keeping its sizing/positioning classes
function replaceDropdownInPlace(dropdown: Element, form: Element): void {
	dropdown.replaceWith(form);
	form.classList.add(...dropdown.classList);
	form.classList.remove('dropdown', 'details-reset', 'details-overlay');
}

function replaceNotificationsDropdown(): void {
	const forms = $$optional('[action="/notifications/beta/update_view_preference"]');

	if (forms.length === 0) {
		return;
	}

	if (forms.length > 2) {
		throw new Error('GitHub added new view types. This feature is obsolete.');
	}

	const dropdown = forms[0].closest('action-menu')!;
	const currentView = $('.Button-label span:last-child', dropdown).textContent.trim();
	const desiredForm = currentView === 'Date' ? forms[0] : forms[1];

	// Replace dropdown
	replaceDropdownInPlace(dropdown, desiredForm);

	// Fix buttonâ€™s style
	const button = $('[type="submit"]', desiredForm);
	button.className = 'btn';
	button.textContent = `Group by ${button.textContent.toLowerCase()}`;
}

function replaceRerunDropdown(menu: Element): void {
	const triggerButton = $('focus-group > button', menu);

	// We only need to unwrap the re-run jobs menu
	if (triggerButton.textContent.trim() !== 'Re-run jobs') {
		return;
	}

	const container = menu.parentElement!;

	for (const button of $$('button.ActionListContent', menu)) {
		button.className = 'Button--secondary Button--medium Button';
		container.append(button.cloneNode(true));
	}

	container.classList.add('d-flex', 'gap-2');
	menu.classList.add('d-none');
}

function unwrapNotifications(signal: AbortSignal): void {
	observe('.js-check-all-container > :first-child', replaceNotificationsDropdown, {signal});
}

function unwrapRerunActions(signal: AbortSignal): void {
	observe('.PageHeader-actions action-menu', replaceRerunDropdown, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isNotifications,
	],
	init: unwrapNotifications,
}, {
	include: [
		pageDetect.isActionRun,
	],
	init: unwrapRerunActions,
});

/*

Test URLs:

- https://github.com/notifications
- https://github.com/refined-github/refined-github/actions/runs/16143473286?pr=8544

*/



================================================
FILE: source/features/update-pr-from-base-branch.tsx
================================================
import React from 'dom-chef';
import {elementExists} from 'select-dom';
import {$, $optional} from 'select-dom/strict.js';
import * as pageDetect from 'github-url-detection';
import delegate, {type DelegateEvent} from 'delegate-it';
import CheckIcon from 'octicons-plain-react/Check';
import {CachedFunction} from 'webext-storage-cache';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';
import api from '../github-helpers/api.js';
import {getBranches} from '../github-helpers/pr-branches.js';
import getPrInfo from '../github-helpers/get-pr-info.js';
import showToast from '../github-helpers/toast.js';
import {getConversationNumber, getRepo} from '../github-helpers/index.js';
import createMergeabilityRow from '../github-widgets/mergeability-row.js';
import {expectToken} from '../github-helpers/github-token.js';
import {deletedHeadRepository, prMergeabilityBoxHeader} from '../github-helpers/selectors.js';

// TODO: Use CachedMap after https://github.com/fregante/webext-storage-cache/issues/51
const nativeRepos = new CachedFunction('native-update-button', {
	maxAge: {
		days: 10,
	},
	staleWhileRevalidate: {
		days: 1,
	},
	async updater(_nameWithOwner: string): Promise<boolean> {
		throw new TypeError('bad usage');
	},
});

function canNativelyUpdate(): boolean {
	if (elementExists('.js-update-branch-form')) {
		return true;
	}

	const nativeButton = $optional('[aria-label="Conflicts"] [class^="MergeBoxSectionHeader-module__wrapper"] [data-component="buttonContent"]');
	return nativeButton?.textContent === 'Update branch';
}

async function disableFeatureOnRepo(): Promise<void> {
	const repo = getRepo()!.nameWithOwner;
	console.trace('Refined GitHub: Disabling `update-pr-from-base-branch` on', repo);
	features.unload(import.meta.url);
	await nativeRepos.applyOverride([repo], true);
}

async function mergeBranches(): Promise<AnyObject> {
	return api.v3(`pulls/${getConversationNumber()!}/update-branch`, {
		method: 'PUT',
		ignoreHTTPStatus: true,
	});
}

async function handler({delegateTarget: button}: DelegateEvent<MouseEvent, HTMLButtonElement>): Promise<void> {
	button.disabled = true;
	await showToast(async () => {
		// Reads Error#message or GitHubâ€™s "message" response
		// eslint-disable-next-line @typescript-eslint/use-unknown-in-catch-callback-variable -- Just pass it along
		const response = await mergeBranches().catch(error => error);
		if (response instanceof Error || !response.ok) {
			throw new Error(`Error updating the branch: ${response.message as string}`, {cause: response});
		}
	}, {
		message: 'Updating branchâ€¦',
		doneMessage: 'Branch updated',
	});

	button.remove();
}

function createButton(): JSX.Element {
	return (
		<button
			type="button"
			className="btn btn-sm rgh-update-pr-from-base-branch tooltipped tooltipped-w"
			aria-label="Use Refined GitHub to update the PR from the base branch"
		>
			Update branch
		</button>
	);
}

async function addButton(): Promise<void> {
	if (canNativelyUpdate()) {
		// Ideally the "canNativelyUpdate" observer is fired first and this listener isn't reached, but that is not guaranteed.
		await disableFeatureOnRepo();
		return;
	}

	const mergeBar = $([
		'.mergeability-details > *:last-child',
		'[class^="MergeBox-module__mergePartialContainer"]',
	]);

	const {base} = getBranches();
	const prInfo = await getPrInfo(base.relative);
	const hasBranchAccess = ['ADMIN', 'WRITE'].includes(prInfo.headRepoPerm); // #8555
	if (
		!prInfo.needsUpdate
		|| prInfo.mergeable === 'CONFLICTING'
		|| !(
			prInfo.viewerCanUpdate
			|| prInfo.viewerCanEditFiles
			|| hasBranchAccess
		)
	) {
		return;
	}

	const mergeabilityRow = $optional([
		'.branch-action-item:has(.merging-body)', // TODO: Drop after June 2025
		'[aria-label="Conflicts"] [class^="MergeBoxSectionHeader-module__wrapper"]',
	]);

	if (mergeabilityRow) {
		const isOldView = mergeBar.parentElement?.classList.contains('mergeability-details');
		const positionClass = isOldView
			? 'float-right'
			: 'flex-order-2 flex-self-center';

		mergeabilityRow.prepend(
			<div
				className={['branch-action-btn js-immediate-updates js-needs-timeline-marker-header', positionClass].join(' ')}
			>
				{createButton()}
			</div>,
		);
	} else {
		// We need to create a new row when `Checks` is present
		const checkFailed = $optional('[aria-label="Checks"]');
		// Old view draft PRs require a new row to display the button
		// https://github.com/refined-github/refined-github/pull/8193#discussion_r1908581612
		(checkFailed ?? mergeBar).before(createMergeabilityRow({
			className: 'rgh-update-pr-from-base-branch-row',
			action: createButton(),
			icon: <CheckIcon />,
			iconClass: 'completeness-indicator-success',
			heading: 'This branch has no conflicts with the base branch',
			meta: 'Merging can be performed automatically.',
		}));
	}
}

async function init(signal: AbortSignal): Promise<false | void> {
	await expectToken();
	if (await nativeRepos.getCached(getRepo()!.nameWithOwner)) {
		return false;
	}

	delegate('.rgh-update-pr-from-base-branch', 'click', handler, {signal});
	observe([
		'.mergeability-details > *:last-child', // Old view - TODO: Drop after June 2025
		prMergeabilityBoxHeader,
	], addButton, {signal});
	observe([
		'.js-update-branch-form', // Old view - TODO: Remove in July 2025
		'[aria-label="Conflicts"] [class^="MergeBoxSectionHeader-module__wrapper"] [data-component="buttonContent"]',
	], disableFeatureOnRepo, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isPRConversation,
	],
	exclude: [
		pageDetect.isClosedConversation,
		() => elementExists(deletedHeadRepository),
	],
	awaitDomReady: true, // DOM-based exclusions
	init,
});

/*
Test URLs

PR without conflicts
https://github.com/refined-github/sandbox/pull/60

Draft PR without conflicts
https://github.com/refined-github/sandbox/pull/61

Native "Update branch" button
(pick a conflict-free PR from https://github.com/refined-github/refined-github/pulls?q=is%3Apr+is%3Aopen+sort%3Acreated-asc)

Native "Resolve conflicts" button
https://github.com/refined-github/sandbox/pull/9

Cross-repo PR with long branch names
https://github.com/refined-github/sandbox/pull/13

PRs to repos without write access, find one among your own PRs here:
https://github.com/pulls?q=is%3Apr+is%3Aopen+author%3A%40me+archived%3Afalse+-user%3A%40me

*/



================================================
FILE: source/features/useful-not-found-page.gql
================================================
query GetLatestCommitToFile(
	$owner: String!
	$name: String!
	$branch: String!
	$filePath: String!
) {
	repository(owner: $owner, name: $name) {
		object(expression: $branch) {
			... on Commit {
				history(first: 1, path: $filePath) {
					nodes {
						oid
					}
				}
			}
		}
	}
}



================================================
FILE: source/features/useful-not-found-page.tsx
================================================
import React from 'dom-chef';
import {$} from 'select-dom/strict.js';
import elementReady from 'element-ready';
import * as pageDetect from 'github-url-detection';

import onetime from '../helpers/onetime.js';
import features from '../feature-manager.js';
import api from '../github-helpers/api.js';
import GitHubFileURL from '../github-helpers/github-file-url.js';
import getDefaultBranch from '../github-helpers/get-default-branch.js';
import {getCleanPathname, isUrlReachable} from '../github-helpers/index.js';
import observe from '../helpers/selector-observer.js';
import GetLatestCommitToFile from './useful-not-found-page.gql';
import {expectToken} from '../github-helpers/github-token.js';

type File = {
	previous_filename?: string;
	filename: string;
	status: string;
	blob_url: string;
};

type FileChanges = {
	file: File;
	commit: {
		parentSha: string;
		date: Date;
		url: string;
	};
};

function getType(): string {
	return location.pathname.split('/').pop()!.includes('.') ? 'file' : 'object';
}

function getStrikeThrough(text: string): HTMLElement {
	return <del className="color-fg-subtle">{text}</del>;
}

async function crossIfNonExistent(anchor: HTMLElement): Promise<void> {
	if (anchor instanceof HTMLAnchorElement && !await isUrlReachable(anchor.href)) {
		anchor.replaceWith(getStrikeThrough(anchor.textContent));
	}
}

function parseCurrentURL(): string[] {
	const parts = getCleanPathname().split('/');
	if (parts[2] === 'blob') { // Blob URLs are never useful
		parts[2] = 'tree';
	}

	return parts;
}

async function getLatestCommitToFile(branch: string, filePath: string): Promise<string | void> {
	const {repository} = await api.v4(GetLatestCommitToFile, {
		variables: {
			branch,
			filePath,
		},
	});
	const commit = repository.object?.history.nodes[0];
	return commit?.oid;
}

async function getChangesToFileInCommit(sha: string, filePath: string): Promise<FileChanges | void> {
	// API v4 doesn't support it: https://github.community/t/what-is-the-corresponding-object-in-graphql-api-v4-for-patch-which-is-available-in-rest-api-v3/13590
	const commit = await api.v3(`commits/${sha}`);
	for (const fileInfo of commit.files as File[]) {
		if ([fileInfo.filename, fileInfo.previous_filename].includes(filePath)) {
			return {
				commit: {
					parentSha: commit.parents[0].sha,
					date: commit.commit.committer.date,
					url: commit.html_url,
				},
				file: fileInfo,
			};
		}
	}
}

async function getUrlToFileOnDefaultBranch(): Promise<string | void> {
	const parsedUrl = new GitHubFileURL(location.href);
	if (!parsedUrl.branch) {
		return;
	}

	parsedUrl.assign({branch: await getDefaultBranch()});
	const urlOnDefault = parsedUrl.href;
	if (urlOnDefault !== location.href && await isUrlReachable(urlOnDefault)) {
		return urlOnDefault;
	}
}

async function showMissingPartOnce(): Promise<void> {
	const pathParts = parseCurrentURL();
	const breadcrumbs = [...pathParts.entries()]
		.toReversed() // Checks the anchors right to left
		.map(([index, part]) => {
			if (
				// Exclude parts that don't exist as standalones
				(index === 0 && part === 'orgs') // #5483
				|| (index === 2 && ['tree', 'blob', 'edit'].includes(part))
				|| index === pathParts.length - 1 // The last part is a known 404
			) {
				return getStrikeThrough(part);
			}

			const pathname = '/' + pathParts.slice(0, index + 1).join('/');
			const link = <a href={pathname}>{part}</a>;
			void crossIfNonExistent(link);
			return link;
		})
		.toReversed() // Restore order
		.flatMap((link, index) => [index > 0 && ' / ', link]); // Add separators

	$(['main > :first-child', '#parallax_illustration']).after(
		<h2 className="container mt-4 text-center">{breadcrumbs}</h2>,
	);
}

async function showDefaultBranchLink(): Promise<void> {
	const urlToFileOnDefaultBranch = await getUrlToFileOnDefaultBranch();
	if (!urlToFileOnDefaultBranch) {
		return;
	}

	$('main > .container-lg').before(
		<p className="container mt-4 text-center">
			<a href={urlToFileOnDefaultBranch}>This {getType()}</a> exists on the default branch.
		</p>,
	);
}

async function getGitObjectHistoryLink(): Promise<HTMLElement | undefined> {
	const url = new GitHubFileURL(location.href);
	if (!url.branch || !url.filePath) {
		return;
	}

	const commitSha = await getLatestCommitToFile(url.branch, url.filePath);
	if (!commitSha) {
		return;
	}

	const fileChanges = await getChangesToFileInCommit(commitSha, url.filePath);
	if (!fileChanges) {
		return;
	}

	url.assign({route: 'commits'});
	const commitHistory = <a href={url.href}>Commit history</a>;
	url.assign({route: 'blob', branch: fileChanges.commit.parentSha, filePath: url.filePath});
	const lastVersionUrl = fileChanges.file.status === 'removed' ? fileChanges.file.blob_url : url.href;
	const lastVersion = <a href={lastVersionUrl}>This {getType()}</a>;
	const permalink = (
		<a href={fileChanges.commit.url}>
			<relative-time datetime={fileChanges.commit.date} />
		</a>
	);
	const verb = fileChanges.file.status === 'removed'
		? 'deleted'
		: <a href={fileChanges.file.blob_url}>moved</a>;

	return (
		<p className="container mt-4 text-center">
			{lastVersion} was {verb} ({permalink}) - {commitHistory}.
		</p>
	);
}

async function showGitObjectHistory(): Promise<void> {
	const link = await getGitObjectHistoryLink();
	if (link) {
		$('main > .container-lg').before(link);
	}
}

async function showGitObjectHistoryOnRepo(description: HTMLDivElement): Promise<void> {
	const link = await getGitObjectHistoryLink();
	if (link) {
		link.className = 'color-fg-muted';
		description.after(link);
	}
}

async function initOnce(): Promise<void> {
	await expectToken();

	void showDefaultBranchLink();
	void showGitObjectHistory();
}

async function initPRCommitOnce(): Promise<void | false> {
	const commitUrl = location.href.replace(/pull\/\d+\/(commits|changes)/, 'commit');
	if (!(await isUrlReachable(commitUrl))) {
		return false;
	}

	const blankSlateParagraph = await elementReady('.blankslate:has(> .octicon-telescope) p', {waitForChildren: false});
	blankSlateParagraph!.after(
		<p>You can also try to <a href={commitUrl}>view the detached standalone commit</a>.</p>,
	);
}

async function initRepoFile(signal: AbortSignal): Promise<void> {
	await expectToken();
	observe('#repos-header-breadcrumb-wide-heading + ol a', crossIfNonExistent, {signal});
	observe('main div[data-testid="eror-404-description"]', showGitObjectHistoryOnRepo, {signal});	// "eror" as misspelled by GitHub
}

void features.add(import.meta.url, {
	asLongAs: [
		pageDetect.is404,
		() => parseCurrentURL().length > 1,
	],
	awaitDomReady: true, // Small page
	init: onetime(showMissingPartOnce),
}, {
	asLongAs: [
		pageDetect.is404,
	],
	include: [
		pageDetect.isSingleFile,
		pageDetect.isRepoTree,
		pageDetect.isEditingFile,
	],
	awaitDomReady: true, // Small page
	init: onetime(initOnce),
}, {
	include: [
		pageDetect.isPRCommit404,
	],
	init: onetime(initPRCommitOnce),
}, {
	include: [
		pageDetect.isRepoFile404,
	],
	init: initRepoFile,
});

/*

Test URLs:

- 404 issue: https://github.com/refined-github/refined-github/issues/888888
- 404 file: https://github.com/refined-github/refined-github/blob/main/source/features/a-horse-with-no-name.tsx
- 410 file: https://github.com/refined-github/refined-github/blob/main/extension/content.js
- 404 ref: https://github.com/refined-github/refined-github/blob/eggs-for-branch/package.json

*/



================================================
FILE: source/features/user-profile-follower-badge.tsx
================================================
import React from 'dom-chef';
import {CachedFunction} from 'webext-storage-cache';
import elementReady from 'element-ready';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import api from '../github-helpers/api.js';
import {getLoggedInUser, getCleanPathname} from '../github-helpers/index.js';
import attachElement from '../helpers/attach-element.js';

const doesUserFollow = new CachedFunction('user-follows', {
	async updater(userA: string, userB: string): Promise<boolean> {
		const {httpStatus} = await api.v3(`/users/${userA}/following/${userB}`, {
			json: false,
			ignoreHTTPStatus: true,
		});

		return httpStatus === 204;
	},
});

async function init(): Promise<void> {
	if (!await doesUserFollow.get(getCleanPathname(), getLoggedInUser()!)) {
		return;
	}

	const target = await elementReady('.js-profile-editable-area [href$="?tab=following"]');
	attachElement(target, {
		after: () => (
			<span className="color-fg-muted"> Â· Follows you</span>
		),
	});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isUserProfile,
	],
	exclude: [
		pageDetect.isOwnUserProfile,
		pageDetect.isPrivateUserProfile,
	],
	init,
});

/*

Test URLs:

1. Visit your own profile
2. Click on "X followers" below your profile picture
3. Click on a follower
4. Look for a "Follows you" badge below their profile picture

*/



================================================
FILE: source/features/vertical-front-matter.css
================================================
.rgh-vertical-front-matter-table > tbody > tr > th {
	text-align: right;
}



================================================
FILE: source/features/vertical-front-matter.tsx
================================================
import './vertical-front-matter.css';

import React from 'dom-chef';
import {$$} from 'select-dom';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';

// https://github.com/github/markup/blob/cd01f9ec87c86ce5a7c70188a74ef40fc4669c5b/lib/github/markup/markdown.rb#L34
const hasFrontMatter = (): boolean => pageDetect.isSingleFile() && /\.(?:mdx?|mkdn?|mdwn|mdown|markdown|litcoffee)$/.test(location.pathname);

function transpose(table: HTMLElement): void {
	const rows = $$(':scope > tbody > tr', table);
	const headers = $$(':scope > thead th', table);
	if (headers.length <= 4 || rows.length !== 1 || headers.length !== rows[0].childElementCount) {
		return;
	}

	const values = [...rows[0].children];
	table.replaceWith(
		<table className="rgh-vertical-front-matter-table">
			<tbody>
				{headers.map((cell, index) => (
					<tr>
						{cell}
						{values[index]}
					</tr>
				))}
			</tbody>
		</table>,
	);
}

function init(signal: AbortSignal): void {
	observe(
		[
			'.markdown-body > table:first-child', // TODO: remove in march 2026
			'.markdown-body > markdown-accessiblity-table > table:first-child',
		],
		transpose,
		{signal},
	);
}

void features.add(import.meta.url, {
	include: [
		hasFrontMatter,
	],
	init,
});

/*

Test URLs:

https://github.com/github/docs/blob/114de99a/content/repositories/working-with-files/managing-files/customizing-how-changed-files-appear-on-github.md

*/



================================================
FILE: source/features/view-last-pr-deployment.tsx
================================================
import React from 'dom-chef';
import {lastElement} from 'select-dom';
import * as pageDetect from 'github-url-detection';
import RocketIcon from 'octicons-plain-react/Rocket';

import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';

function addLink(header: HTMLElement): void {
	const lastDeployment = lastElement('.js-timeline-item a[title="Deployment has completed"]');
	if (!lastDeployment) {
		return;
	}

	header.prepend(
		<a
			className="rgh-last-deployment btn btn-sm d-none d-md-block mr-1"
			target="_blank" // Matches GitHubâ€™s own behavior
			rel="noopener noreferrer"
			href={lastDeployment.href}
		>
			<RocketIcon className="mr-1 v-align-text-top" />
			Latest deployment
		</a>,
	);
}

function init(signal: AbortSignal): void {
	observe('.gh-header-actions', addLink, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isPRConversation,
	],
	awaitDomReady: true, // Must select last item on the page
	init,
});

// TODO: Needs a URL with multiple deployments and deactivated deployments
/*
Test URLs:
https://github.com/fregante/bundle/pull/2
*/



================================================
FILE: source/features/visit-tag.tsx
================================================
import React from 'react';
import {elementExists} from 'select-dom';
import ArrowUpRightIcon from 'octicons-plain-react/ArrowUpRight';
import CodeIcon from 'octicons-plain-react/Code';
import * as pageDetect from 'github-url-detection';

import {branchSelector} from '../github-helpers/selectors.js';
import features from '../feature-manager.js';
import observe from '../helpers/selector-observer.js';
import {wrapAll} from '../helpers/dom-utils.js';
import {buildRepoURL} from '../github-helpers/index.js';

async function addLink(branchSelector: HTMLButtonElement): Promise<void> {
	if (elementExists([
		// If the branch picker is open, do nothing #7491
		'#selectPanel',

		// React view deduplication https://github.com/refined-github/refined-github/issues/7601
		'.rgh-visit-tag',
	])) {
		return;
	}

	const tag = branchSelector.getAttribute('aria-label')?.replace(/ tag$/, '');
	if (!tag) {
		throw new Error('Tag not found in DOM. The feature needs to be updated');
	}

	wrapAll(
		<div className="d-flex gap-2" />,
		branchSelector,
		<a
			className="btn px-2 tooltipped tooltipped-se rgh-visit-tag"
			href={buildRepoURL('releases/tag', tag)}
			aria-label="Visit tag"
		>
			<ArrowUpRightIcon />
		</a>,
	);
}

function replaceIcon(tagIcon: SVGElement): void {
	// https://github.com/refined-github/refined-github/issues/6499#issuecomment-1505256426
	tagIcon.replaceWith(<CodeIcon />);
}

function clarifyIcon(signal: AbortSignal): void {
	observe('.Link[href*="/tree/"] svg.octicon-tag', replaceIcon, {signal});
}

function init(signal: AbortSignal): void {
	observe(`:is(${branchSelector}):has(.octicon-tag)`, addLink, {signal});
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isRepoTree,
		pageDetect.isSingleFile,
	],
	init,
}, {
	include: [
		pageDetect.isReleasesOrTags,
		pageDetect.isSingleReleaseOrTag,
	],
	init: clarifyIcon,
});

/*

Test URLs:

- https://github.com/refined-github/refined-github/tree/23.11.15
- https://github.com/refined-github/refined-github/blob/23.4.10/.editorconfig

Second part:

- https://github.com/refined-github/refined-github/releases
- https://github.com/refined-github/refined-github/releases/tag/23.11.15
- https://github.com/saadeghi/daisyui/releases/tag/v4.4.15

*/



================================================
FILE: source/features/warn-pr-from-master.tsx
================================================
import React from 'dom-chef';
import * as pageDetect from 'github-url-detection';

import observe from '../helpers/selector-observer.js';
import features from '../feature-manager.js';
import parseCompareUrl from '../github-helpers/parse-compare-url.js';
import {defaultBranchOfRepo} from '../github-helpers/get-default-branch.js';

async function addWarning(anchor: HTMLElement): Promise<void> {
	anchor.before(
		<div className="flash flash-error my-3">
			<strong>Note:</strong> Creating a PR from the default branch is an <a href="https://jmeridth.com/posts/do-not-issue-pull-requests-from-your-master-branch/" target="_blank" rel="noopener noreferrer">anti-pattern</a>.
		</div>,
	);
}

function init(signal: AbortSignal): void {
	observe('.js-compare-pr', addWarning, {signal});
}

async function isCrossRepoCompareFromMaster(): Promise<boolean> {
	const c = parseCompareUrl(location.pathname);

	return Boolean(c && c.isCrossRepo && c.head.branch === await defaultBranchOfRepo.get(c.head.repo));
}

void features.add(import.meta.url, {
	asLongAs: [
		pageDetect.isCompare,
		isCrossRepoCompareFromMaster,
	],
	init,
});

/*

Test URLs:

- Simple: https://github.com/refined-github/refined-github/compare/main...fregante:main
- Renamed fork and changed default branch: https://github.com/refined-github/sandbox/compare/default-a...bfred-it-org:github-sandbox:main?expand=1
- Non-standard default name: https://github.com/refined-github/refined-github/compare/sandbox/keep-branch...yakov116:upstream

*/



================================================
FILE: source/features/warning-for-disallow-edits.css
================================================
/* Hide warning when PR is closed */
[data-pull-is-open='false']
	~ #discussion_bucket
	.rgh-warning-for-disallow-edits {
	display: none;
}

.discussion-sidebar-item:has(input[name='collab_privs']:not(:checked))
	+ .rgh-warning-for-disallow-edits {
	display: block;
}

.discussion-sidebar-item:has(input[name='collab_privs']:checked)
	+ .rgh-warning-for-disallow-edits {
	display: none;
}



================================================
FILE: source/features/warning-for-disallow-edits.tsx
================================================
import './warning-for-disallow-edits.css';

import React from 'dom-chef';
import {$optional} from 'select-dom/strict.js';
import * as pageDetect from 'github-url-detection';

import features from '../feature-manager.js';
import attachElement from '../helpers/attach-element.js';

const getWarning = (): React.JSX.Element => (
	<div className="flash flash-error mt-3 rgh-warning-for-disallow-edits">
		<strong>Note:</strong> Maintainers may require changes. It&apos;s easier and faster to allow them to make direct changes before merging.
	</div>
);

function init(): void | false {
	const checkbox = $optional('input[name="collab_privs"]');
	if (!checkbox) {
		return false;
	}

	attachElement(
		checkbox.closest('.discussion-sidebar-item')!,
		{after: getWarning},
	);
}

void features.add(import.meta.url, {
	include: [
		pageDetect.isCompare,
		pageDetect.isPRConversation,
	],
	awaitDomReady: true,
	init,
});

/*

Test URLs:

1. Open https://github.com/pulls?q=+is%3Apr+is%3Aopen+author%3A%40me+archived%3Afalse+-user%3A%40me+
2. Open any PR opened from a fork
3. Toggle the checkbox in the sidebar

*/



================================================
FILE: source/github-events/on-commit-title-update.ts
================================================
import delegate, {type DelegateEventHandler} from 'delegate-it';

const fieldSelector = [
	'#commit-summary-input', // Commit title on edit file page
	'#merge_title_field', // PR merge message field
];

export default function onCommitTitleUpdate(callback: DelegateEventHandler<Event, HTMLInputElement>, signal: AbortSignal): void {
	// GitHub restores the value from the previous session and only triggers this event
	delegate(fieldSelector, 'change', callback, {signal});

	// For immediate user input
	delegate(fieldSelector, 'input', callback, {signal});
}



================================================
FILE: source/github-events/on-field-keydown.tsx
================================================
import {elementExists} from 'select-dom';
import delegate, {type DelegateEventHandler} from 'delegate-it';

type DelegateFieldEvent = DelegateEventHandler<KeyboardEvent, HTMLTextAreaElement>;

function onFieldKeydown(selector: string, callback: DelegateFieldEvent, signal: AbortSignal): void {
	delegate(selector as 'textarea', 'keydown', event => {
		const field = event.delegateTarget;

		if (
			event.isComposing
			// New autocomplete dropdown
			|| field.hasAttribute('aria-autocomplete')
			// Classic autocomplete dropdown
			|| elementExists('.suggester', field.form!)
		) {
			return;
		}

		callback(event);
	}, {
		// Adds support for `esc` key; GitHub seems to use `stopPropagation` on it
		capture: true,
		signal,
	});
}

export function onCommentFieldKeydown(callback: DelegateFieldEvent, signal: AbortSignal): void {
	onFieldKeydown('textarea', callback, signal);
}

export function onConversationTitleFieldKeydown(callback: DelegateFieldEvent, signal: AbortSignal): void {
	onFieldKeydown('input[placeholder="Title"], #issue_title, #pull_request_title', callback, signal);
}

export function onCommitTitleFieldKeydown(callback: DelegateFieldEvent, signal: AbortSignal): void {
	onFieldKeydown('#commit-summary-input', callback, signal);
}



================================================
FILE: source/github-events/on-pr-merge.ts
================================================
import {oneEvent} from 'delegate-it';

import observe from '../helpers/selector-observer.js';

// This event ensures that the feature appears exclusively to the person that merged the PR and not anyone who was on the page at the time of the merge
export default async function waitForPrMerge(signal: AbortSignal): Promise<void> {
	// It must start listening early or else the animation ID will be generated incorrectly (ancestor)
	// WARNING: Be very careful about the value of ancestor if you refactor this code
	const mergeEvent = new Promise(resolve => {
		// `emphasis` excludes merge commit icons added by `mark-merge-commits-in-list`
		observe('.TimelineItem-badge.color-fg-on-emphasis .octicon-git-merge', resolve, {ancestor: 4});
	});

	await oneEvent([
		// TODO: Drop in 2026
		'.js-merge-commit-button',

		// TODO: Add a textContent check after https://github.com/fregante/delegate-it/issues/55
		// TODO: Support "Confirm auto-merge (squash)" button (it's not primary/green)
		'div[class^="MergeBox-module"] div[data-has-label] ~ div button[data-size="medium"][data-variant="primary"]',
	], 'click', {signal});

	// It won't resolve once the signal is aborted
	await mergeEvent;

	if (signal.aborted) {
		throw new Error('The code shouldnâ€™t have reached this point');
	}
}



================================================
FILE: source/github-events/on-react-page-update.tsx
================================================
import {signalFromEvent} from 'abort-utils';

export default function onReactPageUpdate(
	callback: (signal: AbortSignal) => void,
	signal: AbortSignal,
): void {
	document.addEventListener('soft-nav:payload', () => {
		const unifiedSignal = AbortSignal.any([
			signal, // User-provided, likely Turbo page navigation event
			signalFromEvent(document, 'soft-nav:payload'), // A "React page"-specific page navigation event
		]);
		callback(unifiedSignal);
	}, {signal});
}



================================================
FILE: source/github-helpers/api.ts
================================================
/*
These will throw `RefinedGitHubAPIError` if something goes wrong or if it's a 404.
Probably don't catch them so they will appear in the console
next to the name of the feature that caused them.

Usage:

import api from '../github-helpers/api.js';
const user = await api.v3(`/users/${username}`);
const repositoryCommits = await api.v3('commits'); // Without a leading `/`, this is equivalent to `/repo/$current-repository/commits`
const data = await api.v4('{user(login: "user") {name}}');

Returns:
a Promise that resolves into an object.

If the response body is empty, you'll receive an object like {status: 200}

The second argument is an options object,
it lets you define accept error HTTP codes as a valid response, like:

{
	ignoreHTTPStatus: true
}

so the call will not throw an error but it will return as usual.
*/

import mem from 'memoize';
import * as pageDetect from 'github-url-detection';
import type {JsonObject, AsyncReturnType} from 'type-fest';

import {getRepo} from './index.js';
import {getToken} from '../options-storage.js';
import {log} from '../helpers/feature-helpers.js';

type JsonError = {
	message: string;
};

type GraphQLResponse = {
	message?: string;
	data?: JsonObject;
	errors?: JsonError[];
};

type RestResponse = {
	httpStatus: number;
	headers: Headers;
	ok: boolean;
} & AnyObject;

const escapeKey = (...keys: Array<string | number>): string => '_' + String(keys).replaceAll(/[^a-z\d]/gi, '_');

export class RefinedGitHubAPIError extends Error {
	response: AnyObject = {};
	constructor(...messages: string[]) {
		super(messages.join('\n'));
	}
}

export const api3 = pageDetect.isEnterprise()
	? `${location.origin}/api/v3/`
	: 'https://api.github.com/';

const api4 = pageDetect.isEnterprise()
	? `${location.origin}/api/graphql`
	: 'https://api.github.com/graphql';

type GHRestApiOptions = {
	ignoreHTTPStatus?: boolean;
	method?: 'GET' | 'POST' | 'PUT' | 'PATCH' | 'DELETE';
	body?: JsonObject;
	headers?: HeadersInit;
	json?: boolean;
};

type GHGraphQLApiOptions = {
	allowErrors?: boolean;
	variables?: JsonObject;
};

const v3defaults: GHRestApiOptions = {
	ignoreHTTPStatus: false,
	method: 'GET',
	body: undefined,
	json: true,
};

const v4defaults: GHGraphQLApiOptions = {
	allowErrors: false,
};

const v3uncached = async (
	query: string,
	options: GHRestApiOptions = v3defaults,
): Promise<RestResponse> => {
	const {ignoreHTTPStatus, method, body, headers, json} = {...v3defaults, ...options};
	const personalToken = await getToken();

	if (!query.startsWith('https')) {
		query = query.startsWith('/') ? query.slice(1) : ['repos', getRepo()!.nameWithOwner, query].filter(Boolean).join('/');
	}

	const url = new URL(query, api3);
	log.http(url.href);
	const response = await fetch(url.href, {
		method,
		body: body && JSON.stringify(body),
		headers: {
			'User-Agent': 'Refined GitHub',
			Accept: 'application/vnd.github.v3+json',
			...headers,
			...personalToken && {Authorization: `token ${personalToken}`},
		},
	});
	const textContent = await response.text();
	const apiResponse = json ? JSON.parse(textContent) : {textContent};

	if (response.ok || ignoreHTTPStatus) {
		return Object.assign(apiResponse, {
			httpStatus: response.status,
			headers: response.headers,
			ok: response.ok,
		});
	}

	throw await getError(apiResponse);
};

const v3 = mem(v3uncached, {
	cacheKey: JSON.stringify,
});

const v3paginated = async function * (
	query: string,
	options?: GHRestApiOptions,
): AsyncGenerator<AsyncReturnType<typeof v3>> {
	while (true) {
		// eslint-disable-next-line no-await-in-loop
		const response = await v3(query, options);
		yield response;

		const match = /<([^>]+)>; rel="next"/.exec(response.headers.get('link')!);
		if (match) {
			query = match[1]!;
		} else {
			return;
		}
	}
};

const v3hasAnyItems = async (
	query: string,
	options: GHRestApiOptions = {},
): Promise<boolean> => {
	const url = new URL(query, api3);
	url.searchParams.set('per_page', '1'); // Ensure we create pagination after 1 item
	url.searchParams.set('page', '9999'); // Get an empty response
	const {headers} = await v3(url.pathname + url.search, options);

	// If there's more than 1 item, we get a `Link` header
	return headers.has('link');
};

const v4uncached = async (
	query: string,
	options: GHGraphQLApiOptions = v4defaults,
): Promise<AnyObject> => {
	const personalToken = await getToken();

	if (!personalToken) {
		throw new RefinedGitHubAPIError('Personal token required for this feature');
	}

	// TODO: Remove automatic usage of globals via `getRepo()`
	// https://github.com/refined-github/refined-github/issues/5821
	const currentRepoIfAny = getRepo(); // Don't destructure, it's `undefined` outside repos
	query = query.replace('repository() {', () => 'repository(owner: $owner, name: $name) {');

	// Automatically provide variables common variables only when used.
	// GraphQL doesn't like unused variables.
	const variables: JsonObject = {};
	const parameters: string[] = [];
	if (query.includes('$owner')) {
		variables.owner = currentRepoIfAny!.owner;
		parameters.push('$owner: String!');
	}

	if (query.includes('$name')) {
		variables.name = currentRepoIfAny!.name;
		parameters.push('$name: String!');
	}

	Object.assign(variables, options.variables);

	const fullQuery = /^\s*(?:query|mutation)/.test(query)
		? query
		: parameters.length === 0
			? `query {${query}}`
			: `query (${parameters.join(',')}) {${query}}`;

	log.http(fullQuery);

	const response = await fetch(api4, {
		headers: {
			'User-Agent': 'Refined GitHub',
			'Content-Type': 'application/json',
			// eslint-disable-next-line @typescript-eslint/naming-convention -- External API
			Authorization: `bearer ${personalToken}`,
		},
		method: 'POST',
		body: JSON.stringify({
			variables,
			query: fullQuery,
		}),
	});

	const apiResponse: GraphQLResponse = await response.json();

	const {
		data = {},
		errors = [],
	} = apiResponse;

	if (errors.length > 0 && !options.allowErrors) {
		throw new RefinedGitHubAPIError('GraphQL:', ...errors.map(error => error.message));
	}

	if (response.ok) {
		return data;
	}

	throw await getError(apiResponse as JsonObject);
};

const v4 = mem(v4uncached, {
	cacheKey([query, options]) {
		// `repository()` uses global state and must be handled explicitly
		// https://github.com/refined-github/refined-github/issues/5821
		// https://github.com/sindresorhus/eslint-plugin-unicorn/issues/1864
		const key = [query, options];
		if (query.includes('repository() {') || query.includes('owner: $owner, name: $name')) {
			key.push(getRepo()?.nameWithOwner);
		}

		return JSON.stringify(key);
	},
});

async function getError(apiResponse: JsonObject): Promise<RefinedGitHubAPIError> {
	const personalToken = await getToken();

	if ((apiResponse.message as string)?.includes('API rate limit exceeded')) {
		return new RefinedGitHubAPIError(
			'Rate limit exceeded.',
			personalToken
				? 'It may be time for a walk! ğŸƒ ğŸŒ'
				: 'Set your token in the options or take a walk! ğŸƒ ğŸŒ',
		);
	}

	if (apiResponse.message === 'Bad credentials') {
		return new RefinedGitHubAPIError(
			'The token seems to be incorrect or expired. Update it in the options.',
		);
	}

	if ((apiResponse.message as string)?.includes('without `workflow` scope')) {
		return new RefinedGitHubAPIError(
			'To update workflow files, you need to add the `workflow` scope to your token. Update your token at https://github.com/settings/tokens',
		);
	}

	const error = new RefinedGitHubAPIError(
		'Unable to fetch.',
		personalToken
			? 'Ensure that your token has access to this repo.'
			: 'Maybe adding a token in the options will fix this issue.',
		JSON.stringify(apiResponse, undefined, '\t'), // Beautify
	);
	error.response = apiResponse;
	return error;
}

const api = {
	v3,
	v4,
	v3paginated,
	v3hasAnyItems,
	v3uncached,
	v4uncached,
	escapeKey,
	getError,
};

export default api;



================================================
FILE: source/github-helpers/banner.tsx
================================================
import React from 'dom-chef';
import type {RequireAllOrNone} from 'type-fest';

export type BannerProps = RequireAllOrNone<{
	icon?: JSX.Element;
	text: Array<string | JSX.Element> | string | JSX.Element;
	classes?: string[];
	action: string | React.MouseEventHandler<HTMLButtonElement>;
	buttonLabel: JSX.Element | string;
}, 'action' | 'buttonLabel'>;

// Classes copied from "had recent pushes" banner from repo home
const classes = 'flex-shrink-0 btn btn-sm ml-sm-3 mt-2 mt-sm-n2 mb-sm-n2 mr-sm-n1 flex-self-center';

// This could be a `<Banner/>` element but dom-chef doesn't pass props
// https://github.com/vadimdemedes/dom-chef/issues/77
export default function createBanner(props: BannerProps): JSX.Element {
	let button: JSX.Element | undefined;

	if (typeof props.action === 'string') {
		button = (
			<a href={props.action} className={classes}>
				{props.buttonLabel}
			</a>
		);
	} else if (typeof props.action === 'function') {
		button = (
			<button type="button" className={classes} onClick={props.action}>
				{props.buttonLabel}
			</button>
		);
	}

	return (
		<div className={['flash', ...props.classes ?? ''].join(' ')}>
			<div className="d-sm-flex flex-items-center gap-2">
				<div className="d-flex flex-auto flex-self-center flex-items-center gap-2">
					{props.icon}
					<span>{props.text}</span>
				</div>
				{button}
			</div>
		</div>
	);
}



================================================
FILE: source/github-helpers/bugs-label.test.ts
================================================
import {assert, test} from 'vitest';

import isBugLabel from './bugs-label.js';

const supportedLabels = `
bug
bug-fix
bugfix
confirmed-bug
type/bug
type:bug
type-bug
kind/bug
kind:bug
kind-bug
triage/bug
triage:bug
Issue-Bug
:bug:bug
:bug: bug
ğŸ›bug
ğŸ› bug
`;

const blockedLabels = `
bugfixes
bugtracker
bug-report
bug-hunt
bugzilla
debug
debugger
bugatti
bugia
ladybug
not-a-bug
`;

test('isBugLabel', () => {
	for (const label of supportedLabels.trim().split('\n')) {
		assert.isTrue(isBugLabel(label), label + ' is a bug label');
	}

	for (const label of blockedLabels.trim().split('\n')) {
		assert.isFalse(isBugLabel(label), label + ' is a not bug label');
	}
});



================================================
FILE: source/github-helpers/bugs-label.ts
================================================
const supportedLabels = /^(?:bug|bug-?fix|confirmed-bug|(?:category|type|kind|triage|issue)[:/-]bug|(?::[\w-]+:|\p{Emoji})bug)$/iu;
export default function isBugLabel(label: string): boolean {
	return supportedLabels.test(label.replaceAll(/\s/g, ''));
}



================================================
FILE: source/github-helpers/create-dropdown-item.tsx
================================================
import React from 'dom-chef';

// Random icon just for types
import type TagIcon from 'octicons-plain-react/Tag';

type Options = {
	label: string;
	href: string;
	icon: typeof TagIcon;
} & Record<string, string | typeof TagIcon>;

export default function createDropdownItem({
	label,
	href,
	icon: Icon,
	...attributes
}: Options): Element {
	return (
		<li
			data-targets="action-list.items action-list.items"
			role="none"
			data-view-component="true"
			className="ActionListItem"
			{...attributes}
		>
			<a
				tabIndex={-1}
				href={href}
				role="menuitem"
				data-view-component="true"
				className="ActionListContent ActionListContent--visual16"
			>
				<span className="ActionListItem-visual ActionListItem-visual--leading">
					<Icon />
				</span>

				<span data-view-component="true" className="ActionListItem-label">
					{label}
				</span>
			</a>

		</li>
	);
}



================================================
FILE: source/github-helpers/does-file-exist.gql
================================================
query DoesFileExist($owner: String!, $name: String!, $file: String!) {
	repository(owner: $owner, name: $name) {
		file: object(expression: $file) {
			id
		}
	}
}



================================================
FILE: source/github-helpers/dom-formatters.tsx
================================================
import React from 'dom-chef';
import {elementExists} from 'select-dom';
import zipTextNodes from 'zip-text-nodes';
import {applyToLink} from 'shorten-repo-url';
import {linkifyUrlsToDom} from 'linkify-urls';
import {linkifyIssuesToDom, type Options as LinkifyIssuesOptions} from 'linkify-issues';

import getTextNodes from '../helpers/get-text-nodes.js';
import parseBackticksCore from './parse-backticks.js';
import {buildRepoURL} from './index.js';

// Shared class necessary to avoid also shortening the links
export const linkifiedURLClass = 'rgh-linkified-code';
const linkifiedURLSelector = '.rgh-linkified-code';

export const codeElementsSelector = [
	// Sometimes formatted diffs are loaded later and discard our formatting #5870
	'.blob-code-inner:not(deferred-diff-lines.awaiting-highlight *)', // Code lines
	':is(.snippet-clipboard-content, .highlight) > pre.notranslate', // Code blocks in comments. May be wrapped twice
	'.comment-body code:not(a code, pre code)', // Inline code in comments
];

export function shortenLink(link: HTMLAnchorElement): void {
	// Exclude the link if the closest element found is not `.markdown-body`
	// This avoids shortening links in code and code suggestions, but still shortens them in review comments
	// https://github.com/refined-github/refined-github/pull/4759#discussion_r702460890
	if (link.closest(String([...codeElementsSelector, '.markdown-body']))?.classList.contains('markdown-body')) {
		applyToLink(link, location.href);
	}
}

export function linkifyIssues(
	currentRepo: {owner?: string; name?: string},
	element: Element,
	options: Partial<LinkifyIssuesOptions> = {},
): void {
	const linkified = linkifyIssuesToDom(element.textContent, {
		user: currentRepo.owner ?? '/',
		repository: currentRepo.name ?? '/',
		baseUrl: '',
		...options,
		attributes: {
			class: linkifiedURLClass, // Necessary to avoid also shortening the links
			...options.attributes,
		},
	});
	if (linkified.children.length === 0) { // Children are <a>
		return;
	}

	// Enable native issue title fetch
	for (const link of linkified.children as HTMLCollectionOf<HTMLAnchorElement>) {
		const issue = link.href.split('/').pop();
		link.setAttribute('class', 'issue-link js-issue-link');
		link.dataset.errorText = 'Failed to load title';
		link.dataset.permissionText = 'Title is private';
		link.dataset.url = link.href;
		link.dataset.id = `rgh-issue-${issue!}`;
		link.dataset.hovercardType = 'issue';
		link.dataset.hovercardUrl = `${link.pathname}/hovercard`;
	}

	zipTextNodes(element, linkified);
}

export function linkifyURLs(element: Element): void {
	if (element.textContent.length < 15) { // Must be long enough for a URL
		return;
	}

	if (elementExists(linkifiedURLSelector, element)) {
		console.warn('Links already exist', element);
		throw new Error('Links already exist');
	}

	const linkified = linkifyUrlsToDom(element.textContent, {
		attributes: {
			rel: 'noreferrer noopener',
			class: linkifiedURLClass, // Necessary to avoid also shortening the links
		},
	});

	if (linkified.children.length === 0) { // Children are <a>
		return;
	}

	zipTextNodes(element, linkified);
}

export function parseBackticks(element: Element): void {
	for (const node of getTextNodes(element)) {
		const fragment = parseBackticksCore(node.textContent);

		if (fragment.children.length > 0) {
			node.replaceWith(fragment);
		}
	}
}

export function linkifyCommit(sha: string): JSX.Element {
	// Data attributes copied from the commit in https://github.com/refined-github/github-url-detection/releases/tag/v7.1.2
	return (
		<code>
			<a
				className="Link--secondary"
				href={buildRepoURL('commit', sha)}
				data-hovercard-type="commit"
				data-hovercard-url={buildRepoURL('commit', sha, 'hovercard')}
			>
				{sha.slice(0, 7)}
			</a>
		</code>
	);
}



================================================
FILE: source/github-helpers/get-comment-author.ts
================================================
/**
Given any element in a comment, returns the commentâ€™s author

This works on:
- First comment
- Following comments
- Main review comment
- Following review comments
- Gist comments
- Bots

Note: Bots are used as `name[bot]`, `app/name`, or `apps/name` depending on the context:
- https://github.com/webpack/webpack/commits?author=dependabot%5Bbot%5D
- https://github.com/webpack/webpack/pulls/app%2Fdependabot
- https://github.com/apps/dependabot

@returns user-name or dependabot[bot]

*/
export default function getCommentAuthor(anyElementInsideComment: Element): string {
	const avatar: HTMLImageElement = anyElementInsideComment
		.closest([
			'.TimelineItem', // PR comments (and pre-issue redesign issue comments)
			'.review-comment', // PR review comments
			'.react-issue-body', // First issue comment
			'.react-issue-comment', // Issue comments
			'[data-testid="comment-header"]', // Commit comments
		])!
		.querySelector([
			'.TimelineItem-avatar img', // PR comments (and pre-issue redesign issue comments)
			'img.avatar', // PR review comments
			'img[data-testid="github-avatar"]', // Issue comments
			'img[data-component="Avatar"]', // Commit comments
		])!;

	const name = avatar
		.alt // Occasionally ends with `[bot]`
		.replace(/^@/, ''); // May or may not be present

	if (!name.endsWith('[bot]') && avatar.closest('[href^="https://github.com/apps/"]')) {
		// Example: https://github.com/webpack/webpack/pull/15926#issuecomment-1170670173
		return name + '[bot]';
	}

	return name;
}



================================================
FILE: source/github-helpers/get-current-git-ref.test.ts
================================================
import {assert, test} from 'vitest';

// @ts-expect-error JS only
import {navigateToCommits} from '../../test/setup-file.js';
import getCurrentGitRef, {getGitRef} from './get-current-git-ref.js';

// The titles supplied here listed here are real, not guessed, except the error tester
test('getGitRef', () => {
	// Error testing
	assert.equal(getGitRef(
		'/',
		'some page title',
	), undefined, 'It should never throw with valid input');
	assert.throws(() => getGitRef(
		'https://github.com',
		'github.com',
	));

	// Root
	assert.equal(getGitRef(
		'/typescript-eslint/typescript-eslint',
		'typescript-eslint/typescript-eslint: Monorepo for all the tooling which enables ESLint to support TypeScript',
	), undefined);
	assert.equal(getGitRef(
		'/typescript-eslint/typescript-eslint/tree/chore/lerna-4',
		'typescript-eslint/typescript-eslint at chore/lerna-4',
	), 'chore/lerna-4');

	// Sub folder
	assert.equal(getGitRef(
		'/typescript-eslint/typescript-eslint/tree/master/docs',
		'typescript-eslint/docs at master Â· typescript-eslint/typescript-eslint',
	), 'master');
	assert.equal(getGitRef(
		'/typescript-eslint/typescript-eslint/tree/chore/lerna-4/docs',
		'typescript-eslint/docs at chore/lerna-4 Â· typescript-eslint/typescript-eslint',
	), 'chore/lerna-4');

	// Sub sub folder
	assert.equal(getGitRef(
		'/typescript-eslint/typescript-eslint/tree/master/docs/getting-started',
		'typescript-eslint/docs/getting-started at master Â· typescript-eslint/typescript-eslint',
	), 'master');
	assert.equal(getGitRef(
		'/typescript-eslint/typescript-eslint/tree/chore/lerna-4/docs/getting-started',
		'typescript-eslint/docs/getting-started at chore/lerna-4 Â· typescript-eslint/typescript-eslint',
	), 'chore/lerna-4');

	// File
	assert.equal(getGitRef(
		'/typescript-eslint/typescript-eslint/blob/master/docs/getting-started/README.md',
		'typescript-eslint/README.md at master Â· typescript-eslint/typescript-eslint',
	), 'master');
	assert.equal(getGitRef(
		'/typescript-eslint/typescript-eslint/blob/chore/lerna-4/docs/getting-started/README.md',
		'typescript-eslint/README.md at chore/lerna-4 Â· typescript-eslint/typescript-eslint',
	), 'chore/lerna-4');

	// Editing file
	assert.equal(getGitRef(
		'/typescript-eslint/typescript-eslint/edit/master/docs/getting-started/README.md',
		'Editing typescript-eslint/README.md at master Â· typescript-eslint/typescript-eslint',
	), 'master');
	assert.equal(getGitRef(
		'/typescript-eslint/typescript-eslint/edit/chore/lerna-4/docs/getting-started/README.md',
		'Editing typescript-eslint/README.md at chore/lerna-4 Â· typescript-eslint/typescript-eslint',
	), 'chore/lerna-4');

	// Blame
	assert.equal(getGitRef(
		'/typescript-eslint/typescript-eslint/blame/master/docs/getting-started/README.md',
		'typescript-eslint/docs/getting-started/README.md at master Â· typescript-eslint/typescript-eslint',
	), 'master');
	assert.equal(getGitRef(
		'/typescript-eslint/typescript-eslint/blame/chore/lerna-4/docs/getting-started/README.md',
		'typescript-eslint/docs/getting-started/README.md at chore/lerna-4 Â· typescript-eslint/typescript-eslint',
	), 'chore/lerna-4');

	// Single commit
	assert.equal(getGitRef(
		'/typescript-eslint/typescript-eslint/commit/795fd1c529ee58e97283c9ddf8463703517b50ab',
		'chore: add markdownlint (#1889) Â· typescript-eslint/typescript-eslint@795fd1c',
	), '795fd1c529ee58e97283c9ddf8463703517b50ab');

	// Branch includes period
	assert.equal(getGitRef(
		'/anggrayudi/SimpleStorage/tree/release/0.8.0',
		'anggrayudi/SimpleStorage at release/0.8.0',
	), 'release/0.8.0');

	assert.equal(getGitRef(
		'/ksh-code/repository/tree/h.l.o.o',
		'ksh-code/repository at h.l.o.o',
	), 'h.l.o.o');
});

// The titles supplied here listed here are real, not guessed, except the error tester
test('getCurrentGitRef', () => {
	// Commits
	navigateToCommits(
		'master',
		'/typescript-eslint/typescript-eslint/commits/master/docs/getting-started/README.md',
	);
	assert.equal(getCurrentGitRef(), 'master');

	navigateToCommits(
		'chore/lerna-4',
		'/typescript-eslint/typescript-eslint/commits/chore/lerna-4/docs/getting-started/README.md',
	);
	assert.equal(getCurrentGitRef(), 'chore/lerna-4');

	navigateToCommits(
		'this/branch/has/many/slashes',
		'/yakov116/TestR/commits/this/branch/has/many/slashes',
	);
	assert.equal(getCurrentGitRef(), 'this/branch/has/many/slashes');
});



================================================
FILE: source/github-helpers/get-current-git-ref.ts
================================================
import {isRepoCommitList} from 'github-url-detection';
import {$optional} from 'select-dom/strict.js';

import {extractCurrentBranchFromBranchPicker} from './index.js';
import {branchSelector} from './selectors.js';

const typesWithGitRef = new Set(['tree', 'blob', 'blame', 'edit', 'commit', 'commits', 'compare']);
const titleWithGitRef = / at (?<branch>[.\w/-]+)(?: Â· [\w-]+\/[\w-]+)?$/i;

/** Must not be async because it's used by GitHubFileURL. May return different results depending on whether it's called before or after DOM ready */
export default function getCurrentGitRef(): string | undefined {
	// Note: This is not in the <head> so it's only available on AJAXed loads.
	// It appears on every Code page except `commits` on folders/files
	const picker = $optional(branchSelector);
	const refViaPicker = picker && extractCurrentBranchFromBranchPicker(picker);
	if (refViaPicker) {
		return refViaPicker;
	}

	// Slashed branches on `commits`, including pages without a branch picker
	const branchFromFeed = getCurrentBranchFromFeed();
	if (branchFromFeed) {
		return branchFromFeed;
	}

	return getGitRef(location.pathname, document.title);
}

export function getGitRef(pathname: string, title: string): string | undefined {
	if (!pathname.startsWith('/')) {
		throw new TypeError(`Expected pathname starting with /, got "${pathname}"`);
	}

	const [type, gitRefIfNonSlashed] = pathname.split('/').slice(3);
	if (!type || !typesWithGitRef.has(type)) {
		// Root; or piece of information not applicable to the page
		return;
	}

	// Slashed branches on `blob` and `tree`
	const parsedTitle = titleWithGitRef.exec(title);
	if (parsedTitle) {
		return parsedTitle.groups!.branch;
	}

	// Couldn't ensure it's not slashed, so we'll return the first piece whether correct or not
	return gitRefIfNonSlashed;
}

// In <head>, but not reliable https://github.com/refined-github/refined-github/assets/1402241/50357d94-505f-48dc-bd54-74e86b19d642
function getCurrentBranchFromFeed(): string | undefined {
	const feedLink = isRepoCommitList() && $optional('link[type="application/atom+xml"]');
	if (!feedLink) {
		// Do not throw errors, the element may be missing after AJAX navigation even if on the right page
		return;
	}

	return new URL(feedLink.href)
		.pathname
		.split('/')
		.slice(4) // Drops the initial /user/repo/route/ part
		.join('/')
		.replace(/\.atom$/, '');
}



================================================
FILE: source/github-helpers/get-default-branch.gql
================================================
query getDefaultBranch($owner: String!, $name: String!) {
	repository(owner: $owner, name: $name) {
		defaultBranchRef {
			name
		}
	}
}



================================================
FILE: source/github-helpers/get-default-branch.ts
================================================
import {CachedFunction} from 'webext-storage-cache';
import elementReady from 'element-ready';
import type {NameWithOwner} from 'github-url-detection';

import api from './api.js';
import {extractCurrentBranchFromBranchPicker, getRepo} from './index.js';
import {branchSelector} from './selectors.js';
import GetDefaultBranch from './get-default-branch.gql';

const isCurrentRepo = (nameWithOwner: NameWithOwner): boolean => Boolean(getRepo()?.nameWithOwner === nameWithOwner);

// Do not make this function complicated. We're only optimizing for the repo root.
async function fromDOM(): Promise<string | undefined> {
	if (!['', 'commits'].includes(getRepo()!.path)) {
		return;
	}

	// We're on the default branch, so we can extract it from the current page. This exclusively happens on the exact pages:
	// /user/repo
	// /user/repo/commits (without further path)
	const element = await elementReady(branchSelector);

	if (!element) {
		return;
	}

	return extractCurrentBranchFromBranchPicker(element);
}

async function fromAPI(repository: NameWithOwner): Promise<string> {
	const [owner, name] = repository.split('/');
	const response = await api.v4(GetDefaultBranch, {
		variables: {
			owner,
			name,
		},
	});

	return response.repository.defaultBranchRef.name;
}

// DO NOT use optional arguments/defaults in "cached functions" because they can't be memoized effectively
// https://github.com/sindresorhus/eslint-plugin-unicorn/issues/1864
export const defaultBranchOfRepo = new CachedFunction('default-branch', {
	async updater(repository: NameWithOwner): Promise<string> {
		if (!repository) {
			throw new Error('getDefaultBranch was called on a non-repository page');
		}

		// eslint-disable-next-line @typescript-eslint/prefer-nullish-coalescing -- Wrong, type can be `false`
		return (isCurrentRepo(repository) && await fromDOM()) || fromAPI(repository);
	},

	maxAge: {hours: 1},
	staleWhileRevalidate: {days: 20},
});

export default async function getDefaultBranch(): Promise<string> {
	return defaultBranchOfRepo.get(getRepo()!.nameWithOwner);
}



================================================
FILE: source/github-helpers/get-next-conversation-number.ts
================================================
import api from './api.js';

export default async function getNextConversationNumber(): Promise<number> {
	const issues = await api.v3('issues?per_page=1');
	return (issues[0].number as number) + 1;
}



================================================
FILE: source/github-helpers/get-pr-info.ts
================================================
import api from './api.js';
import {getConversationNumber} from './index.js';

export type PullRequestInfo = {
	baseRefOid: string;
	headRefOid: string;
	// https://docs.github.com/en/graphql/reference/enums#mergeablestate
	mergeable: 'CONFLICTING' | 'MERGEABLE' | 'UNKNOWN';

	viewerCanUpdate: boolean;

	// It's not clear why this is `false` on a PR I received (I *can* edit the files), but I'm leaving it as a fallback
	viewerCanEditFiles: boolean;
	needsUpdate: boolean;
	behindBy: number;
	// https://docs.github.com/en/graphql/reference/enums#defaultrepositorypermissionfield
	headRepoPerm: 'ADMIN' | 'WRITE' | 'READ' | 'NONE';
};

export default async function getPrInfo(base: string, number = getConversationNumber()!): Promise<PullRequestInfo> {
	const {repository} = await api.v4uncached(`
		repository() {
			pullRequest(number: ${number}) {
				baseRefOid
				headRefOid
				mergeable
				viewerCanUpdate
				viewerCanEditFiles
				headRef {
					compare(headRef: "${base}") {
						status
						aheadBy
					}
				}
				headRepository {
					viewerPermission
				}
			}
		}
	`);

	const {
		baseRefOid,
		headRefOid,
		mergeable,
		viewerCanUpdate,
		viewerCanEditFiles,
		headRef,
		headRepository,
	} = repository.pullRequest;
	return {
		baseRefOid,
		headRefOid,
		viewerCanUpdate,
		mergeable,
		viewerCanEditFiles,
		// The comparison in the API is base -> head, so it must be flipped
		behindBy: headRef.compare.aheadBy,
		needsUpdate: headRef.compare.status === 'DIVERGED',
		headRepoPerm: headRepository.viewerPermission,
	};
}



================================================
FILE: source/github-helpers/get-tab-count.ts
================================================
import {$optional} from 'select-dom/strict.js';
import oneMutation from 'one-mutation';

export default async function getTabCount(tab: Element): Promise<number> {
	const counter = $optional('.Counter, .num', tab);
	if (!counter) {
		// GitHub might have already dropped the counter, which means it's 0
		return 0;
	}

	if (!counter.firstChild) {
		// It's still loading
		await oneMutation(tab, {childList: true, subtree: true});
	}

	return Number(counter.textContent);
}



================================================
FILE: source/github-helpers/get-user-avatar.ts
================================================
import {$optional} from 'select-dom/strict.js';
import * as pageDetect from 'github-url-detection';

export default function getUserAvatar(username: string, size: number): string | void {
	let cleanName = username.replace('[bot]', '');

	if (/[^\w-]/.test(cleanName)) {
		throw new TypeError(`Expected a username, got ${cleanName}`);
	}

	// Find image on page. Saves a request and a redirect + add support for bots
	const existingAvatar = $optional(`[href="/${cleanName}" i] img`);
	if (existingAvatar) {
		return existingAvatar.src;
	}

	if (
		cleanName === 'Copilot'
		|| cleanName === 'copilot-coding-agent-docs'
		|| cleanName === 'copilot-swe-agent'
	) {
		cleanName = 'in/1143301';
	}

	const url = pageDetect.isEnterprise()
		? `/${cleanName}.png`
		: `https://avatars.githubusercontent.com/${cleanName}`;
		// Why use a 2x size: https://github.com/refined-github/refined-github/pull/4973#discussion_r735133613
	return url + `?size=${size * 2}`;
}



================================================
FILE: source/github-helpers/get-user-permission.ts
================================================
import {CachedFunction} from 'webext-storage-cache';
import {elementExists} from 'select-dom';

import {hasToken} from '../options-storage.js';
import {getRepo} from './index.js';
import api from './api.js';

/*
From https://docs.github.com/en/graphql/reference/enums#repositorypermission

ADMIN: Can read, clone, and push to this repository. Can also manage issues, pull requests, and repository settings, including adding collaborators.

MAINTAIN: Can read, clone, and push to this repository. They can also manage issues, pull requests, and some repository settings.

READ: Can read and clone this repository. Can also open and comment on issues and pull requests.

TRIAGE: Can read and clone this repository. Can also manage issues and pull requests.

WRITE: Can read, clone, and push to this repository. Can also manage issues and pull requests.
*/
type RepositoryPermission = 'ADMIN' | 'MAINTAIN' | 'READ' | 'TRIAGE' | 'WRITE';

async function getViewerPermission(): Promise<RepositoryPermission> {
	if (getRepo() === null) {
		throw new Error('This can only be called on a repository page');
	}

	if (!await hasToken()) {
		return 'READ';
	}

	try {
		const {repository} = await api.v4(`
			repository() {
				viewerPermission
			}
		`);

		return repository.viewerPermission;
	} catch {
		return 'READ';
	}
}

const viewerPermission = new CachedFunction('viewer-permission', {
	updater: getViewerPermission,
	cacheKey: () => getRepo()?.nameWithOwner ?? '',
});

export async function userIsAdmin(): Promise<boolean> {
	const repoAccess = await viewerPermission.get();
	return repoAccess === 'ADMIN';
}

/** Check if the user has complete write access to the repo (but no access to the repo Settings) */
export async function userHasPushAccess(): Promise<boolean> {
	const repoAccess = await viewerPermission.get();
	return repoAccess !== 'READ' && repoAccess !== 'TRIAGE';
}

/** Check if the user can edit all comments and comment on locked issues on the current repo */
export async function userIsModerator(): Promise<boolean> {
	// Faster DOM-based check, if the DOM is available.
	// This cannot be cached in `viewerPermission` because it guarantees you have *at least* moderation access, but can't tell if you have *more* capabilities
	const domCheck = elementExists([
		'.lock-toggle-link > .octicon-lock',
		'[aria-label^="You have been invited to collaborate"]',
		'[title^="You are a member"]',
		'[title^="You are a maintainer"]',
		'[title^="You are a collaborator"]',

		// Don't check for admin access here. If the user has admin access, the DOM check in `viewerPermission` will use the DOM and be cached anyway
	]);

	if (domCheck) {
		return true;
	}

	const repoAccess = await viewerPermission.get();
	return repoAccess !== 'READ';
}



================================================
FILE: source/github-helpers/github-file-url.test.ts
================================================
import {test, assert} from 'vitest';

import GitHubFileURL from './github-file-url.js';

test('branch', () => {
	const url = new GitHubFileURL('https://github.com/microsoft/TypeScript/tree/master');
	assert.equal(url.user, 'microsoft');
	assert.equal(url.repository, 'TypeScript');
	assert.equal(url.route, 'tree');
	assert.equal(url.branch, 'master');
	assert.equal(url.filePath, '');
	assert.equal(url.pathname, '/microsoft/TypeScript/tree/master');
	assert.equal(url.href, 'https://github.com/microsoft/TypeScript/tree/master');
	assert.equal(String(url), 'https://github.com/microsoft/TypeScript/tree/master');
});

test('object', () => {
	const url = new GitHubFileURL('https://github.com/microsoft/TypeScript/tree/master/src');
	assert.equal(url.user, 'microsoft');
	assert.equal(url.repository, 'TypeScript');
	assert.equal(url.route, 'tree');
	assert.equal(url.branch, 'master');
	assert.equal(url.filePath, 'src');
	assert.equal(url.pathname, '/microsoft/TypeScript/tree/master/src');
	assert.equal(url.href, 'https://github.com/microsoft/TypeScript/tree/master/src');
	assert.equal(String(url), 'https://github.com/microsoft/TypeScript/tree/master/src');
});

test('nested object', () => {
	const url = new GitHubFileURL('https://github.com/microsoft/TypeScript/tree/master/src/index.js');
	assert.equal(url.user, 'microsoft');
	assert.equal(url.repository, 'TypeScript');
	assert.equal(url.route, 'tree');
	assert.equal(url.branch, 'master');
	assert.equal(url.filePath, 'src/index.js');
	assert.equal(url.pathname, '/microsoft/TypeScript/tree/master/src/index.js');
	assert.equal(url.href, 'https://github.com/microsoft/TypeScript/tree/master/src/index.js');
	assert.equal(String(url), 'https://github.com/microsoft/TypeScript/tree/master/src/index.js');
});

test('change branch', () => {
	const url = new GitHubFileURL('https://github.com/microsoft/TypeScript/tree/master/src/index.js').assign({
		branch: 'dev',
	});
	assert.equal(url.user, 'microsoft');
	assert.equal(url.repository, 'TypeScript');
	assert.equal(url.route, 'tree');
	assert.equal(url.branch, 'dev');
	assert.equal(url.filePath, 'src/index.js');
	assert.equal(url.pathname, '/microsoft/TypeScript/tree/dev/src/index.js');
	assert.equal(url.href, 'https://github.com/microsoft/TypeScript/tree/dev/src/index.js');
	assert.equal(String(url), 'https://github.com/microsoft/TypeScript/tree/dev/src/index.js');
});

test('change filePath', () => {
	const url = new GitHubFileURL('https://github.com/microsoft/TypeScript/tree/master/src/index.js').assign({
		filePath: 'package.json',
	});
	assert.equal(url.user, 'microsoft');
	assert.equal(url.repository, 'TypeScript');
	assert.equal(url.route, 'tree');
	assert.equal(url.branch, 'master');
	assert.equal(url.filePath, 'package.json');
	assert.equal(url.pathname, '/microsoft/TypeScript/tree/master/package.json');
	assert.equal(url.href, 'https://github.com/microsoft/TypeScript/tree/master/package.json');
	assert.equal(String(url), 'https://github.com/microsoft/TypeScript/tree/master/package.json');
});

test('get filePath from search', () => {
	const url = new GitHubFileURL('https://github.com/yakov116/refined-github/commits/f23b687b3b89aa95a76193722cdfeff740646670?after=f23b687b3b89aa95a76193722cdfeff740646670+34&path%5B%5D=source&path%5B%5D=features&path%5B%5D=release-download-count.tsx');
	assert.equal(url.user, 'yakov116');
	assert.equal(url.repository, 'refined-github');
	assert.equal(url.route, 'commits');
	assert.equal(url.branch, 'f23b687b3b89aa95a76193722cdfeff740646670');
	assert.equal(url.filePath, 'source/features/release-download-count.tsx');
	assert.equal(url.pathname, '/yakov116/refined-github/commits/f23b687b3b89aa95a76193722cdfeff740646670/source/features/release-download-count.tsx');
	assert.equal(url.href, 'https://github.com/yakov116/refined-github/commits/f23b687b3b89aa95a76193722cdfeff740646670/source/features/release-download-count.tsx?after=f23b687b3b89aa95a76193722cdfeff740646670+34');
	assert.equal(url.search, '?after=f23b687b3b89aa95a76193722cdfeff740646670+34');
	assert.equal(String(url), 'https://github.com/yakov116/refined-github/commits/f23b687b3b89aa95a76193722cdfeff740646670/source/features/release-download-count.tsx?after=f23b687b3b89aa95a76193722cdfeff740646670+34');
});



================================================
FILE: source/github-helpers/github-file-url.ts
================================================
import {isRepoRoot} from 'github-url-detection';

import getCurrentGitRef from './get-current-git-ref.js';

export default class GitHubFileURL {
	user = '';
	repository = '';
	route = '';
	branch = '';
	filePath = '';

	private readonly internalUrl: URL;

	constructor(url: string) {
		// Use Facade pattern instead of inheritance #3193
		this.internalUrl = new URL(url);
		this.pathname = this.internalUrl.pathname;
	}

	toString(): string {
		return this.href;
	}

	assign(...replacements: Array<Partial<GitHubFileURL>>): this {
		Object.assign(this, ...replacements);
		return this;
	}

	// Handle branch names containing multiple slashes #4492
	private disambiguateReference(
		ambiguousReference: string[],
	): {branch: string; filePath: string} {
		const branch = ambiguousReference[0];
		// History pages might use search parameters
		const filePathFromSearch = this.searchParams.getAll('path[]').join('/');
		if (filePathFromSearch) {
			this.searchParams.delete('path[]');
			return {branch, filePath: filePathFromSearch};
		}

		const filePath = ambiguousReference.slice(1).join('/');

		// TODO: `getCurrentGitRef` uses global state https://github.com/refined-github/refined-github/issues/6637
		const currentBranch = getCurrentGitRef();
		const currentBranchSections = currentBranch?.split('/');
		if (
			!currentBranch // Current branch could not be determined (1/2)
			|| !currentBranchSections // Current branch could not be determined (2/2)
			|| ambiguousReference.length === 1 // Ref has no slashes
			|| currentBranchSections.length === 1 // Current branch has no slashes
		) {
			// Then the reference is not ambiguous
			return {branch, filePath};
		}

		for (const [index, section] of currentBranchSections.entries()) {
			if (ambiguousReference[index] !== section) {
				console.warn(`The supplied path (${ambiguousReference.join('/')}) is ambiguous (current reference is \`${currentBranch}\`)`);
				return {branch, filePath};
			}
		}

		return {
			branch: currentBranch,
			filePath: ambiguousReference.slice(currentBranchSections.length).join('/'),
		};
	}

	get pathname(): string {
		return `/${this.user}/${this.repository}/${this.route}/${this.branch}/${this.filePath}`.replaceAll(/(?:(?:undefined)?\/)+$/g, '');
	}

	set pathname(pathname: string) {
		const [user, repository, route, ...ambiguousReference] = pathname
			.replaceAll(/^\/|\/$/g, '')
			.replaceAll('%2F', '/') // Escaped in some cases
			.split('/');

		// If GitHubFileURL is being used on the current URL, then allow its "same page" optimizations to work (i.e. parse document.title)
		if (pathname === location.pathname ? isRepoRoot() : isRepoRoot(new URL(pathname, this.internalUrl))) {
			this.assign({
				user,
				repository,
				route,
				branch: ambiguousReference.join('/'),
				filePath: '',
			});
			return;
		}

		const {branch, filePath} = this.disambiguateReference(ambiguousReference);
		this.assign({
			user,
			repository,
			route,
			branch,
			filePath,
		});
	}

	get href(): string {
		// Update the actual underlying URL
		this.internalUrl.pathname = this.pathname;
		return this.internalUrl.href;
	}

	set href(href: string) {
		this.internalUrl.href = href;
	}

	// Proxy all other getters/setters to internalUrl

	get hash(): string {
		return this.internalUrl.hash;
	}

	set hash(hash: string) {
		this.internalUrl.hash = hash;
	}

	get search(): string {
		return this.internalUrl.search;
	}

	set search(search: string) {
		this.internalUrl.search = search;
	}

	get searchParams(): URLSearchParams {
		return this.internalUrl.searchParams;
	}
}



================================================
FILE: source/github-helpers/github-token.ts
================================================
import {CachedFunction} from 'webext-storage-cache';
import * as pageDetect from 'github-url-detection';

// Avoid importing api.js here, there's too much logic/caching we don't need
import {getToken} from '../options-storage.js';
import hashString from '../helpers/hash-string.js';

type BaseApiFetchOptions = {
	apiBase: string;
	token: string;
	path: string;
};

export async function baseApiFetch({apiBase, token, path}: BaseApiFetchOptions): Promise<Response> {
	if (!apiBase.endsWith('/')) {
		throw new TypeError('apiBase must end with a slash');
	}

	const response = await fetch(
		new URL(path, apiBase),
		{
			cache: 'no-store',
			headers: {
				'User-Agent': 'Refined GitHub',
				Accept: 'application/vnd.github.v3+json',
				Authorization: `token ${token}`,
			},
		},
	);

	if (!response.ok) {
		const details = await response.json();
		throw new Error(details.message);
	}

	return response;
}

export const tokenUser = new CachedFunction('token-user', {
	async updater(apiBase: string, token: string): Promise<string> {
		const response = await baseApiFetch({apiBase, token, path: 'user'});
		const details = await response.json();
		return details.login;
	},
	maxAge: {
		// The exact token is forever associated to the user
		days: 365,
	},
	cacheKey: ([apiBase, token]) => hashString(`${apiBase}-${token}`),
});

export async function expectToken(): Promise<string> {
	const token = await getToken();
	if (!token) {
		throw new Error('Personal token required for this feature');
	}

	return token;
}

export async function hasValidGitHubComToken(token?: string): Promise<boolean> {
	token ??= await getToken();
	if (!token) {
		return false;
	}

	try {
		await baseApiFetch({apiBase: 'https://api.github.com/', path: '', token});
		return true;
	} catch {
		return false;
	}
}

function parseTokenScopes(headers: Headers): string[] {
	// If `X-OAuth-Scopes` is not present, the token may be not a classic token.
	const scopesHeader = headers.get('X-OAuth-Scopes');
	if (!scopesHeader) {
		// If the request succeeded but lacked this header, it's likely a fine-grained token
		// https://github.com/orgs/community/discussions/25259#discussioncomment-3247158
		return ['valid_token', 'unknown'];
	}

	const scopes = scopesHeader.split(', ');
	scopes.push('valid_token');
	if (scopes.includes('repo')) {
		scopes.push('public_repo');
	}

	if (scopes.includes('project')) {
		scopes.push('read:project');
	}

	return scopes;
}

type TokenInfo = {
	scopes: string[];
	expiration?: string;
};

export async function getTokenInfo(apiBase: string, personalToken: string): Promise<TokenInfo> {
	const response = await baseApiFetch({apiBase, token: personalToken, path: ''});
	return {
		scopes: parseTokenScopes(response.headers),
		expiration: response.headers.get('GitHub-Authentication-Token-Expiration') ?? undefined,
	};
}

export async function expectTokenScope(scope: string): Promise<void> {
	const token = await expectToken();
	const api = pageDetect.isEnterprise()
		? `${location.origin}/api/v3/`
		: 'https://api.github.com/';

	const {scopes: tokenScopes} = await getTokenInfo(api, token);
	if (!tokenScopes.includes(scope)) {
		throw new Error('The token you provided does not have ' + (tokenScopes.length > 0 ? `the \`${scope}\` scope. It only includes \`${tokenScopes.join(', ')}\`.` : 'any scope. You can change the scope of your token at https://github.com/settings/tokens'));
	}
}



================================================
FILE: source/github-helpers/group-buttons.tsx
================================================
import React from 'dom-chef';
import {$} from 'select-dom/strict.js';

import {wrapAll} from '../helpers/dom-utils.js';

// Wrap a list of elements with BtnGroup + ensure each has BtnGroup-item
export function groupButtons(buttons: Element[], ...classes: string[]): HTMLElement {
	// Ensure every button has this class
	for (let button of buttons) {
		if (!button.matches('button, .btn')) {
			button.classList.add('BtnGroup-parent');
			button = $('.btn', button);
		}

		button.classList.add('BtnGroup-item');
	}

	// They may already be part of a group
	let group = buttons[0].closest('.BtnGroup');

	// If it doesn't exist, wrap them in a new group
	if (!group) {
		group = <div className="BtnGroup" />;
		wrapAll(group, ...buttons);
	}

	group.classList.add(...classes);

	return group;
}

// Find immediate `.btn` siblings of `button` and wrap them with groupButtons
export function groupSiblings(button: Element): Element {
	const siblings = [button];
	let previous = button.previousElementSibling;
	while (previous?.classList.contains('btn')) {
		siblings.unshift(previous);
		previous = previous.previousElementSibling;
	}

	let next = button.nextElementSibling;
	while (next?.classList.contains('btn')) {
		siblings.push(next);
		next = next.nextElementSibling;
	}

	return groupButtons(siblings);
}



================================================
FILE: source/github-helpers/heat-map.css
================================================
:root {
	--rgh-heat-color: #c24e00;

	[data-rgh-heat='1'] {
		color: color-mix(
			in srgb,
			var(--rgh-heat-color) 100%,
			var(--fgColor-muted, var(--color-fg-muted))
		) !important;
	}

	[data-rgh-heat='2'] {
		color: color-mix(
			in srgb,
			var(--rgh-heat-color) 90%,
			var(--fgColor-muted, var(--color-fg-muted))
		) !important;
	}

	[data-rgh-heat='3'] {
		color: color-mix(
			in srgb,
			var(--rgh-heat-color) 80%,
			var(--fgColor-muted, var(--color-fg-muted))
		) !important;
	}

	[data-rgh-heat='4'] {
		color: color-mix(
			in srgb,
			var(--rgh-heat-color) 70%,
			var(--fgColor-muted, var(--color-fg-muted))
		) !important;
	}

	[data-rgh-heat='5'] {
		color: color-mix(
			in srgb,
			var(--rgh-heat-color) 60%,
			var(--fgColor-muted, var(--color-fg-muted))
		) !important;
	}

	[data-rgh-heat='6'] {
		color: color-mix(
			in srgb,
			var(--rgh-heat-color) 50%,
			var(--fgColor-muted, var(--color-fg-muted))
		) !important;
	}

	[data-rgh-heat='7'] {
		color: color-mix(
			in srgb,
			var(--rgh-heat-color) 40%,
			var(--fgColor-muted, var(--color-fg-muted))
		) !important;
	}

	[data-rgh-heat='8'] {
		color: color-mix(
			in srgb,
			var(--rgh-heat-color) 30%,
			var(--fgColor-muted, var(--color-fg-muted))
		) !important;
	}

	[data-rgh-heat='9'] {
		color: color-mix(
			in srgb,
			var(--rgh-heat-color) 20%,
			var(--fgColor-muted, var(--color-fg-muted))
		) !important;
	}

	[data-rgh-heat='10'] {
		color: color-mix(
			in srgb,
			var(--rgh-heat-color) 0%,
			var(--fgColor-muted, var(--color-fg-muted))
		) !important;
	}
}



================================================
FILE: source/github-helpers/hotkey.tsx
================================================
import React from 'dom-chef';

import {isMac} from './index.js';

export function registerHotkey(hotkey: string, functionOrUrl: VoidFunction | string, {signal}: SignalAsOptions = {}): void {
	const element = typeof functionOrUrl === 'string'
		? <a hidden href={functionOrUrl} data-hotkey={hotkey} />
		: <button hidden type="button" data-hotkey={hotkey} onClick={functionOrUrl} />;

	document.body.prepend(element);

	signal?.addEventListener('abort', () => {
		element.remove();
	});
}

/** Safely add a hotkey to an element, preserving any existing ones and avoiding duplicates */
export function addHotkey(button: HTMLAnchorElement | HTMLButtonElement | undefined, hotkey: string): void {
	if (button) {
		const hotkeys = new Set(button.dataset.hotkey?.split(','));
		hotkeys.add(hotkey);
		button.dataset.hotkey = [...hotkeys].join(',');
	}
}

// eslint-disable-next-line unicorn/prevent-abbreviations
export const modKey = isMac ? 'cmd' : 'ctrl';



================================================
FILE: source/github-helpers/hotkeys.test.ts
================================================
import {test, assert} from 'vitest';

import {
	addHotkey,
} from './hotkey.js';

function testAddHotkey(existing: string | undefined, added: string, final: string): void {
	const link = document.createElement('a');
	if (existing) {
		link.setAttribute('data-hotkey', existing);
	}

	addHotkey(link, added);
	assert.equal(link.dataset.hotkey, final);
}

test('addHotkey if one is specified', testAddHotkey.bind(
	undefined,
	'T-REX',
	'CHICKEN',
	'T-REX,CHICKEN',
));
test('addHotkey if the same is already specified', testAddHotkey.bind(
	undefined,
	'CHICKEN',
	'CHICKEN',
	'CHICKEN',
));
test('addHotkey when none are specified', testAddHotkey.bind(
	undefined,
	undefined,
	'CHICKEN',
	'CHICKEN',
));



================================================
FILE: source/github-helpers/icon-loading.tsx
================================================
import React from 'dom-chef';

export default function LoadingIcon(): JSX.Element {
	return (
		<img
			className="rgh-loading-icon"
			src="https://github.githubassets.com/images/spinners/octocat-spinner-128.gif"
			width="18"
		/>
	);
}



================================================
FILE: source/github-helpers/index.test.ts
================================================
import {test, assert} from 'vitest';

import {
	getConversationNumber,
	parseTag,
	isUsernameAlreadyFullName,
	getLatestVersionTag,
} from './index.js';

test('getConversationNumber', () => {
	const pairs = new Map<string, number | undefined>([
		[
			'https://github.com',
			undefined,
		],
		[
			'https://gist.github.com/',
			undefined,
		],
		[
			'https://github.com/settings/developers',
			undefined,
		],
		[
			'https://github.com/refined-github/refined-github',
			undefined,
		],
		[
			'https://github.com/refined-github/refined-github/',
			undefined,
		],
		[
			'https://github.com/refined-github/refined-github/blame/main/package.json',
			undefined,
		],
		[
			'https://github.com/refined-github/refined-github/commit/57bf4',
			undefined,
		],
		[
			'https://github.com/refined-github/refined-github/compare/test-branch?quick_pull=0',
			undefined,
		],
		[
			'https://github.com/refined-github/refined-github/tree/main/distribution',
			undefined,
		],
		[
			'https://github.com/refined-github/refined-github/pull/148/commits/0019603b83bd97c2f7ef240969f49e6126c5ec85',
			148,
		],
		[
			'https://github.com/refined-github/refined-github/pull/148/commits/00196',
			148,
		],
		[
			'https://github.com/refined-github/refined-github/pull/148/commits',
			148,
		],
		[
			'https://github.com/refined-github/refined-github/pull/148',
			148,
		],
		[
			'https://github.com/refined-github/refined-github/issues/146',
			146,
		],
		[
			'https://github.com/refined-github/refined-github/issues',
			undefined,
		],
	]);
	for (const [url, result] of pairs) {
		location.href = url;
		assert.equal(result, getConversationNumber());
	}
});

test('parseTag', () => {
	assert.deepEqual(parseTag(''), {namespace: '', version: ''});
	assert.deepEqual(parseTag('1.2.3'), {namespace: '', version: '1.2.3'});
	assert.deepEqual(parseTag('@1.2.3'), {namespace: '', version: '1.2.3'});
	assert.deepEqual(parseTag('hi@1.2.3'), {namespace: 'hi', version: '1.2.3'});
	assert.deepEqual(parseTag('hi/you@1.2.3'), {namespace: 'hi/you', version: '1.2.3'});
	assert.deepEqual(parseTag('@hi/you@1.2.3'), {namespace: '@hi/you', version: '1.2.3'});
});

test('isUsernameAlreadyFullName', () => {
	assert.isTrue(isUsernameAlreadyFullName('johndoe', 'John Doe'));
	assert.isTrue(isUsernameAlreadyFullName('john-doe', 'John Doe'));
	assert.isTrue(isUsernameAlreadyFullName('john-wdoe', 'John W. Doe'));
	assert.isTrue(isUsernameAlreadyFullName('john-doe-jr', 'John Doe Jr.'));
	assert.isTrue(isUsernameAlreadyFullName('nicolo', 'NicolÃ²'));

	assert.isFalse(isUsernameAlreadyFullName('wonderful', 'wonder'));
	assert.isFalse(isUsernameAlreadyFullName('dotconnor', 'Connor Love'));
	assert.isFalse(isUsernameAlreadyFullName('fregante', 'Federico Brigante'));
	assert.isFalse(isUsernameAlreadyFullName('chipwolf', 'Chip Wolf â€® '));
});

test('getLatestVersionTag', () => {
	assert.equal(getLatestVersionTag([
		'0.0.0',
		'v1.1',
		'r2.0',
		'3.0',
	]), '3.0', 'Tags should be sorted by version');

	assert.equal(getLatestVersionTag([
		'v2.1-0',
		'v2.0',
		'r1.5.5',
		'r1.0',
		'v1.0-1',
	]), 'v2.0', 'Prereleases should be ignored');

	assert.equal(getLatestVersionTag([
		'lol v0.0.0',
		'2.0',
		'2020-10-10',
		'v1.0-1',
	]), 'lol v0.0.0', 'Non-version tags should short-circuit the sorting and return the first tag');
});



================================================
FILE: source/github-helpers/index.ts
================================================
import {$optional, $} from 'select-dom/strict.js';
import {elementExists} from 'select-dom';
import elementReady from 'element-ready';
import compareVersions from 'tiny-version-compare';
import type {RequireAtLeastOne} from 'type-fest';
import * as pageDetect from 'github-url-detection';
import mem from 'memoize';

import {branchSelector} from './selectors.js';

// Re-export for convenience
export const {getRepositoryInfo: getRepo, getCleanPathname, getLoggedInUser} = pageDetect.utils;

export function getConversationNumber(): number | undefined {
	const [, _owner, _repo, type, prNumber] = location.pathname.split('/');
	return (type === 'pull' || type === 'issues') && Number(prNumber) ? Number(prNumber) : undefined;
}

export const isMac = navigator.userAgent.includes('Macintosh');

type Not<Yes, Not> = Yes extends Not ? never : Yes;
type UnslashedString<S extends string> = Not<S, `/${string}` | `${string}/`>;

export function buildRepoURL<S extends string>(...pathParts: RequireAtLeastOne<Array<UnslashedString<S> | number>, 0>): string {
	for (const part of pathParts) {
		if (typeof part === 'string' && /^\/|\/$/.test(part)) {
			throw new TypeError('The path parts shouldnâ€™t start or end with a slash: ' + part);
		}
	}

	return [location.origin, getRepo()?.nameWithOwner, ...pathParts].join('/');
}

export function getForkedRepo(): string | undefined {
	return $optional('meta[name="octolytics-dimension-repository_parent_nwo"]')?.content;
}

export function parseTag(tag: string): {version: string; namespace: string} {
	const [, namespace = '', version = ''] = /(?:(.*)@)?([^@]+)/.exec(tag) ?? [];
	return {namespace, version};
}

export function isUsernameAlreadyFullName(username: string, realname: string): boolean {
	// Normalize both strings
	username = username
		.replaceAll('-', '')
		.toLowerCase();
	realname = realname
		.normalize('NFD')
		// Remove diacritics, punctuation and spaces
		// https://stackoverflow.com/a/37511463/288906
		// https://www.freecodecamp.org/news/what-is-punct-in-regex-how-to-match-all-punctuation-marks-in-regular-expressions/
		.replaceAll(/[\p{Diacritic}\p{P}\s]/gu, '')
		.toLowerCase();

	return username === realname;
}

const validVersion = /^[vr]?\d+(?:\.\d+)+/;
const isPrerelease = /^[vr]?\d+(?:\.\d+)+(?:-\d)/;
export function getLatestVersionTag(tags: string[]): string {
	// Some tags aren't valid versions; comparison is meaningless.
	// Just use the latest tag returned by the API (reverse chronologically-sorted list)
	if (!tags.every(tag => validVersion.test(tag))) {
		return tags[0];
	}

	// Exclude pre-releases
	let releases = tags.filter(tag => !isPrerelease.test(tag));
	if (releases.length === 0) { // They were all pre-releases; undo.
		releases = tags;
	}

	let latestVersion = releases[0];
	for (const release of releases) {
		if (compareVersions(latestVersion, release) < 0) {
			latestVersion = release;
		}
	}

	return latestVersion;
}

// https://github.com/idimetrix/text-case/blob/master/packages/upper-case-first/src/index.ts
export function upperCaseFirst(input: string): string {
	return input.charAt(0).toUpperCase() + input.slice(1).toLowerCase();
}

const cachePerPage = {
	cacheKey: () => location.pathname,
};

/** Is tag or commit, with elementReady */
export const isPermalink = mem(async () => {
	// No need for getCurrentGitRef(), it's a simple and exact check
	if (/^[\da-f]{40}$/.test(location.pathname.split('/')[4])) {
		// It's a commit
		return true;
	}

	// Awaiting only the branch selector means it resolves early even if the icon tag doesn't exist, whereas awaiting the icon tag would wait for the DOM ready event before resolving.
	return elementExists(
		'.octicon-tag', // Tags have an icon
		await elementReady(branchSelector),
	);
}, cachePerPage);

export function isRefinedGitHubRepo(): boolean {
	return location.pathname.startsWith('/refined-github/refined-github');
}

export function isAnyRefinedGitHubRepo(): boolean {
	return /^\/refined-github\/.+/.test(location.pathname);
}

export function isRefinedGitHubYoloRepo(): boolean {
	return location.pathname.startsWith('/refined-github/yolo');
}

export async function isArchivedRepoAsync(): Promise<boolean> {
	// Load the bare minimum for `isArchivedRepo` to work
	await elementReady('main > div');

	// DOM-based detection, we want awaitDomReady: false, so it needs to be here
	return pageDetect.isArchivedRepo();
}

export const userCanLikelyMergePR = (): boolean => elementExists('.discussion-sidebar-item .octicon-lock');

export const cacheByRepo = (): string => getRepo()!.nameWithOwner;

// Commit lists for files and folders lack a branch selector
export const isRepoCommitListRoot = (): boolean => pageDetect.isRepoCommitList() && document.title.startsWith('Commits');

export const isUrlReachable = mem(async (url: string): Promise<boolean> => {
	const {ok} = await fetch(url, {method: 'head'});
	return ok;
});

// Don't make the argument optional, sometimes we really expect it to exist and want to throw an error
export function extractCurrentBranchFromBranchPicker(branchPicker: HTMLElement): string {
	return branchPicker.title === 'Switch branches or tags'
		? branchPicker.textContent.trim() // Branch name is shown in full
		: branchPicker.title; // Branch name was clipped, so they placed it in the title attribute
}

export function addAfterBranchSelector(branchSelectorParent: HTMLDetailsElement, sibling: HTMLElement): void {
	const row = branchSelectorParent.closest('.position-relative')!;
	row.classList.add('d-flex', 'flex-shrink-0', 'gap-2');
	row.append(sibling);
}

/** Trigger a conversation update if the view is out of date */
// https://github.com/refined-github/refined-github/issues/2465#issuecomment-567173300
export function triggerConversationUpdate(): void {
	const marker = $('.js-timeline-marker');
	marker.dispatchEvent(new CustomEvent('socket:message', {
		bubbles: true,
		detail: {data: {gid: marker.dataset.gid}},
	}));
}

// Fix z-index issue https://github.com/refined-github/refined-github/pull/7430
export function fixFileHeaderOverlap(child: Element): void {
	// In the sidebar the container is not present and this fix is not needed
	child.closest('.container')?.classList.add('rgh-z-index-5');
}

/** Trigger a reflow to push the right-most tab into the overflow dropdown */
export function triggerRepoNavOverflow(): void {
	globalThis.dispatchEvent(new Event('resize'));
}

export function triggerActionBarOverflow(child: Element): void {
	const parent = child.closest('action-bar')!;
	const placeholder = document.createElement('div');
	parent.replaceWith(placeholder);
	placeholder.replaceWith(parent);
}

export function multilineAriaLabel(...lines: string[]): string {
	return lines.join('\n');
}

export function scrollIntoViewIfNeeded(element: Element): void {
	// @ts-expect-error No Firefox support https://developer.mozilla.org/en-US/docs/Web/API/Element/scrollIntoViewIfNeeded
	(element.scrollIntoViewIfNeeded ?? element.scrollIntoView).call(element);
}

function getConversationAuthor(): string | undefined {
	return $optional('#partial-discussion-header .gh-header-meta .author')?.textContent;
}

export function isOwnConversation(): boolean {
	return getConversationAuthor() === getLoggedInUser();
}

export function assertCommitHash(hash: string): void {
	if (!/^[0-9a-f]{40}$/.test(hash)) {
		throw new Error(`Invalid commit hash: ${hash}`);
	}
}



================================================
FILE: source/github-helpers/is-conversation-locked.gql
================================================
query GetIssueLockStatus($owner: String!, $name: String!, $number: Int!) {
	repository(owner: $owner, name: $name) {
		issueOrPullRequest(number: $number) {
			... on Lockable {
				locked
			}
		}
	}
}



================================================
FILE: source/github-helpers/is-conversation-locked.ts
================================================
import elementReady from 'element-ready';

import {isInitialLoad} from '../helpers/feature-helpers.js';
import {hasToken} from '../options-storage.js';
import api from '../github-helpers/api.js';
import GetIssueLockStatus from './is-conversation-locked.gql';
import {getConversationNumber} from '../github-helpers/index.js';

async function isConversationLockedViaApi(): Promise<boolean | undefined> {
	if (!await hasToken()) {
		return undefined;
	}

	const {repository} = await api.v4uncached(GetIssueLockStatus, {
		variables: {
			number: getConversationNumber()!,
		},
	});

	return repository.issueOrPullRequest.locked;
}

async function isConversationLockedViaDom(): Promise<boolean | undefined> {
	// The form only appears to moderators
	const lockToggle = await elementReady([
		'.discussion-sidebar-item svg.octicon-key + strong', // PRs, old issues
		'[class^="Item__LiBox"]:has(svg.octicon-lock) [data-component="ActionList.Item--DividerContainer"] span', // Issues
	].join(', '));
	return lockToggle ? lockToggle.textContent === 'Unlock conversation' : undefined;
}

async function isConversationLockedViaReactData(): Promise<boolean | undefined> {
	if (!isInitialLoad()) {
		return;
	}

	const data = await elementReady('[data-target="react-app.embeddedData"]');
	return data ? JSON.parse(data.textContent).payload?.preloadedQueries[0].result.data.repository?.issue?.locked : undefined;
}

export default async function isConversationLocked(): Promise<boolean | undefined> {
	// Like Promise.race, but it only resolves if the result is not undefined
	return new Promise(resolve => {
		// TODO: Add AbortSignal after https://github.com/sindresorhus/element-ready/issues/45
		const resolveIfDefined = async (check: () => Promise<boolean | undefined>): Promise<void> => {
			const result = await check();
			if (result !== undefined) {
				resolve(result);
			}
		};

		void resolveIfDefined(isConversationLockedViaReactData);
		void resolveIfDefined(isConversationLockedViaDom);
		void resolveIfDefined(isConversationLockedViaApi);
	});
}



================================================
FILE: source/github-helpers/is-default-branch.ts
================================================
import getDefaultBranch from './get-default-branch.js';
import {getRepo} from './index.js';

/** Detects if the current view is on the default branch. To be used on file/folder/commit lists */
export default async function isDefaultBranch(): Promise<boolean> {
	const repo = getRepo();
	if (!repo) {
		// Like /settings/repositories
		return false;
	}

	const [type, ...parts] = repo.path.split('/');
	if (parts.length === 0) {
		// Exactly /user/repo, which is on the default branch
		return true;
	}

	if (!['tree', 'blob', 'commits'].includes(type)) {
		// Like /user/repo/pulls
		return false;
	}

	// Don't use `getCurrentGitRef` because it requires too much DOM. This is good enough, it only fails when:
	// defaultBranch === 'a/b' && currentBranch === 'a'
	const path = parts.join('/');
	const defaultBranch = await getDefaultBranch();
	return path === defaultBranch || path.startsWith(`${defaultBranch}/`);
}



================================================
FILE: source/github-helpers/load-details-menu.ts
================================================
import {$optional} from 'select-dom/strict.js';
import oneEvent from 'one-event';

export default async function loadDetailsMenu(detailsMenu: HTMLElement): Promise<void> {
	const fragment = $optional('.js-comment-header-actions-deferred-include-fragment', detailsMenu);
	if (!fragment) {
		return;
	}

	detailsMenu.parentElement!.dispatchEvent(new Event('mouseover'));
	await oneEvent(fragment, 'load');
}



================================================
FILE: source/github-helpers/parse-backticks.test.ts
================================================
import {test, assert} from 'vitest';

import {getParsedBackticksParts} from './parse-backticks.js';

function parseBackticks(string: string): string {
	return getParsedBackticksParts(string).map(
		(part, index) => index % 2 && part.length > 0 ? `<code>${part.trim()}</code>` : part,
	).join('');
}

test('parseBackticks', () => {
	assert.equal(
		parseBackticks('multiple `code spans` between ` other ` text'),
		'multiple <code>code spans</code> between <code>other</code> text',
	);
	assert.equal(
		parseBackticks('`code` at the start'),
		'<code>code</code> at the start',
	);
	assert.equal(
		parseBackticks('code at the `end`'),
		'code at the <code>end</code>',
	);
	assert.equal(
		parseBackticks('single backtick in a code span: `` ` ``'),
		'single backtick in a code span: <code>`</code>',
	);
	assert.equal(
		parseBackticks('backtick-delimited string in a code span: `` `foo` ``'),
		'backtick-delimited string in a code span: <code>`foo`</code>',
	);
	assert.equal(
		parseBackticks('single-character code span: `a`'),
		'single-character code span: <code>a</code>',
	);
	assert.equal(
		parseBackticks(`
			triple-backtick multiline block
			\`\`\`
			foo
			bar
			\`\`\`
			in some text #3990
		`),
		`
			triple-backtick multiline block
			\`\`\`
			foo
			bar
			\`\`\`
			in some text #3990
		`,
	);
	assert.equal(
		parseBackticks(`
			empty triple-backtick block
			\`\`\`
			\`\`\`
		`),
		`
			empty triple-backtick block
			\`\`\`
			\`\`\`
		`,
	);
	assert.equal(
		parseBackticks(`
			triple-backtick code block
			\`\`\`
			foo
			bar
			\`\`\`
			in some text #3990
		`),
		`
			triple-backtick code block
			\`\`\`
			foo
			bar
			\`\`\`
			in some text #3990
		`,
	);
	assert.equal(
		parseBackticks(`
			hello\`
			\`world
		`),
		`
			hello\`
			\`world
		`,
	);
	assert.equal(
		parseBackticks(`
			hello\`\` red
			\`\`world
		`),
		`
			hello\`\` red
			\`\`world
		`,
	);
});



================================================
FILE: source/github-helpers/parse-backticks.tsx
================================================
import React from 'dom-chef';

const splittingRegex = /`` (.*?) ``|`([^`\n]+)`/g;

export function getParsedBackticksParts(string: string): string[] {
	return string.split(splittingRegex)
		.filter(part => part !== undefined); // Only one of the regexp's capture groups matches
}

export default function parseBackticks(description: string): DocumentFragment {
	const fragment = new DocumentFragment();
	for (const [index, text] of getParsedBackticksParts(description).entries()) {
		if (index % 2 && text.length > 0) {
			// `span.sr-only` keeps the backticks copy-pastable but invisible
			fragment.append(
				<span className="sr-only">`</span>,
				<code className="rgh-parse-backticks">{text.trim()}</code>,
				<span className="sr-only">`</span>,
			);
		} else if (text.length > 0) {
			fragment.append(text);
		}
	}

	return fragment;
}



================================================
FILE: source/github-helpers/parse-compare-url.test.ts
================================================
import {expect, test} from 'vitest';

import parseCompareUrl from './parse-compare-url.js';

const base = {
	branch: 'main',
	repo: 'john/recipes',
};

test('parseCompareUrl', () => {
	expect(parseCompareUrl('/john/recipes/compare')).toBe(undefined);
	expect(parseCompareUrl('/john/recipes/compare/main')).toBe(undefined);
	expect(parseCompareUrl('/john/recipes/compare/main...patch-1')).toMatchObject({
		base,
		head: {
			branch: 'patch-1',
			repo: 'john/recipes',
		},
		isCrossRepo: false,
	});
	expect(parseCompareUrl('/john/recipes/compare/main...patty:patch-1')).toMatchObject({
		base,
		head: {
			branch: 'patch-1',
			repo: 'patty/recipes',
		},
		isCrossRepo: true,
	});
	expect(parseCompareUrl('/john/recipes/compare/main...maria:ricette:pizza')).toMatchObject({
		base,
		head: {
			branch: 'pizza',
			repo: 'maria/ricette',
		},
		isCrossRepo: true,
	});
});



================================================
FILE: source/github-helpers/parse-compare-url.ts
================================================
import type {NameWithOwner} from 'github-url-detection';

import {getRepo} from './index.js';

type Comparison = {
	head: {
		repo: NameWithOwner;
		branch: string;
	};
	base: {
		repo: NameWithOwner;
		branch: string;
	};
	isCrossRepo: boolean;
};

const compareRegex = /compare[/]([^.]+)[.][.][.]?(.+)/;
export default function parseCompareUrl(pathname: string): Comparison | undefined {
	const base = getRepo(pathname)!;

	const [, baseBranch, heads] = compareRegex.exec(base.path) ?? [];
	if (!baseBranch) {
		return;
	}

	const headParts = heads.split(':');
	const headBranch = headParts.pop()!; // Branch is always last, or the only one
	const headOwner = headParts.shift() ?? base.owner; // The owner is first, or it's the same as the base
	const headName = headParts.pop() ?? base.name; // The repo is first or middle, or it's the same as the base

	if (headParts.length > 0) {
		throw new Error('Invalid compare URL format');
	}

	const headRepo: NameWithOwner = `${headOwner}/${headName}`;

	return {
		base: {
			repo: base.nameWithOwner,
			branch: baseBranch,
		},
		head: {
			repo: headRepo,
			branch: headBranch,
		},
		isCrossRepo: headRepo !== base.nameWithOwner,
	};
}



================================================
FILE: source/github-helpers/pr-branches.test.ts
================================================
import {test, assert} from 'vitest';

import {parseReferenceRaw} from './pr-branches.js';

test('parseReferenceRaw', () => {
	assert.deepEqual(parseReferenceRaw('fregante/mem:main', 'main'), {
		absolute: 'fregante/mem:main',
		relative: 'main',
		owner: 'fregante',
		name: 'mem',
		nameWithOwner: 'fregante/mem',
		branch: 'main',
	});
	assert.deepEqual(parseReferenceRaw('134130/refined-github:feature/#5942', '134130:feature/#5942'), {
		absolute: '134130/refined-github:feature/#5942',
		relative: '134130:feature/#5942',
		owner: '134130',
		name: 'refined-github',
		nameWithOwner: '134130/refined-github',
		branch: 'feature/#5942',
	});

	assert.throws(
		() => parseReferenceRaw('mem:main', 'main'),
		TypeError,
		'Expected `absolute` to be "user/repo:branch", got "mem:main"',
	);
	assert.throws(
		() => parseReferenceRaw('fregante/mem:main', 'fregante/mem'),
		TypeError,
		'Expected `relative` to be either "main" or "fregante:main", got "fregante/mem"',
	);
	assert.throws(
		() => parseReferenceRaw('fregante/mem:main', 'main:main'),
		TypeError,
		'Expected `relative` to be either "main" or "fregante:main", got "main:main"',
	);
});



================================================
FILE: source/github-helpers/pr-branches.ts
================================================
import {$} from 'select-dom/strict.js';

type PrReference = {
	/** @example fregante/mem:main */
	absolute: string;

	/** @example "main" on same-repo PRs, "fregante:main" on cross-repo PRs  */
	relative: string;

	/** @example fregante */
	owner: string;

	/** @example mem */
	name: string;

	/** @example main */
	branch: string;

	/** @example fregante:mem */
	nameWithOwner: string;
};

const absoluteReferenceRegex = /^(?<nameWithOwner>(?<owner>[^:/]+)\/(?<name>[^:]+)):(?<branch>.+)$/;

/**
 * @param absolute - The full reference, e.g. `fregante/mem:main`
 * @param relative - The references it appear to the user in the PR, e.g. "main" on same-repo PRs, "fregante:main" on cross-repo PRs
 * @example parseReferenceRaw('fregante/mem:main', 'main')
 */
export function parseReferenceRaw(absolute: string, relative: string): PrReference {
	const absoluteMatch = absoluteReferenceRegex.exec(absolute);
	if (!absoluteMatch) {
		throw new TypeError(`Expected \`absolute\` to be "user/repo:branch", got "${absolute}"`);
	}

	const {owner, name, nameWithOwner, branch} = absoluteMatch.groups!;

	// We must receive the relative reference because it also tells whether it's a cross-repo PR
	const expectedRelative = [branch, `${owner}:${branch}`];
	if (!expectedRelative.includes(relative)) {
		throw new TypeError(`Expected \`relative\` to be either "${expectedRelative.join('" or "')}", got "${relative}"`);
	}

	return {
		owner,
		name,
		branch,
		nameWithOwner,
		absolute,
		relative,
	};
}

function parseReference(referenceElement: HTMLElement): PrReference {
	const {title, textContent, nextElementSibling} = referenceElement;

	// In the React version, we have a `title` attribute but it's used to mark deleted repos instead
	return title && title !== 'This repository has been deleted'
		? parseReferenceRaw(title, textContent.trim()) // TODO: Remove in June 2026
		: parseReferenceRaw(nextElementSibling!.textContent.trim(), textContent.trim());
}

export function getBranches(): {base: PrReference; head: PrReference} {
	return {
		get base() {
			return parseReference($([
				'[class*="PullRequestHeaderSummary"] > [class*="PullRequestHeaderSummary"]',
				'.base-ref', // TODO: Remove in June 2026
			]));
		},
		get head() {
			return parseReference($([
				'[class*="PullRequestHeaderSummary"] * [class*="PullRequestHeaderSummary"]',
				'.head-ref', // TODO: Remove in June 2026
			]));
		},
	};
}



================================================
FILE: source/github-helpers/prevent-link-loss.test.ts
================================================
import {test, assert} from 'vitest';

import {
	preventPrCommitLinkLoss,
	preventPrCompareLinkLoss,
	preventDiscussionLinkLoss,
	prCommitUrlRegex,
	prCompareUrlRegex,
	discussionUrlRegex,
} from './prevent-link-loss.js';

function replacePrCommitLink(string: string): string {
	return string.replace(prCommitUrlRegex, preventPrCommitLinkLoss);
}

function replacePrCompareLink(string: string): string {
	return string.replace(prCompareUrlRegex, preventPrCompareLinkLoss);
}

function replaceDiscussionLink(string: string): string {
	return string.replace(discussionUrlRegex, preventDiscussionLinkLoss);
}

test('preventPrCommitLinkLoss', () => {
	// Reset location to a non-PR page for most tests
	location.href = 'https://github.com/refined-github/refined-github';

	assert.equal(replacePrCommitLink('https://www.google.com/'), 'https://www.google.com/');
	assert.equal(
		replacePrCommitLink('https://github.com/refined-github/refined-github/commit/cb44a4eb8cd5c66def3dc26dca0f386645fa29bb'),
		'https://github.com/refined-github/refined-github/commit/cb44a4eb8cd5c66def3dc26dca0f386645fa29bb',
		'It should not affect non PR commit URLs',
	);
	assert.equal(
		replacePrCommitLink('https://github.com/refined-github/refined-github/pull/3/commits/cb44a4eb8cd5c66def3dc26dca0f386645fa29bb'),
		'[`cb44a4e` (#3)](https://github.com/refined-github/refined-github/pull/3/commits/cb44a4eb8cd5c66def3dc26dca0f386645fa29bb)',
	);
	assert.equal(
		replacePrCommitLink('lorem ipsum dolor https://github.com/refined-github/refined-github/pull/3/commits/cb44a4eb8cd5c66def3dc26dca0f386645fa29bb some random string'),
		'lorem ipsum dolor [`cb44a4e` (#3)](https://github.com/refined-github/refined-github/pull/3/commits/cb44a4eb8cd5c66def3dc26dca0f386645fa29bb) some random string',
	);
	assert.equal(
		replacePrCommitLink(replacePrCommitLink('lorem ipsum dolor https://github.com/refined-github/refined-github/pull/44/commits/cb44a4eb8cd5c66def3dc26dca0f386645fa29bb some random string')),
		'lorem ipsum dolor [`cb44a4e` (#44)](https://github.com/refined-github/refined-github/pull/44/commits/cb44a4eb8cd5c66def3dc26dca0f386645fa29bb) some random string',
		'It should not apply it twice',
	);
	assert.equal(
		replacePrCommitLink('I like [turtles](https://github.com/refined-github/refined-github/pull/3/commits/cb44a4eb8cd5c66def3dc26dca0f386645fa29bb)'),
		'I like [turtles](https://github.com/refined-github/refined-github/pull/3/commits/cb44a4eb8cd5c66def3dc26dca0f386645fa29bb)',
		'It should ignore Markdown links',
	);
	assert.equal(
		replacePrCommitLink('lorem ipsum dolor https://github.com/refined-github/refined-github/pull/3205/commits/1da152b3f8c51dd72d8ae6ad9cc96e0c2d8716f5#diff-932095cc3c0dff00495b4c392d78f0afR60 some random string'),
		'lorem ipsum dolor [`1da152b` (#3205)](https://github.com/refined-github/refined-github/pull/3205/commits/1da152b3f8c51dd72d8ae6ad9cc96e0c2d8716f5#diff-932095cc3c0dff00495b4c392d78f0afR60) some random string',
		'It should include line-permalink hashes',
	);
	assert.equal(
		replacePrCommitLink('lorem ipsum dolor https://github.com/refined-github/refined-github/pull/3205/commits/b0ac07948f9d30a760bda25a7106011441abfd5d#r438059292 some random string'),
		'lorem ipsum dolor [`b0ac079` (#3205)](https://github.com/refined-github/refined-github/pull/3205/commits/b0ac07948f9d30a760bda25a7106011441abfd5d#r438059292) some random string',
		'It should include any hashes',
	);
	assert.equal(
		replacePrCommitLink(replacePrCommitLink('lorem ipsum dolor https://github.com/refined-github/refined-github/pull/3205/commits/1da152b3f8c51dd72d8ae6ad9cc96e0c2d8716f5#diff-932095cc3c0dff00495b4c392d78f0afR60 some random string')),
		'lorem ipsum dolor [`1da152b` (#3205)](https://github.com/refined-github/refined-github/pull/3205/commits/1da152b3f8c51dd72d8ae6ad9cc96e0c2d8716f5#diff-932095cc3c0dff00495b4c392d78f0afR60) some random string',
		'It should not apply it twice even with hashes',
	);
	assert.equal(
		replacePrCommitLink('https://github.com/refined-github/shorten-repo-url/pull/33/commits/3d8d1cc8d784c7d92788a8a21e2c30cf87be3658'),
		'[refined-github/shorten-repo-url@`3d8d1cc` (#33)](https://github.com/refined-github/shorten-repo-url/pull/33/commits/3d8d1cc8d784c7d92788a8a21e2c30cf87be3658)',
	);

	// Test "this PR" behavior when on same PR
	location.href = 'https://github.com/refined-github/refined-github/pull/3205';
	assert.equal(
		replacePrCommitLink('https://github.com/refined-github/refined-github/pull/3205/commits/1da152b3f8c51dd72d8ae6ad9cc96e0c2d8716f5'),
		'[`1da152b` (this PR)](https://github.com/refined-github/refined-github/pull/3205/commits/1da152b3f8c51dd72d8ae6ad9cc96e0c2d8716f5)',
		'It should use "this PR" when on the same PR',
	);
	assert.equal(
		replacePrCommitLink('lorem ipsum dolor https://github.com/refined-github/refined-github/pull/3205/commits/b0ac07948f9d30a760bda25a7106011441abfd5d#r438059292 some random string'),
		'lorem ipsum dolor [`b0ac079` (this PR)](https://github.com/refined-github/refined-github/pull/3205/commits/b0ac07948f9d30a760bda25a7106011441abfd5d#r438059292) some random string',
		'It should use "this PR" when on the same PR with hash',
	);

	// When on PR 3205, a link to PR 44 should still show #44
	assert.equal(
		replacePrCommitLink('https://github.com/refined-github/refined-github/pull/44/commits/cb44a4eb8cd5c66def3dc26dca0f386645fa29bb'),
		'[`cb44a4e` (#44)](https://github.com/refined-github/refined-github/pull/44/commits/cb44a4eb8cd5c66def3dc26dca0f386645fa29bb)',
		'It should still use PR number when link is to a different PR',
	);

	// Reset location for other tests
	location.href = 'https://github.com/refined-github/refined-github';
});

test('preventPrCompareLinkLoss', () => {
	assert.equal(
		replacePrCompareLink('https://github.com/sindresorhus/got/compare/v11.5.2...v11.6.0'),
		'https://github.com/sindresorhus/got/compare/v11.5.2...v11.6.0',
		'It should not affect compare URLs without a diff hash',
	);
	assert.equal(
		replacePrCompareLink('https://github.com/sindresorhus/got/compare/v11.5.2...v11.6.0#diff-6be2971b2bb8dbf48d15ff680dd898b0R191'),
		'[sindresorhus/got@`v11.5.2...v11.6.0`#diff-6be2971b2b](https://github.com/sindresorhus/got/compare/v11.5.2...v11.6.0#diff-6be2971b2bb8dbf48d15ff680dd898b0R191)',
	);
	assert.equal(
		replacePrCompareLink('lorem ipsum dolor https://github.com/refined-github/refined-github/compare/main...incremental-tag-changelog-link#diff-5b3cf6bcc7c5b1373313553dc6f93a5eR7-R9 some random string'),
		'lorem ipsum dolor [`main...incremental-tag-changelog-link`#diff-5b3cf6bcc7](https://github.com/refined-github/refined-github/compare/main...incremental-tag-changelog-link#diff-5b3cf6bcc7c5b1373313553dc6f93a5eR7-R9) some random string',
	);
	assert.equal(
		replacePrCompareLink(replacePrCompareLink('lorem ipsum dolor https://github.com/sindresorhus/got/compare/v11.5.2...v11.6.0#diff-6be2971b2bb8dbf48d15ff680dd898b0R191 some random string')),
		'lorem ipsum dolor [sindresorhus/got@`v11.5.2...v11.6.0`#diff-6be2971b2b](https://github.com/sindresorhus/got/compare/v11.5.2...v11.6.0#diff-6be2971b2bb8dbf48d15ff680dd898b0R191) some random string',
		'It should not apply it twice',
	);
	assert.equal(
		replacePrCompareLink('I like [turtles](https://github.com/sindresorhus/got/compare/v11.5.2...v11.6.0#diff-6be2971b2bb8dbf48d15ff680dd898b0R191)'),
		'I like [turtles](https://github.com/sindresorhus/got/compare/v11.5.2...v11.6.0#diff-6be2971b2bb8dbf48d15ff680dd898b0R191)',
		'It should ignore Markdown links',
	);
});

test('preventDiscussionLinkLoss', () => {
	assert.equal(
		replaceDiscussionLink('https://github.com/eslint/eslint/discussions/15898'),
		'https://github.com/eslint/eslint/discussions/15898',
		'It should not affect discussion URLs without a query parameter', // It's what causes the bug
	);
	assert.equal(
		replaceDiscussionLink('https://github.com/eslint/eslint/discussions/15898#discussion-4086661'),
		'https://github.com/eslint/eslint/discussions/15898#discussion-4086661',
		'It should not affect discussion comment URLs without a query parameter', // It's what causes the bug
	);
	assert.equal(
		replaceDiscussionLink('https://github.com/eslint/eslint/discussions/15898?sort=top#discussion-4086661'),
		'[eslint/eslint#15898 (comment)](https://github.com/eslint/eslint/discussions/15898?sort=top#discussion-4086661)',
	);
	assert.equal(
		replaceDiscussionLink('https://github.com/eslint/eslint/discussions/15898?sort=top#issue-comment-box'),
		'[eslint/eslint#15898 (comment)](https://github.com/eslint/eslint/discussions/15898?sort=top#issue-comment-box)',
		'It should work on any hash',
	);
	assert.equal(
		replaceDiscussionLink('https://github.com/eslint/eslint/discussions/15898?sort=top\nhttps://github.com/eslint/eslint/discussions/15898#discussioncomment-646707'),
		'[eslint/eslint#15898](https://github.com/eslint/eslint/discussions/15898?sort=top)\nhttps://github.com/eslint/eslint/discussions/15898#discussioncomment-646707',
		'It should work separately on links.',
	);
	assert.equal(
		replaceDiscussionLink('lorem ipsum dolor https://github.com/eslint/eslint/discussions/15898?sort=top some random string'),
		'lorem ipsum dolor [eslint/eslint#15898](https://github.com/eslint/eslint/discussions/15898?sort=top) some random string',
	);
	assert.equal(
		replaceDiscussionLink(replaceDiscussionLink('lorem ipsum dolor https://github.com/eslint/eslint/discussions/15898?sort=top#discussion-4086661 some random string')),
		'lorem ipsum dolor [eslint/eslint#15898 (comment)](https://github.com/eslint/eslint/discussions/15898?sort=top#discussion-4086661) some random string',
		'It should not apply it twice',
	);
	assert.equal(
		replaceDiscussionLink('I like [turtles](https://github.com/eslint/eslint/discussions/15898#discussion-4086661)'),
		'I like [turtles](https://github.com/eslint/eslint/discussions/15898#discussion-4086661)',
		'It should ignore Markdown links',
	);
	assert.equal(
		replaceDiscussionLink('https://github.com/streetcomplete/StreetComplete/discussions/15898?sort=top#discussioncomment-646707'),
		'[streetcomplete/StreetComplete#15898 (comment)](https://github.com/streetcomplete/StreetComplete/discussions/15898?sort=top#discussioncomment-646707)',
	);
});



================================================
FILE: source/github-helpers/prevent-link-loss.ts
================================================
import type {RepositoryInfo} from 'github-url-detection';

import {getRepo, getConversationNumber} from './index.js';

function getRepoReference(currentRepo: RepositoryInfo | undefined, repoNameWithOwner: string, delimiter = ''): string {
	return repoNameWithOwner === currentRepo!.nameWithOwner ? '' : repoNameWithOwner + delimiter;
}

const escapeRegex = (string: string): string => string.replaceAll(/[\\^$.*+?()[\]{}|]/g, String.raw`\$&`);
const prCommitPathnameRegex = /[/]([^/]+[/][^/]+)[/]pull[/](\d+)[/]commits[/]([\da-f]{7})[\da-f]{33}(?:#[\w-]+)?\b/;
export const prCommitUrlRegex = new RegExp(String.raw`\b` + escapeRegex(location.origin) + prCommitPathnameRegex.source, 'gi');

const prComparePathnameRegex = /[/]([^/]+[/][^/]+)[/]compare[/](.+)(#diff-[\da-fR-]+)/;
export const prCompareUrlRegex = new RegExp(String.raw`\b` + escapeRegex(location.origin) + prComparePathnameRegex.source, 'gi');

const discussionPathnameRegex = /[/]([^/]+[/][^/]+)[/]discussions[/](\d+)[?][^#\s]+(#[\w-]+)?\b/;
export const discussionUrlRegex = new RegExp(String.raw`\b` + escapeRegex(location.origin) + discussionPathnameRegex.source, 'gi');

// To be used as replacer callback in string.replace() for PR commit links
export function preventPrCommitLinkLoss(url: string, repoNameWithOwner: string, pr: string, commit: string, index: number, fullText: string): string {
	if (fullText[index + url.length] === ')') {
		return url;
	}

	const currentPr = getConversationNumber();
	const prReference = currentPr && Number(pr) === currentPr ? '(this PR)' : `(#${pr})`;
	return `[${getRepoReference(getRepo(), repoNameWithOwner, '@')}\`${commit}\` ${prReference}](${url})`;
}

// To be used as replacer callback in string.replace() for compare links
export function preventPrCompareLinkLoss(url: string, repoNameWithOwner: string, compare: string, hash: string, index: number, fullText: string): string {
	if (fullText[index + url.length] === ')') {
		return url;
	}

	return `[${getRepoReference(getRepo(), repoNameWithOwner, '@')}\`${compare}\`${hash.slice(0, 16)}](${url})`;
}

// To be used as replacer callback in string.replace() for discussion links
export function preventDiscussionLinkLoss(url: string, repoNameWithOwner: string, discussion: string, comment: string, index: number, fullText: string): string {
	if (fullText[index + url.length] === ')') {
		return url;
	}

	return `[${getRepoReference(getRepo(), repoNameWithOwner)}#${discussion}${comment ? ' (comment)' : ''}](${url})`;
}



================================================
FILE: source/github-helpers/search-query.test.ts
================================================
import {test, assert} from 'vitest';

import SearchQuery from './search-query.js';

test('.get', () => {
	const query = SearchQuery.from({q: 'wow'});
	assert.equal(query.get(), 'wow');
});

test('.getQueryParts', () => {
	const query = SearchQuery.from({q: 'cool is:issue'});
	assert.deepEqual(query.getQueryParts(), ['cool', 'is:issue']);
});

test('getQueryParts with spaces support', () => {
	const query = SearchQuery.from({q: 'please label:"under discussion"'});
	assert.deepEqual(query.getQueryParts(), ['please', 'label:"under discussion"']);
});

test('getQueryParts with parentheses support', () => {
	const query = SearchQuery.from({q: 'please (label:"bug" or type:bug)'});
	assert.deepEqual(query.getQueryParts(), ['please', '(label:"bug" or type:bug)']);
});

test('.set', () => {
	const query = SearchQuery.from({q: 'wow'});
	query.set('lol');
	assert.equal(query.get(), 'lol');
});

test('.edit', () => {
	const query = SearchQuery.from({q: 'gone fishing'});
	query.edit(queryParts => queryParts.slice(0, 1));
	assert.equal(query.get(), 'gone');
});

test('.replace', () => {
	const query = SearchQuery.from({q: '404 error'});
	query.replace('error', 'failure');
	assert.equal(query.get(), '404 failure');

	query.replace(/^\d(\d)/, '1$1');
	assert.equal(query.get(), '104 failure');
});

test('.remove', () => {
	const query = SearchQuery.from({q: 'is:issue dog is:open'});
	query.remove('is:issue', 'is:open');
	assert.equal(query.get(), 'dog');
});

test('.append', () => {
	const query = SearchQuery.from({q: 'is:pr birds everywhere'});
	query.append('and', 'aliens');
	assert.equal(query.get(), 'is:pr birds everywhere and aliens');
});

test('.prepend', () => {
	const query = SearchQuery.from({q: 'is:pr birds everywhere'});
	query.prepend('sort:cool', 'exclude:chicken');
	assert.equal(query.get(), 'sort:cool exclude:chicken is:pr birds everywhere');
});

test('.includes', () => {
	const query = SearchQuery.from({q: 'label:nonsense'});
	assert.isFalse(query.includes('nonsense'));
	assert.isTrue(query.includes('label:nonsense'));
});

test('defaults', () => {
	const query = SearchQuery.from({q: ''});
	assert.equal(query.get(), '');

	const link = document.createElement('a');
	link.href = 'https://github.com/owner/repo/issues';
	const queryFromLink = SearchQuery.from(link);
	assert.equal(queryFromLink.get(), 'is:issue is:open');
});

test('deduplicate is:pr/issue', () => {
	const query = SearchQuery.from({q: 'refined github is:pr'});
	query.append('is:issue');

	assert.isFalse(query.includes('is:pr'));
	assert.isTrue(query.includes('is:issue'));
});

test('remove additional spaces', () => {
	const query = SearchQuery.from({q: ' refined   github '});
	assert.equal(query.get(), 'refined github');
});

test('parse label link', () => {
	const link = document.createElement('a');
	link.href = 'https://github.com/owner/repo/labels/bug';
	const query = SearchQuery.from(link);

	assert.equal(query.get(), 'is:open label:bug');
	assert.isTrue(query.href.startsWith('https://github.com/owner/repo/issues?'));
});

test('complex queries with multiple conditions', () => {
	const query = SearchQuery.from({q: 'is:issue is:open label:bug author:user milestone:"Q1 2023"'});
	assert.deepEqual(query.getQueryParts(), ['is:issue', 'is:open', 'label:bug', 'author:user', 'milestone:"Q1 2023"']);
});

test('queries with special characters in quoted values', () => {
	const query = SearchQuery.from({q: 'label:"bug: critical!" milestone:"version 1.0-beta"'});
	assert.deepEqual(query.getQueryParts(), ['label:"bug: critical!"', 'milestone:"version 1.0-beta"']);
});

test('queries with colons in quoted values', () => {
	const query = SearchQuery.from({q: 'label:"feature: enhancement" comment:"fixes: #1234"'});
	assert.deepEqual(query.getQueryParts(), ['label:"feature: enhancement"', 'comment:"fixes: #1234"']);
});

test('queries with multiple spaces between parts', () => {
	const query = SearchQuery.from({q: 'is:issue   label:bug    author:user'});
	assert.deepEqual(query.getQueryParts(), ['is:issue', 'label:bug', 'author:user']);
});

test('queries with empty quoted values', () => {
	const query = SearchQuery.from({q: 'is:issue label:""'});
	assert.deepEqual(query.getQueryParts(), ['is:issue', 'label:""']);
});

test('complex parenthesized expressions', () => {
	const query = SearchQuery.from({q: 'repo:user/repo (is:issue OR is:pr) label:bug'});
	assert.deepEqual(query.getQueryParts(), ['repo:user/repo', '(is:issue OR is:pr)', 'label:bug']);
});

test('quoted strings without keys', () => {
	const query = SearchQuery.from({q: '"exact phrase search" label:bug'});
	assert.deepEqual(query.getQueryParts(), ['"exact phrase search"', 'label:bug']);
});

test('keys with special characters', () => {
	const query = SearchQuery.from({q: 'is:issue assignee-review-requested:@me'});
	assert.deepEqual(query.getQueryParts(), ['is:issue', 'assignee-review-requested:@me']);
});

test('mixed key-value types in one query', () => {
	const query = SearchQuery.from({q: 'is:issue "exact match" label:"needs help" (author:user1 OR author:user2)'});
	assert.deepEqual(
		query.getQueryParts(),
		['is:issue', '"exact match"', 'label:"needs help"', '(author:user1 OR author:user2)'],
	);
});

test('queries with date ranges', () => {
	const query = SearchQuery.from({q: 'is:issue created:2023-01-01..2023-12-31'});
	assert.deepEqual(query.getQueryParts(), ['is:issue', 'created:2023-01-01..2023-12-31']);
});

test('queries with negation operators', () => {
	const query = SearchQuery.from({q: 'is:issue -label:bug -author:user'});
	assert.deepEqual(query.getQueryParts(), ['is:issue', '-label:bug', '-author:user']);
});

test('queries with comparison operators', () => {
	const query = SearchQuery.from({q: 'is:issue comments:>10 created:>=2023-01-01'});
	assert.deepEqual(query.getQueryParts(), ['is:issue', 'comments:>10', 'created:>=2023-01-01']);
});

test('queries with wildcard characters', () => {
	const query = SearchQuery.from({q: 'is:issue label:bug-* author:*-bot'});
	assert.deepEqual(query.getQueryParts(), ['is:issue', 'label:bug-*', 'author:*-bot']);
});

test('queries with special URL characters', () => {
	const query = SearchQuery.from({q: 'repo:user/repo-name+feature is:issue'});
	assert.deepEqual(query.getQueryParts(), ['repo:user/repo-name+feature', 'is:issue']);
});

test('queries with multiple negation patterns', () => {
	const query = SearchQuery.from({q: 'is:pr -is:draft -is:merged -label:WIP'});
	assert.deepEqual(query.getQueryParts(), ['is:pr', '-is:draft', '-is:merged', '-label:WIP']);
});

test('queries with multiple key-value pairs having the same key', () => {
	const query = SearchQuery.from({q: 'is:issue label:bug label:enhancement label:"good first issue"'});
	assert.deepEqual(query.getQueryParts(), ['is:issue', 'label:bug', 'label:enhancement', 'label:"good first issue"']);
});

test('queries with complex boolean combinations', () => {
	const query = SearchQuery.from({q: 'is:issue (label:bug AND author:user) OR (label:feature AND milestone:v1.0)'});
	assert.deepEqual(
		query.getQueryParts(),
		['is:issue', '(label:bug AND author:user)', 'OR', '(label:feature AND milestone:v1.0)'],
	);
});

test('queries with numbers and other special characters in search terms', () => {
	const query = SearchQuery.from({q: 'issue#123 PR#456 @user branch:fix/bug-123'});
	assert.deepEqual(query.getQueryParts(), ['issue#123', 'PR#456', '@user', 'branch:fix/bug-123']);
});

test('queries with dots in key values', () => {
	const query = SearchQuery.from({q: 'filename:test.js extension:.tsx repo:user/repo.js'});
	assert.deepEqual(query.getQueryParts(), ['filename:test.js', 'extension:.tsx', 'repo:user/repo.js']);
});

test('queries with unicode characters', () => {
	const query = SearchQuery.from({q: 'label:"ä¼˜å…ˆçº§é«˜" author:ç”¨æˆ·'});
	assert.deepEqual(query.getQueryParts(), ['label:"ä¼˜å…ˆçº§é«˜"', 'author:ç”¨æˆ·']);
});

test('queries with multiple parenthesized groups', () => {
	const query = SearchQuery.from({q: '(is:issue) (is:open) (label:bug) (author:user)'});
	assert.deepEqual(query.getQueryParts(), ['(is:issue)', '(is:open)', '(label:bug)', '(author:user)']);
});

test('queries with multiple quoted strings', () => {
	const query = SearchQuery.from({q: '"first string" "second string" "third string"'});
	assert.deepEqual(query.getQueryParts(), ['"first string"', '"second string"', '"third string"']);
});

test('queries with URL-encoded characters', () => {
	const query = SearchQuery.from({q: 'label:bug%20fix author:user%2Dname'});
	assert.deepEqual(query.getQueryParts(), ['label:bug%20fix', 'author:user%2Dname']);
});



================================================
FILE: source/github-helpers/search-query.ts
================================================
const queryPartsRegExp = /[^\s"()]+:[^"\s()]*(?:"[^"]*")?|\([^)]*\)|"[^"]*"|[^\s"():]+/g;
const labelLinkRegex = /^(?:\/[^/]+){2}\/labels\/([^/]+)\/?$/;

function splitQueryString(query: string): string[] {
	return query.match(queryPartsRegExp) ?? [];
}

// Remove all keywords from array except the last occurrence of one of the keywords.
function deduplicateKeywords(array: string[], ...keywords: string[]): string[] {
	const deduplicated = [];
	let wasKeywordFound = false;
	for (const current of array.toReversed()) {
		const isKeyword = keywords.includes(current);
		if (!isKeyword || !wasKeywordFound) {
			deduplicated.unshift(current);
			wasKeywordFound ||= isKeyword;
		}
	}

	return deduplicated;
}

function cleanQueryParts(parts: string[]): string[] {
	return deduplicateKeywords(parts, 'is:issue', 'is:pr');
}

type Source = Location | HTMLAnchorElement | Record<string, string>;

/**
Parser/Mutator of GitHub's search query directly on anchors and URL-like objects.
Notice: if the <a> or `location` changes outside SearchQuery, `get()` will return an outdated value.
*/
export default class SearchQuery {
	static escapeValue(value: string): string {
		return value.includes(' ') ? `"${value}"` : value;
	}

	static from(source: Source): SearchQuery {
		if (source instanceof Location || source instanceof HTMLAnchorElement) {
			return new SearchQuery(source.href);
		}

		const url = new URL('https://github.com');
		for (const [name, value] of Object.entries(source)) {
			url.searchParams.set(name, value);
		}

		return new SearchQuery(url);
	}

	private readonly url: URL;
	private queryParts: string[];

	constructor(url: string | URL, base?: string) {
		this.url = typeof url === 'string' ? new URL(url, base) : url;
		this.queryParts = [];

		const currentQuery = this.url.searchParams.get('q');
		if (typeof currentQuery === 'string') {
			this.queryParts = splitQueryString(currentQuery);
			return;
		}

		// Parse label links #5176
		const labelName = labelLinkRegex.exec(this.url.pathname)?.[1];
		if (labelName) {
			this.queryParts = ['is:open', 'label:' + SearchQuery.escapeValue(decodeURIComponent(labelName))];
			return;
		}

		// Query-less URLs imply some queries.
		// When we explicitly set ?q=* they're overridden, so they need to be manually added again.

		// Repo example: is:issue is:open
		this.queryParts.push(/\/pulls\/?$/.test(this.url.pathname) ? 'is:pr' : 'is:issue', 'is:open');

		// Header nav example: is:open is:issue author:you archived:false
		if (this.url.pathname === '/issues' || this.url.pathname === '/pulls') {
			if (this.url.searchParams.has('user')) { // #1211
				this.queryParts.push('user:' + this.url.searchParams.get('user')!);
			} else {
				this.queryParts.push('author:@me');
			}

			this.queryParts.push('archived:false');
		}
	}

	getQueryParts(): string[] {
		return cleanQueryParts(this.queryParts);
	}

	get(): string {
		return this.getQueryParts().join(' ');
	}

	set(query: string): this {
		this.queryParts = splitQueryString(query);
		return this;
	}

	get searchParams(): URLSearchParams {
		return this.url.searchParams;
	}

	get href(): string {
		this.url.searchParams.set('q', this.get());
		if (labelLinkRegex.test(this.url.pathname)) {
			// Avoid a redirection to the conversation list that would drop the search query #5176
			this.url.pathname = this.url.pathname.replace(/\/labels\/.+$/, '/issues');
		}

		return this.url.href;
	}

	edit(callback: (queryParts: string[]) => string[]): this {
		this.queryParts = callback(this.getQueryParts());
		return this;
	}

	replace(searchValue: string | RegExp, replaceValue: string): this {
		this.set(this.get().replace(searchValue, replaceValue));
		return this;
	}

	remove(...queryPartsToRemove: string[]): this {
		this.queryParts = this.getQueryParts().filter(queryPart => !queryPartsToRemove.includes(queryPart));
		return this;
	}

	append(...queryPartsToAdd: string[]): this {
		this.queryParts.push(...queryPartsToAdd);
		return this;
	}

	prepend(...queryPartsToAdd: string[]): this {
		this.queryParts.unshift(...queryPartsToAdd);
		return this;
	}

	includes(...searchStrings: string[]): boolean {
		return this.getQueryParts().some(queryPart => searchStrings.includes(queryPart));
	}
}



================================================
FILE: source/github-helpers/selectors.test.ts
================================================
import pMemoize from 'p-memoize';
import {test, assert, describe} from 'vitest';
import {parseHTML} from 'linkedom';
import filenamify from 'filenamify';
import {
	writeFile,
	mkdir,
	unlink,
	readFile,
	access,
} from 'node:fs/promises';

import * as exports from './selectors.js';

const fsCache = {
	async get(path: string): Promise<string | undefined> {
		try {
			const value = await readFile(path, 'utf8');
			return value;
		} catch {
			return undefined;
		}
	},
	async set(path: string, contents: string): Promise<void> {
		await mkdir('./test/.cache', {recursive: true});
		await writeFile(path, contents);
	},
	async has(path: string): Promise<boolean> {
		try {
			await access(path);
			return true;
		} catch {
			return false;
		}
	},
	async delete(path: string): Promise<void> {
		await unlink(path);
	},
} as const;

const fetchDocument = pMemoize(async (url: string): Promise<string> => {
	const request = await fetch(url, {
		headers: {
			Accept: 'text/html',
		},
	});
	return request.text();
}, {
	cacheKey: ([url]) => `./test/.cache/${filenamify(url.replace('https://github.com', ''))}.html`,
	cache: fsCache,
});

describe.concurrent('selectors', () => {
	// Exclude URL arrays
	const selectors: Array<[name: string, selector: string]> = [];
	for (const [name, selector] of Object.entries(exports)) {
		if (!name.endsWith('_')) {
			selectors.push([name, String(selector)]);
		}
	}

	test.each(selectors)('%s', {timeout: 9999}, async (name, selector: string) => {
		// @ts-expect-error Index signature bs

		const urls = exports[name + '_'] as exports.UrlMatch[];

		assert.isArray(urls, `No URLs defined for "${name}"`);
		await Promise.all(urls.map(async ([expectations, url]) => {
			const html = await fetchDocument(url);
			const {document} = parseHTML(html);
			// TODO: ? Use snapshot with outerHTML[]
			const matches = document.querySelectorAll(selector);
			assert.equal(matches.length, expectations, `Got wrong number of matches on ${url}:\n${selector}`);
		}));
	});
});



================================================
FILE: source/github-helpers/selectors.ts
================================================
import {css} from 'code-tag';

const requiresLogin: UrlMatch[] = [];

export type UrlMatch = [expectations: number, url: string];

/** The repo navigation bar */
export const repoUnderlineNavUl = '.js-responsive-underlinenav ul.UnderlineNav-body';
export const repoUnderlineNavUl_ = [
	[1, 'https://github.com/refined-github/refined-github'],
	[1, 'https://github.com/refined-github/refined-github/releases'],
] satisfies UrlMatch[];

export const standaloneGistLinkInMarkdown = css`
	:is(.js-comment-body, .react-issue-comment, .react-issue-body) p a:only-child:is(
		[href^="https://gist.github.com/"],
		[href^="${location.origin}/gist/"]
	)
` as 'a'; // TODO: Drop after https://github.com/fregante/code-tag/issues/12
export const standaloneGistLinkInMarkdown_ = [
	[3, 'https://github.com/refined-github/sandbox/issues/77'],
] satisfies UrlMatch[];

/** The repo navigation barâ€™s overflow menu */
export const repoUnderlineNavDropdownUl = '.js-responsive-underlinenav action-menu ul';
export const repoUnderlineNavDropdownUl_ = [
	// Added via JS :(
	// TODO: Use Puppeteer?
	[1, 'https://github.com/refined-github/refined-github'],
	[1, 'https://github.com/refined-github/refined-github/releases'],
] satisfies UrlMatch[];

export const branchSelector = '[data-hotkey="w"]';
export const branchSelector_ = [
	[1, 'https://github.com/refined-github/refined-github'],
	// Added via JS :(
	// TODO: Use Puppeteer?
	[0, 'https://github.com/refined-github/refined-github/blob/main/readme.md'],
	[0, 'https://github.com/refined-github/refined-github/blame/main/readme.md'],
	[0, 'https://github.com/refined-github/refined-github/tree/main/source'],
	[1, 'https://github.com/refined-github/sandbox/tree/branch/with/slashes'],
	[1, 'https://github.com/refined-github/sandbox/commits/branch/with/slashes'],
	[1, 'https://github.com/refined-github/sandbox/commits'],
] satisfies UrlMatch[];

export const branchSelectorParent = 'details#branch-select-menu';
export const branchSelectorParent_ = branchSelector_;

export const directoryListingFileIcon = [
	// .color-fg-muted selects only files; some icon extensions use `img` tags
	'.react-directory-filename-column > :is(svg, img).color-fg-muted',
	'.js-navigation-container .octicon-file',
];
export const directoryListingFileIcon_ = [
	[18, 'https://github.com/refined-github/refined-github'],
	[3, 'https://github.com/refined-github/refined-github/tree/main/.github'],
] satisfies UrlMatch[];

export const prCommit = '.TimelineItem--condensed:has(.octicon-git-commit)';
export const prCommit_ = [
	[1, 'https://github.com/refined-github/sandbox/pull/10'],
] satisfies UrlMatch[];

// `summary` is needed because the details dropdown contains the list of check runs, each with its status icon
export const prCommitStatusIcon = `:is(${prCommit}) details.commit-build-statuses summary .octicon`;
export const prCommitStatusIcon_ = [
	// Icon not loaded when logged out :(
	[0, 'https://github.com/refined-github/sandbox/pull/10'],
] satisfies UrlMatch[];

export const openPrsListLink = [
	// `.color-fg-open` is needed because of the icon added by `highlight-non-default-base-branch`
	css`
		.js-issue-row:has(
			.octicon-git-pull-request.color-fg-open,
			.octicon-git-pull-request-draft
		) a.js-navigation-open
	`,
	// React view
	css`
		li[role="listitem"] h3 a[data-hovercard-url*="/pull"]
	`,
];

export const openPrsListLink_ = [
	[4, 'https://github.com/refined-github/sandbox/issues?q=conflict'],
] satisfies UrlMatch[];

export const openIssueToLastComment = `
	:is(.js-issue-row, .js-pinned-issue-list-item)
	.Link--muted:is(
		a[aria-label$="comment"],
		a[aria-label$="comments"]
	)
`;
export const openIssueToLastComment_ = [
	[2, 'https://github.com/refined-github/sandbox/labels/bug'],
] satisfies UrlMatch[];

export const actionsTab = '#actions-tab';
export const actionsTab_ = [
	[1, 'https://github.com/refined-github/sandbox'],
] satisfies UrlMatch[];

export const paginationButtonSelector = '.ajax-pagination-form button.ajax-pagination-btn';
export const paginationButtonSelector_ = [
	[2, 'https://github.com/refined-github/sandbox/pull/10'],
] satisfies UrlMatch[];

export const codeSearchHeader = css`
	div:has(
		> [aria-label^="Collapse "],
		> [aria-label^="Expand "]
	)
`;
export const codeSearchHeader_ = [
	// Search not available when logged out :(
	[0, 'https://github.com/search?q=repo%3Arefined-github%2Frefined-github&type=code'],
] satisfies UrlMatch[];

export const linksToConversationLists = `
	a:is(
		[href*="/issues"],
		[href*="/pulls"],
		[href*="/projects"],
		[href*="/labels/"]
	):not(
		[href*="sort%3A"],
		[href*="page="],
		.issues-reset-query,
		.pagination *,
		.table-list-header-toggle *
	)
`;
export const linksToConversationLists_ = [
	[6, 'https://github.com/fregante/iphone-inline-video/issues?q=cool+is%3Aissue+is%3Aopen+'],
	[26, 'https://github.com/fregante/iphone-inline-video/issues?q=cool+is%3Aissue+is%3Aclosed'],
] satisfies UrlMatch[];

export const newCommentField = [
	'[input="fc-new_comment_field"]',
	'[input^="fc-new_inline_comment_discussion"]',
	'[aria-labelledby="comment-composer-heading"]',
];

export const newCommentField_ = requiresLogin;

export const commitHashLinkInLists = [
	'[data-testid="commit-row-browse-repo"]', // `isCommitList`
	'a[id^="commit-details-"]', // `isPRCommitList`
	'.js-details-container .text-right code a.Link--secondary', // `isPRConversation`
] as unknown as Array<'a'>;
export const commitHashLinkInLists_ = [
	[35, 'https://github.com/typed-ember/ember-cli-typescript/commits/master?after=5ff0c078a4274aeccaf83382c0d6b46323f57397+174'],
	[4, 'https://github.com/refined-github/refined-github/pull/6194/commits'],
	[5, 'https://github.com/refined-github/refined-github/pull/6194#event-8016526003'],
] satisfies UrlMatch[];

export const commitTitleInLists = '[data-testid="commit-row-item"] h4[class^="Title-module"]'; // `isCommitList`
export const commitTitleInLists_ = [
	[35, 'https://github.com/typed-ember/ember-cli-typescript/commits/master?after=5ff0c078a4274aeccaf83382c0d6b46323f57397+174'],
	[4, 'https://github.com/refined-github/refined-github/pull/6194/commits'],
];

const botNames = [
	'actions-user',
	'bors',
	'ImgBotApp',
	'renovate-bot',
	'rust-highfive',
	'scala-steward',
	'weblate',
	'apps', // Matches any `/apps/*` URLs
	'github-apps', // GHE apps
] as const;

const botAttributes = botNames.map(bot => `[href^="/${bot}"]`).join(', ');

// All co-authored commits are excluded because it's unlikely that any bot co-authors with another bot, but instead they're co-authored with a human. In that case we don't want to dim the commit.
// ^= is needed to match /apps/* URLs
export const botLinksCommitSelectors = [
	// Co-authored commits are excluded because their avatars are not linked
	`a[data-testid="avatar-icon-link"]:is(${botAttributes})`,

	// Legacy view, still used by PR commits
	// :only-child excludes co-authored commits
	`a[data-test-selector="commits-avatar-stack-avatar-link"]:is(${botAttributes}):only-child`,
];
export const botLinksCommitSelectors_ = [
	[1, 'https://github.com/ivogabe/gulp-typescript/commits/master/?since=2019-08-04&until=2019-11-03'],
];

export const botLinksPrSelectors = [
	...botNames.flatMap(bot => [
		`.opened-by [title$="pull requests created by ${bot}"]`,
		`.opened-by [title$="pull requests opened by ${bot}"]`,
	]),
	'.opened-by [href*="author%3Aapp%2F"]', // Search query `is:pr+author:app/*`
	'.labels [href$="label%3Abot"]', // PR tagged with `bot` label
];
export const botLinksPrSelectors_ = [
	[1, 'https://github.com/sun-zheng-an/gulp-shell/pulls?q=sort%3Aupdated-desc+is%3Apr+is%3Aclosed+lodash'],
];

export const botLinksNotificationSelectors = [
	// Only select if the bot is the primary author (last in DOM, first in avatar list)
	`.AvatarStack-body a.avatar:last-child:is(${botAttributes})`,
];
export const botLinksNotificationSelectors_ = [
	[0, 'https://github.com/notifications'],
] satisfies UrlMatch[];

// `a` selector needed to skip commits by non-GitHub users
const authorLinks = [
	'.js-discussion a.author',
	'.inline-comments a.author',
	'.react-issue-comment a[data-testid="avatar-link"]',
	'[data-testid="comment-header"] a[data-testid="avatar-link"]', // React commit view
	'.react-issue-body a[data-testid="issue-body-header-author"]', // React issue view first comment
];

const authorLinksException = [
	// # targets mannequins #6504
	'[href="#"]',
	'[href*="/apps/"]',
	'[href*="/marketplace/"]',
	'[data-hovercard-type="organization"]',
	// For GHE: https://github.com/refined-github/refined-github/issues/7232#issuecomment-1910803157
	'[show_full_name="true"]',
];

export const usernameLinksSelector = [
	`:is(${authorLinks.join(', ')}):not(${authorLinksException.join(', ')})`,

	// On dashboard
	// `.Link--primary` excludes avatars
	// [aria-label="card content"] excludes links in cards #6530 #6915
	'#dashboard a.Link--primary[data-hovercard-type="user"]:not([aria-label="card content"] *)',
] as unknown as Array<'a'>;
export const usernameLinksSelector_ = [
	[1, 'https://github.com/refined-github/refined-github/issues/7747'],
];

export const actionBarSelectors = [
	'[data-target="action-bar.itemContainer"]', // TODO: remove after March 2025
	'[aria-label="Formatting tools"]',
];
export const actionBarSelectors_ = requiresLogin;

export const prMergeabilityBoxCaption = '[aria-label="Conflicts"] [class^="MergeBoxSectionHeader-module__wrapper"] h3 + .fgColor-muted';
export const prMergeabilityBoxCaption_ = requiresLogin;

export const prMergeabilityBoxHeader = '[aria-label="Conflicts"] [class^="MergeBoxSectionHeader-module__wrapper"]';
export const prMergeabilityBoxHeader_ = requiresLogin;

export const deletedHeadRepository = [
	'span[title="This repository has been deleted"]',
	'.head-ref[title="This repository has been deleted"]', // TODO: Remove in June 2026
];

export const deletedHeadRepository_ = [
	[2, 'https://github.com/refined-github/refined-github/pull/271'],
	[1, 'https://github.com/refined-github/refined-github/pull/271/files'],
];



================================================
FILE: source/github-helpers/timeline-item.tsx
================================================
import React from 'dom-chef';

export default function TimelineItem(): JSX.Element {
	// Classes copied from #issuecomment-new + mt-3 added
	return <div className="ml-0 pl-0 ml-md-6 pl-md-3 mt-3" />;
}



================================================
FILE: source/github-helpers/toast.tsx
================================================
import React from 'dom-chef';
import {assertError} from 'ts-extras';
import CheckIcon from 'octicons-plain-react/Check';
import StopIcon from 'octicons-plain-react/Stop';
import oneEvent from 'one-event';

import delay from '../helpers/delay.js';
import {frame} from '../helpers/dom-utils.js';

function ToastSpinner(): JSX.Element {
	return (
		<svg className="Toast--spinner" viewBox="0 0 32 32" width="18" height="18">
			<path fill="#959da5" d="M16 0 A16 16 0 0 0 16 32 A16 16 0 0 0 16 0 M16 4 A12 12 0 0 1 16 28 A12 12 0 0 1 16 4" />
			<path fill="#ffffff" d="M16 0 A16 16 0 0 1 32 16 L28 16 A12 12 0 0 0 16 4z" />
		</svg>
	);
}

type ProgressCallback = (message: string) => void;
type Task = Promise<unknown> | ((progress: ProgressCallback) => Promise<unknown>);
export default async function showToast(
	task: Task | Error,
	{
		message = 'Bulk actions currently being processed.',
		doneMessage = 'Bulk action processing complete.',
	}: {
		message?: string;
		doneMessage?: string | false;
	} = {},
): Promise<void> {
	const iconWrapper = <span className="Toast-icon"><ToastSpinner /></span>;
	const messageWrapper = <span>{message}</span>;
	const toast = (
		<div
			role="log"
			style={{zIndex: 101}}
			className="rgh-toast position-fixed bottom-0 right-0 ml-5 mb-5 Toast Toast--loading Toast--animateIn"
		>
			{iconWrapper}
			<span className="Toast-content py-2">
				<div style={{fontSize: '10px', color: 'silver', marginBottom: '-0.3em'}}>Refined GitHub</div>
				{messageWrapper}
			</span>
		</div>
	);
	const updateToast = (message: string): void => {
		messageWrapper.textContent = message;
	};

	const finalUpdateToast = async (message: string): Promise<void> => {
		updateToast(message);

		// Without rAF the toast might be removed before the first page paint
		// rAF also allows showToast to resolve as soon as task is done
		await frame();

		const displayTime = (message.split(' ').length * 300) + 2000;
		await delay(displayTime);

		// Display time is over, animate out
		toast.classList.replace('Toast--animateIn', 'Toast--animateOut');
		await oneEvent(toast, 'animationend');
		toast.remove();
	};

	document.body.append(toast);
	await delay(30); // Without this, the Toast doesn't appear in time

	let finalToastMessage: string | false = 'Unknown error';
	try {
		if (task instanceof Error) {
			throw task;
		}

		if (typeof task === 'function') {
			await task(updateToast);
		} else {
			await task;
		}

		toast.classList.replace('Toast--loading', 'Toast--success');
		finalToastMessage = doneMessage;
		iconWrapper.firstChild!.replaceWith(<CheckIcon />);
	} catch (error) {
		assertError(error);
		toast.classList.replace('Toast--loading', 'Toast--error');
		finalToastMessage = error.message;
		iconWrapper.firstChild!.replaceWith(<StopIcon />);
		throw error;
	} finally {
		// Use the last message if `false` was passed
		void finalUpdateToast(finalToastMessage || messageWrapper.textContent);
	}
}



================================================
FILE: source/github-widgets/mergeability-row.tsx
================================================
import React from 'dom-chef';

type MergeabilityRowProps = {
	action?: JSX.Element;
	icon: JSX.Element;
	iconClass?: string;
	heading: JSX.Element | string;
	meta?: JSX.Element | string;
	className?: string;
};

export default function createMergeabilityRow({
	className = '',
	action,
	icon,
	iconClass = '',
	heading,
	meta,
}: MergeabilityRowProps): JSX.Element {
	return (
		<div className={`branch-action-item ${className}`}>
			<div
				className="branch-action-btn float-right js-immediate-updates js-needs-timeline-marker-header"
			>
				{action}
			</div>
			<div
				className={`branch-action-item-icon completeness-indicator ${iconClass}`}
			>
				{icon}
			</div>
			<h3 className="h4 status-heading">
				{heading}
			</h3>
			<span className="status-meta">
				{meta}
			</span>
		</div>
	);
}



================================================
FILE: source/github-widgets/notice-bar.tsx
================================================
import React from 'dom-chef';
import XIcon from 'octicons-plain-react/X';
import elementReady from 'element-ready';

type Options = {
	action?: Element | false;
	type?: 'success' | 'notice' | 'warn' | 'error';
};

/** https://primer.style/css/components/alerts */
export default async function addNotice(
	message: string | Node | Array<string | Node>,
	{
		type = 'notice',
		action = (
			<button className="flash-close js-flash-close" type="button" aria-label="Dismiss this message">
				<XIcon />
			</button>
		),
	}: Options = {},
): Promise<void> {
	const container = await elementReady('#js-flash-container');
	container!.append(
		<div className={`flash flash-full flash-${type} px-4`}>
			{action}
			<div>
				{message}
			</div>
		</div>,
	);
}



================================================
FILE: source/helpers/abbreviate-number.ts
================================================
import {abbreviateNumber as abbreviateNumber_} from 'js-abbreviation-number';

export default function abbreviateNumber(number: number, digits = 1): string {
	return abbreviateNumber_(number, digits, {padding: false}).toLowerCase();
}



================================================
FILE: source/helpers/abbreviate-string.ts
================================================
export default function abbreviateString(string: string, length: number): string {
	return string.length < length
		? string
		: string.slice(0, length) + 'â€¦';
}



================================================
FILE: source/helpers/abortable-classname.ts
================================================
import {onAbort} from 'abort-utils';

// TODO: Drop after https://github.com/fregante/abort-utils/issues/12
export default function abortableClassName(element: Element, signal: AbortSignal, ...classes: string[]): void {
	element.classList.add(...classes);
	onAbort(signal, () => {
		element.classList.remove(...classes);
	});
}



================================================
FILE: source/helpers/async-for-each.ts
================================================
/** Loop an iterable with the ability to place a non-blocking `await` in the loop itself */
export default async function asyncForEach<Item>(
	iterable: Iterable<Item>,
	iteratee: (item: Item) => Promise<void>,
): Promise<void> {
	await Promise.all([...iterable].map(async item => iteratee(item)));
}



================================================
FILE: source/helpers/attach-element.ts
================================================
import {elementExists} from 'select-dom';
import type {RequireAtLeastOne} from 'type-fest';

import getCallerID from './caller-id.js';

type Position = 'before' | 'after';

// NOTE: Do not turn the Callback into an async function or else the deduplication won't work. A placeholder element MUST be returned synchronously. The deduplication logic is DOM-based.
type Attachment<NewElement extends Element, Callback = (E: Element) => NewElement> = RequireAtLeastOne<{
	className?: string;
	before: Callback;
	after: Callback;
}, Position>;

export default function attachElement<NewElement extends Element>(
	anchor: Element | undefined,
	{
		before,
		after,
	}: Attachment<NewElement>,
): void {
	const className = 'rgh-' + getCallerID();
	if (!anchor) {
		throw new Error('Element not found');
	}

	if (elementExists('.' + className, anchor.parentElement!)) {
		return;
	}

	if (before) {
		const element = before(anchor);
		element.classList.add(className);
		anchor.before(element);
	}

	if (after) {
		const element = after(anchor);
		element.classList.add(className);
		anchor.after(element);
	}
}



================================================
FILE: source/helpers/bisect.tsx
================================================
import React from 'dom-chef';
import {CachedValue} from 'webext-storage-cache';
import {$$} from 'select-dom';
import {$optional} from 'select-dom/strict.js';
import elementReady from 'element-ready';

import pluralize from './pluralize.js';
import {getFeatureUrl} from './rgh-links.js';
import {importedFeatures} from '../feature-data.js';

export const state = new CachedValue<FeatureID[]>('bisect', {maxAge: {minutes: 15}});

function enableButtons(): void {
	for (const button of $$('#rgh-bisect-dialog [aria-disabled]')) {
		button.removeAttribute('aria-disabled');
	}
}

// Split current list of features in half and create an options-like object to be applied on load
// Bisecting 4 features: enable 2
// Bisecting 3 features: enable 1
// Bisecting 2 features: enable 1
// Bisecting 1 feature: enable 0 // This is the last step, if the user says Yes, it's not caused by a JS feature
const getMiddleStep = (list: any[]): number => Math.floor(list.length / 2);

async function onChoiceButtonClick({currentTarget: button}: React.MouseEvent<HTMLButtonElement>): Promise<void> {
	const answer = button.value;
	const bisectedFeatures = (await state.get())!;

	if (bisectedFeatures.length > 1) {
		await state.set(answer === 'yes'
			? bisectedFeatures.slice(0, getMiddleStep(bisectedFeatures))
			: bisectedFeatures.slice(getMiddleStep(bisectedFeatures)),
		);

		button.parentElement!.replaceWith(<div className="btn" aria-disabled="true">Reloadingâ€¦</div>);
		location.reload();
		return;
	}

	// Last step, no JS feature was enabled
	if (answer === 'yes') {
		createMessageBox(
			<>
				<p>Unable to identify feature. It might be a CSS-only feature, a <a href="https://github.com/refined-github/refined-github/wiki/Meta-features" target="_blank" rel="noreferrer">meta-feature</a>, or unrelated to Refined GitHub.</p>
				<p>Try disabling Refined GitHub to see if the change or issue is caused by the extension.</p>
			</>,
		);
	} else {
		const feature = (
			<a href={getFeatureUrl(bisectedFeatures[0])}>
				<code>{bisectedFeatures[0]}</code>
			</a>
		);

		createMessageBox(<>The change or issue is caused by {feature}.</>);
	}

	await state.delete();
	globalThis.removeEventListener('visibilitychange', hideMessage);
}

async function onEndButtonClick(): Promise<void> {
	await state.delete();
	location.reload();
}

function createMessageBox(message: Element | string, extraButtons?: Element): void {
	$optional('#rgh-bisect-dialog')?.remove();
	document.body.append(
		<div id="rgh-bisect-dialog" className="Box p-3">
			<p>{message}</p>
			<div className="d-flex flex-justify-between">
				<button type="button" className="btn" onClick={onEndButtonClick}>Exit</button>
				{extraButtons}
			</div>
		</div>,
	);
}

async function hideMessage(): Promise<void> {
	if (!(await state.get())) {
		createMessageBox('Process completed in another tab');
	}
}

export default async function bisectFeatures(): Promise<Record<string, boolean> | void> {
	// `bisect` stores the list of features to be split in half
	const bisectedFeatures = await state.get();
	if (!bisectedFeatures) {
		return;
	}

	console.log(`Bisecting ${bisectedFeatures.length} features:\n${bisectedFeatures.join('\n')}`);

	const steps = Math.ceil(Math.log2(Math.max(bisectedFeatures.length))) + 1;
	await elementReady('body');
	createMessageBox(
		`Do you see the change or issue? (${pluralize(steps, 'last step', '$$ steps remaining')})`,
		<div>
			<button type="button" className="btn btn-danger mr-2" value="no" aria-disabled="true" onClick={onChoiceButtonClick}>No</button>
			<button type="button" className="btn btn-primary" value="yes" aria-disabled="true" onClick={onChoiceButtonClick}>Yes</button>
		</div>,
	);

	// Enable "Yes"/"No" buttons once the page is done loading
	if (document.readyState === 'complete') {
		enableButtons();
	} else {
		window.addEventListener('load', enableButtons);
	}

	// Hide message when the process is done elsewhere
	globalThis.addEventListener('visibilitychange', hideMessage);

	const half = getMiddleStep(bisectedFeatures);
	const temporaryOptions: Record<string, boolean> = {};
	for (const feature of importedFeatures) {
		const index = bisectedFeatures.indexOf(feature);
		temporaryOptions[`feature:${feature}`] = index !== -1 && index < half;
	}

	console.log({temporaryOptions});
	return temporaryOptions;
}



================================================
FILE: source/helpers/calculate-css-calc-string.test.ts
================================================
import {test, assert} from 'vitest';

import calculateCssCalcString from './calculate-css-calc-string.js';

test('calculateCssCalcString', () => {
	assert.equal(calculateCssCalcString('calc(1px)'), 1);
	assert.equal(calculateCssCalcString('calc(1px + 10px)'), 11);
	assert.equal(calculateCssCalcString('calc(1px + 10px + 234px)'), 245);
	assert.equal(calculateCssCalcString('calc(1% / 1em)'), 11); // Yup ğŸ¤«, only px is allowed
});



================================================
FILE: source/helpers/calculate-css-calc-string.ts
================================================
import looseParseInt from './loose-parse-int.js';

/**
Compute the sum in a `calc()`. Only works with very simple sums of px values.
When used with custom properties, `calc()` are not evaluated when retrieved via `getComputedStyle()`

@example calculateCssCalcString('calc(1px + 2px)') => 3;
*/
export default function calculateCssCalcString(string: string): number {
	const addends = string.split('+').map(part => looseParseInt(part));
	return addends.reduce((a, b) => a + b);
}



================================================
FILE: source/helpers/caller-id.test.ts
================================================
import {test, assert} from 'vitest';

import {getStackLine} from './caller-id.js';

test('getCallerID: getStackLine', () => {
	assert.equal(getStackLine('A\nB', 0), 'A');
	assert.equal(getStackLine('A\nB', 1), 'B');

	assert.equal(getStackLine('Error: Get stack\nA\nB', 0), 'A');
	assert.equal(getStackLine('Error: Get stack\nA\nB', 1), 'B');

	assert.isTrue(getStackLine('Error: Get stack\nA\nB', 42).startsWith('0.'));
});



================================================
FILE: source/helpers/caller-id.ts
================================================
import hashString from './hash-string.js';

/**
Get unique ID by using the line:column of the call (or its parents) as seed. Every call from the same place will return the same ID, as long as the index is set to the parents that matters to you.

@param ancestor Which call in the stack should be used as key. 0 means the exact line where getCallerID is called. Defaults to 1 because it's usually used inside a helper.
*/
export default function getCallerID(ancestor = 1): string {
	/* +1 because the first line comes from this function */
	return hashString(getStackLine(new Error('Get stack').stack!, ancestor + 1));
}

export function getStackLine(stack: string, line: number): string {
	return stack
		// Remove non-stacktrace line from array (missing in Firefox) #6032
		.replace('Error: Get stack\n', '')
		.split('\n')
		.at(line) ?? warn(stack, line);
}

function warn(stack: string, line: number): string {
	console.warn('The stack doesnâ€™t have the line', {line, stack});
	return Math.random().toString(16);
}



================================================
FILE: source/helpers/clean-commit-message.test.ts
================================================
import {test, assert} from 'vitest';

import cleanCommitMessage from './clean-commit-message.js';

test('cleanCommitMessage', () => {
	const coauthors = [
		'Co-authored-by: Me <me@example.com>',
		'co-authored-by: Me <me@example.com>',
		'Co-authored-by: You <you@example.com>',
	];
	assert.isEmpty(cleanCommitMessage(''));
	assert.isEmpty(cleanCommitMessage('clean me'));
	assert.isEmpty(cleanCommitMessage(`
		multi-line
	`));

	assert.equal(cleanCommitMessage(`
		Some stuff happened
		${coauthors[0]}
	`), coauthors[0], 'Should preserve just the co-authors');

	assert.equal(cleanCommitMessage(`
		Some stuff happened
		${coauthors[0]}
		Fixes #112345
		${coauthors[2]}
	`), coauthors[0] + '\n' + coauthors[2], 'Should preserve multiple co-authors');

	assert.equal(cleanCommitMessage(`
		Some stuff happened
		${coauthors[0]}
		More stuff
		${coauthors[1]}
	`), coauthors[0], 'Should de-duplicate inconsistent co-authored-by casing');

	assert.isEmpty(cleanCommitMessage(`
		Fixes #1345
	`), 'Should drop closing keywords');

	assert.equal(cleanCommitMessage(`
		Fixes #1345
	`, true), 'Fixes #1345', 'Should keep closing keywords when asked');
	assert.equal(cleanCommitMessage(`
		Fixes #1
		${coauthors[0]}
		closes https://github.com/refined-github/refined-github/pull/6328
	`, true), [
		coauthors[0],
		'Fixes #1',
		'closes https://github.com/refined-github/refined-github/pull/6328',
	].join('\n'), 'Should keep multiple closing keywords');
});



================================================
FILE: source/helpers/clean-commit-message.ts
================================================
export default function cleanCommitMessage(message: string, closingKeywords = false): string {
	const preservedContent = new Set();

	// This method ensures that "Co-authored-by" capitalization doesn't affect deduplication
	for (const [, author] of message.matchAll(/co-authored-by: ([^\n]+)/gi)) {
		preservedContent.add('Co-authored-by: ' + author);
	}

	if (!closingKeywords) {
		return [...preservedContent].join('\n');
	}

	// Preserve closing issues numbers when a PR is merged into a non-default branch since GitHub doesn't close them #4531
	// https://docs.github.com/en/get-started/writing-on-github/working-with-advanced-formatting/using-keywords-in-issues-and-pull-requests#linking-a-pull-request-to-an-issue
	for (const [line] of message.matchAll(/(fix(es|ed)?|close[sd]?|resolve[sd]?)([^\n]+)/gi)) {
		// Ensure it includes a reference or URL
		if (/#\d+/.test(line) || line.includes('http')) {
			preservedContent.add(line);
		}
	}

	return [...preservedContent].join('\n');
}



================================================
FILE: source/helpers/clear-cache-handler.ts
================================================
import {globalCache} from 'webext-storage-cache';

export default async function clearCacheHandler(this: HTMLButtonElement): Promise<void> {
	await globalCache.clear();
	const initialText = this.textContent;
	this.textContent = 'Cache cleared!';
	this.disabled = true;
	setTimeout(() => {
		this.textContent = initialText;
		this.disabled = false;
	}, 2000);
}



================================================
FILE: source/helpers/click-all.ts
================================================
import mem from 'memoize';
import {$$} from 'select-dom';
import type {DelegateEvent} from 'delegate-it';

import preserveScroll from './preserve-scroll.js';

type EventHandler = (event: DelegateEvent<MouseEvent, HTMLElement>) => void;
export default mem((selector: string | ((clickedItem: HTMLElement) => string)): EventHandler => event => {
	if (event.altKey && event.isTrusted) {
		const clickedItem = event.delegateTarget;

		// `parentElement` is the anchor because `clickedItem` might be hidden/replaced after the click
		const resetScroll = preserveScroll(clickedItem.parentElement!);
		clickAllExcept(typeof selector === 'string' ? selector : selector(clickedItem), clickedItem);
		resetScroll();
	}
});

function clickAllExcept(elementsToClick: string, except: HTMLElement): void {
	for (const item of $$(elementsToClick)) {
		if (item !== except) {
			item.click();
		}
	}
}



================================================
FILE: source/helpers/conventional-commits.test.ts
================================================
import {test, expect} from 'vitest';

import {parseConventionalCommit} from './conventional-commits.js';

test('parseConventionalCommit', () => {
	expect(parseConventionalCommit('fix: Commit message')).toMatchInlineSnapshot(`
		{
		  "raw": "fix: ",
		  "rawType": "fix",
		  "scope": undefined,
		  "type": "Fix",
		}
	`);
	expect(parseConventionalCommit('feat: Commit message')).toMatchInlineSnapshot(`
		{
		  "raw": "feat: ",
		  "rawType": "feat",
		  "scope": undefined,
		  "type": "Feature",
		}
	`);
	expect(parseConventionalCommit('fix!: Breaking change')).toMatchInlineSnapshot(`
		{
		  "raw": "fix!: ",
		  "rawType": "fix",
		  "scope": undefined,
		  "type": "Fix!",
		}
	`);
	expect(parseConventionalCommit('feat(scope): Commit message')).toMatchInlineSnapshot(`
		{
		  "raw": "feat(scope): ",
		  "rawType": "feat",
		  "scope": "scope: ",
		  "type": "Feature",
		}
	`);
	expect(parseConventionalCommit('feat(scope)!: Breaking change')).toMatchInlineSnapshot(`
		{
		  "raw": "feat(scope)!: ",
		  "rawType": "feat",
		  "scope": "scope: ",
		  "type": "Feature!",
		}
	`);
	expect(parseConventionalCommit('revert(scope): Revert "feat(scope): Commit message"')).toMatchInlineSnapshot(`
		{
		  "raw": "revert(scope): ",
		  "rawType": "revert",
		  "scope": "scope: ",
		  "type": "Revert",
		}
	`);
	expect(parseConventionalCommit('feat(sco pe): Commit message')).toMatchInlineSnapshot(`
		{
		  "raw": "feat(sco pe): ",
		  "rawType": "feat",
		  "scope": "sco pe: ",
		  "type": "Feature",
		}
	`);
	expect(parseConventionalCommit(('feat: Commit (message)'))).toMatchInlineSnapshot(`
		{
		  "raw": "feat: ",
		  "rawType": "feat",
		  "scope": undefined,
		  "type": "Feature",
		}
	`);
	expect(parseConventionalCommit('fix:')).toMatchInlineSnapshot(`
		{
		  "raw": "fix:",
		  "rawType": "fix",
		  "scope": undefined,
		  "type": "Fix",
		}
	`);

	expect(parseConventionalCommit('idk(label): not recognized')).toBeUndefined();
	expect(parseConventionalCommit('Commit message')).toBeUndefined();
	expect(parseConventionalCommit('feat(): Commit message')).toBeUndefined();
	expect(parseConventionalCommit('fe at(scope): Commit message) ')).toBeUndefined();
});

test('parseConventionalCommit support upper case types', () => {
	expect(parseConventionalCommit('Fix: Commit message')).toMatchInlineSnapshot(`
		{
		  "raw": "Fix: ",
		  "rawType": "Fix",
		  "scope": undefined,
		  "type": "Fix",
		}
	`);
	expect(parseConventionalCommit('Feat: Commit message')).toMatchInlineSnapshot(`
		{
		  "raw": "Feat: ",
		  "rawType": "Feat",
		  "scope": undefined,
		  "type": "Feature",
		}
	`);
	expect(parseConventionalCommit('Fix!: Breaking change')).toMatchInlineSnapshot(`
		{
		  "raw": "Fix!: ",
		  "rawType": "Fix",
		  "scope": undefined,
		  "type": "Fix!",
		}
	`);
	expect(parseConventionalCommit('Feat(scope): Commit message')).toMatchInlineSnapshot(`
		{
		  "raw": "Feat(scope): ",
		  "rawType": "Feat",
		  "scope": "scope: ",
		  "type": "Feature",
		}
	`);
	expect(parseConventionalCommit('Feat(scope)!: Breaking change')).toMatchInlineSnapshot(`
		{
		  "raw": "Feat(scope)!: ",
		  "rawType": "Feat",
		  "scope": "scope: ",
		  "type": "Feature!",
		}
	`);
	expect(parseConventionalCommit('Revert(scope): Revert "Feat(scope): Commit message"')).toMatchInlineSnapshot(`
		{
		  "raw": "Revert(scope): ",
		  "rawType": "Revert",
		  "scope": "scope: ",
		  "type": "Revert",
		}
	`);
	expect(parseConventionalCommit('Feat(sco pe): Commit message')).toMatchInlineSnapshot(`
		{
		  "raw": "Feat(sco pe): ",
		  "rawType": "Feat",
		  "scope": "sco pe: ",
		  "type": "Feature",
		}
	`);
	expect(parseConventionalCommit(('Feat: Commit (message)'))).toMatchInlineSnapshot(`
		{
		  "raw": "Feat: ",
		  "rawType": "Feat",
		  "scope": undefined,
		  "type": "Feature",
		}
	`);
	expect(parseConventionalCommit('Fix:')).toMatchInlineSnapshot(`
		{
		  "raw": "Fix:",
		  "rawType": "Fix",
		  "scope": undefined,
		  "type": "Fix",
		}
	`);

	expect(parseConventionalCommit('Idk(label): not recognized')).toBeUndefined();
	expect(parseConventionalCommit('Commit message')).toBeUndefined();
	expect(parseConventionalCommit('Feat(): Commit message')).toBeUndefined();
	expect(parseConventionalCommit('Fe at(scope): Commit message) ')).toBeUndefined();
});



================================================
FILE: source/helpers/conventional-commits.ts
================================================
// Using https://www.conventionalcommits.org/ as a reference.
export const conventionalCommitRegex = /^(?<type>\w+)(?:\((?<scope>.+?)\))?(?<major>!)?: */;

// Do not send PRs for types not listed here: https://github.com/conventional-changelog/commitlint/tree/master/%40commitlint/config-conventional#rules
// No more types will be added nor do we accept options.
const types = new Map([
	['feat', 'Feature'],
	['fix', 'Fix'],
	['chore', 'Chore'],
	['revert', 'Revert'],
	['style', 'Style'],
	['docs', 'Docs'],
	['build', 'Build'],
	['refactor', 'Refactor'],
	['test', 'Test'],
	['ci', 'CI'],
	['perf', 'Performance'],
]);

export function parseConventionalCommit(commitTitle: string): {
	rawType: string;
	type: string;
	scope?: string;
	raw: string;
} | undefined {
	const match = conventionalCommitRegex.exec(commitTitle);
	if (!match?.groups?.type) {
		return;
	}

	const {type: rawType, scope, major} = match.groups;
	const type = types.get(rawType.toLowerCase());
	if (!type) {
		return;
	}

	return {
		rawType,
		type: major ? `${type}!` : type,
		scope: scope ? `${scope}: ` : undefined,
		raw: match[0],
	};
}



================================================
FILE: source/helpers/delay.ts
================================================
export default async function delay(ms: number, signal?: AbortSignal): Promise<void> {
	signal?.throwIfAborted();
	await new Promise<void>((resolve, reject) => {
		const timeout = setTimeout(resolve, ms);
		signal?.addEventListener('abort', () => {
			clearTimeout(timeout);
			// eslint-disable-next-line @typescript-eslint/prefer-promise-reject-errors -- Pass as is
			reject(signal.reason);
		});
	});
}



================================================
FILE: source/helpers/dom-utils.ts
================================================
import {ElementNotFoundError} from 'select-dom';
import {$, $$, $optional} from 'select-dom/strict.js';

// eslint-disable-next-line @typescript-eslint/no-restricted-types -- Nodes may be exactly `null`
type Nullable<T> = T | null;

/**
 * Append to an element, but before a element that might not exist.
 * @param  parent  Element (or its selector) to which append the `child`
 * @param  before  Selector of the element that `child` should be inserted before
 * @param  child   Element to append
 * @example
 *
 * <parent>
 *   <yes/>
 *   <oui/>
 *   <nope/>
 * </parent>
 *
 * appendBefore('parent', 'nope', <sÃ¬/>);
 *
 * <parent>
 *   <yes/>
 *   <oui/>
 *   <sÃ¬/>
 *   <nope/>
 * </parent>
 */
export const appendBefore = (parent: string | Element, before: string, child: Element): void => {
	if (typeof parent === 'string') {
		parent = $(parent);
	}

	// Select direct children only
	const beforeElement = $optional(`:scope > :is(${before})`, parent);
	if (beforeElement) {
		beforeElement.before(child);
	} else {
		parent.append(child);
	}
};

export const wrap = (target: Element | ChildNode, wrapper: Element): void => {
	target.before(wrapper);
	wrapper.append(target);
};

export const wrapAll = <Wrapper extends Element>(wrapper: Wrapper, ...targets: Array<Element | ChildNode>): Wrapper => {
	const [first, ...rest] = targets;
	first.before(wrapper);
	wrapper.append(first, ...rest);
	return wrapper;
};

export const isEditable = (node: unknown): boolean => node instanceof HTMLTextAreaElement
	|| node instanceof HTMLInputElement
	|| (node instanceof HTMLElement && node.isContentEditable);

export const frame = async (): Promise<number> => new Promise(resolve => {
	requestAnimationFrame(resolve);
});

export const highlightTab = (tabElement: Element): void => {
	tabElement.classList.add('selected');
	tabElement.setAttribute('aria-current', 'page');
};

export const unhighlightTab = (tabElement: Element): void => {
	tabElement.classList.remove('selected');
	tabElement.removeAttribute('aria-current');
};

const matchString = (matcher: RegExp | string, string: string): boolean =>
	typeof matcher === 'string' ? matcher === string : matcher.test(string);

const escapeMatcher = (matcher: RegExp | string): string =>
	typeof matcher === 'string' ? `"${matcher}"` : String(matcher);

const isTextNode = (node: Text | ChildNode): boolean =>
	node instanceof Text || ([...node.childNodes].every(childNode => childNode instanceof Text));

export const isTextNodeContaining = (node: Nullable<Text | ChildNode>, expectation: RegExp | string): boolean => {
	// Make sure only text is being considered, not links, icons, etc
	if (!node || !isTextNode(node)) {
		console.warn('Expected Text node', node);
		throw new TypeError(`Expected Text node, received ${String(node?.nodeName)}`);
	}

	// The string/regex may expect spaces, like for `conventional-commits`
	return matchString(expectation, node.textContent) || matchString(expectation, node.textContent.trim());
};

export const assertNodeContent = <N extends Text | ChildNode>(node: Nullable<N>, expectation: RegExp | string): N => {
	if (isTextNodeContaining(node, expectation)) {
		return node!;
	}

	console.warn('Expected node:', node!.parentElement);
	const content = node!.textContent.trim();
	throw new Error(`Expected node matching ${escapeMatcher(expectation)}, found ${escapeMatcher(content)}`);
};

export const removeTextNodeContaining = (node: Text | ChildNode, expectation: RegExp | string): void => {
	assertNodeContent(node, expectation);
	node.remove();
};

export function removeTextInTextNode(node: Text | ChildNode, text: RegExp | string): void {
	assertNodeContent(node, text);
	node.textContent = node.textContent.replace(text, '');
}

export function getElementByAriaLabelledBy<T extends HTMLElement>(baseSelector: string, label: string): T {
	for (const element of $$(baseSelector + '[aria-labelledby]')) {
		const labelElement = $optional(`[id="${element.getAttribute('aria-labelledby')!}"]`);

		if (labelElement?.textContent?.trim() === label) {
			return element as T;
		}
	}

	throw new ElementNotFoundError(`Expected element labelled "${label}" not found in: ${baseSelector}`);
}

export function getClasses(element: Element): Set<string> {
	const list = new Set<string>();
	for (const cls of element.classList) {
		if (!cls.startsWith('rgh-')) {
			list.add(cls);
		}
	}

	return list;
}

export function isSmallDevice(): boolean {
	return screen.width < 500;
}



================================================
FILE: source/helpers/errors.ts
================================================
import {isEnterprise} from 'github-url-detection';
import memoize from 'memoize';

const warnOnce = memoize(console.warn, {cacheKey: JSON.stringify});

let loggingEnabled = true;

export function disableErrorLogging(): void {
	loggingEnabled = false;
}

const {version} = chrome.runtime.getManifest();

const fineGrainedTokenSuggestion = 'Please use a GitHub App, OAuth App, or a personal access token with fine-grained permissions.';
const preferredMessage = 'Refined GitHub does not support per-organization fine-grained tokens. https://github.com/refined-github/refined-github/wiki/Security';

// Reads from path like assets/features/NAME.js
export function parseFeatureNameFromStack(stack: string = new Error('stack').stack!): FeatureID | undefined {
	// The stack may show other features due to cross-feature imports, but we want the top-most caller so we need to reverse it
	const match = stack
		.split('\n')
		.toReversed()
		.join('\n')
		// eslint-disable-next-line @typescript-eslint/prefer-regexp-exec -- Linear code is best
		.match(/assets\/features\/(.+)\.js/);
	return match?.[1] as FeatureID | undefined;
}

/* Log errors only once */
const loggedStacks = new Set<string>();

export function logError(error: Error): void {
	if (!loggingEnabled) {
		return;
	}

	const {message, stack} = error;

	if (message === 'Extension context invalidated.') {
		warnOnce('â„¹ï¸ Refined GitHub has been disabled or updated. Reload the page');
		return;
	}

	const id = parseFeatureNameFromStack(stack);

	// Avoid duplicate errors
	if (loggedStacks.has(stack!)) {
		return;
	}

	loggedStacks.add(stack!);

	if (message.endsWith(fineGrainedTokenSuggestion)) {
		console.log('â„¹ï¸', id, 'â†’', message.replace(fineGrainedTokenSuggestion, preferredMessage));
		return;
	}

	if (message.includes('token')) {
		console.log('â„¹ï¸ Refined GitHub â†’', message, 'â†’', id);
		return;
	}

	const searchIssueUrl = new URL('https://github.com/refined-github/refined-github/issues');
	searchIssueUrl.searchParams.set('q', `is:issue is:open label:bug ${id ?? message}`);

	const newIssueUrl = new URL('https://github.com/refined-github/refined-github/issues/new');
	newIssueUrl.searchParams.set('template', '1_bug_report.yml');
	newIssueUrl.searchParams.set('title', id ? `\`${id}\`: ${message}` : message);
	newIssueUrl.searchParams.set('repro', location.href);
	newIssueUrl.searchParams.set('description', [
		'```',
		String(error instanceof Error ? error.stack! : error).trim(),
		'```',
	].join('\n'));

	// Don't change this to `throw Error` because Firefox doesn't show extensions' errors in the console
	console.group(`âŒ Refined GitHub: ${id ?? 'global'}`); // Safari supports only one parameter
	console.log(`ğŸ“• ${version} ${isEnterprise() ? 'GHE â†’' : 'â†’'}`, error); // One parameter improves Safari formatting
	console.log('ğŸ” Search issue', searchIssueUrl.href);
	console.log('ğŸš¨ Report issue', newIssueUrl.href);
	console.groupEnd();
}

export function catchErrors(): void {
	globalThis.addEventListener('error', event => {
		const {error} = event; // Access only once
		// Don't use `assertError` or it'll loop
		if (error) {
			logError(error);
			event.preventDefault();
		}
	});

	addEventListener('unhandledrejection', event => {
		const error = event.reason; // Access only once
		// Don't use `assertError` or it'll loop
		if (error?.stack.includes('-extension://')) {
			logError(error);
			event.preventDefault();
		}
	});
}



================================================
FILE: source/helpers/event-listener-loop.test.ts
================================================
import {describe, it, expect} from 'vitest';

import createEventIterator from './event-listener-loop.js';

describe('createEventIterator', () => {
	it('should yield events when they occur', async () => {
		const target = new EventTarget();
		const eventName = 'test-event';
		const iterator = createEventIterator(target, eventName);
		const event = new Event(eventName);

		setTimeout(() => target.dispatchEvent(event), 22);

		const result = await iterator.next();
		expect(result.value).toBe(event);
		expect(result.done).toBe(false);
	});

	it('should stop yielding events when signal is aborted', async () => {
		const target = new EventTarget();
		const eventName = 'test-event';
		const controller = new AbortController();
		const iterator = createEventIterator(target, eventName, {signal: controller.signal});
		const event = new Event(eventName);

		setTimeout(() => {
			target.dispatchEvent(event);
			controller.abort();
		}, 22);

		const result = await iterator.next();
		expect(result.value).toBe(event);
		expect(result.done).toBe(false);

		const abortedResult = await iterator.next();
		expect(abortedResult.value).toBe(undefined);
		expect(abortedResult.done).toBe(true);
	});

	it('should handle multiple events', async () => {
		const target = new EventTarget();
		const eventName = 'test-event';
		const iterator = createEventIterator(target, eventName);
		const event1 = new Event(eventName);
		const event2 = new Event(eventName);

		setTimeout(() => {
			target.dispatchEvent(event1);
			target.dispatchEvent(event2);
		}, 22);

		const result1 = await iterator.next();
		expect(result1.value).toBe(event1);
		expect(result1.done).toBe(false);

		const result2 = await iterator.next();
		expect(result2.value).toBe(event2);
		expect(result2.done).toBe(false);
	});

	it.skip('should handle synchronous events', async () => {
		const target = new EventTarget();
		const eventName = 'test-event';
		const iterator = createEventIterator(target, eventName);
		const event = new Event(eventName);

		// This fails because native async generator functions aren't actually executed when calledâ€¦
		target.dispatchEvent(event);

		const result = await iterator.next();
		expect(result.value).toBe(event);
		expect(result.done).toBe(false);
	});
});



================================================
FILE: source/helpers/event-listener-loop.ts
================================================
async function * createEventIterator<T extends Event>(
	element: EventTarget,
	eventName: string,
	{signal, once}: {
		signal?: AbortSignal;
		once?: boolean;
	} = {},
): AsyncGenerator<T> {
	const queue: T[] = [];
	let deferred = Promise.withResolvers<void>();

	const handler = (event: Event): void => {
		queue.push(event as T);
		deferred.resolve();
		deferred = Promise.withResolvers<void>();
	};

	try {
		element.addEventListener(eventName, handler, {once});

		while (!signal?.aborted) {
			if (queue.length === 0) {
				// eslint-disable-next-line no-await-in-loop
				await deferred.promise;
			}

			yield queue.shift()!;

			if (once) {
				break;
			}
		}
	} finally {
		element.removeEventListener(eventName, handler);
	}
}

export default createEventIterator;



================================================
FILE: source/helpers/feature-helpers.ts
================================================
export const shortcutMap = new Map<string, string>();

export const getFeatureID = (url: string): FeatureID => url.split('/').pop()!.split('.')[0] as FeatureID;

type FeatureHelper = {
	/** If `import.meta.url` is passed as URL, this will be the feature ID */
	id: string;

	/** A class name that can be added as attribute */
	class: string;

	/** A class selector that can be used with querySelector */
	selector: string;
};

export function getIdentifiers(url: string): FeatureHelper {
	const id = getFeatureID(url);
	return {
		id,
		class: 'rgh-' + id,
		selector: '.rgh-' + id,
	};
}

function noop(): void {/* empty */}

const httpLog = console.log.bind(console, 'ğŸŒ');

export const log = {
	info: console.log,
	http: httpLog,
	setup({logging, logHTTP}: {logging: boolean; logHTTP: boolean}): void {
		log.info = logging ? console.log : noop;
		log.http = logHTTP ? httpLog : noop;
	},
};

let _isInitialLoad = true;

export function isInitialLoad(): boolean {
	return _isInitialLoad;
}

export function markAjaxedLoad(): void {
	_isInitialLoad = false;
}

export function listenToAjaxedLoad(): void {
	document.addEventListener('soft-nav:start', markAjaxedLoad, {once: true});
	document.addEventListener('pjax:start', markAjaxedLoad, {once: true});
}



================================================
FILE: source/helpers/feature-utils.test.ts
================================================
import {test, assert} from 'vitest';

import {shouldFeatureRun} from './feature-utils.js';

const yes = (): boolean => true;
const no = (): boolean => false;

test('shouldFeatureRun', async () => {
	const yesYes = [yes, yes];
	const yesNo = [yes, no];
	const noNo = [no, no];

	assert.isTrue(await shouldFeatureRun({}), 'A lack of conditions should mean "run everywhere"');

	assert.isFalse(await shouldFeatureRun({
		asLongAs: yesNo,
	}), 'Every `asLongAs` should be true to run');

	assert.isFalse(await shouldFeatureRun({
		asLongAs: yesNo,
		include: [yes],
	}), 'Every `asLongAs` should be true to run, regardless of `include`');

	assert.isFalse(await shouldFeatureRun({
		include: noNo,
	}), 'At least one `include` should be true to run');

	assert.isTrue(await shouldFeatureRun({
		include: yesNo,
	}), 'If one `include` is true, then it should run');

	assert.isFalse(await shouldFeatureRun({
		exclude: yesNo,
	}), 'If any `exclude` is true, then it should not run');

	assert.isFalse(await shouldFeatureRun({
		include: [yes],
		exclude: yesNo,
	}), 'If any `exclude` is true, then it should not run, regardless of `include`');

	assert.isFalse(await shouldFeatureRun({
		asLongAs: [yes],
		exclude: yesNo,
	}), 'If any `exclude` is true, then it should not run, regardless of `asLongAs`');

	assert.isFalse(await shouldFeatureRun({
		asLongAs: [yes],
		include: yesYes,
		exclude: yesNo,
	}), 'If any `exclude` is true, then it should not run, regardless of `asLongAs` and `include`');
});



================================================
FILE: source/helpers/feature-utils.ts
================================================
import type {Promisable} from 'type-fest';

import {pEveryFunction, pSomeFunction} from './p-utils.js';

export type BooleanFunction = () => boolean;
type PromisableBooleanFunction = () => Promisable<boolean>;

export type RunConditions = {
	/** Every condition must be true */
	asLongAs?: PromisableBooleanFunction[];
	/** At least one condition must be true */
	include?: PromisableBooleanFunction[];
	/** No conditions must be true */
	exclude?: PromisableBooleanFunction[];
};

export function isFeaturePrivate(id: string): boolean {
	return id.startsWith('rgh-');
}

// Safari iOS 17.6 has the key, but it does nothing
export const doesBrowserActionOpenOptions = !globalThis.chrome?.contextMenus || navigator.platform === 'iPhone' || navigator.platform === 'iPad';

export async function shouldFeatureRun({
	/** Every condition must be true */
	asLongAs = [() => true],
	/** At least one condition must be true */
	include = [() => true],
	/** No conditions must be true */
	exclude = [() => false],
}: RunConditions): Promise<boolean> {
	return await pEveryFunction(asLongAs, c => c())
		&& await pSomeFunction(include, c => c())
		&& pEveryFunction(exclude, async c => !await c());
}



================================================
FILE: source/helpers/fetch-dom.ts
================================================
import mem from 'memoize';
import domify from 'doma';
import type {ParseSelector} from 'typed-query-selector/parser.js';

import {log} from './feature-helpers.js';

async function fetchDom(url: string): Promise<DocumentFragment>;
async function fetchDom<Selector extends string, TElement extends HTMLElement = ParseSelector<Selector, HTMLElement>>(url: string, selector: Selector): Promise<TElement | undefined>;
async function fetchDom(url: string, selector?: string): Promise<Node | undefined> {
	log.http(url);
	const absoluteURL = new URL(url, location.origin).href; // Firefox `fetch`es from the content script, so relative URLs fail
	const response = await fetch(absoluteURL);
	const dom = domify(await response.text());
	if (selector) {
		return dom.querySelector(selector) ?? undefined;
	}

	return dom;
}

export {fetchDom as fetchDomUncached};

export default mem(fetchDom);



================================================
FILE: source/helpers/get-items-between.test.ts
================================================
import {test, assert} from 'vitest';

import getItemsBetween from './get-items-between.js';

test('getItemsBetween', () => {
	const list = ['â¤ï¸', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™'];

	assert.deepEqual(getItemsBetween(list, 'ğŸ’›', 'ğŸ’š'), ['ğŸ’›', 'ğŸ’š']);
	assert.deepEqual(getItemsBetween(list, 'ğŸ’š', 'ğŸ’›'), ['ğŸ’›', 'ğŸ’š']);
	assert.deepEqual(getItemsBetween(list, 'â¤ï¸', 'ğŸ’™'), ['â¤ï¸', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™']);
	assert.deepEqual(getItemsBetween(list, 'ğŸ’™', 'â¤ï¸'), ['â¤ï¸', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™']);
	assert.deepEqual(getItemsBetween(list, undefined, 'â¤ï¸'), ['â¤ï¸']);
	assert.deepEqual(getItemsBetween(list, undefined, 'ğŸ’š'), ['â¤ï¸', 'ğŸ’›', 'ğŸ’š']);
	assert.deepEqual(getItemsBetween(list, undefined, 'ğŸ’™'), ['â¤ï¸', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™']);
});



================================================
FILE: source/helpers/get-items-between.ts
================================================
/**
Get the items between previous and current, both ends included. If `previous` is missing, start from 0
*/
export default function getItemsBetween<T>(items: T[], previous: T | undefined, current: T): T[] {
	const start = previous ? items.indexOf(previous) : 0;
	const end = items.indexOf(current);

	return items.slice(Math.min(start, end), Math.max(start, end) + 1);
}



================================================
FILE: source/helpers/get-text-nodes.ts
================================================
export default function getTextNodes(element: Node): Text[] {
	const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT);
	const nodes: Text[] = [];
	let node;

	do {
		node = walker.nextNode();
		if (node) {
			nodes.push(node as Text);
		}
	} while (node);

	return nodes;
}



================================================
FILE: source/helpers/hash-string.ts
================================================
export default function hashString(string: string): string {
	let hash = 0;

	for (const character of string) {
		// eslint-disable-next-line no-bitwise -- Low-level hash function
		hash = ((hash << 5) - hash) + character.codePointAt(0)!;
	}

	return String(Math.trunc(hash));
}



================================================
FILE: source/helpers/history.ts
================================================
export default function removeHashFromUrlBar(): void {
	const url = new URL(location.href);
	url.hash = '';
	history.replaceState(history.state, '', url.href);
}



================================================
FILE: source/helpers/hotfix.tsx
================================================
import React from 'dom-chef';
import {CachedFunction} from 'webext-storage-cache';
import {isEnterprise} from 'github-url-detection';
import compareVersions from 'tiny-version-compare';
import {any as concatenateTemplateLiteralTag} from 'code-tag';

import type {RGHOptions} from '../options-storage.js';
import isDevelopmentVersion from './is-development-version.js';
import {isomorphicFetchText} from './isomorphic-fetch.js';

const {version: currentVersion} = chrome.runtime.getManifest();

function parseCsv(content: string): string[][] {
	const lines = [];
	const [_header, ...rawLines] = content.trim().split('\n');
	for (const line of rawLines) {
		if (line.trim()) {
			lines.push(line.split(',').map(cell => cell.trim()));
		}
	}

	return lines;
}

async function fetchHotfix(path: string): Promise<string> {
	// Use GitHub Pages host because the API is rate-limited
	return isomorphicFetchText(`https://refined-github.github.io/yolo/${path}`, {
		cache: 'no-store', // Disable caching altogether
	});
}

type HotfixStorage = Array<[FeatureID, string, string]>;

export const brokenFeatures = new CachedFunction('broken-features', {
	async updater(): Promise<HotfixStorage> {
		const content = await fetchHotfix('broken-features.csv');
		if (!content) {
			return [];
		}

		const storage: HotfixStorage = [];
		for (const [featureID, relatedIssue, unaffectedVersion] of parseCsv(content)) {
			if (featureID && relatedIssue && (!unaffectedVersion || compareVersions(unaffectedVersion, currentVersion) > 0)) {
				storage.push([featureID as FeatureID, relatedIssue, unaffectedVersion]);
			}
		}

		return storage;
	},
	maxAge: {hours: 6},
	staleWhileRevalidate: {days: 30},
});

export const styleHotfixes = new CachedFunction('style-hotfixes', {
	updater: async (version: string): Promise<string> => fetchHotfix(`style/${version}.css`),

	maxAge: {hours: 6},
	staleWhileRevalidate: {days: 300},
	cacheKey: () => '',
});

export async function getLocalHotfixes(): Promise<HotfixStorage> {
	// To facilitate debugging, ignore hotfixes during development.
	// Change the version in manifest.json to test hotfixes
	if (isDevelopmentVersion()) {
		return [];
	}

	return await brokenFeatures.get() ?? [];
}

export async function getLocalHotfixesAsOptions(): Promise<Partial<RGHOptions>> {
	const options: Partial<RGHOptions> = {};
	for (const [feature] of await getLocalHotfixes()) {
		options[`feature:${feature}`] = false;
	}

	return options;
}

export async function applyStyleHotfixes(style: string): Promise<void> {
	if (isDevelopmentVersion() || isEnterprise() || !style) {
		return;
	}

	// Prepend to body because that's the only way to guarantee they come after the static file
	document.body.prepend(<style>{style}</style>);
}

let localStrings: Record<string, string> = {};
export function _(...arguments_: Parameters<typeof concatenateTemplateLiteralTag>): string {
	const original = concatenateTemplateLiteralTag(...arguments_);
	return localStrings[original] ?? original;
}

const localStringsHotfix = new CachedFunction('strings-hotfixes', {
	async updater(): Promise<Record<string, string>> {
		const json = await fetchHotfix('strings.json');
		return json ? JSON.parse(json) : {};
	},
	maxAge: {hours: 6},
	staleWhileRevalidate: {days: 30},
});

// Updates the local object from the storage to enable synchronous access
export async function preloadSyncLocalStrings(): Promise<void> {
	if (isDevelopmentVersion() || isEnterprise()) {
		return;
	}

	localStrings = await localStringsHotfix.get() ?? {};
}



================================================
FILE: source/helpers/is-development-version.ts
================================================
const {version} = chrome.runtime.getManifest();

export default function isDevelopmentVersion(): boolean {
	return version === '0.0.0';
}



================================================
FILE: source/helpers/is-low-quality-comment.test.ts
================================================
import {describe, test, assert} from 'vitest';

import isLowQualityComment from './is-low-quality-comment.js';

describe('isLowQualityComment', () => {
	describe('returns true', () => {
		test.each([
			'+1',
			'+1!',
			'+10',
			'+9000',
			'-1',
			'ğŸ‘',
			'ğŸ‘ğŸ¾',
			'me too',
			'ditto',
			'Dito',
			'following',
			'please update!',
			'please update ğŸ™ğŸ»',
			'same issue',
			'this same issues',
			'same question',
			'any updates there?',
			'any updates on this?',
			'This is still an issue for me',
			'Still an issue',
			'Issue for me too.',
			'and for me',
		])('%s', comment => {
			assert.isTrue(isLowQualityComment(comment));
		});
	});

	describe('returns false', () => {
		test.each([
			'+1\n<some useful information>',
			'Same here. <some useful information>',
			'Same here, please update, thanks',
			'Same here! Please update, thank you.',
		])('%s', comment => {
			assert.isFalse(isLowQualityComment(comment));
		});
	});
});



================================================
FILE: source/helpers/is-low-quality-comment.ts
================================================
const lowQualityWords = [
	'a',
	'an',
	'and',
	'any',
	'bump',
	'dito',
	'ditto',
	'following',
	'for',
	'here',
	'is',
	'issue',
	'issues',
	'me',
	'on',
	'please',
	'pls',
	'plz',
	'question',
	'same',
	'solution',
	'still',
	'there',
	'this',
	'too',
	'update',
	'updates',
];
const lowQualityWordsRegex = new RegExp(String.raw`\b(${lowQualityWords.join('|')})\b`, 'gi');

export default function isLowQualityComment(text: string): boolean {
	// Note: the unicode range targets skin color modifiers for the hand emojis
	return text
		.replaceAll(lowQualityWordsRegex, '')
		.replaceAll(/[\s,.!?ğŸ‘ğŸ‘ğŸ‘ŒğŸ™]+|[\u{1F3FB}-\u{1F3FF}]|[+-]\d+|â¬†ï¸/gu, '') === '';
}



================================================
FILE: source/helpers/isomorphic-fetch.ts
================================================
import {isWebPage} from 'webext-detect';
import {messageRuntime} from 'webext-msg';

export async function fetchText(url: string, options: RequestInit): Promise<string> {
	const response = await fetch(url, options);
	return response.ok
		? response.text()
		: ''; // Likely a 404. Either way the response isn't the CSS we expect #8142
}

export async function isomorphicFetchText(url: string, options: RequestInit): Promise<string> {
	return isWebPage()
		// Firefox CSP issue: https://github.com/refined-github/refined-github/issues/8144
		? messageRuntime({fetchString: {url, options}})
		: fetchText(url, options);
}



================================================
FILE: source/helpers/loose-parse-int.test.ts
================================================
import {test, assert} from 'vitest';

import looseParseInt from './loose-parse-int.js';

test('looseParseInt', () => {
	assert.equal(looseParseInt('1,234'), 1234);
	assert.equal(looseParseInt('Bugs 1,234'), 1234);
	assert.equal(looseParseInt('5000+ issues'), 5000);
});



================================================
FILE: source/helpers/loose-parse-int.ts
================================================
// eslint-disable-next-line @typescript-eslint/no-restricted-types -- Simplify passing random nodes
export default function looseParseInt(text: ChildNode | string | undefined | null): number {
	if (!text) {
		return 0;
	}

	if (typeof text !== 'string') {
		text = text.textContent;
	}

	return Number(text.replaceAll(/\D+/g, ''));
}



================================================
FILE: source/helpers/map-of-arrays.ts
================================================
export default class ArrayMap<Key, Value> extends Map<Key, Value[]> {
	append(key: Key, ...values: Value[]): void {
		if (!this.has(key)) {
			this.set(key, []);
		}

		this.get(key)!.push(...values);
	}
}



================================================
FILE: source/helpers/matches-any-patterns.ts
================================================
/** Tests a target string against a list of strings (full match) or regexes (can be mixed) */
export default function matchesAnyPattern(
	target: string,
	patterns: Array<string | RegExp | ((x: string) => boolean)>,
): boolean {
	return patterns.some(pattern => {
		if (typeof pattern === 'string') {
			return pattern === target;
		}

		if (typeof pattern === 'function') {
			return pattern(target);
		}

		return pattern.test(target);
	});
}



================================================
FILE: source/helpers/math.ts
================================================
/**
 * Inverse operation of linear interpolation. Given a range and a
 * value, returns the interpolation amount to get that value.
 *
 * @param min Lowest value in the range
 * @param max Highest value in the range
 * @param value Value in the range
 * @returns Interpolation amount from 0.0 to 1.0 (or beyond if `x` is outside the range [min, max])
 */
function inverseLinearInterpolation(min: number, max: number, value: number): number {
	if (min === max) {
		return 0;
	}

	return (value - min) / (max - min);
}

/**
 * Create a function that calculates a GitHub heat index based on a list of numbers.
 * The list is used to find the min and max of the range. The function can then
 * calculate a heat index for a given value based on that range.
 *
 * GitHub has 10 heat values, and uses a lower heat index for a higher value. So the
 * highest heat index that will be returned is 1, and the lowest is 10.
 *
 * @param numbers values to use to calculate the min and max of the heat range
 * @returns function to calculate heat index of a given number
 */
export function createHeatIndexFunction(numbers: number[]): (value: number) => number {
	const steps = 10; // GH has 10 heat colors
	const min = Math.min(...numbers);
	const max = Math.max(...numbers);

	return (value: number) => {
		// Inverse linear interpolation figures out how far the value is between min & max
		const interp = Math.max(0, Math.min(1, inverseLinearInterpolation(min, max, value)));

		// Maps the [0.0, 1.0] value to [steps, 1]
		const floored = Math.floor(interp * steps);
		const heatIndex = Math.max(1, steps - floored);

		return heatIndex;
	};
}

export function randomArrayItem<T>(items: T[]): T {
	return items.at(Math.floor(Math.random() * items.length))!;
}



================================================
FILE: source/helpers/on-element-removal.ts
================================================
import mem from 'memoize';

const onElementRemoval = mem(async (element: Element, signal?: AbortSignal): Promise<void> => {
	if (signal?.aborted) {
		return;
	}

	return new Promise(resolve => {
		const observer = new ResizeObserver(([{target}], observer) => {
			if (!target.isConnected) {
				observer.disconnect();
				resolve();
			}
		});

		if (signal) {
			signal.addEventListener('abort', () => {
				observer.disconnect();
				resolve();
			}, {
				once: true,
			});
		}

		observer.observe(element);
	});
});

export default onElementRemoval;



================================================
FILE: source/helpers/onetime.ts
================================================
const notRun = Symbol('false');
export default function onetime<ArgumentsType extends unknown[], ReturnType>(function_: (...arguments_: ArgumentsType) => ReturnType): (...arguments_: ArgumentsType) => ReturnType {
	let returnValue: ReturnType | typeof notRun = notRun;
	return function (this: unknown, ...arguments_: ArgumentsType): ReturnType {
		if (returnValue !== notRun) {
			return returnValue;
		}

		returnValue = Reflect.apply(function_, this, arguments_);
		return returnValue;
	};
}



================================================
FILE: source/helpers/open-options.tsx
================================================
import React from 'dom-chef';
import {messageRuntime} from 'webext-msg';

export default function openOptions(event: Event | React.UIEvent): void {
	event.preventDefault();
	void messageRuntime({openOptionsPage: true});
}

export function OptionsLink(): JSX.Element {
	return (
		<button type="button" onClick={openOptions} />
	);
}



================================================
FILE: source/helpers/open-tabs.ts
================================================
import {messageRuntime} from 'webext-msg';

import showToast from '../github-helpers/toast.js';
import pluralize from '../helpers/pluralize.js';

export default async function openTabs(urls: string[]): Promise<boolean> {
	if (urls.length >= 10 && !confirm(`This will open ${urls.length} new tabs. Continue?`)) {
		return false;
	}

	const response = messageRuntime({
		openUrls: urls,
	});

	await showToast(response, {
		message: 'Openingâ€¦',
		doneMessage: pluralize(urls.length, '$$ tab') + ' opened',
	});

	return true;
}



================================================
FILE: source/helpers/p-utils.ts
================================================
import type {IterableElement, Promisable} from 'type-fest';

export function pSomeFunction<
	List extends Iterable<unknown>,
	Element extends IterableElement<List>,
>(
	iterable: List,
	predicate: (value: Element) => Promisable<boolean>,
): Promisable<boolean> {
	const promises: Array<PromiseLike<boolean>> = [];
	// Prioritize sync functions and early returns
	for (const item of iterable) {
		const result = predicate(item as Element);
		if (typeof result === 'boolean') {
			if (result) {
				// Early sync return on the first truthy value
				return true;
			}
		} else {
			promises.push(result);
		}
	}

	if (promises.length === 0) {
		// Matches `[].some(Boolean)`
		return false;
	}

	return pSome(promises);
}

async function pSome(iterable: Iterable<PromiseLike<unknown>>): Promise<boolean> {
	// eslint-disable-next-line no-async-promise-executor -- It's fine, resolve is at the end
	return new Promise(async resolve => {
		for (const promise of iterable) {
			(async () => {
				if (await promise) {
					resolve(true);
				}
			})();
		}

		await Promise.allSettled(iterable);

		resolve(false);
	});
}

export function pEveryFunction<
	List extends Iterable<unknown>,
	Element extends IterableElement<List>,
>(
	iterable: List,
	predicate: (value: Element) => Promisable<boolean>,
): Promisable<boolean> {
	const promises: Array<PromiseLike<boolean>> = [];
	// Prioritize sync functions and early returns
	for (const item of iterable) {
		const result = predicate(item as Element);
		if (typeof result === 'boolean') {
			if (!result) {
				// Early sync return on the first falsy value
				return false;
			}
		} else {
			promises.push(result);
		}
	}

	if (promises.length === 0) {
		// Matches `[].every(Boolean)`
		return true;
	}

	return pEvery(promises);
}

async function pEvery(iterable: Iterable<PromiseLike<unknown>>): Promise<boolean> {
	const results = await Promise.all(iterable);
	return results.every(Boolean);
}



================================================
FILE: source/helpers/pluralize.test.ts
================================================
import {test, assert} from 'vitest';

import pluralize from './pluralize.js';

test('pluralize', () => {
	assert.equal(pluralize(0, 'A number', '$$ numbers'), '0 numbers');
	assert.equal(pluralize(0, 'A number', '$$ numbers', 'No numbers'), 'No numbers');
	assert.equal(pluralize(1, 'A number', '$$ numbers', 'No numbers'), 'A number');
	assert.equal(pluralize(2, 'A number', '$$ numbers', 'No numbers'), '2 numbers');
	assert.equal(pluralize(2, 'A number', 'Many numbers', 'No numbers'), 'Many numbers');
});



================================================
FILE: source/helpers/pluralize.ts
================================================
function regular(single: string): string {
	return single + 's';
}

export default function pluralize(
	count: number,
	single: string,
	plural = regular(single),
	zero?: string,
): string {
	if (count === 0 && zero) {
		return zero.replace('$$', '0');
	}

	if (count === 1) {
		return single.replace('$$', '1');
	}

	return plural.replace('$$', String(count));
}



================================================
FILE: source/helpers/pr-commit-cleaner.test.ts
================================================
import {test, assert} from 'vitest';

import cleanPrCommitTitle from './pr-commit-cleaner.js';

test('cleanPrCommitTitle', () => {
	const clean = 'Something done';
	assert.equal(cleanPrCommitTitle('Something done (#123)', 123), clean);
	assert.equal(cleanPrCommitTitle('  Something done  (#123)  ', 123), clean);
	assert.equal(cleanPrCommitTitle(' Something done ', 123), clean);

	assert.notEqual(cleanPrCommitTitle('Something done (fixes #123)', 123), clean);
	assert.notEqual(cleanPrCommitTitle('Something done (#23454)', 123), clean);
});



================================================
FILE: source/helpers/pr-commit-cleaner.ts
================================================
/**
@example 'Something done (#123)' => 'Something done'
*/
export default function cleanPrCommitTitle(commitTitle: string, pr: number): string {
	return commitTitle.replace(new RegExp(String.raw`\(#${pr}\)\s*$`), '').trim();
}



================================================
FILE: source/helpers/preserve-scroll.ts
================================================
export default function preserveScroll(anchor: Element = document.elementFromPoint(innerWidth / 2, innerHeight / 2)!): VoidFunction {
	const originalPosition = anchor.getBoundingClientRect().top;

	/**
	Resets the previously-saved scroll
	*/
	return () => {
		requestAnimationFrame(() => {
			const newPosition = anchor.getBoundingClientRect().top;
			window.scrollBy(0, newPosition - originalPosition);
		});
	};
}



================================================
FILE: source/helpers/recreate-element.ts
================================================
export default function replaceElementTypeInPlace<Type extends keyof HTMLElementTagNameMap>(
	oldElement: Element,
	type: Type,
): HTMLElementTagNameMap[Type] {
	const newElement = document.createElement(type);
	for (const {name, value} of oldElement.attributes) {
		newElement.setAttribute(name, value);
	}

	newElement.append(...oldElement.children);
	oldElement.replaceWith(newElement);
	return newElement;
}



================================================
FILE: source/helpers/rgh-links.tsx
================================================
import React from 'dom-chef';

export function createRghIssueLink(issueNumber: number | string): Element {
	const issueUrl = `https://github.com/refined-github/refined-github/issues/${issueNumber}`;
	return (
		<a
			target="_blank"
			rel="noopener noreferrer"
			data-hovercard-type="issue"
			data-hovercard-url={issueUrl + '/hovercard'}
			href={issueUrl}
		>
			#{issueNumber}
		</a>
	);
}

export function getFeatureUrl(id: FeatureID): string {
	return `https://github.com/refined-github/refined-github/blob/main/source/features/${id}.tsx`;
}



================================================
FILE: source/helpers/selector-observer.tsx
================================================
import React from 'dom-chef';
import {css} from 'code-tag';
import type {ParseSelector} from 'typed-query-selector/parser.js';
import domLoaded from 'dom-loaded';
import {signalFromPromise} from 'abort-utils';

import delay from '../helpers/delay.js';
import onetime from '../helpers/onetime.js';
import optionsStorage from '../options-storage.js';
import getCallerID from './caller-id.js';
import {parseFeatureNameFromStack} from './errors.js';

type ObserverListener<ExpectedElement extends Element> = (element: ExpectedElement, options: SignalAsOptions) => void;

type Options = {
	stopOnDomReady?: boolean;
	once?: boolean;
	signal?: AbortSignal;
	/** Refer to getCallerID's documentation */
	ancestor?: number;
};

const animation = 'rgh-selector-observer';

const registerAnimation = onetime((): void => {
	document.head.append(<style>{`@keyframes ${animation} {}`}</style>);
});

export default function observe<
	Selector extends string,
	ExpectedElement extends ParseSelector<Selector, HTMLElement | SVGElement>,
>(
	selectors: Selector | readonly Selector[],
	listener: ObserverListener<ExpectedElement>,
	{signal, stopOnDomReady, once, ancestor}: Options = {},
): void {
	if (signal?.aborted) {
		return;
	}

	if (stopOnDomReady) {
		const delayedDomReady = signalFromPromise((async () => {
			await domLoaded;
			await delay(100); // Allow the animation and events to complete; Also adds support for ajaxed pages
		})());

		signal = signal ? AbortSignal.any([signal, delayedDomReady]) : delayedDomReady;
	}

	const selector = typeof selectors === 'string' ? selectors : selectors.join(',\n');
	const seenMark = 'rgh-seen-' + getCallerID(ancestor);

	registerAnimation();

	const rule = document.createElement('style');
	// Enable when/if needed
	// if (isDevelopmentVersion()) {
	// 	// For debuggability
	// 	rule.setAttribute('s', selector);
	// }

	rule.textContent = css`
		:where(${String(selector)}):not(.${seenMark}) {
			animation: 1ms ${animation};
		}
	`;
	document.body.prepend(rule);
	signal?.addEventListener('abort', () => {
		rule.remove();
	});

	let called = false;
	// Capture stack outside
	const currentFeature = parseFeatureNameFromStack();
	(async () => {
		const {logging} = await optionsStorage.getAll();
		if (!logging) {
			return;
		}

		await domLoaded;
		await delay(1000);
		if (!called && !signal?.aborted) {
			console.warn(currentFeature, 'â†’ Selector not found on page:', selector);
		}
	})();

	globalThis.addEventListener('animationstart', (event: AnimationEvent) => {
		const target = event.target as ExpectedElement;
		// The target can match a selector even if the animation actually happened on a ::before pseudo-element, so it needs an explicit exclusion here
		if (target.classList.contains(seenMark) || !target.matches(selector)) {
			return;
		}

		called = true;

		// Removes this specific selectorâ€™s animation once it was seen
		target.classList.add(seenMark);

		listener(target, {signal});
	}, {once, signal});
}

// Untested, likely breaks due to wrong `ancestor` level
export async function waitForElement<
	Selector extends string,
	ExpectedElement extends ParseSelector<Selector, HTMLElement | SVGElement>,
>(
	selectors: Selector | readonly Selector[],
	{signal, stopOnDomReady}: Options = {},
): Promise<ExpectedElement | void> {
	const local = new AbortController();
	signal = signal ? AbortSignal.any([signal, local.signal]) : local.signal;

	return new Promise<ExpectedElement | void>(resolve => {
		observe<Selector, ExpectedElement>(selectors, element => {
			resolve(element);
			local.abort();
		}, {signal, stopOnDomReady, once: true});

		signal.addEventListener('abort', () => {
			resolve();
		});
	});
}



================================================
FILE: source/helpers/show-whitespace-on-line.test.ts
================================================
import {assert, test} from 'vitest';
import hl from 'highlight.js';

import showWhiteSpacesOnLine from './show-whitespace-on-line.js';

function highlight(html: string): string {
	// Use highlighter to create multiple text nodes
	return hl.highlight(html, {language: 'js'}).value;
}

function serializeDOM(element: Element): string {
	for (const replacement of element.querySelectorAll('[data-rgh-whitespace]')) {
		switch (replacement.getAttribute('data-rgh-whitespace')) {
			case 'space': {
				replacement.replaceWith(replacement.innerHTML.replaceAll(' ', 'â€¢'));
				break;
			}

			case 'tab': {
				replacement.replaceWith(replacement.innerHTML.replaceAll('\t', 'âŸ¶'));
				break;
			}

			default:
		}
	}

	for (const highlighting of element.querySelectorAll('[class^="hljs"]')) {
		highlighting.replaceWith(highlighting.innerHTML);
	}

	// Compare against the HTML to ensure we're making all the necessary replacements
	return element.innerHTML;
}

function process(html: string): string {
	const element = document.createElement('div');
	element.innerHTML = html;
	return serializeDOM(showWhiteSpacesOnLine(element));
}

function assertProcess(actual: string, expected: string): void {
	assert.equal(process(actual), expected);
}

function assertHighlighted(actual: string, expected: string): void {
	assert.equal(process(highlight(actual)), expected);
}

test('showWhiteSpacesOnLine raw', () => {
	assertProcess(
		'',
		'',
	);
	assertProcess(
		' ',
		'â€¢',
	);
	assertProcess(
		'  ',
		'â€¢â€¢',
	);
	assertProcess(
		'	',
		'âŸ¶',
	);
	assertProcess(
		'		',
		'âŸ¶âŸ¶',
	);
	assertProcess(
		'	 ',
		'âŸ¶â€¢',
	);
	assertProcess(
		' 	',
		'â€¢âŸ¶',
	);
	assertProcess(
		' 	 ',
		'â€¢âŸ¶â€¢',
	);
	assertProcess(
		'	 	',
		'âŸ¶â€¢âŸ¶',
	);
	assertProcess(
		' hello ',
		'â€¢helloâ€¢',
	);
	assertProcess(
		'	hello	',
		'âŸ¶helloâŸ¶',
	);
	assertProcess(
		'	hello world	',
		'âŸ¶helloâ€¢worldâŸ¶',
	);
});

test('showWhiteSpacesOnLine real code', () => {
	assertProcess(
		'[1,""]',
		'[1,""]',
	);
	assertProcess(
		'[1,"  "]',
		'[1,"â€¢â€¢"]',
	);
	assertProcess(
		'[1, "  "]',
		'[1,â€¢"â€¢â€¢"]',
	);
	assertProcess(
		' [1, "  "] ',
		'â€¢[1,â€¢"â€¢â€¢"]â€¢',
	);
	assertProcess(
		'  [1, "  "]  ',
		'â€¢â€¢[1,â€¢"â€¢â€¢"]â€¢â€¢',
	);
	assertProcess(
		'[1,""]',
		'[1,""]',
	);
	assertProcess(
		'[1,"		"]',
		'[1,"âŸ¶âŸ¶"]',
	);
	assertProcess(
		'[1,	"		"]',
		'[1,âŸ¶"âŸ¶âŸ¶"]',
	);
	assertProcess(
		'	[1,	"		"]	',
		'âŸ¶[1,âŸ¶"âŸ¶âŸ¶"]âŸ¶',
	);
	assertProcess(
		'		[1,	"		"]		',
		'âŸ¶âŸ¶[1,âŸ¶"âŸ¶âŸ¶"]âŸ¶âŸ¶',
	);
});

test('showWhiteSpacesOnLine highlighted code', () => {
	assertHighlighted(
		'[1,""]',
		'[1,""]',
	);
	assertHighlighted(
		'[1,"  "]',
		'[1,"â€¢â€¢"]',
	);
	assertHighlighted(
		'[1, "  "]',
		'[1, "â€¢â€¢"]',
	);
	assertHighlighted(
		' [1, "  "] ',
		'â€¢[1, "â€¢â€¢"]â€¢',
	);
	assertHighlighted(
		'  [1, "  "]  ',
		'â€¢â€¢[1, "â€¢â€¢"]â€¢â€¢',
	);
	assertHighlighted(
		'[1,""]',
		'[1,""]',
	);
	assertHighlighted(
		'[1,"		"]',
		'[1,"âŸ¶âŸ¶"]',
	);
	assertHighlighted(
		'[1,	"		"]',
		'[1,âŸ¶"âŸ¶âŸ¶"]',
	);
	assertHighlighted(
		'	[1,	"		"]	',
		'âŸ¶[1,âŸ¶"âŸ¶âŸ¶"]âŸ¶',
	);
	assertHighlighted(
		'		[1,	"		"]		',
		'âŸ¶âŸ¶[1,âŸ¶"âŸ¶âŸ¶"]âŸ¶âŸ¶',
	);
});



================================================
FILE: source/helpers/show-whitespace-on-line.tsx
================================================
import React from 'dom-chef';

import getTextNodes from './get-text-nodes.js';

// `splitText` is used before and after each whitespace group so a new whitespace-only text node is created. This new node is then wrapped in a <span>
export default function showWhiteSpacesOnLine(line: Element, shouldAvoidSurroundingSpaces = false): Element {
	const textNodesOnThisLine = getTextNodes(line);
	for (const [nodeIndex, textNode] of textNodesOnThisLine.entries()) {
		// `textContent` reads must be cached #2737
		let text = textNode.textContent;
		if (text.length > 1000) { // #5092
			continue;
		}

		// This refers to the boundary text nodes, not actual whitespace nodes. Text nodes are generated by the syntax highlighter, so non-highlighted text will have one text node.
		const isLeading = nodeIndex === 0;
		const isTrailing = nodeIndex === textNodesOnThisLine.length - 1;

		const startingCharacterIndex = shouldAvoidSurroundingSpaces && isLeading ? 1 : 0;
		const skipLastCharacter = shouldAvoidSurroundingSpaces && isTrailing;
		const endingCharacterIndex = text.length - 1 - Number(skipLastCharacter);

		// Loop goes in reverse otherwise `splitText`'s `index` parameter needs to keep track of the previous split
		for (let index = endingCharacterIndex; index >= startingCharacterIndex; index--) {
			const thisCharacter = text[index];
			const endingIndex = index;

			// Exclude irrelevant characters
			if (thisCharacter !== ' ' && thisCharacter !== '\t') {
				continue;
			}

			// Find the same character so they can be wrapped together, but stop at `startingCharacterIndex`
			while (text[index - 1] === thisCharacter && !(index === startingCharacterIndex)) {
				index--;
			}

			// Skip non-boundary single spaces
			if (!isLeading && !isTrailing && index === endingIndex && thisCharacter === ' ') {
				continue;
			}

			if (endingIndex < text.length - 1) {
				textNode.splitText(endingIndex + 1);
			}

			textNode.splitText(index);

			// Update cached variable here because it just changed
			text = textNode.textContent;

			textNode.after(
				<span data-rgh-whitespace={thisCharacter === '\t' ? 'tab' : 'space'}>
					{textNode.nextSibling}
				</span>,
			);
		}
	}

	return line;
}



================================================
FILE: source/helpers/smart-block-wrap.ts
================================================
// Wraps string in at least two newlines on each side,
// as long as the field doesn't already have them.
// Code adapted from GitHub.
export default function smartBlockWrap(
	content: string,
	field: HTMLTextAreaElement,
): string {
	const before = field.value.slice(0, field.selectionStart);
	const after = field.value.slice(field.selectionEnd);
	const [whitespaceAtStart] = /\n*$/.exec(before)!;
	const [whitespaceAtEnd] = /^\n*/.exec(after)!;
	let newlinesToAppend = '';
	let newlinesToPrepend = '';
	if (/\S/.test(before) && whitespaceAtStart.length < 2) {
		newlinesToPrepend = '\n'.repeat(2 - whitespaceAtStart.length);
	}

	if (/\S/.test(after) && whitespaceAtEnd.length < 2) {
		newlinesToAppend = '\n'.repeat(2 - whitespaceAtEnd.length);
	}

	return newlinesToPrepend + content + newlinesToAppend;
}



================================================
FILE: source/helpers/types.d.ts
================================================
/* eslint-disable @typescript-eslint/no-restricted-types -- The API does return `null`, not `undefined` */
import type {StrictlyParseSelector} from 'typed-query-selector/parser.js';

// Enables import.meta.glob: https://stackoverflow.com/q/75685623/288906
import 'vite/client';

declare global {
	interface ParentNode {
		querySelector<S extends string>(selector: S | readonly S[]): StrictlyParseSelector<S, HTMLElement> | null;

		querySelectorAll<S extends string>(
			selector: S | readonly S[],
		): NodeListOf<StrictlyParseSelector<S, HTMLElement>>;
	}

	interface Element {
		closest<S extends string>(selector: S | readonly S[]): StrictlyParseSelector<S, HTMLElement> | null;
		matches(selectors: string | readonly string[]): boolean;
	}
}



================================================
FILE: source/helpers/used-storage.ts
================================================
export function getTrueSizeOfObject(object: Record<string, any>): number {
	// Firefox https://bugzilla.mozilla.org/show_bug.cgi?id=1385832#c20
	return new TextEncoder().encode(
		Object.entries(object)
			.map(([key, value]) => key + JSON.stringify(value))
			.join(''),
	).length;
}

/** `getBytesInUse` polyfill */
export async function getStorageBytesInUse(area: 'local' | 'sync'): Promise<any> {
	const storage = chrome.storage[area];
	try {
		return await storage.getBytesInUse(); // Exists in Safari iOS, but can't be called...
	} catch {
		return getTrueSizeOfObject(await storage.get());
	}
}

export async function getStoredItemSize(area: chrome.storage.AreaName, item: string): Promise<number> {
	const storage = chrome.storage[area];
	return getTrueSizeOfObject(await storage.get(item));
}

export async function hasUsedStorage(): Promise<boolean> {
	return (
		await getStorageBytesInUse('sync') > 0
		|| Number(await getStorageBytesInUse('local')) > 0
	);
}



================================================
FILE: source/helpers/wait-for.ts
================================================
import delay from '../helpers/delay.js';

export default async function waitFor(condition: () => any): Promise<void> {
	while (!condition()) {
		// eslint-disable-next-line no-await-in-loop
		await delay(10);
	}
}



================================================
FILE: source/options/feature-list.tsx
================================================
import React from 'dom-chef';
import domify from 'doma';
import delegate, {type DelegateEvent} from 'delegate-it';
import {$} from 'select-dom/strict.js';
import {$$, countElements} from 'select-dom';

import {getLocalHotfixes} from '../helpers/hotfix.js';
import {createRghIssueLink, getFeatureUrl} from '../helpers/rgh-links.js';
import {importedFeatures, featuresMeta} from '../feature-data.js';

function moveDisabledFeaturesToTop(): void {
	const container = $('.js-features');
	const features = $$('.feature').toSorted((a, b) => a.dataset.text!.localeCompare(b.dataset.text!));
	const grouped = Object.groupBy(features, feature => {
		const checkbox = $('input.feature-checkbox', feature);
		return checkbox.checked ? 'on' : checkbox.disabled ? 'broken' : 'off';
	});
	for (const group of [grouped.off, grouped.broken, grouped.on].filter(Boolean)) {
		for (const feature of group!) {
			container.append(feature);
		}
	}
}

async function markLocalHotfixes(): Promise<void> {
	for (const [feature, relatedIssue] of await getLocalHotfixes()) {
		if (importedFeatures.includes(feature)) {
			const input = $<HTMLInputElement>('#' + feature);
			input.disabled = true;
			input.removeAttribute('name');
			$(`.feature-name[for="${feature}"]`).after(
				<span className="hotfix-notice"> (Disabled due to {createRghIssueLink(relatedIssue)})</span>,
			);
		}
	}
}

function buildFeatureCheckbox({id, description, screenshot}: FeatureMeta): HTMLElement {
	return (
		<div className="feature" data-text={`${id} ${description}`.toLowerCase()}>
			<input type="checkbox" name={`feature:${id}`} id={id} className="feature-checkbox" />
			<div className="info">
				<label className="feature-name" htmlFor={id}>{id}</label>
				{' '}
				<a href={getFeatureUrl(id)} className="feature-link">
					source
				</a>
				<input hidden type="checkbox" className="screenshot-toggle" />
				{screenshot && (
					<a href={screenshot} className="screenshot-link">
						screenshot
					</a>
				)}
				<p className="description">{domify(description)}</p>
				{screenshot && (
					<img hidden src={screenshot} loading="lazy" className="screenshot" />
				)}
			</div>
		</div>
	);
}

function summaryHandler(event: DelegateEvent<MouseEvent>): void {
	if (event.ctrlKey || event.metaKey || event.shiftKey) {
		return;
	}

	event.preventDefault();
	if (event.altKey) {
		for (const toggle of $$('input.screenshot-toggle')) {
			toggle.checked = !toggle.checked;
		}
	} else {
		const toggle = event
			.delegateTarget
			.closest('.feature')!
			.querySelector('input.screenshot-toggle')!;
		toggle.checked = !toggle.checked;
	}
}

function featuresFilterHandler(this: HTMLInputElement): void {
	const keywords = this
		.value
		.toLowerCase()
		.replaceAll(/\W/g, ' ')
		.split(/\s+/)
		.filter(Boolean); // Ignore empty strings
	for (const feature of $$('.feature')) {
		feature.hidden = !keywords.every(word => feature.dataset.text!.includes(word));
	}
}

const offCount = new Text();

function updateOffCount(): void {
	const count = countElements('.feature-checkbox:not(:checked)');
	switch (count) {
		case 0: {
			offCount.nodeValue = '';
			break;
		}

		case countElements('.feature-checkbox'): {
			offCount.nodeValue = '(JS offâ€¦ are you breaking up with me?)';
			break;
		}

		default: {
			offCount.nodeValue = `(${count} off)`;
		}
	}
}

export default async function initFeatureList(): Promise<void> {
	// Generate list
	$('.js-features').append(...featuresMeta
		.filter(feature => importedFeatures.includes(feature.id))
		.map(feature => buildFeatureCheckbox(feature)),
	);

	// Add notice for features disabled via hotfix
	await markLocalHotfixes();

	// Load screenshots
	delegate('.screenshot-link', 'click', summaryHandler);

	// Filter feature list
	$('input#filter-features').addEventListener('input', featuresFilterHandler);

	// Add feature count. CSS-only features are added approximately
	$('.features-header').append(`: ${featuresMeta.length + 25} `, offCount);

	delegate('.feature-checkbox', 'change', updateOffCount);
}

export function updateListDom(): void {
	moveDisabledFeaturesToTop();
	updateOffCount();
}



================================================
FILE: source/options/header.svelte
================================================
<svelte:options
	customElement={{
		tag: 'rgh-header',
		props: {
			title: {type: 'String', attribute: 'title'},
		},
	}}
/>

<!-- prettier-ignore -->
<script lang="ts">
	const {title}: {title: string} = $props();
</script>

<header>
	<div class="content">
		<h1>
			<img src="icon.png" alt="" height="32" />
			{title}
		</h1>
		<div>
			<slot />
		</div>
	</div>
</header>

<style>
	header {
		background-color: light-dark(#f6f8fa, #02040a);
		border-bottom: solid 1px light-dark(#d2d9e0, #3d444d);
		padding-block: 30px;
		padding-inline: var(--viewport-margin);
		display: grid;
		gap: 1em;

		& > * {
			width: 100%;
			max-width: var(--content-width);
			margin: auto;
		}
	}

	h1 {
		display: flex;
		gap: 0.4em;
		font-size: clamp(1.3em, 5vw, 2em);
		font-weight: 200;

		img {
			height: 1.3em;
			width: 1.3em;
		}
	}
</style>



================================================
FILE: source/options/reload-without.ts
================================================
import {StorageItem} from 'webext-storage';
import webextAlert from 'webext-alert';
import {isScriptableUrl} from 'webext-content-scripts';
import {isFirefox} from 'webext-detect';
import {createContextMenu} from 'webext-tools';

// Always Firefoxâ€¦ https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage/StorageArea/setAccessLevel
const area = isFirefox() ? 'local' : 'session';

export const contentScriptToggle = new StorageItem('contentScript', {
	area,
	defaultValue: true,
});

async function reload(_: unknown, tab: chrome.tabs.Tab): Promise<void> {
	if (tab.url && isScriptableUrl(tab.url) && await chrome.permissions.contains({
		origins: [tab.url],
	})) {
		await contentScriptToggle.set(false);
		await chrome.tabs.reload(tab.id!);
	} else {
		// TODO: Use https://github.com/fregante/webext-events/issues/31 to disable the item instead
		await webextAlert('Refined GitHub is already not running on this page');
	}
}

export default function addReloadWithoutContentScripts(): void {
	void chrome.storage.session.setAccessLevel?.({accessLevel: 'TRUSTED_AND_UNTRUSTED_CONTEXTS'});

	void createContextMenu({
		id: 'reload-without-content-scripts',
		title: 'Reload without Refined GitHub',
		contexts: ['action'],
		onclick: reload,
	});
}



================================================
FILE: source/options/storage-usage.svelte
================================================
<svelte:options
	customElement={{
		tag: 'storage-usage',
		props: {
			area: {type: 'String', attribute: 'area'},
			item: {type: 'String', attribute: 'item'},
		},
	}}
/>

<!-- prettier-ignore -->
<script lang="ts">
	import prettyBytes from 'pretty-bytes';

	import {onMount} from 'svelte';

	import {getStorageBytesInUse, getStoredItemSize, getTrueSizeOfObject} from '../helpers/used-storage.js';

	const {area, item}: {
		area: 'sync' | 'local';
		item?: string;
	} = $props();
	const storage = chrome.storage[area];

	let used = $state(0);
	const available = $derived((item ? (storage as chrome.storage.SyncStorageArea).QUOTA_BYTES_PER_ITEM ?? storage.QUOTA_BYTES : storage.QUOTA_BYTES) - used);

	async function getStorageUsage() {
		used = item ? await getStoredItemSize(area, item) : await getStorageBytesInUse(area);
	}

	const handleStorageChange = (changes: {[key: string]: chrome.storage.StorageChange}, areaName: chrome.storage.AreaName) => {
		if (item && changes[item]) {
			used = getTrueSizeOfObject(changes[item].newValue);
		}

		if (areaName === area) {
			getStorageUsage();
		}
	};

	$effect(() => {
		if (item) {
			used = getTrueSizeOfObject(storage.get(item));
		}
	});

	onMount(() => {
		getStorageUsage();

		chrome.storage.onChanged.addListener(handleStorageChange);

		return () => {
			chrome.storage.onChanged.removeListener(handleStorageChange);
		};
	});
</script>

<output>
	{available < 100_000
		? `Only ${prettyBytes(available)} available`
		: `${prettyBytes(used)} used`}
</output>



================================================
FILE: source/options/toggle-all.ts
================================================
import {$$, countElements} from 'select-dom';
import {$} from 'select-dom/strict.js';

function enableToggleAll(this: HTMLButtonElement): void {
	const section = $('details#toggle-all');
	section.hidden = false;
	section.open = true;
	this.hidden = true; // Hide button in "Debugging" section
}

function disableAllFeatures(): void {
	for (const enabledFeature of $$('.feature-checkbox:checked')) {
		enabledFeature.click();
	}

	$('details#features').open = true;
}

function enableAllFeatures(): void {
	for (const disabledFeature of $$('.feature-checkbox:not(:checked)')) {
		disabledFeature.click();
	}

	$('details#features').open = true;
}

export default function initToggleAllButtons(): void {
	const initialButton = $('#toggle-all-features');
	// Show "Toggle All" section if the user already disabled a lot of features
	if (countElements('.feature-checkbox:not(:checked)') > 50) {
		$('details#toggle-all').hidden = false;
		initialButton.hidden = true; // Hide button in "Debugging" section
	} else {
		initialButton.addEventListener('click', enableToggleAll);
	}

	$('#disable-all-features').addEventListener('click', disableAllFeatures);
	$('#enable-all-features').addEventListener('click', enableAllFeatures);
}



================================================
FILE: source/options/token-validation.tsx
================================================
import {$$} from 'select-dom';
import {$} from 'select-dom/strict.js';

import {assertError} from 'ts-extras';
import type {SyncedForm} from 'webext-options-sync-per-domain';

import {getTokenInfo, tokenUser} from '../github-helpers/github-token.js';
import delay from '../helpers/delay.js';

const rtf = new Intl.RelativeTimeFormat('en', {numeric: 'auto'});

type Status = {
	error?: true;
	text?: string;
	scopes?: string[];
};

function reportStatus({error, text, scopes = ['unknown']}: Status = {}): void {
	const tokenStatus = $('#validation');
	tokenStatus.textContent = text ?? '';
	if (error) {
		tokenStatus.dataset.validation = 'invalid';
	} else {
		delete tokenStatus.dataset.validation;
	}

	for (const scope of $$('[data-scope]')) {
		scope.dataset.validation = scopes.includes(scope.dataset.scope!)
			? 'valid'
			: scopes.includes('unknown')
				? ''
				: 'invalid';
	}
}

function getApiUrl(): string {
	const tokenLink = $('a#personal-token-link');
	return tokenLink.host === 'github.com'
		? 'https://api.github.com/'
		: `${tokenLink.origin}/api/v3/`;
}

function expandTokenSection(): void {
	$('details#token').open = true;
}

async function validateToken(): Promise<void> {
	const tokenField = $('input[name="personalToken"]');
	reportStatus();

	if (!tokenField.validity.valid || tokenField.value.length === 0) {
		// The Chrome options iframe auto-sizer causes the "scrollIntoView" function to scroll incorrectly unless you wait a bit
		// https://github.com/refined-github/refined-github/issues/6807
		setTimeout(expandTokenSection, 100);
		return;
	}

	reportStatus({text: 'Validatingâ€¦'});

	try {
		const base = getApiUrl();
		const [tokenInfo, user] = await Promise.all([
			getTokenInfo(base, tokenField.value),
			tokenUser.get(base, tokenField.value),
		]);

		// Build status message with user and expiration
		let statusMessage = `ğŸ‘¤ @${user}`;
		if (tokenInfo.expiration) {
			const msUntilExpiration = new Date(tokenInfo.expiration).getTime() - Date.now();
			const daysUntilExpiration = Math.ceil(msUntilExpiration / (1000 * 60 * 60 * 24));
			statusMessage += `, expires ${rtf.format(daysUntilExpiration, 'day')}`;
		} else {
			statusMessage += ', no expiration';
		}

		reportStatus({
			text: statusMessage,
			scopes: tokenInfo.scopes,
		});
	} catch (error) {
		assertError(error);
		reportStatus({error: true, text: error.message});
		expandTokenSection();
		throw error;
	}
}

export default async function initTokenValidation(syncedForm: SyncedForm | undefined): Promise<void> {
	await validateToken();

	// Listen to events
	const field = $('input[name="personalToken"]');
	field.addEventListener('input', validateToken);
	field.addEventListener('focus', () => {
		field.type = 'text';
	});
	field.addEventListener('blur', () => {
		field.type = 'password';
	});

	// Update domain-dependent page content when the domain is changed
	syncedForm?.onChange(async () => {
		// TODO: Fix upstream bug https://github.com/fregante/webext-options-sync-per-domain/issues/10#issuecomment-3077459946
		await delay(100);
		await validateToken();
	});
}



================================================
FILE: test/setup-file.js
================================================
import {parseHTML, NodeFilter} from 'linkedom';

const globals = [
	'navigator',
	'document',
	'HTMLAnchorElement',
	'DocumentFragment',
	'Node',
];

const {window} = parseHTML('...', 'text/html');
globalThis.location = new URL('https://github.com');

for (const property of globals) {
	globalThis[property] ??= window[property];
}

class Location {}
globalThis.Location = Location;
globalThis.NodeFilter = NodeFilter;
globalThis.location = new URL('https://github.com');

const link = document.createElement('link');
link.rel = 'alternate';
link.type = 'application/atom+xml';
navigateToCommits('master', '/refined-github/refined-github/commits');
document.head.append(link);

// eslint-disable-next-line import-x/prefer-default-export
export function navigateToCommits(branch, pathname) {
	link.href = `https://github.com/refined-github/refined-github/commits/${branch}.atom`;
	link.title = `Recent Commits to ava:${branch}`;
	location.pathname = pathname;
}

// No native support https://github.com/WebReflection/linkedom/issues/156
window.Text.prototype.splitText = function (offset) {
	const [start, end] = (() => {
		if (offset <= 0) {
			return ['', this.data];
		}

		if (offset >= this.data.length) {
			return [this.data, ''];
		}

		return [
			this.data.slice(0, Math.max(0, offset)),
			this.data.slice(Math.max(0, offset)),
		];
	})();

	const newNode = window.document.createTextNode(end);
	this.parentNode.insertBefore(newNode, this.nextSibling);
	this.data = start;
	return newNode;
};



================================================
FILE: test/shorten-link.test.ts
================================================
import {parseHTML} from 'linkedom';
import {expect, test} from 'vitest';

import {shortenLink} from '../source/github-helpers/dom-formatters.js';

function shortenLinksInFragment(html: string): string {
	const {document} = parseHTML(html);

	const links = document.querySelectorAll('a');
	for (const link of links) {
		shortenLink(link);
	}

	return document.documentElement.outerHTML;
}

test('shorten link in comment text', () => {
	// https://github.com/refined-github/refined-github/issues/4565#issue-943802539
	expect(shortenLinksInFragment(`
		<td class="d-block comment-body markdown-body js-comment-body">
			<p dir="auto">
				<a href="https://github.com/darkred/test/compare/main...t2?expand=1">https://github.com/darkred/test/compare/main...t2?expand=1</a>
			</p>
		</td>
	`)).toMatchSnapshot();
});

test('avoid shortening link in code block inside comment', () => {
	// https://github.com/denosaurs/mod.land/issues/55#issue-1160032701
	expect(shortenLinksInFragment(`
		<div class="highlight highlight-source-ts">
			<pre class="rgh-linkified-code">
				<span class="pl-s">
					<a href="https://raw.githubusercontent.com/denosaurs/mod.land/master/cnames.ts" rel="noreferrer noopener" class="rgh-linkified-code">
						https://raw.githubusercontent.com/denosaurs/mod.land/master/cnames.ts
					</a>
				</span>
			</pre>
		</div>
	`)).toMatchSnapshot();
});

test('avoid shortening link in embedded file preview inside comment', () => {
	// https://github.com/refined-github/refined-github/pull/4759#issue-988481591
	expect(shortenLinksInFragment(`
		<div class="comment-body markdown-body js-comment-body soft-wrap user-select-contain d-block">
			<div class="Box Box--condensed my-2">
				<div itemprop="text" class="Box-body p-0 blob-wrapper blob-wrapper-embedded data">
					<table class="highlight tab-size mb-0 js-file-line-container" data-tab-size="8" data-paste-markdown-skip="">
						<tbody>
							<tr class="border-0">
								<td id="LC45" class="blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line rgh-linkified-code">
									<span class="pl-c">//
										<a href="https://github.com/sindresorhus/refined-github/issues/522#issuecomment-311271274" rel="noreferrer noopener" class="rgh-linkified-code">
											https://github.com/sindresorhus/refined-github/issues/522#issuecomment-311271274
										</a>
									</span>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
	`)).toMatchSnapshot();
});

test('shorten link in review comment text', () => {
	// https://github.com/refined-github/refined-github/pull/4759#discussion_r738167140
	expect(shortenLinksInFragment(`
		<div class="comment-body markdown-body js-comment-body soft-wrap user-select-contain d-block">
			<p dir="auto">
				<a href="https://github.com/refined-github/refined-github">https://github.com/refined-github/refined-github</a>
			</p>
		</div>
	`)).toMatchSnapshot();
});

test('avoid shortening links in suggestion inside review comment', () => {
	// https://github.com/refined-github/refined-github/pull/4759#discussion_r738167140
	expect(shortenLinksInFragment(`
		<div class="comment-body markdown-body js-comment-body soft-wrap user-select-contain d-block">
			<div class="my-2 border rounded-2 js-suggested-changes-blob diff-view" id="">
				<div itemprop="text" class="blob-wrapper data file" style="margin: 0; border: none; overflow-y: visible; overflow-x: auto;">
					<table class="d-table tab-size mb-0 width-full" data-paste-markdown-skip="">
						<tbody>
							<tr class="border-0">
								<td class="border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition">
									https:<span class="pl-c">//github.com/refined-github/refined-github</span><span class="pl-kos"></span>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
	`)).toMatchSnapshot();
});



================================================
FILE: test/__snapshots__/shorten-link.test.ts.snap
================================================
// Vitest Snapshot v1, https://vitest.dev/guide/snapshot.html

exports[`avoid shortening link in code block inside comment 1`] = `
"<div class="highlight highlight-source-ts">
			<pre class="rgh-linkified-code">
				<span class="pl-s">
					<a href="https://raw.githubusercontent.com/denosaurs/mod.land/master/cnames.ts" rel="noreferrer noopener" class="rgh-linkified-code">
						https://raw.githubusercontent.com/denosaurs/mod.land/master/cnames.ts
					</a>
				</span>
			</pre>
		</div>"
`;

exports[`avoid shortening link in embedded file preview inside comment 1`] = `
"<div class="comment-body markdown-body js-comment-body soft-wrap user-select-contain d-block">
			<div class="Box Box--condensed my-2">
				<div itemprop="text" class="Box-body p-0 blob-wrapper blob-wrapper-embedded data">
					<table class="highlight tab-size mb-0 js-file-line-container" data-tab-size="8" data-paste-markdown-skip="">
						<tbody>
							<tr class="border-0">
								<td id="LC45" class="blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line rgh-linkified-code">
									<span class="pl-c">//
										<a href="https://github.com/sindresorhus/refined-github/issues/522#issuecomment-311271274" rel="noreferrer noopener" class="rgh-linkified-code">
											https://github.com/sindresorhus/refined-github/issues/522#issuecomment-311271274
										</a>
									</span>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>"
`;

exports[`avoid shortening links in suggestion inside review comment 1`] = `
"<div class="comment-body markdown-body js-comment-body soft-wrap user-select-contain d-block">
			<div class="my-2 border rounded-2 js-suggested-changes-blob diff-view">
				<div itemprop="text" class="blob-wrapper data file" style="margin: 0; border: none; overflow-y: visible; overflow-x: auto;">
					<table class="d-table tab-size mb-0 width-full" data-paste-markdown-skip="">
						<tbody>
							<tr class="border-0">
								<td class="border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition">
									https:<span class="pl-c">//github.com/refined-github/refined-github</span><span class="pl-kos"></span>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>"
`;

exports[`shorten link in comment text 1`] = `
"<td class="d-block comment-body markdown-body js-comment-body">
			<p dir="auto">
				<a href="https://github.com/darkred/test/compare/main...t2?expand=1">darkred/test@<code>main...t2</code>?expand=1 (compare)</a>
			</p>
		</td>"
`;

exports[`shorten link in review comment text 1`] = `
"<div class="comment-body markdown-body js-comment-body soft-wrap user-select-contain d-block">
			<p dir="auto">
				<a href="https://github.com/refined-github/refined-github">refined-github/refined-github</a>
			</p>
		</div>"
`;



================================================
FILE: test/web-ext-profile/.gitkeep
================================================




================================================
FILE: .github/funding.yml
================================================
github: fregante



================================================
FILE: .github/pull_request_template.md
================================================
<!--

Thanks for contributing! ğŸ„ Do not ignore this, plz.

1. Does this PR close/fix an existing issue? Write something like: Closes #10

Help us test and visualize this PR:

2. What pages does this PR affect? Include some REAL URLs where you tested the code
3. If applicable, add demonstrative screenshots or gifs

Lastly:

4. Open the PR as draft and review it yourself first. Fix what you find and explain weird code, if necessary.

If you haven't done so yet, check out the Contributing page in the wiki: https://github.com/refined-github/refined-github/wiki/Contributing#metadata-guidelines

-->



## Test URLs


## Screenshot



================================================
FILE: .github/release.yml
================================================
# https://docs.github.com/en/repositories/releasing-projects-on-github/automatically-generated-release-notes#configuration-options
changelog:
  categories:
    - title: Bugfixes
      labels: [bug]
    - title: Improvements
      labels: ['*']
      exclude:
        labels: [meta] # Only needed because Meta must be last
    - title: Meta
      labels: [meta]



================================================
FILE: .github/ISSUE_TEMPLATE/1_bug_report.yml
================================================
name: ğŸ› Report a bug
description: â€”â€”â€”
labels: bug
body:
  - type: markdown
    attributes:
      value: |
        # Thanks for reporting a bug! â›°

        Help us replicate the issue by filling in this form. You can use the "Identify feature" button in the options page to find which feature is causing the issue.

        Please ensure:

        - The bug is caused by Refined GitHub. It doesn't happen if I disable the extension.
        - The bug happens after clearing extension cache. The "Clear cache" button can be found in the options page. [](#clear-cache)

        Include in this issue:

        - Screenshots/video/gif demonstrating the bug, if itâ€™s visual
        - Console errors, if any

  - id: description
    type: textarea
    attributes:
      label: Description
    validations:
      required: true
  - id: repro
    type: textarea
    attributes:
      label: How to replicate the issue + URL
      description: â€¼ï¸â€¼ï¸â€¼ï¸ Every bug report MUST include A REAL URL where the bug appears. If it happens on a private repo, find an equivalent public URL, even if it doesn't happen there.
    validations:
      required: true
  - id: version
    type: input
    attributes:
      label: Extension version
    validations:
      required: true
  - id: browser
    type: input
    attributes:
      label: Browser(s) used
    validations:
      required: true
  - id: token
    type: checkboxes
    attributes:
      label: Token âš ï¸
      options:
        - label: I set a token in the options page. I understand that some features require a token to work.
          required: true



================================================
FILE: .github/ISSUE_TEMPLATE/2_feature_request.yml
================================================
name: ğŸ†• Suggest an improvement or new feature
description: â€”â€”â€”
labels: enhancement, under discussion
body:
  - type: markdown
    attributes:
      value: |
        ğŸ‘‰ Review our [guidelines](https://github.com/refined-github/refined-github/wiki/%22Can-you-add-this-feature%3F%22) to ensure this feature would make sense in Refined GitHub.

        ğŸ‘‹ Consider contributing by fixing some [easy bugs](https://github.com/refined-github/refined-github/issues?q=is%3Aissue+is%3Aopen+sort%3Aupdated-desc+label%3A%22small%22+label%3Abug).

        ğŸï¸ You can provide screenshots/mockups to better visualize your idea. Files can be dropped in this field
  - id: description
    type: textarea
    attributes:
      label: Description
    validations:
      required: true
  - id: urls
    type: textarea
    attributes:
      label: Example URLs
      description: Include a REAL URL where the feature should appear. e.g. Do you want a feature to appear on the main page of a repo? Paste a link to a repo
      placeholder: https://github.com/refined-github/refined-github
    validations:
      required: true



================================================
FILE: .github/ISSUE_TEMPLATE/3_discussion.md
================================================
---
name: ğŸ’¬ Ask a question or open a discussion
about: â€”â€”â€”
labels: under discussion
---

<!-- If you wonder why something isn't working, "report a bug" instead of using this template. -->



================================================
FILE: .github/ISSUE_TEMPLATE/config.yml
================================================
blank_issues_enabled: false



================================================
FILE: .github/workflows/actionlint.yml
================================================
# Copied from https://github.com/rhysd/actionlint/blob/048c97d90b98b832450d3adf00fc7757b0ed9953/docs/usage.md#use-actionlint-on-github-actions
name: actionlint

on:
  pull_request:
    paths:
      - .github/workflows/*.yml

jobs:
  actionlint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false # Disable git write access
      - uses: docker://rhysd/actionlint:latest
        with:
          args: -color



================================================
FILE: .github/workflows/conversation.yml
================================================
name: Conversation

on:
  pull_request_target:
    types: [opened, edited]
  issues:
    types: [opened, edited]

jobs:
  Title:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
    steps:
      - uses: fregante/title-to-labels-action@v1
        with:
          token: ${{ github.token }}
      - uses: actions/checkout@v4
      - uses: fregante/keyword-formatter-action@v1
        with:
          token: ${{ github.token }}
          keywords-path: source/features



================================================
FILE: .github/workflows/hotfixes.yml
================================================
name: Hotfix

on:
  issues:
    types:
      - closed

jobs:
  reminder:
    name: Reminder
    runs-on: ubuntu-latest

    steps:
      - name: Fetch CSV file
        run: |
          curl -o broken-features.csv https://raw.githubusercontent.com/refined-github/yolo/main/broken-features.csv
          cat broken-features.csv

      - name: Was it hotfixed?
        run: |
          if grep -q ",${{ github.event.issue.number }}," broken-features.csv; then
            TODAY="$(npx utc-version --short)"
            echo "WAS_HOTFIXED=$TODAY" >> "$GITHUB_ENV"
          fi

      - name: Leave comment
        if: env.WAS_HOTFIXED
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            To maintainers: Disable the hotfix by adding `${{env.WAS_HOTFIXED}}` to https://github.com/refined-github/yolo/edit/main/broken-features.csv



================================================
FILE: .github/workflows/pr.yml
================================================
name: PR

on:
  pull_request_target:
    types: [opened, reopened, edited, closed]

jobs:
  reminder:
    name: Label Reminder
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Check if PR has no labels
        id: check
        uses: actions/github-script@v8
        with:
          result-encoding: string
          script: |
            const labels = context.payload.pull_request.labels;
            return labels.length === 0;

      - name: Post comment if unlabeled
        if: steps.check.outputs.result == 'true'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: 'To maintainers: Please add labels to this PR'

  Sync:
    if: github.event.pull_request.state == 'open'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: read
      contents: read
    steps:
      - uses: actions/github-script@v8
        with:
          script: |
            const allowed = ['bug', 'enhancement', 'meta']
            const { owner, repo } = context.repo
            const pr = context.payload.pull_request

            const query = `
              query($owner:String!, $repo:String!, $number:Int!) {
                repository(owner:$owner, name:$repo) {
                  pullRequest(number:$number) {
                    closingIssuesReferences(first: 10) {
                      nodes {
                        labels(first: 20) {
                          nodes { name }
                        }
                      }
                    }
                  }
                }
              }
            `

            const res = await github.graphql(query, {
              owner, repo, number: pr.number
            })

            const labels = new Set()
            for (const issue of res.repository.pullRequest.closingIssuesReferences.nodes) {
              for (const l of issue.labels.nodes) {
                if (allowed.includes(l.name)) labels.add(l.name)
              }
            }

            if (labels.size > 0) {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: pr.number,
                labels: [...labels]
              })
            }



================================================
FILE: .github/workflows/relative-ci.yml
================================================
name: RelativeCI

on:
  workflow_run:
    workflows: [Test]
    types:
      - completed

jobs:
  ingest:
    runs-on: ubuntu-latest
    steps:
      - name: Send bundle stats and build information to RelativeCI
        uses: relative-ci/agent-action@v2.2.0
        with:
          key: ${{ secrets.RELATIVE_CI_KEY }}
          token: ${{ secrets.GITHUB_TOKEN }}



================================================
FILE: .github/workflows/release.yml
================================================
env:
  DIRECTORY: distribution
  PROJECT_NAME: refined-github

# FILE GENERATED WITH: npx ghat fregante/ghatemplates/webext
# SOURCE: https://github.com/fregante/ghatemplates
# OPTIONS: {"exclude":["on.schedule"]}

name: Release
on:
  workflow_dispatch: null
jobs:
  Version:
    outputs:
      created: ${{ env.DAILY_VERSION_CREATED }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: package.json
          cache: npm
      - run: npm ci
      - name: Test and build
        run: npm run build
      - name: Create tag if necessary
        uses: fregante/daily-version-action@v2
      - name: Update manifest.json with version ${{ env.DAILY_VERSION}}
        if: env.DAILY_VERSION_CREATED
        run: npx dot-json@1 "$DIRECTORY/manifest.json" version "$DAILY_VERSION"
      - name: Ready for "submit" jobs
        if: env.DAILY_VERSION_CREATED
        uses: actions/upload-artifact@v4
        with:
          path: ${{ env.DIRECTORY }}
      - name: Create release
        if: env.DAILY_VERSION_CREATED
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        working-directory: ${{ env.DIRECTORY }}
        run: |
          FILENAME="$PROJECT_NAME-$DAILY_VERSION-for-local-testing-only.zip"
          zip -r "$FILENAME" ./*
          # Create as draft to curate it before sending it out
          gh release create "$DAILY_VERSION" "$FILENAME" --draft --generate-notes
  Chrome:
    if: needs.Version.outputs.created
    needs: Version
    name: Submit (Chrome)
    environment: Chrome
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
      - run: npx chrome-webstore-upload-cli@3
        working-directory: artifact
        env:
          EXTENSION_ID: ${{ secrets.EXTENSION_ID }}
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN }}
  Firefox:
    if: needs.Version.outputs.created
    needs: Version
    name: Submit (Firefox)
    environment: Firefox
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
      - name: Upload build and source code
        run: npx web-ext@8 sign --channel listed
        working-directory: artifact
        env:
          WEB_EXT_API_KEY: ${{ secrets.WEB_EXT_API_KEY }}
          WEB_EXT_API_SECRET: ${{ secrets.WEB_EXT_API_SECRET }}



================================================
FILE: .github/workflows/test.yml
================================================
name: Test

on:
  pull_request:
    branches:
      - '*'
  push:
    branches:
      - main
      - 'test/*'

jobs:
  Security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: npx lockfile-lint --path package-lock.json --validate-https

  Vitest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: package.json
          cache: npm
      - run: sudo apt-get install ripgrep
      - run: npm ci
      - run: npm run vitest -- --exclude 'build/features*' --exclude '**/selectors*'

      # TODO: Restore
      # For some reason it fails on CI, but not locally
      # Mentioned in https://github.com/refined-github/refined-github/issues/7747
      # - run: npm run vitest -- selectors
      #   if: false
      #   continue-on-error: true

  Verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: package.json
          cache: npm
      - run: npm ci
      - run: npm run vitest -- build/features
      - name: Leave comment
        uses: peter-evans/create-or-update-comment@v4
        if: failure() && github.event_name == 'pull_request'  && github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            Don't worry about fixing this yet, you can wait for the feature to be finalized before documenting it.

            FYI: you can run `npm run fix` to automatically fix a lot of issues and update snapshots. Similar tips can be found in the [contributing wiki](https://github.com/refined-github/refined-github/wiki/Contributing).

  Lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: package.json
          cache: npm
      - run: npm ci
      - run: npm run lint
      - uses: codespell-project/actions-codespell@v2
        with:
          ignore_words_list: eror,usera
          exclude_file: ${{ github.workspace }}/package-lock.json
          skip: '*.json'

  Types:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: package.json
          cache: npm
      - run: npm ci
      - run: npm run build:typescript

  Build:
    strategy:
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: package.json
          cache: npm
      - run: npm ci
      - run: npm run build:bundle
        env:
          RELATIVE_CI_STATS: true
      - name: Upload bundle stats artifact
        if: matrix.os == 'ubuntu-latest'
        uses: relative-ci/agent-upload-artifact-action@v2
        with:
          webpackStatsFile: ./distribution/assets/webpack-stats.json
      - uses: actions/upload-artifact@v4
        if: matrix.os == 'ubuntu-latest'
        with:
          name: refined-github
          path: |
            distribution
            !./distribution/assets/webpack-stats.json


